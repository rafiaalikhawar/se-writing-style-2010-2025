PAD: Programming Third-Party Web Advertisement
Censorship
Weihang Wang, Yonghwi Kwon, Yunhui Zhengy, Yousra Aafer, I-Luk Kim, Wen-Chuan Lee, Yingqi Liu,
Weijie Meng, Xiangyu Zhang, and Patrick Eugsterz
Department of Computer Science, Purdue University, West Lafayette, Indiana, USA
fwang1315, kwon58, yaafer, kim1634, lee1938, liu1751, mengw, xyzhang, pg@cs.purdue.edu
yIBM T.J. Watson Research Center, Yorktown Height, New York, USA
zhengyu@us.ibm.com
zTechnische Universit ¬®at Darmstadt, Darmstadt, Germany
peugster@dsp.tu-darmstadt.de
Abstract ‚ÄîIn the current online advertisement delivery, an ad
slot on a publisher‚Äôs website may go through multiple layers of
bidding and reselling until the Ô¨Ånal ad content is delivered. The
publishers have little control on the ads being displayed on their
web pages. As a result, website visitors may suffer from unwanted
ads such as malvertising, intrusive ads, and information disclo-
sure ads. Unfortunately, the visitors often blame the publisher for
their unpleasant experience and switch to competitor websites.
In this paper, we propose a novel programming support system
for ad delivery, called PAD, for publisher programmers, who
specify their policies on regulating third-party ads shown on
their websites. PAD features an expressive speciÔ¨Åcation language
and a novel persistent policy enforcement runtime that can self-
install and self-protect throughout the entire ad delegation chain.
It also provides an ad-speciÔ¨Åc memory protection scheme that
prevents malvertising by corrupting malicious payloads. Our
experiments show that PAD has negligible runtime overhead. It
effectively suppresses a set of malvertising cases and unwanted
ad behaviors reported in the real world, without affecting normal
functionalities and regular ads.
I. I NTRODUCTION
Web advertisements (ads) are probably the most ubiquitous
mashups nowadays and are still growing substantially. The
annual revenue of US online advertising increased from 12:5
billion (2005) to 59:6 billion (2015), demonstrating a stunning
17% compound annual growth [44]. They are the main source
of income for many Internet companies (e.g. Google and
Facebook) and nourish various online services (e.g., news and
social networks). Web ads have been widely deployed on most
high-trafÔ¨Åc websites. In 2017, more than 1:97 million popular
websites participate in advertising campaigns [45].
Under the hood, a gigantic digital advertising system con-
nects various parties and fulÔ¨Ålls the complicated transactions
among them. Websites join the ecosystem as publishers. They
offer pre-allocated slots to ad networks and deliver bootstrap-
ping JavaScript libraries hosted by the network to visitors.
These ad loading snippets are executed in visitor‚Äôs browser.
They collect and send the visitor/website proÔ¨Åles to the ad
exchange. This information is further shared with participating
advertisers/networks before the ad exchange conducts a pay-
per-impression auction. Advertisers evaluate its value based
on the proÔ¨Åles and bid for a particular impression. Finally,
Network 1
Network 3
Network 2
Advertiser 1
Advertiser 2
Advertiser 3
Publisher 3
Publisher 2
Publisher 1 Ad Exchange
SellBuy
AttackerFig. 1. Ad network system.
additional JavaScript snippets are returned to the visitor and
eventually load the actual ad content (e.g. Adobe Flashes,
videos, images or texts) from the auction winner.
However, the impedance mismatch between mashup soft-
ware devOps and software engineering [59] has already re-
sulted in several challenging issues. The nature of dynamically
including source-code from all over the world makes the
traditional software engineering (e.g. modularity and security
guidelines) less applicable. In the context of web ads, although
the ad exchange and impression bidding approach greatly
improves the efÔ¨Åciency of the advertising business, it brings
risks to publishers because websites don‚Äôt know the auction
winners. They have to blindly trust and deliver any contents
from the ad networks to their visitors without any control.
Undesired Ads. Even though reputable ad networks Ô¨Ålter
malformed ads, visitors still receive undesired ads that cause
negative user experience or even endanger visitors‚Äô systems.
Such obnoxious practices easily alienate visitors and irrepara-
bly damage websites‚Äô reputations [41]. Besides, a recent study
[52] shows that while undesired ads can bring in 0:10-0:80
USD, they cost publishers 1:53 USD per thousand impres-
sions, meaning that websites are actually losing money by
running such bad ads. To make things even worse, attackers are
gaming the system and using this channel to spread malware.
As shown in Fig. 1, attackers join the network and act as
normal advertisers. However, instead of sending ads, they trick
the network and attempt to deliver malicious code to the
website visitors. Exploiting the open nature of ad network,
attackers can even bid for high-value targets based on their
978-1-5386-2684-9/17/$31.00 c2017 IEEEASE 2017, Urbana-Champaign, IL, USA
Technical Research240
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 14:53:14 UTC from IEEE Xplore.  Restrictions apply. operating systems, browser versions, country locations and
other identifying features. By paying a small amount of money,
attackers can easily ‚Äúselect‚Äù the right type of targets from a
huge number of Internet users all over the world.
Malvertising campaigns are becoming a prominent threat.
According to Cyphort Labs, ‚Äúby 2013 malvertising increased
to over 209; 000 incidents and generated over 12:4 billion
malicious ad impressions, which is more than four per each
person using the Internet‚Äù. During 2014, a 325% increase in
malvertising attacks has been observed [39]. In addition, it‚Äôs
believed that leveraging zero-day exploits has made malvertis-
ing more effective. In March 2016, visitors of the NY Times,
the BBC, Newsweek, The Hill, MSN.com, Aol.com, the Weather
Network, the HNL, and Realtor.com have seen ads trying
to install malicious ransomware and Trojans. These popular
websites have billions of visitors every month [43]. ‚ÄúThe
websites themselves weren‚Äôt compromised. The problem was
that the ad networks these sites use - Google, AppNexus, AOL,
Rubicon - were tricked into serving the malicious ads, which
would lead users to sites hosting an exploit kit‚Äù [46]. The
exploit kit then attempts to leverage browser vulnerabilities,
penetrate the sandbox and get into the target‚Äôs computer.
In response to the chaos, Ad-block software are widely
used by website visitors. According to a survey by PageFair,
an anti-adblocking authority, over 600 million devices run
Ad-blocking software globally in 2016 [47]. Although Ad-
blockers can mitigate some of the problems caused by third
party ads, in the long run simply blocking ads will devastate
the economic structure underlying the Internet. Without the
monetary revenue gained from ads, various web services
would go out of business, which is to no one‚Äôs beneÔ¨Åt. As
such, ad-blocking is not a desirable solution to the problem.
Our approach. In this paper, we propose PAD, a novel
technique that allows publishers to program their policies to
regulate ads rendered on their websites. Such regulations aim
to protect website visitors from undesired ad related behaviors
such as malvertising or intrusive ads, and protect publishers
from detrimental client-side behaviors such as ad blocking.
The protection is enforced during the entire life-cycle of the
ad delivery, disregarding layers of reselling and delegation.
PAD allows publisher programmers to compose their regu-
lation logic using an expressive language. It further compiles
policies to JavaScript (JS) code that executes on a novel
persistent runtime, which can self-install in each delegation
layer and execute preemptively before any third-party script.
The runtime also features a novel memory randomization
mechanism that protects memory accesses to block malware
at the entry points. PAD can be conÔ¨Ågured to disable certain
regular JS functionalities (e.g., pop-ups) based on the runtime
context (e.g., the advertiser‚Äôs domain). PAD integrates the
recent advances in web page randomization [62] to allow the
publishers to randomize speciÔ¨Åed ad content, instead of the
entire web page as in [62], to circumvent ad-blocking.
In summary, we make the following contributions.
We propose the novel idea of allowing publishers to pro-
gram their regulation of ads displayed on their websites.We develop a simple yet expressive language to program
regulation policies. Policies are transparently compiled to
JS code that enforces the regulation.
We develop a novel subversion-resilient runtime that en-
sures persistent regulations throughout the life-cycle of ad
delivery and features a novel memory protection technique
to prevent malvertising.
Our evaluation on Alexa Top 200 Global Sites shows that
PAD has reasonable overhead and does not affect normal
contents. It successfully prevents a large set of real incidents
of malvertising and undesired ads we have reproduced.
II. M OTIVATION
In this section, we illustrate undesired ads by examples and
motivate our approach.
A. Malvertising
Like normal advertisers, attackers can also participate in
the impression bidding. However, instead of delivering ads,
they distribute malware. When a website visitor satisÔ¨Åes the
conditions (geographic location, browser versions, etc.), she
will receive the malicious code via the ad network. To Ô¨Çy
under the radar, such code usually runs various checks on the
execution context (e.g. existences of debuggers and vulnerable
components) before attempting to infect the victim.
Recently, a sophisticated campaign named AdGholas was
reported [40]. According to a cybersecurity company Proof-
point [42], the attackers used 22ad networks to distribute
malicious code. It affected 113 legitimate sites including
The New York Times, Le Figaro, The Verge, PCMag, IB-
Times, ArsTechnica, Daily Mail, Telegraaf, La Gazetta dello
Sport, CBS Sports, Top Gear, Urban Dictionary, Playboy,
Answers.com, Sky.com, etc. It was highly effective and infected
thousands of victims per day. Depending on locations, different
malwares were delivered and installed on victim‚Äôs computer.
Gozi (targeting at Internet Solutions for Business) was dropped
in Canada, Terdot.A (aka DELoader) in Australia, Godzilla
loaded Terdot.A in UK, and Gootkit in Spain.
These malware have caused massive damages. For exam-
ple, the banking Trojan Gozi steals banking information to
automate the procedure of robbing online banking customers.
According to the indictment by the US Department of Justice
[38], Gozi alone infected more than 1 million computers and
caused tens of millions of dollars in losses. When an infected
visitor logs into the online banking system, the Trojan injects
form Ô¨Åelds (e.g., Fig. 2) that request additional information.
These sensitive Ô¨Ånancial data will be sent to the attackers.
Gozi also allows attackers to spoof the victim‚Äôs bank balance.
After transferring all available money , Gozi forces the victim‚Äôs
browser to display the original balance before the robbery [42].
Now, let‚Äôs inspect how the AdGholas campaign can effec-
tively infect so many victims without being caught for such a
long time. Fig. 3 shows the key steps, which involve multiple
parties, redirections and anti-monitoring checks. The standard
ad network bidding details are omitted.
241
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 14:53:14 UTC from IEEE Xplore.  Restrictions apply. Fig. 2. Gozi injects forms to steal sensitive Ô¨Ånancial information [42].
Victim
 Ad Network tinyURL.com
www.
Ad ContentAd Content
ads
ads                        Victim Profile
Malicious Banner 
(Steganography)Browser-
defence.com
target?Clean Banner no
yes
adsSilent Https RedirectStegano Exploit 
Kit landing page
Landing Page with Flash File Containing Encrypted Exploits
Targeted 
Flash Player 
?no
yes
adsFlash Player Version Matched
Password for Corresponding ExploitMalware 
Server
adsFlash Player 
Exploited
   Request For Malware
Malware
adsMalware Executed
Fig. 3. AdGholas campaign (Dec. 2016) [40]
After receiving the ‚Äúsniffering‚Äù scripts from the ad network,
visitors are proÔ¨Åled and Ô¨Åltered by a third-party website
browser-defence.com. If they are from the targeted regions,
they will get a banner with malicious code.
The next step is critical for evasion. AdGholas checks
the client-side environment and makes sure it‚Äôs not being
monitored. This is done by executing a JS snippet using
the Internet Explorer vulnerability CVE-2016-0162. However,
AdGholas follows a special and innovative design. Instead of
retrieving the code explicitly, it hides this malicious script
using steganography techniques. In particular, this JS snippet
is encoded in the alpha channel of the banner image, which
deÔ¨Ånes the transparency of each pixel. Then, The JS snippet
is decoded from the image and reconstructed on the Ô¨Çy.
If monitoring utilities such as anti-virus software are not
detected, the visitor will be silently redirected to the landing
page of the real exploit kit. The kit is designed to target
speciÔ¨Åc versions of the Flash players. If present, the exploited
Flash player will download binary executables of backdoors,
spyware or trojans and execute them without user consents.B. Annoying Ads
Besides malvertising, some ads are not deliberately harmful.
However, they may blink, Ô¨Çoat around, pop open a new win-
dow or automatically play sounds, which are irritating. Hub-
Spot Research conducted a survey on annoying ads [41]. They
interviewed 1;055 Internet users in the US, UK, Germany
and France in 2016, and found that pop-ups and video ads
are the most undesired ads. 83% agree that some ads should
be disallowed. 85% say obnoxious ads damage publisher‚Äôs
reputation and should be Ô¨Åltered out.
There are already efforts [50], [56], [61], [60] on detecting
undesired ads based on the observed behaviors. Ad-blockers
powered by predeÔ¨Åned blacklists are widely used. But they
are not sufÔ¨Åcient as they cannot suppress malvertising until
their patterns are discovered and modeled. Instead, we argue
that allowing publishers to persistently regulate third-party
contents is a better solution. Particularly, publishers may
specify regulations for an ad slot, which will be enforced for
all transactions and delegations introduced by the ad slot.
Fig. 4(a) shows a sample policy supported by PAD for the
ad tag ad_btf. It disallows any ad with sound after the
delegation chain becomes longer than 3 steps (we assume
the top-level ads vendors deliver multimedia ads properly).
Fig. 4(b) shows the ads without PAD, where sound related
resources are highlighted by 1 . Fig. 4(c) shows the ads loaded
with PAD enabled, where sound related tags are removed.
(b) Ad playing noisy sound
<html>...
<div id="ad_btf" ...>
  <iframe ...><iframe ...><iframe ...>
          <audio autoplay="autoplay">
             <source src="macalert.mp3" 
                     type="audio/mpeg">
          </audio> ...
  </iframe></iframe></iframe>
</div>...</html>(a) Enforcing Policy Rule with PAD
<pad> if (depth > 3) then block SOUND </pad>
<html>...
<div id="ad_btf" ...>
  <iframe ...><iframe ...><iframe ...>
     <!--
        <audio> tag is removed
        <source> tag is removed
     -->
  </iframe></iframe></iframe>
</div>...</html>1(c) Ad without noisy sound
2
Fig. 4. Preventing Ads Playing Sound
III. P ROBLEM STATEMENT
The current ads system has a very open policy: anyone can
bid for (and win) an ad slot and can resell the slot to other
parties. The current system is fundamentally vulnerable to ma-
licious/undesired ads that are intentionally or unintentionally
delivered by bidders. We study and classify the commonly
seen undesired ad behaviors in Table I.
TABLE I
COMMONLY SEEN UNDESIRED ADBEHAVIORS
Category (T
ype) Description/Examples
Malv ertising
(U1) Deliv
ering malicious software via ads
Intrusi v
e Ads (U2) Disrupt na
vigation behavior (e.g., popup)
Information Access pri
vate information for tracking
Disclosure (U3) Fingerprinting bro
wser/system versions
Inappropriate ads
(U4) Ads with
inappropriate contents (e.g., violence)
Nontransparent Ads with
encrypted/encoded Ô¨Çashes
ads(U5) Ads deli
vered through HTTP
Ad-blocking (U6) Blocking le
gitimate ads
Malvertising uses ad networks to deliver malicious software.
Intrusive ads distract visitors and cause unpleasant experience.
For example, some ads intentionally divert users‚Äô attention
242
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 14:53:14 UTC from IEEE Xplore.  Restrictions apply. Publisher 
Page Policy 
Compiler
< AD Code >
Publisher 
PagePAD Runtime
Publisher 
Page
Memory Protection
Access Control
DOM Randomization
Automated 
Runtime Installer
Policy 
Spec
< Policy Code >
< AD Code >< Policy Code >
< AD Code >Fig. 5. Overview
with audio or video. Information disclosure in ad delivery
leaks sensitive user information. Third party ads often contain
JS code that collects information on the client side and sends
them back to the advertisers. In many cases, sensitive informa-
tion is collected, causing privacy concerns. For example, user
browsing history is often collected to retarget ads. However,
exposing such history to nonreputable advertisers should be
regulated. Examples of inappropriate ads include videos of
violence for kids and ads from the publisher‚Äôs competitors
(which should not be displayed on the publisher‚Äôs web page).
Although ad networks have rules to prevent inappropriate ad
contents, these rules are usually too general and context-
insensitive. Nontransparent ads use stealthy techniques for
disguising themselves or preventing inspection. For example,
a malicious ad may dynamically construct a (malicious) Ô¨Çash
to avoid being detected. Ad-blocking removes ads from web
pages. While undesired ads are suppressed, ad-blockers also
block legitimate ads, eventually damaging the ecosystem.
While ad networks strive to suppress undesired ads, they
usually lack the necessary context to perform the needed Ô¨Åne-
grained regulation. For example, they may not have enough
information about the publisher site to determine what ads
are deemed inappropriate. They also lack the resources and
mechanism to regulate the huge volume of ads. Note that after
bidding, ads are often loaded directly from the advertisers‚Äô
servers to the client, without going through the ad networks.
We consider publishers to be the ideal party to regulate
unwanted ads and third-party contents because they have the
comprehensive contexts. They also have a strong incentive
to deliver relevant ads to the right consumers. In addition,
comparing to having centralized censorship on ad networks, it
is more scalable to do so on the individual client machines.
Therefore, our problem statement is to allow publisher
developers to program their regulation of third party ads
shown on their pages in a reliable and persistent fashion.
IV. O VERVIEW
We propose a novel programming support system for third
party ad censorship called PAD. As shown in Fig. 5, PAD
consists of three main components: the policy speciÔ¨Åcation
language, the policy compiler that compiles speciÔ¨Åcation to
JS code, and a runtime that facilitates regulations.
Policy SpeciÔ¨Åcation Language. PAD provides a language
for publisher developers to program their ad censorship. The
developers engineer their regulation logic within an ad tag in
the publisher‚Äôs content page using our language. Such tags
indicate the locations of ads, which are populated when the
content page is loaded.Policy Compiler. The policy compiler compiles censorship
policies in a content page to the corresponding JS code. Only
compiled pages are deployed. Each ad tag has its independent
policy code. In other words, censorship is ad tag speciÔ¨Åc.
This is because individual tags independently load ads from
different sources at runtime, requiring different regulations.
Programming global censorship (for an entire page or pub-
lisher domain) is possible but we leave it to our future work.
PAD Runtime. PAD runtime consists of 4 modules: Au-
tomated Runtime Installer (ARI) (xV-C1), Memory Protection
(xV-C2), Access Control (xV-C3) and Randomization (xV-C4).
They are essentially JS code that is shipped to the client.
Automated Runtime Installer (ARI). ARI is the core
engine enforcing the regulating code in all delegation layers.
For multi-layer ad networks, PAD monitors dynamically
generated contents and propagates itself into the next layer.
Memory Protection. Based on our extensive study on
malvertising campaigns in the wild, we observe that the
manipulation of consecutive memory regions in JS or Ac-
tionScript is the root cause of payload injection. To mitigate
malvertising attacks, PAD prevents payload injection by
perturbing values in consecutive memory regions.
Access Control. This module allows publishers to restrict
undesired ads such as information leak ads and intrusive
ads. The module essentially intercepts and/or masks some
JS APIs that are critical for undesired ads.
Randomization. To circumvent client-side Ad-blockers,
our runtime leverages an existing web page randomization
technique WebRanz [62] to bypass Ad-blockers‚Äô blacklist.
V. D ESIGN
In this section, we present the design of PAD. We describe
each component in detail and reason about our design choices.
A. Policy SpeciÔ¨Åcations
Program P ::=s
Stmt s ::=s1;s2jprotect sbjjblock caj
randomize ajif(e)thens
Expr e ::=curUrl opujdepth opcj
history containsfu1; u2; u3; :::g
Operator op ::= ! =j==j<j=j>
Subject sbj ::= MEMORYjFLASH
Capability ca ::= GEO-DATAjCOOKIEjBROWSER-VERSIONj
FLASH -PLAYER-VERSIONjEMBEDDED-FLASHj
LOADINGjMIMETYPEjPOPUPjSOUNDj
SRCLESS-IFRAMEjREDIRECTION
Attribute a ::= CANVAS -DATAjDOM
Const c ::=f0;1;2; :::g
Url curUrl; u
Fig. 6. Language.
The policy speciÔ¨Åcation language is presented in Fig. 6. The
language supports a few statements that specify the actions
243
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 14:53:14 UTC from IEEE Xplore.  Restrictions apply. <pad>
   if (curUrl != "doubleClick.com") then
  block BROWSER-VERSION
</pad>
...
<div id = "google_ads"></div>1
2
3
4
5
6Fig. 7. Publisher Page Code with Policy SpeciÔ¨Åcation
<script>
   ARI({"google_ads"});
</script>
<div id = "google_ads">
   <script>
   if (curUrl != "doubleClick.com") {
      Object.defineProperty(window, "navigator", {
         get: function() {
            return null;
         }
      });
   }    
   </script>
    ...
</div>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
Fig. 8. Publisher Page with Compiled Policy Code
for undesired ad behaviors, for example, protect memory,
block clients‚Äô cookies or geo-location data from being ac-
cessed by ad scripts, and randomize DOM to circumvent
ad blockers. The language also supports conditional branches
to allow publishers to specify the conditions in which the
above-mentioned actions should be taken. For example, a
publisher may wish to apply memory protection for certain
ad networks by comparing the current domain (curUrl) with
some domain uspeciÔ¨Åed by the publisher. We also support
comparison of delegation history, which records the entire ad
delegation/reselling history. Such history is quite useful. For
example, a cyclic delegation chain (i.e., an ad dealer sells
an ad slot and later buys it back) may suggest abnormal
behavior. Therefore, the current domain, the delegation depth,
and the delegation history are of special interest and explicitly
modeled in the language. Publisher developers can use regular
JS together with our language to achieve maximum feasibility.
B. Policy Compiler
Given a content page with policy specs, PAD parses the
page to a DOM tree using htmlparser2. It Ô¨Årst adds the
automated runtime installer at the beginning of the page to
make sure it gets executed before any other elements are
loaded. It then traverses the tree to identify all ad tags and
the corresponding policy specs. The JS statements in the specs
are simply copied to the output page whereas the statements
in our language are translated to the corresponding JS code
to fulÔ¨Åll the speciÔ¨Åc actions, including updating critical state
variables (e.g., delegation depth) and invoking API functions
provided by our runtime. The details are elided.
Fig. 7 and Fig. 8 illustrate how the policy compiler compiles
a program with access control specs. In Fig. 7, the publisher
includes an ad (with idof ‚Äúgoogle ads‚Äù) at line 6 and inserts
a spec at lines 2-3 to block browser versions from being Ô¨Ånger-
printed. In Fig. 8, the compiled policy code is inserted at lines
6-12. The compiled code redeÔ¨Ånes window.navigator
and changes its getter to returning null when a read attempt
is executed. The code at lines 6-12 is only effective at the
current layer of ad delegation. To propagate the policy codewhen inner frames are created, the function ARI at line 2
invokes the automated runtime installer (ARI) to self-install
the policy code along the entire propagation chain. We will
discuss the design of ARI in Sec. V-C1.
C. PAD Runtime
Algorithm 1 Automated Runtime Installer
INPUT : A compiled web app with instrumentation
guarding the 1st layer of each Ad
OUTPUT: Enforcing policy speciÔ¨Åcations over the entire
delegation chain during runtime
1procedure ARI(ads)
2 foradinadsdo
3 depth 0
4 history ;
5 globalVar fdepth, historyg
6 policyCode getPolicyCode(ad)
7 ifinnerIframeCreated() then
8 propagate(policyCode, globalVar)
9procedure PROPAGATE (policyCode,globalVar)
10 globalVar.depth globalVar.depth + 1
11 globalVar.history globalVar.history[curUrl
12 inject(globalVar)
13 inject(policyCode)
14 ifinnerIframeCreated() then
15 propagate(policyCode, globalVar)
1) Automated Runtime Installer (ARI): ARI provides per-
sistent protection along the ad delegation chain. At each
delegation layer, new content (such as HTML/JS/Flash/inner
frame) can be dynamically generated via JS functions such
asdocument.write(). ARI propagates PAD‚Äôs protection
logic along the delegation chain.
Alg. 1 describes the design of ARI. It takes a compiled
publisher page with ads guarded by instrumentation code. For
each ad within the page, ARI initializes global variables such
as the delegation depth (line 3), domain history (line 4)
and extracts the policy code generated from compiler for each
speciÔ¨Åcation (line 6). When an inner <iframe> is created,
ARI invokes a recursive function propagate() to propagate the
policy code and global variables to the next layer of delegation
(lines 7-8). The recursive function propagate() increments the
delegation depth (line 10) and updates the domain history
to include the current domain (line 11). Then it injects the
updated global variables and policy code into the current layer
(lines 12-13). The recursive procedure continues to propagate
if a next layer of <iframe> is dynamically generated.
<html><head><script src="PAD.js" ...>...</head>...
<div id="div-gtp-ad-..." ...>
</div>
...
</html><iframe  id="google _ads_iframe _..." ...>
<html><head><script src="PAD.js" ...>...</head>
</html>
</iframe ><iframe id="ad_creative ..." ...>
<html><head><script src="PAD.js" ...>...
    ...
    <script src="ad_content .js"></script>
    ...
</html>
</iframe >Publisher
Ad network
AdvertiserPublisher 's Webpage
Ad request via JS libs
document .write ("<iframe ...>...");
Ad request via JS libsF3F2A
B
C
Ad ContentWebpage requestF1
ARI rewr ites document .write ()
21
document .write ("<iframe ...>...");
ARI rewr ites document .write ()
3
Fig. 9. Recursively Applied ARI on Multiple Delegations
Fig. 9 depicts the code snippet of how ARI enforces PAD
in the delegation layers. The right side of Fig. 9 shows a
244
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 14:53:14 UTC from IEEE Xplore.  Restrictions apply. webpage including dynamically generated ad content during
the ad delivery process. Note that in the example, the pub-
lisher already installed PAD on their webpages by including
<script src="PAD.js" ...> (A in Fig. 9).
When a user visits the website, the web page with PAD
is loaded ( 1 ). During the page load, an ad request is
initiated to ad networks to retrieve the ad contents (e.g.,
HTML/JS/Flash). The ad contents are dynamically inserted
into the webpage ( 2 ) by creating an inner frame F2 . Note
that the document.write() at2 is executed within frame
F1 , where PAD is already installed. Hence, PAD intercepts
it at 2 and inserts <script src="PAD.js" ...> (B )
to install itself within the new inner frame. Similarly, another
layer of delegation is dynamically inserted into the inner page
F2 . At 3 , PAD inserts <script src="PAD.js" ...>
(C ) to install itself into the new inner frame F3 , where the
actual ad is Ô¨Ånally delivered. Since PAD is propagated through
delegations, it can enforce the protections persistently.
2) Memory Protection: In this section, we Ô¨Årst analyze
memory management related attack vectors in ads. Then,
we introduce our memory protection runtime support which
mitigates malvertising by corrupting malicious payloads.
Memory Management in Web Ads. As ads include JS/Flash
contents, they can allocate and access memory via JS or
ActionScript (AS) interfaces. We Ô¨Årst explain different ways
of accessing memory and how malicious ads exploit them.
[0][1][2][3][4]
[0][1][2][3][4]1 2 3 4 5 50 ...1.  var ary = [1, 2, 3, 4, 5]; // initialize
2.  ary[4] = 50; // change a value(a) An example of Array
(b) ary at Line 1:
(d) ary at Line 2:(c) Memory:
Fig. 10. Immutable Object
Immutable Objects. Immutable Objects are objects whose
previously stored values on the memory are not overwritten.
Fig. 10(a) illustrates a simple JS/AS program that initializes
an array and updates its Ô¨Åfth element. Fig. 10(b-c) show
how the array is allocated in the memory. Note that Array
in JS is actually implemented as a hash table and a set
of pointers to elements. More importantly, it is immutable,
meaning that changing a value in the array does not change
the previously stored value. Instead, as shown in Fig. 10(c),
a new memory buffer is allocated for the new value.
Mutable Objects (MO). Some JS and AS objects
can access memory directly. We call such objects mu-
table objects. Unlike immutable objects, mutable objects
allow overwriting previously stored values in memory.
More importantly, the buffer allocated for a mutable ob-
ject is consecutive. TypedArray (e.g., Uint8Array,
Uint16Array andUint32Array) and DataView in
JS and ByteArray/Vector in AS are popular classesthat can create mutable objects. Besides, Canvas in JS
andImageData are used to access image data (e.g., pixel
colors). They can create mutable objects too. Indeed, many
exploits leverage them to directly write consecutive memory
by changing image data (e.g., pixel colors in RGBA format).
Consecutive Immutable Objects (CIO). We call multiple
immutable objects that may be allocated in consecutive
memory consecutive immutable object. For example, in
modern browsers (e.g., Firefox and Chrome), Array ob-
jects in JS are allocated in consecutive buffers when they
hold a primitive type (e.g., integer). String objects are
also allocated in consecutive buffers.
Attacks on Memory in Malvertising. We analyze popular
malvertising campaigns and exploit kits used in attacks and
Ô¨Ånd that most attacks exploit vulnerabilities in JS/AS memory
management. In particular, they use mutable objects to inject
and trigger malicious payloads. In the following paragraphs,
we explain details of such attacks and their root causes.
Payload Injection and Triggering via Mutable Objects.
Mutable objects are widely used to inject and trigger
malicious payloads by overwriting critical values in memory
(e.g., return addresses). SpeciÔ¨Åcally, upon the allocation of
a mutable object, a new buffer is allocated and the corre-
sponding memory address and length are stored in memory.
When the mutable object is used, the address pointing to
the start of the buffer is retrieved in order to compute the
address for the access. If the address or the length of the
allocated buffer is compromised, an attacker can access
arbitrary memory just like accessing this mutable object.
Such compromise is often achieved through vulnerabilities
such as type confusion [25].
Payload Injection via CIO. As consecutive memory
buffers are allocated for CIO, they can be leveraged to inject
payloads like heap spraying. However, immutable objects
cannot be directly used to write arbitrary memory and
heap spraying itself does not trigger the injected payload.
Therefore, to launch an attack, the attacker must rely on
another vulnerability to trigger the injected code.
Algorithm 2 Memory Protection via Value Randomization
INPUT : A JS statement such as new Uint32Array([21, 3, 15])
OUTPUT: A Uint32Array object with value encoded
1procedure OVERLOADED UINT32A RRAY (values)
2 valuesInMemory Uint32Array(values.length)
3 fori= 0; i<values.length ;i++ do
4 valuesInMemory[i] encode(values[i])
5 this.values Uint32Array(valuesInMemory)
6 return this
INPUT : A JS statement such as u32arr.indexOf(15)
OUTPUT: Return the index of ‚Äú15‚Äù from [21, 3, 15]
7procedure OVERLOADED INDEX OF(elem)
8 valuesInMemory this.values
9 fori= 0; i<valuesInMemory.length ;i++ do
10 values[i] decode(valuesInMemory[i])
11 return this.indexOf(values)
Mitigating Malvertising via Memory Protection. We mit-
igate malvertising via memory protection, which is driven by
the procedure of attacks being launched using mutable objects
245
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 14:53:14 UTC from IEEE Xplore.  Restrictions apply. and consecutive immutable objects. Malvertising attacks are
conducted in two critical steps. First, a malicious payload
is injected into the victim‚Äôs memory via legitimate channels
(e.g., loading an image with a payload prepared by an exploit
kit), and heap spraying is often used due to address space
randomization techniques. Later, the payload is triggered and
executed by exploiting vulnerabilities. As these two steps are
essential to its success, malvertising can be suppressed by
breaking either step. We describe how we achieve this via
value and data layout randomization.
Value Randomization (Encoding/Decoding Values). PAD
breaks a malicious payload by perturbing values in memory.
In particular, it encodes values written to memory via
MO and CIO, and decodes them upon retrieval using
the same key employed in encoding. In this scenario,
malicious payload is encoded before being injected to
memory. However, since a malicious payload is always
executed natively, without going through the JS/AS in-
terfaces, it is not properly decoded before execution and
hence broken. Alg. 2 illustrates how value randomization
is realized for Uint32Array objects. SpeciÔ¨Åcally, when
a new Uint32Array object is created, instead of storing
the arguments ([21, 3, 15]) as array values, the overloaded
constructor (lines 1-6) encodes each element and the
encoded values are stored in memory. When the statement
invokes indexOf(15) on the previously created object,
theUint32Array.indexOf is overloaded (lines 7-11).
To return the index of element ‚Äú15‚Äù (i.e., 2), the values in
memory are decoded and the native implementation of
indexOf is invoked to return (lines 9-11).
Data Layout Randomization. PAD also randomizes the
underlying memory layout for JS/AS objects to break a
malicious payload, which is quite sensitive to memory
structures. In fact, attackers leverage CIOs to inject payloads
mainly because they provide a convenient (and reliable)
way to hold the carefully crafted payload in a consecutive
sequence of buffers. To randomize memory layout, when a
new CIO is created, PAD creates new dummy objects and
inserts them in between the original buffers. For instance,
when a program creates an array [1,2,3], PAD constructs
[1,R,2,R,3] instead, where Rrepresents a random value. As
a result, if an attacker tries to inject malicious ROP payloads
with CIO, the random values placed between ROP gadgets
will break the exploit. Note that the semantics of the array
is not broken as when the array is accessed, we translate
the index of the real values, skipping the inserted R.
3) Access Control: As discussed in Sec. V-B, the policy
compiler compiles the speciÔ¨Åcation program and redeÔ¨Ånes
objects such as window.navigator to block the access to
particular objects and achieve access control. During runtime,
the redeÔ¨Åned getters will be invoked rather than the native
functions. For example, as illustrated in Fig. 8 (line 6-12),
any read access to the browser information from domains other
than doubleclick.com viawindow.navigator is restricted.
Security sensitive objects and objects related with intrusive
ads are identiÔ¨Åed and redeÔ¨Åned during runtime. We omitthe discussion of other objects as they are similar to above-
mentioned case.
4) Randomization: WebRanz [62] is integrated into PAD.
WebRanz is a web page randomization technique which
protects advertisements from being blocked by ad-blockers.
SpeciÔ¨Åcally, it randomizes URLs and DOM element properties
(e.g., idandname), which ad-blockers rely on to locate
and remove ads. However, WebRanz is not sensitive to ad
tags. Instead, its randomization technique is applied to the
entire page, resulting in a high overhead. PAD only performs
randomization on ad contents within ad tags speciÔ¨Åed by
publishers. By doing so, publishers can deliver ads without
being blocked by ad-blockers with less overhead. As the
randomization technique is not our focus, details are omitted.
D. Threat Model
PAD assumes publishers and website visitors are benign,
while the ad-networks and advertisers may be malicious. Note
that, in most malvertising campaigns, the malicious party is the
advertiser. While the ad-networks might also be compromised,
protecting compromised publishers is beyond the scope of our
paper. In fact, if a publisher is compromised, any operation in
the compromised page cannot be trusted. Similarly, protecting
visitors with compromised systems (e.g., OS/Kernel/Browser)
is out of our scope.
Accessing Original DeÔ¨Ånitions. An attacker may try to bypass
PAD by locating and directly using the original functions or
classes. A straightforward way is scanning all variables to Ô¨Ånd
the ones holding the original versions. For example, window
in JS can be used to enumerate all deÔ¨Åned global variables. By
recursively resolving the global variables, one may gain access
to any variable including the variables holding the original
deÔ¨Ånitions. To prevent this, we disable variable enumerations
viaObject.defineProperty() as a part of our runtime
installer. Note that Object.defineProperty() is pro-
tected so an attacker cannot abuse this interface. Moreover,
even though it is not enumerable, if the variable names are
statically deÔ¨Åned, they can be directly accessed by names.
Hence, we generate random names for the variables that
contain original deÔ¨Ånitions. The name is randomized on each
load to make it a moving target.
Removing Our Protection. An attacker may try to remove
our protection by replacing classes and methods overwritten
by PAD with their own version. To prevent this, we use
defineProperty to make classes and methods we mod-
iÔ¨Åed read-only. SpeciÔ¨Åcally, we set writable property to
false and override defineProperty to prevent further
changes. As we do it at the very beginning of each delegation,
no JS code including malicious one can disable our deÔ¨Ånition.
Disabling Automated Runtime Installer. As PAD‚Äôs pro-
tection depends on ARI which installs itself and PAD, an
attacker may try to disable ARI. However, to achieve this,
the attacker needs to bypass our methods by calling the
original ones which we made impossible as discussed above.
In brief, one cannot remove our methods as they are read-
only (e.g., writable: false). To prevent any attempts
246
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 14:53:14 UTC from IEEE Xplore.  Restrictions apply. TABLE II
CHARACTERISTICS OF MALICIOUS ADCAMPAIGNS
Ad Date Publisher (Ad
Networks) First Ad
Redirect
1*17-01-14 [25] N/A (PropellerAds,
ClickAdu etc.) N/A
2*16-12-06 [33] Yahoo,
MSN (N/A) broxu.com
3 16-07-25 [10] N/A (Re
venueHits) foundationarcet.or g
4 16-07-05 [11] N/A (Re
venueHits) top4do wnload.or
g
5*16-05-25 [32] answers.com (DoubleClick,
Zedo etc.) rÔ¨Åhub .com
6 16-03-04 [34] nalsee.com (N/A) 49.238.137.2
7*15-09-30 [12] Japanese Ne
ws Sites (N/A) N/A
8 14-11-11 [9] wira-ku.com (N/A) a.horsered.com
9 14-10-06 [8] netw ork-tools.com
(N/A) ox.help.or g
10 14-09-29 [7] hindustantimes.com (N/A) static.rcs7.or g
11 14-09-11 [6] marica.bg (N/A) serve.intelelink.net
12 14-09-05 [5] centralpark.com (N/A) saw
.piroscia.com
13 14-08-25 [3] urbantoronto.ca (N/A) reserv e.sandystrong.or
g
14 14-08-22 [4] onlinene wspapers.com
(N/A) c.ic.com.au
15 14-06-28 [2] N/A (N/A) zamcheck.or g
16 14-06-19 [1] N/A (N/A) stat.litecsys.com
*:Proof-of-Concept
(PoC) sample.
N/A: Publisher/Ad trafÔ¨Åc is redacted or not included in sample.
to change
thewritable property of object, we override
defineProperty to disallow change requests.
VI. E VALUATION
PAD is implemented in JavaScript and ActionScript, lever-
aging a set of Node.js utilities. We investigated the following
research questions to evaluate the effectiveness of PAD to reg-
ulate third-party ads over the complex ads delegation process.
RQ1 How effective is PAD on preventing malvertising?
RQ2 How effective is PAD on preventing information leak
ads, non-transparent ads, inappropriate and intrusive ads?
RQ3 How much runtime overhead does PAD incur?
TABLE III
MALICIOUS ADCAMPAIGNS ‚Äô ATTACK VECTORS
Ad Exploit Kit Payload CVE Report Attack V
ector
1 Neutrino Trojans [26], [27] DataView
2 Steg
ano Spyw
are [24], [23],
[21], [22] ByteArray
3 Magnitude Cerber*[24] ByteArray
4 Magnitude Cerber*UNREPOR TED ByteArray
5 Angler Ransomw are [24] ByteArray
6 KaiXin PeCompact2, T
rojan [18] Vector
7 Angler Spyw
are [19], [20] Uint32Array, Vector
8 Angler Poweliks [17], [16],
[15] ByteArray
9 Sweet Orange Zemot#[17] Vector
10 Nuclear Crypto w
all*[17] Vector
11 Sweet Orange Gimemo T
rojan [17] Vector
12 Sweet Orange Zusy T
rojan [17] Vector
13 Nuclear Zemot#[17] Vector
14 Nuclear Zusy T
rojan [17] Vector
15 Sweet Orange Trojan
Dropper [17] Vector
16 Nuclear Zbot, Sp
yware [17] Vector
*:Ransomw
are. #: Downloader.
A. Experimental
Methodology
To answer the research questions, we run PAD on real
world ad examples. SpeciÔ¨Åcally, we collect 16 malvertising
ad samples (for RQ1) and 15 undesired ads (for RQ2). We
gather the source code of publisher web pages and host them
on our own web server. For the cases in which the publisher
is not reported or intentionally redacted, we set up a test page
to include the undesired ad(s) on our web server.
B. Experimental Results
RQ1: Malvertising Attacks. Table. II and III show the
malicious ad samples and the memory protection enforced.Column Publisher lists the websites redirecting to malware
through ad networks. First Ad Redirect andAd Networks
show the Ô¨Årst malicious redirect and the ad networks involved
in each malicious campaign.
We collect 12 samples of malvertising in the wild and
4 proof-of-concept (PoC) samples from online malvertising
reports. 15 of them are exploiting Adobe Flash Player, 3
samples for Internet Explorer and 1 for Microsoft Edge. Note
that it is very hard to collect malvertising samples from the
wild, as most malicious campaigns simply change their IPs
or ad networks once they are caught. Moreover, malvertising
attacks that exploit zero-day vulnerabilities make them very
difÔ¨Åcult to be detected. We have validated that all attacks can
be suppressed by one line of memory protection speciÔ¨Åcation.
Note that PAD provides a general protection hence it prevents
anunreported case (Ad 4) too.
RQ2: Undesired Ads. We investigate how PAD beneÔ¨Åts
the protection against intrusive ads (U2), information disclo-
sure ads (U3), inappropriate ads (U4), and nontransparent ads
(U5). Table. IV summarizes our Ô¨Åndings. Column Adand
Date are the reference and date of the undesired ad. Note
that entries with + are ads that are active as the time of
paper submission. The table also shows the Publisher involved
in each ad campaign and the access control speciÔ¨Åcation
publishers can leverage to suppress each undesired ad.
For example, ad [37] on nytimes.com redirects users to
a malicious page. Developers can leverage our speciÔ¨Åca-
tion language block REDIRECTION to disable redirec-
tions. [36] on youtube.com directs users to a Ô¨Çash ad which
Ô¨Ångerprints users‚Äô browser. To prevent users‚Äô browsers be-
ing Ô¨Ångerprinted, Youtube developers can specify block
BROWSER-VERSION with PAD. Preschool sites funology.com
andtwistynoodle.com serve inappropriate ads to children via
ad retargeting service. Publishers can use PAD to block
ads from particular domains. Ad [28] serves from ad net-
work domain ero-advertising.com embedded a Flash ad
onstopmalvertising.com to perform DDoS attacks. block
EMBEDDED-FLASH can be used to block such ads.
As shown in the result, all undesired ad behaviors are
prevented by enforcing our access control policies. A detailed
case study is discussed in VI-C3.
Page  
w/o PAD  Page  
with PAD  
0 1 2 3 4 5 6 7Average: 1.702  
Average: 1.674  Std: 4.480  
Std: 4.146  
Fig. 11. Page Load Latency
RQ3: Runtime Overhead. Finally, to understand the
runtime overhead induced by PAD, we study the average
latency of rendering a web page with and without PAD. We
choose Alexa top 200 websites, load each page 10 times and
calculate the average load time. As shown in Fig. 11, a web
browser takes a slightly longer time to render a web page when
it is enforced with our protection. This is because (1) PAD
introduces additional JavaScript and the browser needs extra
247
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 14:53:14 UTC from IEEE Xplore.  Restrictions apply. time to parse the code; (2) the self-propagating enforcement
intercepts the multiple layers of ad delivery on the Ô¨Çy. As
the size of additional JavaScript is small and the interception
is lightweight, the overhead of rendering a page with PAD
protection is negligible (1:67%). To avoid different ads being
loaded across runs (of the same website), we save all the
contents, including ads, and host them on our own proxy. We
also used a plugin to check each page load event. The plugin
is designed in such a way that any unsuccessful load causes
the browser to hang forever. In our experiment, we have not
encountered any such cases. This suggests that PAD does not
affect normal functionalities (including ads).
TABLE IV
ACCESS CONTROL ON UNDESIRED ADBEHAVIORS
Type Ad Date Publisher Access Contr
ol Spec
U2*+ +watchfomn
y.tvblock POPUPtorrentz.eu
[37] 09-09-13 nytimes.com block REDIRECTION
U3*[31] 16-04-12 N/Ablock MIMETYPE[31] 16-02-06 N/A
[36] 14-02-20 youtube.com block BROWSER-VERSION
[29] 12-01-21 Ô¨Åleserv e.com block FLASH-PLAYER-VERSION
U4*+ +funology.com
twistynoodle.com ifcurUrl
== "xxx.com"
+ + realstreamunited.tv then block
LOADING
+ + stream2w atch.cc
U5*[40] 16-12-06 N/A randomize CANVAS-DATA
[14] 15-05-12 N/A block LOADING
[35] 15-05-07 N/A block SRCLESS-IFRAME
[30] 15-02-04 gope go.com
block EMBEDDED-FLASH [13] 15-01-24 N/A
[28] 11-07-22 stopmalvertising.com
+: The
ad is active now. N/A: Publisher is redacted or not included in report.
C. Case
Study
In this section, we show three case studies to demonstrate
how PAD prevents undesired ad behavior in practice.
1) Type Confusion Vulnerability in Microsoft Edge: Type
confusion vulnerabilities have been reported lately in the JS
Engine (Chakra) of Microsoft Edge. When an ad is delivered,
JS can be injected for logging and dynamic ad delivery. Un-
fortunately, a malicious advertiser can also inject a malicious
JS Ô¨Åle to exploit the vulnerabilities to execute malicious code.
1  var dv = new DataView( new ArrayBuffer(8) );
2  Exploit_CVE_2016_7201( ... );  
      ...
3  var ropPtrAddr = ...; // Address of Stack
4  var rop = [ ..., 0x20564D603FA, 0x20560000000, ... ];
5  for (var i = 0; i < rop.length; ++i) {
6    dv.setUint32( retPtrAddr.add(i * 8), rop[i] );
7  }
Contents of Stack Memory (Injected payload)
0x20564D603FA
0x20560000000
0x211D000A2F5
0x211D000A2CD
...(b) w/o PAD (c) with PAD
0x0101030665D704FB
0x0101030661010101
0x01010312D101A3F6
0x01010312D101A3CE
...(a) Malicious JavaScript Program (CVE-2016-7200/7201)
 +0x0101...0101
 +0x0101...0101
 +0x0101...0101
 +0x0101...0101
 +0x0101...0101
Fig. 12. Malicious JS Program Exploiting DataView
Fig. 12(a) shows a malicious JS program which exploits
two vulnerabilities (CVE-2016-7200 and CVE-2016-7201). In
particular, it Ô¨Årst creates a DataView object which will be
used to inject a malicious payload at Line 1. Then, at Line 2,it leverages the vulnerabilities to obtain a corrupted DataView
object (dv). SpeciÔ¨Åcally, it exploits CVE-2016-7201 which is
a type confusion vulnerability to obtain the ability to modify
a target address of DataView when it reads and writes. As we
discussed in Sec. V-C2, a DataView object internally stores
a pointer to a buffer which holds its value and the length
of the buffer. CVE-2016-7201 essentially changes the pointer
of the buffer via a type confusion vulnerability. As a result,
after Line 2, the JS program can read and write arbitrary
memory through the corrupted object dv. SpeciÔ¨Åcally, by
changing the Ô¨Årst argument of setUint32 which speciÔ¨Åes
an offset of the DataView‚Äôs buffer for writing a value, an
attacker can overwrite values on any address he/she wants
to. Then, at Line 3, it obtains a stack address containing a
return address by exploiting address information leak. We omit
the detail due to the space limit. At Line 4, it constructs a
malicious ROP payload (rop[]) within an array. Finally, the
program injects the malicious payload at Lines 5-7 through
thesetUint32() method. Note that dvis already compro-
mised so that it can point to arbitrary buffer. Therefore, by
providing addresses pointing to the program‚Äôs stack, it injects
the malicious payload.
PAD protects the attack by mutating input values
passed to DataView. In particular, PAD overrides the
DataView.setUint32() to mutate any input parameter.
In this example, to make the discussion easier, we mutate
the input by adding 1 to every byte of a value passed to
setUint32(). For example, a 0x64D603FA input value will
be mutated to 0x65D704FB. Note that in our implementation,
we use a one time pad encoding scheme. Hence, we apply
different mutations every time. Fig. 12(c) shows an example
of a corrupted stack with a simple addition (+1 for each byte).
Observe that such a small addition completely breaks the
functionality of the payload and leads the exploit to a crash
as the execution jumps to an unmapped memory.
In addition to overriding setters (e.g., setUint32()),
we do also override getters (e.g., getUint32()) to decode
retrieved values in order to enable seamless execution of
benign program operations via DataView. The decoding
performs the exact reverse operation of the encoding process.
For example, if we encode by adding 0x1 to the values, we
decode by subtracting 0x1 at getters invocation.
2) Pixel Bender Parser Vulnerability in Adobe Flash
Player: Similar to the type confusion attack in Microsoft
Edge, Vector in AS can be corrupted by a vulnerability
on Pixel Bender Parser which is a high-performance graphic
programming interface for image processing.
1  var vt = new Vector.<int>( ... );
2  Exploit_CVE-2014-0515( ... );  
      ...
3  var ropPtrAddr = ...; // Address of Stack
4  var rop = [ ..., 0x70ff016a, 0x70fff870, ... ];
5  for ( ... ) {
6     vt[retPtrAddr + i * 4] = rop[i];
7  }
Fig. 13. Malicious AS Program Exploiting Vector
Fig. 13 shows a malicious Ô¨Çash Ô¨Åle which contains AS code
exploiting CVE-2014-0515 vulnerability. At Line 1, the code
248
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 14:53:14 UTC from IEEE Xplore.  Restrictions apply. Ô¨Årst allocates a Vector. The function at line 2 represents
exploiting the vulnerability in order to overwrite the length
ofVector. Note that Vector in AS and DataView in
JS have similar internal representations and thus share the
same problems of the vulnerable length information. By
overwriting the length ofVector, an attacker can gain
arbitrary memory access. Similar to the Edge case, it prepares
ROP gadgets and stack addresses, then injects the ROP pay-
load at Line 6. Note that it uses the [] operator to inject the
payload, instead of invoking a function. To handle this, PAD
also overrides the operator by using defineProperty with
index (e.g., 1, 2, and so on). Note that in JS/AS obj[name]
is equivalent to obj.name. Hence, we override obj.1(),
obj.2(), and so on. As in JS, PAD prevents the attack by
encoding the values passed through [] operator.
3) Preventing Geo-location Information Access: Personal-
ized ads are chosen based on the proÔ¨Åle of targeted customers.
While it is valuable to advertisers, collecting sensitive infor-
mation to deliver targeted ads is quite controversial. When
multiple ad networks are involved, it is hard to know and
control who collects what information. Hence, it is important
for publishers to protect their customers‚Äô sensitive information
from being collected by ad networks or advertisers.
<div id="div-gtp-ad1" ...>
  <script> 
    navigator.geolocation.
        getCurrentPosition( ... );
  </script>
  ...
</div> ...
<div id="div-gtp-ad1" ...>
  <script> 
    navigator.geolocation.
       getCurrentPosition( ... );
  </script>
  ...
</div>(a) Ad accesses geo-location
(b) Install PAD with Policy Spec
<script src="PAD.js"></script>
<pad>  block GEO-DATA  </pad>
...
<div id="div-gtp-ad1" ...>...
</div>(c) Ad Regulated by PAD
<script>
  navigator.geolocation.
   getCurrentPosition = function() { 
                           return null;
                        };
</script>1
2
3
45
6
Fig. 14. Preventing Geo-Location Accesses
In this case study, we show how PAD enables a pub-
lisher to protect its customer‚Äôs geo-location from being dis-
closed to ad networks and advertisers. Fig. 14(a) shows the
publisher web page without PAD. The tag div with id
div-gpt-ad1 (1 ) serves as an ad slot on the page. 2
shows the JS code loaded as a part of the ad delivery. It
accesses the geo-location of the customer via the JS interface
navigator.geolocation.getCurrentPosition.
Fig. 14(b) shows how PAD can be employed to enforce
the geo-location access control. First, the publisher developer
includes <script src="PAD.js"></script> at the
beginning of the page (Fig. 14- 3 ). Then, she can add policy
specblock GEO-DATA as shown in Fig. 14- 4 to enforce
that ‚Äúblocks geo-data on any delegation (any url)‚Äù.
Fig. 14(c) shows how PAD enforces the policy at runtime.
SpeciÔ¨Åcally, PAD Ô¨Årst overrides navigator.geolocatio
n.getCurrentPosition (5 ) to intercepts the access
to geo-location. When getCurrentPosition is invoked,
PAD checks the current speciÔ¨Åcations and applies actions
accordingly. In this case, the access control for blocking
geo-location takes effect. PAD returns empty geo-location
information instead of returning the real location( 6 ). Besidesblocking, Ô¨Çexible fuzzing methods such as reducing location
accuracy can be easily supported in PAD.
VII. R ELATED WORK
Malvertising detection. Zarras et al. [64] investigated the
source of malvertising and showed that every publisher with-
out an exclusive agreement with the advertiser is likely to serve
malicious ads. Xing et al. [63] performed a large scale study
on malvertising in ad-injecting browser extensions. OdoSwiff
[50] detects malicious Ô¨Çash Ô¨Åles based on known patterns
in the code and execution traces. In particular, it statically
looks for invalid images, suspicious jumps and APIs used in
known exploits. MadTracer [56] detects malvertising based
on rules learned from the ad delivery paths. Stringhini et al.
[61] and Mekky et al. [58] identify malicious content based
on HTTP redirections. Poornachandran et al. [60] proposed a
classiÔ¨Åer-based malvertising detection approach. As learning
based detections rely on patterns found in known attacks, they
may not catch unknown attacks. In contrast, we break the
payloads that are carefully crafted for speciÔ¨Åc defects, we can
stop the attacks even targeting at zero-day vulnerabilities.
Ads and security policies. Alt [48] presents an advertising
platform based on adaptive proÔ¨Åles, where visitors can setup
proÔ¨Åles to obtain favorable ads. AdJail [57] is a framework for
publishers to specify conÔ¨Ådentiality and integrity policies on
ads. AdSentry [49] allows publishers and end users to specify
access control policies for ads. Gui et al. [53] surveyed 21
Android apps and identiÔ¨Åed several undesired consequences
of ads including hidden costs and complaints. They further
studied 400 mobile ad reviews to identify complaint topics
[54]. Hussein et al. [55] use a runtime veriÔ¨Åcation tool to
enforce security speciÔ¨Åcation for Java. Ghotbi and Fischer
[51] presents a Ô¨Åne-grained role- and attribute-based access
control model. We focus on developing a policy language for
publishers so that they can easily specify how PAD operates.
VIII. C ONCLUSION
We propose a novel programming support system PAD to
regulate third party ads. PAD allows publisher programmers to
specify and enforce their ad regulation policies throughout the
entire ad delegation chain. This is enabled by a self-installing
and self-protecting runtime. PAD also features an ad-speciÔ¨Åc
memory protection scheme that prevents malvertising. Our
experiments show that PAD has negligible overhead and can
effectively prevent real world malvertising and undesired ads.
ACKNOWLEDGMENT
We thank the anonymous reviewers for their construc-
tive comments. This research was supported, in part, by
DARPA under contract FA8650-15-C-7562, NSF under awards
1409668, 1320444, 1320306, 1618923, and 1421910, ONR
under contracts N000141410468 and N000141712947, ERC
grant FP7-617805, and BMBF project CRISP. Any opinions,
Ô¨Åndings, and conclusions in this paper are those of the authors
only and do not necessarily reÔ¨Çect the views of our sponsors.
249
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 14:53:14 UTC from IEEE Xplore.  Restrictions apply. REFERENCES
[1] 2014-06-19 - NUCLEAR EK FROM 5.135.28.118.
http://www.malware-trafÔ¨Åc-analysis.net/2014/06/19/index.html.
[2] 2014-06-28 - SWEET ORANGE EK FROM 94.185.80.43 PORT 8590.
http://www.malware-trafÔ¨Åc-analysis.net/2014/06/28/index.html.
[3] 2014-08-15 - NUCLEAR EK FROM 178.32.92.105.
http://www.malware-trafÔ¨Åc-analysis.net/2014/08/25/index2.html.
[4] 2014-08-22 - NUCLEAR EK FROM 87.117.255.66.
http://www.malware-trafÔ¨Åc-analysis.net/2014/08/22/index.html.
[5] 2014-09-05 - SWEET ORANGE EK FROM 8.28.175.69.
http://www.malware-trafÔ¨Åc-analysis.net/2014/09/05/index.html.
[6] 2014-09-11 - SWEET ORANGE EK FROM 87.118.126.94.
http://malware-trafÔ¨Åc-analysis.net/2014/09/11/index.html.
[7] 2014-09-29 - NUCLEAR EK Delivers Digitally-signed Cryptowall Mal-
ware. http://www.malware-trafÔ¨Åc-analysis.net/2014/09/29/index.html.
[8] 2014-10-06 - Sweet Orange EK. http://www.malware-trafÔ¨Åc-
analysis.net/2014/10/06/index2.html.
[9] 2014-11-11 - ANGLER EK USES DIFFERENT OBFUSCATION
FOR THE MALWARE PAYLOAD. http://www.malware-trafÔ¨Åc-
analysis.net/2014/11/11/index.html.
[10] 2016-07-25 - MAGNITUDE EK FROM 51.254.181.39 SENDS
CERBER RANSOMWARE. http://www.malware-trafÔ¨Åc-
analysis.net/2016/07/25/index3.html.
[11] 2016-07-25 - MAGNITUDE EK FROM 51.254.181.39 SENDS
CERBER RANSOMWARE. http://www.malware-trafÔ¨Åc-
analysis.net/2016/07/05/index.html.
[12] 3,000 High-ProÔ¨Åle Japanese Sites Hit By Massive Malvertising Cam-
paign. https://blog.trendmicro.com/trendlabs-security-intelligence/3000-
high-proÔ¨Åle-japanese-sites-hit-by-massive-malvertising-campaign/.
[13] A Different Exploit Angle on Adobe‚Äôs Re-
cent Zero-Day. https://www.Ô¨Åreeye.com/blog/threat-
research/2015/01/a different exploit.html.
[14] Angler Exploit kit breaks Referer chain using HTTPS to HTTP redirec-
tion. https://hiddencodes.wordpress.com/2015/05/29/angler-exploit-kit-
breaks-referer-chain-using-https-to-http-redirection/.
[15] CVE-2013-2551: Buffer overÔ¨Çow in the Pixel Bender parser in Flash
Player. https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-
2013-2551.
[16] CVE-2014-0322: An use-after-free vulnerability in IE.
https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0322.
[17] CVE-2014-0515: Use-after-free involving the CMarkup object in IE.
https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0515.
[18] CVE-2014-0569: Interger OverÔ¨Çow in Sound.toString() in Flash Player.
https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0569.
[19] CVE-2015-2419: Double-free in jscript9‚Äôs JSON APIs.
https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-2419.
[20] CVE-2015-5560: Integer overÔ¨Çow in mp3 ID3 tag in Flash Player.
https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-5560.
[21] CVE-2015-8651: Integer overÔ¨Çow in domainMemory in Flash Player.
https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-8651.
[22] CVE-2016-0162: An information-disclosure vulnerability in IE.
https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-0162.
[23] CVE-2016-1019: Type confusion in FileReference class‚Äôs type checking
in Flash. https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-
2016-1019.
[24] CVE-2016-4117: Out-of-bound read in DeleteRangeTimelineOperation
in Flash. https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-
2016-4117.
[25] CVE-2016-7200, CVE-2016-7201 (Edge) and Exploit Kits.
http://malware.dontneedcoffee.com/2017/01/CVE-2016-7200-
7201.html.
[26] CVE-2016-7200: Info leak in Array.Ô¨Ålter in Chakra JavaScript engine.
https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-7200.
[27] CVE-2016-7201: Type confusion in FillFromPrototypes in Chakra.
https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-7201.
[28] DDoS Attacks - A new twist in Malvertisements.
http://stopmalvertising.com/malvertisements/ddos-attacks-a-new-twist-
in-malvertisements.html.
[29] Malvertisement on FileServe delivers Password Stealer via Ex-
ploits. http://stopmalvertising.com/malvertisements/malvertisement-on-
Ô¨Åleserve-delivers-password-stealer-via-exploits.html.
[30] Malvertising on Indonesian portal gopego.com delivers Cryptowall 3.0.
https://www.cyphort.com/gopego-malvertising-cryptowall/.[31] Microsoft Patches CVE-2016-3351 Zero-Day, Exploited
By AdGholas and GooNky Malvertising Groups.
https://www.proofpoint.com/us/threat-insight/post/Microsoft-Patches-
Zero-Day-Exploited-By-AdGholas-GooNky-Malvertising.
[32] New wave of malvertising leverages latest Flash exploit.
https://blog.malwarebytes.com/cybercrime/2016/05/new-wave-of-
malvertising-leverages-latest-Ô¨Çash-exploit/.
[33] Readers of popular websites targeted by stealthy
Stegano exploit kit hiding in pixels of malicious ads.
http://www.welivesecurity.com/2016/12/06/readers-popular-websites-
targeted-stealthy-stegano-exploit-kit-hiding-pixels-malicious-ads/.
[34] Recent example of KaiXin exploit kit. https://isc.sans.edu/forums/diary/
Recent+example+of+KaiXin+exploit+kit/20827/.
[35] Security: Referer chain breaking by abusing src-less iframe body con-
text. https://bugs.chromium.org/p/chromium/issues/detail?id=485722.
[36] The Wild Wild Web: YouTube ads serving malware.
https://labs.bromium.com/2014/02/21/the-wild-wild-web-youtube-
ads-serving-malware/.
[37] Anatomy of a Malware Ad on NYTimes.com.
http://troy.yort.com/anatomy-of-a-malware-ad-on-nytimes-com/, 2009.
[38] Three Alleged International Cyber Criminals Responsible For
Creating And Distributing Virus. https://www.justice.gov/usao-
sdny/pr/three-alleged-international-cyber-criminals-responsible-creating-
and-distributing-virus, 2013.
[39] Cyphort Lab, The Rise of Malvertising. http://go.cyphort.com/rs/181-
NTN-682/images/Malvertising-Report-15-RP.pdf, 2015.
[40] Eset Research, Readers of popular websites targeted by
stealthy Stegano exploit kit hiding in pixels of malicious ads.
http://www.welivesecurity.com/2016/12/06/readers-popular-websites-
targeted-stealthy-stegano-exploit-kit-hiding-pixels-malicious-ads, 2016.
[41] Mimi An, Why People Block Ads And What It Means for Marketers and
Advertisers. https://research.hubspot.com/reports/why-people-block-
ads-and-what-it-means-for-marketers-and-advertisers, 2016.
[42] Proofpoint, Massive AdGholas Malvertising Campaigns Use
Steganography and File Whitelisting to Hide in Plain Sight.
https://www.proofpoint.com/us/threat-insight/post/massive-adgholas-
malvertising-campaigns-use-steganography-and-Ô¨Åle-whitelisting-to-
hide-in-plain-sight, 2016.
[43] The Guardian, Major sites including New York
Times and BBC hit by ‚Äòransomware‚Äô malvertising.
https://www.theguardian.com/technology/2016/mar/16/major-sites-
new-york-times-bbc-ransomware-malvertising, 2016.
[44] The Interactive Advertising Bureau (IAB), 2015 Internet Advertising
Revenue Full-Year Report. http://www.iab.com/wp-content/uploads/20
16/04/IAB Internet Advertising Revenue Report FY2015-Ô¨Ånal.pdf,
2016.
[45] W3Techs Web Technology Surveys, Usage of advertising networks
for websites. https://w3techs.com/technologies/overview/advertising/all,
2016.
[46] Zeljka Zorz, Malvertising campaign hits MSN.com, NY Times,
BBC, AOL. https://www.helpnetsecurity.com/2016/03/16/malvertising-
campaign/, 2016.
[47] PageFair, 2017 Global Adblock Report.
https://pagefair.com/downloads/2017/01/PageFair-2017-Adblock-
Report.pdf, 2017.
[48] Florian Alt, Moritz Balz, Stefanie Kristes, Alireza Sahami Shirazi, Julian
Mennen ¬®oh, Albrecht Schmidt, Hendrik Schr ¬®oder, and Michael Goedicke.
Adaptive User ProÔ¨Åles in Pervasive Advertising Environments. In Pro-
ceedings of the European Conference on Ambient Intelligence, AmI‚Äô09,
pages 276‚Äì286, Salzburg, Austria, 2009.
[49] Xinshu Dong, Minh Tran, Zhenkai Liang, and Xuxian Jiang. Ad-
sentry: Comprehensive and Flexible ConÔ¨Ånement of Javascript-based
Advertisements. In Proceedings of the 27th Annual Computer Security
Applications Conference, ACSAC‚Äô11, pages 297‚Äì306, Orlando, Florida,
USA, 2011.
[50] Sean Ford, Marco Cova, Christopher Kruegel, and Giovanni Vigna.
Analyzing and Detecting Malicious Flash Advertisements. In Proceed-
ings of the 2009 Annual Computer Security Applications Conference,
ACSAC‚Äô09, pages 363‚Äì372, Honolulu, Hawaii, USA, 2009.
[51] Seyed Hossein Ghotbi and Bernd Fischer. Fine-Grained Role- and
Attribute-Based Access Control for Web Applications. In International
Conference on Software and Data Technologies, ICSOFT‚Äô12, pages 171‚Äì
187, Berlin, Heidelberg, 2012.
250
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 14:53:14 UTC from IEEE Xplore.  Restrictions apply. [52] Daniel G. Goldstein, Siddharth Suri, R. Preston McAfee, Matthew
Ekstrand-Abueg, and Fernando Diaz. The Economic and Cognitive Costs
of Annoying Display Advertisements. Journal of Marketing Research,
51(6):742‚Äì752, 2014.
[53] Jiaping Gui, Stuart Mcilroy, Meiyappan Nagappan, and William G. J.
Halfond. Truth in Advertising: The Hidden Cost of Mobile Ads
for Software Developers. In Proceedings of the 37th International
Conference on Software Engineering - Volume 1, ICSE‚Äô15, pages 100‚Äì
110, Florence, Italy, 2015.
[54] Jiaping Gui, Meiyappan Nagappan, and William G. J. Halfond. What
Aspects of Mobile Ads Do Users Care About? An Empirical Study of
Mobile In-app Ad Reviews. arXiv:1702.07681, 2017.
[55] Soha Hussein, Patrick Meredith, and Grigore Ros ¬∏lu. Security-policy
Monitoring and Enforcement with JavaMOP. In Proceedings of the
7th Workshop on Programming Languages and Analysis for Security,
PLAS‚Äô12, pages 3:1‚Äì3:11, Beijing, China, 2012.
[56] Zhou Li, Kehuan Zhang, Yinglian Xie, Fang Yu, and XiaoFeng Wang.
Knowing Your Enemy: Understanding and Detecting Malicious Web
Advertising. In Proceedings of the 2012 ACM Conference on Computer
and Communications Security, CCS‚Äô12, pages 674‚Äì686, Raleigh, North
Carolina, USA, 2012.
[57] Mike Ter Louw, Karthik Thotta Ganesh, and V . N. Venkatakrishnan.
Adjail: Practical Enforcement of ConÔ¨Ådentiality and Integrity Policies
on Web Advertisements. In Proceedings of the 19th USENIX Conference
on Security, USENIX Security‚Äô10, pages 24‚Äì24, Washington, DC, 2010.
[58] H. Mekky, R. Torres, Z. L. Zhang, S. Saha, and A. Nucci. Detecting
Malicious HTTP Redirections Using Trees of User Browsing Activity. In
IEEE Conference on Computer Communications, INFOCOM‚Äô14, pages
1159‚Äì1167, Toronto, Canada, 2014.
[59] Tommi Mikkonen and Antero Taivalsaari. The Mashware Challenge:Bridging the Gap Between Web Development and Software Engineering.
InProceedings of the FSE/SDP Workshop on Future of Software Engi-
neering Research, FoSER‚Äô10, pages 245‚Äì250, Santa Fe, New Mexico,
USA, 2010.
[60] Prabaharan Poornachandran, N. Balagopal, Soumajit Pal, Aravind
Ashok, Prem Sankar, and Manu R. Krishnan. Demalvertising: A Kernel
Approach for Detecting Malwares in Advertising Networks, pages 215‚Äì
224. Springer Singapore, Singapore, 2017.
[61] Gianluca Stringhini, Christopher Kruegel, and Giovanni Vigna. Shady
Paths: Leveraging SurÔ¨Ång Crowds to Detect Malicious Web Pages. In
Proceedings of the 2013 ACM SIGSAC Conference on Computer &#38;
Communications Security, CCS‚Äô13, pages 133‚Äì144, Berlin, Germany,
2013.
[62] Weihang Wang, Yunhui Zheng, Xinyu Xing, Yonghwi Kwon, Xiangyu
Zhang, and Patrick Eugster. WebRanz: Web Page Randomization for
Better Advertisement Delivery and Web-bot Prevention. In Proceedings
of the 2016 24th ACM SIGSOFT International Symposium on Founda-
tions of Software Engineering, FSE‚Äô16, pages 205‚Äì216, Seattle, WA,
USA, 2016.
[63] Xinyu Xing, Wei Meng, Byoungyoung Lee, Udi Weinsberg, Anmol
Sheth, Roberto Perdisci, and Wenke Lee. Understanding Malvertising
Through Ad-Injecting Browser Extensions. In Proceedings of the 24th
International Conference on World Wide Web, WWW ‚Äô15, pages 1286‚Äì
1295, Florence, Italy, 2015.
[64] Apostolis Zarras, Alexandros Kapravelos, Gianluca Stringhini, Thorsten
Holz, Christopher Kruegel, and Giovanni Vigna. The Dark Alleys of
Madison Avenue: Understanding Malicious Advertisements. In Pro-
ceedings of the 2014 Conference on Internet Measurement Conference,
IMC‚Äô14, pages 373‚Äì380, Vancouver, BC, Canada, 2014.
251
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 14:53:14 UTC from IEEE Xplore.  Restrictions apply. 