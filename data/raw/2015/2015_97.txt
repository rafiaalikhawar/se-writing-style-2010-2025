Jens Knoop, Uwe Zdun (Hrsg.): Software Engineering 2016,
Lecture Notes in Informatics (LNI), Gesellschaft f ¨ur Informatik, Bonn 2016 97
Morpheus: Variability-Awar eRefactoring in the Wild
J¨orgLiebig1,SvenApel2,Andreas Janker3,Florian Garbe4,and Sebastian Oster5
Abstract: Today,manysoftware systems are conﬁgurable with conditional compilation. Just like
anysoftware system, conﬁgurable systems need to be refactored during their evolution. The inherent
variability of conﬁgurable systems induces an additional dimension of complexity that is not addressed
properly by current academic and industrial refactoring engines. Even simple refactorings, such as
RENAME IDENTIFIER ,are not handled well by existing refactoring engines and may introduce errors
in some variants of the conﬁgurable system to be refactored. Toimpro vethe state of the art, we
propose avariability-a ware refactoring approach that relies on a canonical variability representation
andvariability-awar eanalysis .The goal is to preserv ethe behavior of all variants of the conﬁgurable
system, without compromising general applicability and scalability .T od emonstrate practicality ,w e
developed M ORPHEUS ,asound variability-a ware refactoring engine for Ccode with preprocessor
directi ves.Weapplied M ORPHEUS to three substantial real-world systems ( Busybox ,OpenSSL ,and
SQLite )showing that variability-a ware refactoring is practical (i.e., scalable, sound, and complete) in
the presence of conditional compilation.
Keywords: conﬁgurable systems, refactoring, preprocessor
Formore than 40 years software de velopers implement conﬁgurable software systems in
the programming language Cusing conditional compilation with the Cpreprocessor CPP.
Using preprocessor directi ves, such as#ifdef s, developers write optional and alternati ve
code fragments, which form the basis to tailor aconﬁgurable system to different application
scenarios and use cases. Man ydevelopers are familiar with #ifdef s, and practically every
software system written in Ci sc onﬁgurable with conditional compilation [ Li10 ].Toevolve
and maintain software systems, software de velopers usually rely on refactoring engines
as part of integrated de velopment environments, such as E CLIPSE .Arefactoring engine
isatool, which (semi-) automatically applies code restructings with the goal to impro vethe
internal code structure while preserving the external program behavior [ Me02 ]. Howe ver,
evolving and maintaining conﬁgurable systems is challenging, as the behavior not only of
asingle system, buto fm ultiple system variants ha veto be considered, something which
is not adressed properly in current refactoring engines.
Toassess the state-of-the-art of refactoring engines for conﬁgurable systems, we conducted
an empirical study to classify strategies of ho wexisting refactoring engines (industrial,
open-source, and academic) handle refactorings for conﬁgurable systems [ Li15 ]. Overall,
we found that there are ﬁvedifferent strategies: code restructurings using standard editor fa-
cilities ( ﬁnd/replace ), applying refactorings to single variants only ( single variant ), applying
refactorings to multiple variants in isolation ( variant-based ), support for source code with a
1Method Park, joerg.liebig@methodpark.de
2University of Passau, apel@ﬁm.uni-passau.de
3University of Passau, janker@ﬁm.uni-passau.de
4University of Passau, fgarbe@ﬁm.uni-passau.de
5Method Park, sebastian.oster@methodpark.de98 J ¨orgLiebig et al.
limited set of #ifdef usage patterns in conﬁgurable code ( limited patterns ), and in volving
heuristics to reasons about code restructurings in the presence of preprocessor directi ves
(heuristics ). All strategies suffer from certain limitations that hinder their applicability in
practice: the yare error-prone ( ﬁnd/replace ), are incomplete ( single variant andlimited
patterns ), do not scale ( variant-based ), or are unsound ( heuristics ).Forexample, even a
simple refactoring, such as E XTRACT FUNCTION ,does not work properly in the popular de-
velopment environment E CLIPSE in the presence of #ifdef s. In E CLIPSE ,which applies a
single-variant strategy ,w eo bserved adifferent program behavior after code restructurings.
Asexisting strategies and refactoring engines ha veserious shortcommings, which hinder
their application in practice, we de veloped our ownstrategy ,called variability-awar erefac-
toring [Li15]. The idea is to use variability-a ware data-structures and algorithms [ Wa14,
Li13 ,K¨a11]for this task, i.e., data-structures and algorithms, which incorporate variability
in the form of #ifdef sdirectly during code restructurings. Toassess the applicability of
variability-a ware refactoring, we implemented variability-a wareversions of three common
refactorings (RENAME IDENTIFIER ,EXTRACT FUNCTION ,and I NLINE FUNCTION )a s
part of our ownrefactoring engine: M ORPHEUS .I ne xperiments with three, real-world case
studies ( Busybox ,OpenSSL ,andSQLite ), we could sho wthatvariability-a ware refactoring
scales well to practical conﬁgurable systems, while preserving the behavior of all variants.
Theaverage time for applying asingle refactoring is in the order of milliseconds. With
variability-a ware refactoring, we close agap in tool-support for conﬁgurable software
systems and sho wthat, for the ﬁrst time, ascalable, sound, and complete refactoring engine
forC(including preprocessor directi ves) is possible.
References
[K¨a11] K¨astner ,C.; Giarrusso, P.;Rendel, T.;Erdweg, S.; Ostermann, K.; Berger ,T.:Variability-
AwareParsing in the Presence of Lexical Macros and Conditional Compilation. In: Pro-
ceedings of the Conference on Object-Oriented Programming, Systems, Languages, and
Applications (OOPSLA). ACM, pp. 805–824, 2011.
[Li10] Liebig, J.; Apel, S.; Lengauer ,C.; K¨astner ,C.; Schulze, M.: An Analysis of the Variability
inForty Preprocessor-Based Software Product Lines. In: Proceedings of the International
Conference on Software Engineering (ICSE). ACM, pp. 105–114, 2010.
[Li13] Liebig, J.; vonRhein, A.; K ¨astner ,C.; Apel, S.; D ¨orre, J.; Lengauer ,C.: Scalable Analysis of
Variable Software. In: Proceedings of the European Software Engineering Conference and
theACMSIGSOFT Symposium on the Foundations of Software Engineering (ESEC/FSE).
ACM, pp. 81–91, 2013.
[Li15] Liebig, J.; Janker ,A.; Garbe, F.;Apel, S.; Lengauer ,C.: Morpheus: Variability-A ware
Refactoring in the Wild. In: Proceedings of the International Conference on Software
Engineering (ICSE). ACM, pp. 380–391, 2015.
[Me02] Mens, T.:AS tate-of-the-Art Surv eyon Software Merging. IEEE Transactions on Software
Engineering, 28(5):449–462, 2002.
[Wa14] Walkingsha w,E.; K ¨astner ,C.; Erwig, M.; Apel, S.; Bodden, E.: Variational Data Structures:
Exploring Tradeoffs in Computing with Variability. In: Proceedings of the International
Symposium on Ne wIdeas in Programming and Reﬂections on Software (Onward!). ACM,
pp. 213–226, 2014.