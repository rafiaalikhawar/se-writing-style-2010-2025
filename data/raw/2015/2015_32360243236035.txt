Phys: ProbabilisticPhysicalUnit Assignment
and Inconsistency Detection
Sayali Kate
PurdueUniversity, USA
skate@cs.purdue.eduJohn-Paul Ore
University ofNebraskaśLincoln, USA
jore@cse.unl.eduXiangyuZhang
PurdueUniversity, USA
xyzhang@cs.purdue.edu
Sebastian Elbaum
University ofNebraskaśLincoln, USA
elbaum@cse.unl.eduZhaoguiXu
Nanjing University, China
zhaogui.xu@outlook.com
ABSTRACT
Programvariablesusedinroboticandcyber-physicalsystemsoften
haveimplicitphysicalunitsthatcannotbedeterminedfromtheir
variabletypes.Inferringanabstractphysicalunittypeforvariables
andcheckingtheirphysicalunittypeconsistencyisofparticular
importanceforvalidatingthecorrectnessofsuchsystems.Forin-
stance,avariablewiththeunitof‘meter’shouldnotbeassigned
toanothervariablewiththeunitof‘degree-per-second’.Existing
solutionshavevariouslimitationssuchasrequiringdevelopersto
annotate variables with physical units and only handling variables
that are directly or transitively used in popular robotic libraries
with known physical unit information. We observe that there are a
lot of physical unit hints in these softwares such as variable names
and specific forms of expressions. These hints have uncertainty
as developers maynot respectconventions.We propose tomodel
them with probability distributions and conduct probabilistic in-
ference. At the end, our technique produces a unit distribution
foreachvariable.Unitinconsistenciescanthenbedetectedusing
thehighlyprobableunitassignments.Experimentalresultson30
programs show that our technique can infer units for 159.3% more
variables compared to the state-of-the-art with more than 88.7%
truepositives,andinconsistenciesdetectionon90programsshows
that our technique reports 103.3% more inconsistencies with 85.3%
true positives.
CCS CONCEPTS
·Software and its engineering →Abstract data types ;Soft-
waredefectanalysis ;·Mathematicsofcomputing →Factor
graphs;
KEYWORDS
abstract type inference; physical units;static analysis; unitconsis-
tency;dimensionalanalysis;probabilisticinference;roboticsystems
Permissionto make digitalor hard copies of allorpart ofthis work for personalor
classroom use is granted without fee provided that copies are not made or distributed
forprofitorcommercialadvantageandthatcopiesbearthisnoticeandthefullcitation
on the first page. Copyrights for components of this work owned by others than ACM
mustbehonored.Abstractingwithcreditispermitted.Tocopyotherwise,orrepublish,
topostonserversortoredistributetolists,requirespriorspecificpermissionand/ora
fee. Request permissions from permissions@acm.org.
ESEC/FSE ’18, November 4ś9, 2018, Lake BuenaVista,FL,USA
©2018 Associationfor Computing Machinery.
ACM ISBN 978-1-4503-5573-5/18/11...$15.00
https://doi.org/10.1145/3236024.3236035ACMReference Format:
SayaliKate,John-PaulOre,XiangyuZhang,SebastianElbaum,andZhaogui
Xu.2018.Phys:ProbabilisticPhysicalUnitAssignmentandInconsistency
Detection.In Proceedingsofthe26thACMJointEuropeanSoftwareEngineer-
ingConferenceandSymposiumontheFoundationsofSoftwareEngineering
(ESEC/FSE ’18),November 4ś9, 2018, LakeBuena Vista, FL, USA. ACM, New
York, NY, USA, 11pages.https://doi.org/10.1145/3236024.3236035
1 INTRODUCTION
Programvariablesrepresentingphysicalunitslike meterorradian
arecommoninroboticandcyber-physicalsystems.However,the
typesofthesevariables(e.g., floatanddouble)canhardlydenote
such physical information. While compilers and many analysis
techniquesensurevariablesaremanipulatedaccordingtothetyp-
ingrules,ensuringvariableswithphysicalunitsaremanipulated
accordingtothesemanticsofthephysicalworld,however,isless
commonandyetascrucialforthesekindsofsystems.Forexample,
a recent study found hundreds of faulty manipulations in robots
using the ROS middleware [ 22]. Those systems builtcorrectly but
presented inconsistent unit manipulations such as assigning linear
(meter-per-second ) and angular ( radian-per-second ) units to
avariable,oraddingvariablesrepresentingvelocity( meter-per-
second) anddistance ( meter).
Automated approaches to aid in the detection of inconsistent
usageofvariablesrepresentingphysicalunitsincludeunit-aware
programming languages [ 1,31], unit-aware libraries [ 9,30], and
unittypeannotations[ 10].Theseapproaches,however,havenot
been broadly adopted in part because of their associated cost in
modifyingexistingsystemsorchangingentrencheddevelopment
practices.Approachesthatrequirenoadditionaldevelopmentin-
vestment are desirable but rare. One of such approaches, Unify,
candetectunitusage discrepanciesacrossversions[ 7],butitcan-
notdetectunitinconsistencieswhenavariableisfirstintroduced.
Anotherapproachistakenby Ayudante [8],whichinfersabstract
typeinconsistenciesbycontrastingclustersofvariablesbasedon
dataflowversusclustersbasedonthemeaningofvariablenames
asperalargelexicaldatabase[ 18].Thisapproach,however,misses
muchoftheuniqueconstructivesemanticsofphysicalunits(like
meter2= meter * meter )andassumesthatallthesevariableand
name associations are certain, when in practice they are probabilis-
tic.Amorebroadlyapplicableapproachthatrequiresnoadditional
developer investment is Phriky-Units (Phriky), which relies on one-
timemappingofphysicalattributesinshared-librariestounits[ 23]
toinfertheunitsofvariables,andusesalightweightdataflowanal-
ysisandunitpropagationtofacilitateinconsistencydetectionusing
563
ESEC/FSE’18,November4–9, 2018, Lake Buena Vista,FL,USA S.Kate,J. Ore,X. Zhang, S.Elbaum, Z. Xu
dimensionalanalysis.Theone-timemappingandlightweightanaly-
sisthatmake Phrikycost-effectiveatdetectinginconsistencies,also
limititspower.Inparticular,wenoticedthat Phrikyonlyassigns
units to a small fraction of the variables of non shared-library data
types that hold physical units (in this paper we quantify that space
to be under31.56%).
To address that limitation, we propose an approach that can tap
onnewsourcesofinformationtoassignunitstoalargerportionof
thevariablespace,facilitatingthedetectionofmoreinconsistencies.
The approach builds on two key insights. First, variables represent-
ing physical entities are often named and operated on to reflect
thoseentities,givinghintsaboutvariables’units.Forexample,in
the statement: v = angSpeed * wheel_diam/2 , names ‘angSpeed’ and
‘wheel_diam ’ suggest that they represent angular speed and length
respectively, and a multiplication operation on them indicates that
variablevis intended to represent linear velocity. Second, since
the correctness of these hints is not certain (developers can violate
naming conventions or inappropriately operate on units) we must
deal with themprobabilistically.For example, sincename‘ wheel_-
diam’doesnotusetheentityterm‘ diameter’completely,wecan
only say that it is likely to have unit ‘ meter’ with some probability.
Put together, these insights indicate that there are hints to be
leveragedbuttodosoweneedtomodelthesourcesof uncertainty
in terms of probabilities. More specifically, our approach: 1) col-
lects initial observations (or beliefs) based on various evidences
such as variable names and expression forms that suggest physical
unit (e.g., expression x>πindicates xhas unit ‘ radian’), and
encodes them as initial probabilities to model uncertainty; 2) an-
alyzes the code to generate five kinds of probability constraints
that denote dependencies between variable units; 3) generates a
graph where the nodes are the initial observations and constraints
transformed into functions on the variables, and the edges connect
the functionswith theircorresponding variables;and 4)performs
belief propagation [ 25]along theedges to determine theposterior
probabilities denoting the likelihood that a variable would have
an associated physical unit. Once the variables have a physical
unit assigned, detection of inconsistency is performed following
establisheddimensionalanalysisrules[ 3].
The contributionsofour work are:
•A probabilistic approach for physical unit inference and
inconsistency detection that takes advantage of variables’
names,expressionforms,andassociatedoperationstomake
probabilisticinferences ofunittypes.
•Aprototypeoftheapproachimplementedinatool, Phys,that
assignsunitsanddetectsinconsistenciesonC++programs.
•An evaluation on 90 sample ROS-based project files. The
assessmentshowsthat Physcaninferunitsfor159.27%more
variables of non shared-library data types in 30 sample files
(with more than 88.7% true positives), and detect 103.31%
more inconsistencies in 90 sample files (with 85.3% true pos-
itives),when comparedwiththe state-of-the-art.
2 BACKGROUND
Inthissection,weintroducethebasicnotationsofphysicalunits
and unit-inconsistencies, and provide a brief overview of proba-
bilisticinference basedongraphicalmodels.2.1 Physical-unitsandUnit-inconsistency
Detection
Inroboticsoftware,somevariablesrepresentthephysicaldimen-
sions such as length, velocity, and acceleration. Each of these vari-
ables carries a physical-unit, e.g., a variable representing length
stores a value ofunit ‘ meter’. Operations on such variables need
tofollowcertaindimensionalrules,e.g.,alengthvaluecannotbe
added to a velocity value. Violation of such a rule, we refer to
asunit-inconsistency . In order to detect a unit-inconsistency, we
firstneedtocollect thephysical-unitinformationof eachvariable.
However,physical-unitinformationisnotexplicitlydeclaredfor
variablesunliketypeinformation.Forexample,whilelengthand
velocity carry different physical-units, ‘ meter’ and ‘meter-per-
second’, respectively, they may be represented by variables of the
sametype,e.g.,‘ float’.Therefore,traditionaltypecheckingofa
softwareprogramcannotdetectunit-inconsistencies.Anewkindof
analysis is required to detect unit-inconsistencies. These analyses
focus on inferring the physical-units of variables. There have been
anumberofpreviousworksthataimtoaddressthischallengesuch
as the tools Phriky[23,24]andOsprey[10].
Inparticular, Phrikyperformsunitconsistencyanalysisonpro-
gramsthatusearoboticshared-librarycontainingdata-typesfor
various physical quantities. These shared-library data-types pro-
videthebasicunitinformationforasubsetofvariablesasastarting
pointfortheanalysis.Suchinitialunitinformationispropagated
to other variables through a set of inference rules similar to typing
rules.Specifically,thetool Phrikyimplementsalookuptable,called
a ‘mapping,’ from attributes of shared libraries to physical units
forsoftwarewrittenfortheRobotOperatingSystem(ROS).ROS
is a publisher-subscriber middleware that defines commonly used
messagesinsharedlibraries.Thesesharedmessageshaveattributes
withphysical meaningslike lengths,velocities, andaccelerations.
OurtoolPhysleveragesthisone-time‘mapping’duringanalysis
as one way to find variables with units. Also, it uses the same
notation for physical-units and unit-inconsistencies as defined by
Phriky.The notation isdescribedbelow.
Physical-units. The physical-unit representation contains a stan-
dard setofunitsfromthespecification ofInternationalSystem of
Units (SI) [ 2], plus some units officially accepted to be used with
the SI system.Following [ 10], unitsare definedas:
u:=meter|second|kiloдram|quaternion|radian|
deдree_360|amp|candela|deдree_celsius|
unknown|dimensionless|u1∗u2|u−1(1)
Unitunknown means that the unit of a variable is not known. The
unitdimensionless means a variable does not have a unit, such
as a scaling factor or the ratio ‘ meter-per-meter ’. The product
u1∗u2represents a multiplication of two units and u−1represents
the inverse of a unit. Together, product and inverse form vari-
ousderivedunitslike‘ meter * second−1’,i.e.,aunitofvelocity,
‘meter-per-second ’. Further, note that we use the same unit to
represent variables of the same dimension. So, two variables of the
lengthdimensionwithdifferentunitsinpractice,‘ centimeter ’and
‘meter’respectively,are assumedto have the same unit, ‘ meter’.
564Phys: Probabilistic PhysicalUnitAssignment... ESEC/FSE’18,November4–9, 2018, Lake Buena Vista,FL,USA
Unit-inconsistencyDetection. Theviolationofdimensionalrules,
such as one can only add or compare values of the same dimen-
sion,aretranslatedtounit-inconsistenciesoverprogramconstructs.
They are listedbelow.Let u1andu2be twodifferentunits.
(1)Addition/subtractionofinconsistentunits:aninconsistencyis
detectedwhenthereisanaddition/subtractionoftwodifferentunits.
Notethatmultiplicationanddivision ofinconsistent unitsmay be
legitimate, such as ‘ meter-per-second *second,’ and hence not a
goodstandardfor inconsistencydetection [ 23].
u1(+,−)u2
(2) Comparison of inconsistent units: an inconsistency is detected
when twodifferentunitsare comparedto eachother.
u1(<,≤,=,/nequal,≥,>)u2
(3) Assignment of inconsistent units. This category includes two
cases: a) the left-side and the right-side of an assignment have
different units; b) the right-side of an assignment has two different
units, e.g., a right-side variable may have different units in the two
branches of a conditional statement. Note that we union the units.
u1←u2,x←{u1,u2}
(4) Function with different unit arguments: an inconsistency is de-
tectedwhenafunction’s ithargumentreceivesvalueswithdifferent
unitsintwodifferentfunctioncalls.
f(u1),f(u2)
Detectionofunit-inconsistenciesservestwopurposes:1)theincon-
sistentuseofunitsmaybeintentionalasperthedeveloper.Insuch
acase,itisalwaysrecommendedtodocumentasuspicioususeof
units,especiallywhenthecodeismeanttobereused.Thismakesit
easiertomaintainthecode;2)theinconsistentuseofunitsexposes
the sourceofapotentialunintendedsystembehavior,orabug.
2.2 ProbabilisticInference with Graphical
Models
Often while solving real-world problems, we need to draw conclu-
sionsbasedonincompleteoruncertaininformation.Uncertainty
is usually modeled in the form of a probability distribution. The
process of performing inference based on such models is called
probabilistic inference . One type of probabilistic inference is the
computationofamarginalprobabilityoftheeventorproperty.For
example, in our case, we need to compute the marginal probability
that a variable xhas unitufrom the probability distribution of
all variables in the program being of unit u. The probability that
xhas unituis conditioned on how xis used in the program and
dependsonwhatisassignedto xandhowxisusedinmathematical
expressions. Factor graphs [ 14] are used to represent the structure
ofthis conditional dependence.
In factor graphs, arandom variable (or aboolean variable with
probability, ł ris 0.7 chance truež) is used to denote a predicate
(e.g., program variable xhas unitu, orP(x,u)). Inter-dependent
randomvariablesaredenotedasapropositionallogicformulawith
probabilities.Forinstance,theinformationthatavariable vellikely
hastheunitof‘ meter-per-second ’withprobability0.7isdenoted
byN(‘vel’,meter-per-second )0.7−−−→P(vel,meter-per-second ).
Intuitively,itmeansfromthenamingconvention N(thinkofitasa
dictionary that maps a name to its unit) we know that a name ‘ vel’
hasthe‘meter-per-second ’unit,wethenhave0.7confidencethat
variablevelis really of that unit, with probability 0.7 modeling
the uncertainty of naming conventions (i.e., programmers may not(a) Code snippet showing several constraints related to variable q1.
source:https://git.io/vAAAI
(b) Inference resulting in meter-per-second unitsfor q1.
Figure 1: Example unit inconsistency detected using proba-
bilisticconstraints.
respect naming conventions). Arandomvariablemay be involved
in multiple propositional logic formulas denoting its dependencies.
Forinstance,iftheprogramhasanassignmentstatement x=y,we
haveP(y,U)0.95−−−→P(x,U).Thefactorgraphenginewilltakethese
formulas,derivethecorrespondingjointprobabilitydistribution,
and perform probabilistic inference. There are various inference
algorithms,bothexactandapproximate,definedforthesegraphical
models. The approximate algorithms allow us to find solutions
where the exact inference is infeasible. After inference, the post-
distribution denotes the fusion of all the (uncertain) evidences and
henceouranalysisresults.Adetaileddescriptionofprobabilistic
graphicalmodelsrepresentationandinferencecanbefoundin[ 13].
Physusesafactorgraphmodeltorepresentthejointprobability
distributionofvariablesbeingofunit u.And,sincetherecanbea
largenumberofvariablesintheprogram,itusesanapproximate
algorithm for the unitinference.
3 MOTIVATING EXAMPLE
Figure1ashowsacode-snippetfromaROS-basedprojectfileavail-
able on GitHub, ‘ summit_xl_robot_control.cpp ’.Physreports
565ESEC/FSE’18,November4–9, 2018, Lake Buena Vista,FL,USA S.Kate,J. Ore,X. Zhang, S.Elbaum, Z. Xu
an inconsistency on line 18. The nature of the inconsistency is that
therobot’slow-levelwheelcontrollersarecommandedanincorrect
reference velocity. This inconsistency is difficult to detect statically
oratrun-timebecauseitissyntacticallyandsemanticallycorrectas
per the programming language, and the wheel turns in the correct
direction but the velocity is incorrect in proportion to the radius of
therobot’swheel(itisnotapparentforsmallerwheels).Asaresult,
undersomescenarios,therobotcanmoveundesirablyslow.Insuch
cases,controlengineersoftenblamethelow-levelcontrollerandtry
tocompensatebytuningcontrolgains,i.e.,changingparameters
to make the motors more sensitive to the (faulty) signal, leading to
potentialinstabilities.
Wearemotivatedbythesekindsofstealthy,difficult-to-detect
bugsthatrequirecombiningmultipleinformationsourceseachwith
adifferentdegreeofcertaintyÐfromlesscertainvariablenamehints
to more certaindataflowhints.
GoingbacktoourexampleinFigure 1a,todetectthe‘subtraction
ofinconsistentunits’inline18,weneedtoinferunitsof joint_state_-
.velocityandq1([frw_vel_] omitted for brevity). Inferring units for
variables like joint_state_.velocity , which instantiate shared ROS
libraries attributes with known unit types, is already done success-
fullybyPhrikyusingpredefinedmapssowereusethatapproach.
More specifically, variable joint_state_.velocity is an attribute of
classsensor_msgs::JointState , and the mapping determines that the
attribute JointState::velocity have units‘ per-second ’.
Variableq1,however,doesnotinstantiateanythingwithaknown
unit. Inferring units for such variables requires a new and more
sophisticated approach for unit inference, as used by our tool Phys.
We note that variable q1on line 16 is assigned units computed
from the units of wx1(andwy1; description for wy1omitted for
simplicity). wx1isassignedunitsonline14,providingadataflow
constraintfrom v_ref_x_becausev_ref_x_ispartofanaddition,and
we assume allunits withinanaddition are thesame. For inferring
the units of v_ref_x_ we have two hints: 1) a dataflow constraint
online6from linearSpeedXMps_ alongwithanaminghintbecause
linearSpeedXMps_ containsthesubstring‘Speed’;and2)assignment
ofunitsresultingfromtheprocedure saturation online24.Inter-
estingly,saturation uses its first parameter as the return variable
and thus provides a hint that its returned units may be the same as
itsfirstargument’sunits.Therefore,online24, v_ref_x_islikelyto
havethesameunitsasargument cmd_vel.linear.x thathasaknown
unitassociatedas part ofthe map.
Allthesehintstogetherformasetofprobabilisticconstraints,
partiallyshowninFigure 1basaninferencegraph. Physthencalcu-
lates the likelihood of possible unit assignments for q1and assigns
the most likely unit, which turns out to be ‘ meter-per-second ’
withthe highestprobability of0 .81,reportingthat:
Addition of inconsistent units on line 18.
Attempting to add [{'second': -1.0}] to
[{'second': -1.0, 'meter': 1.0}].
4 APPROACH
In this section, we first provide a high-level overview of Phys, then
give a detailed description of the probabilistic constraints gener-
ated byPhys, and finally discuss how the probabilistic inference
engine transforms probabilistic constraints into a factor graph and
conducts graph inference.Variables	with	
Associated	
Units		
Inconsistency	
Reports	Unit		
Inconsistency	
Detection	Probabilistic	
Inference	
Engine		
	
	
	
	
	
	
	
	
	
Probabilistic	
Constraint	
Collector	
	Dataflow	
Naming	
Computed	
Unit	
Known	
Symbol	
Conversion	Code	
Predefined	
Unit	Maps	
Stage	1		 Stage	2		
Phys	Apply	Units	
and	Iterate	
Figure 2:Overview ofPhys framework.
Table 1:Constraint Predicate Definitions
TYPE SYMBOL DEFINITION
Dataflow D( var,u) varhas unitubased-ondataflow
dependencyof varon ROS-TYPEDvariable.
Naming N( var,u) varhas unitubased-onits name.
Computed-Unit C( var,u) unit uofvaris computed from the right
side of assignmentstatement,‘ var = expr ’.
Known-Symbol K( var,u) varhas unitubased-onknown symbols.
Conversion F( var,u) varhas unitubased-onunit-conversion
expression.
Prior-
Probabilitypred=1 (q)predis truewith probability q.
Implication pred1p− →pred2pred1impliespred2with probability p.
Table 2:Collected constraintsforexample inFigure 1.
LN#Probabilistic Constraint Iter#
(1)24C(v_ref_x_, ms−1)0.95−−−→P(v_ref_x_, ms−1) 1
(2)25C(v_ref_y_, ms−1)0.95−−−→P(v_ref_y_, ms−1) 1
(3)6 P(v_ref_x_, ms−1)0.95←−→P(linearSpeedXMps_, ms−1) 1
(4)- N(linearSpeedXMps_, ms−1)0.7−−→P(linearSpeedXMps_, ms−1) 1
(5)14P(wx1,ms−1)0.95←−→P(v_ref_x_, ms−1) 1
(6)15P(wy1,ms−1)0.95←−→P(v_ref_y_, ms−1) 1
(7)16C(q1,ms−1)0.95−−−→P(q1,ms−1) 2
(8)-N(summit_xl_wheelbase_, m)0.7−−→P(summit_xl_wheelbase_, m)1
(9)-N(summit_xl_trackwidth_, m)0.7−−→P(summit_xl_trackwidth_, m)1
(10)12P(L,m)0.95←−→P(summit_xl_wheelbase_, m) 1
(11)13P(W,m)0.95←−→P(summit_xl_trackwidth_, m) 1
(12)26C(w_ref_,s−1)0.95−−−→P(w_ref_,s−1) 1
(13)7 P(w_ref_, s−1)0.95←−→P(angularSpeedRads_, s−1) 1
(14)- N(angularSpeedRads_, s−1)0.7−−→P(angularSpeedRads_, s−1) 1
(15)12C(x1,m)0.95−−−→P(x1,m) 2
(16)13C(y1,m)0.95−−−→P(y1,m) 2
(17)14C(wx1,ms−1)0.95−−−→P(wx1,ms−1) 3
(18)15C(wy1,ms−1)0.95−−−→P(wy1,ms−1) 3
Figure2shows an overview of the Physframework. It is divided
into two stages: Stage 1 infers units with the help of a probabilistic
inference engine, and Stage 2 uses the inferred units to detect unit
inconsistencies.
Stage1:ProbabilisticUnitInference. There are two main com-
ponentsforunitinferenceasshowninFigure 2Stage1:probabilistic
constraint collector and probabilistic inference engine. The con-
straint collector first preprocesses the code to generate a list of
functions and then scans each function to identify variables that
instantiate ROS shared library data types. Using a predefined map
566Phys: Probabilistic PhysicalUnitAssignment... ESEC/FSE’18,November4–9, 2018, Lake Buena Vista,FL,USA
fromROSattributestounits[ 24],thesevariablescanbedirectlyas-
signedaphysicalunit.Themappingisaone-timeeffortandconsists
of 98 data structures, each having 2-5 fields. For example, variables
instantiating the ROS attribute geometry_msgs::Twist.linear.x are
mappedto‘ meter-per-second .’Themappingprovidesasubsetof
variableswithknownunitsandallowsustotransferthisknown
unitinformationtovariablesofnon-sharedlibrarytypeandthen
fuseitwithotherunithints.
Next, the constraint collector traverses through the code to
gather unit hints called observations and to derive constraints that
denoterelationsbetweenvariables.Table 1definesfivetypesofob-
servations (dataflow, naming, computed-unit, known-symbol, and
conversion)denotedaspredicatesassertingavariable varhasaunit
u. These observations are associated with some prior probabilities
to express the initial confidence in those observations to be true,
whichiscapturedbytheconstrainttypedefinedinthesixthrowof
Table1.Thecollectoralsoconstructsimplicationconstraints,asper
theseventhrowofTable 1,whichcapturetheinter-dependencesof
the predicates based on program semantics, allowing probabilities
tobepropagatedandfused.Last,theconstraintcollectorrecords
composite units such as ‘ meter-per-second-squared ’,theresult
of combining units in mathematical expressions. The observed and
composite unitsare addedto the set UNIT_SET.
After all constraints have been collected, the probabilistic infer-
ence engine transforms the constraints into a factor graph. The
engine performs belief propagation in the graph for each unit in
UNIT_SET.Thisyieldsaposteriormarginalprobabilityforeach
variable,var,havingaunit, u,denotedas P(var,u).Ifthereissome
evidencefor u(i.e.,withprobability p>0.5,where0.5isnoknowl-
edge),and uismorelikelythananyotherunit,then varisassigned
the unitu. As shown in Figure 2, Stage 1 includes an iterative
process of gathering constraints, running the probabilistic infer-
enceengine,inferringunits,andagaingatheringconstraints.The
iterative part isrepeateduntil afixedpointisreached.
Stage2:Unit-inconsistencyDetection. Theunitinconsistency
detector scans the annotated abstract syntax tree (AST) for unit
inconsistencies as defined in Section 2.1. That is, inconsistent addi-
tion/subtraction,comparison,assignment,orfunctionarguments.
Tomitigatefalsepositives,thedetectorisconservativelyconfigured
bydefaulttoreportaninconsistencyonlyifthethreemostlikely
unitassignmentstothevariablesinvolvedinanexpressionallyield
an inconsistency. Physthen emits a list of variable unit assignment
andany detectedinconsistencies.
4.1 ProbabilisticConstraints
Physhastwoformsofconstraints:theprior-probabilityconstraints,
andthe implicationconstraints.
As shown in Table 1, a prior-probability constraint encodes that
aninitialobservation predistruewithsomeconfidence q,andis
denotedpred=1(q). This constraint encodes belief from prior hu-
man domain knowledge and distributions of known types inferred
solely from ROS libraries. The inherent uncertainty in this con-
straintcanbesubstantiallysuppressedwhentheinferenceengine
fusesinformation from manysources.
Implicationconstraintsareusedtorelatetwopredicates/random-
variables together, and take the form pred1p− →pred2 with confi-
dencep,andcanalsobebidirectional.Table 2showsimplicationconstraints collected from the code snippet in Figure 1a. Notice
howeveryconstraintinthetableisformulatedasanimplication
constraint, from anobservationpredicatetoa posteriorpredicate
such as (1) and (2), or from a posterior predicate to another pos-
terior predicate such as (10) and (11). Next, we discuss how to
collect the constraints from the data flow, naming, computed-unit,
known-symbolandconversionperspectives.
DataflowConstraints. Dataflowconstraintsarecollectedforvari-
ablepairsthatcanhavethesameunitduetoprogramdataflow.For
example, Figure 1ahas a dataflow constraint on line 14: wx1and
v_ref_x,andthegeneratedconstraintisshowninTable 2(5).Inthis
example,thedataflowconstraintencodesthedimensionalrulethat
the units resulting from addition/subtraction are likely the same
as the units of the operands. As shown in the table, this constraint
has a probability of 0.95. It is a standard to use 0.95 to represent
high confidence inthe inference [ 32].
Moregenerally,variousprogramexpressionssuchasaddition,
comparison, min(),max()function calls, and copy provide unit
hints about their operands according to the dimensional rules. The
operandsofsuchexpressionsorstatementspotentiallyrepresent
quantities with the same unit. If a dataflow relation for the same
unit is detected for variables aandb, we add an implication con-
straint between the two predicates: P(a,u)0.95←−→P(b,u), where
u∈UNIT_SETandconfidence ispropagatedinboth directions.
For variables with unit hints from the ROS mapping, we for-
mulate the followingconstraints:1) a prior probabilityconstraint,
D(b,K)=1(0.95)withDasserting the unit of a ROS variable; and
2)an implicationconstraint, D(b,K)0.95−−−→P(b,K).
NamingConstraints. Developerstendtousevariablenamesthat
hint atthe physical quantitiesthey represent. For example, linear-
SpeedXMps_ contains‘Speed’thatsuggestsalinearvelocity. Phys
uses a hand-coded lookup table between common strings (called
‘suffixes’)andunits.Forexample,‘length’and‘distance’aremapped
to ‘meter’. Generating the table is a one-time effort. The current
versioncontains only 41 entries.
Tofind the bestsuffixmatch, Physuses asimilaritymetric:
sim(var,u)=max
s∈{(s:u)}len(LCS(var,s,k))
MAX_LEN_SUFFIX(2)
Here,sim(var,u)computes the maximum similarity between vari-
ablevaroverallsuffixes s,where{(s:u)}isthesetofallsuffixes
withthesameunit u.Theterm len(LCS(var,s,k))representsthe
lengthofalongestcommonsubstringbetweenavariable varanda
suffixssuchthatthelengthisatleast kandthesubstringstartswith
thefirstkcharactersofasuffix s(k=3inourimplementation).The
longesthand-codedsuffix, MAX_LEN_SUFFIX=12.
The maximum similarity score sim(var,u)is then converted to
anaming constraint:
N(var,u)=1(p=0.5+0.5∗sim(var,u)) (3)
Theconfidence pisscaledsothatasimilarityof0isaconfidence
of 0.5, meaning ‘no evidence’. An implication constraint is also
generated.For linearSpeedXMps_ ,itis:
N(linearSpeedXMps_ ,ms−1)0.7−−→P(linearSpeedXMps_ ,ms−1)(4)
The predicate N( linearSpeedXMps_ ,ms−1) has an initial confidence
0.5+0.5∗sim(var,ms−1)thatispropagatedto P(linearSpeedXMps_ ,
ms−1)withprobability 0.7.
567ESEC/FSE’18,November4–9, 2018, Lake Buena Vista,FL,USA S.Kate,J. Ore,X. Zhang, S.Elbaum, Z. Xu
Table 3:Probabilisticconstraints.
Type Expression Condition Probabilistic Constraints
Dataflow aop1b, c?a : b
op1∈{+, -,+=,-=,=, <,<=, ==,!=,>,>=}a∈ROS-TYPED-VARS∧
b/nelementROS-TYPED-VARS ;
ROS-VAR(a, u)D(b, u)=1 (0.95);D(b, u)0.95−−−→P(b, u)
min(a, b)
max(a, b)a/nelementROS-TYPED-VARS∧
b∈ROS-TYPED-VARS ;
ROS-VAR(b, u)D(a, u)=1 (0.95);D(a, u)0.95−−−→P(a, u)
a =bop2cos(x), a =b op2sin(x),op2∈{*, /} a/nelementROS-TYPED-VARS∧
b/nelementROS-TYPED-VARSP(a, U)0.95←−→P(b, U)
Function definition:f(typea, ...),Function call: f(b, ...)
Naming var_name p = 0.5 +1
2* sim(var_name , U)N(var_name , U)=1 (p); N( var_name , U)0.7−−→P(var_name , U)
Computed-
unita =expr ∀v:v∈vars(expr)∧
v∈ROS-TYPED-VARS ;
cu=unit(expr)C(a, cu)=1 (1.0); C(a, cu)0.95−−−→P(a, cu)
∃v:v∈vars(expr)∧
v/nelementROS-TYPED-VARS ;
cu=unit(expr)C(a, cu)=1 (0.8); C(a, cu)0.95−−−→P(a, cu)
Known-
symbolcos(a), sin(a) K(a, radian)=1 (0.95);K(a, radian)0.95−−−→P(a, radian)
Conversion a =b *π/ 180 F(a, radian)=1 (0.9); F(a, radian)0.95−−−→P(a, radian),
F(b, degree_360) = 1 (0.9); F(b, degree_360)0.95−−−→P(b, degree_360)
a =b * 180/ π F(a, degree_360) = 1 (0.9); F(a, degree_360)0.95−−−→P(a, degree_360),
F(b, radian)=1 (0.9); F(b, radian)0.95−−−→P(b, radian)
aopnum,op∈{+, -,+=,-=,=, <,<=, ==,!=,>,>=}num: numerical value >2π;
unit(a)==radianF(a, degree_360) = 1 (0.9); F(a, degree_360)0.95−−−→P(a, degree_360)
aop π,op∈{+, -,+=,-=,=, <,<=, ==,!=,>,>=} F(a, radian)=1 (0.95);F(a, radian)0.95−−−→P(a, radian)
The confidence0.7for all naming constraints reflectsthatvari-
ablenamesareuncertainandcancausefalseunitinconsistenciesif
not augmented with other evidence. This confidence is the lowest
amongallconfidenceprobabilitiesconfiguredin Phys,asnaming
usuallyprovidestheweakesthintaboutavariable’sunit.Thevalue
0.7wasempiricallyidentified,yieldingasufficientlyhighTPrate
(>80%) while retaining enough detection power to find signifi-
cantlymore unitinconsistenciesthanothermethods.
Computed-UnitConstraints. Computed-unitconstraintsarecol-
lected for the assignment resulting from mathematical expressions,
which may compose/compute new units from the operands’ units.
To generate a computed-unit constraint for a mathematical expres-
sion,wefirstneedunitderivationrules.Forexample,foradivision
expression x/y,the unitderivationruleis:
P(x,u)
unit(x)=uunit(x)=meter,unit(y)=second
unit(x/y)=meter-per-second
Whereunit(x)yieldstheunitof xbasedonthecurrentunitassign-
ment ofx, and hence the units of xandyare ‘meter’ and ‘second’,
respectively.Thereforethecomputedunitfor x/yis‘meter-per-
second’.Otherderivationrulescan be similarlydefined.
Once we have computed the resulting units, we generate two
constraints:1)apriorprobabilityconstraint C(var,cu)=1(p),indi-
catingthatweobserve varhasacomputedunit cuwithprobability
p; and, 2)C(var,cu)0.95−−−→P(var,cu), that propagates the initial
confidenceto the unit assertionof variable var. Anexample ofacomputed-unitconstraintisshowninTable 2(7).Thisconstraint
is generated once the units for the expression sqrt(wx1∗wx1+
wy1∗wy1)iscomputedtobe ms−1,resultinginacomputed-unit
predicate C(q1,ms−1)withconfidence p.
Thevalueofprobability pdependsonwhichvariablescontribute
toacomputedunit cu.IfexprhasonlyROSvariables,then agets
unitcuwith probability 1 .0, otherwise 0.8. After empirically ex-
ploring a range of values, the value of 0.8 is set higher than the
naming hint confidence (0.7) and lower than the later discussed
unitconversionhint confidence (0.9).
Known-SymbolConstraints. Softwaredealingwithphysicalquan-
tities often uses mathematical functions from some math library.
For example, we observed a lot of usage of two such functions:
sin(a)andcos(a). Both functions accept an argument that repre-
sentsanangleexpressedin‘ radian’.Weformulatethisunithint
intotwoknown-symbolconstraints:1) K(a,radian)=1(0.95);and,
2) an implication constraint K(a,radian)0.95−−−→P(a,radian). The
0.95 probability models the uncertainty arising from a possible use
ofavariable withan incorrectunitassignment.
ConversionConstraints. Manyroboticandcyber-physicalpro-
grams reason about spatial relationships with angles, and devel-
opersuseboth‘ radian’or‘degree_360 ’.Conversionconstraints
capture commonexpressionsthatconvertbetween‘ radian’and
‘degree_360 ’andprovidehints aboutunits.
So, in the angle conversion expression a=b∗π/180, vari-
ablebshould be of unit ‘ degree_360 ’ and variable ashould be
568Phys: Probabilistic PhysicalUnitAssignment... ESEC/FSE’18,November4–9, 2018, Lake Buena Vista,FL,USA
ofunit‘radian’.Thegeneratedconversionconstraintswouldbe:
1)F(a,radian)=1(0.9),F(b,deдree_360)=1(0.9);and,2)implica-
tion constraints: F(a,radian)0.95−−−→P(a,radian),F(b,deдree_360)
0.95−−−→P(b,deдree_360). If a variable with unit ‘ radian’ from the
previous iteration is added or compared with 180, then we infer
‘degree_360 ’,asshowninTable 3.Theobservationalconfidence
of0.9 informsthe prior probability constraintsfor thesehints.
Inaddition,ifavariableisaddedorcomparedwith π,thenwe
infer‘radian’.Thishintisformulatedasaconversionconstraint
inTable3,withthe high probability of0 .95.
4.2 ProbabilisticInference Engine
Factor.Here,wediscusshowtheprobabilisticconstraintsaretrans-
latedintoprobabilisticfunctions.Thefunctionsserveasnodesin
afactorgraph.Allthepredicatespresentinconstraintsarerepre-
sented as boolean variables. An implication constraint, pred1p− →
pred2,istranslatedintoafactor F(pred1,pred2)as:
F(pred1,pred2)=p,if(pred1− →pred2)istrue
1−p,otherwise(5)
and, a bidirectional constraint, pred1p← →pred2, is divided into two
constraints: pred1p− →pred2 andpred1p← −pred2, which are then
translated.Apriorprobabilityconstraint pred1=1(q),istranslated
intoafactor F(pred1)as:
F(pred1)=q,if(pred1)istrue
1−q,otherwise(6)
Wedenoteafactorwithacorrespondingprobabilisticconstraint
formulation, e.g. F(pred1):pred1=1(q).
ThebooleanvariablesinFigure 3atogetherwiththeprobabilistic
constraintsinTable 2(1ś7)canbetranslatedintothefactorsshown
inFigure 3b.
Factor-graph. Afactorgraphisabipartitegraphwithtwokinds
of nodes: variable nodes and factor nodes. The edges join each
factorwithitsvariables,i.e.,thevariablesoverwhichaprobabilistic
function corresponding to the factor is defined. Figure 3cshows
a factor-graph for the variables and factors from Figures 3a-3b.
FactorsF12,F13andF14are omittedfor simplicity.
Belief Propagation. We use the sum-product belief propagation
algorithm[ 14]forprobabilisticinference.Itisaniterativealgorithm
that passes belief messages between adjacent nodes and updates
theprobabilityforeachnodebasedonthereceivedmessages.An
updated probability is propagated toadjacent nodesin the nextit-
eration. The algorithm terminates when the probabilities converge.
Iteration .Physiterates during Stage 1, as shown in Figure 2. This
iterationiscriticaltopickupadditionalconstraints.Forexample,
Table2ontherightsideliststheiterationnumberinwhicheach
probabilisticconstraintwascollected.Asshowninthetable,con-
straints(17)and(18)wereonlyinferredaftermostoftheotherunits
in the program had been determined. In general, it is important to
considerwhetheraniterationwillreachafixedpointandterminate.
Unlikeatraditionaldataflowanalysis,unitsdonotfitwellintoa
lattice-based approach, and therefore we cannot use the Ascending
ChainCondition [21]toguaranteeafixedpoint.Thereforeweman-
uallyboundtheiterationsto4,andobservethatmostprogramswe
have analyzedreachafixedpointwithin this bound.p1:P(v_ref_x_, ms−1)
p2:P(v_ref_y_, ms−1)
p3:P(linearSpeedXMps_, ms−1)
p4:P(wx1,ms−1)
p5:P(wy1,ms−1)p6:P(q1,ms−1)
c1:C(v_ref_x_, ms−1)
c2:C(v_ref_y_, ms−1)
c6:C(q1,ms−1)
n3:N(linearSpeedXMps_, ms−1)
(a)Booleanvariables representingthepredicates
Factors
(1)F1:c10.95−−−→p1,
F2:c1=1(1.0)
(2)F3:c20.95−−−→p2,
F4:c2=1(1.0)
(3)F5:p10.95−−−→p3,
F12:p30.95←−−−p1
(4)F6:n30.95−−−→p3,
F7:n3=1(0.7083334)
(5)F8:p40.95−−−→p1,
F13:p10.95←−−−p4
(6)F9:p50.95−−−→p2,
F14:p20.95←−−−p5
(7)F10:c60.95−−−→p6,
F11:c6=1(0.8)
(b) Factors(c) FactorGraph
Figure 3: Factors and factor-graph for the probabilistic con-
straints(1)-(7) ofour example inTable 2.
4.3 Complexity andTermination
Preprocessing builds a context-insensitive call graph, and topolog-
ically sorting this graph is O(|V|+|E|), worst case O(|E2|)when
removing cycles. Collecting probabilistic constraints involves at
mosthloops over each statement where his the height of the
statement’s AST. The probabilistic inference engine implements
an approximate solution to the sum-product message passing al-
gorithm [ 14]that isquadratic. Collecting probabilisticconstraints
and the sum-product are run within a loop bounded by a constant
(four times). After the loop, detecting inconsistencies involves a
linearscanofprogramvariablesandtheprogram’sAST.Overall,
complexityisquadraticintimeandspace.Thisapproachterminates
because we bound the loops to collect probabilistic constraints and
run sum-product.
5 EVALUATION
Ourmaingoalistoevaluatetheeffectivenessof Physinbothunitin-
ferenceaswellasunit-inconsistencydetection.Forthat,weaddress
the following researchquestions:
•RQ1.How effective is our approach in physical unit type
inference comparedto the state of the art?
•RQ2.Can our approach detect more unit-inconsistencies
comparedto the state of the art?
•RQ3.How useful are various types of constraints defined in
our approach?
We have implemented Physin Python. It relies on a few third-
party components: Cppcheck [17] is used to obtain an intermediate
569ESEC/FSE’18,November4–9, 2018, Lake Buena Vista,FL,USA S.Kate,J. Ore,X. Zhang, S.Elbaum, Z. Xu
form of a C++ program including a list of tokens, an AST for each
statementandsymboltablesforvariables,functions,andscopes;
libDAI[20] is used as the probabilistic inference engine. Moreover,
as mentioned before, Physutilizes a one-time ‘mapping’ of ROS
data structures to physical units provided by Phriky. Our code is
available for download at https://zenodo.org/record/1310129 .
TheexperimentalevaluationisconductedonsampleC++files
picked from a large number of ROS-based projects (i.e., robotic
software) publicly available on GitHub. We used 90 files for unit
inconsistencydetectioninSection 5.2,and30filesfortypeinference
in Section 5.1because of the manual annotation effort. The list
of public software is at http://www.ros.org/browse/list.php . The
executiontimeof Physrangesfrom1to28secondsforafilewith
details elided.
For the comparison of Physwith the state of the art, we use
Phriky.Therobotics programsthatwe use forexperiments donot
come with any physical unit information. In order to determine
whether a variable can have a unit and whether an inferred unit is
correct,wemanuallycollectthegroundtruthforallthereported
variablesinthesampletest-suitefiles.Fordeterminingtruepositive
(TP) cases ofthe reported inconsistencies,we manually examine
eachinconsistencybyreviewing the corresponding sourcecode.
5.1 Physical-Unit TypeInference
In the first experiment, we want to evaluate the ability of Phys
to infer physical unit types for variables. Note that, we consider
onlythosevariablesthatcanhavephysicalunits(somevariablesin
robotics software do not represent any physical quantity, e.g., for
loopindexvariable).Plus,variablesof integertypeareassumed
tobe dimensionless.Since Physreports a rankedlist ofunits fora
variable,we consideronly the top unitinthis experiment.
Experiment Setup. We compute results for three categories of
variables:1)variablesthat Phrikycouldnotassignanyunitto,2)
variables that Phrikyassigned an incorrect unit to, and 3) variables
thatPhrikyassigned a correct unit to. Note that, Phrikysometimes
assigns more than one unit to a variable due to the unit-resolution
rule of performing union on an addition expression. In that case, if
aunionedsetcontainsacorrectunit,thentheunitassignmentis
consideredascorrectfor Phriky.Also,variablesofROSdatatype,
that obtain units from the ‘mapping’, are not included in the result
computation.Theexperimentisperformedonasampletestsuite
of30 C++filesrandomly pickedfrom ROS-basedprojects.
RQ1Results: Unit Inference. Table4summarizes the results.
Column ‘Total Vars (#)’ shows the total number of variables of
nonROSdatatypesforwhich Physcouldinferunits.Further,the
table presents the count of variables in each category that Phys
could infer unitsfor in Columns ‘Var(#)’. Columns ‘Var (%)’show
thepercentageofatotalnumberofvariablesinasamplefilethat
thecorresponding‘Var(#)’accountsfor.Theaccuracyoftheunit
assignmentsisshowninColumns‘TP(%)’.TheTPrateiscomputed
as‘TP%’=TP/‘Var(#)’,whereTPrepresentsthecountoftruepositive
unit assignments (not shown in the table for brevity). Observe that,
we achieve an overall TP rate of greater than 88% in each category.
Also,itcanbeobservedthat Physisabletoinferunitsforalotof
variables that Phrikycannot. In particular, Physinfers units for 783
variables, whereas Phrikycould assignunitsto only 302variables.EffectofConstraint Probabilities. AsseeninSection 4.1,Phys
is configured with the following parameters for constraints: 0.7
for naming,0.8 forcomputed-unitand0.9 forconversion. Weper-
formed a couple of additional experiments to study the effect of
using different parameters values: 1) Naming probability: Physwas
evaluatedwithfourvalues,namely,0.6,0.7,0.8and0.9.Itwasob-
servedthatithadnegligibleimpactonunit-inferenceforthe30-files
set; 2) Combination of computed-unit and conversion probabilities:
asmentionedbefore,computed-unitprobabilityispurposelychosen
tobelowerthanconversionprobability.Therefore,weevaluated
Physwiththreecombinationsofvaluesfor(computed-unit,conver-
sion),namely,(0.8,0.9),(0.8,0.8)and(0.9,0.8),i.e.,lowerthan,equal
to and higher than. It was observed that the TP rate was decreased
for thelast twocombinationsinone ofthe categoriesof variables
(i.e.,variableswithincorrectunitsby Phriky).Thedecreasewasdue
toincorrectunitinferenceforsomeoftheanglevariables,which
were inferredto be ‘ radian’instead of ‘ degree_360 ’.
5.2 Unit-inconsistency Detection
Inthisexperiment,weevaluatetheabilityof Phystodetectunit-
inconsistencies. Note that we consider only high-confidence incon-
sistencies.Aninconsistencyisconsideredhigh-confidenceonlyif
alltheunitsintheinconsistentexpressionareknown(nounknown
unitsforvariables,andnoconstantsthatmayormaynotbearan
implicit unit). Both PhrikyandPhyscan be configured to report
only high-confidencecases.
ExperimentSetup. WecomputetheTPrateofthereportedincon-
sistencies for both PhysandPhriky. Due to the substantial manual
efforts entailedin identifying the ground truth forvariables’ units,
we selected only a subset (30 files) of a large number of ROS-based
C++ projects as our sample test-suite for the previous experiment.
However,itwouldbeinterestingtoseehow Physperformsonother
filesaswell.Therefore,wedividetheexperiment intotwoparts.In
partone,wecomputetheresultsforoursampletestsuiteof30files
usedinthepreviousexperiment.Wecallitthe 30-filesset .Inpart
two, we compute results for an expanded set of randomly selected
sample files. For the selection of the expanded set, we ran Physon
28,484ROS-basedprojects’filesavailableonGitHub.Physreported
inconsistencies in 990 files (i.e. 3.5% of files with units). We then
randomly selected 60 files for which inconsistencies were reported
byPhysto form the expandedset.
RQ2Results: 30-Files SetInconsistencies. Table5presents the
TPandFPcountsforeachofthesamplefilesinthe30-filesset.The
table does not show entries for files that are found to have zero
inconsistencies by both PhysandPhriky. Columns 2-4 show the
resultsfor Phriky,whereas Columns5-7 show the resultsfor Phys.
Itcanbeobservedthat,though PhyshaslowerTPrate(96.43%)than
that ofPhriky(100%), it has a capabilityto uncover more inconsis-
tencies. The highlighted rowsindicatethe cases ofinconsistencies
missed by Phriky, but detected by Phys. In particular, the result for
the filesummit_xl_robot_control.cpp demonstrates the detec-
tion of the addition unit-inconsistency described in the motivation
section (Section 3). Also, observe that for the file action.cpp , the
numberofTPinconsistenciesby Physislessthanthatby Phriky.
However, though less, we found that the root cause of all those
capturedinconsistencies is same, and thus, we do not actuallymiss
the caseofan incorrectusage of unitsinthis file.
570Phys: Probabilistic PhysicalUnitAssignment... ESEC/FSE’18,November4–9, 2018, Lake Buena Vista,FL,USA
Table 4:Physical unittype inferenceby Physcompared with Phriky.
30-filesset Inferred
unitsVariables with nounits by
PhrikyVariables with incorrect
units byPhrikyVariables with correct
units byPhriky
Vars (#) Vars (#) Vars (%) TP (%) Vars (#) Vars (%) TP (%) Vars (#) Vars (%) TP (%)
Perception.cpp 94 67 77.91 95.52 1 100.0 100.0 26 100.0 100.0
labbot_teleoperation_twist.cpp 3 1 50.0 100.0 0 - - 2 100.0 100.0
QuadScripts.cpp 48 22 78.57 100.0 0 0.0 0.0 26 96.30 100.0
ard_node.cpp 20 4 66.67 100.0 0 - - 16 100.0 100.0
traj_builder.cpp 105 48 81.36 87.50 6 100.0 100.0 51 100.0 100.0
motor_and_sensors_controller.cpp 10 7 100.0 57.14 0 - - 3 100.0 100.0
simulation_functions.cpp 2 1 33.33 100.0 0 - - 1 100.0 100.0
follow.cpp 9 4 50.0 75.0 2 100.0 100.0 3 100.0 100.0
motor_control_hc.cpp 16 5 83.33 80.0 0 0.0 0.0 11 100.0 100.0
placement_wrt_workspace_action_server.cpp 5 5 71.43 100.0 0 - - 0 - -
interpolater.cpp 11 2 15.38 100.0 6 100.0 100.0 3 100.0 100.0
collvoid_local_planner.cpp 55 42 75.0 88.10 2 50.0 0.0 11 100.0 100.0
vel_scheduler.cpp 31 14 93.33 71.43 1 100.0 100.0 16 100.0 100.0
simple_pose.cpp 21 13 81.25 100.0 2 100.0 100.0 6 100.0 100.0
base_driver.cpp 32 25 96.15 92.0 5 100.0 60.00 2 100.0 100.0
channel_controller.cpp 65 49 87.50 73.47 2 100.0 100.0 14 100.0 100.0
odometry.cpp 7 2 50.0 100.0 0 - - 5 100.0 100.0
viconxbee.cpp 5 4 100.0 100.0 0 - - 1 100.0 100.0
base_controller.cpp 22 19 86.36 73.68 0 - - 3 75.0 100.0
trajectory_planner_ros.cpp 49 41 51.25 90.24 2 50.0 0.0 6 100.0 100.0
summit_xl_robot_control.cpp 104 68 93.15 100.0 23 85.19 100.0 13 92.86 100.0
summit_xl_waypoints.cpp 7 7 87.50 100.0 0 - - 0 - -
summit_xl_joint_state.cpp 0 0 0.0 0.0 0 - - 0 - -
summit_xl_joystick.cpp 3 3 100.0 0.0 0 - - 0 - -
action.cpp 30 24 68.57 87.50 0 - - 6 100.0 100.0
twist_marker.cpp 2 2 50.0 100.0 0 - - 0 - -
twist_mux.cpp 2 2 40.0 100.0 0 - - 0 - -
twist_mux_diagnostics.cpp 4 4 100.0 100.0 0 - - 0 - -
navigating_jockey.cpp 8 5 71.43 100.0 1 100.0 100.0 2 100.0 100.0
turtlebot_example_node.cpp 13 10 90.91 100.0 0 - - 3 100.0 100.0
Total 783 500 76.34 89.40 53 76.81 88.68 230 98.71 100.0
Table 5:Inconsistenciesforthe30-filesset.
Sample Test-Suite1 Phriky
InconsistenciesPhys
Inconsistencies
Total
(#)TP
(#)FP
(#)Total
(#)TP
(#)FP
(#)
labbot_teleoperation_twist.cpp 2 2 0 2 2 0
QuadScripts.cpp 4 4 0 4 4 0
ard_node.cpp 6 6 0 6 6 0
traj_builder.cpp 1 1 0 1 1 0
motor_and_sensors_controller.cpp 2 2 0 4 4 0
simulation_functions.cpp 1 1 0 1 1 0
follow.cpp 2 2 0 2 2 0
motor_control_hc.cpp 7 7 0 7 7 0
placement_wrt...action_server.cpp 1 1 0 3 1 2
collvoid_local_planner.cpp 2 2 0 2 2 0
base_driver.cpp 3 3 0 3 3 0
odometry.cpp 2 2 0 2 2 0
viconxbee.cpp 3 3 0 3 3 0
trajectory_planner_ros.cpp 3 3 0 3 3 0
summit_xl_robot_control.cpp 0- -88 0
action.cpp 3 3 0 2 2 0
twist_marker.cpp 1 1 0 1 1 0
turtlebot_example_node.cpp 0- -22 0
Total 4343
[100.0%]05654
[96.43%]2
There is one file, placement_wrt_workspace_action_server.cpp ,
for which Physreported two FPs. Both are reported because of
incorrectunitassignmentofavariable max_velocity .Thenaming
convention component of Physidentifies it as unit ‘ meter-per-
second’. However, in the program, this variable has been used as a
maximum velocity value for both linear and angular velocities and
thus can have either‘ meter-per-second ’or‘per-second ’unit.Table 6:Inconsistenciesforthe expanded set.
PhrikyInconsistencies PhysInconsistencies
Total
(#)TP
(#)FP
(#)Total
(#)TP
(#)FP
(#)
Unit-inconsistencies 78 75[96.2%] 3 190 156[82.1%] 34
Files 25 24 1 60 45 16
RQ2Results:InconsistenciesfortheExpandedFileSet. Table
6shows the summarized results for the expanded sample set. The
overallTPratefor Physis82.1%.Physdetects103.3%moreincon-
sistenciescomparedto Phriky,includingeveryinconsistencythat
Phrikydetects.Physfinds 156 true positive inconsistencies in 45
files, whereas Phrikywasableto find only 75 in24 files.
Also, a number of FPs (34) are reported by Phys. They are gener-
ally caused by an incorrect unit inference of some variables, due to
theinherentuncertaintymodeledintotheprobabilisticinference
approach. Majority of these FPs are caused by variables that are
intentionallyusedtorepresenttwodifferentquantities(i.e.units)in
a program, e.g., variable run_velis used as both linear velocity and
angular velocity. Other causes for FPs include: a) variable with a
namereflectingaphysicalquantity,butusedasascalar(e.g. width);
b)controllergainvariables,whichareusedonlyinthecontroller
equationandmaycarryimplicittimequantity(i.e.,itmayhaveany
ofthe ‘second’or‘per-second ’unitsornounit).
5.3 ConstraintDistribution
RQ3Results:ConstraintUsage. Here,wepresentastudyonthe
types of constraints collected by Physin our sample test suites.
Table7presents a count of files for which a particular type of
571ESEC/FSE’18,November4–9, 2018, Lake Buena Vista,FL,USA S.Kate,J. Ore,X. Zhang, S.Elbaum, Z. Xu
Table 7:Usageofvarious constrainttypes.
Files(#)
Dataflow Naming Computed-
unitKnown-
symbolConversion
30-Files Set 27 27 28 14 10
Expanded Set 57 56 52 35 20
constraint was collected. It can be observed that dataflow, nam-
ing, and computed-unit constraints play a major role in the unit-
inference.Also,theothertwotypes,known-symbolandconversion
constraints,havebeenfoundinanumberoffilesandthusareuseful
instrengthening the unit-inference.
6 THREATS AND LIMITATIONS
6.1 Threats
Self-labeling. Onethreatisthatthiseffortusesself-labeleddata
to evaluate both physical unit type inference and inconsistency
detection.Tomitigatethisthreatwhenlabelingphysicalunittypes,
wehadmultipleauthorsreviewthetypeassignmentsandalsoused
Physto show inconsistencies when a physical unit type needed
correction.Tomitigatethisthreatwithinconsistencies,theauthors
evaluatedinconsistenciesindependently andcomparedresults.
Overfitting. By assuming English and encoding priors for suffixes
like‘speed’thatcouldmeaneitherlinearorangularvelocity(dif-
ferentabstracttypes)thereisathreatofoverfitting.Wemitigate
thisthreatbyusingasmallbutgeneralsetofsuffixes(41entries)
asdescribedinSection 4.1andobservingthatweevaluated Phys
on 60 random files drawn from 28 ,484 files with inconsistencies,
and observed only few FPs caused by incorrect suffix assumptions.
łMagic" Numbers. We use three predefined confidence values for
naming,computed-unitandconversionconstraints,respectively.
Their values are determined empirically and hence pose threats
toourresults.Ourexperimentsshowthattheresultsarenotthat
sensitive to the values.
6.2 Limitations
False Negatives. The number of false negatives in the dataset is
unknown, so we cannot calculate recall. To address this limitation,
we willexamine evaluatingthe approach after seeding faults.
Generality. Thisapproachreliesonhavingsomeinitialabstract
type information for physical units, in our case the ROS shared
messagelibraries.However,thisapproachcouldalsoleveragesome
gradualtypeinformationfromdeveloperannotations.Whileour
evaluation focuses on ROS C++ software for impact, the technique
isgeneralfor otherrobotic systems.
7 RELATED WORK
Abstract Type Inference. Guoet al.[6] proposed a dynamic,
unification-basedanalysisforabstracttypeinferenceinJavapro-
gramstoaidprogramcomprehension.Likewise,weinferabstract
types based on program interactions, but our work is static and we
inferinconsistencies. Ayudante [8]usesdataflowtoclustervariables
intoabstractdatatypes,thenleveragesaWordNet[ 18]similarity
metric to cluster by variable name; differences between the cluster-
ingsarereportedasabstracttypeinconsistencies.Like Phys,Ayu-
danteusesdataflowandvariablenames,but Physusesprobabilistic
reasoningto accountfor theuncertainty presentinusing variable
names in isolation. Also, we found poor results using WordNetinthephysicalunitstypedomainwithoutcontext,sincephysical
unitstypesarehighlydependentonacombinationoflocalclues
(like ‘speed’ meaning either linear and angular velocity). Ayudante
more aligns withatraditional unification-basedtype systems.
ProbabilisticInferenceinSoftware. Dietzetal.usedprobabilis-
ticinferencetolocalizebugs[ 5]andwealsoseektofindbugs.How-
ever,ourworkcollectsevidenceduringstaticanalysiswhiletheir
workcollectsevidencefromprogramtraces.Probabilisticinference
isusedfortypeinference[ 27],specificationextraction[ 4,16],secu-
rity [15], and reasoning about approximate computations [ 19]. We
takeaninspirationforourapproach’sdesign,inparticular,fromthe
workonprobabilistictypeinferenceforPython[ 32].Thedifference
lies in that we detect physical unit inconsistencies and model hints
specific to the problem, such as expression forms and ROS data
types. Furthermore,units are not a predefinedset andthey canbe
composedbythe code.Our techniqueishence iterative.
Physical Units in Software. Many efforts have proposed sup-
port for physical units with language extensions [ 1,11,12], unit-
annotation libraries [ 30], or dynamic techniques [ 29]. The tool
Osprey[10]detectsunitinconsistencies withstatic analysisbyus-
ingdeveloperannotationsandpropagatingunitsthroughdata-flow
and constraints, but only works on Java programs. Our work is
differentfromtheirsinthatweuseinformationavailableinvariable
names andapply probabilisticconstraints.
We target C++ code written for the Robot Operating System
(ROS) [26], a popular open-source middleware. Robot software
and ROS programs are used increasingly in both academic and
industrial robots [ 28] and contain many variables measured in
physicalunits.Webuildon PhrikyUnits ‘mapping’[ 23,24],alookup
table from shared library attributes to physical units, but assign
more unitsto variables byaddingadditionalconstraints,allowing
ourapproachtodetectmoreinconsistencies.Further,ourapproach
makes more variable assignments because it applies units after
collecting constraints from the whole program, rather than Phriky
that only makesalinearscan andcannotgobackwards.
8 CONCLUSION
We have presented a novel probabilistic approach for abstract type
inferenceofphysicalunitsandinconsistencydetectioninrobotic
systems.Theapproachleveragesuncertainhintsaboutvariables’
units such as variables’ names, expression forms, and associated
operations to make probabilistic inferences of unit types. We have
implemented this approach as a tool Phys.Physcan infer unitsfor
159%morevariablesthanstate-of-the-art,leadingtothedetectionof
morethan103%inconsistencieswithoutadditionaldevelopereffort,
and with a true positive rate of 85%. In the future, we would like to
address the causes for the reported false positives and incorporate
more unit hints such as those present in equations that form a
robot’ssensing, planning, andcontrolcomponents.
ACKNOWLEDGEMENTS
We thank our insightful reviewers. This research was supported
byONRcontractsN000141410468andN000141712947,NSFawards
1638099, 1526652, 1718040, 1748764, and 1409668. Any opinions,
findings,andconclusionsinthispaperarethoseoftheauthorsonly
anddo not necessarily reflectthe viewsof our sponsors.
572Phys: Probabilistic PhysicalUnitAssignment... ESEC/FSE’18,November4–9, 2018, Lake Buena Vista,FL,USA
REFERENCES
[1]Eric Allen, David Chase, Joe Hallett, Victor Luchangco, Jan-Willem Maessen,
Sukyoung Ryu,Guy LSteele Jr,Sam Tobin-Hochstadt, JoaoDias, CarlEastlund,
et al.2005. The Fortress language specification. Sun Microsystems 139 (2005),
140.
[2]BIPM. 2006. Le Système international d’unités / The International System of Units
(‘The SI Brochure’) (eighth ed.). Bureau international des poids et mesures. http:
//www.bipm.org/en/si/si_brochure/
[3] Percy WilliamsBridgman. 1922. DimensionalAnalysis . YaleUniversityPress.
[4]Anthony Cozzie, Frank Stratton, Hui Xue, and Samuel T. King. 2008. Digging
for Data Structures. In 8th USENIX Symposium on Operating Systems Design
and Implementation, OSDI 2008, December 8-10, 2008, San Diego, California, USA,
Proceedings ,RichardDravesandRobbertvanRenesse(Eds.).USENIXAssociation,
255ś266. http://www.usenix.org/events/osdi08/tech/full_papers/cozzie/cozzie.
pdf
[5]Laura Dietz, Valentin Dallmeier, Andreas Zeller, and Tobias Scheffer. 2009.
Localizing Bugs in Program Executions with Graphical Models. In Advances
in Neural Information Processing Systems 22: 23rd Annual Conference on Neu-
ral Information Processing Systems 2009. Proceedings of a meeting held 7-10
December 2009, Vancouver, British Columbia, Canada. , Yoshua Bengio, Dale
Schuurmans, John D. Lafferty, Christopher K. I. Williams, and Aron Cu-
lotta (Eds.). Curran Associates, Inc., 468ś476. http://papers.nips.cc/paper/
3792-localizing-bugs-in-program-executions-with-graphical-models
[6]Philip J. Guo, Jeff H. Perkins, Stephen McCamant, and Michael D. Ernst. 2006.
Dynamic Inference of Abstract Types. In Proceedings of the 2006 International
Symposium on Software Testing and Analysis (ISSTA ’06) . ACM, New York, NY,
USA,255ś265. https://doi.org/10.1145/1146238.1146268
[7]S. Hangal and M. S. Lam. 2009. Automatic dimension inference and checking for
object-oriented programs. In 2009 IEEE 31st International Conference on Software
Engineering . 155ś165. https://doi.org/10.1109/ICSE.2009.5070517
[8]Irfan Ul Haq, Juan Caballero, and Michael D. Ernst. 2015. Ayudante: identifying
undesired variable interactions. In Proceedings of the 13th International Workshop
onDynamicAnalysis,WODA@SPLASH2015,Pittsburgh,PA,USA,October26,2015 ,
HarryXuandWalterBinder(Eds.).ACM,8ś13. https://doi.org/10.1145/2823363.
2823366
[9]Paul N. Hilfinger. 1988. An Ada Package for Dimensional Analysis. ACM Trans.
Program.Lang.Syst. 10,2(April1988),189ś203. https://doi.org/10.1145/42190.
42346
[10]Lingxiao Jiang and Zhendong Su. 2006. Osprey: a practical type system for
validating dimensional unit correctness of C programs. In 28th International
ConferenceonSoftwareEngineering(ICSE2006),Shanghai,China,May20-28,2006 .
262ś271. https://doi.org/10.1145/1134323
[11]Michael Karr and David B. Loveman, III. 1978. Incorporation of Units into
Programming Languages. Commun. ACM 21, 5 (May 1978), 385ś391. https:
//doi.org/10.1145/359488.359501
[12]Andrew Kennedy. 2009. Types for Units-of-Measure: Theory and Practice. In
CentralEuropeanFunctionalProgrammingSchool-ThirdSummerSchool,CEFP
2009,Budapest,Hungary,May21-23,2009andKomárno,Slovakia,May25-30,2009,
Revised Selected Lectures . 268ś305. https://doi.org/10.1007/978-3-642-17685-2_8
[13]DaphneKollerandNirFriedman.2009. ProbabilisticGraphicalModels-Principles
andTechniques . MITPress. http://mitpress.mit.edu/catalog/item/default.asp?
ttype=2&tid=11886
[14]FrankR.Kschischang,BrendanJ.Frey,andHans-AndreaLoeliger.2001. Factor
graphs and the sum-product algorithm. IEEE Trans. Information Theory 47, 2
(2001), 498ś519. https://doi.org/10.1109/18.910572
[15]Zhiqiang Lin, Junghwan Rhee, Chao Wu, Xiangyu Zhang, and Dongyan
Xu. 2012. Discovering Semantic Data of Interest from Un-mappable Mem-
ory with Confidence. In 19th Annual Network and Distributed System Se-
curity Symposium, NDSS 2012, San Diego, California, USA, February 5-8,
2012. The Internet Society. https://www.ndss-symposium.org/ndss2012/discovering-semantic-data-interest-un-mappable-memory-confidence
[16]V. Benjamin Livshits, Aditya V. Nori, Sriram K. Rajamani, and Anindya Banerjee.
2009. Merlin:specificationinferenceforexplicitinformationflowproblems.In
Proceedings of the 2009 ACM SIGPLAN Conference on Programming Language
Design and Implementation, PLDI 2009, Dublin, Ireland, June 15-21, 2009 , Michael
Hind and Amer Diwan (Eds.). ACM, 75ś86. https://doi.org/10.1145/1542476.
1542485
[17]Daniel Marjamaeki. 2013. Cppcheck - A tool for static C/C++ code analysis.
http://cppcheck.sourceforge.net/
[18]GeorgeA.Miller.1995. WordNet:ALexicalDatabaseforEnglish. Commun.ACM
38,11(Nov. 1995),39ś41. https://doi.org/10.1145/219717.219748
[19]SasaMisailovic.2017. Probabilisticreasoningforanalysisofapproximatecom-
putations.In Proceedingsofthe2017InternationalConferenceonCompilers,Ar-
chitecturesandSynthesisforEmbeddedSystems,CASES2017,Seoul,Republicof
Korea, October 15-20, 2017 . 4:1.https://doi.org/10.1145/3125501.3125524
[20]Joris Mooij. 2010. libDAI - A free and open source C++ library for Discrete
Approximate Inference in graphical models. https://staff.fnwi.uva.nl/j.m.mooij/
libDAI/
[21]Flemming Nielson, Hanne Riis Nielson, and Chris Hankin. 1999. Principles of
programanalysis . Springer. https://doi.org/10.1007/978-3-662-03811-6
[22]John-PaulOre,SebastianG.Elbaum,andCarrickDetweiler.2017. Dimensional
inconsistenciesincodeandROSmessages:Astudyof5.9Mlinesofcode.In 2017
IEEE/RSJInternationalConferenceonIntelligentRobotsandSystems,IROS2017,
Vancouver, BC, Canada, September 24-28, 2017 . IEEE, 712ś718. https://doi.org/10.
1109/IROS.2017.8202229
[23]John-Paul Ore, Carrick Detweiler, and Sebastian Elbaum. 2017. Lightweight
Detection of Physical Unit Inconsistencies Without Program Annotations. In
Proceedingsofthe26thACMSIGSOFTInternationalSymposiumonSoftwareTesting
and Analysis (ISSTA 2017) . ACM, New York, NY, USA, 341ś351. https://doi.org/
10.1145/3092703.3092722
[24]John-Paul Ore, Carrick Detweiler, and Sebastian Elbaum. 2017. Phriky-Units:
A Lightweight, Annotation-free Physical Unit Inconsistency Detection Tool.
InProceedings of the 26th ACM SIGSOFT International Symposium on Software
Testing and Analysis (ISSTA 2017) . ACM, New York, NY, USA, 352ś355. https:
//doi.org/10.1145/3092703.3098219
[25]JudeaPearl.1986. Fusion,Propagation,andStructuringinBeliefNetworks. Artif.
Intell.29,3 (1986), 241ś288. https://doi.org/10.1016/0004-3702(86)90072-X
[26]MorganQuigley,KenConley,BrianGerkey,JoshFaust,TullyFoote,JeremyLeibs,
Rob Wheeler, and Andrew Y Ng. 2009. ROS: an open-source Robot Operating
System.In ICRA workshop onopensourcesoftware , Vol. 3.2. Kobe, Japan,5.
[27]Veselin Raychev, Martin Vechev, and Andreas Krause. 2015. Predicting Program
Propertiesfrom"BigCode".In Proceedingsofthe42NdAnnualACMSIGPLAN-
SIGACTSymposiumonPrinciplesofProgrammingLanguages (POPL’15) .ACM,
NewYork, NY, USA,111ś124. https://doi.org/10.1145/2676726.2677009
[28]ROS Industrial Consortium. 2016. Current Members - ROS Industrial. http:
//rosindustrial.org/ric/current-members
[29]G. Rosu and Feng Chen. 2003. Certifying measurement unit safety policy. In
18th IEEE International Conference on Automated Software Engineering, 2003.
Proceedings. 304ś309. https://doi.org/10.1109/ASE.2003.1240326
[30]MatthiasSchabelandStevenWatanabe.2010. BoostUnits. http://www.boost.
org/doc/libs/1_66_0/doc/html/boost_units.html
[31]Don Syme, Luke Hoban, Tao Liu, Dmitry Lomov, James Margetson, Brian McNa-
mara,JoePamer,PennyOrwick,DanielQuirk,ChrisSmith,etal .2010. TheF#
2.0languagespecification. Microsoft,August (2010).
[32]ZhaoguiXu,XiangyuZhang,LinChen,KexinPei,andBaowenXu.2016. Python
ProbabilisticTypeInferencewithNaturalLanguageSupport.In Proceedingsof
the 2016 24th ACM SIGSOFT International Symposium on Foundations of Software
Engineering (FSE2016) .ACM,NewYork, NY,USA,607ś618. https://doi.org/10.
1145/2950290.2950343
573