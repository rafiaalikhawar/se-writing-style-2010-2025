Context-Aware Patch Generation for Better
Automated Program Repair
MingWen1,JunjieChen2,3,RongxinWu1,DanHao2,3,Shing-ChiCheung1
1DepartmentofComputerScienceandEngineering
TheHongKongUniversityofScienceandTechnology,HongKong,China
{mwenaa,wurongxin,scc}@cse.ust.hk
2KeyLaboratoryofHighConfidenceSoftwareTechnologies(PekingUniversity),MoE
3InstituteofSoftware,EECS,PekingUniversity,Beijing,100871,China
{chenjunjie,haodan}@pku.edu.cn
ABSTRACT
The effectiveness of search-based automated program repair is
limitedinthenumberofcorrectpatchesthatcanbesuccessfully
generated.Therearetwocausesofsuchlimitation.First,thesearch
spacedoesnotcontainthecorrectpatch.Second,thesearchspace
ishugeandthereforethecorrectpatchcannotbegenerated(i.e.,
correctpatchesareeithergeneratedafterincorrectplausibleones
ornotgeneratedwithinthetimebudget).
Toincreasethelikelihoodofincludingthecorrectpatchesinthe
searchspace,weproposetoworkatafinegranularityintermsof
ASTnodes.This,however,willfurtherenlargethesearchspace,
increasingthechallengetofindthecorrectpatches.Weaddressthe
challengebydevisingastrategytoprioritizethecandidatepatches
basedontheirlikelihoodofbeingcorrect.Specifically,westudythe
useofASTnodes’contextinformationtoestimatethelikelihood.
Inthispaper,weproposeCapGen,acontext-awarepatchgen-
erationtechnique.ThenoveltywhichallowsCapGentoproduce
morecorrectpatchesliesinthreeaspects:(1)Thefine-granularity
designenablesittofindmorecorrectfixingingredients;(2)The
context-awareprioritizationofmutationoperatorsenablesitto
constrainthesearchspace;(3)Threecontext-awaremodelsenable
ittorankcorrectpatchesathighpositionsbeforeincorrectplausible
ones.WeevaluateCapGenonDefects4Jandcompareitwiththe
state-of-the-artprogramrepairtechniques.Ourevaluationshows
thatCapGenoutperformsandcomplementsexistingtechniques.
CapGenachievesahighprecisionof84 .00%andcanprioritizethe
correctpatchesbefore98 .78%oftheincorrectplausibleones.
CCS CONCEPTS
•Software and its engineering →Error handling and recov-
ery;Software testing and debugging ;
KEYWORDS
Context-Aware,AutomatedProgramRepair,PatchPrioritization
Permissiontomakedigitalorhardcopiesofallorpartofthisworkforpersonalor
classroomuseisgrantedwithoutfeeprovidedthatcopiesarenotmadeordistributed
forprofitorcommercialadvantageandthatcopiesbearthisnoticeandthefullcitation
onthefirstpage.CopyrightsforcomponentsofthisworkownedbyothersthanACMmustbehonored.Abstractingwithcreditispermitted.Tocopyotherwise,orrepublish,topostonserversortoredistributetolists,requirespriorspecificpermissionand/ora
fee.Requestpermissionsfrompermissions@acm.org.
ICSE ’18, May 27-June 3, 2018, Gothenburg, Sweden
©2018AssociationforComputingMachinery.
ACMISBN978-1-4503-5638-1/18/05...$15.00
https://doi.org/10.1145/3180155.3180233ACM Reference Format:
MingWen,JunjieChen,RongxinWu,DanHao,Shing-ChiCheung.2018.
Context-AwarePatchGenerationforBetterAutomatedProgramRepair.In
ICSE ’18: ICSE ’18: 40th International Conference on Software Engineering
, May 27-June 3, 2018, Gothenburg, Sweden. ACM, New York, NY, USA,
11pages.https://doi.org/10.1145/3180155.3180233
1 INTRODUCTION
Arecentstudyshowsthattheglobalcostofgeneraldebuggingis
312billiondollarsannuallyandsoftwaredevelopersspend50%of
theirtimeonfixingbugs[ 6].Theexcessivelyhighcostinfixingbugs
motivatestheresearchesonrepairingprogramsautomatically.Over
theyears,variousAutomatedProgramRepair(APR)techniques
havebeenproposed[ 16,19–21,23–25,31,33,43,45,46,53,55].
Manyofthem[ 16,19,20,29,36,45,46]areknownassearch-based
APR[17](whichmayalsobereferredtoasgenerate-and-validate
APR[24,38,42]orheuristic-basedAPR[ 55]).Theygeneratepatch
candidatesbyfirstapplyingapredefinedsetofmutationoperators
onthefaultspacedeterminedbyFaultLocalization(FL)techniques
[37,49–51].Theythendeploysomeheuristics[ 20,36]tosearch
amongthesecandidatesforacorrectpatchthatpassesallgiventest
cases[16,19,20,25,35,36,43,46].Search-basedAPRtechniques
haveshowntobeabletofixawiderangeofbugsandbescalable
tolargeprogramswithoutrequiringextraspecifications[20,27].
Despitetheireffectiveness,therearetwomajorlimitationsinex-
istingsearch-basedAPRtechniques[ 16,20,21,36].First,thecorrect
patchesarenotalwaysinthesearchspace,makingitimpossible
forthemtorepairbugssuccessfully.Thesecondlimitationarises
fromthe search space explosion problem[20,24].Toenhancethe
chancesofincludingthecorrectpatchesinthesearchspace,increas-
inglylargesearchspaces(e.g.,byusingmoremutationoperators
[16,19,23,24])arebeingdesigned. However,thespaceenlargement
greatlyincreasesthesearcheffortsandcanresultinsharpreduction
inrepaireffectiveness.Forexample,thelargesearchspaceresults
ingeneratingfewercorrectpatchesduetoproducingplausible(i.e.,
patchesthatpassalltestcases)butincorrectpatchesbeforethe
correctonesorbudgettimeout[24].
Findinggoodfixingingredientsisvitaltoresolvethefirstlim-
itation[4,30,53].Fixingingredientsarethoseexistingcodeele-
mentsreusedtogeneratefixingpatches[30].Existingapproaches
[16,19,20,29,36,46]workonStatementlevel,whicharetoo
coarse-grainedtofindthecorrectfixingingredientssinceprevious
studieshaveshownthatgoodfixingingredientsexistmoreoftenat
afinergranularitythanthatofstatements[ 4,30].Thismotivates
ustoleveragefine-granularityfixingingredients(e.g.,expressions)
12018 ACM/IEEE 40th International Conference on Software Engineering
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 10:49:35 UTC from IEEE Xplore.  Restrictions apply. ICSE ’18, May 27-June 3, 2018, Gothenburg, Sweden M. Wen, J. Chen, R. Wu, D. Hao, and S. Cheung
togeneratepatches.However,doingsowillfurtherincreasethe
searchspaceandhenceaggravatethesecondlimitation.Thisissue
wasalsoobservedbyBarr et al.[4]whofoundthatthegenetic
programmingsearchalgorithmisalwaysboggeddownwithina
fewgenerationsduetothesearchspaceexplosionwhentrying
outGenProg[ 20]withfixingingredientsattheExpressionlevel.
Therefore,betterstrategiesarerequiredtoprioritizethesearch
spacederivedfromfinefixingingredients.
Inpursuitofanefficientsearchstrategy,weanalyzethepatch
generationprocessofsearch-basedAPRandidentifythemajor
factorscontributingtothesearch-spaceexplosionproblem[ 21].
AnAPRprocesstypicallyinvolvesgeneratingthreespaces.First,
itselectsabuggylocationgeneratedbyFLtechniques(i.e.,faultspace).Second,itselectsamutationoperatorfromapredefined
setofoperations(i.e.,operationspace)thatcanbeappliedtothe
selectedbuggylocation.Third,itselectsafixingingredient(i.e.,in-
gredientspace)ifitisrequiredbythemutationoperator.Theingre-
dientspacecanbeasetofcodefragmentsextractedfromthesameapplication[
20,23,36,45]oracrossmultipleapplications[ 41].There-
fore,thefault space, operation space andingredient space jointlyat-
tributetothesearchspaceexplosionproblem[ 21].Amongthethree
spaces,thefaultspaceisasetofsuspiciouscodeelements,whicharepotentiallybuggy,derivedfromagivensetoftestresults.Itdepends
largelyontheadequacyofthesetests[ 52,56].Followingexisting
practices,wedirectlyleveragethesuspiciousvaluesreturnedbyFL
techniquestoprioritizethefaultspace[ 15,16,20,33,36,43,46,48].
Inthispaper,weapproachthesearchspaceexplosionproblem
bystudyingtheothertwospaces(i.e.,operationspaceandingre-
dientspace),whichcollectivelyreferredtoasthe fix space[21].
Specifically,westudyhowtoefficientlysearchforacorrectpatch,
ifany,inthefixspaceofaselectedsuspiciouscodeelement.Ex-
istingstrategiesofsearch-basedAPRrandomlychooseoperators
andingredientsfromthefixspace[ 16,19,20,27,36,46].However,
thisrandomstrategyisinefficientandsubjecttohighpossibilities
ofproducingplausiblepatches[24,25,53].Therefore,wepropose
toprioritizethesearchforcorrectpatchesoverplausiblebutin-
correctonesbasedonmutationoperators’andfixingingredients’
likelihoodtocorrectlyrepairtheselectedsuspiciouscodeelement.
Wefindthatthecontextinformationofthesuspiciouscodeand
theingredientscanproviderichinformationabouttheirlikelihood
tocorrectlyrepairthebug.Ourfindingissupportedbyourempiri-
calstudyshowingthatthecorrectfixingingredientsandthebuggy
codeelementssharehighsimilarityintermsoftheircontexts.Lever-
agingthefindings,wedevelopanapproachcalledCapGen,which
standsfor Context-Aware-PatchGeneration.CapGenworksona
fine-granularityattheASTnodelevel.Itiscontext-awareintwo
aspects.First,themutationoperatorsareprioritizedconcerningthe
contextinformation.Specifically,CapGenconsiderstheASTnode
typesoftherequiredingredientandthesuspiciouscodeelement
whenselectingmutationoperators.However,whetherbugscanbe
fixedmoreoftenundercertaincontextsthantheothersremains
unknown.Toaddressthischallenge,CapGenleveragessubstantial
realbugfixesinopensourceprojectstoguidethediscoveryofsuchcontexts.Second,thefixingingredientsareextractedtogetherwith
theircontextinformation.Specifically,weproposedthreemodels
tocapturethecontextinformationintermsoftheingredients’syn-
tacticsandsemantics.CapGenleveragesthesemodelstoguidetheapplicationoftheingredientstothecorrectlocations.Thisis
basedonourintuitionthatafixingingredientshouldbeapplied
tothelocationswithsimilarcontextscomparedwiththelocation
whereitisextracted.Tothebestofourknowledge,incorporating
thecontextinformationwhenselectingmutationoperatorsand
prioritizingfixingingredientsisnewtoprogramrepair.
WeevaluateCapGenontheDefects4J[ 14]benchmark.The
evaluationresultsshowthatCapGenmakestwomajoraccomplish-
ments.First,CapGengeneratesplausiblepatchesfor25bugsand
21ofthemarecorrect,thusachievingahighprecisionof84 .00%.It
outperformsthecurrentstate-of-the-artapproachesintermsofthe
numberofbugsrepairedcorrectlyandtheprecision.Morespecif-
ically,usingthecontextmodels,theranksofcorrectpatcheshas
beenimprovedfor85 .31%andthenumberoftiesoftherankings
hasbeenreducedby97 .59%onaverage.Thissignificantlyallevi-
atesthesearch-spaceexplosionproblem.Second,itgeneratesno
incorrectplausiblepatchesfor60 .00%(15/25)ofthebugs.Forthose
withincorrectplausiblepatchesgenerated,thecorrectpatchescan
berankedinpriorto98 .78%oftheincorrectones.Itisbecause
thatourcontext-awaremodelscanpreciselyidentifythecorrectfixingingredientsandthusreducethepossibilityofgeneratingincorrectplausiblepatches.Thisalsosignificantlyalleviatesthe
overfittingproblem[ 42].Amongthese21bugscorrectlyrepaired,
15ofthemhaveneverbeenrepairedbyexistingAPRapproaches,
showingthatCapGenwellcomplementsexistingapproaches.We
alsoevaluatedCapGenontheIntroClassJava[ 10]benchmark,
theresultsofwhichshowthegeneralityofCapGen.
Insummary,ourpapermakesthefollowingnovelcontributions:
•WeproposeCapGen,whichisacontext-awarepatchgenera-
tiontechnique.Tothebestofourknowledge,CapGenisthefirst
approachtoincorporatingthecontextinformationtoprioritize
mutationoperatorsandapplyfixingingredients.
•Wedesignthreenovelmodelstocapturethecontextinfor-
mationoffixingingredients.Wealsopresentempiricalevidences
supportingthatthecorrectfixingingredientsshouldsharehigh
similaritieswiththebuggyelementintermsoftheircontexts.
•WeevaluateCapGenonthebenchmarkDefects4J.There-
sultsshowthatCapGencangeneratecorrectpatcheswithahigh
precisionof84 .00%.Moreover,itoutperformsandcomplements
existingstate-of-the-artapproaches.
2 BACKGROUND AND MOTIVATION
Toaddressthetwoaforementionedlimitationsofsearch-basedAPR,
westudytherealbugfixesandmakesomeinterestingobservations
onpatchgranularities,theoperationspaceandtheingredientspace.
•Patch Granularities: Wefoundthatoneimportantreason
whichhindersexistingapproaches[ 16,20,29]togeneratethecor-
rectpatchesinthesearchspaceisthatthedesignedmutationop-
eratorsworkatthestatementlevel,whicharetoocoarse-grained.
Martinez etal.reportedthatcoderedundancyissignificantlyhigher
atafinergranularitythanstatementlevel[ 30].Thissuggeststhatit
ismorelikelytofindgoodfixingingredientsatafinergranularity.
Figure1showsanexample,whichisabugcausedbyawrong
expressioninthereturnstatementatline417.Tofixit,developers
changedtheoriginalexpressionto equals(x,y,1) .Thefixing
ingredient equals(x,y,1) existsattwootherplaces(line422and
line442)inthesameprogram.Ifweapplymutationoperatorsatthe
2
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 10:49:35 UTC from IEEE Xplore.  Restrictions apply. Context-Aware Patch Generation for Better Automated Program Repair ICSE ’18, May 27-June 3, 2018, Gothenburg, Sweden
statementlevel(e.g.,replacingthereturnstatementwithanother)
asexistingapproaches[ 16,19,20,29],wecannotfixthebugby
replacingline417withline422norline442.Anotherexampleis
showninFigure2,wherethefixingingredient next(pos)also
existsatagranularityfinerthanstatements.Thesemotivateusto
extractfixingingredientsandapplymutationoperatorsatafiner
granularity,suchastheexpressionlevel.
))ݕ(ܰܽܰݏ݅.݈ܾ݁ݑ݋ܦ&&)ݔ(ܰܽܰݏ݅.݈ܾ݁ݑ݋ܦ(࢔࢛࢚࢘ࢋ࢘ ||;ݕ==ݔ 417:
,࢟,࢞(࢙࢒ࢇ࢛ࢗࢋ࢔࢛࢚࢘ࢋ࢘ ૚) ; 417:
))ݕ(ܰܽܰݏ݅.݈ܾ݁ݑ݋ܦ&&)ݔ(ܰܽܰݏ݅.݈ܾ݁ݑ݋ܦ(࢔࢛࢚࢘ࢋ࢘ || 422: ࢙࢒ࢇ࢛ࢗࢋ,࢟,࢞૚ ;
442: ,࢟,࢞(࢙࢒ࢇ࢛ࢗࢋ૚) ࢔࢛࢚࢘ࢋ࢘ ||ݕ(ݏܾܽ.ℎݐܽܯݐݏܽܨ − ;ݏ݌݁=<)ݔ  //ݐ݊݁݉݁ݐܽݐݏݕ݃݃ݑܤ
//ݐ݊݁݉݁ݐܽݐݏ݀݁ݔ݅ܨ 
 //݃ݑܾ݁ℎݐ݃݊݅ݔ݂݅ݎ݋݂ݏݐ݊݁݅݀݁ݎ݃݊݅݁ℎܶ-
+
Figure 1: Buggy statement, fixed statement and the fixingingredients of bug Math 63 in Defects4J.
Applyingmutationoperatorswithingredientsatafinergran-
ularityincreasesthelikelihoodtoincludethecorrectpatchesinthesearchspace[
4,30].However,aseriousside-effectisthatit
willincreasethefixspace(i.e.,operationandingredientspace)sig-
nificantly,exacerbatingthesearchspaceexplosionproblem[4].A
recommendedwaytoaddressthisistoprioritizethepatchesbased
ontheirlikelihoodtorepairabugcorrectlyasadoptedbyrecent
approaches[ 19,53,55].Wemaketwokeyobservationsonthefix
spacefromexistingliteratureandthemotivatingexamples,which
shedlightsonhowtoprioritizethesearchofcorrectpatches.
ࢌ࢏ܿ&&ܱ݊݃݊݅݌ܽܿݏ݁ ܧܱܷܶܳ==ݐݎܽݐݏ { 421:
422:+࢚࢞ࢋ࢔ ;࢙࢕࢖ 
423: ࢒࢒࢛࢔?࢒࢒࢛࢔==݋ܶ݀݊݁݌݌ܽ࢔࢛࢚࢘ࢋ࢘ ∶ ݀݊݁݌݌ܽ.݋ܶ݀݊݁݌݌ܽ;ܿ //)݀݁ݐݎ݁ݏ݊݅(ݐ݊݁݉݁ݐܽݐݏ݀݁ݔ݅ܨ 
 //݃ݑܾ݁ℎݐ݃݊݅ݔ݂݅ݎ݋݂ݏݐ݊݁݅݀݁ݎ݃݊݅݁ℎܶ
170:ࢌ࢏ܴܿܶܣܶܵ==)(ݔ݁݀݊ܫݐ݁݃.ݏ݋݌ ிெ்{
171: ݁ݏݎܽ݌=ݐܽ݉ݎ݋݂ ࢚࢞ࢋ࢔,݊ݎ݁ݐݐܽ݌ ;࢙࢕࢖ //ݐ݊݁݉݁ݐܽݐݏݕ݃݃ݑܤ
Figure 2: Buggy statement, fixed statement and the fixingingredients of bug Lang 43 in Defects4J.
•Observations on the Operation Space:
Insertion,deletion
andreplacementaremutationoperatorscommonlyusedtogen-eratepatches[
16,20,27,29,46].Asrevealedbyexistingstudies
[28,58],thelikelihoodofrepairingabugiscorrelatedwiththe
concernedoperatorandthetype1oftheinvolvedcodeelements.
Forinstance, insertioncancorrectlyrepairabugmorefrequently
withacodeelementofExpressionStatement2thanothertypes
ofcodeelements[ 58].IntheexampleinFigure2,thebugisfixed
byinserting next(pos)asanExpressionStatementatline422.
Wefurtherobservethatthelikelihoodofcorrectbugrepairing
iscorrelatedwiththecontextoftheinvolvedcodeelements.Our
observationisinlinewitharecentfindingthatthesyntacticusage
ofcodeelementsishighlycontextual[ 39].Forinstance,a switch
statementusuallyoccursmuchmoreoftenundera whilestate-
mentthana forstatement[39].Supposewewanttoreplacethe
buggyexpressionatline417inFigure1withanothercompatible
expression(i.e.,expressionsevaluatedas booleanvalues).There
aremanytypesofingredients(e.g.,MethodInvocation,InfixExpression)thatcanbeevaluatedas
boolean.However,under
thecontextofaReturnStatement,MethodInvocationhasa
1TypereferstotheASTnodetypeinthisstudy,suchasInfixExpression
2https://msdn.microsoft.com/en-us/library/s7ytfs2k.aspxrelativelyhighprobabilityof24 .4%tobeselectedasaningredient
forthereturningvalueandismorethansixtimeshigherthanthat
oftypeBooleanorInfixExpression[ 39].Therefore,expressions
oftypeMethodInvocationshouldbepreferentiallyselectedas
ingredientstofixthisbuginaReturnStatement.
Thesemotivateustoprioritizethemutationoperatorsusing
thecontextinformationderivedfromtheASTnodetypeofthe
involvedfixingingredientandthatoftheenclosingcodeelement
where this ingredient is going to be applied. However, how to
selectthosecontextsthatcancoverasmanybugsaspossiblewhilekeepingatractableoperationspaceisachallenge.Inthisstudy,we
leveragesubstantialopensourceprojectstolearnthosecontexts
underwhichrealbugsarefrequentlyfixed,andusesuchknowledge
toprioritizemutationoperators(seeSection3.1).
•Observations on the Ingredient Space: Weobservethatthe
contextinformationofthefixingingredientscanguideustoselect
thecorrectingredienttothesuspiciousbuggylocation.Consider
thereturnexpressionatline417oftheexampleinFigure1.Evenwe
havedecidedtopatchtheexpressionusingmethodinvocationsas
aforementioned,westillneedtoselectoneofthemanymethodin-
vocationsintheprogramtogenerateapatch.Arandomselectionis
lesslikelytogenerateacorrectpatch.Thecorrectfixingingredientexistsattwootherplacesintheprogram.Iflookingattheircontexts
(e.g.,theenclosingstatementswheretheyareextracted),wecan
findthatbothofthemareusedin returnstatements,andthereare
nootherusagesof equals(x,y,1) inthisprogram.Therefore,this
fixingingredientshouldbepreferentiallyselectedovertheothers
topatchthebuggy returnstatementatline417.Asimilarcaseis
foundfortheexampleinFigure2.Theingredient next(pos)is
extractedfromastatementenclosedbyan ifstatement,andthus
itshouldbepreferentiallyselectedandinsertedunderthebuggy
ifstatementatline421.
Thismotivatesustoconsiderthesimilaritybetweenthecon-
textwhereaningredientisextractedandthecontextwherethe
buggycoderesideswhengeneratingpatches.Aningredientwitha
highercontextsimilarityshouldberankedhigher.Insection3.2.1,
weproposethreemodelstomeasurethecontextsimilaritiesin
termsofaningredient’sandabuggycode’sgenealogicalstruc-
tures,accessedvariablesandsemanticdependencies.Tovalidateif
suchmeasurementcanreliablyindicatethelikelihoodofgenerat-
ingcorrectpatches,weconductanempiricalstudytocollectthe
supportingevidenceinSection3.2.2.
3 APPROACH
We propose a Context-AwarePatchGeneration (CapGen) ap-
proach,whichworksontheAbstractSyntaxTree(AST)ofapro-
gram.Specifically,alltheASTnodesinthecategoryofType,Ex-
pressionandStatement[ 39]areextractedasfixingingredients.
Thissectionfirstintroducesthecontext-awareprioritizationof
operationsandthefixingingredients.Afterthat,itintroduceshow
CapGenintegratesthefaultspace,operationspaceandingredient
spacetogethertoprioritizethegeneratedpatches.
3.1 Context-Aware Operators Selection
Motivatedbyourobservations,weconsiderthethreebasicAST
mutationoperators,whichtakeafixingingredientasasourcenodeandtheplace(i.e.,thebuggycodeelement)wheretheingredientis
tobeappliedasatargetnode.
3
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 10:49:35 UTC from IEEE Xplore.  Restrictions apply. ICSE ’18, May 27-June 3, 2018, Gothenburg, Sweden M. Wen, J. Chen, R. Wu, D. Hao, and S. Cheung
1 If Statement 
2
Infix Expression 
ܱ݊݃݊݅݌ܽܿݏ݁ && 
ܿ[ݐݎܽݐݏ ]==ܧܱܷܶܳ3 Block
4Return
Statement Expression 
Statement
)࢙࢕࢖(࢚࢞ࢋ࢔; 51 If Statement 
2
Infix Expression 
ܱ݊݃݊݅݌ܽܿݏ݁ && 
ܿ[ݐݎܽݐݏ ]==ܧܱܷܶܳ3 Block
4Return
Statement 
Figure 3: The AST differences of the example in Figure 2
•Replacement:replace Target Node (N t)withSource Node (N s)
•Insertion:insert Source Node (N s) under Target Node (N t)
•Deletion:delete Source Node (N s) under Target Node (N t)
Theoperationspaceinducedbytheseoperatorsislarge[ 28].
ReductionofthespaceisacriticalissueinAPR[ 21,24],andwe
proposetoleveragecontextinformationtoachievethis.Basedon
ourobservationsinSection2,weexplicitlyaugmentamutation
operatorwiththecontextinformationofthesourcenode’stypeand
thetargetnode’stype.Examplesofaugmentedoperatorsare“insertSimpleNameunderMethodInvocation"and“deleteExpression
StatementunderMethodDeclaration".Moreexamplesofaug-
mentedmutationoperatorscanbefoundinTable1.Toreducethe
operationspace,weidentifytheprobabilitytocorrectlyfixbugsforeachaugmentedoperatorandconsideronlythoseoperators
thatofferarelativelyhighprobability.Wederivetheprobabilities
fromthedatasetofpatchessystematicallycollectedbyLeGoues et
al.[19].Thedatasetcontainsover3 ,000realfixingpatchesfrom
over700opensourceprojectsandispublicavailable[ 1].Forease
ofpresentation,werefertothedatasetasBugFixSetinthispaper.
ForeachpatchinBugFixSet,wecomparethedifferencesbetween
thebuggyandthefixedversionattheASTnodelevel.Forexample,
Figure3givestheASTdifferencesforthebugfix(line421to423)
ofourmotivatingexampleinFigure2.AnodewithtypeExpres-
sionStatement(i.e.,node5)isinsertedunderthetargetnodeof IfStatement(i.e.,node1).ThenodewithtypeBlockisnot
consideredsinceitprovideslittlecontextinformationformutation
operation.Notethatnode5isasubtreecomposedofothernodes
suchasMethodInvocation(i.e., next)andSimpleName(i.e.,
pos).Weregardtheoperationperformedonthissubtreeasone
repairaction[ 58]sincethetransformationcanbecompletedin
onesingleoperation(insertingthewholesubtree).Therefore,the
augmentedmutationoperatorextractedfromthispatchis“insert
anExpressionStatementunderanIfStatement".
BugFixSetprovidesalargeandrepresentativerepositoryofreal
patches[19],andthisenablesustoobtaintheknowledgeofthose
augmentedmutationoperatorsthatarefrequentlyusedinrealbug
fixes.Wecountthefrequencyofeachaugmentedmutationopera-
torsparticipatinginthepatchesofBugFixSettoapproximateits
probabilitytofixbugs.Thehigherthefrequency,thehigherthe
probabilityoffixingrealbugs.Table1showsthetop10augmented
mutationoperatorswiththehighestfrequenciesforreplacement,
insertionanddeletion,respectively.Weselectonlythese30aug-mentedoperatorsforCapGentoprioritizetheoperationspace.
Theycover69 .69%oftherepairactionsparticipatinginthepatches
ofBugFixSetaltogether.Weuse MandFreq(M)todenotease-
lectedaugmentedmutationoperatoranditsfrequency,respectively.Forreplacement,weutilizethedatatype(e.g.,
int, boolean )ofa
node,ratherthanitsnodetype,toinfercontextinformation.Itis
becausethatifthedatatypeofafixingingredientdoesnotmatch
thatofthetargetnode,themutatedprogramwillnotbecompiledcorrectly.Forexample,boththedatatypesofthefixingingredi-ent(i.e.,
equals(x,y,1) )andthetargetnode(i.e.,thereturning
expression)inFigure1are boolean.
3.2 Context-Aware Ingredients Prioritization
Existingstudieshavereportedthatasignificantportionofthefixing
ingredientscanbefoundinthesamefileofthebuggycode[ 4,30].
Therefore,weextracttheingredientsfromthefilewherethetarget
node(i.e.,thebuggycodeelement)resides.Unlikeexistingstudies
[16,19,20,29,36,46],wealsoextractthecontextinformationfor
eachingredient.Ourhypothesisisthatthecorrectfixingingredientsshouldsharehighsimilaritywiththetargetnodesintermsoftheircontexts.Wedenotethesimilarityas
Simi(Ns,Nt).Inthefollowing,
wefirstintroducethreeaspectsofcontextinformationembedded
inanASTnodeanditssurroundingcodes,andthenexplainhowto
measurethecontextsimilaritybetweentwonodesforeachaspect.
Afterthat,wevalidateourhypothesisviaanempiricalstudyonthe
BugFixSet.Finally,weintroducehowtoprioritizetheingredients
forthethreetypesofaugmentedmutationoperators.
3.2.1 Extracting Context Information.
We model the context information of an AST node from three
differentaspects:genealogy,variableanddependency.
First,anode’sgenealogicalstructurecanprovideusefulcon-
text.Forinstance,theinfixexpression equals(x,y,1) inFigure
1isfrequentlyusedasthereturningvaluein returnstatements.
Therefore,thisinfixexpressionshouldhavehigherprobabilitytobe
usedastheingredientformutatingthereturningvaluesinReturnStatementthantheconditionsofIfStatement.Thisinformation
ofwhereaningredientisfrequentlyusedcanbeextractedfromits
genealogicalstructures,e.g.,the Ancestor Nodes ofthenode.
Second,variableusagesinaningredientcanprovideusefulcon-
textinformationsincevariablesareprimarycomponentsofan
ingredient[55].TheexampleinFigure1showsthatthefixingin-
gredientusesthesamevariables(e.g., x, y)asthetargetexpression
tobereplaced.Moreover,plausiblepatchescanbegeneratedby
simplyremovingfunctionalitiesviareplacingcomplexexpressions
withconstantvalues(i.e.,novariableusages).Patchesthusgener-
atedmightpassaproject’stestsuiteduetotheweaktestproblem
[42].Thesemotivateustorankthoseingredientswithmoresimilar
variableusagescomparedwiththetargetnodeathigherpositions.
Third,thevariablesusedordefinedinagivennodeareaffected
byorcanaffectothernodes.Suchsemanticcontextsintermsof
thenodes’dependenciesarereportedtobehelpfulincapturingthe
characteristicsofcorrectpatches[ 5,25].Therefore,CapGenex-
tractsthisdependencyinformationasanaspectofanode’scontext
toprioritizefixingingredients.
•Modeling Genealogy Contexts:
CapGenextractsthegenealogycontextsofanASTnode Nvia
checkingits Ancestor Nodes toseeNisusedunderwhattypes
ofcodeelements,andcheckingits SiblingNodes toseeNisused
togetherwithwhattypesofcodeelements.Forancestornodes,
wetraversefrom Ntoitsancestorsuntilwereachamethoddec-
laration. For Sibling Nodes, we extract those nodes of category
StatementandExpressionwithinthesameBlockof N.Westore
thegenealogicalinformationin ϕ,whichcountsthenumberof
occurrencesofdifferentnodetypesamongalltheancestorand
siblingnodes.Algorithm1showsthedetailsofthisprocess.
4
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 10:49:35 UTC from IEEE Xplore.  Restrictions apply. Context-Aware Patch Generation for Better Automated Program Repair ICSE ’18, May 27-June 3, 2018, Gothenburg, Sweden
Table 1: Top replacement, insertion and deletion operators augmented with target and source nodes’ types
Replacement Insertion Deletion
TargetNode Freq SourceNode TargetNode Freq SourceNode TargetNode Freq
Simple_Name 0.1721 Expression_Statement Method_declaration 0.0815 Simple_Name Method_Invocation 0.0191
String_Literal 0.1310 Simple_Name Method_Invocation 0.0313 Expression_Statement Method_Declaration 0.0157
Infix_Expression 0.0201 Expression_Statement If_Statement 0.0304 Infix_Expression If_Statement 0.0144
Qualified_Name 0.0197 Method_Invocation Method_Invocation 0.0282 Method_Invocation Method_Invocation 0.0144
Conditional_Expression 0.0135 If_Statement If_Statement 0.0141 Expression_Statement If_Statement 0.0072
Simple_Type 0.0082 Infix_Expression Method_Invocation 0.0125 Infix_Expression Method_Invocation 0.0066
Boolean_Literal 0.0075 Qualified_Name Method_Invocation 0.0075 Prefix_Expression Infix_Expression 0.0041
Parameterized_Type 0.0038 Expression_Statement Try_Statement 0.0075 Boolean_Literal Method_Invocation 0.0038
Primitive_Type 0.0009 If_Statement Method_Declaration 0.0063 Expression_Statement Catch_Clause 0.0031
Assignment 0.0003 Boolean_Literal Method_Invocation 0.0047 Method_Invocation Infix_Expression 0.0028
0.3771 0.2240 0.0912
Algorithm 1: ModelingGenealogyContext
input :N:Agivennode
output:Mapϕ:NodeType /mapsto→Integer:theextractedcontextinformation
1/* encoding ancestor nodes */
2parent←N
3 while parent /nequalnull &parent /nequalMethodDeclaration do
4i f parent /nequalBlockthen
5 ϕ(GetNodeType (parent))+=1
6 end
7parent←GetParentNode( parent)
8 end
9/* encoding sibling nodes */
10parent←GetParentNode( N);
11 while parent /nequalBlockdo
12parent←GetParentNode( parent)
13 end
14children←parent.FilterChildrenOfType (Statement |Expression)
15 foreach node∈childrendo
16ϕ(GetNodeType (parent))+=1
17 end
Whenapplyingasourcenode Nswithcontext ϕSunderatarget
nodewithcontext ϕT,wecomputeitsfeasibilityviacomparingthe
similarities f(ϕS,ϕT)betweenthesetwocontexts:
f(ϕS,ϕT)=/summationtext.1
t∈Kmin(ϕT(t),ϕS(t))/summationtext.1
t∈KϕT(t)(1)
whereKdenotesasetofalldistinctASTnodetypescapturedby
ϕT.Here,Equation1measurestheproportionofthecontextsin
ϕTthatcanbecoveredbythecontextsofthesourcenode Ns.
•Modeling Variable Contexts:
GivenanASTnode N,CapGenextractsasetofvariables(in-
cludinglocalvariablesandfields)thatareaccessed(i.e.,read/write)
inthisnode,whichisdenotedas θ.Eachoftheelementsinset θis
denotedas ϵ,whichisatuple /angbracketleftType,Name /angbracketrightrecordingthedatatype
andthenameofthevariable.WeusetheJaccarddistancetomea-
surethesimilaritybetweenthevariablecontextsoftwonodes θT
andθS.Besides,toavoidplausiblepatchesgeneratedbyinvolving
trivialingredients,wegivemoreweightstothosecomplexingredi-
ents.Therefore,weusethenumberofvariablesinvolvedin Nsto
representtheweightoftheingredient.
д(θS,θT)=|θS|∗|θS/intersectiontext.1θT|
|θS/uniontext.1θT|. (2)
Twoelementsarethesameonlyifboththetypeandthename
arematched.However,fornodeslikeSimpleName(i.e.,variables),
whenwereplaceitwithanother,theirnamesmustbedifferent.
Therefore,weonlyrequirethedatatypeisthesameforsuchcases.
•Modeling Dependency Contexts:
GivenanASTnode N,CapGenextractsitsdependencycon-
textsviainvestigatingthosenodesaffecting Nandthosenodes
affectedby N.Specifically,weconductintra-procedurebackward
slicingandforwardslicingbasedonthe definition and use(also
knownas def-use)ofvariablesextractedfromagivennode[47].
Lines2to11inAlgorithm2describethedetailsofextractingthe
contextinformationbyleveragingbackwardslicing.Foreachofthe
variablesusedinthenode,CapGenslicesasetofstatementswhichaffectthevaluesofthevariable.WethenextracttheASTnodesin
thesestatementthatareinstancesof ExpressionorStatement
andstoresuchinformationinamap ψtocountthenumberofoc-
currencesofeachnodetypeintheslicedstatements.Suchcontext
informationisalsoextractedbyleveragingforwardslicing.
Algorithm 2: ModelingDependencyContext
input :N:Agivennode
output:Mapψ:NodeType /mapsto→Integer:theextractedcontextinformation
1/* context information extracted from backward slicing */
2variableSet ←GetUseVariable( N)
3 foreach variable∈variableSet do
4contextStatements ←BackwardSlicing( variable)
5 foreach stmt∈contextStatements do
6 chs←stmt.FilterChildrenOfType (Statement |Expression)
7 foreach node∈chsdo
8 ψ(GetNodeType (node))+=1
9 end
10 end
11 end
12/* context information extracted from forward slicing */
13variableSet ←GetDeforSetVariable( N);
14/* forward slicing is conducted the same on variableSet */
Thefeasibilityofapplyingasourcenode Nswithdependency
contextψSunderatargetnodewithcontext ψTissimilartohowwe
measurethefeasibilityintermsofthegenealogycontexts.Specifi-
cally,wemeasuretheproportionofthetargetnode’contextsthat
canbecoveredbythecontextsofthesourcenode.
f(ψS,ψT)=/summationtext.1
t∈Kmin(ψT(t),ψS(t))/summationtext.1
t∈KψT(t)(3)
whereKdenotesasetofallASTnodetypescapturedby ψT.
3.2.2 Empirical Evidences.
Wedesignedthreedifferentmodelstocapturethecontextsimi-
laritiesbetweenthefixingingredients Nsandthetargetnode Nt.
Ourintuitionisthattherequiredfixingingredientsaresupposed
tosharehighsimilaritieswiththetargetnodetobemutatedin
termsoftheircontexts.Tovalidatetheintuition,wecollectedem-
piricalevidencesfromtheBugFixSetdataset.Among12 .65%of
thebugfixesinBugFixSet,fixingingredientsexistintheirasso-
ciatedbuggyprogram.Thisproportionisconsistentwithexisting
empiricalstudies[ 4,30].Foreachofthesebugfixes,wefirstex-
tractthecorrectfixingingredientas Nstogetherwithitscontext
informationfromtheassociatedbuggyprogram.Wethencompare
itwiththetargetnode Ntatthebuggylocationforeachofthe
threeaforementionedcontextmodelsanddenotethesimilarityas
Ss.Forcomparison,wealso randomlyselectanotheringredient Nr
whosetypeisthesameas Nsandcanalsobeappliedtothetarget
location.Forexample,if Nsisanodeof InfixExpressionwith
type boolean,wealsorandomlyselectanotherinfixexpression
withtype booleanwhosevariablescanberesolvedatthetarget
location.Thisprocessissimilartotheprocessofselectingingredi-
entsrandomlybyexistingapproaches[ 16,20,36,38].Wedenote
thecontextsimilaritybetween NrandNtasSr.Foreachbug,we
5
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 10:49:35 UTC from IEEE Xplore.  Restrictions apply. ICSE ’18, May 27-June 3, 2018, Gothenburg, Sweden M. Wen, J. Chen, R. Wu, D. Hao, and S. Cheung
p−value 
 = 2.67e−30
0.3978
0.1187
0.000.250.500.751.00
Correct Random6LPLODULW\
(a) Genealogyp−value 
 = 8.44e−10
0.4556
0.1531
0.000.250.500.751.00
Correct Random6LPLODULW\
(b) Variablep−value 
 = 8.31e−21
0.5211
0.1822
0.000.250.500.751.00
Correct Random6LPLODULW\
(c) Dependency
Figure 4: Comparisons of the contexts similarities between
the correct fixing ingredients and the fixing ingredients
withthesametypeasthecorrectonebutrandomlyselected
repeattherandomprocess50times,and Sristheaveragedcontext
similarityvalueoverthe50runs.Wethencompare SsandSrto
seeifSsisgreaterthan Srsignificantly.
Figure4showstheresultsintermsofthegenealogy,variable
anddependencycontextmodels.Here,forthevariablecontext
model,weonlykeeptheJaccardterm,whichmeasuressimilarity.
Thesimilaritiesofallmodelsarenormalizedtoarangefrom0to
1.Theresultsshowthatforallthethreemodels,thesimilarity
between NtandNsissignificantlyhigherthanthatbetween Nt
andNr(p<0.001)usingtheone-sidedMann-WhitneyU-Test[ 26].
Theseresultsempiricallysupportourintuitionthatcorrectfixing
ingredientsshouldsharehighsimilaritieswiththetargetnodein
termsoftheircontextinformation.
Actually,existingstudieshavealsoinvestigatedwheretofind
fixingingredients[ 4,12,30].However,theirinvestigationsfocus
onfindingingredientsatthefilelevel(i.e.,inthesamefileorin
differentfiles)[ 30]oratthecommitlevel(i.e.,inthecurrentversion
orinthepreviousversions)[ 4].Forexample,Barr etal.[4]found
thatasignificantportionoffixingingredientsexistinthesamefile.
Ourempiricalstudytakesafurtherstepandsearchesthefixingingredientsatafinergranularitywithinthesamefile(i.e.,those
codeelementswithhighercontextsimilarities).Inparticular,our
findingsarealsousefulforfuturesearch-basedaswellassemantics-basedAPR,bothofwhichneedtosearchfixingingredientsintheir
patchgenerationprocess.
3.2.3 Ingredients Prioritization.
Weintegratethethreemodelstoprioritizetheextractedingredi-
ents.Thoseingredientswithhighercontextsimilarities(i.e.,withalargervalueof
Simi(Ns,Nt))arerankedhigher.However,wehave
differenttreatmentstothethreedifferentmutationoperators.For
replacement,wecombineallthethreecontextmodels,andthusthe
Simi(Ns,Nt)isspecificallydefinedas:
SimiR(Ns,Nt)=f(ϕS,ϕT)∗f(ψS,ψT)∗д(θS,θT)(4)
However,for insertion,the Ntistheparentnodeof Nsafterinsert-
ingNsunderNt,andthusitmakesnosensetoincludethevariable
modelinthiscasesince NtandNsservedifferentfunctionalities.
Thesamecasefor deletion.Therefore,for insertion:
SimiI(Ns,Nt)=f(ϕS,ϕT)∗f(ψS,ψT)(5)
Fordeletion,thecaseismorecomplicatedsincewearegoing
todelete NsfromNt.Inthiscase,wefirstlocatethenodesin
theotherplaces Nowhichareidenticalto Ns.Wecomputethe
contextsimilaritybetween NoandNt.Ifthereisahighcontext
similaritybetween NoandNt,whichmeansthesourcenode Nsis
usedinsimilarcontextsattheotherplaces.Inthiscase,wegivelowerprobabilitytodelete NsunderNt.Therefore,for deletion,
Simi(Ns,Nt)isdefinedasfollowingsspecially:
SimiD(Ns,Nt)=(1−f(ϕO,ϕT))∗(1−f(ψO,ψT))(6)
whereNo≡Ns.Ifthereisnoothernodeswhichareidenticalto
Nt,thenSimi(Ns,Nt)wouldsimplybe1.
3.3 Patch Prioritization
Insummary,togeneratecandidatepatches,CapGenfirstselectsabuggynode
Nt,prioritizedbyitssuspiciousvalue FL(Nt)gen-
eratedbyFLtechniques.NotethatexistingFLtechniquesassign
suspiciousvaluesatthelinelevel,CapGenappliestheseFLtech-
niquesbyassigningaline’ssuspiciousvaluetoeachofitsASTnodesinthesameline.ThesuspiciousvalueofthoseASTnodes
(e.g.,IfStatement)thatspanacrossmultiplelinesareaveraged
overtheselines.Then,fortheselected Nt,CapGenselectsasetof
mutationoperatorsthatcanbeappliedto Nt,andeachmutation
operators Mhasthecorrespondingoperationprobability Freq(M)
by considering the contexts of Nt. Afterwards, CapGen priori-
tizesallcompatiblesourcenodes Ns,whichareusedasingredients
requiredby M,basedontheircontextsimilarity Simi(Ns,Nt)com-
paredwiththetargetnode Nt.Finally,patchesaregenerated,and
eachofthemisdenotedas P=/angbracketleftNt,M,Ns/angbracketright.CapGenprioritizes
thosepatchesbyintegratingthefaultspace,theoperationspace
andtheingredientspacetogether.Thefinalscoreof Pisdenotedas
Score(/angbracketleftNt,M,Ns/angbracketright),whichiscalculatedasshowninEquation7.
Score(/angbracketleftNt,M,Ns/angbracketright)=FL(Nt)∗Freq(M)∗Simi(Ns,Nt)(7)
Currently,weusemultiplicationtocombineallthemodelstofilter
outthosepatchesgeneratedwithingredientssharingnocontext
similarities.Designingdifferentwaystocombinethosecomponents
togetherisleftforfutureworkasdiscussedinSection5.1.
4 EVALUATION
4.1 Research Questions
WeimplementedCapGeninJavabasedonacodetransformation
librarySpoon[ 34]andthefaultlocalizationtoolGZoltar[ 2].Specif-
ically,CapGenleveragesGZoltarwiththealgorithmOchiai[ 37]to
retrievethefaultspaceandthesuspiciousvalues.Weusethepro-
gramanalysistoolUnderstand[ 3]forcodeslicing.Ourexperiments
arerunonaCentOSserverwith2xIntelXeonE5-2450CoreCPU
@2.1GHzand192GBphysicalmemory.Wesetthetimebudgetfor
eachbugas90minutesfollowingexistingpractices[ 16,19].Our
evaluationaimstoanswerthefollowingresearchquestions:
•RQ1:HoweffectivelydoesCapGenfixrealworldbugs?
•RQ2:CanCapGenoutperformexistingapproaches?
•RQ3:HowisthecontributionofeachmodelusedbyCapGen?
TheimplementationofCapGenandthedetailsofourevaluation
resultsarepubliclyavailableat:
https://github.com/justinwm/CapGen.
4.2 The Subject Programs
ToanswerthethreeRQs,werunCapGenonthebenchmarkdatasets
forprogramrepair:Defects4j[ 14].Thebenchmarkwasbuiltto
facilitatecontrolledexperimentsinsoftwaredebuggingandtesting
researches[14],whichhasbeenwidelyadoptedbyrecentstudies
onAPR[19,27,29,40,54].Followingexistingpractices[ 27,40,53],
weuseDefects4Jof version1.0.1andexcludetheClosureCompiler
6
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 10:49:35 UTC from IEEE Xplore.  Restrictions apply. Context-Aware Patch Generation for Better Automated Program Repair ICSE ’18, May 27-June 3, 2018, Gothenburg, Sweden
Table 2: Subjects for evaluation
Subject #Bugs KLOC TestKLOC #TestCases
CommonsLang 65 22 6 2,245
JFreeChart 26 96 50 2,205
CommonsMath 106 85 19 3,602
Joda-Time 27 28 53 4,130
Total 224 231 128 12,182
projectbecauseitusesacustomizedtestingformatinsteadofJUnit
test[53].Asaresult,fourprojectswithatotalof224realbugs
areusedassubjectsforexperiment.Theirdemographyisgiven
inTable2.EvaluationsonanotherbenchmarkIntroClassJava
[10,22]arealsoconducted(seediscussioninSection5.2).
4.3 RQ1:Performanceof CapGenonRealBugs
ToanswerRQ1,weapplyCapGentotheDefects4jbenchmark.
Foreachbug,wevalidatethegeneratedpatchesprioritizedbytheir
Score(/angbracketleftNt,M,Ns/angbracketright)onebyone.Wefirstrunthefailingtestcases
toseeiftheypassonthegeneratedpatch.Ifso,wethenrunthe
regressiontestcasestoseewhetherthispatchintroducesnewbugs.
Weskiptovalidatethenextpatchotherwise.CapGenkeepsgener-
atingandvalidatingthecandidatepatcheswithinthetimebudget.
Afterallthepatcheshavebeenvalidatedorthebudgettimeout,
wecollectthe plausiblepatcheswhichpassboththefailingtest
casesandtheregressiontestcases.Wethenmanuallyanalyzethese
patchestoseeiftheyaresemanticallyequivalenttothepatches
submittedbydevelopers.Wemarkthemas correctpatchesifthey
are,andincorrect plausible patchesotherwise.
CapGengeneratesplausiblepatchesfor25bugsintotalamong
allthe224bugs.Weidentifythecorrectpatchesfor22ofthese25bugssuccessfully.Table3showsthedetailsofthese22bugs.ColumnTotshows the number of the patches generated while
Crtshowsthenumberofthecorrectonesamongthem.Thetotal
numberofpatchesgeneratedisaffectedbythesizeofthefaultspaceandthesizeofbuggysourcefile(sincemorefixingingredientswill
beextractedifthebuggysourcefileislargerandcontainsmore
statements).TherearecasesthatCapGengeneratesmorethanone
correctpatch.Forexample,CapGengenerates2correctpatchesforMath53,whichrequiresinsertingastatementtofixthebug.
Wefindthatboththetwopatchesareequivalenttothedevelopers’
patchsincetherequiredstatementcanbeinsertedattwoadjacent
places.Columns RankandTieinTable3showtherankofthefirst
correctpatchandthenumberofpatches,includingwrongpatches
(i.e.,thosedidnotpassthetestsuite)andplausiblepatches,thatare
rankedintiewiththefirstcorrectpatchrespectively.Thevalueof
Rankistherankofthefirstpositionifthereareties.Column Time
showsthatthetimerequiredforCapGentogeneratethecorrect
patchesrangesfrom0.18to50.32minutes.Columns P-B,P-Tand
P-Ashowthenumberofincorrectplausiblepatchesgroupedby
theirrelativeranks(i.e.,before,intiewithandafter)comparedwith
thecorrectpatches.WecanseethatCapGengeneratesincorrect
plausiblepatchesfor40 .00%(10/25)ofthebugs.However,even
thoughCapGenmightgenerateincorrectplausiblepatches,itranks
themmostlyafterthecorrectones.Table3showsthat21outof
the22bugs,CapGenranksnoincorrectplausiblepatchesbefore
orintiewiththefirstcorrectpatches.TheonlyexceptionisMath
80,forwhichCapGengeneratestwoincorrectplausiblepatches
thatarerankedbeforethefirstcorrectpatch.Table 3: Performance of CapGen on Defects4J
ProjectBugIdCrtTotRankTieP-BP-TP-ATime
Chart 1 1 503 99 000 0 5.89
Chart 8 1 731 54004 7 0.37
Chart 11 1 105 27 000 0 7.48
Chart 24 1 179 14 000 0 0.99
Lang 6 2 771 216 000 0 10.93
Lang 26 1 5,094 371 000 0 50.32
Lang 43 3 438 9100 1 5.96
Lang 57 3 18,370 30 000 0 5.78
Lang 59 1 986 59 0001 9 1.74
Math 5 1 1,166 150 000 3 5.33
Math 30 1 669 172 000 0 6.18
Math 33 1 9,412 43 1000 0 21.51
Math 53 2 553 129 100 0 11.06
Math 57 1 421 78 000 0 19.07
Math 58 1 1,104 456 000 0 27.74
Math 59 1 225 9000 0 4.61
Math 63 1 463 4300 8 2.17
Math 65 1 31,152 3200 0 0.18
Math 70 1 262 23 000 0 3.02
Math 75 1 464 7200 0 0.85
Math 80 1 69,252 221 35208 1 22.86
Math 85 1 566 3000 3 3.42
Crtdenotesthenumberofcorrectpatches. Totdenotesthetotalnumberof
patchesgenerated. Rankistherankofthefirstcorrectpatch. P-B, P-TandP-A
denotesthenumberoftheplausiblepatchesthatareranked before,in tie with
andafterthefirstcorrectpatchrespectively. Timestandsforthetimerequiredto
findthefirstcorrectpatchin minutes.
Forthe21correctlyrepairedbugs,90 .48%ofthemrequireafixing
granularityfinerthanthestatementlevel.ExamplesaregiveninFigures1and5.Someofthecasesrequiringfixingingredients
withfinergranularitiescanbehandledbyspecificallydesigned
mutationoperators.Forexample,forbugChart1,byreplacingthe
infixexpression dataset!=null withanother dataset==null ,
CapGencanrepairit.HDRepairalsorepaireditbyincludinga
mutationoperatorthatnegatesbooleanexpressions[ 19].Currently,
CapGenincludes30augmentedmutationoperators,andsevenof
themcanrepairatleastonebugcorrectly.
TheseresultsshowtheeffectivenessofCapGen.Specifically,it
repairs21bugssuccessfully(i.e.,thefirstpatchpassingalltests
iscorrect)andachievesahighprecisionof84 .00%(21/25),which
outperformstheexistingstate-of-the-artapproachACS[ 53]witha
precisionof78 .30%.PrecisionisvitalforAPRtechniquesbecause
muchdebuggingeffortwouldbewastediftheprovidedpatches
areplausiblebutincorrect[ 53].Thishighprecisionisachievedvia
patchprioritizationguidedbyourcontext-awaremodels.Specifi-
cally,98.78%(164/166)oftheincorrectplausiblepatchesareranked
afterthecorrectones(seeSection4.5fordetailedanalysis).
4.4 RQ2:Comparison with Existing Approaches
WecompareCapGenwithfiveAPRapproaches,ACS[ 53],HDRepair
[19],jGenProg[27],Nopol[54]andPAR[16,19],whichhavebeen
evaluated on the Defects4j benchmark within our knowledge.
Amongthem,ACS[ 53]andHDRepair[ 19]arethestate-of-the-
artapproaches.SimilartoCapGen,HDRepair[ 19]andPAR[16]
setthetimebudgetas90minutes.Nopol[ 54]andjGenProg[ 27]
setthesearchingtimeas3hours.ACS[ 53]setsthebudgetas30
minutessinceitonlytargetsatconditionsynthesisandthusthecorrespondingsearchspaceismuchsmaller.Table4showsthecomparisonresults.Thebaselines’resultsaredirectlyextracted
fromexistingliterature[ 16,20,53,54].Comparedwiththesetech-
niques,CapGenoutperformsallofthemintermsofthenumber
7
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 10:49:35 UTC from IEEE Xplore.  Restrictions apply. ICSE ’18, May 27-June 3, 2018, Gothenburg, Sweden M. Wen, J. Chen, R. Wu, D. Hao, and S. Cheung
Table 4: Comparisons with existing tools on Defects4J
ProjectCapGenHDRepairjGenProgPARACSNopol
Chart 42/2 0/0 0/- 2/0 1/0
Lang53/2 0/0 1/- 3/0 3/0
Math124/2 5/3 2/- 12/2 1/1
Time01/0 0/0 0/- 1/0 0/0
Total2110/6 5/3 3/- 18/2 5/1
Precision84.0%56.5% 18.5% - 78.3% 14.3%
X/Y:Xisthenumberofbugsrepairedbytheapproach;Yisthenumberofbugs
thatrepairedbyCapGenandalsobytheapproach.‘-’meanstheresultsarenotavailableduetothePARdidnotpresenttheIDoftherepairedbugs.
ofcorrectlyrepairedbugsandprecision.Byanalyzingtheoverlap
ofrepairedbugsbetweenCapGenandthecomparedtechniques,
CapGenactuallycomplementsthe-state-of-arttechniques.15ofthe
21bugsrepairedbyCapGenhaveneverbeenrepairedbyexisting
approaches[16,19,20,53,54].
Sixofthe21bugsrepairedbyCapGencanberepairedbythe
state-of-the-artsearch-basedapproachHDRepair[ 19].Thishap-
penswhentherequiredfixingingredientisatthestatementlevel
(e.g.,Math53)orcanbehandledbyspecificdesignedmutation
operations(e.g.,Chart1).ThedominantreasonwhyCapGencan
repair15newbugsisthatCapGenworksatafinergranularity(e.g.,
Figure2).Forthe4bugsthatcanbefixedbyHDRepair[ 19]but
notCapGen,themajorreasonisthatthefixingingredientsdonot
existinoursearchingscope.Forexample,forMath34,thecorrect
fixistoreplacethemethodinvokingexpression chromosimes in
chromosomes.iterator() with getChromosomes() .However,
the fixing ingredient getChromosomes() does not exist in the
buggyprogram,andthusCapGenfailedtorepairthebug.Tohan-
dlethiscase,HDRepair[ 19]designedamutationoperatorthat
replacesthenameofamethodcall(oramethodinvokingexpres-
sion)byanothermethodname(orexpression)withcompatible
types. By including more mutation operators or increasing the
scopetoextractfixingingredients,CapGencanhandlemorecases
(seeSection5.1formorediscussions).
=݆࢚࢔࢏4∗݊−1 ; 1135:
(ࢌ࢏1.5 ∗ ݇ݎ݋ݓ[݃݊݋ܲ݃݊݅݌] < ݇ݎ݋ݓ[ ૝∗( ࢔−૚ ) +݃݊݋ܲ݃݊݅݌ ] ) 1133:
941:݇ݎ݋ݓ=݀ࢋ࢒࢈࢛࢕ࢊ [ ૝∗( ࢔−૚ ) +݃݊݋ܲ݃݊݅݌ ] ;// ݐ݊݁݉݁ݐܽݐݏݕ݃݃ݑܤ
//ݐ݊݁݉݁ݐܽݐݏ݀݁ݔ݅ܨ 
 //=݆࢚࢔࢏݃ݑܾ݁ℎݐ݃݊݅ݔ݂݅ݎ݋݂ݏݐ݊݁݅݀݁ݎ݃݊݅݁ℎܶ૝∗( ࢔−૚ ) ; 1135:
Figure 5: Buggy statement, fixed statement and the fixingingredients of bug Math 80 in Defects4J.
ComparingwithACS[ 53],CapGencanrepair19differentbugs.
ThisisbecauseACSonlytargetsatsynthesizingpredicatecon-
ditions,andthusotherbugsingeneralareoutoftherepairing
capabilitiesofACS.Forinstance,ourmotivatingexampleshown
inFigure1whichreplacesthereturnvalueofanotherexpression.
AnothermotivatingexampleinFigure2cannotberepairedbyACS
neither,whichisanomissionbugandrequiresinsertingamethod
invocation to repair it. Actually, these kind of bugs can hardly
beenrepairedsuccessfullybyACS,aswellassemantics-basedAPR
[23,32,33,53],sincetheymainlyfocusonsynthesizingconditions
orright-handsideofassignments.Thisembodiestheindispensabil-
ityofsearch-basedAPRinprogramrepairwhichtargetsatfixing
bugsingeneral.WealsonoticethatCapGensuccessfullyrepaired
twobugsthatcanberepairedbyACSwhicharecausedbywrong
conditions.Forexample,byreplacingtheconditionin if (fa *
fb >= 0.0) with f a*f b>0 . 0 ,CapGencanrepairMath85.0200400600800
FL FL&MO GC DC VC GC&DC GC&VC DC&VC Context
Rank Tie67.23%
4.57%87.58%
61.82%84.84%
65.98%46.97%
42.70%92.48%
71.08%96.18%
78.40%96.30%
81.67%97.59%
84.31%
ܾ݃݊݅݉݋ܿݕܾ݈݁݀݋݉ݐݔ݁ݐ݊݋ܿℎ݂ܿܽ݁݋ݏ݊݋݅ݐܽݑ݈ܽݒ݁ݏ݈݅ܽݐ݁݀ݐ݅ 
&ܮܨℎݐ݅ݓ݀݁ݎܽ݌݉݋ܿ݁ݎܽݏݐ݊݁݉݁ݒ݋ݎ݌݉݅݁ℎݐ,ܱܯ&ܮܨℎݐ݅ݓܱܯ 
(GC&DC&VC)
Figure 6: The average rank of first correct patch.
ThesamecaseforChart1.However,CapGenrequirestheexistence
ofthefixingingredientsintheprogram.Thosecaseswhosefixing
ingredientsdonotexistintheprogrammightbehandledbyACS.
4.5 RQ3: Contributions of Each Model
Weusetheaverageresultsofthe22bugsshowninTable3to
answerthisquestion.Specifically,weconductednineexperiments
toexaminethecontributionofeachcomponentofCapGen.Figure
6 shows the results. Each bar has two heights. The white part
indicatesthefirstcorrectpatch’saveragerank,andtheirheight
difference(graycolored)givesthenumberofotherpatchesthatare
rankedintiewiththecorrectone.Inthefirstsetup,weuseonly
thesuspiciousvalueofthefaultspace(i.e., FL(Nt))torankallthe
patchesgenerated.Allmutationoperators,whicharedenotedas
MO,bearthesameweights,andnocontextmodelsareconsidered.
Inthesecondsetup,westudytheprioritizationperformancewith
themutationoperators’weightscombined(i.e., FL(Nt)∗Freq(M)).
Intheremainingsevensetups,weevaluatethecontributionofeachofourcontextmodelsandtheircombinationsonebyone.
Specifically,weintegrateasinglecontextmodeltothefinalranking
(i.e.,GCforGenealogyContext,DCforDependencyContextand
VCforVariableContext)andthearbitrarycombinationsofthem.In
Figure6,barsfromposition3to9showtheresultsbycombiningthecontextmodelswithFLandMO(e.g.,VCmeansCapGenleverages
FL,MOandtheVCmodeltoproducethefinalranking).
AsshowninFigure6,eachindividualmodelcontributestoim-
provetherankofcorrectpatches.IfweuseonlytheFLmodel,the
patchesaresimplyrankedbythesuspiciousvaluesofthebuggylo-cationsreturnbyGZoltar.Duetoinadequacyoftestcases[
42],the
rankingofthecorrectbuggylocationislowandcontainsmanyties.
Besides,manypossiblepatchescanbegeneratedforeachlocation.
Thesetworeasonsaccountforthepoorranks(e.g.,,thelowrank
andmanyties)ofthecorrectpatches.Bycombiningtheweights
ofthemutationoperators,CapGencansignificantlybreaktheties
andreducethenumberoftiesby67 .23%.Theperformanceofthe
firstrankhasalsobe enimprovedby4 .57%.Byfurtherintroducing
allthecontextmodelsoffixingingredients,therankisfurtherimprovedby84
.31%andthenumberoftiesarefurtherreduced
by97.59%withrespecttotherankingofusing FL(Nt)∗Freq(M).
LetusillustratethisusingthebugshowninFigure5.Thebuggy
expressionisinanAssignmentunderanIfStatement(line1133).
ThecorrectfixingingredientalsoexistsinanAssignmentanda
conditionexpressioninanIfStatement.Bycapturingsuchcon-
textinformation,wecanprioritizethecorrectfixingingredientsat
highpositions.Specifically,thecorrectpatchisrankedat6758with
3767tiesifonlytheFLmodelisused.ByincludingtheMOmodel,
itcanberankedat5807with1002ties.Byincludingallthethree
8
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 10:49:35 UTC from IEEE Xplore.  Restrictions apply. Context-Aware Patch Generation for Better Automated Program Repair ICSE ’18, May 27-June 3, 2018, Gothenburg, Sweden
050100150200
FL FL&MO GC DC VC GC&DC GC&VC DC&VC Context
Before TieAfter(GC&DC&VC)
Figure 7: Total number of plausible patches
contextmodels,itcanberankedat221with35ties,whichcanbe
searchedwithin30minutes.Fortherankingsofeachindividual
modelandthecombinationsofthem,theimprovementiscomputed
againsttherankingofusing FL(Nt)∗Freq(M).Theresultsshow
thatthethreemodelscollectivelyachievethebestperformance,
followedbythecombinationofthetwomodelsofDCandVC.
Anothercrucialfunctionofourcontext-waremodelsisthatthey
canprioritizethecorrectpatchesbeforetheincorrectplausible
ones.Themajorityofthepatchesgeneratedwhichpassalltestcasesareplausiblebutincorrectduetotheweaktestsprovided
[42,52,56].Previoustechniques[ 16,19,20,29,36,46]userandom
techniquestosearchamongthesegeneratedpatches,andtherefore,
theyaremorelikelytoproducetheincorrectplausiblepatches
[38].Thisproblemcanbesignificantlyalleviatedbyprioritizingthe
patchesusingourcontextmodels.Figure7showsthedistributions
ofthetotalnumberofincorrectplausiblepatchesranked before,
in tie withandafterthecorrectpatchesunderthenineanalyses.
TheuseofFLmodelaloneinthefirstanalysisleadsto80 .69%of
theincorrectplausiblepatchesgeneratedbeingrankedintiewith
orbeforethefirstcorrectone.Thenumberhasbeenreducedby
17.18%byintroducingtheMOmodel,and98 .52%inafurtherstep
bycombiningourcontextmodels.Finally,only2plausiblepatches
arerankedbeforeorintiewiththecorrectones.Wealsopresent
theresultsindetailforeachofourcontextmodel.Forexample,byintegratingtheGC,DCandVCmodelalonecanreducethe
numberby82 .22%,80.74%and34 .07%respectivelycomparingwith
theresultsgeneratedbyleveragingFLandMO.
Letusfurtherillustratetheeffectivenessofourcontextmodels
bycaseanalysis.ForourmotivatingexampleshowninFigure1,
CapGencanrankthecorrectpatchatposition4beforeallother8
plausiblebugs.Replacingthevariable xinthefunction isNaN(x)
withfield MathUtils.TWO_PI isoneexampleofincorrectplau-
siblepatches.However,duetothelowcontextsimilaritysharedby
xand MathUtils.TWO_PI ,thefinalprobabilityofthispatch
isonly4 .97-e4,andthusrankedafterthecorrectpatch.Replacing
Double.isNaN(x) && Double. isNaN(y) withexpression x==0
canalsopassthetestsuite.However,ourvariablecontextmodel
favorsthoseingredientswhichinvolvemoresimilarvariableswiththetargetnode.Therefore,thispatchisalsorankedafterthecorrect
one.Similarcasesfortheotherbugs.
CapGenfailstorankthecorrectpatchbeforeallincorrectplau-
sibleonesforMath80showninFigure5.Duetoweaktestcases
provided,81incorrectplausiblepatcheshavebeengeneratedand78
ofthemarerankedafterthecorrectoneusingourcontextmodels.
However,therearestill2exceptions.Forexample,replacingthe
variable natline1135withanothervariable pingPongcanpassall
thetestcases,andCapGenfailstorankthisoneafterthecorrect
patch.Itisbecausethesetwovariablesareusedtogetheralotintheprogramandthussharingahighcontextsimilarity.Besides,our
variablecontextmodelcannotfilterouttherankofthispatchsince
itonlyrequirestheirtypestobethesameifboththeingredient
andthetargetnodeareSimpleNameasdescribedinSection3.2.1.
Theseresultsshowthateachofourproposedmodelcanhelp
rankthecorrectpatchesattoppositionsand,moreimportantly,
beforetheincorrectplausibleones.
5 DISCUSSIONS
5.1 On the Extensions of CapGen
CapGenperformsasinglemutationtogeneratepatches,which
indicatesCapGencanonlytargetatfixingthosebugsrequiringa
singlerepairactioncurrently.However,thistypeofbugsiscommon
inpractice[28,58].Forexample,aexistingstudyfoundthataround
30%ofthebugscanbefixedbyasinglerepairaction[ 58].Inthe
Defects4Jbenchmark,31 .70%ofthebugs(71/224)canberepaired
byasinglerepairaction.Notethat,patchesgeneratedviaasimple
repairactionmightalsobecomplex.Forexample,CapGeninserts
awholeIfStatement,whichacrossthreelines,tofixbugMath
53.Inthefuture,wewillincludeperformingmutationsatmultiple
placesinCapGen.Atthesametime,wewillalsotrytoreducetheincreaseofthesearchspacethatitincurs.Onepossibledirectionistoperformthesameoperationatmultiplebuggytargetnodessimul-
taneouslyinthefaultspaceiftheyareidenticaltoeachother.For
example,anbuggyexpression return isZero?NaN:INF existsat
multipleplacesforMath46,repairingthisbugrequireschanging
allthesebuggyexpressionstothecorrectones.
Inthefuture,wealsoplantoincludemoremutationoperatorsto
increasethechancesofrepairingmorebugs,whichcouldbeeasily
integrated by design. Furthermore, CapGen currently searches
onlyinthesameprogramfilewherethetargetnoderesidestofindfixingingredients.Amongthe71bugswhichrequireonlyonerepair
action,only27ofthemwhoseallrequiredfixingingredientscan
befoundinthesameprogram.Therefore,extendingthesearching
scopeisapromisingextensionforCapGen,whichcanincreasethe
chancestofindthecorrectfixingingredientsformorebugs[ 30].
Forexample,ifwesearchamongthewholeapplication,wecanfind
theingredientsfortwomorebugsamongthe71bugs.However,including more mutation operators and enlarging the scope to
searchtheingredientswillinevitablyincreasethesearchspaceandthusmakeitmorechallengetoidentifythecorrectpatch.Therefore,bettersearchingstrategiesaredesired.Currently,CapGencombinesFL,MOandthethreecontextmodelsbymultiplicationtoprioritize
thesearchspace.Inthefuture,CapGenwilltrybetterstrategies
suchaslearning-to-ranktechniquestointegratethesemodels.
5.2 Threats to Validity
Onepotentialthreattovalidityisthegeneralityofthebenchmark
Defects4J,whichmeansthatourevaluationresultsmaynotbe
generalizedtootherdataset.WeplanedtouseBugFixSetforcross
validation.However,itonlyprovidesthepatchforeachbugwith-
outthecorrespondingtestcases.Therefore,itmakesitimpossible
tovalidatethecorrectnessofthepatchesgeneratedbyCapGen
automatically.TheotherbenchmarkinJavabesidesDefects4Jis
IntroClassJava[ 10,22]withinourknowledge.Toalleviatethe
threatofgenerality,wealsoevaluatedCapGenonthisbenchmark.
IntroClassJavaistheJavaversionoftheIntroClassbenchmark
9
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 10:49:35 UTC from IEEE Xplore.  Restrictions apply. ICSE ’18, May 27-June 3, 2018, Gothenburg, Sweden M. Wen, J. Chen, R. Wu, D. Hao, and S. Cheung
originallyproposedbyLeGoues etal.[22].Thisbenchmarkcon-
tains297bugsfromstudent-writtenhomeworkassignments.These
bugsfeaturecomplicatedfixesalthoughtheyaresmallprograms
[55].Wefollowexitingtechniques[ 18,57]tocheckwhetheragen-
eratedpatchiscorrect.WerunCapGenonthisbenchmarkand
foundthatitcansuccessfullyrepair25bugsintotal.Thestate-of-
the-artsemantics-basedAPRtechniques,JFix[ 18]andAngelix[ 32],
whichworkontheIntroClassJavabenchmark,areabletorepair
19and7bugsrespectively[ 18].Specifically,CapGencanrepair14
newbugs.ItisbecauseneitherAngelixnorJFixcanhandlefloating
pointorstringsrelatedbugs[ 55]limitedbythecapabilityofthe
constraintsolvingtechniques.Therefore,theyhaveonlyevaluated
onasubsetoftheIntroClassJavabenchmarkwhichonlyincludes
integerandboolean-relatedfixes.CapGenhasnosuchlimitations
andareevaluatedonthewholedataset.Thisresultalsoshowsthat
CapGencomplementswelltoexistingapproaches.
Besides,CapGenisdesignedindependentofthedatasetusedfor
evaluation.Specifically,themutationoperatorsareprioritizedbased
onsubstantialrealbugfixesextractedfromopensourceprojects.
Forthethreecontextmodelsproposedtoprioritizetheingredients,
weconductanempiricalstudyandtheresultsshowsthatthecorrect
fixingingredientsindeedsharehighcontextsimilaritywiththe
targetnodesmeasuredbyourmodels.Thisfindingisgeneral,and
canfacilitatethedesignofselectingfixingingredientsforboth
search-basedandsemantics-basedAPRtechniquesinthefuture.
6 RELATED WORK
Automatedprogramrepairtechniquescanbebroadlyclassified
intotwocategories.Thefirstcategoryissearch-basedAPR[ 16,19,
20,36,38,43,45,46].Themostrepresentativeofthiscategoryis
GenProg[20,46],whichsearchesforcorrectpatchesviagenetic
programmingalgorithm.RSRepair[ 36]adoptsthesamefaultspace
andoperationspaceasGenProg.ItdiffersfromGenProginthat
itsearchesamongallthecandidatesrandomlyinsteadofusing
geneticprogramming.Reducingthenumberofcandidatepatches
andreducingthetestcasesrequiredforvalidatingapatcharetwo
importantaspectstoboosttheefficiencyofsearch-basedAPRtech-
niques[11].Motivatedbythis,AE[ 45]isproposedtoreducethe
totalcostrequiredtofindacorrectpatch.Inordertogeneratecandi-datesthataremorelikelytobethecorrectpatch,PAR[
16]proposes
toleveragefixingtemplateslearnedfromhumanpatchestogen-eratepossiblecandidates.Eachtemplateisabletofixacommon
typeofbugs.ThedesignofmutationoperatorsofCapGenisalso
guidedbysubstantialrealbugfixes.However,CapGenonlylever-
agesthesyntacticinformationtodesignthemutationoperators
(i.e.,insertingatypeofcodeelementunderanothertypeofcode
element).PARdesignsmutationoperatorsconsideringtheseman-
ticinformationsuchasaddinganullpointerchecker.Designing
withsuchspecificinformationmakesPARlessgeneralizablethan
CapGen.ThemostrecentworkisHDRepair[ 19],whichleverages
historicaldatatosearchforcorrectpatches.
Thesecondcategoryissemantics-basedAPR,whichsynthe-
sizesarepairpatchdirectlyusingsemanticinformationviasym-bolicexecutionandconstraintsolving[
9,13,15,31–33,44,54].
StagedProgramRepair(SPR)[ 23]isahybridofsearch-basedand
semantics-basedautomatedprogramrepairtechnique.Itleverages
traditionalmutationoperatorstogeneratecandidatepatches[ 8],anditisalsocapableofsynthesizingconditionsviasymbolicexe-
cution.Prophet[ 25]wasproposedbasedonSPR,whichiscapable
ofprioritizingcandidatepatchesvialearningfromcorrectpatches
automaticallyusingmachinelearningtechniques.SPRandProphet
onlysynthesizeprogramelementsinvolvingconditions.Nopolis
alsocapableofsynthesizingconditions[ 54].SemFix[33]iscapable
ofsynthesizingrighthandsideofassignmentsbesidesconditions.
Angelix[32]wasproposedtoaddressthescalabilityissueconcern-
ingsemantics-basedtechniquesusinganovellightweightrepairconstraint angelic forest.S3wasrecentlyproposedtosynthesize
patchesleveragingprogram-by-examplestechniques[55].
Bothsearch-basedAPRandsemantics-basedAPRtechniques
havetheiradvantagesanddisadvantages.Search-basedAPRissim-
ple,intuitiveandgeneralizabletofixalltypesofbugs,whichmake
themmoreeffective.However,theefficiencyisgreatlycompro-misedbythesearchspaceexplosionproblem[
24].Ontheother
hand,semantics-basedAPRismoreeffectivesincethesearchspaceismoretractablebyusingprogramsynthesiswithrestrictedcompo-nents.However,theeffectivenesscouldbelimitedbythecapability
ofconstraintsolvingandprogramsynthesis.Besides,bothofthese
twocategoriessufferfromtheoverfittingproblem[42,52].
In order to generate high-quality patches, many approaches
proposetorankthepatchesbasedontheirlikelihoodtobecorrect
recently[7,19,25,31,53,55].HDRepairprioritizespatchesbased
ontheirsimilaritieswithpreviousfixpatternsthatareminedfrom
softwarehistories[ 19].Prophet[25]alsocomparesthegenerated
patchwithexistinghumanpatchestoinvestigateitsprobability
ofbeingcorrectbutleveragesdifferentfeaturesasHDRepair[ 19].
ACSleveragestheinformationminedfromotherprojectsandJava
documentationstoprioritizethevariablesandpredicatesusedin
thesynthesizedconditions[ 53].S3prioritizesthegeneratedpatches
bycomparingtheirsimilaritieswiththeoriginalbuggyprogramin
termsasetoffeatures[ 55].Differentfromthem,CapGendirectly
leveragesthecontextinformationextractedfromthebuggycode
elements and the fixing ingredients to prioritize the generated
patches.Tothebestofourknowledge,incorporatingthecontext
informationoffixingingredientsisnewtoprogramrepair.
7 CONCLUSION
Wepresentanovelsearch-basedAPRtechnique,CapGen,which
worksontheASTnodeleveltoincreasethechancesofincluding
thecorrectpatchesinthesearchspace.Thekeynoveltyof Cap-Genwhichallowsittogenerateandsearchthecorrectpatchesefficientlyisthatthepatchgenerationprocessiscontext-aware,
specifically,inthefollowingtwoaspects:1).Themutationoperatorsareprioritizedconsideringthecontextinformationguidedbylarge
historicaldata.2).Fixingingredientsareextractedtogetherwith
theircontextinformation,andsuchinformationisleveragedtopri-
oritizethegeneratedpatches.WeevaluateCapGenonDefects4J,
andtheresultsshowthatCapGenoutperformsandcomplements
existingstate-of-the-arttechniques.Moreimportantly,CapGencanachieveaprecisionof84
.00%andcanprioritizethecorrectpatches
inpriorto98 .78%oftheplausiblebutincorrectones.
ACKNOWLEDGMENTS
TheworkwassupportedbytheHongKongRGC/GRFGrantNo.
16202917,theMSRACollaborativeResearchAward,andtheNa-
tionalNaturalScienceFoundationofChinaunderGrantNo.61522201.
10
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 10:49:35 UTC from IEEE Xplore.  Restrictions apply. Context-Aware Patch Generation for Better Automated Program Repair ICSE ’18, May 27-June 3, 2018, Gothenburg, Sweden
REFERENCES
[1] 2017. https://github.com/xuanbachle/bugfixes.(2017). Accessed:2017-03-22.
[2] 2017. http://www.gzoltar.com.(2017). Accessed:2017-03-22.[3] 2017. Understand. https://scitools.com.(2017). Accessed:2017-03-22.[4]
EarlTBarr,YuriyBrun,PremkumarDevanbu,MarkHarman,andFedericaSarro.
2014. Theplasticsurgeryhypothesis.In FSE’14.ACM,306–317.
[5]MarcelBöhme,EzekielOlamideSoremekun,SudiptaChattopadhyay,Emamurho
Ugherughe,andAndreasZeller.2017. WhereistheBugandHowisitFixed?An
ExperimentwithPractitioners.In ESEC/FSE’2017 (ESEC/FSE 2017).1–11.
[6]TomBritton,LisaJeng,GrahamCarver,PaulCheak,andTomerKatzenellenbo-
gen.2013. Reversibledebuggingsoftware. JudgeBus.School,Univ.Cambridge,
Cambridge, UK, Tech. Rep (2013).
[7]LorisDâĂŹAntoni,RoopshaSamanta,andRishabhSingh.2016. Qlose:Program
repairwithquantitativeobjectives.In InternationalConferenceonComputerAided
Verification.Springer,383–401.
[8]VidrohaDebroyandWEricWong.2010.Usingmutationtoautomaticallysuggest
fixesforfaultyprograms.In 2010 Third International Conference on Software
Testing, Verification and Validation.IEEE,65–74.
[9]Favio DeMarco, Jifeng Xuan, Daniel Le Berre, and Martin Monperrus. 2014.
Automaticrepairofbuggyifconditionsandmissingpreconditionswithsmt.In
Proceedingsofthe6th InternationalWorkshoponConstraintsinSoftware Testing,
Verification, and Analysis.ACM,30–39.
[10]ThomasDurieuxandMartinMonperrus.2016. IntroClassJava: ABenchmarkof
297 Small and Buggy Java Programs. Ph.D.Dissertation.UniversiteLille1.
[11]StephanieForrest,ThanhVuNguyen,WestleyWeimer,andClaireLeGoues.2009.
Ageneticprogrammingapproachtoautomatedsoftwarerepair.In GECCO’2009.
ACM,947–954.
[12]MarkGabelandZhendongSu.2010. Astudyoftheuniquenessofsourcecode.
InFSE’10.ACM,147–156.
[13]GuoliangJin,LinhaiSong,WeiZhang,ShanLu,andBenLiblit.2011. Automated
atomicity-violationfixing.In ACM SIGPLAN Notices,Vol.46.ACM,389–400.
[14]RenéJust,DarioushJalali,andMichaelDErnst.2014. Defects4J:Adatabaseof
existingfaultstoenablecontrolledtestingstudiesforJavaprograms.In ISSTA’2014.
ACM,437–440.
[15]YalinKe,KathrynTStolee,ClaireLeGoues,andYuriyBrun.2015. Repairing
programswithsemanticcodesearch(T).In ASE’2015.IEEE,295–306.
[16]DongsunKim,JaechangNam,JaewooSong,andSunghunKim.2013. Automatic
patchgenerationlearnedfromhuman-writtenpatches.In ICSE’2013.IEEEPress,
802–811.
[17]Xuan-BachDLe.2016. Towardsefficientandeffectiveautomaticprogramrepair.
InASE’2016.ACM,876–879.
[18]Xuan-BachDLe,Duc-HiepChu,DavidLo,ClaireLeGoues,andWillemVisser.
2017. JFIX:semantics-basedrepairofJavaprogramsviasymbolicPathFinder.In
ISSTA’17.ACM,376–379.
[19]XuanBachDLe,DavidLo,andClaireLeGoues.2016. HistoryDrivenProgram
Repair.In SANER’2016,Vol.1.IEEE,213–224.
[20]ClaireLeGoues,MichaelDewey-Vogt,StephanieForrest,andWestleyWeimer.
2012.Asystematicstudyofautomatedprogramrepair:Fixing55outof105bugs
for8each.In ICSE’2012.IEEE,3–13.
[21]ClaireLeGoues,StephanieForrest,andWestleyWeimer.2013.Currentchallenges
inautomaticsoftwarerepair. Software Quality Journal 21,3(2013),421–443.
[22]ClaireLeGoues,NealHoltschulte,EdwardKSmith,YuriyBrun,Premkumar
Devanbu,StephanieForrest,andWestleyWeimer.2015. TheManyBugsand
IntroClassbenchmarksforautomatedrepairofCprograms. IEEETransactions
on Software Engineering 41,12(2015),1236–1256.
[23]FanLongandMartinRinard.2015. Stagedprogramrepairwithconditionsyn-
thesis.In FSE’2015.ACM,166–178.
[24]FanLongandMartinRinard.2016. Ananalysisofthesearchspacesforgenerate
andvalidatepatchgenerationsystems.In ICSE’2016.ACM,702–713.
[25]FanLongandMartinRinard.2016. Automaticpatchgenerationbylearning
correctcode.In ACM SIGPLAN Notices,Vol.51.ACM,298–312.
[26]Henry B Mann and Donald R Whitney. 1947. On a test of whether one of
two random variables is stochastically larger than the other. The annals of
mathematical statistics (1947),50–60.
[27]MatiasMartinez,ThomasDurieux,RomainSommerard,JifengXuan,andMartinMonperrus.2016.AutomaticrepairofrealbugsinJava:Alarge-scaleexperiment
ontheDefects4Jdataset. Empirical Software Engineering (2016),1–29.
[28]MatiasMartinezandMartinMonperrus.2015.Miningsoftwarerepairmodelsfor
reasoningonthesearchspaceofautomatedprogramfixing. Empirical Software
Engineering20,1(2015),176–205.
[29]MatiasMartinezandMartinMonperrus.2016.ASTOR:AProgramRepairLibrary
forJava.In Proceedings of ISSTA, Demonstration Track.
[30]MatiasMartinez,WestleyWeimer,andMartinMonperrus.2014. Dothefix
ingredientsalreadyexist?anempiricalinquiryintotheredundancyassumptions
ofprogramrepairapproaches.In CompanionProceedingsofthe36thInternational
Conference on Software Engineering.ACM,492–495.
[31]SergeyMechtaev,JooyongYi,andAbhikRoychoudhury.2015.Directfix:Looking
forsimpleprogramrepairs.In ICSE’2015,Vol.1.IEEE,448–458.[32]SergeyMechtaev,JooyongYi,andAbhikRoychoudhury.2016. Angelix:Scalable
multilineprogrampatchsynthesisviasymbolicanalysis.In ICSE’2016.ACM,
691–701.
[33]HoangDuongThienNguyen,DaweiQi,AbhikRoychoudhury,andSatishChan-
dra.2013.SemFix:programrepairviasemanticanalysis.In ICSE’2013.IEEEPress,
772–781.
[34]RenaudPawlak,MartinMonperrus,NicolasPetitprez,CarlosNoguera,andLionel
Seinturier.2015. Spoon:ALibraryforImplementingAnalysesandTransforma-
tionsofJavaSourceCode. Software:PracticeandExperience 46(2015),1155–1179.
DOI:http://dx.doi.org/10.1002/spe.2346
[35]Jeff H Perkins, Sunghun Kim, Sam Larsen, Saman Amarasinghe, Jonathan
Bachrach,MichaelCarbin,CarlosPacheco,FrankSherwood,SteliosSidiroglou,
GregSullivan,andothers.2009. Automaticallypatchingerrorsindeployedsoft-
ware.InProceedingsoftheACMSIGOPS22ndsymposiumonOperatingsystems
principles.ACM,87–102.
[36]YuhuaQi,XiaoguangMao,YanLei,ZiyingDai,andChengsongWang.2014.The
strengthofrandomsearchonautomatedprogramrepair.In ICSE’2014.ACM,
254–265.
[37]YuhuaQi,XiaoguangMao,YanLei,andChengsongWang.2013.Usingautomated
programrepairforevaluatingtheeffectivenessoffaultlocalizationtechniques.
InISSTA’2013.ACM,191–201.
[38]ZichaoQi,FanLong,SaraAchour,andMartinRinard.2015.Ananalysisofpatch
plausibilityandcorrectnessforgenerate-and-validatepatchgenerationsystems.
InISSTA’2015.ACM,24–36.
[39]DongQiu,BixinLi,EarlTBarr,andZhendongSu.2017. Understandingthe
syntacticruleusageinjava. JournalofSystemsandSoftware 123(2017),160–172.
[40]SinaShamshiri,RenéJust,JoséMiguelRojas,GordonFraser,PhilMcMinn,and
AndreaArcuri.2015.DoAutomaticallyGeneratedUnitTestsFindRealFaults?An
EmpiricalStudyofEffectivenessandChallenges(T).In ASE’2015.IEEE,201–211.
[41]SteliosSidiroglou-Douskos,EricLahtinen,FanLong,andMartinRinard.2015.Au-
tomaticerroreliminationbyhorizontalcodetransferacrossmultipleapplications.
InACM SIGPLAN Notices,Vol.50.ACM,43–54.
[42]EdwardKSmith,EarlTBarr,ClaireLeGoues,andYuriyBrun.2015. Isthecure
worsethanthedisease?overfittinginautomatedprogramrepair.In Proceedings
of the 2015 10th Joint Meeting on Foundations of Software Engineering.ACM,
532–543.
[43]ShinHweiTanandAbhikRoychoudhury.2015. relifix:Automatedrepairof
softwareregressions.In ICSE’2015.IEEEPress,471–482.
[44]YiWei,YuPei,CarloAFuria,LucasSSilva,StefanBuchholz,BertrandMeyer,and
AndreasZeller.2010.Automatedfixingofprogramswithcontracts.In ISSTA’2010.
ACM,61–72.
[45]WestleyWeimer,ZacharyPFry,andStephanieForrest.2013.Leveragingprogram
equivalenceforadaptiveprogramrepair:Modelsandfirstresults.In ASE’2013.
IEEE,356–366.
[46]WestleyWeimer,ThanhVuNguyen,ClaireLeGoues,andStephanieForrest.2009.
Automaticallyfindingpatchesusinggeneticprogramming.In ICSE’2009.IEEE
ComputerSociety,364–374.
[47] MarkWeiser.1981. Programslicing.In ICSE’1981.IEEEPress,439–449.
[48]MingWen,JunjieChen,RongxinWu,DanHao,andShing-ChiCheung.2017.An
EmpiricalAnalysisoftheInfluenceofFaultSpaceonSearch-BasedAutomated
ProgramRepair. arXiv preprint arXiv:1707.05172 (2017).
[49]MingWen,RongxinWu,andShing-ChiCheung.2016.Locus:locatingbugsfrom
softwarechanges.In ASE’2016.ACM,262–273.
[50]WEricWong,RuizhiGao,YihaoLi,RuiAbreu,andFranzWotawa.2009. A
surveyonsoftwarefaultlocalization. (2009).
[51]RongxinWu,MingWen,Shing-ChiCheung,andHongyuZhang.2017. Change-
Locator:locatecrash-inducingchangesbasedoncrashreports. EmpiricalSoftware
Engineering(2017),1–35.
[52]QiXinandStevenPReiss.2017.Identifyingtest-suite-overfittedpatchesthrough
testcasegeneration.In ISSTA,17.ACM,226–236.
[53]YingfeiXiong,JieWang,RunfaYan,JiachenZhang,ShiHan,GangHuang,and
LuZhang.2017. Preciseconditionsynthesisforprogramrepair.In ICSE’17.IEEE
Press,416–426.
[54]JifengXuan,MatiasMartinez,FavioDemarco,MaximeClément,SebastianLame-
lasMarcote,ThomasDurieux,DanielLeBerre,andMartinMonperrus.2016.
Nopol:Automaticrepairofconditionalstatementbugsinjavaprograms. (2016).
[55]DLeXuan-Bach,ChuDuc-Hiep,LoDavid,GouesClaire,Le,andWillemVisser.
2017. S3:Syntax-andSemantic-GuidedRepairSynthesisviaProgrammingby
Examples.In FSE’2017.ACM,toappear.
[56]JinqiuYang,AlexeyZhikhartsev,YuefeiLiu,andLinTan.2017. Bettertestcases
forbetterautomatedprogramrepair.In FSE’17.ACM,831–841.
[57]LucianoZemín,SimónGutiérrezBrida,ArielGodio,CésarCornejo,RenzoDegio-
vanni,GermánRegis,NazarenoAguirre,andMarceloFrias.2017. Ananalysisof
thesuitabilityoftest-basedpatchacceptancecriteria.In Proceedings of the 10th
International Workshop on Search-Based Software Testing.IEEEPress,14–20.
[58]HaoZhongandZhendongSu.2015. Anempiricalstudyonrealbugfixes.In
ICSE’15.IEEEPress,913–923.
11
Authorized licensed use limited to: LAHORE UNIV OF MANAGEMENT SCIENCES. Downloaded on August 07,2025 at 10:49:35 UTC from IEEE Xplore.  Restrictions apply. 