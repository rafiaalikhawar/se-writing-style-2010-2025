PhysFrame: TypeCheckingPhysicalFramesofReference for
Robotic Systemsâˆ—
Sayali Kate
PurdueUniversity
USA
skate@purdue.eduMichael Chinn
Universityof Virginia
USA
mec2wr@virginia.eduHongjunChoi
PurdueUniversity
USA
choi293@purdue.edu
XiangyuZhang
PurdueUniversity
USA
xyzhang@cs.purdue.eduSebastian Elbaum
Universityof Virginia
USA
selbaum@virginia.edu
ABSTRACT
Aroboticsystemcontinuouslymeasuresitsownmotionsandtheex-
ternalworldduringoperation.Suchmeasurementsarewithrespect
tosomeframeofreference, i.e.,acoordinatesystem.Anontrivial
robotic system has a large number of different frames and data
have to be translatedback-and-forth from aframe to another. The
onus is on the developers to get such translation right. However,
this is very challenging and error-prone, evidenced by the large
numberofquestionsandissuesrelatedtoframeusesondevelopersâ€™
forum. Since any state variable can be associated with some frame,
reference frames can be naturally modeled as variable types. We
hence develop a novel type system that can automatically infer
variablesâ€™frametypesandinturndetectanytypeinconsistencies
andviolationsofframeconventions.Theevaluationonasetof180
publiclyavailableROSprojectsshowsthatoursystemcandetect
190inconsistencieswith154truepositives.Wereported52todevel-
opersandreceived18responsessofar,with15fixed/acknowledged.
Our techniquealsofinds 45 violations of common practices.
CCS CONCEPTS
Â·Software and its engineering â†’Abstract data types ;Soft-
ware defectanalysis.
KEYWORDS
Physical Frame of Reference, Frame Consistency, Type Checking,
Static Analysis, z-score Mining, Robotic Systems
ACM Reference Format:
Sayali Kate, Michael Chinn, Hongjun Choi, Xiangyu Zhang, and Sebastian
Elbaum. 2021. PhysFrame: Type Checking Physical Frames of Reference
for Robotic Systems. In Proceedings of the 29th ACM Joint European Soft-
ware Engineering Conference and Symposium on the Foundations of Software
Engineering (ESEC/FSE â€™21), August 23Å›28, 2021, Athens, Greece. ACM, New 
York, NY, USA, 12 pages. https://doi.org/10.1145/3468264.3468608
âˆ—An extended version is available at arXiv [19].
ESEC/FSE â€™21, August 23Å›28, 2021, Athens, Greece
Â© 2021 Copyright held by the owner/author(s).
ACM ISBN 978-1-4503-8562-6/21/08.
https://doi.org/10.1145/3468264.34686081 INTRODUCTION
Roboticsystemshaverapidlygrowingapplicationsinourdailylife,
enabled by the advances in many areas such as AI. Engineering
suchsystemsbecomesincreasinglyimportant.Duetotheunique
characteristicsofsuchsystems,e.g.,theneedofmodelingthephys-
ical world and satisfying the real time and resource constraints,
robotic system engineering poses new challenges to developers.
Oneoftheprominentchallengesistoproperlyusephysicalframes
ofreference.Specifically,theoperationofaroboticsysteminvolves
moving individual body parts and interacting with the external
world. It entails precisely measuring positions and orientations of
body parts and external objects. All these measurements are repre-
sentedwithrespecttoasetofcoordinatesystems(alsocalled frames
ofreference orframesinshort).Forexample,inathree-dimensional
coordinate system, the location (1,2,3) is meaningless unless we
know the frame to which this location refers to. The origin of a
frame provides the reference position (0,0,0), whereas theorienta-
tion of the three axes tells us the directions in which they point to.
Further, the origin and orientation of a frame itself may be defined
relative to anotherframe andsoon.
Roboticsystemsusuallyfollowamodulardesign,inwhichbody
parts and control software components are developed indepen-
dently by various parties. As such, different components often
usedifferentframes.Forexample,acamerahasthe cameraframe
throughwhichthephysicalworldismeasuredfromthecameraâ€™s
perspective. In this frame, the center of camera is the origin and
the axes follow the orientations of the camera. The body of a robot
has thebody frame whose origin is the center of the body and axes
arepre-definedbasedontheshapeofrobot.Measurementsinthe
camera frame have to betranslated to the body frame before they
can be used in body related computation. Since the camera can
bemountedatdifferentplacesandmovesduringoperation,such
translation has to be done by the developers in software. More
discussion about frames and an example can be found in Section 2.
Mostroboticsystemsaredevelopedingeneralpurposelanguages
such as C/C++, facilitated by domain specific libraries. Such lan-
guages do not have intrinsic support for the additional complexity
induced by the use of frames. For example, although popular li-
braries such as ROS [ 32] provide functions to facilitate translation
between frames, the onus is on the developers to determine the
referenceframesofprogramvariables,theplaceswheretranslation
45This work is licensed under a Creative Commons Attribution International 4.0 License.
ESEC/FSE â€™21, August 23â€“28, 2021,Athens,Greece S.Kate, M. Chinn, H.Choi, X.Zhang,S.Elbaum
Figure1:Forumpoststhatshowframesinroboticprogram-
mingaredifficulttohandle. (Note:right-sidesnapshotistakenfrom
http://wiki.ros.org/ROS/Troubleshooting page licensed underthe CC BY3.0)
is needed, and correctly implement the concrete translations. Since
translation is often done by vector/matrix operations, many de-
velopers even realizetheir own translation functionsfrom scratch
withoutusingROSAPIs.Asaresult,useofframesiserror-prone,
even for experienced developers. This is evidenced by the fact that
a large number of questions and issues for a robotic system project
areusuallyregardingreferenceframes.Figure 1showsthatques-
tionstaggedwithâ€˜ tfâ€™(akeywordforROSframesupport[ 14,36])
are among the top ten types of questions by ROS developers, such
asÅ‚confusedaboutcoordinateframes ",Å‚tftransformsareconfusing ",
andÅ‚isthereaneasierwaytofindthecoordinatesofapointinan-
otherframe ".Also,ROSwikiidentifiestransformissuesasoneof
thetop5commonproblems.Besidesthedifficultiesofgettingthem
rightduringdevelopment,misuseofframesmaycauserobotrun-
time malfunction [ 5], code reuse problems [ 1,4], and maintenance
difficulties after deployment.
ROS provides a number of tools to help developers debug frame
relatedproblems[ 2].Thesearemostlyruntimetoolsthatcanfacili-
tatevisualizationofframes,relationbetweenframes,detailsofa
transformation between two frames (e.g. when it is created and by
whichcomponent). However, it isalways more desirable to detect
problemsasearlyaspossibleinthedevelopmentlife-cycle.Astatic
tool that can scan and detect frame misuses before running the
system would be highly desirable. To the best of our knowledge,
there are unfortunately nosuch tools.
In this paper, we introduce and implement a novel fully auto-
matedstatictooltoidentifyframerelatedproblemsinROS-based
projects. Developers direct the tool to operate on a project direc-
tory, and the tool automatically models the project, and checks for
potential frame faults. Since each physical state related variable
(e.g., sensor reading, acceleration, velocity, and position) is associ-
ated with some frame, our tool builds on such such associations
which are similar to variable types by nature. We hence propose
a type system to model reference frames. A traditional type sys-
temoftenstartswithtypeannotationsthatrequiredevelopersto
know variable types in the first place, which is difficult in our con-
text as knowing the right frames is usually difficult. Instead, our
technique automatically infers frames and performs type consis-
tency checks, leveraging ROS conventions that can be extracted
from its specifications and mined from code repositories. The tech-
nique uses frame information sources such as static data values
exchanged between components and the ROS frame APIs for as-
signing frame types, and defines type propagation and checking
rulesbasedonthestandardcoordinateconventionsdocumentedin
ROS-Enhancement-Proposals (REPs) and the semantics of frame
related operations such as displacements and rotations. As partofourcontributionwepresentatypelanguageasavehicletode-
scribe these type rules , which constitute the foundation for our
domain-specific staticanalyzer.
Our contributionsare summarizedas follows:
â€¢We propose a fully automated type inference and checking tech-
niqueforphysicalframesinROS-basedprogramstodetectframe
inconsistenciesandconvention violations.
â€¢We define frame and transformation abstract types, and our sys-
temautomaticallyinferssuchtypesforvariables.Thisisachieved
bynovel abstractionof framerelatedprogram semantics.
â€¢We present a data-driven approach to identifying commonly
followedpracticesthatmaynotbedocumentedanywhere.Our
systemalsochecksfor violations of such practices.
â€¢We implement a tool, PhysFrame , and evaluate it on 180 ROS
projects from Github. It reports 190 type inconsistencies with
154truepositives(81.05%).Wereport52fromprojectsthatare
recently active to developers and have received 18 responses
so far, with 15 fixed/confirmed. It also detects 45 violations of
common practices.
2 REFERENCE FRAMESAND ROS
2.1 Frames
Acoordinatesystemthatisusedasareferenceformeasurementsof
quantitiessuchaspositionandvelocityiscalleda frameofreference ,
in short,a frame.It isdefined by two components: an origin point
andtheaxessystem.Aroboticsystemoftenconsistsofmanyparts,
eachhavingatleasta bodyframe withtheoriginatthecenterof
therigidshapeofthepart,andaxespointingtosomeorthogonal
directions.Itallowsmeasurementsintheperspectiveofthepart.
Thebodyframeforthebaseofarobotisoftencalled base_link .It
is one of the most important frames in a robot as measurements in
thisframedescribehowtherobotasawholeseestheworld.The
bodyframeforacameraiscalledthe cameraframe .Ifthepartis
asensor,itoftenhasotherframestodenotesensorreadings.For
example,acamerahasmultiple opticalframes ,includingthe color
framemeasuring RGB format image, the depth frame measuring
depth image, and the ir framemeasuring infra red image. These
framesarecenteredatthecorrespondingsensors(e.g.,lens)instead
ofthe camera body.They are differentfrom the camera frame.
Therearealsothe odometry(odom)frame ,themapframe ,and
theearth frame to denote the physical world, i.e., how the world
sees the robot and its surroundings. The odomframe represents
robotâ€™s initial pose and does not move with the robot. It is like a
thirdpersonstandingattherobotâ€™sstartingpositionandobserving
themotionofrobotintheenvironment.The mapframeprojects
everythinginalocalizedmapsuchasinsidearoom.Itislikeathird
person standingsomewhereintheroom (notthestartingpoint of
the robot) and observing the robot and its environment. The earth
frameisan earthcenteredframe.
During operation, sensor readings are acquired regarding the
corresponding sensor frames. They are then transformed to the
body frames of the parts where the sensors are installed, and even-
tually to the base_link frame and some world frame(s) in which
controlalgorithmsusethetransformedvaluestocomputeactuation
signals. These signals may undergo the inverse transformations
untiltheyreachtheactuators.Asimplecommodityrobotmayhave
46PhysFrame : Type CheckingPhysical Frames of Reference forRoboticSystems ESEC/FSE â€™21, August 23â€“28, 2021,Athens,Greece
Figure 2:Frames inaSimple Robot
up to 81 different frames [ 35] as shown in Figure 7 in Appendix
in[19]andvalueshavetobecorrectlytransformedbetweenany
pairofframes.Itisaheavyburdenfordeveloperstogetallthese
transformations right.
Figure2showsasimplerobot.Observethateachofitspartshas
itsownbodyframe(e.g., camera_link ,laser,andbase_link ).There
are also the world frames such as odomandmap. Suppose if the
vehicle locates an obstacle, then it knows the obstacleâ€™s position
inthecamera_depth_optical frame.Thispositionisdifferentfrom
thepositionoftheobstacleinthe mapframe.Inordertoanswer
the question Å‚what is the position of an obstacle in the room?",
thevehicleneedstoknowhowthe camera_depth_optical frameis
positioned and oriented relative to the base_link frame and how
thebase_link frameispositionedandorientedrelativetothe map
frame, then has to convert the obstacle position from the camera_-
depth_optical frame all the way to the mapframe. Moreover, the
position of the obstacle in the frame of front right wheel, front_-
right_wheel , is different from that in the base_link frame. Hence,
to know the position with respect to the front right wheel, the
vehicle needs to know the position and orientation of front_right_-
wheelframe relative to the base_link frame. Different body frames
may have different axis orientation conventions. Figure 2presents
two axis orientations labeled as F1 and F2. Each part has a default
forward-facingdirection(e.g.,thenoseofanaerialrobotandthe
frontofacamera),thevalues forward,backward,left,right ,etc.,are
definedregardingthedefaultdirection.F1andF2arewidelyused
inROS.Moreover,variouslibrariesusedifferentconventions.For
example, (x: right, y: up, z: backward) axis orientation is widely
usedinOpenGL.
2.2 ROSandFrames
The Robotic OperatingSystem (ROS)[ 32]isan open source soft-
ware framework for building robotic applications. Its modular, dis-
tributed nature has made it widely used. Its users range from a
novice developer working on a hobby project to industries. ROS
providesvariouscomponentssuchasdrivers,localizationpackages,
odometer packages developed by the community in addition to the
corecomponents.Itprovidesapackagecalled tfortf2[14,36]to
support transformation between frames.
ROS Transforms. Tospecifyframesandtransformations,devel-
opersleveragethe tflibrarytoexplicitlypublishtransformationsbetween frames (called transforms inROS), which alsoimplicitly
introducetheframes.Atransformconsistsofaparentframeand
achildframe,uniquelyidentifiedbytheirids.ROSdevelopersof-
ten say a transform is from the parent to the child. For example
Å‚mapâ†’odomÅ¾ means a transform from the mapframe to the odom
frame. It is defined by providing the displacements of the child
frameâ€™s origin and the rotation of its axes regarding the parent
frame. However, the transform is used to translate states in the child
frametotheparentframe (nottheotherwaysuggestedbyitsname).
WeunfortunatelyhavetoinheritsuchtermambiguityfromROS.
In the rest of the paper, we explicitly distinguish the name of a
transform andits use instate translation to avoid confusion.
After transforms are published, other ROS components, such as
standardcontrolalgorithms,subscribetothesetransformsbased
on their names and use them in computation without knowing
how they are implemented. Hence, these core algorithms can be
agnostic to concrete systemcomposition.
Launch Files. Many parts have fixed and static relative positions,
e.g., camera mounted at a fixed position of an aerial robot. The
transformsbetweentheirframescanbestaticallydefinedin launch
files,whichareakindofstaticinitializationfilesthatdefinehow
to start executing a robotic system. The transforms for frames
with dynamic relative positions, e.g., when a camera is mounted
ona gimbal,have to be publishedand updatedon-the-fly during
operation.Theyarehenceimplementedbycode.Anexamplelaunch
file snippetcan be foundinAppendix A in[ 19].
TF Tree. Transformsare potentiallyneededinbetweeneachpair
offrames. However,specifying/implementingtransformsforeach
pair entails substantial and error-prone efforts. ROS has a clean
hierarchicaldesigntoreducethecomplexity.Ifweconsideraframe
as a node and a transform between two frames as an edge, ROS
requires all published frames and transforms to form a tree, that
is, no cycles and each node having only one parent. We call it a
TF tree. As such, the developer only needs to focus on realizing
the transforms denoting individual edges. ROS then automatically
constructs the transform from an arbitrary frame ğ‘“1to another
arbitraryframe ğ‘“2,byfirstperformingthetransformsfrom ğ‘“1tothe
lowest common ancestor frame of the two, and then the transform
from the ancestor to ğ‘“2. It can be easily inferred that such a design
substantially reduces the developersâ€™ burden. The below figure
shows the TF tree for the robot in Figure 2. Observe that while
the developers only need to develop and publish 12 transforms
(denoted by the edges), ROS allows 156 transforms from a frame
to anyother frame. The red edges form a transformpath between
front_right_wheel tocamera_depth_optical ,whentherightwheel
onthe front ofthe robot uses data from the camera depthsensor.
2.3 Frame Conventionsin ROS
All ROS projects follow certain conventions when manipulating
frames. Violation to these conventions would cause integration,
maintenance,andreuseproblems.Ourtechniqueleveragesthese
conventionstoautomaticallyinferandcheckframetypes.There
are two sources for extracting conventions: ROS specification and
47ESEC/FSE â€™21, August 23â€“28, 2021,Athens,Greece S.Kate, M. Chinn, H.Choi, X.Zhang,S.Elbaum
launchfiles.Theformerisexplicitandthelatterisimplicit.Since
ROS conventions are often related to static coefficients values (e.g.,
orthogonal axesorientations),theyare difficultto extractdirectly
from code where coefficients are largely variables.
ExplicitConventionsFromROSSpecifications. Theseconven-
tionscan be classifiedintothe following three categories.
NamingConventions. ROSapplicationsusemessagestoexchange
data between components. The frame_id field in a message speci-
fiestheframeforthedatainthatmessage.Theseidsfollowcertain
conventions. For example, Å‚ mapÅ¾ is used for the map frame [ 27],
and Å‚base_link Å¾ for the body frame of the robotâ€™s base [ 27,28];
optical framesshould have an Å‚ _optical Å¾suffix[15].
AxisOrientationConventions. Accordingto[ 15],bodyframesshould
havethe(x:forward,y:left,z:up)orFLUaxisorientation(i.e.,F1
orientation in Figure 2); optical frames should have the (x: right, y:
down,z:forward)orientation(i.e.,F2 inFigure 2).
TreeOrderConventions. Recallthatinaroboticsystem,thepublished
frames and transforms are organized in a TF tree. ROS requires TF
treesfollowapartialorder: earthâ†’mapâ†’odomâ†’base_link [27].
Note that while a concrete TF tree for a specific robotic system
mayomitsomeoftheseframesandhaveadditionalframes,such
an order must be respected. The reason is that the order optimizes
the performance for mostly commonly seen transforms.
Implicit Conventions from ROS Launch Files. Launch files
provide a rich resource for mining implicit conventions. We fo-
cusonextracting twokindsofimplicitconventions.
Co-occurrenceConventions. Roboticsystemsofasamekindshare
similarityintheirphysicalcompositions.Assuch,theyoftenuse
similarframesandtransforms.Thisisreflectedbyco-occurrences
oftransforms inlaunchfiles.For example,agroundvehiclerobot
withtwowheelshasonewheelonitsleftandtheotherwheelon
its right. If a transform from base_link to the frame of left wheel
is defined, then a transform from base_link to the frame of right
wheel isalsodefined.
Value Conventions. Certain transforms are associated with fixed
coefficientvaluessuchas0rotationanglesor0displacementvalues.
For example, a transform from camera_depth tocamera_depth_-
opticalmusthave 0displacementvalues.
3 MOTIVATION
Tomotivateourtechniqueweusecodefromthe simultaneouslo-
calization and mapping (SLAM) component ORB2-SLAM2 (links
inthecaptionofFigure 3)[3,29].Localizationandmappingalgo-
rithms like ORB are key to the operation of modern mobile robots,
incrementallybuildingamapoftherobotsurroundingsutilizing
itscameraastherobotnavigates.Thiscomponent,however,uses
differentconventionsfromROSandhencethemostimportanttask
for interfacingthen isto perform appropriate frameconversions.
ThecodesnippetinFigure 3aimstoimplementatransformto
facilitate translation of states from the ROS cameraframe to the
ROSmapframe using the environment model of ORB-SLAM2. The
conversion implementation, however, is incorrect, and PhysFrame
catchesthis errorbytype checking.
Constructingtheaforementionedtransformisnon-trivial,and
consists of three groups of operations. First, given some ROS state
inthechild cameraframewiththeconventionalFLUorientation,it
Figure 3:Example ofincorrect transformbetween frames
source: https://git.io/JtSHb,fixed source: https://git.io/JtSRt
should be translated into ORBâ€™s RDF orientation, (x:right, y:down,
z:forward). Second, the position of the cameraframe in the map
frameneedstobedetermined.However,sinceORB-SLAM2mod-
elstheenvironmentinthe cameraframe,onecanonlyquerythe
position of mapframe in the cameraframe, so it needs to be trans-
posed to acquire the position of cameraframe in the mapframe.
Third,thetransformshouldtranslatetheresultsbacktoROSâ€™sFLU
orientation.The code shownfails to accomplishthe last step.
Function PublishPositionAsTransform() starting at line 27
takes the ORB-SLAM2â€™s position matrix (denoting the mapframeâ€™s
position in the cameraframe), i.e., variable position , and con-
structs a ROS transform (line 28) by invoking TransformFrom-
Mat(),whichstartsatline1.Inline4itacquirestherotationmatrix
fromtheORB-SLAM2â€™spositionmatrix,whichincludesbothdis-
placementsandrotation,andperformstranspositionbyfunction
t(). Line 6 clones it to tf_camera_rotation . Line 10 creates a
matrix denoting rotation of an FLU axis system anti clockwise
for 90 degree with respect to the ğ‘¥axis (shown to the right of
thecode).Lines13and17createtwoadditionalrotationmatrices.
Lines 20-23 compose the three matrices and the earlier rotation
matrix. Line 25 creates a ROS transform from displacements de-
noted by tf_camera_translation and rotation denoted by tf_-
camera_rotation .Whenthetransformisusedinstatetranslation,
a state is multiplied with tf_camera_rotation , which equals to
invYZ*Rz*Rx*rotation .Thefirstthreematrixesareequivalentto
transformingtheFLUorientationofthestatetotheRDForienta-
tionasshownontherightofline25.Thefourthmatrix( rotation )
thentranslatesthestatefromthecameraframetothemapframe.
However, the constructed transform is problematic as it forgets
tofurthertranslatebacktoFLU.Thisbugwillcausedownstream
system mis-behaviors, which could be devastating if the camera
48PhysFrame : Type CheckingPhysical Frames of Reference forRoboticSystems ESEC/FSE â€™21, August 23â€“28, 2021,Athens,Greece
Figure 4:Overview of PhysFrame
readingsarethedominantsourceforcontroldecisions.Itisfixed
by appending the inverse rotation matrices of invYZ,Rz, andRxto
tf_camera_rotation after line23, to changeRDF to FLU.
PhysFrame associateseachstatevariablewithaframetypethat
abstracts both the displacements and orientation of the frame in
itsparentframe.Italsoassociateseachtransformvariablewitha
transformtypethatdenotesthedisplacementsandrotationneeded
inframe translation.It propagates such types following operation
semanticsandchecksconsistency.Intheexamplecode,itassociates
matrixRxatline10withatransformtypefromtheFLUorientation
ğ´totheorientation ğµ.Thetypeisderivedfromtheconstantmatrix
values.Itfurtherassociatesmatrix Rzatline13withatransform
type from FLU to the orientation ğ¶; andinvYZat line 17 from FLU
toğ·. By modeling the semantics of matrix multiplications at lines
20, 21, and 23, it determines that the transform at line 25 has the
type from FLU to RDF. This yields a type error at lines 30-31 when
the transform is published by function sendTransform() because
ROS convention demands both camera frame and map frame to
have FLU,whereas the transform convertsFLUto RDF.
Observethatitisdifficulttogetsuchtransformationrightdueto
its intrinsic subtlety and complexity. While this is only a one-step
transform, as mentioned earlier, a non-trivial robotic system has
more than 80 different frames and transforms between any pair
maybenecessary.Theexamplebugisjustoneofthemanykindsof
bugsPhysFrame detects.Othersincludemissingframeandbroken
TF tree.More discussioncan be foundinSection 4.2.3.
4 OURAPPROACH
4.1 Overview
Figure4presents an overview of PhysFrame . It takes as input a
C++ROSproject,andoutputsframeinconsistenciesandimplicit
conventionviolations. PhysFrame consistsofthreecomponents:
implicit convention miner ,file-processor ,andtypechecker .
Theminertakesadatabaseof statictransformsextractedfrom
the launch files of a large repository of over 2200 mature ROS
projectsfromGithubandperformsdataminingtoinferimplicitcon-
ventions. The miner identifies frequent static patterns that include
pair of transforms that commonly co-exist in a project, transforms
commonlyhavingzerodisplacements,andtransformscommonly
havingzerorotation.Sincethesepatternsmayhappencoinciden-
tally, the miner computes a frequency for each pattern to quantify
itscertainty(weusez-score[ 13]asafrequencymeasure)andre-
ports it if it is above a specified z-score threshold. The mining
process is executed once on the collected static transform data-
base, but can be updated as new static transforms are incorporatedinto the database. The produced rule conventions are then used in
theanalysisforeachsubjectROSprojecttoidentifyanti-patterns.
Details can be foundinAppendix Bin[ 19].
A ROS project often contains multiple executable subsystems,
each having its own TF-tree. PhysFrame has to analyze these sub-
systemsoneatatime.Thefile-processorseparatesaprojectinto
subsystems,eachconsistingofagroupofC/C++sourcefilesand
launch files that are executed together. A subsystem usually has
aseparateinitiallaunchfile.Thefile-processorhencestartsfrom
these top level launch files, identifies the child launch files and
the corresponding CMakeLists files, which indicate the source files
involvedineachsubsystem,andinturnfindsfile groupsthatrep-
resent the projectâ€™s subsystems.Details are elided.
Thetypecheckerthentakespatternsandfilegroupsinformation,
togetherwithprojectfiles,andtypesvariablesandstatementsin
theC/C++sourcefiles.Typeerrorsarereportedwhentheprogram
cannotbeproperlytyped. PhysFrame reports7kindsoftypeerrors
and 2 kinds of type warnings as inconsistencies, and reports 3
kinds of implicit convention violation warnings (see Section 4.2.3).
Warningsmaynotleadtobrokenfunctionalitiesbutproblemsin
code maintenance and reuse. In the following, we will focus on
explainingthe type system.
4.2 TypeSystem
Before introducing the formal language and type rules, we intu-
itively explain how frames and transforms are used. Typically, one-
steptransformobjectsareexplicitlycreatedtofacilitatetranslation
of states in a child frame (e.g., position) to a parent frame. A trans-
form specifies the relative position and orientations of the child
frame in the parent frame, denoted by displacements and rotations.
Italsospecifiesthe(string)idsforthechildandparentframes.Anid
istheuniquerepresentationofaframe.Thecreationsoftransforms
also implicitly define frames (through the ids). They are implicit as
therearenoexplicitROSdatastructuresforframes.Astatevariable
can be explicitly associated with some frame id, yielding a stamped
(aROSterm)statevariable.Atransformcanbeexplicitlyappliedto
somestampedvariable(inachildframe)toacquireitscorrespon-
denceintheparentframe.One-steptransformscanbepublished
andhencebecomepartoftheglobalTFtree.Assuch,transforms
betweenarbitraryframes(e.g.,thosemultiplestepsapart)canbe
automaticallyconstructedbytraversingthetree(Section 2.2).To
define a one-step transform, developers often explicitly specify the
entailed rotation. A rotation can be composed from others. For
example,a60degreerotationcanbecomposedfromtwo30degree
rotations. Plain state variables (not stamped) can be operated on
just like regular C/C++ variables/data-structures. As such, even
they (implicitly) belong to some frames, frame inconsistencies can-
not be detected. Furthermore, ROS does not provide type checking
mechanism even for stamped variables. The C/C++ type system
cannot offer help either as it does not have any domain knowledge.
Forexample,itcantypeavariabletoaROStransformdatastruc-
ture but cannot identify the specific transform type, i.e., the parent
andchildframesandthe displacementsandrotation involved.
4.2.1 A Simplified Language and Types. ROS is based on C/C++
with a set of library functions. While our type system supports the
complex syntax of C/C++/ROS and models the frame related APIs,
49ESEC/FSE â€™21, August 23â€“28, 2021,Athens,Greece S.Kate, M. Chinn, H.Choi, X.Zhang,S.Elbaum
weuseasimplifiedlanguage fordiscussionbrevity.Thelanguage
focuses on modeling frame related semantics and ignores the stan-
dard C/C++ types, operations and statements. It directly models
anumberofROS tfAPIsaslanguageprimitives.Moreover,since
ouranalysisisflowinsensitive,controlstructurelikeconditional
statements andloopsare less relevantandhence not modeled.
Types.We define three types: (1) frame type ( Frame) that repre-
sentstheframeinformationofastatevariable,(2)transformtype
(Transform ) that represents frame transforms, and (3) rotation type
(ğ‘…ğ‘œğ‘¡ğ‘ğ‘¡ğ‘–ğ‘œğ‘›)thatrepresentschangesintheaxesâ€™directions.Notethat
theseare not ROS types, but rathertypes in PhysFrame .
Frame Type. This is an abstract type and always used with some
concrete state type such as PointandPose, indicating points and
poses in a specific frame, respectively. For example, ROS uses
tf::Stamped<T>(T x, ..., String id) todenotea Ttypestate
objectassociatedwithaframeidentifiedby id.Theframetypeâ€™s
definitionisas follows.
ğ¹ğ‘Ÿğ‘ğ‘šğ‘’::=<ğ‘–ğ‘‘,ğ‘ğ‘–ğ‘‘,ğ‘¥,ğ‘¦,ğ‘§,ğ‘‘ ğ‘¥,ğ‘‘ğ‘¦,ğ‘‘ğ‘§> (1)
Itiscomposedofeightfields: ğ‘–ğ‘‘denotingthe(string)nameofframe,
ğ‘ğ‘–ğ‘‘thenameofitsparentframetype;thenextthreefields, ğ‘¥,ğ‘¦,ğ‘§,
beingthepositions oftheframeâ€™s originwith respect toitsparent
frame,where theirvaluesare oftype Displacement .
Displacement ::=ğ‘…| âŠ¤ (2)
where,ğ‘…isastaticnumericalvalue,and âŠ¤representsavalueun-
knownstatically.Thenextthreefields, ğ‘‘ğ‘¥,ğ‘‘ğ‘¦,ğ‘‘ğ‘§,encodethe ğ‘¥,ğ‘¦,ğ‘§
axesorientations ofaframe,withvaluesofthe Orientation type:
Orientation ={left,right,up,down, forward, backward }
They denote the (orthogonal) orientations of axes regarding the
bodypartcorrespondingtotheframe .Theyareindependentofthe
placementofthebodypartregardingitsbase.Forexample,although
acameramaybeinstalledwitharbitrary(andevendynamic)angles
regardingarobotâ€™sbody,theorientationofthecameraframeâ€™saxes
isforward-left-up (FLU), which is orthogonal regarding the camera.
Althoughaxesorientationsareorthogonal,differentcomponents
and robotic frameworks have different orientation conventions,
transformations needto be explicitly performedbydevelopers.
Transform Type. ROS allows developers to create transform objects
that denote transformation from a frame to another (e.g., using the
tt::Transformer class). We associate such objects with a trans-
formtypethatabstractsinformationtofacilitateconsistencyand
convention checks.The transform type isdefinedas follows.
ğ‘‡ğ‘Ÿğ‘ğ‘›ğ‘ ğ‘“ğ‘œğ‘Ÿğ‘š ::=<cid,pid,ğ‘¥,ğ‘¦,ğ‘§,ğœ ğ‘Ÿ> (3)
Here,ğ‘ğ‘–ğ‘‘andğ‘ğ‘–ğ‘‘arethechildandparentframeids,respectively,
ğ‘¥,ğ‘¦,ğ‘§areabstract valuesofthe aforementioned Displacement type,
andğœğ‘Ÿdenotesanabstractrotation,whichwillbeexplainednext.
The displacementsandrotation togetherdefineatransformation.
Rotation Type. Rotations change axes orientations of a frame. ROS
allowscreationoffirst-orderrotationobjects(e.g.,throughtheROS
tt::Transform class) and manipulations of these objects. They
canbefurtherusedtoconstructtransformobjects.Inthiswork,we
are interested in orthogonal rotations such as those with 90 or 180
degreesastheyareusedinchangingaxesorientations.WehenceâŸ¨ğ‘ƒğ‘Ÿğ‘œğ‘”ğ‘Ÿğ‘ğ‘š âŸ©ğ‘ƒ/Colonequalğ‘†
âŸ¨ğ‘†ğ‘¡ğ‘ğ‘¡ğ‘’ğ‘šğ‘’ğ‘›ğ‘¡ âŸ©ğ‘†/Colonequalğ‘†1;ğ‘†2|ğ‘¥:=ğ‘£|ğ‘¥:=ğ‘¦|ğ‘¥:=ğ‘¦opğ‘§|
fx:=stamped(ğ‘ ,ğ‘¥)|fx.id:=ğ‘ |
ğ‘¥:=get_data (fx)|fx:=fy|fx:=external ()|
fx:=transform_to (ğ‘ ,fy)|
tx:=new_transform (ğ‘ ğ‘â„ğ‘‘,ğ‘ ğ‘ğ‘›ğ‘¡,ğ‘¥,ğ‘¦,ğ‘§,rx)|
sendTransform (tx)|
tx:=lookupTransform (ğ‘ ğ‘ğ‘›ğ‘¡,ğ‘ ğ‘â„ğ‘‘)|
fx:=apply_transform (tx,fy)|rx:=ğ‘£3Ã—3|
rx:=ğ‘¥|rx:=ryâŠ—rz|publish (ğ‘ ğ‘¡ğ‘œğ‘ğ‘–ğ‘,fx)
<ğ‘†ğ‘¡ğ‘ğ‘¡ğ‘’ğ‘‰ğ‘ğ‘Ÿ > ğ‘¥,ğ‘¦,ğ‘§
<ğ‘†ğ‘¡ğ‘ğ‘šğ‘ğ‘’ğ‘‘ğ‘†ğ‘¡ğ‘ğ‘¡ğ‘’ğ‘‰ğ‘ğ‘Ÿ >fx,fy,fz
<ğ‘‡ğ‘Ÿğ‘ğ‘›ğ‘ ğ‘“ğ‘œğ‘Ÿğ‘šğ‘‰ğ‘ğ‘Ÿ >tx,ty,tz
<ğ‘…ğ‘œğ‘¡ğ‘ğ‘¡ğ‘–ğ‘œğ‘›ğ‘‰ğ‘ğ‘Ÿ > rx,ry,rz
<ğ¶ğ‘œğ‘›ğ‘ ğ‘¡ğ‘‰ğ‘’ğ‘ğ‘¡ğ‘œğ‘Ÿ > ğ‘£
<ğ¶ğ‘œğ‘›ğ‘ ğ‘¡ğ‘†ğ‘¡ğ‘Ÿğ‘–ğ‘›ğ‘” > ğ‘ 
Figure 5:Language
definerotation type as follows.
ğ‘…ğ‘œğ‘¡ğ‘ğ‘¡ğ‘–ğ‘œğ‘› ::=<ğ‘‘ğ‘ ğ‘¥,ğ‘‘ğ‘ ğ‘¦,ğ‘‘ğ‘ ğ‘§>| âŠ¤ (4)
The three fields, ğ‘‘ğ‘ ğ‘¥,ğ‘‘ğ‘ ğ‘¦,ğ‘‘ğ‘ ğ‘§are variables of DirSwitch type:
DirSwitch ={Å‚ğ‘¥â€,Å‚âˆ’ğ‘¥â€,Å‚ğ‘¦â€,Å‚âˆ’ğ‘¦â€,Å‚ğ‘§â€,Å‚âˆ’ğ‘§â€,âŠ¤}
Fieldğ‘‘ğ‘ ğ‘¥holds a value indicating that the axis denoted by the
value points in the same direction as the previous ğ‘¥axis (i.e., the ğ‘¥
axis before rotation). Fields ğ‘‘ğ‘ ğ‘¦andğ‘‘ğ‘ ğ‘§work in a similar way. We
use the following example to explain the semantics. Let <Å‚ğ‘§â€,Å‚âˆ’
ğ‘¥â€,Å‚âˆ’ğ‘¦â€>be aRotationtype. It switches orientations of axes
such that ğ‘§axis points in the same direction as the previous ğ‘¥axisâ€™
direction, âˆ’ğ‘¥axis points in the same direction as the previous ğ‘¦
axisâ€™direction(i.e.,thecurrent ğ‘¥axisistheoppositeoftheprevious
ğ‘¦axis), and âˆ’ğ‘¦points in the same direction as the previous ğ‘§axisâ€™
direction. Assumea variableofframetype <..., forward, left, up >.
After applying the aforementioned rotation, a new frame type <
...,right,down, forward >is derived. Value âŠ¤means the rotation is
not orthogonalorcannotbe determinedstatically.
Language. Figure5presents the language. We call all ROS state
variables StateVar, such as tf::Point andtf::Pose . State vari-
ables are frame agnostic. When they are explicitly associated with
someframe,theybecome StampedStateVar1,correspondingto tf::
StampedâŸ¨PointâŸ©andtf::Stamped âŸ¨PoseâŸ©,etc.inROS.Weuse ğ‘¥,ğ‘¦,ğ‘§
forStateVarandfx,fy,fzforStampedStateVar .Wealsousevariables
tx,ty,tzandrx,ry,rzto denote transform and rotation variables.
Notethatthesevariablesarenottyped.Theirtypeswillberesolved
byourtyperules.Wedistinguishdifferentkindsofvariablesjust
for betterreadability.
Statement Å‚ ğ‘¥:=ğ‘£Å¾ denotes a state variable assignment using
a constant vector. A scalar variable can be considered as a vec-
tor variable with one dimension. Function stamped () explicitly
associates ğ‘¥with a frame denoted by a string ğ‘ , corresponding
totf::Stamped âŸ¨TâŸ©::Stamped() in ROS. ROS allows stamping a
state variable with an empty id and later explicitly setting the id
fieldofthestampedvariable.Acommonerroristhatthedeveloper
stampsanemptyframeandlaterforgetstosettheframe.Statement
Å‚fx.id:=ğ‘ Å¾ models the set frame operation. Function get_data()
retrieves the plain state from a stamped state variable. Function
external() modelsthesituationswherestampedstatevariablesare
1ROS uses the term Å‚ stampedÅ¾ to denote that a variable is contextualized with a frame.
Wehence useasimilartermhere.
50PhysFrame : Type CheckingPhysical Frames of Reference forRoboticSystems ESEC/FSE â€™21, August 23â€“28, 2021,Athens,Greece
publishedbylibraries without sourcecodeand hencebeyondour
analysis. Function transform_to() transforms fyto a target frame
denoted by ğ‘ , yielding a new stamped variable fx. It corresponds
to ROS functions such as tf::Transformer::transformPoint() .
Function new_transform() createsaone-steptransformobjectfor
translatingstatesinthechildframetotheircorrespondencesinthe
parent frame. It specifies the parent and child frame ids ( by ğ‘ ğ‘ğ‘›ğ‘¡
andğ‘ ğ‘â„ğ‘‘,respectively),thedisplacements(bystatevariables ğ‘¥,ğ‘¦,ğ‘§),
and the rotation (by ğ‘Ÿğ‘¥). The displacements and rotation specify
the linear and angular positions of the child frame with respect
to the parentframe. This primitive correspondsto creating a ROS
tf::StampedTransform object. One-step transforms can be pub-
lishedbyfunction sendTranform() suchthattheybecome edges
of the TF tree (Section 2.2). Function lookupTransform() finds a
transformfromframe ğ‘ ğ‘ğ‘›ğ‘¡toframeğ‘ ğ‘â„ğ‘‘.Thesetwoframesmaynot
correspond to any publishedone-step geometric transforms. Recall
that ROS automatically constructs a transform by finding a path
fromğ‘ ğ‘ğ‘›ğ‘¡to the lowest common ancestor (in the TF tree) and then
toğ‘ ğ‘â„ğ‘‘. It corresponds to tf::Transfomer::lookupTransform() .
Function apply_transform() appliesa transform txto a stamped
variablefy.Assuch, fymusthavethechildframetypeof txandfx
havetheparentframetypeof tx.StatementÅ‚ rx:=ğ‘£3Ã—3Å¾specifies
a constant rotation by a 3 times 3 matrix. One can also specify a
dynamic rotation from a (matrix/vector) variable. Two rotations
can be aggregated to one by matrix multiplication âŠ—. A stamped
variablecanbepublishedtoatopic.Any(remote)subscribesofthe
topicwillreceivethe value.As such,the variableâ€™sframemust be
properly set.Otherwise,remoteparties cannotmake sense ofit.
WhilePhysFrame supportsconditionals,loops,functions,and
otherframerelatedROS APIs. They are elidedfrom our language.
4.2.2 TypeRules. Table1presentsthetyperules.Theserulesinfer
typesfor statevariablesand frame related variablesand check for
any inconsistencies, that is, variables cannot be properly typed,
e.g., a variable having more than one types following the rules.
Weusemeta-variables ğœ,ğœğ‘¡,andğœğ‘Ÿtorangeovertheinfinitesets
ofFrame,Transform , andRotationtypes. In our rules, a variable
ğ‘¥:ğœmeansthat ğ‘¥hasğœtype.Astatement ğ‘¥:=...:ğœmeansthat
the statement has ğœtype, which is equivalent to the left-hand-side
variableğ‘¥havingğœtypeaswell.Ingeneral,aruleisreadasfollows:
ifthepremisesaresatisfied(e.g.,typechecked),theconclusionsare
yielded.The rulesare driven bythe syntax ofthe language.
Data Assignment Rules. Ruleğ‘…1specifies that for a copy statement,
if the right-hand-side is typed to ğœ, the left-hand-side is typed to ğœ
aswell.Rule ğ‘…2requiresthatinabinaryoperationofstatevariables,
the two operands must have the same type ğœ. Then we conclude
theresultofthestatementhasthesametype.Rule ğ‘…3specifiesthat
ifğ‘¥is typed to ğœ, which has the ğ‘ as the frame id, we can conclude
fxhas the same type ğœ. Note that type inference is flow-insensitive,
ifğ‘¥was free (i.e.,untyped), the rule types it to ğœ. Ruleğ‘…4types an
explicitsetframestatementtothetypedenotedbytheidstring ğ‘ .
Ruleğ‘…5specifiesthatifastatevariable ğ‘¥isacquiredfromastamped
variablefx,ğ‘¥inherits the type of fx. Ruleğ‘…6specifies two stamped
variables inacopy statementmusthave the same type.
Transformation-related Rules. Ruleğ‘…7types a transformation state-
ment.Specifically,themeaningoffunction reachable ()isdefined
in Figure 6. It asserts that there is a direct/indirect transform fromreachable (ğ‘ 1,ğ‘ 2):ğ‘ 1andğ‘ 2share some common ancestor in the TF tree
and hence reachable from eachother
disp(ğ‘¥) =/braceleftBiggğ‘Ÿ ğ‘¥holdsa constant ğ‘Ÿâˆˆğ‘…after
constantpropagation
âŠ¤otherwise
rotate(<ğ‘‘ğ‘¥,ğ‘‘ğ‘¦,ğ‘‘ğ‘§>,<ğ‘‘ğ‘ ğ‘¥,ğ‘‘ğ‘ ğ‘¦,ğ‘‘ğ‘ ğ‘§>)=<ğ‘›ğ‘¥,ğ‘›ğ‘¦,ğ‘›ğ‘§>, with
ğ‘›ğ‘¥=ï£±ï£´ï£´ï£´ï£´ï£´ï£´ï£´ï£´ ï£²
ï£´ï£´ï£´ï£´ï£´ï£´ï£´ï£´ï£³ğ‘‘ğ‘¥ ğ‘‘ğ‘ ğ‘¥=Å‚ğ‘¥â€
ğ‘œğ‘ğ‘ğ‘œğ‘ ğ‘–ğ‘¡ğ‘’ (ğ‘‘ğ‘¥)ğ‘‘ğ‘ ğ‘¥=Å‚âˆ’ğ‘¥â€
ğ‘‘ğ‘¦ ğ‘‘ğ‘ ğ‘¦=Å‚ğ‘¥â€
ğ‘œğ‘ğ‘ğ‘œğ‘ ğ‘–ğ‘¡ğ‘’ (ğ‘‘ğ‘¦)ğ‘‘ğ‘ ğ‘¦=Å‚âˆ’ğ‘¥â€
ğ‘‘ğ‘§ ğ‘‘ğ‘ ğ‘§=Å‚ğ‘¥â€
ğ‘œğ‘ğ‘ğ‘œğ‘ ğ‘–ğ‘¡ğ‘’ (ğ‘‘ğ‘§)ğ‘‘ğ‘ ğ‘§=Å‚âˆ’ğ‘¥â€
âŠ¤ otherwiseğ‘›ğ‘¦=...,ğ‘›ğ‘§=...
tree_form_with_edge(ğ‘ 1,ğ‘ 2): addingannewedge denoted by
ğ‘ 1â†’ğ‘ 2doesnot break the TFtreeform
orthogonalize (ğ‘£3Ã—3)=/braceleftBiggâŠ¤ ğ‘‘ğ‘ ğ‘¥=âŠ¤âˆ¨ğ‘‘ğ‘ ğ‘¦=âŠ¤âˆ¨
ğ‘‘ğ‘ ğ‘§=âŠ¤
âŸ¨ğ‘‘ğ‘ ğ‘¥,ğ‘‘ğ‘ ğ‘¦,ğ‘‘ğ‘ ğ‘§âŸ©otherwise
ğ‘‘ğ‘ ğ‘¥=ï£±ï£´ï£´ï£´ï£´ï£´ï£´ï£´ï£´ ï£²
ï£´ï£´ï£´ï£´ï£´ï£´ï£´ï£´ï£³Å‚ğ‘¥â€ğ‘£1=[1,0,0]
Å‚âˆ’ğ‘¥â€ğ‘£1=[âˆ’1,0,0]
Å‚ğ‘¦â€ğ‘£1=[0,1,0]
Å‚âˆ’ğ‘¦â€ğ‘£1=[0,âˆ’1,0]
Å‚ğ‘§â€ğ‘£1=[0,0,1]
Å‚âˆ’ğ‘§â€ğ‘£1=[0,0,âˆ’1]
âŠ¤ otherwiseğ‘‘ğ‘ ğ‘¦=... ğ‘‘ğ‘ ğ‘§=...
compose(âŸ¨ğ‘‘ğ‘ â€²
ğ‘¥,ğ‘‘ğ‘ â€²
ğ‘¦,ğ‘‘ğ‘ â€²
ğ‘§âŸ©,âŸ¨ğ‘‘ğ‘ â€²â€²
ğ‘¥,ğ‘‘ğ‘ â€²â€²
ğ‘¦,ğ‘‘ğ‘ â€²â€²
ğ‘§âŸ©)=âŸ¨ğ‘‘ğ‘ ğ‘¥,ğ‘‘ğ‘ ğ‘¦,ğ‘‘ğ‘ ğ‘§âŸ©
ğ‘‘ğ‘ ğ‘¥=ï£±ï£´ï£´ï£´ï£´ï£´ï£´ï£´ï£´ ï£²
ï£´ï£´ï£´ï£´ï£´ï£´ï£´ï£´ï£³ğ‘‘ğ‘ â€²â€²
ğ‘¥ğ‘‘ğ‘ â€²
ğ‘¥=Å‚ğ‘¥â€
âˆ’ğ‘‘ğ‘ â€²â€²
ğ‘¥ğ‘‘ğ‘ â€²
ğ‘¥=Å‚âˆ’ğ‘¥â€
ğ‘‘ğ‘ â€²â€²
ğ‘¦ğ‘‘ğ‘ â€²
ğ‘¥=Å‚ğ‘¦â€
âˆ’ğ‘‘ğ‘ â€²â€²
ğ‘¦ğ‘‘ğ‘ â€²
ğ‘¥=Å‚âˆ’ğ‘¦â€
ğ‘‘ğ‘ â€²â€²
ğ‘§ğ‘‘ğ‘ â€²
ğ‘¥=Å‚ğ‘§â€
âˆ’ğ‘‘ğ‘ â€²â€²
ğ‘§ğ‘‘ğ‘ â€²
ğ‘¥=Å‚âˆ’ğ‘§â€
âŠ¤otherwiseğ‘›ğ‘¦=...,ğ‘›ğ‘§=...
Figure 6:Auxiliary functions used intype rules
fyâ€™sframeğœ1totheframe ğœdenotedby ğ‘ .Ifso,weconcludethat fx
hasğœtype. Rule ğ‘…8types a statement that creates a one-step trans-
formfrom <ğ‘ ğ‘â„ğ‘‘,ğ‘ ğ‘ğ‘›ğ‘¡,ğ‘¥,ğ‘¦,ğ‘§,rx>.Itentailstheintroductionofan
implicitframetype ğœğ‘whoseidis ğ‘ ğ‘â„ğ‘‘,parentidis ğ‘ ğ‘ğ‘›ğ‘¡,displace-
ments are those abstracted from ğ‘¥,ğ‘¦,ğ‘§using the disp()function
defined in Figure 6, and axes orientations are resulted from apply-
ing the (abstract) rotation specified by the rotation type ğœğ‘Ÿofrxto
theorientationsoftheparentframe.Function rotateisdefinedin
Figure6.Ittakesa3-dimensionsourceorientation(withvalues left,
right,forward, etc.) and a 3-dimension rotation (with values Å‚ ğ‘¥Å¾,
Å‚-ğ‘¦Å¾, etc.),andproducesaresulted3-dimension targetorientation.
Specifically,theresult ğ‘¥orientation,denotedas ğ‘›ğ‘¥isdeterminedby
searching for which rotationdimension has value of Å‚ ğ‘¥Å¾ or Å‚-ğ‘¥Å¾. If
theğ‘¦rotation has value Å‚ ğ‘¥Å¾, denoted as dsğ‘¦=Å‚ğ‘¥â€,ğ‘›ğ‘¥has the same
orientationastheoriginal ğ‘¦orientation(i.e., ğ‘‘ğ‘¦).IfthevalueisÅ‚- ğ‘¥Å¾,
theorientationisflipped.Anexampleofsuchrotationcanbefound
inthe discussionofrotation type at the end of Section 4.2.1.
Ruleğ‘…9types a statement that publishes a transform tx. It re-
quirestheedge fromtheparentframetothechildframedoesnot
break the TF tree, e.g., by introducing cycles or having multiple
parents for a child. The tree_form_with_edge()function not only
checks the condition but also adds the edge to the TF tree if the
condition is satisfied. Rule ğ‘…10types a statement that looks up
a transform from an arbitrary parent frame to an arbitrary child
frame in the TF tree.The transformmay not be any of the created
one-steptransforms,butratherautomaticallycomposedbyROSby
traversing the tree. It requires reachability between the two frames
(in the tree), which implicitly demands the existence of the two
51ESEC/FSE â€™21, August 23â€“28, 2021,Athens,Greece S.Kate, M. Chinn, H.Choi, X.Zhang,S.Elbaum
Table 1:Type Rules
ğ‘…1ğ‘¦:ğœ
ğ‘¥:=ğ‘¦:ğœğ‘…2ğ‘¦:ğœ ğ‘§:ğœ
ğ‘¥:=ğ‘¦orğ‘§:ğœ
ğ‘…3ğœ.ğ‘–ğ‘‘=ğ‘  ğ‘¥:ğœ
fx:=stamped (ğ‘ ,ğ‘¥):ğœğ‘…4ğœ.ğ‘–ğ‘‘=ğ‘ 
fx.id:=ğ‘ :ğœ
ğ‘…5fx:ğœ
ğ‘¥:=get_data(fx):ğœğ‘…6fy:ğœ
fx:=fy:ğœ
ğ‘…7ğœ.ğ‘–ğ‘‘=ğ‘ reachable (ğœ.ğ‘–ğ‘‘,ğœ1.ğ‘–ğ‘‘)fy:ğœ1
fx:=transform_to (ğ‘ ,fy):ğœ
ğ‘…8rx:ğœğ‘Ÿğœğ‘=âŸ¨ğ‘ ğ‘â„ğ‘‘,ğ‘ ğ‘ğ‘›ğ‘¡,disp(ğ‘¥),disp(ğ‘¦),disp(ğ‘§),ğ‘‘ğ‘¥,ğ‘‘ğ‘¦,ğ‘‘ğ‘§âŸ©
ğ‘ ğ‘â„ğ‘‘!=ğ‘ ğ‘ğ‘›ğ‘¡ğœğ‘.ğ‘–ğ‘‘=ğ‘ ğ‘ğ‘›ğ‘¡
âŸ¨ğ‘‘ğ‘¥,ğ‘‘ğ‘¦,ğ‘‘ğ‘§âŸ©=rotate(âŸ¨ğœğ‘.ğ‘‘ğ‘¥,ğœğ‘.ğ‘‘ğ‘¦,ğœğ‘.ğ‘‘ğ‘§âŸ©,ğœğ‘Ÿ)
tx:=new_transform (ğ‘ ğ‘â„ğ‘‘,ğ‘ ğ‘ğ‘›ğ‘¡,ğ‘¥,ğ‘¦,ğ‘§,rx):
<ğ‘ ğ‘â„ğ‘‘,ğ‘ ğ‘ğ‘›ğ‘¡,disp(ğ‘¥),disp(ğ‘¦),disp(ğ‘§),ğœğ‘Ÿ>
ğ‘…9tx:ğœğ‘¡tree_form_with_edge(ğœğ‘¡.ğ‘ğ‘–ğ‘‘,ğœğ‘¡.ğ‘ğ‘–ğ‘‘)
sendTransform (tx):ğœğ‘¡
ğ‘…10reachable (ğ‘ ğ‘ğ‘›ğ‘¡,ğ‘ ğ‘â„ğ‘‘)ğœğ‘¡.ğ‘ğ‘–ğ‘‘=ğ‘ ğ‘ğ‘›ğ‘¡ğœğ‘¡.ğ‘ğ‘–ğ‘‘=ğ‘ ğ‘â„ğ‘‘
tx:=lookupTransform (ğ‘ ğ‘ğ‘›ğ‘¡,ğ‘ ğ‘â„ğ‘‘):ğœğ‘¡
ğ‘…11tx:ğœğ‘¡fy:ğœ ğœğ‘¡.ğ‘ğ‘–ğ‘‘=ğœâ€².ğ‘–ğ‘‘ ğœğ‘¡.ğ‘ğ‘–ğ‘‘=ğœ.ğ‘–ğ‘‘
fx:=apply_transform (tx,fy):ğœâ€²
ğ‘…12ğœğ‘Ÿ=orthogonalize (ğ‘£3Ã—3)
rx:=ğ‘£3Ã—3:ğœğ‘Ÿ
ğ‘…13rx:=ğ‘¥:âŠ¤
ğ‘…14ğœâ€²
ğ‘Ÿ=âŸ¨ğ‘‘ğ‘ â€²
ğ‘¥,ğ‘‘ğ‘ â€²
ğ‘¦,ğ‘‘ğ‘ â€²
ğ‘§âŸ©ğœâ€²â€²
ğ‘Ÿ=âŸ¨ğ‘‘ğ‘ â€²â€²
ğ‘¥,ğ‘‘ğ‘ â€²â€²
ğ‘¦,ğ‘‘ğ‘ â€²â€²
ğ‘§âŸ©
ry:ğœâ€²ğ‘Ÿrz:ğœâ€²â€²ğ‘Ÿğœr=compose(ğœâ€²ğ‘Ÿ,ğœâ€²â€²ğ‘Ÿ)
rx:=ryâŠ—rz:ğœğ‘Ÿ
ğ‘…15ry:âŸ¨ğ‘‘ğ‘ ğ‘¥,ğ‘‘ğ‘ ğ‘¦,ğ‘‘ğ‘ ğ‘§âŸ©rz:âŠ¤
rx:=ryâŠ—rz:âŸ¨ğ‘‘ğ‘ ğ‘¥,ğ‘‘ğ‘ ğ‘¦,ğ‘‘ğ‘ ğ‘§âŸ©
ğ‘…16fx:ğœ
publish(ğ‘ ğ‘¡ğ‘œğ‘ğ‘–ğ‘,ğ‘“ğ‘¥):ğœ
frames. Rule ğ‘…11specifies that when typing a statement applying a
transform txto astamped variable fy, thetransformâ€™s child frame
mustequalto fyâ€™sframe,anditsparentframeistheresultingframe.
ğ‘…16types a statement that publishes a stamped variable. It re-
quires that the variable isproperly typed.
Rotation-relatedRules. Ruleğ‘…12typesthecreationofarotationfrom
a3Ã—3constantvector.Function orthogonalize ()isusedtoabstract
thevectortothecorresponding DirSwitch abstractvalues.Itsdefini-
tioncanbefoundinFigure 6.Specifically,anorthogonal3 Ã—3vector
is composed of three orthogonal unit vectors, i.e., each row and
each column has only one non-zero element of value 1 or -1. Now,
if we consider that rows 1,2,3 represent initial ğ‘¥,ğ‘¦,ğ‘§orientation
andcolumns 1,2,3 represent then changed ğ‘¥,ğ‘¦,ğ‘§orientation, then
the column position of the non-zero element in a row indicates
theaxisofthechangedorientationthatisthesameastheaxisof
theinitialorientationrepresentedbytherow.Forexample,value
-1 in row 2 and column 1 denotes that the direction of ğ‘¦axis of
initial orientation becomes the direction of âˆ’ğ‘¥axis of the changed
orientation. When the matrix does not denote orthogonal rotation,
the resultedtype is âŠ¤.
Ruleğ‘…13types a rotation creation from a variable (i.e., non-
constant). It usuallycorresponds to angular transformationthat is
neededforstatetranslationacrossframes,butnotfororientation
changes. For example, if a cameracan spin regarding the body, its
readings (regarding the camera frame) have to go through a dy-
namic angular transformation in order to be interpreted regardingTable 2:Type checkingofexample inFigure 3
St#Statement Type Rule
6tf_cam_rotation:=tmp âŠ¤ ğ‘…13
10Rx:=[[1,0,0],[0,0,âˆ’1],[0,1,0]] âŸ¨ğ‘¥,âˆ’ğ‘§,ğ‘¦âŸ© ğ‘…12
13Rz:=[[0,âˆ’1,0],[1,0,0],[0,0,1]] âŸ¨âˆ’ğ‘¦,ğ‘¥,ğ‘§âŸ© ğ‘…12
20tf_cam_rotation:=RxâŠ—tf_cam_rotation âŸ¨ğ‘¥,âˆ’ğ‘§,ğ‘¦âŸ© ğ‘…15
21tf_cam_rotation:=RzâŠ—tf_cam_rotation âŸ¨ğ‘§,ğ‘¥,ğ‘¦âŸ© ğ‘…14
23tf_cam_rotation:=invYZâŠ—... âŸ¨ğ‘§,âˆ’ğ‘¥,âˆ’ğ‘¦âŸ©ğ‘…14
25rtmp:=tf_cam_rotation âŸ¨ğ‘§,âˆ’ğ‘¥,âˆ’ğ‘¦âŸ©
30ttmp:=new_transform (ğ‘ cam,ğ‘ map,...,rtmp)errorbecause
rotate(âŸ¨ğ‘“,ğ‘™,ğ‘¢âŸ©,
âŸ¨ğ‘§,âˆ’ğ‘¥,âˆ’ğ‘¦âŸ©)=
âŸ¨ğ‘Ÿ,ğ‘‘,ğ‘“âŸ©ğ‘…8
the bodyframe. Notethat in this case, theangular transformation
isindependentofframeorientations.Boththecameraandthebody
frameshaveorthogonalorientations.Rule ğ‘…14typesarotationcom-
positionstatement.Itleveragesfunction compose()toderiveanew
rotation type. In thefunction definitioninFigure 6,âŸ¨ğ‘‘ğ‘ â€²ğ‘¥,ğ‘‘ğ‘ â€²ğ‘¦,ğ‘‘ğ‘ â€²ğ‘§âŸ©
andâŸ¨ğ‘‘ğ‘ â€²â€²ğ‘¥,ğ‘‘ğ‘ â€²â€²ğ‘¦,ğ‘‘ğ‘ â€²â€²ğ‘§âŸ©, bothdenotechange in the orientation,where
the formerchange isfollowedby thelatter. Forexample, RzandRx
vectors in our motivating example (Figure 3) represent âŸ¨âˆ’ğ‘¦,ğ‘¥,ğ‘§âŸ©
andâŸ¨ğ‘¥,âˆ’ğ‘§,ğ‘¦âŸ©changesrespectivelyasperrule ğ‘…12.PartAinthebe-
lowfigure showsthese orientation changes ina sequence; whereas
part B shows the orientation change that is computed by aggregat-
ing these two changes. Note that both parts result into the same
orientation.
ğ‘…15typesarotationcompositioninwhichoneoftherotationsis
notstaticornotorthogonal.Notethatanarbitraryangularrotation
can be integrated with an orthogonal axes orientation rotation.
Since we only model and check axes orientation, the resulted type
isthe one that represents orthogonalorientationchanges.
Example. Table2presents part of the example code in Figure 3
writtenin our languageandthe types computedbythe type rules.
Thefirstcolumnshowstheoriginallinenumbersofthestatements.
St#6isanassignmentofarotationvariablefromastatevariable.
The state variable tmpgets a value from the external value state
variablerotation.Therefore,asperrule ğ‘…13,tf_cam_rotation istyped
toâŠ¤.St#10and13aretheassignmentsofrotationvariablesfrom
constantvectors.Rule ğ‘…12allowstyping RxandRztoâŸ¨ğ‘¥,âˆ’ğ‘§,ğ‘¦âŸ©and
âŸ¨âˆ’ğ‘¦,ğ‘¥,ğ‘§âŸ©, respectively. Further, St#20and21denote thecomposi-
tion of rotations: the former is typed with the type of Rxbyğ‘…15as
thetypeof tf_cam_rotation isâŠ¤,whereasthelatteristypedwith
âŸ¨ğ‘§,ğ‘¥,ğ‘¦âŸ©,whichiscomputedbycomposingtypesof Rzandtf_cam_-
rotationusingrule ğ‘…142.St#23and25aresimilarlytyped.Finally,
St# 30 constructs a new transform object. However, it cannot be
properlytypedbyrule ğ‘…8asapplyingrotation âŸ¨ğ‘§,âˆ’ğ‘¥,âˆ’ğ‘¦âŸ©tothepar-
entmapframewiththeconventionalorientation âŸ¨forward,left,upâŸ©,
i.e,FLU,yieldstheorientation âŸ¨right,down,forwardâŸ©,contradicting
withtheROSorientationconventionFLUforthecameraframe.On
theotherhand, PhysFrame correctlytype-checksthefixedversion.
SoundnessandCompleteness. The essenceof PhysFrame isto
leverage flow-insensitive static analysis (like type checking) to
2PhysFrame uses SSAto handlevariablere-definitions.
52PhysFrame : Type CheckingPhysical Frames of Reference forRoboticSystems ESEC/FSE â€™21, August 23â€“28, 2021,Athens,Greece
findframerelatedbugs.Itisautomatedanddoesnotrequireany
usertypeannotationsforsubjectROSprojects.Assuch,thetype
systemisneithersoundnorcomplete.Thisisbecausesometype
rules are uncertain. For example in rule ğ‘…12, a matrix representing
orthogonal angular transformation may not be intended for frame
axesorientationchanges,butratherbecausetheparentandchild
bodypartsareinstalledinawaythattheyformsomeorthogonal
angle(s), while their frame axes orientations are identical (both
FLU). However,since there isno way for PhysFrame to knowthe
real meanings of such rotation without user input, it considers this
an axes orientation rotation, which is the most common case. And
stamped variables from third party libraries are widely used and
PhysFrame maynotbeabletotypethem.Therefore, PhysFrame
has both false positives and false negatives. On the other hand,
we foresee future robotic system development frameworks may
support full-fledged frame types which the developer can use to
declaretheirvariables.Withsuchexplicittypedeclarations,asound
andcomplete type systemcan be developed.
4.2.3 FrameRelatedProblems. PhysFrame reports7kindsoftype
errors,2kindsoftypewarningsand3kindsofviolationsofimplicit
conventions. The firsttwoare alsocalledinconsistencies.
Type Errors. Thisfirstkindis TFtreerelatederrors. Theseerrors
includea frame having multiple parent frames ,frames forming a
cycle, andframes not following conventional orders such as a map
framemustbe the ancestorofabody frame(Section 2.3).
Thesecond kindoftype errorsis incorrect framesor transforms.
ROSallowsdeveloperstostampastatevariable ğ‘¥withanempty
id. If these variables are published, meaning that other compo-
nents from different parties may receive such data, they should
be stamped with a proper frame (rule ğ‘…16). Moreover, if they are
used in transforms, runtime errors will be triggered as well. In
these cases, PhysFrame reports a missing frame error . Although
notexplicitlymodeledbyourrules,afewROSdatatypesrequire
explicitly specifying child frame ids. If child frames are not set,
PhysFrame reportsmissing childframe errors .
Atransformisrequiredtohavedifferentparentandchildframes
(ruleğ‘…8). Otherwise, it is meaningless. PhysFrame reports a re-
dundant transform . Ruleğ‘…8requires that the displacements and
rotationinanewlycreatedtransformshouldyield(relative)posi-
tionsandaxesorientationsconsistentwiththeparentframeand
ROS conventions (e.g., body frames should have forward-left-up
(FLU)orientations). Otherwise,itreports incorrecttransforms .
Type Warnings. Asensortransformthatdefinesasensorframe
with respect tosome other robotic body part like base_link, wrist,
etc. or vice versa should have at least some non-zero displace-
ment(s)/rotation(s) as a sensorâ€™s center unlikely aligns with a body
partâ€™scenter. PhysFrame reportsawarningwhenasensortrans-
formhaszerodisplacementsandrotations.Foratransformfrom
parenttochild,ROSnamingconventionsfollowtemplatesâ€˜<par-
ent>_to_<child>â€™ andâ€˜<child>_in_<parent>â€™, whichgivetheclear
meanings of the transform. Developers however often inverse the
parentandthechildintransformvariablenames. PhysFrame hence
reportsreversed name warnings . These two are warnings as they
maynotaffectthefunctionalitiesbutratherdegrademaintainability.
Suchcheckingsarenotexplicitlymodeledintyperulesalthough
PhysFrame supports them.Implicit Convention Violations. As mentioned in Section 2.3,
implicitconventionsareminedfromlaunchfiles.Assuch,theymay
notberequiredbutrathercommonlyseen. PhysFrame reportsthree
kinds ofwarnings. The first is null displacement expected warning,
meaning that certain transforms or frames are supposed to have
null displacements.The secondis nullrotationexpected warning,
meaningthatcertaintransformsaresupposedtohavenullrotations.
Thethirdisthat co-occurrenceviolation warningswhenframesthat
are commonly seen together (in other projects) are not present
in a project. Such checkings are performed as an additional step
afterframeandtransformtypesareinferred.Thereasonisthatitis
hard to implement implicit conventions as type rules as the mined
conventionsmaychangedependingontherepositoriesusedand
the z-score threshold setting.
5 EVALUATION
We address the following questions: RQ1.How effective and ef-
ficientisPhysFrame indisclosingframerelatedinconsistencies?
RQ2.What is the response from developers on the inconsistencies
reported by PhysFrame ?RQ3.What kinds of implicit conventions
are violatedandwhat isthe impact of z-score onresults?
5.1 Experiment Setup
Implementation . We have implemented a prototype of Phys-
Framein around 4800 lines of Python code. It utilizes a third-party
component, cppcheck [26], to obtain an XML dump for a C/C++
file providing an intermediate representation. It contains program
tokens,symboltablesforscopes,functionsandvariables,andan
ASTforeachstatement.Wehavealsoimplementedconstantpropa-
gationtoresolvevariablestostaticvalueswhenpossible.Theminer
isimplementedusingMySQLdatabaseandSQLscript.Implementa-
tiondetailscanbefoundinAppendixCin[ 19].Thedatabaseforthe
implicitconventionminerisbuiltfromalistofROSprojectsthat
containatleastonelaunchfilewitha static_transform_publisher .We
useonlythematureprojectsfromthislist.Weconsideraprojectma-
turewhenithasmorethan30commits.Thedatabasecontains12.1K
statictransformsin5.3Klaunchfilesfrom2.2Kmatureprojects.The
tool and data is available at https://doi.org/10.5281/zenodo.4959920
Artifacts . We run the type checker on 180 ROS projects from
Github. They include (a) 7 projects from the ROS Kinetic distri-
bution that contain at least one issue or a commit related to frame;
(b) 23 randomly selected projects from the ROS indigo distribution;
and (c) 150 randomly selected ROS projects that contain at least
onestatictransform.Amongtheseprojects,69arematureand99
not (with less than 30 commits). Note that we consider evaluation
on unmature projects important as well because they are likely by
non-expertROSdevelopersthatcanbenefitmorefrom PhysFrame .
Table7inAppendixin[ 19]showsthestatisticsoftheseprojects.
Onaverage,eachprojecthas45source/launchfilesand52491LOC,
withthe largestone having433filesandover 7million LOC.
Examination Process . We examine each of the reported incon-
sistenciesbyreviewingthecorrespondingsourcecodeandmark
it asTrue Positive (TP) orFalse Positive (FP). The manual exami-
nation poses a threat to the validity of results presented in this
paper (please refer to Appendix D in [ 19]). We mitigate it by cross-
checking,beingveryconservativeinmarkingTPs,andconfirmation
53ESEC/FSE â€™21, August 23â€“28, 2021,Athens,Greece S.Kate, M. Chinn, H.Choi, X.Zhang,S.Elbaum
Table 3:Inconsistenciesby Category (with thefirstseven type errors, thelasttwotype warnings)
Category Number of Inconsistencies Number of Repositories
Total (#) TP (#) FP(#) Total (#) TP (#) FP(#)
C/C++ Launch C/C++ Launch
c_MULTIPLE_PARENTS_IN_FRAME_TREE 4 3 1 0 0 4 4 0
c_CYCLE_IN_FRAME_TREE 1 1 0 0 0 1 1 0
td_INCORRECT_FRAME_ORDER_IN_TREE 7 3 4 0 0 7 7 0
c_INCORRECT_TRANSFORM 17 4 4 0 9 9 3 6
td_REDUNDANT_TRANSFORM 2 2 - 0 - 2 2 0
td_MISSING_FRAME 108 92 - 16 - 56 49 13
td_MISSING_CHILD_FRAME 12 8 - 4 - 7 4 3
td_REVERSED_NAME(typewarning) 33 1 28 1 3 19 17 4
c_SENSOR_NULL (typewarning) 6 0 3 0 3 5 2 3
Total 190 114 40 21 15 110 89 29
[81.05%] [18.95%]
Table 4:Summary ofTrue Positive Inconsistencies
Report & Response CountInconsistency Categories
foundby searching
commit-historyorissue
reports of repositories.3td_MISSING_FRAME
1c_INCORRECT_TRANSFORM
fixed by developers
beforewereported
them.1td_MISSING_FRAME
1td_REDUNDANT_TRANSFORM
1c_CYCLE_IN_FRAME_TREE
1c_MULTIPLE_PARENTS_IN_FRAME_TREE
reported,and either
fixed by developersor
readyto accept a
pull-request.2td_MISSING_FRAME
1td_MISSING_CHILD_FRAME
1td_REDUNDANT_TRANSFORM
1td_INCORRECT_FRAME_ORDER_IN_TREE
reported,and
acknowledged by
developers(in some
cases,confirmed as a
useful fix to others for
reusing the package
node).1td_MISSING_FRAME
5td_REVERSED_NAME
2c_SENSOR_NULL
2td_INCORRECT_FRAME_ORDER_IN_TREE
reported,butrefused
by developersonthe
grounds that reuseof
the package node is not
easy, orthe package is
nolonger maintained.3td_MISSING_FRAME
reported,butno
responsefrom
developersyet.12td_MISSING_FRAME
1td_MISSING_CHILD_FRAME
4c_INCORRECT_TRANSFORM
14td_REVERSED_NAME
1td_INCORRECT_FRAME_ORDER_IN_TREE
2c_MULTIPLE_PARENTS_IN_FRAME_TREE
foundin a package
nodethat is reused by
otherdeveloper. The
issue is either fixed or
acknowledged by other
users in the original
repositoryof the node.2td_MISSING_FRAME
4td_MISSING_CHILD_FRAME
foundin backup-copy
files in repositories.5td_MISSING_FRAME
potential issues. 8td_MISSING_FRAME
projectsnot activein
past twoyears.55td_MISSING_FRAME
2td_MISSING_CHILD_FRAME
3c_INCORRECT_TRANSFORM
10td_REVERSED_NAME
1c_SENSOR_NULL
3td_INCORRECT_FRAME_ORDER_IN_TREE
1c_MULTIPLE_PARENTS_IN_FRAME_TREETable 5:ImplicitConvention Warningsby Category
Category z=1 z=2 z=5 z=10
W#R#W#R#W#R#W#R#
w_sig_null_rot_exp 18 9 16 7 14 5 9 2
w_name_null_rot_exp 20 10 20 10 2 2 0 0
w_name_co-occurrence 7 3 0 0 0 0 0 0
with developers. The implicit convention violation warnings are
by their nature more difficult to determine if they denote real bugs.
We hence run the tool on the same set of projects with different
z-score threshold values and study the reported warnings. All type
checkingrunsareonaDellPowerEdgeR420Linuxserverwithtwo
IntelXeonE5-26902.90GHz8-coreprocessorsand192GBofRAM.
5.2 Results andObservations
RQ1. Effectiveness and Efficiency. PhysFrame reports 190 in-
consistencies with 154true positivesand81.05%truepositive rate.
Theseinconsistencies belongto 100projects,over 55%ofthetotal
we examined. This number is specially significant considering that
manymoreframerelatedbugsreportedinearlierversionsofthe
systemsmayhavebeendetectedby PhysFrame .PhysFrame also
reports45,36,16,9implicitconventionviolationwarningswhen
the z-score threshold is set to 1, 2, 5, 10, respectively, which cor-
responds to p-values smaller than 0.15 for z=1 to p-values smaller
than0.00001forz=10.Theaverageanalysistimeis52secondswith
themaximum1190seconds.FurtherdetailscanbefoundinTable6
inAppendix in[ 19].
Inconsistencies by Category. Table3summarizes inconsistencies by
theircategory,withthefirstseventypeerrorsandthelasttwotype
warnings.Thefirstcolumnliststhecategories.Eachhaseitheraâ€˜ ğ‘_â€™
orâ€˜ğ‘¡ğ‘‘_â€™prefix,denotingwhetheritisaÅ‚correctnessÅ¾oraÅ‚technical
debtÅ¾ issue, respectively. The Å‚correctnessÅ¾ issues represent the
typesofinconsistenciesthatviolateROSconventionssuchasatree
representation of all the frames in an application, sensor frames
shouldhavenon-nulltransformswithrespecttorobotbodyframes,
andincorrecttransforms.Theincorrecttransformissuesinclude
those that have invalid displacement/rotation (like our motivating
example inSection 3) which can leadto problems duringruntime,
andthosethatdonotfollowROSnamingconventions(discussed
in Section 2.2) while defining a child frame in the transform which
affectcodereadabilityandmaycauseissuesduringcodereuse.The
Å‚technicaldebtÅ¾issuesrepresentthetypesofinconsistenciesthat
54PhysFrame : Type CheckingPhysical Frames of Reference forRoboticSystems ESEC/FSE â€™21, August 23â€“28, 2021,Athens,Greece
may make code maintenance and understanding difficult and may
leadtopotentialruntimeproblemsduringcodereuse/collaboration.
Thenextfivecolumnsshowthetotalnumberofinconsistenciesfor
eachcategory,TP casesinC/C++codeandinlaunchfiles,FPcases
in C/C++ code and in launch files, respectively. Further, the last
threecolumnsshowthenumberofprojectswithinconsistencies,
TPs,andFPs,respectively.
Many of the reported inconsistencies are about missing frames,
i.e., developers forgot to set frame ids for published state values.
FP cases of this type are observed due to usage of stamped data
typesforstoringnon-framedata(e.g.,binarymaskofimage),usage
ofstampedtransformfortfoperationsthatdonotneed frame_id
fieldvalue,andpassingofstampeddatatypevariablestofunctions
whose signature is not available during analysis. Similar sources of
false positives affect other categories. PhysFrame also found many
reversednamewarnings.Forexample,ROSexpectstransformvari-
ables to follow the naming convention of Å‚ âŸ¨parentâŸ©_to_âŸ¨childâŸ©Å¾.
We find that many developers use the names reversed. This may
causemaintenanceandreuseissuesastheconventionisexpected
by other parties. PhysFrame also identified 17 frame type incon-
sistencies similar to our motivating example in Section 3and 12
TFtreeerrors.GiventhatROSisbuilttoencouragecollaborative
development, even the issues affecting code readability or reuse
canbeimportant.WehavethreecasestudiesinAppendixEin[ 19].
RQ2.DeveloperResponses. Table4summarizesthedistribution
ofthetruepositivesacrossdifferentreportingactions,developer
responses and inconsistency categories. Row 1 (below the table
title)shows that4ofthe154true positives PhysFrame uncovered
wereknownissuesbythedevelopers. Row2showsthatanother
four were fixed by the time we reached the developers. Among the
remainingtruepositives,wereportedthe52thatbelongtoprojects
that showed activity in the past 2 years (rows 3-6). We received
18responseswith15eitheracknowledgingthisissueorfixingit,
and 3 declining our reports because either it is not seen as relevant
(project is not intended for external use hence conventions do not
needtoberespected),orprojectnolongermaintained.Row8shows
thatPhysFrame found 6 bugs in reused versions of projects that
have already been fixedinthe originalrepositories.
RQ3.ImplicitConventionViolations. Table5showsthethree
kindsofimplicitconventionviolations PhysFrame has foundand
theimpactofz-scorethreshold.W#meansthenumberofwarnings
and R# the number of projects with warnings. The most popu-
lar kind is w_name_null_rot_exp , meaning that a transform with
a specific name is expected to have 0 rotation; w_sig_null_rot_-
expis similar except that a transform is identified by parent and
child frame ids instead of name. Some of the w_sig_null_rot_exp
warningsarepersistent (withdifferentz-threshold),meaningthat
conventions adoptedbyalmostallprojectsare being violated.
6 RELATED WORK
Component-basedRobotSoftware. Component-basedprogram-
ming[8,9]hasbeenextensivelyusedinrobotdevelopment,aim-
ing to facilitatereuse.Followingthe principle,severalrobotsoft-
ware frameworks [ 25], such as Open Robot Control Software (Oro-
cos)[10],ROS[32].Player[ 17],Miro[37],havebeendevelopedand
widely used. These frameworks commonly provide communica-
tion infrastructure across components [ 16] and substantial librarysupport. As such, respecting conventions is critical for these infras-
tructures. Unfortunately, they provide no compile time support to
ensureframeconventions,oneofthemosterror-proneaspectsof
robot programming. PhysFrame is a type checking technique that
systematically detectsproblems inusing frames.
TypeCheckinginRoboticSystems. Typechecking[ 11,33]isa
well-known technique to improve software reliability. In robotic
software, due to its domain-specific characteristics, variables of-
tenhavephysical-worldsemantics.Additionaltypecheckingcan
hence be performed considering the physical world. Unit type
checking [ 7,12] is the most common robotic software type system,
whichtype variableswithphysicalunitinformation.Theseminal
work [21,22,34] in the type checking of units and dimensionsex-
tendsaprogramminglanguage.Ayudante[ 18]buildsandcompares
clusters of variables based on dataflow and the meaning of vari-
ablesnamestodetecttype(e.g.,unit)inconsistencies.Therecent
work on Phriky [ 30,31] supports dimensionality type checks in
ROS without developer annotations, and Phys [ 20] extends it with
probabilistic type inference to detect more inconsistencies. In this
workweextendthetypecheckingtoreferenceframesinrobotic
software,whichrequires adistinct type system.
Frame Safety. Lowry et al. [ 23] proposed a general abstract in-
terpretationsystemforcertifyingdomain-specificpropertiesand
provideacasestudytocertifyNAIFlibraryprogramsâ€™frame-safety.
The case study checks limited properties (e.g., frame consistencies)
and thesystem needs annotations for program inputs. In contrast,
oursisafullyautomatedtoolcheckingmanypropertiesforROS
projects (e.g., TF tree shape and frame orientations), without re-
quiringannotations.Ourabstractdomainsarehencedifferentfrom
theirs andour method istype systembased. The workby Basir et
al. [6] onautomated theoremproving for automatically generated
codealsopresentedacasestudytoverifytwoframe-safetyrequire-
ments.META-AMPHIONsystem[ 24]helpsdomainexpertsbuild
domain-specific program synthesizers. In the context of frame-
safety, we believe that this work would enable the synthesis of
programsthatareframe-safegiventhecorrectdomaintheory.In
our work, we focus on finding frame issues in the already devel-
opedcode.Overallwedonotneedannotations,haveapush-button
approach, andprovideabroad assessment of real code.
7 CONCLUSION
Wedevelopafullyautomatedtypecheckingtechniqueforreference
frames in robotic system, which is one of the most subtle and
error-proneaspectsinroboticsoftwareengineering.Weexplainthe
semanticsofframesandframetransformations,andproposeanovel
way to abstract them. Type checking rules are developed based on
the domain specific semantics. Applying our technique to 180 ROS
projects from GitHub discloses over 190 errors and warnings, with
154truepositives.Wereported52ofthemandreceived18responses
bythe time ofsubmissionand15 fixed/acknowledged.
ACKNOWLEDGMENTS
Wethankourinsightfulreviewers.Thisresearchwassupported,in
partbyNSF1901242,1910300,1909414and1853374,ONRN0001417-
12045, N000141410468 and N000141712947. Any opinions, findings,
and conclusions in this paper are those of the authors only and do
not necessarily reflectthe viewsof our sponsors.
55ESEC/FSE â€™21, August 23â€“28, 2021,Athens,Greece S.Kate, M. Chinn, H.Choi, X.Zhang,S.Elbaum
REFERENCES
[1]2015.diff_drive_controller is hard-coded into the â€™odomâ€™ reference frame #204 .
https://github.com/ros-controls/ros_controllers/issues/204
[2] 2017. TF: Debugging Tools .http://wiki.ros.org/tf/Debuggingtools
[3] 2019. ORB-SLAM2 ROS node .http://wiki.ros.org/orb_slam2_ros
[4]2019.T265framequestions#772 .https://github.com/IntelRealSense/realsense-
ros/issues/772
[5]2020.Incorrect frame tree cartographer ros and t265 camera #1599 .https://github.
com/IntelRealSense/realsense-ros/issues/1599
[6]Nurlida Basir, Ewen Denney, and Bernd Fischer. 2010. Deriving Safety Cases for
HierarchicalStructurein Model-BasedDevelopment.In Proceedingsofthe29th
International Conference on Computer Safety, Reliability, and Security (Vienna,
Austria)(SAFECOMPâ€™10) . Springer-Verlag, Berlin, Heidelberg, 68Å›81.
[7]GeoffreyBiggs.2007. Designinganapplication-specificprogramminglanguage
for mobilerobots . Ph.D. Dissertation. ResearchSpace@ Auckland.
[8]Alex Brooks, Tobias Kaupp, Alexei Makarenko, Stefan Williams, and Anders
Oreback.2005. Towardscomponent-basedrobotics.In 2005IEEE/RSJInternational
Conference onIntelligentRobotsand Systems . IEEE,163Å›168.
[9]Davide Brugali and Patrizia Scandurra. 2009. Component-based robotic engi-
neering (part i)[tutorial]. IEEE Robotics & Automation Magazine 16, 4 (2009),
84Å›96.
[10]HermanBruyninckx.2001. Openrobotcontrolsoftware:theOROCOSproject.In
Proceedings 2001 ICRA. IEEE international conference on robotics and automation
(Cat. No.01CH37164) , Vol. 3.IEEE,2523Å›2528.
[11]Luca Cardelli. 1996. Type systems. ACM Computing Surveys (CSUR) 28, 1 (1996),
263Å›264.
[12]Kostadin Damevski.2009. Expressingmeasurementunits ininterfacesforsci-
entific component software.In Proceedingsofthe 2009 Workshopon Component-
BasedHighPerformance Computing . 1Å›8.
[13]Dawson Engler, David YuChen, SethHallem, Andy Chou, and Benjamin Chelf.
2001. Bugs as Deviant Behavior: A General Approach to Inferring Errors in
Systems Code. In Proceedings of the Eighteenth ACM Symposium on Operating
SystemsPrinciples (Banff,Alberta,Canada) (SOSPâ€™01) .AssociationforComputing
Machinery, NewYork, NY, USA,57Å›72. https://doi.org/10.1145/502034.502041
[14]TullyFoote.2013. tf:The transformlibrary.In IEEE InternationalConference on
Technologies for Practical Robot Applications (TePRA), 2013 (Open-Source Software
workshop) . 1Å›6.https://doi.org/10.1109/TePRA.2013.6556373
[15]Tully Foote and Mike Purvis. 2010. Standard Units of Measure and Coordinate
Conventions .https://www.ros.org/reps/rep-0103.html
[16]Open Source Robotics Foundation. [n.d.]. ROS Topics homepage .http://wiki.ros.
org/Topics
[17]Brian Gerkey, Richard T Vaughan, and Andrew Howard. 2003. The player/stage
project:Toolsformulti-robotanddistributedsensorsystems.In Proceedingsof
the 11thinternational conference onadvancedrobotics , Vol. 1.317Å›323.
[18]Irfan Ul Haq, Juan Caballero, and Michael D Ernst. 2015. Ayudante: Identifying
undesired variable interactions. In Proceedings of the 13th International Workshop
onDynamic Analysis . 8Å›13.
[19]SayaliKate,MichaelChinn,HongjunChoi,XiangyuZhang,andSebastianElbaum.
2021. PHYSFRAME:TypeCheckingPhysicalFramesofReferenceforRobotic
Systems. arXiv: 2106.11266 [cs.RO]
[20]Sayali Kate, John-Paul Ore, Xiangyu Zhang, Sebastian Elbaum, and Zhaogui Xu.
2018. Phys:probabilisticphysicalunitassignmentandinconsistencydetection.In
Proceedingsofthe201826thACMJointMeetingonEuropeanSoftwareEngineeringConference and Symposium on the Foundations of Software Engineering . 563Å›573.
[21]Andrew Kennedy. 1994. Dimension Types. In Proceedings of the 5th European
SymposiumonProgramming:ProgrammingLanguagesand Systems (ESOP â€™94) .
Springer-Verlag, Berlin, Heidelberg, 348Å›362.
[22]Andrew Kennedy. 2009. Types for Units-of-Measure: Theory and Practice. In
ProceedingsoftheThirdSummerSchoolConferenceonCentralEuropeanFunctional
Programming School (Budapest, Hungary) (CEFPâ€™09) . Springer-Verlag, Berlin,
Heidelberg, 268Å›305.
[23]MichaelLowry,ThomasPressburger,andGrigoreRosu.2001. CertifyingDomain-
Specific Policies. In Proceedings of the 16th IEEE International Conference on
AutomatedSoftwareEngineering (ASE â€™01) . IEEE Computer Society, USA,81.
[24]Michael R. Lowry and Jeffrey Van Baalen. 1997. META-AMPHION: Synthesis of
EfficientDomain-SpecificProgramSynthesisSystems. AutomatedSoftwareEngg.
4,2 (April1997),199Å›241. https://doi.org/10.1023/A:1008637201658
[25]GergelyMagyar,PeterSinÄÃ¡k,andZoltÃ¡nKrizsÃ¡n.2015. Comparisonstudyof
robotic middleware for robotic applications. In Emergent Trends in Robotics and
IntelligentSystems . Springer, 121Å›128.
[26]Daniel Marjamaeki. 2017. Cppcheck - A tool for static C/C++ code analysis .http:
//cppcheck.sourceforge.net/
[27]Wim Meeussen. 2010. Coordinate Frames for Mobile Platforms .https://www.ros.
org/reps/rep-0105.html
[28]ThomasMoulard.2011. CoordinateFramesforHumanoidRobots .https://www.
ros.org/reps/rep-0120.html
[29] RaÃºl Mur-Artal and Juan D. TardÃ³s. 2017. ORB-SLAM2: anOpen-Source SLAM
SystemforMonocular,StereoandRGB-DCameras. IEEETransactionsonRobotics
33,5 (2017), 1255Å›1262. https://doi.org/10.1109/TRO.2017.2705103
[30]John-Paul Ore, Carrick Detweiler, and Sebastian Elbaum. 2017. Lightweight
Detection of Physical Unit Inconsistencies Without Program Annotations. In
Proceedingsofthe26thACMSIGSOFTInternationalSymposiumonSoftwareTesting
andAnalysis (SantaBarbara, CA, USA) (ISSTA2017) .ACM, New York,NY,USA,
341Å›351. https://doi.org/10.1145/3092703.3092722
[31]John-Paul Ore, Carrick Detweiler, and Sebastian Elbaum. 2017. Phriky-Units:
A Lightweight, Annotation-Free Physical Unit Inconsistency Detection Tool.
InProceedings of the 26th ACM SIGSOFT International Symposium on Software
Testing and Analysis (Santa Barbara, CA, USA) (ISSTA 2017) . Association for
ComputingMachinery,NewYork,NY,USA,352Å›355. https://doi.org/10.1145/
3092703.3098219
[32]MorganQuigley,KenConley,BrianGerkey,JoshFaust,TullyFoote,JeremyLeibs,
Rob Wheeler, and Andrew Y Ng. 2009. ROS: an open-source Robot Operating
System.In ICRA workshop onopensourcesoftware , Vol. 3.2. Kobe, Japan,5.
[33]John C Reynolds. 1974. Towards a theory of type structure. In Programming
Symposium . Springer, 408Å›425.
[34]Mikael Rittri. 1995. Dimension Inference under Polymorphic Recursion. In
ProceedingsoftheSeventhInternationalConferenceonFunctionalProgramming
Languages and Computer Architecture (La Jolla, California, USA) (FPCA â€™95) .
Association for Computing Machinery, New York, NY, USA, 147Å›159. https:
//doi.org/10.1145/224164.224197
[35] Clearpath Robotics.2017. Robots-PR2 .http://wiki.ros.org/Robots/PR2
[36]Wim Meeussen Tully Foote, Eitan Marder-Eppstein. [n.d.]. Ros tf package home-
page.http://wiki.ros.org/tf,http://wiki.ros.org/tf2
[37]Hans Utz, Stefan Sablatnog, Stefan Enderle, and Gerhard Kraetzschmar. 2002.
Miro-middlewareformobilerobotapplications. IEEETransactionsonRobotics
and Automation 18,4 (2002), 493Å›497.
56