Patching Vulnerabilities with Sanitization Synthesis
FangYu
National Chengchi University
yuf@nccu.edu.twMuath Alkhalaf
UCSanta Barbar a
muath@cs .ucsb .eduTevkBultan
UCSanta Barbar a
bultan@cs .ucsb .edu
ABSTRA CT
Wepresen tautomata-based static string analysis techniques
thatautomatically generate sanitization statemen tsforpatch-
ingvulnerable webapplications. Ourapproac hconsists of
threephases: Givenanattackpattern werstconduct avul-
nerabilit yanalysis toidentifyifstrings thatmatchtheattack
pattern canreachthesecurit y-sensitiv efunctions. Next, we
compute vulnerabilit ysignatures thatcharacterize allinput
strings thatcanexploit thediscoveredvulnerabilit y.Given
thevulnerabilit ysignatures, wethenconstruct sanitization
statemen tsthat1)checkifagiveninput matchesthevul-
nerabilit ysignature and2)modifytheinput inaminimal
waysothatthemodied input doesnotmatchthevul-
nerabilit ysignature. Ourapproac hiscapable ofgenerating
relational vulnerabilit ysignatures (andcorresp onding sani-
tization statemen ts)forvulnerabilities thatareduetomore
thanoneinput.
Categories andSubject Descriptors
D.2.4 [SoftwareEngineering ]:Software/Program Veri-
cation| ModelChecking, Reliability
General Terms
Verication, Securit y
Keywords
Sanitization Synthesis, String Analysis, Automata
1.INTR ODUCTION
Webapplications arenotorious forsecurit yvulnerabilities
thatcanbeexploited bymalicious users. Duetoglobal
accessibilit yofwebapplications, malicious users allaround
theworldcanexploit avulnerable webapplication andcause
Thisresearc hisfunded bytheNSCgrant99-2218-E-004-
002-MY3, andtheNSF grantsCCF-0716095 andCCF-
0916112.
Permission tomakedigital orhard copies ofallorpart ofthisworkfor
personal orclassroom useisgranted without feeprovided thatcopies are
notmade ordistrib uted forprot orcommercial advantage andthatcopies
bear thisnotice andthefullcitation ontherstpage. Tocopyotherwise, to
republish, topost onserversortoredistrib utetolists, requires prior specic
permission and/or afee.
ICSE '11,May 21Â–28, 2011, Waikiki, Honolulu, HI,USA
Copyright 2011 ACM978-1-4503-0445-0/11/05 ...$10.00.serious damage. So,itiscritical thatvulnerabilities arenot
onlydiscoveredfast,buttheyarealsorepairedfast.
Inthispaper,wepresen ttechniques forautomatically de-
tecting andpatchingstring related vulnerabilities inweb
applications. Westartwithasetofattackpatterns (regular
expressions) thatcharacterize possible attacks(either taken
fromanattackpattern specication library orwritten by
thewebapplication developer).Givenanattackpattern,
ourstring analysis approac hworksinthree phases:
Phase 1:Vulnerabilit yAnalysis: First, weuse
automata-based static string analysis techniques todeter-
mineifthewebapplication isvulnerable toattackscharac-
terized bythegivenattackpattern andgenerate acharac-
terization ofthepotentialattackstrings iftheapplication is
vulnerable.
Phase 2:Vulnerabilit ySignature Generation: We
thenprojecttheseattackstrings touserinputs andcompute
anover-appro ximation ofallpossible inputs thatcancause
anattack.Thischaracterization ofpotentially harmful user
inputs iscalled thevulnerability signatur eforagivenattack
pattern.
Phase 3:Sanitization Generation: Once wehavethe
vulnerabilit ysignature, weautomatically synthesize patches
thateliminate thevulnerabilit yusing twostrategies:
Match-and-blo ck:Weinsert match statements tovulnera-
blewebapplications andhalttheexecution when aninput
thatmatchesavulnerabilit ysignature isdetected.
Match-and-sanitize: Weinsert bothmatchandreplace
statements tovulnerable webapplications. When aninput
thatmatchesavulnerabilit ysignature isdetected, instead
ofhalting theexecution, thereplace statemen tisexecuted.
Thereplace statemen tdeletes asmall setofcharacters from
theinput suchthatthemodied string nolonger matches
thevulnerabilit ysignature.
Forvulnerabilit yanalysis, weuseaforwardsymbolicreach-
abilityanalysis thatcomputes anover-appro ximation ofall
possible values thatstring variables cantakeateachpro-
gram point.Weusedeterministic nite automata (DFAs)
torepresen tvalues thatstring expressions cantake.In-
tersecting theresults oftheforwardanalysis atsinks (i.e.,
sensitiv efunctions thatcancause avulnerabilit y)withthe
attackpattern givesusthepotentialattackstrings ifthe
program isvulnerable. Iftheintersection isempty,thenthe
program isnotvulnerable withrespecttothegivenattack
pattern.
Weusetwodieren ttechniques forvulnerabilit ysignature
generation. Intherstone,westart withtheDFAthat
represen tstheattackstrings atthesink, andthenuseabackwardsymbolicreachabilit yanalysis tocompute anover-
approximation ofallpossible inputs thatcangenerate those
attackstrings. Theresult isaDFAthatcharacterizes the
vulnerabilit ysignature forthegivenattackpattern.
However,thisapproac hdoesnotworkforvulnerabilities
thatareduetomorethanoneinput. Forexample, ifanat-
tackstring isgenerated byconcatenating twoinput strings,
itmightnotbepossible topreventtheattackbyblock-
ingonlyoneoftheinputs, since astring coming fromone
input canleadtoanattackifitisconcatenated withasuit-
ablyconstructed string coming fromanother input. Insuch
cases thevulnerabilit ysignature caninclude allpossible in-
putstrings. Using suchavulnerabilit ysignature forauto-
mated patchgeneration wouldmean blockingorerasing all
theuserinput, whichwouldmakethewebapplication unus-
able. However,ifwecandoananalysis thatkeepstrackof
therelationships among dieren tstring variables, thenwe
canblockonlythecombinations ofinput strings thatlead
toanattackstring.
Wepresen tarelational vulnerabilit ysignature genera-
tionalgorithm based onmulti-trac kdeterministic nite au-
tomata (MDF A).AnMDFAhasmultiple tracksandreads
onesymbolforeachtrackineachtransition. I.e.,anMDFA
recognizes tuples ofstrings rather thanasingle string. We
useaforwardsymbolicreachabilit yanalysis where eachgen-
erated MDFAhasonetrackforeachinput variable and
represen tstherelation betweentheinputs andthestring
expression ataparticular program point.Intersecting the
MDFAatasinkwiththeattackpattern andprojecting the
resulting MDFAtotheinput tracksgivesusthevulnerabil-
itysignature. Thevulnerabilit ysignature MDFAaccepts all
combinations ofinputs thatcanexploit thevulnerabilit y.
Once wegenerate thevulnerabilit ysignature wegener-
atematchandreplace statemen tsbased onthevulnera-
bilitysignature. Thematchstatemen tbasically simulates
thevulnerabilit ysignature automaton andreportsamatch
iftheinput string isaccepted bytheautomaton. Inthe
match-and-blo ckstrategy thisisallweneed, andwehalt
theexecution ifthere isamatch.Inthematch-and-sanitize
strategy ,however,wealsogenerate areplace statemen tthat
willmodifytheinput sothatitdoesnotmatchthevulner-
abilitysignature. Since inputs thatmatchthevulnerabilit y
signature maycome fromnormal, non-malicious users(who,
forexample, mayhaveacciden tallytypedasuspicious char-
acter), itispreferable tochange theinput inaminimal way.
Wepresen tanautomata theoretic characterization ofthis
minimality andshowthatsolving itprecisely isintractable.
Weshowthatwecangenerate areplace statemen twhichis
closetooptimal inpractice byadopting apolynomial-time
min-cut algorithm.
Weimplemen tedallthetechniques mentioned abovefor
PHP programs ontopofourstring analysis toolcalled
Stranger (STRing AutomatoN GEneratoR) [17]. Stranger
usesthefront-end ofPixy[11],avulnerabilit yanalysis tool
forPHPthatperforms taintanalysis toidentifypotentially
vulnerable sinks(sinks thatdependonexternal inputs) and
generates dependency graphs thatshowhowtheexternal
inputs owintothesinks. Stranger thenperforms string
analysis onthedependency graphs. Stranger alsousesthe
automata packageofMONA tool[3]tostoretheautomata
constructed during string analysis symbolically .
Related Work: Duetoitsimportance insecurit y,string1<?php
2$name=$_GET["name"];
3$out="NAME:"$name;
4echo$out;
5?>
Figure 1:ASimple Example
analysis hasbeenwidely studied. Oneinuen tialapproac h
hasbeengrammar-based string analysis thatstatically com-
putes anover-appro ximation ofthevalues ofstring expres-
sionsinJavaprograms [4]whichhasalsobeenusedtocheck
forvarious typesoferrors inWebapplications [8,13,15,
9].In[13,15],multi-trac kDFAs,alsoknownastransduc ers,
areusedtomodelreplacemen toperations. There arealso
severalrecentstring analysis toolsthatusesymbolicstring
analysis based onDFAencodings [14,7,18].Some ofthem
arebased onsymbolicexecution anduseaDFArepresen-
tation tomodelandverifythestring manipulation opera-
tions inJavaprograms [14,7].HAMPI [12]isabounded
string constrain tsolverthatsearchesforastring thatsatis-
esagivensetofstring constrain tsbybounding thestring
length. Thistypeofbounded analysis cannot beusedfor
sound string analysis whereas thestring analysis techniques
wepresen tinthispaperaresound. Inourearlier work,
wehaveusedsingle-trac kDFAbased symbolicreachabilit y
analysis toverifythecorrectness ofstring sanitization op-
erations inPHPprograms [18,17].Ourpreliminary results
ongenerating (non-relational) vulnerabilit ysignatures us-
ingsingle-trac kDFAwerereported earlier [16]. Recen tly,
wealsoreported ourresults onfoundations ofstring analy-
sisusing multi-trac kautomata [19].These earlier results do
notaddress thesanitization synthesis problem wediscuss in
thispaper.Moreo ver,tothebestofourknowledge thisis
therstpaperthatpresen tsarelational vulnerabilit ysigna-
ture(i.e.,avulnerabilit ysignature thatinvolvesmore than
oneinput) generation technique forstrings.
There hasbeenprevious workonautomatically generating
lters forblockingbadinput [6].Although thisissimilar to
ourmatch-and-blo ckstrategy ,there areseveralsignican t
dierences withourwork.First, earlier work[6]focuses on
buer-o verowvulnerabilities whicharedieren tthanthe
string vulnerabilities weinvestigate here. Second, inear-
lierwork[6]thegeneration oflters isdonestarting with
anexisting exploit, whereas westart withanattackpat-
tern. Finally ,unlikeprior results, inthispaper,wegen-
erate sanitization statemen tsthatrepair badinputs using
thematch-and-sanitize strategy .Wealsogiveanautomata-
theoretic characterization ofthematch-and-sanitize strat-
egy,provethatgenerating optim ummodications isanin-
tractable problem, andpresen taheuristic approac hbased
onamin-cut algorithm.
2.ANOVER VIEW
Consider thePHP script showninFigure 1.Thisscript
starts withassigning theuserinput provided inthe_GETar-
raytothevariablenameinline2.Itconcatenates aconstan t
string withvariablenameandassigns ittoanother variable
outinline3.Then itsimply outputs thevariableoutusing
theechostatemen tinline4.
Theechostatemen tinline4isasinkstatemen tsince it
cancontainaCross SiteScripting (XSS) vulnerabilit y.For
example, amalicious usercanprovideaninput thatcontains
thestring constan t<script andexecute acommand leading
toaXSSattack.Inorder topreventthisvulnerabilit y,it
isnecessary tosanitize theuserinputs before using theminanechostatemen t.Intherestofthissection wegive
anoverview ofhowourapproac hautomatically detects this
vulnerabilit yandgenerates thesanitization statemen t.Let
usassume thattheattackpattern forthisvulnerabilit yis
specied using thefollowing regular expression <
(where denotes anyASCIIcharacter).
Vulnerabilit yAnalysis: Werstperform aforwardsym-
bolicreachabilit yanalysis thatusesoneDFAforeachvari-
ableateachprogram pointtorepresen tthesetofvaluesthat
thevariables cantake.During forwardanalysis weitera-
tivelyupdatetheseDFAsbycomputing post-conditions (for-
wardimage) ofprogram statemen ts.Forexample ourpost-
condition computation foranassignmen tstatemen ttakes
asetofDFAscharacterizing thevalues ofthestring vari-
ables attheright-hand-side oftheassignmen t(before the
assignmen tisexecuted) asinput, andreturns aDFAchar-
acterizing thepossible values oftheleft-hand-side variable
aftertheassignmen tstatemen tisexecuted.
During forwardanalysis wecharacterize alltheuserinput
as,i.e.,theusercanprovideanystring asinput. Any
variable thatisassigned aninput isrepresen tedbyaDFA
thataccepts thelanguage atthenextprogram pointaf-
tertheassignmen t.Forexample forthesmall script shown
inFigure 1,ourforwardanalysis willgenerate aDFAfor
thevariablenameatthebeginning ofstatemen t3thatac-
cepts thelanguage .Computing thepost-condition of
thestatemen t3willgenerate aDFAforthevariableout
atthebeginning ofstatemen t4thataccepts thelanguage
NAME:.When oursymbolicreachabilit yanalysis reaches
axpointeachstring variable ateachprogram pointisas-
sociated withaDFAthatcharacterizes allpossible values
thatvariable cantakeatthatprogram point.Ouranalysis
isconserv ativeinthesense thattheresulting DFAsaccept
anover-appro ximation ofallpossible valuesofthevariables
theyrepresen t.Notethatapproximation isinevitable since
string analysis problem isundecidable [19].
When ourforwardanalysis converges, wetaketheinter-
section (using automata product) ofthelanguage oftheDFA
thatcorresp ondstothestring expression atthesinkstate-
mentwiththeattackpattern. Inourrunning example state-
ment3isasinkstatemen t,andtheDFAthatcorresp ondsto
thestring expression atline4(whichissimply thevariable
out)accepts thelanguage NAME:.When wetakethein-
tersection ofthislanguage withtheattackpattern weobtain
anautomaton thataccepts thelanguage NAME:<.
Thisautomaton characterizes allpossible attackstrings at
thesinkstatemen t.Since thelanguage ofthisautomaton is
notempty,weknowthattheprogram isvulnerable.
Vulnerabilit ySignature Generation: Next, wegure
outwhichinput values cancreate theattackstrings atthe
sinkstatemen t.Inoursingle-trac kDFAbased approac h,
thisisdonewithabackwardsymbolicreachabilit yanaly-
sis.WestartwiththeDFAthatcharacterizes theattack
strings (i.e,theDFAwecompute attheendofthevulnera-
bilityanalysis) andpropagate theresults backwardsuntilwe
reachaninput. During backwardanalysis weiterativ elyup-
datethese DFAsbycomputing pre-condition (backwardim-
age)ofprogram statemen ts.Forexample ourpre-condition
computation foranassignmen tstatemen ttakesaDFAchar-
acterizing thevalues ofthestring variable attheleft-hand-
sideoftheassignmen t(after theassignmen tisexecuted) as
input, andreturns asetofDFAscharacterizing thepossi-1<?php
1.1if(preg_match(
'/([=-\xfd]|[\x00-;])*<([\x00-\xfd])*/',$_GET ["name"]))
1.2 die("Invalid input");
2$name=$_GET["name"];
3$out="NAME:".$name;
4echo$out;
5?>
(a)Patch1using match-and-blo ckstrategy
1<?php
1.1if(preg_match(
'/([=-\xfd]|[\x00-;])*<([\x00-\xfd])*/',$_GET ["name"]))
1.2 $_GET["name"] =
preg_replace('/</',"",$_GET["name"]);
2$name=$_GET["name"];
3$out="NAME:".$name;
4echo$out;
5?>
(b)Patch2using match-and-sanitize strategy
Figure 2:Patchesfortheexample inFigure 1
1<-<
min cut21(<,) (   ,) (   -<,  ) min cut
2
(  ,   )(  ,-<)
(  ,-<)(  ,   ) ( ,<) 
( ,<) 3
4
(a) (b)
Figure 3:Vulnerabilit ysignatures
blevaluesofthevariables thatareattheright-hand-side of
theassignmen tbeforetheassignmen tstatemen tisexecuted.
Fortheexample showninFigure 1,ourbackwardanalysis
computes thepre-condition fortheassignmen tstatemen tin
line3andgenerates aDFAforthevariablenameattheend
ofstatemen t3thataccepts thelanguage <.When
wecompute thepre-condition oftheassignmen tstatemen t
inline2wereachaninput andgenerate thevulnerabilit y
signature fortheinput_GET["name"] asaDFAthataccepts
thelanguage <.
Sanitization Generation: Thelastphase ofouranalysis
generates apatchthatremovesthevulnerabilit y.Thevul-
nerabilit ysignature givesanover-appro ximation ofallpos-
sibleinput valuesthatcanexploit thevulnerabilit y.Hence,
ifwedonotallowinput values thatmatchthevulnerabil-
itysignature thenwecanremovethevulnerabilit y.Inour
match-and-blo ckstrategy wegenerate apatchthatsimply
checksiftheinput string matchesthevulnerabilit ysigna-
ture. Ifitdoes,ithalts theexecution without executing
therestofthescript. Thepatchgenerated forthesmall
example inFigure 1based onthevulnerabilit ysignature
<andusing thematch-and-blo ckstrategy isshown
inFigure 2(a). Notethatthepatchedscript willblockany
input string thatcontainsthesymbol<.
Inourmatch-and-sanitize strategy ,instead ofblockingthe
execution, wemodifytheinput inaminimal waytoguar-
anteethatthemodied input cannot leadtoanyattack
strings. Wedothisbyanalyzing thevulnerabilit ysigna-
tureDFA.Consider theDFAforthevulnerabilit ysignature
<showninFigure 3(a)(weuse <toindicate
anysymbolother than<).Ourgoalistondaminimal set
ofcharacters, suchthatifweremovethose characters froma
givenstring, theresulting string willnotbeaccepted bythe
DFA.Aswediscuss inSection 3,thiscorresp ondstonding1<?php
2$title=$_GET["title"];
3$name=$_GET["name"];
4$out="NAME:".$title.$name;
5echo$out;
6?>
Figure 4:Another Simple Example
acutinthegraph dened bythestates andthetransitions
oftheDFA,i.e.,nding asetofedges suchthatwhen we
removethem, there arenopaths leftinthegraph fromthe
initial stateoftheDFAtoanalstate. Notethateachedge
oftheDFAislabeledwithasymbol.After wendacut,if
wetaketheunion ofthesymbolsoftheedges inthecut,we
obtain asetofsymbolssuchthatanystring accepted bythe
DFAmustinclude atleastoneofthesymbolsinthatset.
Weuseamin-cut algorithm tocompute acutthatcon-
tainsminim umnumberofedges. Then wegenerate apatch
thatdeletes allthecharacters fromtheinput thatappear
ontheedges included inthecutset.FortheDFAshownin
Figure 3(a),themin-cut algorithm returns thesingle edge
labeledwiththesymbol<.Sowegenerate apatchthat
deletes allthe<symbolsfromtheinput asshowninFig-
ure2(b). Notethat,unlikethepatchshowninFigure 2(a),
thepatchgenerated based onthematch-and-sanitize strat-
egycontinuestoexecute thescript afterthesanitization.
Relational Vulnerabilit ySignature Generation: Con-
siderthesimple script showninFigure 4.Thisexample is
similar totheoneshowninFigure 1withonesignican tdif-
ference: there aretwoinput variables thatbothcontribute
tothestring expression usedatthesinkstatemen tatline5.
Assume thatweuseoursingle-trac kautomata based anal-
ysisdescrib edabovetoanalyze thisscript. Thesetofat-
tackstrings generated forthesinkstatemen tatline5will
again be:NAME:<.However,theresult oftheback-
wardanalysis willbedieren t.Thecrucial stepisthepre-
condition computation forthestatemen tinline4.Thein-
puttothispre-condition computation willbeaDFAthat
accepts theattackstrings characterized bytheregular ex-
pression givenabove.Theresult ofthepre-condition com-
putation willgenerate twoDFAs,oneforthevariablename
andoneforthevariabletitle,andthese DFAswillchar-
acterize allpossible valuesthese twovariables cantakejust
beforetheexecution ofstatemen tinline4thatcanleadto
generation ofanattackstring atthesinkstatemen tinline
5.When wedothispre-condition computation wegettwo
DFAsthataccept thesame language ,i.e.,anyvalueof
either variable canleadtoanattackstring. Although this
isasound approximation itfailstocapture theinformation
thatatleastoneofthesevariables should contain thechar-
acter <.Notethatthiscondition cannot beexpressed asa
constrain tonanindividual variable, itidentiesarelation
betweenthetwostring variables.
Ourrelational analysis usesasingle multi-trac kautoma-
ton(MDF A)foreachprogram pointtocapture therelation-
shipbetweentheinput values andpossible values ofstring
expressions intheprogram. Weuseaforwardanalysis that
operates onthedependency graph. Weshowthedepen-
dency graph fortheexample fromFigure 4inFigure 5.We
write thestring expression intheprogram thatcorresp onds
toeachnodeinthedependency graph totheleftsideof
thenodeandalsogivethelinenumber.Ouranalysis starts
fromtheinput nodesandtraversesthedependency graph
while generating oneMDFAforeachinternal nodeofthede-i1$_GET[â€œnameâ€] $_GET[â€œtitleâ€]
$name 
(line 3)$title 
(line 2)i2
n1 n2 n1 = i1 n2 = i2
n3n3 = i1 . i2 $title . $name 
(line 4)
â€œNAME : â€œ . $title . $name
(line 4)n5n5 =  â€œNAME : â€œ . i1 . i2n4 â€œNAME : â€œ
(line 4)
n6n6 =  â€œNAME : â€œ . i1 . i2$out 
(lines 4, 5)
Figure 5:Dependency graph
pendency graph. EachMDFAhasonetrackforeachinput
variable andonetrackforthestring expression thatcorre-
spondstothatnode,andrepresen tstherelation between
them. InFigure 5weshowastring constrain tontheright
sideofeachinternal node.Thatstring constrain tcharacter-
izesthesetofstrings accepted bytheMDFAforthatnode.
Forexample, fornoden3,thestring constrain tisn3=i1:i2
whichindicates thatthestring expression thatcorresp onds
tonoden3isequal totheconcatenation ofinput i1and
input i2.
When theanalysis reachesasinknode,weintersect the
trackthatcorresp ondstothestring expression forthesink
node(inourexample thiswouldbethetrackthatcorre-
spondstonoden6)withtheattackpattern DFA(byex-
tending theattackpattern DFAtoanMDFAbyadding
extra tracksthataccept allstrings). After theintersection,
weprojectawaythetrackforthesinknode,leavingonly
thetracksfortheinput nodes.Theresulting MDFArep-
resentstherelational vulnerabilit ysignature. Forourex-
ample, thevulnerabilit ysignature MDFAisshowninFig-
ure3(b)(where eachtransition ismarkedwithtwosymbols,
oneforeachtrack,andifatrackismarkedwiththesym-
bolthenthatmeans thatnosymbolfromthattrackis
consumed when thattransition istaken). Note thatthis
automaton accepts tuples ofstrings, where either therst
string inthetuple orthesecond string inthetuple contains
atleastone<symbol.
ThepatchesshowninFigure 2forthesingle input caseare
generated byconverting thestandard DFArepresen tation
toaregular expression andthenusing thePHPpreg_match
function togenerate thematchpartofthepatch.Forthere-
lational case,when wegenerate tworegular expressions, one
foreachinput, fromtheautomaton showninFigure 3(b),
weagain getforbothinputs, soallinputs match.Thisis
acceptable ifweusethematch-and-sanitize strategy since,
although alltheinput strings willbeconsidered potentially
vulnerable, onlyasmall setofsymbolsthatrelate tothe
vulnerabilit ywillbereplaced. Forexample, thepatchgen-
erated using thisapproac hfortheexample inFigure 4is
showninFigure 6.However,ifweusethematch-and-blo ck
approac husing theregular expression ,wewillblockall
theinputs whichisnotacceptable. Aswediscuss inSec-
tion3,insuchcasesitisnecessary togenerate matchstate-
mentsthatuseautomata simulation instead ofautomata to
regular expression conversion.
Inorder togenerate thesanitization statemen tsfromre-
lational vulnerabilit ysignatures, wendamin-cut inthe
vulnerabilit ysignature MDFAaswedidforthesingle-trac k1<?php
1.1if(preg_match('/([\x00-\xfd])*/', $_GET["title"])
andpreg_match('/([\x00-\xfd])*/', $_GET["name"])) {
1.2 $_GET["title"] =
preg_replace('/</',"",$_GET["title"]);
1.3 $_GET["name"] =
preg_replace('/</',"",$_GET["name"]); }
2$title=$_GET["title"];
3$name=$_GET["name"];
4$out="NAME:".$title.$name;
5echo$out;
6?>
Figure 6:Patchfortheexample fromFigure 4
case.Then, foreachtrack,wetaketheunion ofthesymbols
onthattrackforalltheedges inthemin-cut. Inorder tosan-
itizetheinput weneedtoremovethesymbolsforeachtrack
fromtheinput thatcorresp ondstothattrack.Forexam-
ple,based onthemin-cut showninFigure 3(b),weneedto
delete thesymbol<bothfromtheinputs_GET["name"] and
_GET["title"] .Theautomatically generated replace state-
mentsforthisexample areshowninFigure 6.
3.SANITIZA TION GENERA TION
Inthissection wedescrib ehowwegenerate sanitization
statemen tsgivenavulnerabilit ysignature thatischaracter-
izedeither asastandard single-trac kautomaton (DFA)or
amulti-trac kautomaton (MDF A).Wediscuss thedetails of
vulnerabilit ysignature generation inlatersections.
Inorder toimplemen tthematch-and-blo ckandmatch-
and-sanitize strategies weneedtogenerate codeforthematch
andreplacestatemen ts.
MatchGeneration: There aretwowaysofdoing match-
ing:1)Regular-expr ession-b asedmatching: Generate areg-
ularexpression from thevulnerabilit ysignature automa-
tonandthenusethePHP function preg_match tocheckif
theinput matchesthegenerated regular expression, or2)
Automata-simulation-b asedmatching: Generate codethat,
givenaninput string, simulates thevulnerabilit ysignature
automaton todetermine iftheinput string isaccepted bythe
vulnerabilit ysignature automaton, i.e.,iftheinput string
matchesthevulnerabilit ysignature.
Wersttriedtheregular-expression-based matchingap-
proach.However,thisapproac hendsupbeingveryine-
cientduetotheimplemen tation ofpreg_match inPHP.The
alphab etofthevulnerabilit ysignature automata consists of
the256ASCIIcharacters andthevulnerabilit ysignature
automata canhavealarge numberofstates ifthere area
lotofcomplex string manipulation operations inthecode.
Inoneoftheexamples weanalyzed thevulnerabilit ysig-
nature automaton consists of811states. Thesizeofthe
regular expression generated fromthevulnerabilit ysigna-
tureautomaton canbeexponentialinthenumberofstates
oftheautomaton [10]. Hence, wemayendupwithvery
large regular expressions. Moreo ver,thepreg_match func-
tioninPHP doesnotonlycheckifagiveninput matches
thegivenregular expression butitalsocomputes allthesub-
strings thatmatchtheparenthesized subexpressions ofthe
givenregular expression. Since theDFAtoregular expres-
sionconversion algorithm cangenerate alotofparenthesized
subexpressions, thismeans thatthepreg_match function will
doalotofunnecessary extra workduring thematch,result-
ingwithaninecien tmatchimplemen tation.
Inorder todoecien tmatchingweusetheDFAsimula-
tionalgorithm whichhaslinear timecomplexit y[10].Giventhevulnerabilit ysignature DFA,wegenerate afunction that
takesastring asinput, simulates theDFA,andreturns true
iftheDFAaccepts thestring orfalseotherwise. Wein-
sertthematchfunction instead ofthepreg_match statemen ts
showninthepatchesinFigures 2and6.
Fortherelational vulnerabilit ysignatures, weuseasimilar
approac h.Givenarelational vulnerabilit ysignature char-
acterized asanMDFA,wegenerate codethatsimulates the
MDFAduring thematchgeneration. TheMDFAsimulation
algorithm issimilar totheDFAsimulation algorithm, itjust
keepsaseparate pointerforeachinput string tokeeptrack
ofhowmuchofeachtrackisprocessed atanygiventime
andadvances thestate oftheMDFAbased onthetuples
ofinput symbolsandthetransition relation oftheMDFA.
Thesimulation timeforMDFAislinear inthetotallength
oftheinput strings.
Replace Generation: Forthematch-and-sanitize strat-
egy,ourautomated sanitization generation algorithm takes
thevulnerabilit ysignature automaton asinput, anditgen-
erates areplace statemen tthatmodies agiveninput string
insuchawaythatthemodied string isnotaccepted by
thethevulnerabilit ysignature automaton (meaning that
themodied string cannot cause anattack).Wemodify
theinput strings byjustdeleting asetofcharacters using
thepreg_replace function (ourapproac hcanbeextended so
thatescapecharacters canbeinserted infrontofasetof
characters rather thandeleting them). Inorder toprevent
extensiv emodication totheinput, thesetofcharacters to
bedeleted should beassmall aspossible. Thequestion is
howcanweidentifythesetofcharacters tobedeleted?
First, wewillformalize thisproblem inautomata-theoretic
terms. LetM=hQ;;;q0;Fidenote aDFAwhere Qis
thesetofstates, isthealphab et,QQisthe
transition relation, q02Qistheinitial state, andFQ
isthesetofaccepting states. L(M)denotes thelanguage
accepted byM.WesaySisanalphab et-cut ofM,if
L(M)\LS=;,where LS=(nS)isthesetofallstrings
thatdonotcontainanycharacter inS.Themin-alphab et-
cutproblem isnding thealphab et-cut Smin,suchthatfor
anyother alphab et-cut S,jSminjjSj.Fortheexample
automaton inFigure 3(a)themin-alphab et-cut isf<g.
Themin-alphab et-cut problem canalsobestated ingraph-
theoretic terms. GivenaDFAM,anedge-cut ofMisaset
oftransitions Esuchthat,ifthesetoftransitions inE
areremovedfromthetransition relation ,thennoneofthe
states inFarereachable fromtheinitial state q0.LetSE
denote thesetofsymbolsofthetransitions inE.IfEisan
edge-cut ofMthenSEisanalphab et-cut ofM.Hence, nd-
ingthemin-alphab et-cut isequivalenttonding anedge-cut
withminim umsetofdistinct symbols.Fortheexample au-
tomaton inFigure 3(a)themin-edge-cut isf(1;<;2)g,which
alsocorresp ondstothemin-alphab et-cut.
Notethat,ifthevulnerabilit ysignature DFAaccepts the
emptystring, thenthere willnotbeanyedge(oralphab et)
cutsincetheinitial statewouldbeanaccepting state. For
therestofourdiscussion wewillassume thattheDFAfor
thevulnerabilit ysignature doesnotaccept theemptystring
(wecaneasily handle thecases where itaccepts theempty
string byrsttesting iftheinput string isemptyandthen
inserting asingle character totheinput ifitis).
Theorem: Themin-alphab et-cut problem isNP-har d.
Weprovethisbyareduction fromthevertexcoverproblem.Avertexcoverofagraph G=(V;E)isasetofvertices such
thateachedgeofthegraph isinciden ttoatleastonevertex
oftheset.Theproblem ofnding aminim umvertex cover
isknowntobeNP-complete. Vertex coverproblem canbe
reduced tothemin-alphab et-cut problem asfollows.Given
G=(V;E)webuildanautomaton M=hQ;;;q0;Fiwith
thesetofstates Q=E[fq0;qFg,theinitial stateq0,setof
nalstates F=fqFg,alphab et=V,andthetransition
relation dened asfollows:e=(v;v0)2E)(q0;v;e)2
^(e;v0;qF)2.Themin-alphab et-cut fortheautomaton
Mistheminim umvertex coverforthegraph G.
Since themin-alphab et-cut problem isintractable, rather
thantrying tondtheoptim umsolution, wecanconsider
using ecien theuristics thatgiveareasonably small cut
thatisnotnecessarily theoptim umsolution. Infact,there
isaverygoodcandidate foraheuristic solution. Given
aDFAM,amin-edge-cut ofMisanedge-cut Eminsuch
thatforanyother edge-cut E,jEminjjEj.Notethatthe
min-edge-cut minimizes thenumberofedges intheedge-cut
whereas themin-alphab et-cut minimizes thesetofsymbols
ontheedges intheedge-cut. Interestingly ,eventhough
themin-alphab et-cut problem isintractable, there isanef-
cientalgorithm forcomputing themin-edge-cut. Weuse
theFord-Fulkerson's max-o wmin-cut algorithm [5]tond
amin-edge-cut Eminwhere thecomplexit yofthealgorithm
isO(jj2).Note thatjSminjjEminj,i.e.,themin-edge-
cutprovides andupperboundforthemin-alphab et-cut. So
ifthemin-edge-cut issmall, thenthesetofdistinct sym-
bolsontheedges ofthemin-edge-cut willgiveusagood
approximation oftheSmin.
Once wecompute analphab et-cut Susing ourheuristic,
wegenerate apreg_replace statemen tthatdeletes thesym-
bolsinSfrom theinput, making surethattheresulting
string doesnotmatchthevulnerabilit ysignature.
Thedenition ofthemin-alphab et-cut problem isdieren t
formulti-trac kautomata. Givenann-trackMDFAMover
([)n,wesayann-tuple S=(S1;:::Sn),where Si,
isanalphab et-cut ofM,ifL(M)\LS=;,where LS=
(((nS1)[):::((nSn)[)))isthesetofallstrings
whose ithtrackdoesnotcontainanycharacter inSi.Let
jSj=jS1j+:::+jSnj.Themin-alphab et-cut problem fora
MDFAMisnding thealphab etcutSminofM,suchthat
foranyalphab etcutSofM,jSminjjSj.
Since min-alphab et-cut isintractable forsingle-trac kDFA,
itisalsointractable forMDFA.Weusemin-edge-cut alsoas
anapproximation formin-alphab et-cut forMDFA.When we
ndamin-edge-cut, wecompute thecorresp onding multi-
trackalphab et-cut bycomputing asetofsymbolsforeach
trackbycollecting thesetofdistinct symbols(other than
)oneachtrackontheedges inthemin-edge-cut. There-
sulting alphab etcutisann-tuple S=(S1;:::;Sn),where
eachSiisthesetofsymbolsfortracki,i.e.,input i.For
theexample automaton inFigure 3(b),themin-edge-cut is
f(1;(<;);3);(1;(;<);4);(2;(;<);4)g,whichalsocorre-
spondstothemin-alphab et-cut (f<g;f<g).
Once wecompute thealphab et-cuts, wegenerate one
preg_replace statemen tforeachinput variable i,thatdeletes
everysymbolinSifromtheinput isothattheresulting in-
putstrings donotmatchthevulnerabilit ysignature.
4.VULNERABILITY ANALYSIS
Inthissection werstdene thedependency graphs and
thendescrib eourvulnerabilit yanalysis. Adependency graphG=hN;Eiisadirected graph, where Nisanite setof
nodesandENNisanite setofdirected edges. An
edge(ni;nj)2Eidenties thatthevalueofnjdepends
onthevalueofni,e.g.,assign thevalueofthevariable as-
sociated withnitothevariable associated withnjinthe
program. Eachnoden2Ncanbe(1)anormal nodein-
cluding input,constant ,variable ,or(2)anoperation node
including concat andreplace .
Aninput nodeidentiesthedatafromuntrusted parties,
e.g.,aninput fromwebforms. Aconstant nodeisassociated
withaconstan tvalue.Bothnodeshavenopredecessors.
Aconcat nodenhastwopredecessors: theprex node
(n:p)andthesux node(n:s),andstores theconcatenation
ofanyvalueoftheprex nodeandanyvalueofthesux
nodeinn.
Areplace nodehasthree predecessors: thetarget node
(n:t),thematchnode(n:m),andthereplacemen tnode
(n:r).Foreachvalueofn:tit:(1)identiesallthematches,
i.e.,anyvalueofn:m,thatappearinn:t,(2)replaces all
these matchesinn:twithanyvalueofn:r,and(3)stores
theresult inn.
Forn2N,Succ(n)=fn0j(n;n0)2Egistheset
ofsuccessors ofn.Pred(n)=fn0j(n0;n)2Egisthe
setofpredecessors ofn.Foradependency graph G,we
alsodene Root(G)=fnjPred(n)=;gandLeaf(G)=
fnjSucc(n)=;g.
Ourvulnerabilit yanalysis takesthefollowing inputs: a
dependency graph (G),asetofsinknodes(Sink),andan
attackpattern (Attk).Sinkdenotes thenodesthatareas-
sociated withsensitiv efunctions thatmightleadtovulner-
abilities. Attkisaregular expression represen tedasaDFA.
Ourvulnerabilit yanalysis approximates thesetofstring
values asaregular language andrepresen tsthem symbol-
ically asaDFAthataccepts thatlanguage. Toassociate
eachnodewithitsautomata, wecreate twoautomata vec-
torsPOST andPRE.Thesizeofbothisbounded byjNj.
POST [n]istheDFAaccepting allpossible valuesthatnode
ncantake.PRE[n]istheDFAaccepting allpossible values
thatnodencantaketoexploit thevulnerabilit y.Initially ,
allthese automata accept nothing, i.e.,their language is
empty.VulSinkisthesetofvulnerable program points
andinitially issettoanemptyset.
Weuseaforwardsymbolicreachabilit yanalysis based on
astandard workqueue algorithm. Weiterativ elyupdatethe
automata vectorPOST untilaxpointisreached.Atline
7,constr uct(n)returns aDFAthat: (1)accepts arbitrary
strings ifnisaninput node,(2)accepts anemptystring if
nisavariable node,or(3)accepts theconstan tvalueifn
isaconstant node.Atlines9and11,weincorp orate two
automata-based string manipulating functions [18]:
conca t(DFAM1,DFAM2)returns aDFAMthataccepts
fw1w2jw12L(M1);w22L(M2)g.
repla ce(DFAM1,DFAM2,DFAM3)returns aDFAM
that accepts fw1c1w2c2:::wkckwk+1jk>0;
w1x1w2x2:::wkxkwk+12L(M1);8i,xi2L(M2);widoes
notcontainanysubstring accepted byM2;ci2L(M3)g.
Atline15,weincorp orate theautomata widening operator
r[2]toaccelerate thexpointcomputation, whichensures
termination andreturns theleastxpointunder certain con-
ditions. Upontermination ofthewhile loop(lines 4to20)
POST [n]records theDFAwhose language includes allpos-
siblevalues thatncantake.Algorithm 1vulAnal ysis(G;Sink;Attk)
1:Init(POST ;PRE);
2:queue WQ:=NULL;
3:WQ.enqueue( Root(G));
4:while WQ6=NULLdo
5: n:=WQ.dequeue();
6:ifn2Root(G)then
7: tmp:=constr uct(n);
8:elseifnisconcat then
9: tmp:=conca t(POST [n:p],POST [n:s]);
10: elseifnisreplace then
11: tmp:=repla ce(POST [n:t],POST [n:m],POST [n:r]);
12: else
13: tmp:=S
n02Pred(n)POST [n0];
14: endif
15: tmp:=(tmp[POST [n])rPOST [n];
16: iftmp6POST [n]then
17: POST [n]:=tmp;
18: WQ.enqueue( Succ(n));
19: endif
20:endwhile
21:setVul:=fg;
22:foreachn2Sinkdo
23: tmp:=POST [n]\Attk;
24: ifL(tmp)6=;then
25: Vul:=Vul[fng;
26: PRE[n]:=tmp;
27: endif
28:endfor
29:return Vul;
Intheforloop(lines 22to28),foreachnoden2Sink,we
generate aDFAtmpbyintersecting theattackpattern and
thepossible valuesofn.IfL(tmp)isnotempty,weidentify
thatnisavulnerable program pointandaddittoVulatline
25.Infact,tmpaccepts thesetofreachable attackstrings at
nodenthatcanbeusedtoexploit thevulnerabilit y.Hence,
weassign tmptoPRE[n]atline26.Thisinformation isthen
passed toourvulnerabilit ysignature generation algorithm.
5.VULNERABILITY SIGN ATURES
Inthissection wepresen tournon-relational vulnerabil-
itysignature generation algorithm (Algorithm 2)whichisa
backwardsymbolicreachabilit ycomputation based onsingle-
trackDFAs.Forn2Vul,PRE[n]issettotheintersection of
POST [n]andAttkduring thevulnerabilit yanalysis phase
before thebackwardanalysis starts. Thepredecessors of
n2Vularethestarting pointsofthebackwardanalysis.
Similar totheforwardanalysis, thecomputation isbased
onastandard workqueue algorithm.
Werstputthepredecessors ofn2Vulintothework
queue asshownatline2-4.Weiterativ elyupdatethePRE
array(byadding pre-images) untilwereachaxpoint.Ifthe
successor ofnisanoperation node,thepre-image (tmp)of
niscomputed inlines11,13and17bycalling thedened
automata-based functions: preConca tPrefix ,preConca t-
Suffix ,andpreRepla cewhichwedene below.Otherwise,
thepre-image ofnisdirectly derivedfromthesuccessor ofn
(line20).NotethatPOST [n]records allpossible valuesthat
ncantake.Weusethisinformation during thepre-image
computation byrestricting theargumen tsofoperations such
asreplace .Weunion thepre-images ofnastmp0atline22.
Since weareinterested onlyinreachable valuesofn,i.e.,
PRE[n]POST [n]bydenition, weintersect tmp0with
POST [n]atline24.Similar totheforwardanalysis, we
widen theresult atline25toaccelerate thexpointcom-
putation. Atline26,weintersect tmp0withPOST [n]again
toremoveunreac hable values (that mighthavebeenintro-Algorithm 2VulSigGen( G;POST ;PRE;Vul)
1:queue WQ=NULL;
2:foreachn2Vuldo
3: WQ.enqueue( Pred(n));
4:endfor
5:while WQ6=NULLdo
6: n:=WQ.dequeue();
7: tmp0:=NULL;
8:foreachn02Succ(n)do
9: ifn0isconcat then
10: ifnisn0:lthen
11: tmp:=preConca tPrefix (PRE[n0],POST [n0:r]);
12: else
13: tmp:=preConca tSuffix (PRE[n0],POST [n0:l]);
14: endif
15: elseifn0isreplace then
16: ifnisn0:tthen
17: tmp :=preRepla ce(PRE[n0],POST [n0:m],
POST [n0:r]);
18: endif
19: else
20: tmp:=PRE[n0];
21: endif
22: tmp0:=tmp0[tmp;
23: endfor
24: tmp0:=tmp0\POST [n];
25: tmp0:=(tmp0[PRE[n])rPRE[n];
26: tmp0:=tmp0\POST [n];
27: iftmp06PRE[n]then
28: PRE[n]:=tmp0;
29: WQ.enqueue( Pred(n));
30: endif
31:endwhile
32:return PRE;
duced duetowidening) atnoden.Iftmp0accepts more
values thanPRE[n],weupdatePRE[n]atline28andadd
thepredecessors ofntotheworking queue atline29.Upon
termination, PRE[n]records theDFAthataccepts allpossi-
blevaluesofnthatmayexploit theidentied vulnerabilit y.
Pre-image Computation: Below,weexplain howwecom-
putethefollowingpre-image functions:
preConca tPrefix (DFAM,DFAM2)returns aDFAM1
sothatM=conca t(M1;M2).
preConca tSuffix (DFAM,DFAM1)returns aDFAM2
sothatM=conca t(M1;M2).
preRepla ce(DFAM,M2,M3)returns aDFAM1sothat
M=repla ce(M1;M2;M3).
Concatenation: Tocompute thepre-image ofconcate-
nation nodes,weintroduce concatenation transducers to
specifytherelation among itsoutput andtwoinput nodes.
Transducers aremulti-trac kautomata weuseforimage com-
putation (these aredieren tthanthemulti-trac kautomata
weuseforrelational vulnerabilit ysignature generation in
thenextSection). Aconcatenation transducer isaMDFA
overthealphab etthatconsists of3tracks.The3-trac k
alphab etisdened as3=([fg)([fg),
where 62isaspecialsymbolforpadding. Weusew[i]
(1i3)todenote theithtrackofw23.Alltracks
arealigned. w[1]2,w[2]2isleftjustied, and
w[3]2isrightjustied. Weusew0[2];w0[3]2to
denote the-freeprex ofw[2]andthe-freesux ofw[3].
Wesaywisaccepted byaconcatenation transducer Mif
w[1]=w0[2]:w0[3].Since aconcatenation transducer binds
thevaluesofdieren ttrackscharacter bycharacter itisable
toidentifytheprex andsux relations precisely .
Hereweonlyconsider howtocompute thepre-image oftheprex node,i.e.,YinX:=YZ,givenregular setschar-
acterizing possible valuesoftheoutput nodeXandthesux
nodeZ.Thepre-image ofthesux nodecanbecomputed
inasimilar way.LetMxandMz,accept valuesofXandZ
respectively.preConca tPrefix (Mx,Mz)returns Mywhich
isconstructed using thefollowingsteps:
Extend Mxtoa3-trac kDFAM0,sothatM0accepts
fwjw[1]2L(Mx)g.
Construct theconcatenation transducer Mthataccepts
fwjw[1]=w0[2]:w0[3];w0[3]2L(Mz)g.
Intersect M0with M.Theresult accepts fwjw[1]=
w0[2]:w0[3];w[1]2L(Mx);w0[3]2L(Mz)g.Wethenproject
awaytherstandthethird tracks.
Removetailsifanytoconstruct My.
Replacemen t:Recall thatareplace nodehasthree input
nodes:target, match,andreplacemen t.Letusconsider the
pre-image ofthetarget nodegivenregular setscharacter-
izingpossible values oftheoutput node,thematchnode,
andthereplacemen tnode.LetMx=repla ce(Mt,Mm,
Mr),thenourgoalistocompute Mt,givenMx;Mm;and
Mr.Weconserv ativelymodelpreRepla ce(Mx,Mm,Mr)as
repla ce(Mx,Mr,Mm[Mr).Theresult isanoverapprox-
imation ofthepre-image ofthetarget node.
6.RELA TION ALSIGN ATURES
Arelational vulnerabilit ysignature Mofninputs isa
MDFAoverthen-trackalphab etn,dened as(fg)
:::(fg)(ntimes), where 62isthespecialsymbol
forpadding. Wefurther restrict M,sothatalltracksare
aligned andforanyw2L(M),w[i]2(1in).
Letw0[i]denote thelongest -freesubstring ofw[i].
Givenadependency graph G,asetofinput nodesIn,a
sinknodesink,andanattackpattern Attk,ourgoalisto
generate arelational vulnerabilit ysignature Msuchthat:
(1)MisajInj-trackMDFA.Eachtrackisassociated with
aninput variable Xn,n2In.(2)Foranywordw(w[i]2
),wehavew2L(M)ifthefollowingcondition holds:
ifwesetw0[i]astheinitial valueoftheinput nodeiand
propagate thevaluesofthenodesalong withGaccordingly ,
thevalueofthenodesinkmatchesthepattern Attk.I.e.,
widenties themalicious inputs whose combination may
exploit thevulnerabilit y.
Thealgorithm togenerate arelational vulnerabilit ysigna-
tureisshowninAlgorithm 3.Weperform forwar dxpoint
computation onthedependency graph wherereplace nodes
areignored. Ourrelational vulnerabilit ysignature algorithm
isnotcapable ofhandling replace statemen ts.However,
since werunthevulnerabilit ysignature generation aftera
vulnerabilit yisdetected, weargue thatitisreasonable to
ignore thesanitization statemen tsinthecode(whichisthe
typical useforthereplace statemen ts).After wegenerate
therelational vulnerabilit ysignature, theexisting sanitiza-
tionstatemen tscanbecommen tedoutandreplaced with
theautomatically generated sanitization statemen ts.
Similar totheother analyses wepresen ted,weuseastan-
dardworkqueue algorithm incorp orating theautomata widen-
ingoperator. Eachnodeisassociated withasignature, a
i+1-trac kMDFAwhere therstitracksareassociated with
some input variables, e.g.,Xn;n2In,andthelasttrack
(output track)isassociated withXousedtorepresen tthe
valuesofthecurren tnode.More specically ,i(0ijInj)
isthenumberoftheinput variables whose valueshavebeenusedtoconstruct thevalues ofthecurren tnode.Weusea
MDFAvector Swhere S[n]isthesignature associated with
nodenanditspecies therelations among thevaluesofthe
input variables andthevaluesofn.
Initially ,foreachinput noden2In,S[n]isa2-trac k
MDFA(associated withXnandXo)thataccepts theiden-
tityrelation onXnandXo,i.e.,thevalueofthecurren t
nodeisequal tothevalueoftheinput variable Xn.Fora
noden2Root(G)nIn,S[n]isasingle-trac kDFA(associ-
atedwithXo)thateither accepts ifnisavariable node,
oraccepts aconstan tvalueifnisaconstant node.I.e.,the
curren tvalueofthenodeisanarbitrary string oraconstan t.
Inbothcases, itisnotrelated toanyinput variable. For
therest,i.e.,n62Root(G),S[n]accepts anemptyset.
After weinitialize Satline1,weperform thexpoint
computation. Betweenlines6and18,weiterativ elyupdate
thesignature ateachnodeuntilthequeue isempty(reaching
axpoint).Todealwiththeunion orwidening operator on
S1andS2thatmaybeassociated withthedieren tsetsof
input variables, sayX1andX2,weextend bothtracksto
X1[X2andXobypadding sintheadded tracks.We
thenapply standard union orwidening tothese extended
MDFAs.
Belowwedescrib ehowtoconcatenate twosignatures:
Conca tSigna ture(S1,S2),where S1isthesignature ofthe
prex nodeandS2isthesignature ofthesux node.Let
S1=hQ1;1;1;I1;F1ibeaMDFAwhose tracksareas-
sociated withthesetofinput variables X1andXowhere
1=([)jX1j.LetS2beaMDFAwhose tracksare
associated withthesetofinput variables X2andXowhere
2=([)jX2j.Werstextend S1andS2totwo
MDFAS
1andS
2thatareassociated withX1[X2and
Xo.Weextend S1(prex) toS
1byadding intheadded
tracks,while weextend S2(sux) toS
2byadding in
boththeadded tracksandthecommon tracksthatarealso
associated withS1.Conca tSigna ture(S1,S2)returns the
(jX1[X2j+1)-trac kMDFAthataccepts theconcatenation
ofS
1andS
2.
After reachingaxpoint,atline19,weintersect thesig-
nature ofsinkwiththeattackpattern ontheoutput track.
LetMAttkaccepts fwjw[Xo]2Attkg.Thisisdone by
thestandard intersection ofS[sink]andMAttk.After the
intersection, theoutput trackidentiesthereachable attack
strings, andtheinput tracksidentifyallthemalicious inputs
whose combination canyieldanattackstring. Atline20,
weprojectawaytheoutput trackfromM,andreturn the
result atline21astherelational vulnerabilit ysignature of
hG;In;sink;Attki.
7.EXPERIMENTS
Werstevaluated ourapproac hforXSSvulnerabilities
using veknownexamples. Then weapplied ouranalysis to
three opensource webapplications tosearchforXSSand
SQLI vulnerabilities. Inourexperimen tsweusedanIntel
machinewith3.0GHzprocessor and4GBofmemory run-
ningUbuntuLinux8.04. Weused8bitstoencodeeach
ASCIIcharacter. FortheXSSvulnerabilities thesinks in-
clude theprintf andechofunctions, andfortheSQLI vul-
nerabilities thesinksinclude themysql_query function. We
usedtheattackpattern <SCRIPT (indicating anembed-
dedscript) fortheXSSvulnerabilit yandtheattackpattern
'or1=1(indicating atruecondition inaquery) for
theSQLI vulnerabilit y.Ourapproac hcandealwithanyAlgorithm 3RelSigGen( G;In;sink;Attk)
1:Init(S;G;In);
2:queue WQ:=NULL;
3:forn2In[Root(G)do
4: WQ.enqueue( Succ(n));
5:endfor
6:while WQ6=NULLdo
7: n:=WQ.dequeue();
8:ifnisconcat then
9: tmp:=Conca tSigna ture(S[n:p],S[n:s]);
10: else
11: tmp:=S
n02Pred(n)S[n0];
12: endif
13: tmp:=(tmp[S[n])rS[n];
14: iftmp6S[n]then
15: S[n]:=tmp;
16: WQ.enqueue( Succ(n));
17: endif
18:endwhile
19:M:=S[sink]\MAttk;
20:Projecttheoutput trackawayfrom M;
21:return M;
attackpattern specied asaregular expression.
Forsanitization synthesis ourtoolgenerates matchstate-
mentsasaCextension toPHPthatsimulates thevulnera-
bilitysignature automaton. Forreplace statemen ts,itgen-
erates aPHP function preg_replace todelete characters
thatareidentied bythealphab et-cuts generated fromthe
vulnerabilit ysignature automata.
PatchingKnownVulnerabilities Werstanalyzed ve
benchmarks manuallyextracted from(1)MyEasyMarket-4.1
(ashopping cartprogram), (2)BloggIT-1.0 (ablogengine),
and(3)proManager-0.72 (aprojectmanagemen tsystem).
Eachbenchmark represen tsaknownXSSvulnerabilit y[1]
containing asingle sink. Thedependency graphs ofthese
benchmarks arerather small (around 20-30 nodes)butin-
clude loops,concatenations withlargeconstan ts,andnested
replacemen ts(from customized orPHPbuilt-in sanitization
routines) andrepresen ttypical string manipulation opera-
tionsinPHPwebapplications.
Asexpected, ourvulnerabilit yanalysis reported thatall
benchmarks arevulnerable andreturned thecorresp onding
vulnerabilit ysignature foreachinput. Benchmark 3has
twouserinputs contributing tothevulnerabilit yandwe
generated bothsingle-trac k(denoted as3S)andmulti-trac k
signatures (denoted as3R).Table1showsthenumberof
edges inthemin-edge-cut forthevulnerabilit ysignature au-
tomata wecomputed, andthealphab et-cuts thatcorresp ond
tothese min-edge-cuts.
Sig. 1 2 3S 3R 4 5
#edges 1 8 4 3 4 4
alp.-cut f<gfS;0;"g,f<g,f<gf<;0;"gf<;0;"g
Table1:Minim umEdge andAlphab etCuts
Ourresults showthatourtechniques areveryeectiv e.
Aswecansee,themin-edge-cut results inaverysmall
alphab et-cut, andmanyofthem (1and3R)aretheopti-
mumsolutions. Forbenchmark 3,using single-trac ksigna-
tures (3S), givesthealphab et-cut forbothinputs. I.e.,
weneedtodelete allcharacters. Aswediscussed earlier,
thisisduetothefactthatsingle tracksignatures cannot
keeptherelation among inputs, andaretoocoarse (inthis
case,)tosynthesize practical sanitization code.Onthe
other hand, therelational signature (3R)givestheoptim um
solution deleting only'<'frominput 1andinput 2.Wefavorednon-alphan umeric characters while generating
thealphab et-cuts byincreasing theweightsofthealphan u-
meric characters during themin-cut algorithm (weassume
thatalphan umeric characters aremore likelytorepresen t
normal userinput andweprefer nottodelete them unless
necessary), Thisresulted inhavingnon-alphan umeric char-
acters inallthecutsbutone.Finally ,existing sanitization
routines intheanalyzed applications canaddsome addi-
tional characters tothealphab et-cut duetotheconserv ative
nature ofouranalysis thatover-appro ximates thevulnerabil-
itysignatures. Forexample, in2'`'and'"'areintroduced by
thePHPsanitization routinemysql_real_escape_string .
Analyzing andPatchingOpenSource Applications:
Weapplied ouranalysis tothree opensource PHPwebap-
plications: (1)Webchess 0.9.0 (aserverforplayingchess
overtheinternet) (2)EVE1.0(atrackerforplayersactivit y
foranonline game), and(3)Faqforge 1.3.2 (adocumen t
managemen ttool).Thesizesoftheseapplications areshown
in2.These applications aredownloaded fromsourceforge
andaredirectly analyzed using thetechniques presen tedin
thispaperwithout anymanualmodication.
Application #ofPHPles totalloc#ofsinks
XSS SQLI
1Webchess0.9.0 23 3375 421 140
2 EVE1.0 8 906 114 17
3Faqforge 1.3.2 10 534 375 133
Table2:TheSizesofAnalyzed Applications
Table3summarizes theresults ofourXSSandSQLI vul-
nerabilit yanalyses respectivelyandtheperformance forsig-
nature generation. Stranger discovered55XSSand61
SQLI vulnerabilities inthese applications. InTable3,(sin-
gle,2,3,4)indicates thenumberofdetected vulnerabilities
thathavesingle input, twoinputs, three inputs andfourin-
puts, respectively.Forexample, there are20vulnerabilities
detected inFaqforge andtheyallhavesingle input (denoted
as(20,0,0,0)).That is,foreachvulnerable sink,wehave
onlyoneinput contributing avaluetothesink. Weauto-
matically generate multi-trac ksignatures forvulnerabilities
thathavemultiple inputs, andsingle-trac ksignatures for
vulnerabilities thathavesingle input. There arethree SQLI
vulnerabilities forwhichwewerenotabletosynthesize san-
itization patchesduetothelargenumberofinputs anddue
toaboundintheMONA DFApackageimplemen tation that
limits thenumberoftrackswecandeclare foragivenDFA.
During theSQLI vulnerabilit yanalysis ofFaqforge thetaint
analysis phase doesnotreportanysinks thatdependon
userinputs, soourtooldoesnotexecute anyofthestring
analysis phases anddoesnotreportandvulnerabilities.
Based ontheresults showninTable3,theanalysis cost
seems aordable: thetotaltimeindicates thetotal time
toanalyze allPHP lesinthese applications from start
totheend,whichincludes pre-pro cessing (parsing, depen-
dency andtaintanalyses) timeandstring analysis (vulnera-
bilityanalysis andvulnerabilit ysignature generation) time.
Itranges from8seconds to290seconds. Thefwdtimeindi-
catesthetotaltimetodetect vulnerabilities fromalltainted
sinks (determined byrstrunning ataintanalysis) inall
PHPscripts. Thebwdtimeindicates thetotaltimetogen-
erate single tracksignatures foralldetected vulnerabilities
thathavesingle input, andtherelational timeindicates the
totaltimetogenerate multitracksignatures foralldetected
vulnerabilities thathavemultiple inputs.#ofVul. Time (seconds) Mem(Kb)
(single, 2,3,4) total fwd bwd relational average
XSSVulnerabilit yAnalysis
1 (24,3,0,0) 46.08 1.73 0.92 6.30 16850
2 (0,0,8,0) 288.50 6.80   127.80 125382
3 (20,0,0,0) 7.87 0.22 0.22   9948
SQLI Vulnerabilit yAnalysis
1 (43,3,1,2) 110.7 4.87 12.04 38.03 136790
2 (8,3,0,0) 23.9 1.5 8.47 5.2 17280
3 (0,0,0,0) 6.7       <1
Table3:XSS/SQLI Vulnerabilit yAnalysis Results
Replace performance: Theaverage timespentingen-
erating thealphab et-cut from thevulnerabilit ysignature
automata forXSS(SQLI) was0.06(0.07) seconds perau-
tomaton forWebchess,0.3(0.1)seconds perautomaton for
EVE, and0.05seconds perautomaton forFaqforge. We
notice thatmincut forXSSanalysis results forEVE took
thelargest timeasitcontains onlythree-input signature
automata asapposedtomostly single-input signature au-
tomata intheother two.
Allofthegenerated alphab et-cuts containonlyasingle
character pereachinput. ForeachXSSsingle trackau-
tomata thecutisonlythecharacter '<'whichistheopti-
mumcut(consequen tlytheoptim umsanitization withre-
specttotheattackpattern). Similarly ,fortheXSSrela-
tional signature automata weobtained '<'foreachinput.
Theautomatically generated sanitization (replace) state-
mentsfromouranalysis werealmost thesame astheones
thataremanually written except thattheydelete the'<'
character instead ofreplacing itwiththeHTML entity"&lt;"
asistypically doneinmanualsanitization. FortheSQLI
vulnerabilities, theresults weresimilar, where thereported
cutscontained onlythecharacter '='instead of'<'.
Ouranalysis produces twoartifacts: aPHP extension
thatcontainsastranger_match_* function foreachvulner-
ableinput, andasetofpreg_replace statemen ts,onefor
eachvulnerable input. InPHP,userinputs from$_GET and
$_POST arealwaysavailable attherstprogram pointinthe
script. Thismeans thatwecansanitize theinputs atthe
rstPHPlineofthetarget script. Inserting these callscan
easily beautomated aswehavethelenames foreachof
theinput variables along withthevariables' names fromthe
parsing phase. Notethatweareanalyzing PHPscripts stat-
ically inasound manner where weonlydealwithonescript
atatimealong withallthelesitincludes. Weusedthere-
sultofouranalysis tosanitize thethree applications above
byplacing theautomatically generated sanitization state-
mentsatthebeginning ofeachvulnerable script. Then we
ranourforwardvulnerabilit yanalysis whichreported zero
vulnerabilities withregard totheattackpattern mentioned
abovedemonstrating thatouranalysis sound andguaran tees
thatafterthesanitization statemen tsareinserted, sensitiv e
functions willnotreceiv eanyinput thatmatchestheattack
pattern.
8.CONCLUSIONS
Most critical securit yvulnerabilities inwebapplications
arecaused byinadequate manipulation ofinput strings. In
thispaperwepresen tedasetoftechniques that1)iden-
tifyvulnerabilities thatareduetostring manipulation, 2)
generate acharacterization ofinputs thatcanexploit the
vulnerabilit y,and3)generate sanitization statemen tsthat
eliminate thevulnerabilit y.9.REFERENCES
[1]D.Balzarotti, M.Cova,V.Felmetsger, N.Jovanovic,
C.Kruegel, E.Kirda, andG.Vigna. Saner:
Comp osing Static andDynamic Analysis toValidate
Sanitization inWebApplications. InS&P,pages
387{401, 2008.
[2]C.Bartzis andT.Bultan. Widening arithmetic
automata. InCAV,pages 321{333, 2004.
[3]BRICS. TheMONA project.
http://www.brics.dk/mona/ .
[4]A.S.Christensen, A.Mller, andM.I.Schwartzbac h.
Precise analysis ofstring expressions. InSAS,pages
1{18, 2003.
[5]T.H.Cormen, C.E.Leiserson, andR.L.Rivest.
Introduction toAlgorithms .MITPress, 1990.
[6]M.Costa, M.Castro, L.Zhou, L.Zhang, and
M.Peinado. Bouncer: securing softwarebyblocking
badinput. InSOSP ,pages 117{130, 2007.
[7]X.Fu,X.Lu,B.Peltsverger, S.Chen, K.Qian, and
L.Tao.Astatic analysis framew orkfordetecting sql
injection vulnerabilities. InCOMPSA C,pages 87{96,
2007.
[8]C.Gould, Z.Su,andP.Devanbu.Static checkingof
dynamically generated queries indatabase
applications. InICSE,pages 645{654, 2004.
[9]G.Wassermann andZ.Su.Static detection of
cross-site scripting vulnerabilities. InICSE,pages
171{180, 2008.
[10]J.E.HopcroftandJ.D.Ullman. Introduction to
Automata Theory,Languages andComputation .
Addison-W esley,1979.
[11]N.Jovanovic,C.Krugel,andE.Kirda. Pixy: Astatic
analysis toolfordetecting webapplication
vulnerabilities. InS&P,pages 258{263, 2006.
[12]A.Kiezun, V.Ganesh, P.J.Guo,P.Hooimeijer, and
M.D.Ernst. Hampi: asolverforstring constrain ts.In
ISSTA,pages 105{116, 2009.
[13]Y.Minamide. Static approximation ofdynamically
generated webpages. InWWW ,pages 432{441, 2005.
[14]D.Shannon, S.Hajra,A.Lee,D.Zhan, and
S.Khurshid. Abstracting symbolicexecution with
string analysis. InTAICPART-MUT ATION ,pages
13{22, 2007.
[15]G.Wassermann andZ.Su.Sound andprecise analysis
ofwebapplications forinjection vulnerabilities. In
PLDI,pages 32{41, 2007.
[16]F.Yu,M.Alkhalaf, andT.Bultan. Generating
vulnerabilit ysignatures forstring manipulating
programs using automata-based forwardandbackward
symbolicanalyses. InASE,pages 605{609, 2009.
[17]F.Yu,M.Alkhalaf, andT.Bultan. Stranger: An
automata-based string analysis toolforphp.In
TACAS,pages 154{157, 2010.
[18]F.Yu,T.Bultan, M.Cova,andO.H.Ibarra.
Symbolicstring verication: Anautomata-based
approac h.InSPIN,pages 306{324, 2008.
[19]F.Yu,T.Bultan, andO.H.Ibarra. Relational string
verication using multi-trac kautomata. InCIAA ,
2010.