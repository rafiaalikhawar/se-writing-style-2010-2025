finding incorrect compositions of atomicity pengliu lpxz ust.hkjuliandolby dolby us.ibm.comcharleszhang charlesz cse.ust.hk hongkonguniversityofscienceandtechnology ibmthomasj.watsonresearchcenter china unitedstates abstract in object oriented code atomicity is ideally isolated in a library which encapsulates shared program state and provides atomic apis for access.
the library provides a convenient way for programmers to reason about the needed synchronization.
however as the library exports a limited set of apis it cannot satisfy every unplanned atomicity demand therefore clients may have to compose invocations of the libraryapistoobtainnewatomicfunctionality.
thisprocess is error prone due to the complexity of reasoning required hence tool support for uncovering incorrect compositions i.e.
atomic compositions that are implemented incorrectly would be very helpful.
a key difficulty is how to determine the intended atomic compositions which are rarely documented.
existing inference techniques cannot be used to infer the atomic compositions because they cannot recognize the library and the client which requires understanding the related program state.
even if extended to support the library client they lead to many false positives or false negatives because they miss the key program logic which reflects programmers coding paradigms for atomic compositions.
we define a new inference technique which identifies intended atomic compositions using two key symptoms based on program dependence.
we then check dynamically whether these atomic compositions are implemented incorrectly as non atomic.
evaluation on thirteen applications shows that our approach finds around previously unknown incorrect compositions.
further study ontomcatshows that almost half out of of discovered incorrect compositions are confirmed as bugs by the developers.
given thattomcat is heavily used in sites includinglinkedin.comand ebay.com we believe finding multiple new bugs in it automatically with relatively few false positives supports our heuristics for determining intended atomicity.
categoriesandsubjectdescriptors d. .
testing and debugging permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed for profit or commercial advantage and that copies bearthisnoticeandthe fullcitationonthefirstpage.
tocopyotherwise to republish topostonserversortoredistributetolists requirespriorspecific permission and or a fee.
esec fse august saint petersburg russia copyright acm ... .
.generalterms reliability experimentation measurement keywords atomic compositions concurrent programming program dependence static analysis predictive analysis .
introduction the difficulty of debugging concurrent programs has inspired the development of a range of tools based on concepts from race conditions to higher level concepts like atomicity .
atomicity expresses the intuitive idea that shared state must be accessed by some code without interference.
ideally atomicity is isolated in a library which encapsulates the shared state and provides the atomic apis for accessing it without interference.
consider the code snippet listing from thebayesianapplication learnernet is an instance of the class bayesiannet .
the class bayesiannet and the referenced class node not shown form a library which encapsulates the fields defining the structure of the bayesian net.
the library also provides two atomic apis hasedge which checks atomically the existence of an edge between two nodes fromidandtoid andapplyop which inserts atomically an edge between the nodes.
listing1.
codesnippetofbayesianapplication 1istaskvalid true if op insert if learnernet.hasedge fromid toid istaskvalid false 7else ... if istaskvalid 9learnernet.applyop op fromid toid many promising approaches have been proposed recently to test whether the library implements its own atomic apis correctly which have been relatively successful for two reasons the code responsible for the atomic accesses can be easily identified as the library api methods the library typically involves a small code base which can be tested exhaustively.
however even if the library implements its atomic apis correctly the application may still malfunction because the client code composes new functionality with the library apis that is intended to be atomic but does so incorrectly.
for example in listing two invocations line and line of library apis are composed at the client sidepermission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed for profit or commercial advantage and that copies bear this notice and the full citation on the first page.
copyrights for components of this work owned by others than acm must be honored.
abstracting with credit is permitted.
to copy otherwise or republish to post on servers or to redistribute to lists requires prior specific permission and or a fee.
request permissions from permissions acm.org.
esec fse august saint petersburg russia copyright acm ... .
to realize new atomic functionality i.e.
to add a given edge between two nodes only if they are not connected by any existing edge.
in general client side atomic composition commonly exists because the library designers cannot predict all desired atomic usages.
unfortunately client side atomic compositions may be implemented incorrectly due to the inherent difficultiesinreasoningaboutconcurrentbehavior clients compose quite often e.g.
compositions per evaluated large program columnacin table the reasoning for each composition is non modular e.g.
each studied buggy composition spans multiple methods.
incorrect compositions i.e.
atomic compositions that are implemented incorrectly commonly lead to unwanted behaviors.
for example in listing if the two invocations are interleaved non atomically by an invocation in another thread that inserts an edge between the two nodes the connectivity state returned by the former invocation becomes stale the latter invocation which depends on the stale state proceeds to insert another edge.
consequently two edges are inserted between the two nodes violating the invariant.
we identify the problem of the incorrect client side composition and address it automatically in this paper.
based on the automatic discovery of the library and the client we infer the intended client side atomic composition automatically after which we adopt existing atomicity violation detection analyses to find the incorrect implementation of the atomic composition.
automatic inference of atomic composition is required to free programmers from the daunting task of manually specifying compositions per large program.
however the inference is challenging.
the first challenge lies in recognition ofthelibraryandtheclient whichisaprerequisiteforatomic composition inference.
existing inference of atomicity which reasons about the field accesses directly cannot recognize the library or the client.
specifically recognition of the library requires understanding what fields are related e.g.
some fields from the class bayesiannet and the class nodeare related in describing the structure of the bayesian net therefore both classes are included in the same library.
most existing inference techniques which understand only the single variable atomicity would isolate the fields in different libraries and accordingly miss the atomicity on the related fields.
furthermore recognition of the irrelevant client side uses of a library requires understanding independent portions of the library state e.g.
the independence between the fields describing the structure of the net and the fields describing the domain specific values stored in the net.
the second challenge posed to the inference is it needs to achieve high fidelity i.e.
it neither misses many real atomic compositions nor introduces many false ones.
existing inference of atomicity even if extended to support the library client fails to achieve the high fidelity.
specifically the inference techniques identify the atomicity with the dynamic instruction adjacency or the lexical adjacency which introduce too many atomic compositions conservatively the inference techniques identify the atomicity with the frequency based or statistic based symptom which miss many real atomic compositions.
for example the atomic composition in our running example is missed because it appears only once.
we propose a new approach to address these challenges.
first we identify the library and the client based on thenotion ofatomic set which characterizes a group of related fields.
as the related fields are linked by field