how do developers use parallel libraries?
semih okur danny dig university of illinois at urbana champaign il usa okur2 illinois.edu dig illinois.edu abstract parallel programming is hard.
the industry leaders hope to convert the hard problem of using parallelism into the easier problem of using a parallel library .
yet we know little about how programmers adopt these libraries in practice.
without such knowledge other programmers cannot educate themselves about the state of the practice library designers are unaware of api misusage researchers make wrong assumptions and tool vendors do not support common usage of library constructs.
we present the rst study that analyzes the usage of parallel libraries in a large scale experiment.
we analyzed open source applications that adopted microsoft s new parallel libraries task parallel library tpl and parallel language integrated query plinq comprising .6m lines of code written in c .
these applications are developed by programmers.
using this data we answer research questions and we uncover some interesting facts.
for example i for two of the fundamental parallel constructs in at least of the cases developers misuse them so that the code runs sequentially instead of concurrently ii developers make their parallel code unnecessarily complex iii applications of di erent size have di erent adoption trends.
the library designers con rmed that our ndings are useful and will in uence the future development of the libraries.
categories and subject descriptors d. .
concurrent programming parallel programming f. .
studies of program constructs objectoriented constructs general terms measurement experimentation keywords multi core empirical study parallel libraries c .
permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed for profit or commercial advantage and that copies bear this notice and the full citation on the first page.
to copy otherwise to republish to post on servers or to redistribute to lists requires prior specific permission and or a fee.
sigsoft fse november cary north carolina usa.
copyright acm ... .
.
.
introduction the computing hardware industry has resorted to multicore cpus in order to keep up with the previous prediction of moore s law.
while the number of transistors will keep doubling the multicore revolution puts pressure on software developers to use parallelism if they want to bene t from future hardware improvements.
at the time this seemed like a huge gamble will software developers embrace parallelism in their applications?
a few years after the irreversible conversion to multicore we can nally answer such questions.
parallel programming is hard.
in the desktop computing the dominant paradigm is thread based parallelism on shared memory systems.
under this paradigm parallel programming is regarded as the art to balance con icting forces making code thread safe requires protecting accesses to shared variables through synchronization but this in turn reduces the scalability of parallel applications.
parallelism can also obfuscate the intent of the original sequential code .
despite books on parallel programming and api documentation of parallel constructs parallel programming education is lagging behind.
developers miss examples of successful applications that use parallelism.
the industry leaders hope to convert the hard problem of using parallelism into the easier problem of using a parallel library.
microsoft provides task parallel library tpl parallel language integrated query plinq collections.concurrent cc and threading for .net languages e.g.
c .
java developers uses java.util.concurrent package.
intel provides threading building blocks tbb for c .
despite syntactic di erences these libraries provide similar features such as scalable concurrent collections e.g.
concurrentdictionary high level parallel constructs e.g.
parallel.for and lightweight tasks.
their runtime systems also provides automatic load balancing .
despite the recent surge in the number of these libraries we know little about how practitioners adopt these libraries in practice.
we present the rst empirical study that answers questions about parallel library usage in depth and on a large scale.
we analyzed open source applications that adopted microsoft s new tpl and plinq libraries.
in this corpus we studied the usage of all four .net parallel libraries both old and new .
these applications are hosted on github and microsoft s codeplex and they comprise .6m nonblank non comment lines of code written in c by programmers.
we implemented a semantic analysis that uses type information to collect precise statistics about parallel constructs.using this data we are able to answer several questions.
q1 are developers embracing multi threading?
our data shows that of all open source c applications in the most active code repositories use multi threading.
out of these applications use multi threading for concurrency and use it for parallelism.
q2 how quickly do developers start using the new tpl plinq libraries?
tpl and plinq have been released nearly years ago in april .
however we found signi cant di erences between the times when developers start using these libraries.
we found that applications of di erent size have a di erent adoption tipping point.
we also found that more applications are becoming parallel and existing parallel applications are becoming more parallel.
q3 which parallel constructs do developers use most often?
of the api methods account for of the library usage thus newcomers can focus on learning a smaller subset of the parallel libraries.
q4 how do developers protect accesses to shared variables?
locks are still the most used synchronization construct but developers use a wide variety of alternatives.
q5 which parallel patterns do developers embrace?
out of the six widely used parallel patterns that we analyzed loop parallelism is the most common.
q6 which advanced features do developers use?
we found that developers rarely use optional parameters such as customized task schedulers aggregate exception handling controlling the level of parallelism etc.
q7 do developers make their parallel code unnecessarily complex?
we found that developers sometimes use more powerful task constructs instead of the equivalent but simpler task constructs even though they never use the extra power.
thus they make their code less readable and more verbose than it needs to be.
q8 are there constructs that developers commonly misuse?
we found that for two of the fundamental parallel constructs in at least of the cases developers misuse them the code runs sequentially instead of concurrently.
our study has several practical implications.
first it is a tremendous resource for educating developers.
the most common way to learn a new library is to study relevant examples of the api.
newcomers can start learning the apis that are most widely used see q1 and q3 and we can point them to the kinds of applications that are most likely to use the libraries q2 .
newcomers should avoid common misuses q8 and constructs that unnecessarily increase the code complexity and the likelihood of errors q7 .
our study also educates developers by showing real world examples of parallel patterns q5 .
second designers of these libraries can learn how to make the apis easier to use q6 .
they can learn from observing which constructs do programmers embrace q3 and which ones are tedious to use or error prone q8 .
third researchers and tool vendors can focus their e orts on the constructs that are commonly used q3 or tedious or error prone to use q8 .
for example the refactoring community can decide which refactorings to automate.
the testing and veri cation community can study the synchronization idioms that programmers use q4 .
this paper makes the following contributions to the best of our knowledge this is the rst empirical study to answer questions about parallel library usage on a large scale using semantic analysis.
we present implications of our ndings from the perspective of three di erent audiences developers library designers and researchers.
the tools and data are publicly available as a tremendous education resource .
background .
parallel programming in .net we rst give a brief introduction to parallel programming in .net framework.
the earlier versions provide the threading library which contains many low level constructs for building concurrent applications.
thread is the primary construct for encapsulating concurrent computation and threadpool allows one to reuse threads.
synchronization constructs include three types locks signals and non blocking.
.net .
was enhanced with higher level constructs.
the new tpl library enables programmers to introduce task parallelism in their applications.
parallel task and taskfactory classes are the most important constructs in tpl.
task is a lightweight thread like entity that encapsulates an asynchronous operation.
using tasks instead of threads has many bene ts not only are tasks more e cient they also abstract away from the underlying hardware and the os speci c thread scheduler.
task is a generic class where the associated action returns a result it essentially encapsulates the concept of a future computation.
taskfactory creates and schedules tasks.
here is a fork join task example from the passwordgenerator application for uint i i tasks .
length i tasks tf.
startnew generatepassword length forcenumbers ... cancellation .
token try task .
waitall tasks cancellation .
token ... the code creates and spawns several tasks stored in an array of tasks the fork step and then waits for all tasks to complete the join step .
parallel class supports parallel loops with forand foreach methods and structured fork join tasks with invoke method.
the most basic parallel loop requires invoking parallel.for with three arguments.
here is a usage example from the ravendb application parallel .for counter ... processtask counter database table the rst two arguments specify the iteration domain and the third argument is a c lambda function called for each iteration.
tpl also provides more advanced variations of parallel.for useful in map reduce computations.
.net also provides the cc library which supports several thread safe scalable collections such as concurrentdictionary .
.net .
provides a fourth parallel library the parallel language integrated query plinq library which supports a declarative programming style.
plinq queries operate on ienumarable objects by calling asparallel .
here is an example from the appvisum application assembly .
gettypes .
asparallel .
where t t. issubclassof typeof controllerbase .
select t new ... .
forall t controllerscache .add t.name t. type after the asparallel the data is partitioned to worker threads and each worker thread executes in parallel the following where select and forall.figure number of applications that use threading tpl plinq or cc libraries.
tpl threading plinq 32cc apps in gray area .
roslyn the microsoft visual studio team has recently released roslyn as a community technology preview with the goal to expose the compiler as a service through apis to other tools like code generation analysis and refactoring.
roslyn has components such as syntax symbol table and binding and flow analysis apis.
the syntax api allows one to parse the structure of a program.
while a c le can be syntactically analyzed in isolation we cannot ask questions such as what is the type of this variable .
the type may be dependent on assembly