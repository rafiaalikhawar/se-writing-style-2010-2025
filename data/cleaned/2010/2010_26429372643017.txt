static lightweight includes resolution for php mark hills1 1east carolina university greenville nc usapaul klint2and jurgen j. vinju2 2centrum wiskunde informatica amsterdam the netherlands 3inria lille nord europe lille france abstract dynamic languages include a number of features that are challenging to model properly in static analysis tools.
in php one of these features is the include expression where an arbitrary expression provides the path of the file to include at runtime.
in this paper we present two complementary analyses for statically resolving php includes one that works at the level of individual php files and one targeting php programs possibly consisting of multiple scripts.
to evaluatethe effectiveness of these analyses we have applied the first to a corpus of open source systems totaling more than .
million lines of php and the second to a number of programs from a subset of these systems.
our results show that inmany cases includes can be resolved to a specific file or asmall subset of possible files enabling better ide features and more advanced program analysis tools for php.
categories and subject descriptors f. .
semantics of programming languages program analysis d .
.
language constructs and features general terms languages measurement experimentation keywords static analysis dynamic language features php .
introduction php invented by rasmus lerdorf in is an imperative object oriented language focused on server side application development.
it is now one of the most popular languages as of july ranking 7th on the tiobe programming permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributedfor profit or commercial advantage and that copies bear this notice and the full cita tion on the first page.
copyrights for components of this work owned by others thanacm must be honored.
abstracting with credit is permitted.
to copy otherwise or re publish to post on servers or to redistribute to lists requires prior specific permissionand or a fee.
request permissions from permissions acm.org.ase september v asteras sweden.
copyright acm ... .
.
index 1used by82.2percent of all websites whose server side language can be determined 2and ranking as the 4th most popular language on github by repositories created in .3php is dynamically typed with a single inheritance class model including interfaces and a number of standard built intypes e.g.
strings integers floats .
typecorrectness is judged based on duck typing allowing values to be used whenever they can behave like values of the expected type.
for instance adding the strings and yields the number while concatenating the numbers 3and4yields the string .
along with dynamic types php includes a number of dynamic language features also found in other dynamic languages such as ruby and python including an evalexpression to run dynamically built code and special methods referred to as magic methods that handle accesses ofobjectfieldsandusesofmethodsthatareeithernotdefined or not visible.
although the popularity of php should have resulted in a plethora of powerful development tools so far this has not been the case.
we believe this is because the samedynamic features that make php so flexible also make it challenging for static analysis.
this hinders the creation of the static analyses needed as the foundation on which these programmer tools are built and also causes challenges for static analysis tools used for tasks such as security analysis a topic we touch on briefly in section .
in this paper we focus on one specific dynamic feature the php file inclusion mechanism.
in php like in many other dy namic languages file inclusion is performed dynamically the file to be included is specified using an arbitrary expression which at runtime evaluates to a file path.
the file at this path is then loaded with some parts of the file brought in as top level definitions e.g.
classes and functions and other parts inserted directly at the point of the call and executed.
this provides an obvious challenge for static analysis it may not be possible to even determine the source code that needsto be analyzed until runtime.
precise resolution of includes isa prerequisite for any form of static analysis or ide support.
is it really the case though that these dynamic includes are truly dynamic or is it possible to resolve many of them statically?
in prior work we showed that the latter is paperinfo tpci index.html pl php all all 3the query for this is based on blog top github languages for so far but including the entire year.
find include filepath starts with directory characters?
file missingfile foundlookup file using directory infofile found using include path?file found using including script path?file found using current working directory?
file located?no yes yes noyes yes yesno no no figure the php file inclusion process.
actually the case many apparently dynamic includes are in practice static.
string building expressions used in these includes are not often used in a truly dynamic fashion where the file that is included depends on a dynamic value.
instead they are used for the mundane task of navigating the local file system towards a single file taking advantage of system wide constants and functions for string concatenation and directory navigation.
the main contributions presented in this paper are as follows.
first taking advantage of the findings of our prior work we have developed two includes resolution algorithms.
the first analysis dubbed flres l o o k sa tas p e c i fi cp h pfi l e in isolation quickly determining which files could be includedby each include expression in that file.
this analysis works with any php file in the system and is intended to provide information for more precise analysis as well as supportfor ides.
the second analysis dubbed pgres looks at a specific php program a page loaded from a server or a command line program and attempts to resolve all includes for this program even those that are loaded transitively by already included files.
this analysis is more precise since the context of the initial include expression is sometimes required for correct resolution and also models the possibilitythat the file cannot be determined statically such as in cases where includes are used to load plugins.
determining the actual file or files that can be included at runtime allowsstatic analysis tools to get access to more of the programsource that will be executed opening up possibilities formore powerful analysis techniques to be applied and enabling more powerful developer tools including tools for finding errors performing code refactoring detecting security violations and supporting standard ide services such as jump to definition .
second to ensure these algorithms work in practice we have validated them empirically.
flreshas been validated againstacorpusof20open sourcesystems madeupof32 682source files and lines of code while pgreshas been validated against a number of programs from these systems.
this corpus includes a number of the most used php systems including well known systems such as wordpress joomla and mediawiki as well as frameworks such as symfony.
the rest of the paper is organized as follows.
in section we discuss php includes in more depth describ ing the method used by php to resolve includes at run time showing examples of both static and dynamic in cludes and describing which cases we focus on in this pa per.
following this in section we present flres with pgrespresented in section .
to show that the analyses work in practice section evaluates the effectivenessof these algorithms using the corpus mentioned above.
fi nally section describes related work and section con cludes.
all software used in this paper including the cor pus used for the validation is available for download at .
.
overview here we explain how includes work in php the technical context of our work and the necessity of creating two distinct algorithms for resolving includes.
.
php include semantics in php include expressions are used to include the contents of one file into another at runtime.
we list here what the php interpreter normally does dynamically and what our two algorithms approximate statically in a conservative fashion.
the include expressiontakesa single operand this o p e r a n di se x p e c t e dt oe v a l u a t et oas t r i n gc o n t a i n i n gt h efi l e name possibly including some information about the path to the file.
this operand can either be given statically a sa string literal or dynamically using an arbitrary expression that yields a string.
once the operand is evaluated the include mechanism associates the string result referred to below just as the file name although it may include path information as well to an actual file referred to here as the target file present either in the system or in installed libraries.
this file resolutionis normally done by the php interpreter according to the dynamic process depicted in figure .
if the file name starts with directory characters e.g.
.
o r.. the target file is looked up using this directory information.
file namesbeginning with or are absolute paths looked up from the root of the site for websites or the file system for commandline tools while names beginning with .or..are relative paths looked up starting in the directory containing the script currently being executed.
otherwise the target file is computed using the following process.
first the file name is looked up starting from each directory given as part of the include path.
the lookup .
includes normal utf8test.php line 2require once utfnormaldefines.php .
includes usermailer.php line 5require once mail.php .
maintenance showstats.php line 8require once dirname file .
maintenance.php .
tests jasmine spec makers makejquerymsgspec.php lines and maintenancedir dirname dirname dirname dirname dirname file .
maintenance 14require maintenancedir maintenance.php .
from includes skin.php lines to deps wgstyledirectory skinname .deps.php 18if file exists deps include once deps figure includes in mediawiki .
.
.
stops when the target file is found even if other later entries in the include path have not been tried.
the include path can hold either absolute or relative paths although it isdiscouraged the current directory .is often given in the include path.
next the current working directory which may be different from the directory containing the executing script is checked for the file.
finally an attempt is made to find the target file by looking it up in the directory containing the executing script.
if the file is not found in any of these locations or if the lookup based on absolute or relative paths discussed above fails to find the file the process ends in the file missing node meaning the include cannot be performed.
in summary the semantics of dynamic includes are affected by the given file name the include path and the locationand working directory of the script and the file system is searched in a well defined order for the file being included.
when the include expression is evaluated any functions classes interfaces and traits in the target file are included into the current global scope.
the other contents of the included file are executed as part of evaluating the expression and inherit the current execution environment meaning they run as if they were inserted at the spot of the original include .areturn statement evaluated in the included code will immediately return back to the point of the original include expression skipping the rest of the code that would normally be evaluated.
the value of an include expression isfalsein case of failure and either or the explicitly returned value in the case of success.
ifthefiletobeincludeddoesnotexist astandard include expression will issue a warning while a variant require will produce a fatal error.
if the file to be included has already been included it will be included again unless the oncevariants include once andrequire once are used.
these variants ensure that the contents of a file areincluded at most once.
in the remainder of this paper wedo not bother to distinguish between these variants sincethey do not influence the operation of the two resolution algorithms.
several example include expressions from mediawiki .
.
are shown in figure .
in the first example the included file utfnormaldefines.php is given statically and is found in the same directory as the file with the include expression utf8test.php .
since no path information is given this file will be found by looking in the include path if one is given and then in the directory of the including script by which point it will definitely be found.
in the second example the included file mail.php i sa l s ogiven statically.
however mail.php is not part of mediawiki but is instead part of the pear mail package and is found by looking on the include path.
we classify the remaining three examples and others like them as dynamic includes.
in the third example file is a so called magic constant file evaluates to the full path including file name of the file which uses it.
dirname is a standard library function which returns the parent directory of a file.
taken together this will evaluate tothe absolute path of the maintenance directory with the string concatenation operation i.e.
the dot operation then adding the file maintenance.php to the end of the path.
the fourth example provides an alternate way of looking up the same file the starting directory is more deeply nested so more calls to dirname are used with the result assigned to variable maintenancedir .
this is then used inside a string built using string interpolation the variable is replaced by its value and the name of the maintenance.php file.
finally in the fifth example the location of the file is built asa string expression with two variables one for the mediawiki style directory and one for the name of the skin used to customize site appearance.
the resulting file path is saved into a variable this variable is checked to see if the file existsand if so the file is included.
of these three dynamic include examples we are currently able to resolve the first two to unique target files using the techniques described below.
the last is truly dynamic and cannot be resolved to a singlefile the best that can be done is to partially resolve it to those files ending in deps.php.
.
the php air framework to statically resolve such dynamic includes we analyze php using rascal as part of our ongoing work on php air a framework for php analysis in rascal .
rascal is a meta programming language for source code analysis and transformation that uses a familiar java like syntax and is based on immutable data trees relations sets term rewrit ing and relational calculus primitives.
all analysis performedin this paper was performed using rascal code ensuring that the results are reproducible and checkable.
we also used rascal and its string templating and io facilities to generate the latex for the tables in this paper that document the corpus and the analysis results.
all code is available online at we are parsing php scripts using our fork4of an opensource php parser5 which itself is based on the grammar used inside the zend engine the scripting engine for php.
this parser generates asts as terms formed over rascal s algebraic datatypes.
.
the need for two algorithms in this paper we present two includes resolution algorithms one for individual files and one for programs.
the first flres for individual files computes files that could be included directly by a given file ignoring the contextof the include the directory of the original script being executed the current working directory or the include path all of which may not be known when looking at the file in isolation.
the second pgres for programs is context sensitive considering all this information in order to more precisely resolve the includes in the original file as well as those brought 505input sys a php system a mapping from file locations to abstract syntax trees input toresolve a location indicating the ast in systo be analyzed input baseloc a location indicating the root of system sys input libs a set of locations of known library includes used by sys output arelation res from the location of each include expression to the location s of possibly included files 1iinfo include info cache for sys 2ast the ast for file toresolve insys 3includes a set containing each include expression in ast 4foreach i includes do i normalizeexpr replaceconstants i iinfo iloc the location of i ip the operand used in iindicating the file to include ifip is a literal string starting with then ifsys contains a file at baseloc ip then addiloc baseloc ip t o res remove ifrom include c o n t i n u ew i t hn e x ti end end foreach file freturned by matchincludes sys i baseloc libs do addiloc baseloc ip t o res end 17end algorithm php file level includes resolution analysis flres .
in as part of the includes process.
since this information is based on the program file being run pgresis not designed to be applied to php files that cannot be directly executed.
figure illustrates one typical scenario where this distinction is critical.
here two files a.php for brevity just abelow and admin b.php b both include file includes c.php c .cincludes file d.php d but does not provide any path information.
when looking at c in isolation without knowing it is being included by another file the analysis should indicate that either the file d.php d1 or the file admin d.php d2 could be loaded by the include .
note that here this is not an over approximation as each file could be loaded by this include expression.
the program level analysis pgres will instead look individually at both aand b two programs scripts that can be invoked directly and will determine which files could be included when either is executed.
when cis included in a t h ec o d ec o n t a i n e di nc will be executed in the context of a.w h e nt h e include expression that includes dis executed this means it will not run in the context of c in the includes directory but will instead run in the context of a.s i n c e d1is in the same directory as ait will be included following the solid line and the ambiguity over which version of dto include disappears.
the same happens with b when cis included the code in cruns in the context of b w i t h d2found in the same directory as b the dashed line again making the file to be selected unambiguous.
the file level includes analysis flres i sd e s c r i b e dn e x t in section .
the program level includes analysis pgres i s described later in section .
.
file level includes resolution the flresalgorithm see algorithm takes as input a representation of the php system under analysis sys the location of the php file to analyze toresolve the root location of the system under analysis baseloc and in libs a.php ... include includes c.php ... admin b.php ... include includes c.php ... includes c.php ... include d.php ... d.php admin d.php figure an ambiguous file level include.
the locations of all standard libraries used by sys.t h e sys representation is a map from file names to asts for each file see section .
we need to assume that libsis a correct and complete list of library dependencies libscan be empty if the system does not use any external libraries those that come with php such as the standard mysql libraries do not need to be explicitly included to use .
iinfois a cache similar to that maintained by ides containing information about the system under analysis such as the locations ofdefined constants.
currently extracted using rascal we plan to integrate this with eclipse to allow it to be updated incrementally as files are edited.
the algorithm collects all instances of include expressions in the ast for a script.
it then performs two main steps to find the files that could be included by each.
first the call toreplaceconstants replaces each constant in the include expression by the value of the constant under the conditions that the constant is defined using a literal value or an ex pression that can statically be converted to a literal value and that all definitions of the constant in sysare identical.
second the call to normalizeexpr performs a number of simplifications including simulating the effects of common functions for working with strings and directory names replacing magic constants with their values shown in table and converting concatenations of string literals into a single literal.
this simplification process continues until no more 506constant name replacement value file absolute path including file name dir absolute path without file name class name of the enclosing class method name of the enclosing method function name of the enclosing function namespace name of the enclosing namespace trait name of the enclosing trait table magic constants in php.
changes to the expression being simplified are found.
a common example of how magic constants are used in include expressions in combination with builtin functions is shown in figure in the third example where file is used in conjunction with the dirname function.
this algebraic simplification process is run repeatedly to take advantage of new opportunities for replacements until no more constant expressions can be collapsed into literal expressions.
at this point if the expression indicating what to include given as ip is a literal string starting with or an attempt is made to find the file in sysby adding ipto the end of baseloc.
if this file is found we consider the include to be resolved and add this mapping to res which is a relation from include locations to the locations of the files that could be included at each location.
we also skip the rest of this i t e r a t i o no ft h el o o p .i fip is not a literal string starting with or if the file lookup failed flresinstead attempts to use matching against the literal suffix of ip.
only this suffix is used in this match because expressions in the include could modify the path in unexpected ways e.g.
navigating to a parent directory .
all files in sysand in libsthat match are returned.
in some cases where ipis an arbitrary expression or ends in an arbitrary expression this could be all the files in both.
a pair consisting of the location of i given as iloc end each returned file f is then added into res.
in summary flresis a fast lightweight algorithm that is based on straightforward algebraic simplification and constant propagation.
in section we will evaluate how accurately it performs on real php systems.
soundness flresprovides a sound over approximation of the files that could be included by each include expression in a file under two conditions.
the first condition is that thefiles given in sysandlibsare actually all the files that could be included.
if for some reason additional libraries are being used but are not included in libs these files will be missed.
files included using evalare also not detected although we are unaware of any code in the corpus that actually does this .
the second condition is that the constants used in an include expression are actually visible at that pointin the code.
for instance when given an include path like root .
myfile.php if there is a unique constant root defined as base flresa s s u m e st h i sc o n s t a n ti sb e i n g used.
however if a constant is not visible the name of the constant is instead treated as a string literal meaning the above should attempt to include file rootmyfile.php .w e are unaware of any cases where this specific scenario occurs in practice it is more likely that the include would just fail but it is a theoretical possibility.
.
program level resolution the pgresalgorithm see algorithm receives six inputs.
the first four are the same inputs given to flres.t h e fifth parameter ipath represents the include path for php and is given as a list of locations.
to remain sound thealgorithm makes few assumptions about the include path pgresassumes that the given include path is accurate but additional entries may be present if language features that can alter the include path are reachable something checked in the body of the algorithm.
the sixth argument flres i s the output of flres which serves as a starting point for pgres.
part of this information is the include expression with the replaceconstants andnormalizeexpr steps already applied meaning that this does not need to be done again here.
the iinfoon line is the same cached system information used in flres.
on line the initial include graph igraphis constructed.
starting from toresolve and using the already computed information from flresinflres a node is created for each reachable script in sysand library in libs.as i n g l ee d g ei s created for each include with a single source node the script containing the include and a set of possible targets.
on line setsipis computed.
this set contains the locationsofallreachablescriptsthatmaysetthephpinclude path or the php working directory at runtime.
the include path can be changed by calling the set include path function or the ini set function although for caveats see the discussion of soundness below and supplying the newinclude path.
in both cases the include path is changed for the remainder of the script.
in the case of ini set t o maintain soundness we assume the call couldset the include path unless a string literal is used to name a different setting.
the working directory is modified by calling chdir.
once this is done line then annotates all the nodes of the include graph with information on the related script specifically which constants it defines and whether it sets the include path or changes the working directory i.e.
is in setsip .
after this the loop on lines through continues while the edge set of the include graph changes.
in the first step on line the include expressions on each edge are simplified according to what is currently known about the includes relation.
this is similar to the simplification steps described forflres but also takes advantage of information about which constant definitions are actually reachable.
the same constant can be given different values in different scripts which does occur in practice but it may be the case that only one definition of the constant is actually reachable.
this allows additional constant replacements beyond what is possible in flresfor the situations when the constants are not unique throughout the entire system.
the inner loop on lines through then iterates over each edge ewhich does not already have a unique target file with the goal of updating the target node sets to account for any new information.
if the file name given as an operand to theinclude expression assigned to ip i sal i t e r a ls t r i n g calculateloc is called to compute the actual include file represented by the location.
calculateloc identifiesthefiletobeincludedbywalking at r e em o d e lo ft h efi l e si n sys following the procedure laid out in figure .
this also provides an increase in precision over flres since unlike flres pgresknows the include path and the directory of the executing script.
before thecall to calculateloc changesip is first set to true if a 507input sys a php system a mapping from file locations to abstract syntax trees input toresolve a location indicating the ast in systo be analyzed input baseloc a location indicating the root of system sys input libs a set of locations of known library includes used by sys input ipath the include path a list of locations input flres file level resolve information from flres output arelation res from the location of each include expression to the location s of possibly included files 1iinfo include info cache for sys 2igraph build initial include graph based on flresresults 3setsip reachable scripts that set the include path or change the working directory 4igraph annotatenodes iinfo setsip 5while the set of edges in the include graph changes do igraph simplifyedges igraph iinfo fore a non unique edge do i the include expression for edge e ip the operand used in iindicating the file to include ifip is a literal string then changesip a file that sets the include path or changes the working directory is reachable e calculateloc toresolve baseloc ipath changesip end foreach file freturned by matchincludes sys i baseloc libs do addiloc baseloc ip t o res end end 18end 19res the relation from include expressions to files induced by igraph algorithm php program level includes resolution analysis pgres .
script that sets the include path or changes the working directory is reachable in the include graph.
if changesip is true it will short circuit the process shown in figure since it then may be the case that any directory is on the include path or any directory is the current directory if no directory characters are found at the start of the file name calculateloc will fail leaving the information about the target files for this include unchanged.
if after this edge ecan still point to multiple nodes the same matching process used in flresis used here as well.
this is repeated since as the number of reachable constants decreases more constant replacements may become available this allows the file names used in the matching process to improve making the match more precise over time.
on line once no more changes occur in the include graph the result res is computed as the relation from include expressions to included files induced by igraph.
soundness pgresprovides a sound over approximation of the files that could be included by each include expression in a program under several common conditions.
the first two are identical to those for flres and are discussed in section .
additionally pgresalso assumes that the include path and the working directory are not changed in obfuscated ways e.g.
by invoking ini set using a variable function or inside eval.
if this is done it could cause the wrong file to be found during the lookup process in calculateloc .w e believe this would be highly unusual though and are not aware of any real php code that actually does this.
pgres does not attempt to use the values of variables making the algorithm less precise in some cases but also protecting against soundness concerns related to the interaction of phpvariables with various reflective features and library functions that can be used to indirectly modify their values.
.
ev aluation in this section we present the results of our evaluation of the two includes resolution algorithms flres andpgres described respectively in sections and .
first we describethe systems used in the evaluation.
then the two algorithmsare evaluated separately.
first flres the file level resolution algorithm is evaluated on the entire corpus to measure its capability of resolving includes to small sets of possible php files.
then we evaluate the improvement of pgresover flresby applying it to a subset of the corpus focusing just on actual php programs scripts that can be executed directly from a web server or the command line.
.
corpus as part of our prior work on php we assembled a corpus of large open source php systems basing ourchoice on popularity rankings provided by ohloh a site that tracks open source projects.
we have since extended this with an additional system magento a popular online retail system and updated all systems in the corpus to morerecent versions if available.
the chosen systems are shown in table .
systems were generally selected just based on the o h l o hr a n k i n g a l t h o u g hi ns o m ec a s e sw es k i p p e ds y s t e m s if we already had several more popular systems of the same type in the corpus.
we used popularity instead of actual number of downloads or installed sites since we have no way to accurately compute these figures.
in total the corpusconsists of php source files with lines of 508system version php release date file count sloc description cakephp .
.
.
.
application framework codeigniter .
.
.
.
application framework doctrine orm .
.
.
.
object relational mapping drupal .
.
.
cms gallery .
.
.
.
photo management joomla .
.
.
.
cms kohana .
.
.
.
application framework magento .
.
.
.
.
online retail mediawiki .
.
.
.
wiki moodle .
.
.
online learning oscommerce .
.
.
.
.
online retail pear .
.
.
.
component framework phpbb .
.
.
.
bulletin board phpmyadmin .
.
.
.
database administration silverstripe .
.
.
.
cms smarty .
.
.
.
template engine squirrel mail .
.
.
.
webmail symfony .
.
.
.
application framework wordpress .
.
.
.
blog the zend framework .
.
.
.
application framework the php versions listed above in column php are the minimum required versions.
the file count includes files with a .php or an .inc extension.
in total there are systems consisting of files with total lines of source.
t a b l e2 t h ep h pc o r p u s .
php source counted using the cloc7tool .
the systems in this corpus were used during development of the includes resolution analysis both as a test bed to check the results of the analysis and as a source of usage patterns that a realistic analysis would need to handle.
.
evaluating flres flresis evaluated here based on the following questions a how many includes in real php code can be resolved to a small set of target files?
b how small are these sets?
and c how fast does the analysis usually run?
.
smaller target file sets mean the algorithm is more precise while a faster run time means it is suitable for use in an ide.
in terms of recall and precision we know the algorithm to have recall since it is sound under assumptionsthat hold within the corpus.
precision could be defined per resolved include as numberofpossiblefiles under the assumption that only one specific file would be included at run time.
however such assumption is not reasonable since some includes could indeed be designed to resolve to several files.
we therefore simply report the number of computed candidates for each include.
.
.
method to evaluate the effectiveness of the flresalgorithm we have applied it to all the php files in the corpus shown in table using a rascal script to run the analysis and allow for reproducibility.
we use rascal to gather the information seen in table .
all include expressions are matched just by matching any include expression node in the ast while includes are defined for matching purposes as any include expression with an operand other than a string literal strings built using interpolation appear as so called encapsed strings instead of string literals .
per php system in the corpus we measure how many include statements there are how many of those have paths built dynamically at runtime which of the includes we can resolve to a single unique file to how many candidates aninclude points after resolution and how many can not beresolved at all.
a strong reduction of provided includes especially dynamic includes to unique files or at least a low amount of left over candidates indicates success.
contrary ifflreswould not work this method would show insignificant amounts of resolved includes or high average left over nondeterminism.
intuitively we expected the larger part of includes to be resolved by flres i.e.
.
.
.
threats to v alidity we note the following threats to validity in our evaluation offlres .we focused mainly on large well maintained software systems.
it may be the case that these systems aremore careful and consistent in how they use includesthan other systems.
however we do not believe that this is an issue uses of dynamic includes vary widely inthe systems we have looked at and the corpus contains software from many different application domains.
.we do not try to account for cases where part of one system is used in another which could skew our results.
this happens in magento for instance which uses part 509system includes results total static dynamic unique missing any other average cakephp .
codeigniter .
doctrineorm .
drupal .
gallery .
joomla .
kohana .
magento .
mediawiki .
moodle .
oscommerce .
pear .
phpbb .
phpmyadmin .
silverstripe .
smarty .
squirrelmail .
symfony .
wordpress .
zendframework .
total .
table results of running flres on the corpus.
of the zend framework libraries and in gallery which uses part of kohana.
although this could mean we are counting the same resolved cases multiple times it could also mean we have the same unresolved cases appearinginmultiplelocations.
wehavenotattempted to determine which versions of these libraries appear embedded in other projects or whether the included code is the original code or has been modified.
.if a system violates the soundness assumptions given insection flreswould return incorrect results.
we believe this is unlikely it should be possible to determine which external libraries are used by a system and we have not seen the situation we described with defined c o n s t a n t si na n yo ft h ec o d ew eh a v ee x a m i n e d .
.
.
results for flres table shows the result of running flreson the corpus shown in table .
the first column shows the name of the system.
the second third and fourth columns provide information about the includes in this system totalgives the total number of include expressions staticgives the number of these includes where the file to include is given as a string literal and dynamic gives the number of includes that use expressions other than a string literal to specify the included file.
this is a good proxy for which includes could include multiple files but not perfect figure illustrated that file paths given as string literals may refer to multiple files.
the five columns under resultsthen show the actual results of the analysis.
uniqueshows the total number of includes that can be assigned a single possible target file by flres.missingthen shows the number of includes with no possible target file.
while in some cases this appears to be an error in the code in many the missing includes are surrounded by a check to see if the file is present and appear to be for included files which are part of optional extensions to thesystem.
column anyillustrates the other extreme cases where the include could refer to percent or more of the files in the system.
otherthen shows includes between these two extremes includes that could refer to more than one file but are specific enough to not refer to at least percent of the files.
finally the averagecolumn indicates how many files on average each of these otherincludes could actually refer to.
for instance for cakephp each of the includes classified as othercould refer to roughly .
files.
figure shows an overview of the running times per file for all files in the corpus.
the plot shows that although there exist some outliers above seconds the largest outlier at seconds is not included in this plot and quite a few outliers that may take up to half a second flresis able to analyze most of the files within to milliseconds with a median of just over .
.
.
analysis in many of the systems the number of unique includes is quite high while the average number of possible files for those includes in the othercategory are much lower than the total number of files in the system with many systems having a range from roughly kohana pear the zend framework symfony up to around .
as indicated above performance is also good.
while we are investigating the 50000time ms log scale figure boxplot detailing run time in ms of flres for all files in the corpus.
outliers to further improve performance most files can be a n a l y z e di n5t o5 0m s .
there are several reasons that an include may not evaluate to a uniqueinclude or may even evaluate to any.f i r s t as was shown in figure in some cases the file possibly included by the given include expression isn t unique at least when the context isn t known.
second in some cases the include relies on a constant which is given different values in different files.
the analysis then has to take account of the inclusion relation between files to ensure the correct constantis used.
the pgresalgorithm takes account of both of these limitations in flres allowing it to improve the precision of the analysis and give fewer possible files per include.
third in some cases a stronger analysis such as a string analysis is needed.
this is the case in phpbb which uses variablesin every include expression.
finally some of the includes are specifically designed to support plugin architectures anduse very general include expressions to facilitate this.
it may be possible for the user to annotate the expression somehow to provide additional information but in general it is not possible for any static analysis to determine the possible files to be included in this scenario.
.
evaluating pgres pgresis evaluated focusing on the following question a how much improvement does the algorithm produce in the size of the sets of candidates over flres?
.
again smaller candidate sets indicate a more precise algorithm and can also improve the precision of other analyses using the results ofpgres.
the definitions of recall and precision used here are the same as for flres given above.
.
.
method t h em e t h odu s e dt oe v a l u a t epgres is similar to that used forflres except for the choice of files to analyze.
since pgresis targeted at php programs only files that could be directly invoked have been chosen.
we have limited our efforts to programs from the following systems oscommerce wordpress mediawiki phpmyadmin and cakephp.
.
.
threats to validity our evaluation of pgreshas the same threats to validity as flres described above but with the soundness assumptions for pgresdescribed in section .
most of thesesoundness assumptions e.g.
setting the include path inside eval are very unlikely in this case evalis very rarely used and we have not seen this scenario in real code.
a threat unique to pgresis that it may be the case that what we identify as a program is actually not but is instead an include used in other files.
identifying which files can be directly invoked versus which can be included in other files is not trivial the most obvious solution to use files that cannot be included by other files would assumethe analysis we are implementing.
instead this requires a deep knowledge of each individual system one of the reasons we have restricted the number of systems evaluated using pgres.i nt h ec a s ew h e r ew eh a v ei n a d v e r t e n t l ys e l e c t e da n include file pgresmay resolve includes incorrectly either missing target files that should be present or giving incorrect target files.
since pgresuses the results from flresas a starting point pgreswill never return a set of candidates larger than flres.
when applying pgresas a first analysis step enabling another e.g.
static taint analysis the program files should be identified in advance.
.
.
results pgreswas executed on a total of programs from mediawiki from wordpress from phpmyadmin from oscommerce and from cakephp which is a framework but includes a small sample application .
pgreswas not able to improve upon the results of flresfor either mediawiki or wordpress but improvements were seen with the other three applications.
the numbers below are computed by looking at all includes identified as being reachablebypgresfor a specific program then for each include computing the number of candidates returned by both flres and pgres.pgresis more precise in those cases where more include expressions have smaller candidate sets.
in the case of phpmyadmin summing across all programs analyzed pgreswas able to reduce the total number of includes categorized as anyfrom to .
pgreswas also able to reduce the number with a candidate set of from to and of from to while increasing the number with a unique match from to .
inthecaseofcakephp acrossthe2programsanalyzed pgreswas able to reduce the total number of includes with a candidate set of from to of from to and of from to while increasing the number with a unique match from to .
in the case of oscommerce summing across all pro grams analyzed pgreswas able to reduce the total number of includes with a candidate set of from to of from to of from to of from to of from to of from to of from to of from to and of from to .
the number of includes with a unique match went from to .
themedianexecutiontimeof pgresoverthe408analyzed programs was .
seconds and the average was .
seconds with some programs analyzed almost immediately and one taking .
seconds.
.
.
analysis the results of the analysis show that pgresis quite effective specifically in those cases where contextual information about the script is important especially when the directory of the including script or the values of reachable versus globally uniquely defined constants determine which filescan be imported.
in situations where this is not the case pgresdoes not improve on the results computed by flres.
in both mediawiki and wordpress the includes that cannot be further resolved are generally to support system exten sions e.g.
the final example in figure which supportsinstallable skins that can be selected by the user as partof his her preferences with file names given in terms ofglobal variables method parameters method results and object fields based on data from the site configuration or the database.
in some cases a stronger analysis might be able to further reduce the target file sets but one lesson learned from this evaluation is that the chance of success may below other than in the case of phpbb where an analysis focused on the values flowing into variables may help many of the unresolved cases seem to be truly dynamic.
since pgresis slower than flres it is not suitable for interactive use e.g.
in an ide.
instead it would be applied as part of other program analysis tools which require higher accuracy.
.
related work the inability to resolve includes has been a challenge for creating realistic php analysis tools.
for instance huang etal s webssari system does not handle dynamic includes at all leading to a need to manually resolve the includes and manually merge the included code.
jovanovic et al.
s pixy is able to resolve some dynamic includes but this resolution mechanism offers limited support for newer php features and appears to fail in practice .
in their work on finding interference issues between plugins in php applications such as wordpress eshkevari et al.
defined a symbolic includes resolution algorithm similar to ourflresalgorithm withsupportformatchingpathsuffixes and simulating the effect of common operations.
while flressupports additional php operations it appears that their algorithm could easily be extended to do so.
nguyen et al.
in their work on phpsync used symbolic execution to identify the program points in php scripts responsible for generating specific html fragments.
they representedstringvaluesusinga d model ahierarchical symbolic representation of the possible string values generated by php scripts and language constructs.
to symbolicallyexecute include expressions they used the value of the d model representing the filename to determine which file should actually be executed.
while this supports expressions built using string operations the results of library functions o f t e nu s e di n include expressions are left unresolved as symbolic strings.
wassermann et al.
extending earlier work by minamide model string values and string operations inphp programs using context free grammars and languagetransducers respectively.
although their analysis was focused on preventing injection attacks and cross site scripting vulnerabilities they also used their string analysis to resolve dynamic includes including using a path matching technique which seems similar to ours.
since this is done as part of a more complex analysis the overall execution time is muchhigher the runtime for the two largest systems in their evaluation lines of code in one case in another is more than hours.
biggar in his work on the phccompiler looked at a large corpus of php code packages downloaded fromsourceforge totaling files with lines of code including blank lines and comments .
he found fewer dynamic includes in his dataset than we have in ours only of the includes in his corpus are dynamic.
this may be just a difference of classification we consider any include to be dynamic that has a non literal operand while biggar also considers include expressions built using string literals concatenation and constants to be static we do not forthe reason mentioned above constant definitions are not globally unique through the entire system .
zhao et al.
in their work on the facebook hiphop compiler instead impose a requirement that all includes are statically known at compile time eliminating many of the legitimate uses we have found for this technique for instance to support installable plugins .
the algorithm presented here would loosen this requirement to allow includes that are static in practice while still allowing the flexibility of building the filename to be included using common string building operations and reachable constant definitions.
looking at other dynamic scripting languages with similar features richards et al.
used trace analysis to examine how the dynamic features of javascript are used in practice specifically investigating whether the scenarios assumed by static analysis tools e.g.
limited use of eval limited deletion of fields use of functions that matches the provided function signatures are accurate.
in a more focused study over a larger corpus richards et al.
analyzed runtimetraces to find uses of eval categorizing these uses into a number of patterns.
this is also the case with the work of furr et al.
who used profiling of dynamic ruby features to determine how these features are used in practice and to replace uses of these features with uses of equivalent static features.
.
conclusions php s include expressions are an example of a dynamic feature that has traditionally made static analysis of php challenging.
inthisworkwepresentedtwoalgorithms flres andpgres for resolving include expressions at the level of individual files and php programs respectively.
evaluating flresover a corpus of more than .
million lines of php code and more than files we showed that flresis effective at producing small sets of candidate files for many include expressions and generally runs fast enough to be used in php ides.
pgres evaluated over more than php programs scripts designed to be executed directly shows significant improvements on the results of flresin some cases with little to no improvement in others.
pgrescan be applied when accuracy is more important than efficiency for example when analyzing the security of php programs.
in future work we plan to make use of both algorithms in our ongoing work on the php air framework for php program analysis.
finally we plan to continue ongoing work on integrating php analysis with the eclipse ide with the goal of providing ide based support for developers to assist in developing understanding and refactoring large php code bases.
.