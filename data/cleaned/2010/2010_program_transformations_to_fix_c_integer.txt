program transformations to fix c integers zack coker auburn university zfc0001 tigermail.auburn.edu abstract c makes it easy to misuse integer types even mature programs harbor many badly written integer code.
traditional approaches at best detect these problems they cannot guide developers to write correct code.
we describe three program transformations that fix integer problems one explicitly introduces casts to disambiguate type mismatch another adds runtime checks to arithmetic operations and the third one changes the type of a wrongly declared integer.
together these transformations fixed all variants of integer problems featured in programs of nist s samate reference dataset making the changes automatically on over million lines of code.
we also applied the transformations automatically on open source programs.
the transformations made hundreds of changes on over lines of code but did not break the programs.
being integrated with source code and development process these program transformations can fix integer problems along with developers misconceptions about integer usage.
our work has been accepted at icse .
more information is available at the project page munawarhafiz.com research intproblem .
one can try the three program transformations on the web http .
.
problem and motivation ever since attackers shifted their attention from traditional buffer overflows to other types of attacks attacks on integer vulnerabilities have been on the rise even featuring as the second most common vulnerability behind buffer overflows .
typical programs with reported integer vulnerabilities have not been written recently they as well as other mature programs contain many integer problems some of which result in vulnerabilities.
the integer model of c is complex unintuitive and partly undefined making it easy to write code with integer problems.
our results show that even mature programs contain these problems.
there are four types of integer problems a signedness bug occurs when an unsigned type is interpreted as signed or vice versa an arithmetic overflow occurs when integer operations such as addition or multiplication produce a result that overflows the allocated storage anarithmetic underflow occurs when integer operations such as subtraction and multiplication produce a result that is smaller than what can be stored a widthness bug or atruncation bug is the loss of information when a larger integer type is assigned to a smaller type e.g.
int to short.
most of the recent works on integer problems focus on detecting integer vulnerabilities.
these approaches are insufficient in ways.
first they only apply to integer overflows.
a few tools target integer problems other than overflows but they have problems with performance and accuracy .
second these tools are not used because runtime approaches have performance overhead as high as 50x slowdown for brick .
however the most important problem is that these approaches do not help developers produce better code.
it is very easy to write c code with integer problems.
dietz and colleagues reported that unintended integer overflows are very common in real programs.
at the moment these factors are a part of why these tools are not more widely adopted.
.
background and related work research on integer problems primarily focuses on detecting integer overflow vulnerabilities either statically or dynamically.
the static analysis approaches target either source code or binary code.
intscope modifies binaries to an intermediate representation and then checks for integer overflow combining symbolic execution and taint analysis.
uqbtng also decompiles and then applies model checking with cbmc .
on the other hand some approaches examine source code e.g.
microsoft s prefast archerr etc.
ashcraft and colleagues approach uses bounds checking and taint analysis to see if an untrusted value is used in trusted sinks bounds checking is also used by sarkar and colleagues .
however both approaches are not applicable to detect all types of integer problems.
ceesay and colleagues added type qualifiers to detect integer overflow problems.
their approach requires user annotation and only detects integer overflow.
some dynamic analysis tools can detect all types of integer problems e.g.
rich brick and smartfuzz .
rich instruments programs to detect safe and unsafe operations based on well known subtyping theory.
brick uses a modified version of valgrind .
it iseither slow 50x slowdown or has many false positives.
smartfuzz is also based on valgrind but it uses dynamic test generation techniques to generate inputs leading to good test coverage.
sage and ioc are other dynamic approaches but they target fewer integer problems.
.
approach and uniqueness .
general approach we describe a program transformation based approach that fixes all types of integer problems in c programs.
we introduce three transformations an a ddinteger cast aic transformation that explicitly introduces casts to disambiguate integer usage and fix signedness and widthness problems a r eplace arithmetic operator rao transformation that replaces arithmetic operations with safe functions to detect overflows and underflows at runtime and a c hange integer type cit transformation that changes types to fix signedness and widthness problems.
they are similar to refactorings but they do not intend to preserve behavior.
they are instead security oriented program transformations that improve the security of systems by preserving expected behavior but removing integer problems.
they transform the integer model of c programs towards a safe integer model following cert and misra c guidelines.
a transformation based approach has several advantages.
first program transformations remove a frequent and repetitive task from developers.
people are bad at repetitive tasks computers are better.
second program transformations making small changes are more likely to be adopted .
most importantly the source level program transformations would help developers better understand and be aware of the subtleties of integer problems.
we have implemented the program transformations as eclipse plugins.
the program transformations are developed using openrefactory c our infrastructure for developing program transformations for c. openrefactory c features sophisticated analyses needed to support complex program transformations.
.
contributions our approach makes the following contributions.
it shows that integer problems in c programs can be prevented with a small number of source to source program transformations section .
.
these program transformations modify the integer model of a c program towards a safe model.
they guide developers by explicitly revealing mistakes in integer operations section .
.
it demonstrates that complex yet accurate source level c program transformations can be implemented as part of the refactoring catalog of popular ides.
it shows that the three program transformations can prevent all types of integer problems section .
.
it alsoevaluates the accuracy of the program transformations by applying them automatically to make many small modifications to open source programs in a way that produces programs that maintain functionality section .
and have minimal overhead section .
.
it presents an empirical study based on well known open source programs about the types and patterns of integer problems in source code section .
.
.
program transformations in action consider this recent widthness overflow vulnerability in ziproxy v. .
.
in line of image.c file.
979raw size bmp width bmp height bmp bpp in line the result of multiplying three signed integers is stored in rawsize a long long integer variable.
c first performs the integer multiplication in an integer context meaning that multiplying any values that produce results outside of the signed integer range would first wrap around the wrapped around value would then be cast to long long int.
during the wrap around information will be lost.
traditional approaches to detect integer overflows would add runtime checks on the multiplication our rao transformation would similarly replace the multiplication operations with safe functions that detect overflow.
however this solution is not perfect since the developer obviously wanted to use the full range of the long long integer variable to store the solution.
the context of the multiplication should be lifted so that a multiplication with long long integer values can be allowed.
a developer can first detect the problem with rao but then apply aic on rawsize to fix the context.
979raw size long long int bmp width long long int bmp height long long int bmp bpp additionally a developer can apply rao on the result to remove possibilities of overflow.
this adds defense in depth.
979raw size mulsll long long int bmp width mulsll long long int bmp height long long int bmp bpp .
description of the three transformations .
.
a ddinteger cast aic you have a program in which integer operations have operands with different types the end result may contain an unexpected value.
add explicit casts for all type mismatches so that they are visible and properly handled.
motivation signedness and widthness mismatches are very common section .
and may lead to unexpected results in a program s behavior.
if the types were explicitlymentioned e.g.
misra rules .
.
a compiler can unambiguously enforce the types.
precondition a developer selects an integer variable and invokes the aic transformation.
the variable s