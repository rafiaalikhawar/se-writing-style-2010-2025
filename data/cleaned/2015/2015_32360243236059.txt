path basedfunction embeddingand its application to error handlingspecification mining daniel defreez universityof california davis unitedstates of america dcdefreez ucdavis.eduadityav.thakur universityof california davis unitedstates of america avthakur ucdavis.educindy rubio gonz lez universityof california davis unitedstates of america crubio ucdavis.edu abstract identifying relationships among program elements is useful for programunderstanding debugging andanalysis.onesuchkindof relationshipissynonymy.functionsynonymsarefunctionsthat play a similar role in code examples include functions that performinitializationfordifferentdevicedrivers andfunctionsthat implement different symmetric key encryption schemes.
function synonymsarenotnecessarilysemanticallyequivalentandcanbe syntacticallydissimilar consequently approachesforidentifying code clones or functional equivalence cannot be used to identify them.
this paper presents func2vec a technique that learns an embedding mapping each function to a vector in a continuous vectorspacesuchthatvectorsforfunctionsynonymsareinclose proximity.
we compute the function embedding by training a neural networkonsentences generatedusing randomwalks overthe interproceduralcontrol flowgraph.weshowtheeffectivenessof func2vecatidentifyingfunctionsynonymsinthelinuxkernel.finally we apply func2vecto the problem of mining error handling specifications in linux file systems and drivers.we show that the functionsynonymsidentifiedby func2vecresultinerror handling specifications withhigh support.
ccs concepts computingmethodologies unsupervisedlearning softwareanditsengineering automatedstaticanalysis error handlingandrecovery keywords programanalysis programembeddings errorhandling program comprehension specification mining acmreference format danieldefreez adityav.thakur andcindyrubio gonz lez.
.pathbased function embedding and its application to error handling specification mining.
in proceedings of the 26th acm joint european software engineering conference and symposium on the foundations of software engineering esec fse november4 9 lakebuenavista fl usa.
acm newyork ny usa 11pages.
permissionto make digitalor hard copies of allorpart ofthis work for personalor classroom use is granted without fee provided that copies are not made or distributed forprofitorcommercialadvantageandthatcopiesbearthisnoticeandthefullcitation on the first page.
copyrights for components of this work owned by others than acm mustbehonored.abstractingwithcreditispermitted.tocopyotherwise orrepublish topostonserversortoredistributetolists requirespriorspecificpermissionand ora fee.
request permissions from permissions acm.org.
esec fse november 4 9 lake buenavista fl usa associationfor computing machinery.
acm isbn ... .
introduction apart from writing new code a software engineer spends a substantial amount of time understanding evolving and verifying existing software.
program comprehension entails inferring a mental model of the relationships among various program elements .
when available documentation can aid program comprehension .
for instance documentation about high level api functionsoftencontainsa seealso sectionenablingthereader to navigate to relevant functions.
however such documentation is eitherunavailableforlow levelcode oritisdifficulttomaintainas thecodeevolves .furthermore languagessuchasclackfeatures suchas polymorphismandencapsulation that makeexplicit the relationships between functions.
thispaperdealswiththeproblemofidentifying functionsynonyms functionsthatservethesamepurposeorplayasimilarrole in code.
identifying function synonyms is especially challenging inlow levelcodewritteninc suchasthelinuxkernel because i function synonyms are often semantically different and syntactically dissimilar e.g.
snd atiixp free andsnd intel8x0 freein the linux pci sound drivers atiixpandintel8x0 respectively ii function synonyms need not always have similarnames e.g.
acpi video get brightness andintel panel get backlight eachreturnthebrightnesslevelofthebacklight and iii functionswithsimilarnamesarenotnecessarilysynonyms e.g.
rcu seq start adjusts the current sequence number while kprobe seq start returns the current sequence number.
thus techniques that identify syntactic and semantic code clones check semantic equivalence or rely on naming conventions cannotbe usedto identifyfunction synonyms.
this paper presents func2vec a technique that learns an embedding mapping each function to a vector in a continuous vector space such that vectors for function synonyms are in close proximity.figure 1illustratestheoutputof func2vecforthepcisound drivers inparticular func2vecmaps eachfunction to a vector in r300 whichisthen projectedonto2 dimensionsusingt sne .
functions are grouped based on functionality probe open free etc.
e.g.
snd atiixp free andsnd intel8x0 free bothbelong to the group labeled free.
functions within each group are synonymous andare clusteredtogetherinthe func2vecembedding.
func2vecis based on the insight that two functions are synonymsifthecontextsinwhichtheyarecalledalongprogrampaths are similar.
specifically func2vecencodes the program as a labeledpushdownsystem l pds wherelabelsrepresentprogram elementssuchasfunctioncalls instructions types anderrorcodes.
random walks generated over the l pds are used to learn a vector esec fse november4 lake buena vista fl usa danieldefreez adityav.thakur andcindy rubio gonz lez figure function synonymclusters embedding using a neural network .func2vecis the first te chnique to use static interprocedural program traces to learn a function embedding that captures thehierarchical structureofprograms.
using two data sets we show that func2vecis capable of accuratelyidentifyingfunctionsynonymsforarunnablelinuxkernel million loc .
func2vecis the first to learn a function embedding forlarge scale low level code suchas thelinuxkernel.
as a case study we apply func2vecto the problem of mining error handlingspecifications inthelinuxkernel.anerror handling specificationliststhefunctionsthatshouldbeexecutedwhenan erroroccursbasedonthepreviousfunctionscalled.specification miningisapopulartechniquewithmanyapplications .
the number of times a specification occurs in the code is called its support.
to avoid reporting false specifications only specifications abovealargesupportthresholdarereported.however even fora code base as large as linux many true specifications have a low support .furthermore error handlingspecificationshavean even lower support because error handlingcode isless common.
thekeyinsightbehindmininghigh supporterror handlingspecifications isthat severallow supportspecifications canbe merged iftheyinvolvefunctionsynonyms.ourspecificationminerleveragesfunc2vecas well as multiple implementations of linux file systems and drivers to obtain mergederror handling specifications that have high support section 2presents an example.
the contributionsofthis paper are as follows func2vec a techniquefor learning afunctionembedding that captures the hierarchical structure ofprograms .
anevaluationoftheeffectivenessof func2vecforfindingfunctionsynonyms inthe linux kernel .
a formulation ofminingerror handlingspecifications for lowlevel systemscode that uses afunction embedding .
anevaluationoftheusefulnessof func2vecforminingmerged error handlingspecificationsacross10linuxfilesystems and linux device drivers .
we describe relatedwork in andconclude in .
motivating example this section illustrates how identifying function synonyms can be usedtomine error handlingspecificationsinlinux pcisound drivers.
figure 2shows excerpts from the function snd atiixp createin driver atiixp andsnd intel8x0 create in driverintel8x0 .
note that the functions look almost identical only because we have not shown dissimilar code loc in snd atiixp createand193locin snd intel8x0 create .
anerrorhandleriscodethatisexecutedifanerroroccurs in linux it corresponds to a conditional statement that checks for an error.figure 2showserrorhandlersfor snd atiixp create and snd intel8x0 create markedh1throughh5 .
an error handling specification imposes requirements on an errorhandlerbasedonthesetoffunctionsthathavebeenpreviously called.
an error handling specification is defined as ce r where cis thecontextandris theresponse.
this specification states that if the set of functions in the context are successfully called and an error occurs then the functions in the response must be called usually to release resources acquired by functions in thecontext .
the specification for error handler h2insnd atiixp create figure2a is pci enable device e pci disable device .the samespecificationistrueforerrorhandler h2insnd intel8x0 create figure2b .
thesupportof the specification is across all linux device drivers i.e.
there are occurrences that follow this specification inthe code.
thespecificationforerrorhandler h4insnd atiixp create is pci enable device kzalloc pci request regions e snd atiixp free .
the support of the specification is only .
the specification for the error handler h4insnd intel8x0 create is pci enable device kzalloc pci request regions e snd intel8x0 free whichhasthesamecontextasthespecification foundinatiixpbuthasadifferentresponse.thisspecificationhas a support of .
however assuming a support threshold of these two true specificationswouldnotbereportedbythespecification minerdueto theirlowsupport.
func2vecreports that snd atiixp free andsnd intel8x0 freeare function synonyms.
thus the above specifications can be combinedtoforma mergederror handling specification.anerror handler that supports any one of the specifications in the merge supports all of the specifications because the functions involved are synonyms.consequently merged specificationshave support higher than those of the corresponding individual specifications.
forexample whenconsidering48devicedrivers func2vecfinds 16functionsynonymsfor snd atiixp free andsnd intel8x0 free.usingthisinformation wefindamergedspecificationwitha supportof80.inlinux mergedspecificationsoftenresultfromcombiningmultiple similarimplementationssuchasmultipledevice driversormultiplefilesystems.ascanbeseen functionsynonyms are crucial for findingmergedspecifications withhigh support.
func2vec path basedfunction embedding func2vecmapsadiscretesetoffunctionstoacontinuousvector space that is given a vocabulary lof program functions each program functionl lis mapped to a d dimensional vector in rd.
toaccomplishthis func2vecgeneratesalinearizedrepresentation of programs viz.
sentences over a given vocabulary.
func2vecis thefirsttousestaticinterproceduralprogrampathsforthispurpose.
intuitively ifmanyprogrampathshaveacalltofunction f2after a call to function f1 and a call to f3after a call to f1 thenf2and f3should be embeddedclose to eachother.
424path basedfunction embedding esec fse november4 lake buena vista fl usa 1585intsnd atiixp create struct snd card card 1595if err pci enable device pci h1 1596return err 1598chip kzalloc sizeof chip ... 1599if chip null h2 pci disable device pci 1601return enomem 1609if err pci request regions pci h3 pci disable device pci kfree chip 1612return err 1614chip addr pci resource start pci 1622if request irq pci irq ... h4 1623dev err card dev irq d pci irq snd atiixp free chip 1625return ebusy 1632if err snd device new card ... h5 snd atiixp free chip 1634return err a function snd atiixp create indriver atiixp2989intsnd intel8x0 create struct snd card card 3036if err pci enable device pci h1 3037return err 3039chip kzalloc sizeof chip ... 3040if chip null h2 pci disable device pci 3042return enomem 3062if err pci request regions pci h3 kfree chip pci disable device pci 3065return err 3179if err snd intel8x0 chip init h4 snd intel8x0 free chip 3181return err 3184if request irq pci irq ... h5 3185dev err card dev irq d pci irq snd intel8x0 free chip 3187return ebusy b function snd intel8x0 create indriver intel8x0 figure2 a anexcerptfromthefunction snd atiixp create inthedriver atiixp sound pci atiixp.c .the functioncontains threeerror handling specifications.
each specification consists of a context set function calls highlighted in gray and a response set function calls in a box .
the first specification is associated with error handler h2and has a element context highlighted in gray and a element response in a box .
the second specification is associated with error handler h3and has a element context highlighted in gray and a element response in a box .
the third specification is associated with handlers h4andh5.ithasa3 elementcontext highlightedingray anda1 elementcontext inabox b anexcerptfromthe function snd intel8x0 create in the driver intel8x0 sound pci intel8x0.c in which threeerror handling specifications are alsofound.the specificationsforthetwofunctions differ onlyintheresponse forthethird specification.
a naive approach for linearizing a program is to generate a sentence using the instructions along every valid interprocedural path in the program.
such an approach has the following disadvantages using the entire instruction set would generate sentences with a verylargevocabulary therearetoomanyprogrampathsforthis approachtobepractical anditdoesnotcapturethehierarchical structure ofprograms.
thedesign of func2vecaddresseseach ofthese disadvantages.
func2vecabstractseachprograminstructiontoreducethevocabulary.
to address the path explosion problem func2vecperforms a randomwalkoftheprogramrestrictedtogenerate pathsoflength atmostkstartingatacalltoeachfunction.lastly onencountering a function call the random walk either outputs the function namearchitecture cindy rubio gonzalez july source codellvm l pdsrandom walker training function embeddingwalks source codellvm l pds random walkertraining function embedding walkssource codellvm l pdsrandom walkertraining function embeddingwalkssource codeprogram encoder l pdsrandom walkertrainer function embeddingwalks source codeprogram encoder l pdsrandom walkermodel trainer function embeddingwalks figure func2vecarchitectureitself ordecidestostepintothefunctiondefinition.thisstrategy of the random walk isable to capture the hierarchical structure of programs the context preceding the function call can be linked to either the function call itself or to the context in the body of the functionbeingcalled.figure 3showsthethreemaincomponents offunc2vec.
.
programencoder apushdownsystem pds isusedtomodelthesetofvalidinterprocedural paths inthe program .a pds is defined as follows definition3.
.
apushdownsystem isatriplep p where pand are finite sets control locations andstack alphabet respectively.
a configuration ofpis a pair p w wherep pand w .
containsafinitenumberofrules p p w where p p p andw whichdefineatransitionrelation betweenconfigurationsof psuchthatif r p p w then p w p ww for allw .
cr c denotes that the rule r was used to transition from configuration ctoc ofp.
to model control flow of a program a 425esec fse november4 lake buena vista fl usa danieldefreez adityav.thakur andcindy rubio gonz lez 1voidpci disable device struct pci dev dev 4struct pci devres dr ... 5if dr null dr enabled 8do pci disable device dev 11intsnd atiixp create ... struct pci dev dev ... 14struct atiixp chip ... 15if chip null pci disable device dev return enomem 19interr ... 20if err pci disable device dev kfree chip return err 25chip addr ... ... a simplifiedcodefromfigure 2a atiixp eq pci disable device enomemlt pci disable device kfreestore atiixppci devres eq pci devres do pci disable device snd atiixp create kfree pci disable devicen1 n2 n3 n4 n5 n6n7 n8 n9 n10 n11 n12 n13n14 n15 n16n17 n18 n19 n20 n21n22 n23 n24 n25 n26 n27n28 n29 do pci disable device b graphicalrepresentation of l pdsrulesfor snd atiixp create p n1 p n2 atiixp p n2 p n3 eq p n3 p n4 p n3 p n7 p n4 p n17n5 p n4 p n5 pci disable device p n5 p n6 enomem p n6 p p n7 p n8 store p n8 p n9 lt p n9 p n10 p n9 p n14 p n10 p n17n11 p n10 p n11 pci disable device p n11 p n26n12 p n11 p n12 kfree p n12 p n13 p n13 p p n14 p n15 atiixp p n15 p n16 p n16 p rulesfor pci disable device p n17 p n18 pci devres p n18 p n19 eq p n19 p n20 p n19 p n22 p n20 p n21 pci devres p n21 p n23 p n22 p n23 p n23 p n28n24 p n23 p n24 do pci disable device p n24 p n25 p n25 p c l pdsrules figure example of l pds encoding single control location p and the following three types of rules r p p w are sufficient i internalrules with w that model intraprocedural flow ii pushrules with w that model function calls and iii poprules with w that model function returns.
amostly standard wayofencoding aninterproceduralcontrolflowgraph icfg ofaprogramasapdsisused.themaindifference is when a function call is encountered given a call to function f whoseentrynodeis efontheicfgedge n1 n2 thepdscontains boththestandardcallrule p n1 p efn2 aswellasaninternal rule p n1 p n2 .
this new internal rule is akin to a summary edge for the called procedure.
the addition of this internal rule allows the random walk used by func2vec algorithm to either step over orstep intothe functioncall.
a labeled pds l pds is a pds in which each rule is associated with a sequence of labels and theselabels are concatenatedas the l pdsmakesits transitions.more formally definition .
.
alabeled pushdown system l pds is a triple l p l f wherep p is a pds lis a finite set of labels and f l is a map that assigns a sequence of labels toeachruleofp.aconfiguration oflisapair c l wherecisa configurationofthepds pandl l .
andfdefinethetransition relation lbetween configurations of lsuch that if cr c then c l l c ll wheref r l .
cr lc denotes that the rule r was used to transition from configuration ctoc ofl.
in practice labels are only attached to internal rules of the l pds.
a unique label is assigned to eachinstructioncategory errorcode structtype andfunction.each instructionisabstractedto alistof such labels as follows instructionsareclassifiedintocategoriessuchasload store eq etc.theinternalruleassociatedwithaparticularinstruction islabeledwiththe corresponding instructioncategory.
systems code defines specific constants that are used as error codes see .ifsuchanerrorisusedintheinstruction thenwe add the error code label to the corresponding internal rule.
iftheinstructionloadsorstorestoa structvariable thenwe add thestruct type label to the corresponding internal rule.
iftheinstructionisafunctioncall thenthefunctionlabeltothe corresponding internal ruleisadded.
example3.
.
figure4ashowssimplifiedfunctions pci disable deviceandsnd atiixp create from 2 .
figure 4bshows a graphicalrepresentationofthecorresponding l pds.figure 4clists thel pds rules we use the notation r lto mean that f r l in thel pds.
the instruction category labels used in this example are eq store lt for simplicity we do not include labels loadandret the struct typelabelsare atiixp pci devres the error code labels are enomem and the function labels are pci disable device kfree do pci disable device .
we describe the first rules for the function snd atiixp createin figure 4c.
the internal rule corresponds to line in figure 4a where the variable chipof typestruct atiixp is assigned.
thus the rule is labeled with struct type label atiixp.
the internal rule corresponds to the equality expression on line15 andisattachedtheinstructionlabeleq.unlabeledrules 426path basedfunction embedding esec fse november4 lake buena vista fl usa algorithm1 randomwalk l l k input l pdsl p l f startlabell walklength k output walk l1 ... ln p n p n l random r l r andl f r 2c p n l 3forn 0tokdo 4c random c cr lc for some r 5returnlabels c algorithm2 func2vec l w d k input l pdsl p l f window size w embedding size d walksper label walklength k output vector representation for labels l rd 1w 2fori 0to do 3foreachl ldo w w randomwalk l l k 5 trainmodel w d w and correspond to the trueandfalsebranches of the conditional on line .
call rule and internal rule are associated withthefunctioncall pci disable device online16.notethat the call rule is not labeled the internal rule has a function label pci disable device .finally rule isgiventheerror codelabel enomem andcorrespondsto the return statementonline .
.
random walker algorithm 1shows how to generate a random walk of an l pds.
given a set s random s returns an element s sthat is chosen uniformly at random.
labels returns the sequence of labels associated with anl pds configuration.
given an l pdsl a start labell andawalklength k arandomwalkisgeneratedasfollows.
a rule associated with label lis chosen at random line and the configuration cis initialized line .
then in the loop at line 4the current configuration cis updated by choosing uniformly at random a next configuration in the l pds.
note that in definition .
labels are concatenatedwhen the configurationisupdated.
example3.
.
considerlabell atiixp andwalklength k .
therearetworulesassociatedwith atiixp rules and from figure4c.
assume rule was chosen and the random walk starts at rule with label atiixp.
two possible random walks would be w1def atiixpeqpci disable device enomem w2def atiixpeqpci devres eqpci devres do pci disable device .
duringwalk w1internalrule waschosen whilewalk w2stepped intothe functioncallbychoosing the callrule .
.
model trainer given anl pdsl a window w a dimension d a number of walks perlabel andawalklength k func2vec algorithm generates walksforeachlabelin l andusesthemtotrainthemodel.the result isavector representation for labels l rd.trainmodel on line5uses a neural network to learn .
traditional language models try to estimate the probability of seeing a labelligiven the context of the previous labels in the random walk viz.
pr parenleftbig li l1 l2 ... li parenrightbig .
apart from learning the probability distribution of label co occurrences we also want to learn theembedding l rd.thus ourproblemistoestimatethe likelihood pr parenleftbig li l1 l2 ... li parenrightbig .
mikolov et al .
introduce a technique that uses a single layer fully connected neural network to approximate this likelihood.it uses a context of size w both before and after the given word and considers the context as a set ignoring the ordering constraint.
this results in the the following optimization problem for computing maximize logpr parenleftbig li li w ... li li ... li w parenrightbig .
the implementation of func2vecuses the implementation of mikolov et al .
providedingensim .
func2vec evaluation the experiments in this section are designed to answer the followingresearchquestions rq1.howeffectiveis func2vecatidentifyingfunctionsynonyms?
rq2.
whatimpact do path basedsentences have?
func2vecis evaluated against a runnable linux kernel with all filesystemsandpcisounddriversincluded roughly2millionloc.
theresultingl pdsconsistsof5 483stacklocations nodes pds rules and labels.
for this experiment the number of walks generated per label was the walk length kwas the vector dimension dwas and the window size wwas10.settingthewindowsize wto10indicatesawindowof where labels in either the forward or backward direction arewithintheslidingwindow.theseparameterswerechosenvia gridsearchoverasmalltrainingsetthatisdisjointfromthegold standard below.
to process the linux kernel func2vecrequires approximately 24g of memory and two hours of compute time on amazon ec2 r4 instances.
these instances use intel xeon e5 v4 broadwell processorsandddr4 memory.
gold standard.
we constructed two gold standard data sets to evaluatefunc2vec.thefirstdataset gs1 consistsof2 652unique functions that were identified by hand and reviewed with the help of a linux kernel developer.
these functions form equivalence classes of function synonyms ranging in size from two to .
note that the functions in gs1 cross components can violate naming conventions andaregenerallythehardestclassofsynonymstofind.
specifically gs1includes6 079functionpairsthataresynonyms butdonotfollowanyknownnamingscheme e.g.
nlmsg trim and genlmsg cancel and functions pairs that are notsynonyms butdofollowanamingscheme e.g.
sr release andsd release .
we constructed a second data set gs2 by relying on a single strong naming convention.
in linux it is often the case that two different functions are created that perform essentially the same task and one of the functions has underscores prepended to the name.gs2 consists of the2 pairs of functions ofthis form.
as a sanity check a random sample of pairs was selected and all were judgedto be function synonyms.
evaluation metrics.
two different metrics are used to evaluate func2vec.thefirstmetricistheareaunderthereceiveroperating 427esec fse november4 lake buena vista fl usa danieldefreez adityav.thakur andcindy rubio gonz lez a gold standardgs1 b gold standardgs2 figure receiveroperatingcharacteristic roc curves characteristic roc curveforpairsoffunctionsinourgoldstandard when those pairs are sorted by their cosine similarity.
this evaluates the claim that function synonyms are more similar to each other than to unrelated functions.
for the second metric the output offunc2vecis clustered using k means clustering and the results are comparedwiththe gold standardbycomputing the f score.
path based vs. flat comparison.
for each metric the performance of the path based approach used by func2vecdescribed in 3is compared with a flat walker.
the flat walker uses an identicall pds but lists the labels in the order that they appear in a function instead of generating path based sentences.
all other parametersandinputsare identicalto the path basedversion.
metric roccurves.
receiver operatingcharacteristic roc curves plot the true positive rate against the false positive rate as a parametervaries.theyarecommonlyusedtomeasuretheaccuracy ofasignaldetector astheyarewellsuitedforneedle in a haystack scenarioswheretruepositivesareexpectedtoberelativelyrare .
that is the case here where any two function pairs are unlikely to be synonyms of each other.
for the evaluation a much larger number of not synonym pairs are used than synonym pairs to mimic this expected distribution.
the accuracy of a detector can be visually gauged by how bowed the curve is.
note that small changes inthe area underthe curve can hidelarge differences.
theroccurvesinfigures 5aand5baregeneratedbysorting thesimilaritiesinthetwogoldstandarddatasets respectively and thenvaryingtherankcutoff anapproachusedinlauandbaldwintable func2vecmetrics goldstandardtest metric path based flat gs1 manuallyreviewed auroc .
.
gs2 underscore names auroc .
.
gs1 manuallyreviewed cluster f1 .
.
gs2 underscore names cluster f1 .
.
.
in essence function pairs in the gold standard data sets are sortedandeachpairiscountedaseitheratruepositiveorafalse positive based on its classification in the gold standard with the true positive andfalse positive ratesrecalculatedafter eachpair.
results.
figure5ashowstheroccurveproducedwhen func2vec isevaluatedagainstourgoldstandarddatasetofmanuallyidentified function synonyms gs1 .
figure 5bshows the roc curve produced when func2vecis evaluated against our gold standard data setoffunctionpairsthathaveidenticalnames onewithprepended underscores gs2 .
the area under each roc curve auroc is reportedintable .theoverallaccuracyof func2vecishigh as evidencedbythesharpriseoftheroccurves with func2vecperformingbetterontheeasierunderscorenamesthanthemanually inspected test set.
this answers rq1.
for each of our test data sets the path based walker significantly outperforms the flat walker.
this answers rq2.
metric2 k meansf score.
forthesecondmetric the func2vec vectorsareclusteredwithk meansandtheresultsarecompared with theequivalence classes inthegold standard.for eachcluster ciand gold standard class lj the precision recall and f score are definedas follows precision ci lj ci lj ci recall ci lj lj ci lj f ci lj recall ci lj precision ci lj recall ci lj precision ci lj togetanoverallscorethatcombinesprecisionandrecall the f scoreoverallgoldstandardclassesisused .sinceanimperfect cluster may partially overlap multiple gold standard classes we computeprecisionandrecallscoresfortheproductofgoldstandard classes and k means clusters.
the precision and recall matrices are combinedintoasinglef scorematrix penalizingaclusterforeither including extra functions or missing functions.
the maximum fscoreforeachsetofsynonymsinthegoldstandardisused creating a mapping between k means clusters and gold standard classes.
theaveragef scoreoverallclassesinthegoldstandardisreported here weightedbythe size of eachgold standardclass.
f summationdisplay ili nmax f ci lj results.
our evaluation of func2vecshows that it is capable of clustering functionsynonyms between functions in the linux kernelwithbothhighprecisionandrecall.thef scorenumbersare reportedintable .thef scoreforthepath basedwalkerishigher thanthatfortheflatwalker.thef scoreforgs1comportswiththe auroc.
however the functions in gs2 do not cluster as well as 428path basedfunction embedding esec fse november4 lake buena vista fl usafunction synonymssource codecontext response extractor minererror handler locator specifications function synonymssource codecontext response extractorerror handler locator specs spec miner function synonymssource codecontext response extractorerror handler locator specs spec miner figure specification mining architecture those in gs1.
after extensive testing we believe this is a challenge ofapplyingk meansclustering andthattheaurocisamorereliable metric here.
this provides additional evidence for the answers to rq1 andrq2.
threats to validity.
identifying function synonyms is an inherently subjective task.
we tried to mitigate this as much as possible by enlisting the assistance of a linux kernel developer when constructingourgoldstandard.multiplepeopleperformedoverlappingclassificationindependently andanyconflictingclassifications wereflaggedanddiscussed.nonetheless itisnotfeasibletoconstruct exhaustive ground truth for the linux kernel and therefore itispossiblethat func2vecwillperformdifferentlyforclassesof function synonyms we are unaware of.
error handlingspecifications to show the practical utility of identifying synonymous functions withfunc2vec we present a detailed case study exploring their effectonminingerror handlingspecifications.themajorphases oftheminingprocessare locatingerrorhandlers extractingerror handlercontextsandresponses andfrequentitemsetmining.these phasesare showninfigure 6anddescribedinthis section.
.
definingerror handlingspecifications error handlingspecificationsareminedbasedontheobservation that the actions performed after an error occurs the error handler response frequently dependontheactionscarriedout beforethe erroroccurred theerror handlercontext .suchacontextandresponse pair definean error handlingspecification.
errorhandlers.
anerrorhandlerisapieceofcodethatisexecuted upondetectionofanerror.ourevaluationtargetsthelinuxkernel which is written in c. without explicit error handling language constructssuchastry catch locatingerrorhandlersinccodemust relyonsomeamountofdomainknowledge.weknowthatlinux defines a specific set of integer error constants referred to as error codes.
when returned from a function these error codes denote that an error has occurred.
this is known as the return code idiom.
thecontextandresponseof an error handler consist of the functions called before and after an error is detected respectively.
in many cases the order in which these functions are called does not matter.oncethepredicateassociatedwiththeerrorhandlerisidentified the context and response are computed via traversing the code pathsinthe backwardandforwarddirections respectively.
example5.
.
thefunction snd atiixp create infigure2acontainsthefiveerrorhandlersh1 h5 whicharelistedintable 2along withtheircorresponding contextsandresponses.
1static struct inode btrfs new inode ... most of the function is omitted 3path btrfs alloc path ... 5btrfs free path path 6ret ... 7if ret btrfs free path not required figure code snippet from the btrfsfile system.
the path isfreed priorto theerrorhandleron line 7is reached.
error handlingspecifications.
anerror handlingspecification is defined as an association rule whose antecedent is the specification contextandconsequentisthe specificationresponse .thisrulesimply means thatthe setoffunction calls inthe contextimplies thatthe setoffunctioncallsintheresponsearerequiredtohappenoncean errorisdetected.
definition .
.
anerror handling specification sis defined as cse rs wherecs c1 c2 ... cm isthecontextsetoffunction callsforthespecification s andrs r1 r2 ... rm istheresponse setoffunction calls for the specification s. example .
.
the following error handling specifications can be inferredfor the atiixp sound driver s1def pci enable device e pci disable device s2def pci enable device kzalloc e pci disable device kfree s3def pci enable device kzalloc pci request regions e snd atiixp free definition5.
.
anerror handlingspecification sdef cse rsis applicableto anerror handler h denotedby s h iffcs chand cs rs ch wherechandrhare the context and response of the errorhandler h respectively.
example5.
.
considertheerror handlers h1 h5inex.
.1and the specifications in ex.
.
thens1 h2 s2 h3 s3 h4 and s3 h5.
the first term cs chin definition .4says that the entire specificationcontextmustapplytothehandlercontext.thesecond termcs rs chisaddedforcaseswheretherequiredresponse actionshavealreadyhappenedpriortoaparticularerrorhandler being reached as illustratedbythe following example.
example .
.
consider the specification sdef btrfs alloc path e btrfs free path andthecodesnippetfromthe btrfs filesystem showninfigure .thecontext chfortheerrorhandlerhatline7is btrfs alloc path btrfs free path .ifdefinition5.4is restricted to only contain the term cs ch then specification sisapplicabletotheerrorhandler h.clearlythisis incorrect as the path has been allocated and then freed prior to the error handler being reached.
consequently without the second term in definition .
the error handler hwould be flagged as a violation even though the pathhas already been freed.
definition5.
.
anerror handlingspecification sdef cse rsis satisfied by an error handler h denoted by s h iffs hand rs rh whererhisthe response of h. 429esec fse november4 lake buena vista fl usa danieldefreez adityav.thakur andcindy rubio gonz lez table errorhandlers in snd atiixp create errorhandler lines function generating error context response h1 pci enable device h2 kzalloc pci enable device pci disable device h3 pci request regions pci enable device kzalloc pci disable device kfree h4 request irq pci enable device kzalloc pci request regions dev err snd atiixp free h5 snd device new pci enable device kzalloc pci request regions request irq snd atiixp free given an error handling specification and an error handler the miner is able to report a violation of the specification using definition5.
.
example5.
.
considertheerror handlersinex.
.1andthespecifications in ex.
.
thens1 h2 s2 h3 s3 h4 ands3 h5.
ifthecalltofunction snd atiixp free online1633infigure 2a wasmissing then s3 h5 i.e.
s3wouldnotbesatisfiedby h5.
the above definitions of error handling specifications and satisfiability can be extended to handle synonymous functions .
letfbe thesetoffunctionsintheprogramthatisbeingmined.
f fis asaidtobea partitionfunction iff f1 f2 forallfunctions f1 andf2thatareidenticalorsynonyms.weabusenotationslightlyby extending the partition function that applies to a single function to a set of functions f1 f2 ... fn f1 f2 ... fn .
similarly givenanerror handlingspecification sdef cse rs we use s to mean cs e rs .
definition .
.
given a partition function a setxof errorhandling specifications is said to be a mergederror handling specification withrespectto iff s s for alls s x. example .
.
letthe partitionfunction be such that snd atiixp free snd intel8x0 free .then pci enable device kzalloc pci request regions e snd attixp free pci enable device kzalloc pci request regions e snd intel8x0 free is a merged error handlingspecification withrespectto .
using this notation definitions .4and5.7can be naturally extendedto mergederror handlingspecifications.
definition5.
.
amergederror handlingspecification xisapplicable to an error handler h denoted by x h iff there exists s xsuch that s h. definition .
.
a merged error handling specification xis satisfied byan error handler h denoted by x h iff there exists s xsuch that s h. .
miningerror handlingspecifications given a set of error handlers with their respective contexts and responses frequent itemset mining is used to infer likely errorhandlingspecifications.frequentitemsetminingalgorithmstake the minimum support threshold as a parameter and return all sets of items that have a support greater than or equal to this threshold.lettbe a set of transactions where each transaction t tis asetofitems.afrequentitemsetminingalgorithmreturnsthesets ofitems that frequently co occur inthe same transaction in t. definition .
.
thesupportof a set of items igiven a set of transactionstisdefinedassupp i def t t i t .
to construct the merged specifications frequent itemsets are mined at a low support threshold.
after frequent itemset mining is performed specificationsthatusefunctionsynonymsaremerged together.
all pairs of specifications with functions in either the context orresponse that exceed a similarity threshold are merged.
set intersection is performed over the remaining items.
the transitive closure overthese mergedspecification pairs is taken yielding equivalence classes that form the final set of merged specifications.
thesupportforanunmergedspecificationisidenticaltoitssupport as an itemset.
however the support of a merged specification isnotsimplythesumofthesupportofcorrespondingunmerged specifications but the number of uniquetransactions error handlers thatsupportthemergedspecification whichmaybelowerif the unmergedspecifications share supportingerrorhandlers.
specification miningevaluation this section is designed to answer the following question what impactdofunction synonymshave onthe quality ofmined errorhandling specifications?
we mine error handling specifications in drivers and linux file systems btrfs ecryptfs ext2 ext4 gfs2 hfs hfs nilfs2 ocfs2 andufs .
we chose linux filesystems and drivers because of the dire consequences of error handling defects but the mining approach is general and can be applied to other parts of linux ortoanycprogramthatusesthereturn codeidiomforerror handling.
frequent itemset mining is used to infer specifications in thisevaluation butfunctionsynonymscouldbeusedtoenhance otherminingtechniques.
implementation details.
as shown in figure our miner takes asinput errorhandlercontextandresponsesets and synonymous function information.
our implementation relies extensively onthellvmcompilerinfrastructure .tolocateerrorhandlers weuseanexistingllvm basederror propagationanalysis augmented with an llvm pass that identifies handlers based on alistoffunctions that are knownto be calledonlyonerror paths.
table3showsthetotal numberof errorhandlersfound.function synonyms are identified by func2vec.
eclat lcm is used to compute frequent itemsets.
430path basedfunction embedding esec fse november4 lake buena vista fl usa table numberoferrorhandlers impl.
handlers impl.
handlers btrfs nilfs2 ecryptfs ocfs2 ext2 ufs ext4 shared vfs gfs2 sound drivers hfs hfs total table4 specificationsupportimprovementwhenusingsynonyms.
the un.
column lists the support for each specificationwithoutmerging andthe mrg.
columnliststhesupport foreachspecification after merging.
specification un.
mrg.
pci enable device kzalloc pci request regions e snd intel8x0 free pci enable device kzalloc pci request regions e snd intel8x0m free pci enable device kzalloc pci request regions e snd atiixp free pci enable device kzalloc pci request regions e snd ice1712 free pci enable device kzalloc pci request regions e snd via82xx free pci enable device kzalloc e snd nm256 free pci enable device kzalloc e azx free pci enable device kzalloc e snd ali free pci enable device kzalloc e snd emu10k1x free pci enable device kzalloc e snd ca0106 free btrfs alloc path e btrfs free path btrfs alloc path e btrfs release path gfs2 holder init e gfs2 holder uninit gfs2 glock nq e gfs2 glock dq gfs2 glock nq init e gfs2 glock dq uninit hfs find init e hfs find exit hfsplus find init e hfsplus find exit kmalloc e kfree kzalloc e kfree results.
weinspectedallspecificationswithatleastsupport50for thebtrfs ext4 gfs2 andocfs2filesystems support20forthe ext2 ecryptfs hfs hfs nilfs2 andufsfilesystems support for sound drivers and support for code shared by all implementations.beforemerging thesounddriverresultscontainedonly error handling specifications above the support threshold all of which weredeemed correctby manual inspection.aftermerging therewere31specificationsabovethethreshold all31beingcorrect.
beforemerging thefilesystemresultscontained11error handling specificationsabovethesupportthresholds.aftermerging there were specifications above the thresholds allcorrect.1static int gfs2 get flags ... ... 3gfs2 holder init ip i gl ... 4error gfs2 glock nq gh 5if error missing call to gfs2 holder uninit 7return error ... 9gfs2 glock dq gh 10gfs2 holder uninit gh 11return error figure8 bugfoundin gfs2.thefunctionshouldnotexiton line7without calling gfs2 holder uninit .
examples of specifications .
to further illustrate the impact on specificationquality table 4shows six examples ofmergederrorhandling specifications.
the first example shows a specification foundacrossdevicedrivers see .
all18functionsfoundinthe response sets e.g.
snd intel8x0 free snd via82xx free etc.
are function synonyms reported by func2vec for brevity we only list individual specifications .
this results in a merged specificationwithasupportof80.withoutsynonyms theseindividual specifications would not be reportedatallbecausetheyfall below the support threshold of10.
not all of the sound driver specifications in table 4have the same form.
the five specifications in the second row starting with snd nm256 free are taken from a group of merged specifications.
unlike the first example these do not include pci request regions in the context even though all of these free functions are synonymsandclosetogetherinthe func2vecembedding.thefree functions in the second row do not call pci release regions andtherefore pci request regions doesnotappearinanyofthe contexts.here specificationminingand func2vechaveworkedin concert to arrive at the correctspecifications.
thebtrfsexample in table 4illustrates merging specifications within a single implementation.
btrfs free path is a synonym of the function btrfs release path as the primary purpose of eachistodropreferencestoapathinthefilesystem.thedifference is thatbtrfs free path also frees the memory while callers of btrfs release path handle the memory operation separately.
mergingtheserelatedspecificationsbringsupthe btrfs release pathversionsothat they appear togetherinthe miningreport.
the specifications shown in the fourth row of table 4led to the discovery of two previously unknown bugs in the gfs2file system.
the patch we submitted to fix these bugs was accepted by red hat and mergedinto linuxversion .
.figure 8shows one ofthe two bugs.thefunctionfirstcalls gfs2 holder init whichacquires a reference to a glock.
the function then attempts to enqueue thisholderstructure.onthe normalpathwhere gfs2 glock nq succeeds there is no problem.
if gfs2 glock nq fails on line however gfs2 holder uninit is never called even though gfs2 holder init completed successfully.
as is common with error handling bugs only in rare circumstances will this problem be encountered because it requires gfs2 glock nq to fail.
but when the bug is triggered the consequences are severe resulting in an inaccurate reference count for the glock.
431esec fse november4 lake buena vista fl usa danieldefreez adityav.thakur andcindy rubio gonz lez thefifthrowintable 4showsaspecificationthatcrossestwo relatedfilesystems hfsandhfs .thehfsandhfs filesystems are implemented by linux to interoperate with mac os.
other relatedfilesystemssuchas ext2andufsalsocontainspecifications that can be improvedbymergingwithfunction synonyms.
finally the sixth row illustrates how function synonyms can be useful even for specifications that already have high support.
the function kzallocissimilar to kmalloc because they both allocate memory but kzalloczeroes the memory first.
from an error handlingperspective they are equivalent.
related work distributed representations.
distributedrepresentationshave beenextensivelystudiedinnaturallanguageprocessingandcognition .
recent advances have resulted in scalable approaches to computing such distributed representations or vector embeddings given a corpus of sentences for instance word2vec and glove .
deepwalk computes vector embeddings of nodesin a graph.
deepwalk is similar to func2vecin that they bothuserandomwalkstogenerateacorpusofsentences.however deepwalk generates walks consisting of nodes whilefunc2vec generates walks consisting of labelsalong edges.
func2vecalso abstractstheprogramcodeintoan l pds.yeetal .
applyvector representations to information retrieval in software engineering byusingword2vec ondocumentation associatedwithcode.
nguyen et al .
computesdistributed representations of api functions using word2vec .
they generated sentences using the program ast as opposed to interprocedural paths and used their techniquetomigrateapiusagesfromjavatoc .similarly alon etal.
presentsanapproachforlearningprogramrepresentations using paths in the ast which is then used to predict names for variablesandmethodsinjavascript java python andc programs.
wang et al .
learns program embeddings from program execution traces and use the embeddings to classify errors in student programming assignments written in c .
deepbugs learns aword2vec based embedding for each identifier in a javascript programusingthesequenceoftokensaroundtheidentifier.this embedding is used for name based bug detection.
in contrast to theseapproaches weproposeatechniquetolearnafunctionembedding from interprocedural static paths in the program and use the embedding in mining error handling specifications in linux whichiswritten inc. error handling specification mining.
one ofthe key developmentsintheerror handlingspecificationminingliteraturehasbeen theuseofnormalpathstominespecificationsforerror handling paths.
this line of thought was first mentioned in and was subsequently usedinseveral otherpapers .
weimerandnecula findassociationrulesoftheform fca fce wherefunctioncall fcashouldbefollowedbycall fce and fceisfoundatleastonceinexception handlingcode.improving on thummalapenta and xie mineconditional association rules of the form fc1c...fcnc fca fc1e...fcne which denotes asequenceoffunctioncallspriortothetargetfunction fcathat throws an exception and then a sequence of recovery function calls.
acharya and xie mine error handling specifications from interprocedural traces.
cleanup functions are identified from errortraces whicharethenusedalongwithnormaltracestofindspecifications.gouesandweimer broadenthisnotionoftracereliability to include a number of other features e.g.
execution frequency cloning code age density etc.
and significantly improve the false positiveratereportedin .collectively theseapproacheshave beensuccessfulatfindingdefectsinerror handlingcodethatshares function calls with normal paths.
but there exist functions that are onlycalledonerrorpaths andthatareonlymeaningfultolinux.
thus the correct use of these functions cannot be deduced from normal paths or outside programs and they would be missed by the above approaches.
muchoftheworkonerror handlingspecificationshasfocused onlanguageswithexception handlingsupport suchasjavaorc .
severalapproaches finderror handlingspecifications injavaprogramsusingstaticanalysis.buseandweimer infer andcharacterizeexception causingconditions whicharethenused asdocumentation.weimerandnecula usedataflowanalysis to locate resource management mistakes in error handling code andproposealanguageextensiontoimprovereliability.acommon mistake found might be the failure to release resources or to clean up properly along all paths.
identifying blocks of error handling code in these languages is comparatively easy but as we have shown itismorechallengingtodistinguishbetweennormaland error handlingpathsinlinux.
implementationinconsistencies.
engleretal .
usethenotion of internal consistency to find programming errors.
one of their techniquesforfindingrelatedpiecesofcodereliedontheidiomatic use of function pointers to define multiple implementations of a single interface.
min et al .
compare multiple file systems by leveraging the vfs interface to identify implementations of the same functionality.theseare complementary to our work.
conclusion weintroducedthenotionof functionsynonyms whicharefunctions that play a similar role in code.
synonymous functions might be syntacticallydissimilarandmightnotbesemanticallyequivalent.
we presented func2vec a technique that learns an embedding mapping each function to a vector in a continuous vector space such that vectors for function synonyms are in close proximity.
specifically func2veccomputes a function embedding by training aneuralnetworkonsentencesgeneratedusingrandomwalksofthe interproceduralcontrol flowgraphoftheprogram.weshowedthe effectivenessandscalabilityof func2vecbyevaluatingitagainst twogold standardsoffunction synonyms inthe linux kernel.
we showed how func2veccan improve the quality of errorhandlingspecificationsfor10linuxfilesystemsand48linuxdevicedrivers.achallengeinminingerror handlingspecifications isthattheirsupportisoftentoolow.toovercomethischallenge func2vecwas used to identify function synonyms across multiple implementations of file systems and device drivers.
these function synonyms were then used to merge individual error handling specifications resultinginmergedspecificationswithhighsupport.