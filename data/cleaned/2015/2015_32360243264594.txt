asketch a sketchingframework foralloy kaiyuanwang university oftexasat austin usa kaiyuanw utexas.eduallison sullivan university oftexasat austin usa allisonksullivan utexas.edu darkomarinov university of illinoisat urbana champaign usa marinov illinois.edusarfrazkhurshid university oftexasat austin usa khurshid utexas.edu abstract alloy is a declarative modeling language that supports f irst order logic with transitive closure.
alloy has been used in a varie ty of domains to model software systems and f ind design de f iciencie s. however it is often challenging to make an alloy model corre ct or to debug a faulty alloy model.
asketch is a sketching synt hesis technique that can help users write correct alloy models .
asketch allows users to provide a partial alloy model with hole s a generator that speci f ies candidate fragments to be consider ed for each hole andasetofteststhatcapturethedesiredmodelpr operties.
then the tool completes the holes such that all tests f or the completedmodelpass.
asketch uses testswrittenfortherec ently introducedaunitframework whichprovidesafoundationof testing unittests testexecution andmodelcoverage forall oymodelsinthespiritoftraditionalunittesting.thispaperdes cribesour java implementation of asketch which is a command line too l released as an open source project on github.
our experimen tal results show that asketch can handle partial alloy models wi th multiple holes and a large search space.
the demo video for as ketch can befound at .
ccs concepts softwareand itsengineering source codegeneration keywords sketching f irst orderlogic asketch acmreference format kaiyuanwang allisonsullivan darkomarinov andsarfrazkhurshid.
.
asketch asketchingframeworkforalloy.in proceedingsofthe26thacm jointeuropeansoftwareengineeringconferenceandsympos iumonthefoundations of software engineering esec fse november lake buena vista fl usa.
acm newyork ny usa 4pages.
introduction software modeling languages which can be used to describe k ey attributes of software systems play an important role in he lping engineers build reliable systems.
many modeling languages have permission to make digital or hard copies of all or part of thi s work for personal or classroomuseisgrantedwithoutfeeprovidedthatcopiesar enotmadeordistributed for pro f it or commercial advantage and that copies bear this n otice and the full citationonthe f irstpage.copyrightsforcomponents of thiswork owned byothersthan acmmustbehonored.abstractingwithcreditispermitted.t ocopyotherwise orrepublish topostonserversortoredistributetolists requ irespriorspeci f icpermission and or afee.
request permissionsfrompermissions acm.or g. esec fse november4 lake buena vista fl usa associationfor computing machinery.
acm isbn978 ... .
proposed over the last few decades .
alloy is a wellknown modeling languages which comes with an automatic satbasedanalyzer thatperformsanalysis usinga boundedscope ontheuniverseof discourse.over thepastfew years many al loy extensions have beendeveloped .
the alloy analyzer helps users validate their models using a utomated analysis.
typically alloy users apply the followi ng validationapproaches which aresupportedbythestandardallo yanalyzer solving constraints expressed in the model and c hecking if expected alloy instances are present while unexpected instancesareabsent writingrelatedformulasandvalida tingifthe expectedproperties among them hold e.g.
implication or e quivalence and using a sat solver s unsat core feature to high light partsofthemodelthatmake theformulasunsatis f iable.
a few recent projects adapt the notion of traditional testin g fromimperative programs to declarative modelsin alloy.theaunitframework introducesforalloythebasictestingfoundations i.e.
unittesting testexecution andmodelcovera ge.
followupworkonmualloy introducesmutationtestingforalloy and provides a technique for mutation based test generatio n for alloy models.
a more recent complementary project called a sketch introduces sketching for partial alloy models.
asketchallowsuserstowritehigh levelskeletalmodels w hilethe toolsynthesizes thelow level details.
thispaperdescribesourjavaimplementationofasketch wh ich isacommand linetoolthatwereleasedasanopen sourcepro ject .
asketch takes as input a partial alloy model with holes a generator that provides po tential candidate fragments to be considered for each hole and a set of aunit tests that capture the desired properties of the exp ected model.asketchencodesallinputsasasingle meta model inalloy andinvokesthesatsolvertoexplorethesearchspace.theou tput isacompletealloymodelwithholesreplacedwithconcretec andidatefragmentssuchthatalltestspass.weevaluateasketch using alloy models that were used in previous work .
the experimentalresultsshowthatasketchisableto f indasolutio nofa partialalloymodelwithmultipleholesandalargesearchsp acein areasonable amountof time upto15holes and morethan4.4e1 possiblecandidatesolutionsin 7seconds .
aunit background asketch takes as one of its inputsaunit tests and then comple tes partialalloymodelswith holes suchthat allprovided aunit tests pass.
we brie f ly describe aunit via an example more details a re availableelsewhere .figure1showsanacyclicsingly linked list model.
the model declares a singleton set of one listatom esec fse november4 lakebuena vista fl usa k. wang a.sullivan d.marinov ands.khurshid one sig list header lonenode signode link lonenode predacyclic alln node n inlist.header.
link n !
inn.
link runacyclic figure1 acyclic singly linkedlist list0 node0 node1header link figure2 examplelist instance predtest some disj list0 list some disj node0 node1 node list list0 andnode node0 node1 header list0 node1 andlink node1 node0 acyclic runtest figure3 exampletestfor list and a set of nodeatoms.
each listatom has zero or one header nodes.
each nodeatom has zero or one subsequent nodes along thelink.bothheaderandlinkarepartialfunctions.thepredicate acyclicstates that the listis acyclic if the following holds for eachnode n ifnisreachablefromthe list s headerfollowingzero ormoretraversalsalongthe link thennisnotreachablefromitself followingone ormoretraversals alongthe link.
ifwerunthe acyclicpredicateusingalloyanalyzer wecanget anexampleinstanceshowninfigure .theinstancecontainsasinglelistatom list0 andtwo nodeatoms node0andnode1 .list0 s headerisnode1 andnode1 s next node is node0.list0satis f ies the acyclicpredicatebecausethere is nocycle in thelist.
an aunit test is a pair of a model valuation and a run command.
for example the instance in figure 2can be written as an aunit testshown infigure .thetest declares a single listatom list0 and 2disjoint nodeatoms node0andnode1 .
itrestricts the entirelistset tobe list0 andnodeset tobe node0 node1 .
the test predicatealso states that the headermapslist0tonode1 and thelinkmapsnode1tonode0.
since the valuation represents an acyclic list we expect the acyclicpredicate to be satis f ied.
thus weinvoke acyclic inthetestpredicateandexpecttheexistence of a solution to the run test command.
in this case running the test predicate results in an isomorphic alloy instance simi lar to the one shown in figure .
if a valuationis not expected then we caninvokethenegationofthecorrespondingpredicateinth etest predicate itself.
for example if a list is cyclic then we ca n invoke !acyclic in the test.
asketch assumes that all tests should pass i.e.
alltest predicates shouldbesatis f ied.
technique asketch has twomain components input interpreter parse the model with holes and interpret the generator tocreate candidatefragments.
outputsynthesizer encodethemodelwithholes thecandidate fragments and the aunit tests into a meta model and invoke sat solvertosearch forsolutions.
thequalityofthesolutionsdepends onboththegenerator an d the test suite.
if the generator provides fragments that are semantically equivalent to the desired candidate fragments and the test suitecapturesthepropertiesofthedesiredmodel thenask etchis more likelyto generate thedesired solutionin a few iterati ons.
in practice there could be multiple solutions that make all th e tests pass.
asketch can iteratively provide these solutions if th e user wants toinspect them.holekind notation candidates binaryoperator bo compare operator co in !
!in logical operator lo quanti f ier q all no some lone one unaryoperator uo no some lone one unaryoperator expression uoe unaryoperator formula uof !
expression e any expression figure4 supportedholes we f irstillustratetheinputlanguage speci f icallythesupp orted holekindsandthegeneratorgrammar.then wedescribethro ugh an example how the synthesizer translates the sketching pro blem intoa constraint solving problem.
.
input language .
.
hole kinds.
figure4shows the kind notation and candidate fragments for all holes supported by asketch.
for examp le users can use a quanti f ier hole q id where qindicates that it is thequanti f ierholekind and idisanidenti f ierthatrefers toagenerator which provides the candidate fragments for the hole v ia a regular expression regex .
the default regex for a quanti f i er hole is all no some lone one .
anotherexampleistheexpression hole e id whichcanbecompletedwithanyexpressionsyntacticallyvalidinthecontextofthehole.notethattheregex for unary operatorformulaholeis either negation !
oranemptystring .
.
.
generator grammar.
users can provide a generator for a holeusing regexes withthefollowinggrammar regexdecl id quotedbl.var quotedbl.var quotedbl.var quotedbl.var regex quotedbl.var quotedbl.var regex nonspecial regex quotedbl.var?
quotedbl.var quotedbl.var quotedbl.var regex quotedbl.var quotedbl.var regex regex regex quotedbl.var quotedbl.var regex forregexdecl idintroduces an identi f ier to be referred from a hole e.g.
q id andeis a regex.
we follow the design choice of the sketch framework that includes three regex operators option e?
concatenation e1 e2 and choice e1 e2 as well as parentheses for precedence.
nonspecial can be any string that containscharacterssupportedbythealloygrammarexceptf or and which need tobeescaped as and respectively.
we use antlr4 to generate the parser with the generatorgrammar and implement a backtracking algorithm to deco de theregex intoall possiblecandidatefragments.
.
synthesizer asketch converts thesketching problem into aconstraint s olving problem in the alloy language itself which is then solved by the alloyanalyzer.speci f ically asketchgeneratesasingleal loymetamodelthatencodesallpossiblesolutions i.e.
candidatemodel sobtained from all possible combinations of all candidate frag ments forallholes.
for example consider an alloy user who wants to model the acyclicproperty shown in figure and comes up with the followingskeletonfor thepredicate ?
?
n node n inlist.header.
link n !
in??
theuserisnotsurewhatquanti f ier f irst ?
?
andwhatexpression second ?
?
to use in the skeleton but knows roughly what to search for each hole and also which instances are desired a nd 917asketch a sketching frameworkfor alloy esec fse novemb er4 lakebuena vista fl usa which are undesired.
the user can provide the following part ial alloymodel agenerator and a set oftests toasketch model with holes one sig list header lonenode signode link lonenode predacyclic q q n node n inlist.header.
link n !
in e e runacyclic generator q all some no e list.header node n .
?link ?
aunit tests that capture desired model properties predtest ... thegeneratorstatesthatthequanti f ierholeshouldtakeava lue from and the expression hole should take a valuefrom list.header list.header.link list.header.
link list.header.
link node node.link node.
link node.
link n n.link n. link n. link .
the user also provides aunit tests similar to the example in figure 3to represent both desired and undesired valuations foracyclic lists.
asketch automatically creates an alloy meta model shown in figure5.
the f ield declarations are removed from the generated meta model line .
instead asketch parameterizes the acyclic predicate with one new parameter per signature and one new pa rameter per f ield lines .
the quanti f ier hole is replaced with a predicate call line q which is declared to encode all possible quanti f iers that can appear in the quanti f ier hole lines .
the f irst parameter o f the predicate q hin line represents the value chosen for the hole.
lines encode the potential candidate quanti f iers as sign atures andrqis one of q all q some orq no.
the rest of the parameters inqare exactly the same as the parameters in the acyclic predicate.
the body of the predicate qstates how the parameter hdetermines the value of the quali f ier hole if hisq all then the quanti f ier hole is all lines and similarly for some lines and no lines .anyreference toadeclaredsignature or f ieldis replaced bythecorrespondingparameter in predic ateq e.g.
list.header.
link is replaced with lists.header.
link .
the expression hole is replaced with a function call lines and expr which is declared to encode all possible expressions that can appear in the expression hole lines .
s imilar to the predicate q the f irst parameter of function expr hin line represents the value chosen for the hole.
lines enc ode the candidate expressions as signatures e0toe11 andreis equal to one of them.
note that the expression hole is in the scope of variable n so the function expralso has a parameter for it line .becauseall userspeci f iedcandidateexpressions areof arity1 thereturntypeof expralsohas anarityof univinline .the body of the function exprstates how the parameter hdetermines the value of the expression hole if hise0 then the expression is lists.header line which maps back to list.header in the originalmodel andtheexpressionencodingissimilarfort heother candidate expressions.
theaunittestfromfigure 3istranslatedtoafact lines where the signatures and f ields are represented byfresh vari ables introduced by the letexpressions.
the acyclicpredicate is also invoked withthecorresponding fresh variables.
theentiremeta modelusesalloyfactstorequirethatallau nit tests mustbesatis f ied.if we invoke theempty runcommand line then the alloy analyzer returns a solution that assigns q all1.one sig list signode .predacyclic lists list header list node .
nodes node link node node .
q .one sig rqinq abstract sig q .one sig q all q some q no extends q .predq h q lists list header list node .
nodes node link node node .
h q all alln nodes n inlists.header.
link .
n !
inexpr .
h q some somen nodes n inlists.header.
link .
n !
inexpr .
h q no non nodes n inlists.header.
link .
n !
inexpr .one sig reine abstract sig e .one sig e0 e1 e2 e3 e4 e5 e6 .
e7 e8 e9 e10 e11 extends e .funexpr h e lists list header list node .
nodes node link node node n node univ .
h e0 lists.header else .
h e1 lists.header.link else .
h e2 lists.header.
linkelse .
h e3 lists.header.
link else h e4 nodes else .
h e5 nodes.link else h e6 nodes.
linkelse .
h e7 nodes.
link else h e8 n else .
h e9 n.link else h e10 n. linkelse .
h e11 n. link else none .
.
sketch run .facttest .some disj list0 list some disj node0 node1 node .
letlists list0 letheader list0 node1 .
letnodes node0 node1 letlink node1 node0 .
acyclic .
more tests... figure5 meta modelfor list torqande10tore whichindicatesthatthequanti f ierholeandthe expressionholeintheoriginalpartialmodelshouldberepl acedby all and n. link respectively.
usage in this section we describe how users can invoke asketch.
mo re detailscan befound ontheasketch githubhomepage.
to sketch a partial alloy model run .
asketch.sh run m arg f arg t arg or .
asketch.sh run model path arg fragment path arg test pa th arg .
theoptions are m model path thisargumentis required.passthe f ilename of thepartialalloymodeltobesketched.
f fragment path this argument is required.
pass the generatorwhichprovidesthecandidatefragmentstobeconside red foreach hole.
t test path this argument is required.pass the test suite which contains aunit tests that capture the desired propert ies of theexpectedmodel.
s scope thisargumentis optional.passthealloyscopefor solvingthegenerated alloymeta model.thescopeistypica lly larger than or equal to the minimum scope necessary to make all aunit tests satis f ied.
if the argument is not speci f ied th e defaultvalueof 3is used.
n sol num this argument is optional.
pass the number of uniquesolutionsthatasketchshouldreport.iftheargumen tis not speci f ied thedefaultvalueof1 is used.
for each run the asketch tool reports the candidate fra gmentsforeachholeafterexpandingthecorrespondingregul arexpression the order the associated identi f ier the kind and the 918esec fse november4 lakebuena vista fl usa k. wang a.sullivan d.marinov ands.khurshid model hole space test scp prim cls t sol arr bt .7e4 .9e4 cd .5e7 .1e4 contains .2e4 ctree .4e11 .8e4 deadlock .2e4 dll .2e7 .7e4 grade .2e7 remove .1e4 .9e4 sll 2e4 figure6 asketchmodelstats timeinmilliseconds candidate spacesizefor each hole thesizeof theentire search space computed by multiplying the sizes of individual fragm ents acrossallholes and asetofsolutions ifany aswellas thesolving time for each solution.
furthermore asketch stores the generated alloy meta model in a hidden directory project dir .hidden solve.als .
evaluation we describe the experiments and results for evaluating aske tch.
we ran asketch on a macbook pro with a .5ghz intel core i74870hq.
figure 6lists the partial alloy models involved in the experiment and the corresponding stats from asketch.
modelis the model names arrmodels arrays btmodels binary trees cd models java class hierarchy contains checks whether a list containsanelement ctreemodelstwocoloredundirectedtrees deadlockmodelsprocessdeadlocks dllmodelsdoubly linkedlists grademodelsteaching assistantsgradingassignments removemodels removing an element from a list and sllmodels singly linked lists.allmodelsare fromprevious work .
wemakethesemodelspartialbyreplacingfragmentswithvar iousholekinds.forexpressionholes weusecandidateexpre ssions of different arities e.g.
arity and and types e.g.
sig nature typesandthealloyintegertype .
holeshowsthenumberofholes for each partial model.
spaceshows the size of the search space i.e.
thenumberof combinations ofcandidatefragments acr oss all holes.
testshowsthenumberofaunittestsprovidedtocomplete each partial model.
scpshows the scope used to search for solutions.
primand clsshow the number of primary variables and clausesforrunningthegeneratedmeta model whichmeasur esthe complexityofthesketching problem.
tsolshows thetime in milliseconds taken to f ind the f irstsolutionthatsatis f ies all t ests.
thenumberofholesofourevaluationmodelsranges from3to .thesearchspacerangesfrom80to4.4e11.weusethesamet est suitethatcomeswith each modelintheprevious workand dele te irrelevantteststhatdonotinvokethepredicateswewantto sketch.
the number of primary variables for the generated meta mode ls ranges from49to531.thenumberofclausesforthemeta mode ls rangesfrom1873to9.8e4.thesolvingtimeto f indthe f irstsol ution ranges from 96msto6473ms.
thesizeofthesearchspacedependsonthenumberofholesand thegenerators fortheholes.if apartial modelhas a largenu mber of holes and the generator for each holeprovides a large num ber of candidate fragments then the sketching problem has a lar ge search space.
typically a more complex meta model makes co nstraint solving slower.
for example ctreehas the largest numberofprimaryvariablesandclausesamongallgeneratedmeta m odels and it takes more than seconds to f ind the f irst solution.
in co ntrast arrhasthesmallestnumberofprimaryvariablesandclauses andittakestheleastamountoftimeto f indthe f irstsolution.
however the increasing size of the search space does not necess arily imply increasing number of primary variables and clauses in the generated meta model.
for example gradehas a search space of size1.2e7and deadlock hasasearchspaceofsize4800 butthegeneratedmeta modelfor deadlock ismorecomplicatedthanthatfor grade.
overall these results show that asketch is able to handle partial models with multiple holes up to and a large sear ch space morethan400billion .
conclusion this paper introduced the open source asketch tool for sket ching partial alloy models with holes.
asketch provides comma ndlineoptions toautomaticallytranslatethesketching prob lem into aconstraintsolvingproblemandthensearchforsolutions.
givena partialalloymodelwithholes agenerator andasetofauni ttests thatcapturethedesire propertiesof themodel asketch is a bleto report a set of solutions such that all aunit tests pass.
our e valuation shows that asketch is able to handle partial alloy mod els withmultipleholes and a largesearch space.