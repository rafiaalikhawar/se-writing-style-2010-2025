phys probabilisticphysicalunit assignment and inconsistency detection sayali kate purdueuniversity usa skate cs.purdue.edujohn paul ore university ofnebraska lincoln usa jore cse.unl.eduxiangyuzhang purdueuniversity usa xyzhang cs.purdue.edu sebastian elbaum university ofnebraska lincoln usa elbaum cse.unl.eduzhaoguixu nanjing university china zhaogui.xu outlook.com abstract programvariablesusedinroboticandcyber physicalsystemsoften haveimplicitphysicalunitsthatcannotbedeterminedfromtheir variabletypes.inferringanabstractphysicalunittypeforvariables andcheckingtheirphysicalunittypeconsistencyisofparticular importanceforvalidatingthecorrectnessofsuchsystems.forinstance avariablewiththeunitof meter shouldnotbeassigned toanothervariablewiththeunitof degree per second .existing solutionshavevariouslimitationssuchasrequiringdevelopersto annotate variables with physical units and only handling variables that are directly or transitively used in popular robotic libraries with known physical unit information.
we observe that there are a lot of physical unit hints in these softwares such as variable names and specific forms of expressions.
these hints have uncertainty as developers maynot respectconventions.we propose tomodel them with probability distributions and conduct probabilistic inference.
at the end our technique produces a unit distribution foreachvariable.unitinconsistenciescanthenbedetectedusing thehighlyprobableunitassignments.experimentalresultson30 programs show that our technique can infer units for .
more variables compared to the state of the art with more than .
truepositives andinconsistenciesdetectionon90programsshows that our technique reports .
more inconsistencies with .
true positives.
ccs concepts software and its engineering abstract data types softwaredefectanalysis mathematicsofcomputing factor graphs keywords abstract type inference physical units static analysis unitconsistency dimensionalanalysis probabilisticinference roboticsystems permissionto make digitalor hard copies of allorpart ofthis work for personalor classroom use is granted without fee provided that copies are not made or distributed forprofitorcommercialadvantageandthatcopiesbearthisnoticeandthefullcitation on the first page.
copyrights for components of this work owned by others than acm mustbehonored.abstractingwithcreditispermitted.tocopyotherwise orrepublish topostonserversortoredistributetolists requirespriorspecificpermissionand ora fee.
request permissions from permissions acm.org.
esec fse november 4 9 lake buenavista fl usa associationfor computing machinery.
acm isbn ... .
format sayalikate john paulore xiangyuzhang sebastianelbaum andzhaogui xu.
.phys probabilisticphysicalunitassignmentandinconsistency detection.in proceedingsofthe26thacmjointeuropeansoftwareengineeringconferenceandsymposiumonthefoundationsofsoftwareengineering esec fse november 4 9 lakebuena vista fl usa.
acm new york ny usa 11pages.
introduction programvariablesrepresentingphysicalunitslike meterorradian arecommoninroboticandcyber physicalsystems.however the typesofthesevariables e.g.
floatanddouble canhardlydenote such physical information.
while compilers and many analysis techniquesensurevariablesaremanipulatedaccordingtothetypingrules ensuringvariableswithphysicalunitsaremanipulated accordingtothesemanticsofthephysicalworld however isless commonandyetascrucialforthesekindsofsystems.forexample a recent study found hundreds of faulty manipulations in robots using the ros middleware .
those systems builtcorrectly but presented inconsistent unit manipulations such as assigning linear meter per second and angular radian per second units to avariable oraddingvariablesrepresentingvelocity meter persecond anddistance meter .
automated approaches to aid in the detection of inconsistent usageofvariablesrepresentingphysicalunitsincludeunit aware programming languages unit aware libraries and unittypeannotations .theseapproaches however havenot been broadly adopted in part because of their associated cost in modifyingexistingsystemsorchangingentrencheddevelopment practices.approachesthatrequirenoadditionaldevelopmentinvestment are desirable but rare.
one of such approaches unify candetectunitusage discrepanciesacrossversions butitcannotdetectunitinconsistencieswhenavariableisfirstintroduced.
anotherapproachistakenby ayudante whichinfersabstract typeinconsistenciesbycontrastingclustersofvariablesbasedon dataflowversusclustersbasedonthemeaningofvariablenames asperalargelexicaldatabase .thisapproach however misses muchoftheuniqueconstructivesemanticsofphysicalunits like meter2 meter meter andassumesthatallthesevariableand name associations are certain when in practice they are probabilistic.amorebroadlyapplicableapproachthatrequiresnoadditional developer investment is phriky units phriky which relies on onetimemappingofphysicalattributesinshared librariestounits toinfertheunitsofvariables andusesalightweightdataflowanalysisandunitpropagationtofacilitateinconsistencydetectionusing esec fse november4 lake buena vista fl usa s.kate j. ore x. zhang s.elbaum z. xu dimensionalanalysis.theone timemappingandlightweightanalysisthatmake phrikycost effectiveatdetectinginconsistencies also limititspower.inparticular wenoticedthat phrikyonlyassigns units to a small fraction of the variables of non shared library data types that hold physical units in this paper we quantify that space to be under31.
.
to address that limitation we propose an approach that can tap onnewsourcesofinformationtoassignunitstoalargerportionof thevariablespace facilitatingthedetectionofmoreinconsistencies.
the approach builds on two key insights.
first variables representing physical entities are often named and operated on to reflect thoseentities givinghintsaboutvariables units.forexample in the statement v angspeed wheel diam names angspeed and wheel diam suggest that they represent angular speed and length respectively and a multiplication operation on them indicates that variablevis intended to represent linear velocity.
second since the correctness of these hints is not certain developers can violate naming conventions or inappropriately operate on units we must deal with themprobabilistically.for example sincename wheel diam doesnotusetheentityterm diameter completely wecan only say that it is likely to have unit meter with some probability.
put together these insights indicate that there are hints to be leveragedbuttodosoweneedtomodelthesourcesof uncertainty in terms of probabilities.
more specifically our approach collects initial observations or beliefs based on various evidences such as variable names and expression forms that suggest physical unit e.g.
expression x indicates xhas unit radian and encodes them as initial probabilities to model uncertainty analyzes the code to generate five kinds of probability constraints that denote dependencies between variable units generates a graph where the nodes are the initial observations and constraints transformed into functions on the variables and the edges connect the functionswith theircorresponding variables and performs belief propagation along theedges to determine theposterior probabilities denoting the likelihood that a variable would have an associated physical unit.
once the variables have a physical unit assigned detection of inconsistency is performed following establisheddimensionalanalysisrules .
the contributionsofour work are a probabilistic approach for physical unit inference and inconsistency detection that takes advantage of variables names expressionforms andassociatedoperationstomake probabilisticinferences ofunittypes.
aprototypeoftheapproachimplementedinatool phys that assignsunitsanddetectsinconsistenciesonc programs.
an evaluation on sample ros based project files.
the assessmentshowsthat physcaninferunitsfor159.
more variables of non shared library data types in sample files with more than .
true positives and detect .
more inconsistencies in sample files with .
true positives when comparedwiththe state of the art.
background inthissection weintroducethebasicnotationsofphysicalunits and unit inconsistencies and provide a brief overview of probabilisticinference basedongraphicalmodels.
.
physical unitsandunit inconsistency detection inroboticsoftware somevariablesrepresentthephysicaldimensions such as length velocity and acceleration.
each of these variables carries a physical unit e.g.
a variable representing length stores a value ofunit meter .
operations on such variables need tofollowcertaindimensionalrules e.g.
alengthvaluecannotbe added to a velocity value.
violation of such a rule we refer to asunit inconsistency .
in order to detect a unit inconsistency we firstneedtocollect thephysical unitinformationof eachvariable.
however physical unitinformationisnotexplicitlydeclaredfor variablesunliketypeinformation.forexample whilelengthand velocity carry different physical units meter and meter persecond respectively they may be represented by variables of the sametype e.g.
float .therefore traditionaltypecheckingofa softwareprogramcannotdetectunit inconsistencies.anewkindof analysis is required to detect unit inconsistencies.
these analyses focus on inferring the physical units of variables.
there have been anumberofpreviousworksthataimtoaddressthischallengesuch as the tools phriky andosprey .
inparticular phrikyperformsunitconsistencyanalysisonprogramsthatusearoboticshared librarycontainingdata typesfor various physical quantities.
these shared library data types providethebasicunitinformationforasubsetofvariablesasastarting pointfortheanalysis.suchinitialunitinformationispropagated to other variables through a set of inference rules similar to typing rules.specifically thetool phrikyimplementsalookuptable called a mapping from attributes of shared libraries to physical units forsoftwarewrittenfortherobotoperatingsystem ros .ros is a publisher subscriber middleware that defines commonly used messagesinsharedlibraries.thesesharedmessageshaveattributes withphysical meaningslike lengths velocities andaccelerations.
ourtoolphysleveragesthisone time mapping duringanalysis as one way to find variables with units.
also it uses the same notation for physical units and unit inconsistencies as defined by phriky.the notation isdescribedbelow.
physical units.
the physical unit representation contains a standard setofunitsfromthespecification ofinternationalsystem of units si plus some units officially accepted to be used with the si system.following unitsare definedas u meter second kilo ram quaternion radian de ree 360 amp candela de ree celsius unknown dimensionless u1 u2 u unitunknown means that the unit of a variable is not known.
the unitdimensionless means a variable does not have a unit such as a scaling factor or the ratio meter per meter .
the product u1 u2represents a multiplication of two units and u 1represents the inverse of a unit.
together product and inverse form variousderivedunitslike meter second i.e.
aunitofvelocity meter per second .
further note that we use the same unit to represent variables of the same dimension.
so two variables of the lengthdimensionwithdifferentunitsinpractice centimeter and meter respectively are assumedto have the same unit meter .
564phys probabilistic physicalunitassignment... esec fse november4 lake buena vista fl usa unit inconsistencydetection.
theviolationofdimensionalrules such as one can only add or compare values of the same dimension aretranslatedtounit inconsistenciesoverprogramconstructs.
they are listedbelow.let u1andu2be twodifferentunits.
addition subtractionofinconsistentunits aninconsistencyis detectedwhenthereisanaddition subtractionoftwodifferentunits.
notethatmultiplicationanddivision ofinconsistent unitsmay be legitimate such as meter per second second and hence not a goodstandardfor inconsistencydetection .
u1 u2 comparison of inconsistent units an inconsistency is detected when twodifferentunitsare comparedto eachother.
u1 nequal u2 assignment of inconsistent units.
this category includes two cases a the left side and the right side of an assignment have different units b the right side of an assignment has two different units e.g.
a right side variable may have different units in the two branches of a conditional statement.
note that we union the units.
u1 u2 x u1 u2 function with different unit arguments an inconsistency is detectedwhenafunction s ithargumentreceivesvalueswithdifferent unitsintwodifferentfunctioncalls.
f u1 f u2 detectionofunit inconsistenciesservestwopurposes theinconsistentuseofunitsmaybeintentionalasperthedeveloper.insuch acase itisalwaysrecommendedtodocumentasuspicioususeof units especiallywhenthecodeismeanttobereused.thismakesit easiertomaintainthecode theinconsistentuseofunitsexposes the sourceofapotentialunintendedsystembehavior orabug.
.
probabilisticinference with graphical models often while solving real world problems we need to draw conclusionsbasedonincompleteoruncertaininformation.uncertainty is usually modeled in the form of a probability distribution.
the process of performing inference based on such models is called probabilistic inference .
one type of probabilistic inference is the computationofamarginalprobabilityoftheeventorproperty.for example in our case we need to compute the marginal probability that a variable xhas unitufrom the probability distribution of all variables in the program being of unit u. the probability that xhas unituis conditioned on how xis used in the program and dependsonwhatisassignedto xandhowxisusedinmathematical expressions.
factor graphs are used to represent the structure ofthis conditional dependence.
in factor graphs arandom variable or aboolean variable with probability ris .
chance true is used to denote a predicate e.g.
program variable xhas unitu orp x u .
inter dependent randomvariablesaredenotedasapropositionallogicformulawith probabilities.forinstance theinformationthatavariable vellikely hastheunitof meter per second withprobability0.7isdenoted byn vel meter per second .
p vel meter per second .
intuitively itmeansfromthenamingconvention n thinkofitasa dictionary that maps a name to its unit we know that a name vel hasthe meter per second unit wethenhave0.7confidencethat variablevelis really of that unit with probability .
modeling the uncertainty of naming conventions i.e.
programmers may not a code snippet showing several constraints related to variable q1.
source b inference resulting in meter per second unitsfor q1.
figure example unit inconsistency detected using probabilisticconstraints.
respect naming conventions .
arandomvariablemay be involved in multiple propositional logic formulas denoting its dependencies.
forinstance iftheprogramhasanassignmentstatement x y we havep y u .
p x u .thefactorgraphenginewilltakethese formulas derivethecorrespondingjointprobabilitydistribution and perform probabilistic inference.
there are various inference algorithms bothexactandapproximate definedforthesegraphical models.
the approximate algorithms allow us to find solutions where the exact inference is infeasible.
after inference the postdistribution denotes the fusion of all the uncertain evidences and henceouranalysisresults.adetaileddescriptionofprobabilistic graphicalmodelsrepresentationandinferencecanbefoundin .
physusesafactorgraphmodeltorepresentthejointprobability distributionofvariablesbeingofunit u.and sincetherecanbea largenumberofvariablesintheprogram itusesanapproximate algorithm for the unitinference.
motivating example figure1ashowsacode snippetfromaros basedprojectfileavailable on github summit xl robot control.cpp .physreports 565esec fse november4 lake buena vista fl usa s.kate j. ore x. zhang s.elbaum z. xu an inconsistency on line .
the nature of the inconsistency is that therobot slow levelwheelcontrollersarecommandedanincorrect reference velocity.
this inconsistency is difficult to detect statically oratrun timebecauseitissyntacticallyandsemanticallycorrectas per the programming language and the wheel turns in the correct direction but the velocity is incorrect in proportion to the radius of therobot swheel itisnotapparentforsmallerwheels .asaresult undersomescenarios therobotcanmoveundesirablyslow.insuch cases controlengineersoftenblamethelow levelcontrollerandtry tocompensatebytuningcontrolgains i.e.
changingparameters to make the motors more sensitive to the faulty signal leading to potentialinstabilities.
wearemotivatedbythesekindsofstealthy difficult to detect bugsthatrequirecombiningmultipleinformationsourceseachwith adifferentdegreeofcertainty fromlesscertainvariablenamehints to more certaindataflowhints.
goingbacktoourexampleinfigure 1a todetectthe subtraction ofinconsistentunits inline18 weneedtoinferunitsof joint state .velocityandq1 omitted for brevity .
inferring units for variables like joint state .velocity which instantiate shared ros libraries attributes with known unit types is already done successfullybyphrikyusingpredefinedmapssowereusethatapproach.
more specifically variable joint state .velocity is an attribute of classsensor msgs jointstate and the mapping determines that the attribute jointstate velocity have units per second .
variableq1 however doesnotinstantiateanythingwithaknown unit.
inferring units for such variables requires a new and more sophisticated approach for unit inference as used by our tool phys.
we note that variable q1on line is assigned units computed from the units of wx1 andwy1 description for wy1omitted for simplicity .
wx1isassignedunitsonline14 providingadataflow constraintfrom v ref x becausev ref x ispartofanaddition and we assume allunits withinanaddition are thesame.
for inferring the units of v ref x we have two hints a dataflow constraint online6from linearspeedxmps alongwithanaminghintbecause linearspeedxmps containsthesubstring speed and2 assignment ofunitsresultingfromtheprocedure saturation online24.interestingly saturation uses its first parameter as the return variable and thus provides a hint that its returned units may be the same as itsfirstargument sunits.therefore online24 v ref x islikelyto havethesameunitsasargument cmd vel.linear.x thathasaknown unitassociatedas part ofthe map.
allthesehintstogetherformasetofprobabilisticconstraints partiallyshowninfigure 1basaninferencegraph.
physthencalculates the likelihood of possible unit assignments for q1and assigns the most likely unit which turns out to be meter per second withthe highestprobability of0 .
reportingthat addition of inconsistent units on line .
attempting to add to .
approach in this section we first provide a high level overview of phys then give a detailed description of the probabilistic constraints generated byphys and finally discuss how the probabilistic inference engine transforms probabilistic constraints into a factor graph and conducts graph inference.variables with associated units inconsistency reports unit inconsistency detection probabilistic inference engine probabilistic constraint collector dataflow naming computed unit known symbol conversion code predefined unit maps stage stage phys apply units and iterate figure overview ofphys framework.
table constraint predicate definitions type symbol definition dataflow d var u varhas unitubased ondataflow dependencyof varon ros typedvariable.
naming n var u varhas unitubased onits name.
computed unit c var u unit uofvaris computed from the right side of assignmentstatement var expr .
known symbol k var u varhas unitubased onknown symbols.
conversion f var u varhas unitubased onunit conversion expression.
priorprobabilitypred q predis truewith probability q. implication pred1p pred2pred1impliespred2with probability p. table collected constraintsforexample infigure .
ln probabilistic constraint iter 24c v ref x ms .
p v ref x ms 25c v ref y ms .
p v ref y ms p v ref x ms .
p linearspeedxmps ms n linearspeedxmps ms .
p linearspeedxmps ms 14p wx1 ms .
p v ref x ms 15p wy1 ms .
p v ref y ms 16c q1 ms .
p q1 ms n summit xl wheelbase m .
p summit xl wheelbase m n summit xl trackwidth m .
p summit xl trackwidth m 12p l m .
p summit xl wheelbase m 13p w m .
p summit xl trackwidth m 26c w ref s .
p w ref s p w ref s .
p angularspeedrads s n angularspeedrads s .
p angularspeedrads s 12c x1 m .
p x1 m 13c y1 m .
p y1 m 14c wx1 ms .
p wx1 ms 15c wy1 ms .
p wy1 ms figure2shows an overview of the physframework.
it is divided into two stages stage infers units with the help of a probabilistic inference engine and stage uses the inferred units to detect unit inconsistencies.
stage1 probabilisticunitinference.
there are two main componentsforunitinferenceasshowninfigure 2stage1 probabilistic constraint collector and probabilistic inference engine.
the constraint collector first preprocesses the code to generate a list of functions and then scans each function to identify variables that instantiate ros shared library data types.
using a predefined map 566phys probabilistic physicalunitassignment... esec fse november4 lake buena vista fl usa fromrosattributestounits thesevariablescanbedirectlyassignedaphysicalunit.themappingisaone timeeffortandconsists of data structures each having fields.
for example variables instantiating the ros attribute geometry msgs twist.linear.x are mappedto meter per second .
themappingprovidesasubsetof variableswithknownunitsandallowsustotransferthisknown unitinformationtovariablesofnon sharedlibrarytypeandthen fuseitwithotherunithints.
next the constraint collector traverses through the code to gather unit hints called observations and to derive constraints that denoterelationsbetweenvariables.table 1definesfivetypesofobservations dataflow naming computed unit known symbol and conversion denotedaspredicatesassertingavariable varhasaunit u. these observations are associated with some prior probabilities to express the initial confidence in those observations to be true whichiscapturedbytheconstrainttypedefinedinthesixthrowof table1.thecollectoralsoconstructsimplicationconstraints asper theseventhrowoftable whichcapturetheinter dependencesof the predicates based on program semantics allowing probabilities tobepropagatedandfused.last theconstraintcollectorrecords composite units such as meter per second squared theresult of combining units in mathematical expressions.
the observed and composite unitsare addedto the set unit set.
after all constraints have been collected the probabilistic inference engine transforms the constraints into a factor graph.
the engine performs belief propagation in the graph for each unit in unit set.thisyieldsaposteriormarginalprobabilityforeach variable var havingaunit u denotedas p var u .ifthereissome evidencefor u i.e.
withprobability p .
where0.5isnoknowledge and uismorelikelythananyotherunit then varisassigned the unitu.
as shown in figure stage includes an iterative process of gathering constraints running the probabilistic inferenceengine inferringunits andagaingatheringconstraints.the iterative part isrepeateduntil afixedpointisreached.
stage2 unit inconsistencydetection.
theunitinconsistency detector scans the annotated abstract syntax tree ast for unit inconsistencies as defined in section .
.
that is inconsistent addition subtraction comparison assignment orfunctionarguments.
tomitigatefalsepositives thedetectorisconservativelyconfigured bydefaulttoreportaninconsistencyonlyifthethreemostlikely unitassignmentstothevariablesinvolvedinanexpressionallyield an inconsistency.
physthen emits a list of variable unit assignment andany detectedinconsistencies.
.
probabilisticconstraints physhastwoformsofconstraints theprior probabilityconstraints andthe implicationconstraints.
as shown in table a prior probability constraint encodes that aninitialobservation predistruewithsomeconfidence q andis denotedpred q .
this constraint encodes belief from prior human domain knowledge and distributions of known types inferred solely from ros libraries.
the inherent uncertainty in this constraintcanbesubstantiallysuppressedwhentheinferenceengine fusesinformation from manysources.
implicationconstraintsareusedtorelatetwopredicates randomvariables together and take the form pred1p pred2 with confidencep andcanalsobebidirectional.table 2showsimplicationconstraints collected from the code snippet in figure 1a.
notice howeveryconstraintinthetableisformulatedasanimplication constraint from anobservationpredicatetoa posteriorpredicate such as and or from a posterior predicate to another posterior predicate such as and .
next we discuss how to collect the constraints from the data flow naming computed unit known symbolandconversionperspectives.
dataflowconstraints.
dataflowconstraintsarecollectedforvariablepairsthatcanhavethesameunitduetoprogramdataflow.for example figure 1ahas a dataflow constraint on line wx1and v ref x andthegeneratedconstraintisshownintable .inthis example thedataflowconstraintencodesthedimensionalrulethat the units resulting from addition subtraction are likely the same as the units of the operands.
as shown in the table this constraint has a probability of .
.
it is a standard to use .
to represent high confidence inthe inference .
moregenerally variousprogramexpressionssuchasaddition comparison min max function calls and copy provide unit hints about their operands according to the dimensional rules.
the operandsofsuchexpressionsorstatementspotentiallyrepresent quantities with the same unit.
if a dataflow relation for the same unit is detected for variables aandb we add an implication constraint between the two predicates p a u .
p b u where u unit setandconfidence ispropagatedinboth directions.
for variables with unit hints from the ros mapping we formulate the followingconstraints a prior probabilityconstraint d b k .
withdasserting the unit of a ros variable and an implicationconstraint d b k .
p b k .
namingconstraints.
developerstendtousevariablenamesthat hint atthe physical quantitiesthey represent.
for example linearspeedxmps contains speed thatsuggestsalinearvelocity.
phys uses a hand coded lookup table between common strings called suffixes andunits.forexample length and distance aremapped to meter .
generating the table is a one time effort.
the current versioncontains only entries.
tofind the bestsuffixmatch physuses asimilaritymetric sim var u max s s u len lcs var s k max len suffix here sim var u computes the maximum similarity between variablevaroverallsuffixes s where s u isthesetofallsuffixes withthesameunit u.theterm len lcs var s k representsthe lengthofalongestcommonsubstringbetweenavariable varanda suffixssuchthatthelengthisatleast kandthesubstringstartswith thefirstkcharactersofasuffix s k 3inourimplementation .the longesthand codedsuffix max len suffix .
the maximum similarity score sim var u is then converted to anaming constraint n var u p .
.
sim var u theconfidence pisscaledsothatasimilarityof0isaconfidence of .
meaning no evidence .
an implication constraint is also generated.for linearspeedxmps itis n linearspeedxmps ms .
p linearspeedxmps ms the predicate n linearspeedxmps ms has an initial confidence .
.
sim var ms thatispropagatedto p linearspeedxmps ms withprobability .
.
567esec fse november4 lake buena vista fl usa s.kate j. ore x. zhang s.elbaum z. xu table probabilisticconstraints.
type expression condition probabilistic constraints dataflow aop1b c?a b op1 !
a ros typed vars b nelementros typed vars ros var a u d b u .
d b u .
p b u min a b max a b a nelementros typed vars b ros typed vars ros var b u d a u .
d a u .
p a u a bop2cos x a b op2sin x op2 a nelementros typed vars b nelementros typed varsp a u .
p b u function definition f typea ... function call f b ... naming var name p .
sim var name u n var name u p n var name u .
p var name u computedunita expr v v vars expr v ros typed vars cu unit expr c a cu .
c a cu .
p a cu v v vars expr v nelementros typed vars cu unit expr c a cu .
c a cu .
p a cu knownsymbolcos a sin a k a radian .
k a radian .
p a radian conversion a b f a radian .
f a radian .
p a radian f b degree 360 .
f b degree 360 .
p b degree 360 a b f a degree 360 .
f a degree 360 .
p a degree 360 f b radian .
f b radian .
p b radian aopnum op !
num numerical value 2 unit a radianf a degree 360 .
f a degree 360 .
p a degree 360 aop op !
f a radian .
f a radian .
p a radian the confidence0.7for all naming constraints reflectsthatvariablenamesareuncertainandcancausefalseunitinconsistenciesif not augmented with other evidence.
this confidence is the lowest amongallconfidenceprobabilitiesconfiguredin phys asnaming usuallyprovidestheweakesthintaboutavariable sunit.thevalue .7wasempiricallyidentified yieldingasufficientlyhightprate while retaining enough detection power to find significantlymore unitinconsistenciesthanothermethods.
computed unitconstraints.
computed unitconstraintsarecollected for the assignment resulting from mathematical expressions which may compose compute new units from the operands units.
to generate a computed unit constraint for a mathematical expression wefirstneedunitderivationrules.forexample foradivision expression x y the unitderivationruleis p x u unit x uunit x meter unit y second unit x y meter per second whereunit x yieldstheunitof xbasedonthecurrentunitassignment ofx and hence the units of xandyare meter and second respectively.thereforethecomputedunitfor x yis meter persecond .otherderivationrulescan be similarlydefined.
once we have computed the resulting units we generate two constraints apriorprobabilityconstraint c var cu p indicatingthatweobserve varhasacomputedunit cuwithprobability p and c var cu .
p var cu that propagates the initial confidenceto the unit assertionof variable var.
anexample ofacomputed unitconstraintisshownintable .thisconstraint is generated once the units for the expression sqrt wx1 wx1 wy1 wy1 iscomputedtobe ms resultinginacomputed unit predicate c q1 ms withconfidence p. thevalueofprobability pdependsonwhichvariablescontribute toacomputedunit cu.ifexprhasonlyrosvariables then agets unitcuwith probability .
otherwise .
.
after empirically exploring a range of values the value of .
is set higher than the naming hint confidence .
and lower than the later discussed unitconversionhint confidence .
.
known symbolconstraints.
softwaredealingwithphysicalquantities often uses mathematical functions from some math library.
for example we observed a lot of usage of two such functions sin a andcos a .
both functions accept an argument that representsanangleexpressedin radian .weformulatethisunithint intotwoknown symbolconstraints k a radian .
and an implication constraint k a radian .
p a radian .
the .
probability models the uncertainty arising from a possible use ofavariable withan incorrectunitassignment.
conversionconstraints.
manyroboticandcyber physicalprograms reason about spatial relationships with angles and developersuseboth radian or degree 360 .conversionconstraints capture commonexpressionsthatconvertbetween radian and degree 360 andprovidehints aboutunits.
so in the angle conversion expression a b variablebshould be of unit degree 360 and variable ashould be 568phys probabilistic physicalunitassignment... esec fse november4 lake buena vista fl usa ofunit radian .thegeneratedconversionconstraintswouldbe f a radian .
f b de ree 360 .
and implication constraints f a radian .
p a radian f b de ree 360 .
p b de ree 360 .
if a variable with unit radian from the previous iteration is added or compared with then we infer degree 360 asshownintable .theobservationalconfidence of0.
informsthe prior probability constraintsfor thesehints.
inaddition ifavariableisaddedorcomparedwith thenwe infer radian .thishintisformulatedasaconversionconstraint intable3 withthe high probability of0 .
.
.
probabilisticinference engine factor.here wediscusshowtheprobabilisticconstraintsaretranslatedintoprobabilisticfunctions.thefunctionsserveasnodesin afactorgraph.allthepredicatespresentinconstraintsarerepresented as boolean variables.
an implication constraint pred1p pred2 istranslatedintoafactor f pred1 pred2 as f pred1 pred2 p if pred1 pred2 istrue p otherwise and a bidirectional constraint pred1p pred2 is divided into two constraints pred1p pred2 andpred1p pred2 which are then translated.apriorprobabilityconstraint pred1 q istranslated intoafactor f pred1 as f pred1 q if pred1 istrue q otherwise wedenoteafactorwithacorrespondingprobabilisticconstraint formulation e.g.
f pred1 pred1 q .
thebooleanvariablesinfigure 3atogetherwiththeprobabilistic constraintsintable 1 7 canbetranslatedintothefactorsshown infigure 3b.
factor graph.
afactorgraphisabipartitegraphwithtwokinds of nodes variable nodes and factor nodes.
the edges join each factorwithitsvariables i.e.
thevariablesoverwhichaprobabilistic function corresponding to the factor is defined.
figure 3cshows a factor graph for the variables and factors from figures 3a 3b.
factorsf12 f13andf14are omittedfor simplicity.
belief propagation.
we use the sum product belief propagation algorithm forprobabilisticinference.itisaniterativealgorithm that passes belief messages between adjacent nodes and updates theprobabilityforeachnodebasedonthereceivedmessages.an updated probability is propagated toadjacent nodesin the nextiteration.
the algorithm terminates when the probabilities converge.
iteration .physiterates during stage as shown in figure .
this iterationiscriticaltopickupadditionalconstraints.forexample table2ontherightsideliststheiterationnumberinwhicheach probabilisticconstraintwascollected.asshowninthetable constraints and wereonlyinferredaftermostoftheotherunits in the program had been determined.
in general it is important to considerwhetheraniterationwillreachafixedpointandterminate.
unlikeatraditionaldataflowanalysis unitsdonotfitwellintoa lattice based approach and therefore we cannot use the ascending chaincondition toguaranteeafixedpoint.thereforewemanuallyboundtheiterationsto4 andobservethatmostprogramswe have analyzedreachafixedpointwithin this bound.p1 p v ref x ms p2 p v ref y ms p3 p linearspeedxmps ms p4 p wx1 ms p5 p wy1 ms p6 p q1 ms c1 c v ref x ms c2 c v ref y ms c6 c q1 ms n3 n linearspeedxmps ms a booleanvariables representingthepredicates factors f1 c10.
p1 f2 c1 .
f3 c20.
p2 f4 c2 .
f5 p10.
p3 f12 p30.
p1 f6 n30.
p3 f7 n3 .
f8 p40.
p1 f13 p10.
p4 f9 p50.
p2 f14 p20.
p5 f10 c60.
p6 f11 c6 .
b factors c factorgraph figure factors and factor graph for the probabilistic constraints ofour example intable .
.
complexity andtermination preprocessing builds a context insensitive call graph and topologically sorting this graph is o v e worst case o e2 when removing cycles.
collecting probabilistic constraints involves at mosthloops over each statement where his the height of the statement s ast.
the probabilistic inference engine implements an approximate solution to the sum product message passing algorithm that isquadratic.
collecting probabilisticconstraints and the sum product are run within a loop bounded by a constant four times .
after the loop detecting inconsistencies involves a linearscanofprogramvariablesandtheprogram sast.overall complexityisquadraticintimeandspace.thisapproachterminates because we bound the loops to collect probabilistic constraints and run sum product.
evaluation ourmaingoalistoevaluatetheeffectivenessof physinbothunitinferenceaswellasunit inconsistencydetection.forthat weaddress the following researchquestions rq1.how effective is our approach in physical unit type inference comparedto the state of the art?
rq2.can our approach detect more unit inconsistencies comparedto the state of the art?
rq3.how useful are various types of constraints defined in our approach?
we have implemented physin python.
it relies on a few thirdparty components cppcheck is used to obtain an intermediate 569esec fse november4 lake buena vista fl usa s.kate j. ore x. zhang s.elbaum z. xu form of a c program including a list of tokens an ast for each statementandsymboltablesforvariables functions andscopes libdai is used as the probabilistic inference engine.
moreover as mentioned before physutilizes a one time mapping of ros data structures to physical units provided by phriky.
our code is available for download at .
theexperimentalevaluationisconductedonsamplec files picked from a large number of ros based projects i.e.
robotic software publicly available on github.
we used files for unit inconsistencydetectioninsection .
and30filesfortypeinference in section .1because of the manual annotation effort.
the list of public software is at .
the executiontimeof physrangesfrom1to28secondsforafilewith details elided.
for the comparison of physwith the state of the art we use phriky.therobotics programsthatwe use forexperiments donot come with any physical unit information.
in order to determine whether a variable can have a unit and whether an inferred unit is correct wemanuallycollectthegroundtruthforallthereported variablesinthesampletest suitefiles.fordeterminingtruepositive tp cases ofthe reported inconsistencies we manually examine eachinconsistencybyreviewing the corresponding sourcecode.
.
physical unit typeinference in the first experiment we want to evaluate the ability of phys to infer physical unit types for variables.
note that we consider onlythosevariablesthatcanhavephysicalunits somevariablesin robotics software do not represent any physical quantity e.g.
for loopindexvariable .plus variablesof integertypeareassumed tobe dimensionless.since physreports a rankedlist ofunits fora variable we consideronly the top unitinthis experiment.
experiment setup.
we compute results for three categories of variables variablesthat phrikycouldnotassignanyunitto variables that phrikyassigned an incorrect unit to and variables thatphrikyassigned a correct unit to.
note that phrikysometimes assigns more than one unit to a variable due to the unit resolution rule of performing union on an addition expression.
in that case if aunionedsetcontainsacorrectunit thentheunitassignmentis consideredascorrectfor phriky.also variablesofrosdatatype that obtain units from the mapping are not included in the result computation.theexperimentisperformedonasampletestsuite of30 c filesrandomly pickedfrom ros basedprojects.
rq1results unit inference.
table4summarizes the results.
column total vars shows the total number of variables of nonrosdatatypesforwhich physcouldinferunits.further the table presents the count of variables in each category that phys could infer unitsfor in columns var .
columns var show thepercentageofatotalnumberofvariablesinasamplefilethat thecorresponding var accountsfor.theaccuracyoftheunit assignmentsisshownincolumns tp .thetprateiscomputed as tp tp var wheretprepresentsthecountoftruepositive unit assignments not shown in the table for brevity .
observe that we achieve an overall tp rate of greater than in each category.
also itcanbeobservedthat physisabletoinferunitsforalotof variables that phrikycannot.
in particular physinfers units for variables whereas phrikycould assignunitsto only 302variables.effectofconstraint probabilities.
asseeninsection .
phys is configured with the following parameters for constraints .
for naming .
forcomputed unitand0.
forconversion.
weperformed a couple of additional experiments to study the effect of using different parameters values naming probability physwas evaluatedwithfourvalues namely .
.
.8and0.
.itwasobservedthatithadnegligibleimpactonunit inferenceforthe30 files set combination of computed unit and conversion probabilities asmentionedbefore computed unitprobabilityispurposelychosen tobelowerthanconversionprobability.therefore weevaluated physwiththreecombinationsofvaluesfor computed unit conversion namely .
.
.
.
and .
.
i.e.
lowerthan equal to and higher than.
it was observed that the tp rate was decreased for thelast twocombinationsinone ofthe categoriesof variables i.e.
variableswithincorrectunitsby phriky .thedecreasewasdue toincorrectunitinferenceforsomeoftheanglevariables which were inferredto be radian instead of degree 360 .
.
unit inconsistency detection inthisexperiment weevaluatetheabilityof phystodetectunitinconsistencies.
note that we consider only high confidence inconsistencies.aninconsistencyisconsideredhigh confidenceonlyif alltheunitsintheinconsistentexpressionareknown nounknown unitsforvariables andnoconstantsthatmayormaynotbearan implicit unit .
both phrikyandphyscan be configured to report only high confidencecases.
experimentsetup.
wecomputethetprateofthereportedinconsistencies for both physandphriky.
due to the substantial manual efforts entailedin identifying the ground truth forvariables units we selected only a subset files of a large number of ros based c projects as our sample test suite for the previous experiment.
however itwouldbeinterestingtoseehow physperformsonother filesaswell.therefore wedividetheexperiment intotwoparts.in partone wecomputetheresultsforoursampletestsuiteof30files usedinthepreviousexperiment.wecallitthe filesset .inpart two we compute results for an expanded set of randomly selected sample files.
for the selection of the expanded set we ran physon 484ros basedprojects filesavailableongithub.physreported inconsistencies in files i.e.
.
of files with units .
we then randomly selected files for which inconsistencies were reported byphysto form the expandedset.
rq2results files setinconsistencies.
table5presents the tpandfpcountsforeachofthesamplefilesinthe30 filesset.the table does not show entries for files that are found to have zero inconsistencies by both physandphriky.
columns show the resultsfor phriky whereas columns5 show the resultsfor phys.
itcanbeobservedthat though physhaslowertprate .
than that ofphriky it has a capabilityto uncover more inconsistencies.
the highlighted rowsindicatethe cases ofinconsistencies missed by phriky but detected by phys.
in particular the result for the filesummit xl robot control.cpp demonstrates the detection of the addition unit inconsistency described in the motivation section section .
also observe that for the file action.cpp the numberoftpinconsistenciesby physislessthanthatby phriky.
however though less we found that the root cause of all those capturedinconsistencies is same and thus we do not actuallymiss the caseofan incorrectusage of unitsinthis file.
570phys probabilistic physicalunitassignment... esec fse november4 lake buena vista fl usa table physical unittype inferenceby physcompared with phriky.
filesset inferred unitsvariables with nounits by phrikyvariables with incorrect units byphrikyvariables with correct units byphriky vars vars vars tp vars vars tp vars vars tp perception.cpp .
.
.
.
.
.
labbot teleoperation twist.cpp .
.
.
.
quadscripts.cpp .
.
.
.
.
.
ard node.cpp .
.
.
.
traj builder.cpp .
.
.
.
.
.
motor and sensors controller.cpp .
.
.
.
simulation functions.cpp .
.
.
.
follow.cpp .
.
.
.
.
.
motor control hc.cpp .
.
.
.
.
.
placement wrt workspace action server.cpp .
.
interpolater.cpp .
.
.
.
.
.
collvoid local planner.cpp .
.
.
.
.
.
vel scheduler.cpp .
.
.
.
.
.
simple pose.cpp .
.
.
.
.
.
base driver.cpp .
.
.
.
.
.
channel controller.cpp .
.
.
.
.
.
odometry.cpp .
.
.
.
viconxbee.cpp .
.
.
.
base controller.cpp .
.
.
.
trajectory planner ros.cpp .
.
.
.
.
.
summit xl robot control.cpp .
.
.
.
.
.
summit xl waypoints.cpp .
.
summit xl joint state.cpp .
.
summit xl joystick.cpp .
.
action.cpp .
.
.
.
twist marker.cpp .
.
twist mux.cpp .
.
twist mux diagnostics.cpp .
.
navigating jockey.cpp .
.
.
.
.
.
turtlebot example node.cpp .
.
.
.
total .
.
.
.
.
.
table inconsistenciesforthe30 filesset.
sample test suite1 phriky inconsistenciesphys inconsistencies total tp fp total tp fp labbot teleoperation twist.cpp quadscripts.cpp ard node.cpp traj builder.cpp motor and sensors controller.cpp simulation functions.cpp follow.cpp motor control hc.cpp placement wrt...action server.cpp collvoid local planner.cpp base driver.cpp odometry.cpp viconxbee.cpp trajectory planner ros.cpp summit xl robot control.cpp action.cpp twist marker.cpp turtlebot example node.cpp total there is one file placement wrt workspace action server.cpp for which physreported two fps.
both are reported because of incorrectunitassignmentofavariable max velocity .thenaming convention component of physidentifies it as unit meter persecond .
however in the program this variable has been used as a maximum velocity value for both linear and angular velocities and thus can have either meter per second or per second unit.table inconsistenciesforthe expanded set.
phrikyinconsistencies physinconsistencies total tp fp total tp fp unit inconsistencies files rq2results inconsistenciesfortheexpandedfileset.
table 6shows the summarized results for the expanded sample set.
the overalltpratefor physis82.
.physdetects103.
moreinconsistenciescomparedto phriky includingeveryinconsistencythat phrikydetects.physfinds true positive inconsistencies in files whereas phrikywasableto find only in24 files.
also a number of fps are reported by phys.
they are generally caused by an incorrect unit inference of some variables due to theinherentuncertaintymodeledintotheprobabilisticinference approach.
majority of these fps are caused by variables that are intentionallyusedtorepresenttwodifferentquantities i.e.units in a program e.g.
variable run velis used as both linear velocity and angular velocity.
other causes for fps include a variable with a namereflectingaphysicalquantity butusedasascalar e.g.
width b controllergainvariables whichareusedonlyinthecontroller equationandmaycarryimplicittimequantity i.e.
itmayhaveany ofthe second or per second unitsornounit .
.
constraintdistribution rq3results constraintusage.
here wepresentastudyonthe types of constraints collected by physin our sample test suites.
table7presents a count of files for which a particular type of 571esec fse november4 lake buena vista fl usa s.kate j. ore x. zhang s.elbaum z. xu table usageofvarious constrainttypes.
files dataflow naming computedunitknownsymbolconversion files set expanded set constraint was collected.
it can be observed that dataflow naming and computed unit constraints play a major role in the unitinference.also theothertwotypes known symbolandconversion constraints havebeenfoundinanumberoffilesandthusareuseful instrengthening the unit inference.
threats and limitations .
threats self labeling.
onethreatisthatthiseffortusesself labeleddata to evaluate both physical unit type inference and inconsistency detection.tomitigatethisthreatwhenlabelingphysicalunittypes wehadmultipleauthorsreviewthetypeassignmentsandalsoused physto show inconsistencies when a physical unit type needed correction.tomitigatethisthreatwithinconsistencies theauthors evaluatedinconsistenciesindependently andcomparedresults.
overfitting.
by assuming english and encoding priors for suffixes like speed thatcouldmeaneitherlinearorangularvelocity differentabstracttypes thereisathreatofoverfitting.wemitigate thisthreatbyusingasmallbutgeneralsetofsuffixes 41entries asdescribedinsection .1andobservingthatweevaluated phys on random files drawn from files with inconsistencies and observed only few fps caused by incorrect suffix assumptions.
magic numbers.
we use three predefined confidence values for naming computed unitandconversionconstraints respectively.
their values are determined empirically and hence pose threats toourresults.ourexperimentsshowthattheresultsarenotthat sensitive to the values.
.
limitations false negatives.
the number of false negatives in the dataset is unknown so we cannot calculate recall.
to address this limitation we willexamine evaluatingthe approach after seeding faults.
generality.
thisapproachreliesonhavingsomeinitialabstract type information for physical units in our case the ros shared messagelibraries.however thisapproachcouldalsoleveragesome gradualtypeinformationfromdeveloperannotations.whileour evaluation focuses on ros c software for impact the technique isgeneralfor otherrobotic systems.
related work abstract type inference.
guoet al.
proposed a dynamic unification basedanalysisforabstracttypeinferenceinjavaprogramstoaidprogramcomprehension.likewise weinferabstract types based on program interactions but our work is static and we inferinconsistencies.
ayudante usesdataflowtoclustervariables intoabstractdatatypes thenleveragesawordnet similarity metric to cluster by variable name differences between the clusteringsarereportedasabstracttypeinconsistencies.like phys ayudanteusesdataflowandvariablenames but physusesprobabilistic reasoningto accountfor theuncertainty presentinusing variable names in isolation.
also we found poor results using wordnetinthephysicalunitstypedomainwithoutcontext sincephysical unitstypesarehighlydependentonacombinationoflocalclues like speed meaning either linear and angular velocity .
ayudante more aligns withatraditional unification basedtype systems.
probabilisticinferenceinsoftware.
dietzetal.usedprobabilisticinferencetolocalizebugs andwealsoseektofindbugs.however ourworkcollectsevidenceduringstaticanalysiswhiletheir workcollectsevidencefromprogramtraces.probabilisticinference isusedfortypeinference specificationextraction security and reasoning about approximate computations .
we takeaninspirationforourapproach sdesign inparticular fromthe workonprobabilistictypeinferenceforpython .thedifference lies in that we detect physical unit inconsistencies and model hints specific to the problem such as expression forms and ros data types.
furthermore units are not a predefinedset andthey canbe composedbythe code.our techniqueishence iterative.
physical units in software.
many efforts have proposed support for physical units with language extensions unitannotation libraries or dynamic techniques .
the tool osprey detectsunitinconsistencies withstatic analysisbyusingdeveloperannotationsandpropagatingunitsthroughdata flow and constraints but only works on java programs.
our work is differentfromtheirsinthatweuseinformationavailableinvariable names andapply probabilisticconstraints.
we target c code written for the robot operating system ros a popular open source middleware.
robot software and ros programs are used increasingly in both academic and industrial robots and contain many variables measured in physicalunits.webuildon phrikyunits mapping alookup table from shared library attributes to physical units but assign more unitsto variables byaddingadditionalconstraints allowing ourapproachtodetectmoreinconsistencies.further ourapproach makes more variable assignments because it applies units after collecting constraints from the whole program rather than phriky that only makesalinearscan andcannotgobackwards.
conclusion we have presented a novel probabilistic approach for abstract type inferenceofphysicalunitsandinconsistencydetectioninrobotic systems.theapproachleveragesuncertainhintsaboutvariables units such as variables names expression forms and associated operations to make probabilistic inferences of unit types.
we have implemented this approach as a tool phys.physcan infer unitsfor morevariablesthanstate of the art leadingtothedetectionof morethan103 inconsistencieswithoutadditionaldevelopereffort and with a true positive rate of .
in the future we would like to address the causes for the reported false positives and incorporate more unit hints such as those present in equations that form a robot ssensing planning andcontrolcomponents.