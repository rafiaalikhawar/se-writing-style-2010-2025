repairing crashes in android apps shin hwei tan southern university of science and technology shinhwei hotmail.comzhen dong national university of singapore zhen.dong comp.nus.edu.sg xiang gao national university of singapore gaoxiang comp.nus.edu.sgabhik roychoudhury national university of singapore abhik comp.nus.edu.sg abstract android apps are omnipresent and frequently suffer from crashes leading to poor user experience and economic loss.
past work focused on automated test generation to detect crashes in android apps.however automatedrepairofcrasheshasnotbeenstudied.
in this paper we propose the first approach to automatically repairandroidapps specificallyweproposeatechniqueforfixing crashes in android apps.
unlike most test based repair approaches wedonotneedatest suite insteadasinglefailingtestismeticulouslyanalyzedforcrashlocationsandreasonsbehindthesecrashes.
ourapproachhingesonacarefulempiricalstudywhichseeksto establish common root causes for crashes in android apps and then distills the remedy of these root causes in the form of eight generictransformationoperators.theseoperatorsareappliedusingasearch basedrepairframeworkembodiedinourrepairtool droix.
wealsoprepareabenchmark droixbench capturingreproducible crashesinandroidapps.ourevaluationof droixondroixbench reveals that the automatically produced patches are often syntacticallyidenticaltothehumanpatch andonsomerareoccasioneven better than the human patch in terms of avoiding regressions .
these results confirm our intuition that our proposed transformations form a sufficient set of operators to patch crashes in android.
ccs concepts software and its engineering automatic programming software testing and debugging dynamic analysis keywords automated repair android apps crash sbse acm reference format shin hwei tan zhen dong xiang gao and abhik roychoudhury.
.
repairing crashes in android apps.
in icse icse 40th international conference on software engineering may june gothenburg sweden.acm newyork ny usa 12pages.
thisworkwasdoneduringtheauthor sphdstudyatnationaluniversityofsingapore permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed forprofitorcommercialadvantageandthatcopiesbearthisnoticeandthefullcitation on the first page.
copyrights for components of this work owned by others than acmmustbehonored.abstractingwithcreditispermitted.tocopyotherwise orrepublish topostonserversortoredistributetolists requirespriorspecificpermissionand ora fee.
request permissions from permissions acm.org.
icse may june gothenburg sweden association for computing machinery.
acm isbn ... .
introduction smartphones have become pervasive with millions sold worldwideintheyearof2011alone .userstendtorelymoreontheir smartphonestoconducttheirdailycomputingtasksassmartphones arebundledwithvariousmobileapplications.hence itisimportant to ensure the reliability of apps running in their smartphones.
testing and analysis of mobile apps with the goal of enhancing reliability havebeenstudiedinpriorwork.someoftheseworks focusonstaticanddynamicanalysisofmobileapps while other works focus on testing of mobile apps .
to further improve the reliability of mobile applications several approachesgobeyondautomatedtestingofappsbyissuingsecurity related patches .
while fixing security related vulnerabilities isimportant asurveyrevealedthatmostoftherespondentshave experiencedaproblemwhenusingamobileapplication with62percent of them reported a crash freeze or error .
indeed frequentcrashesofanappwillleadtonegativeuserexperienceandmayeventuallycauseuserstouninstalltheapp.inthispaper we study automated approaches which alleviate the concern due to app crashes via the use of automated repair.
recently several automated program repair techniques have been introduced to reduce the time and effort in fixing softwareerrors .
these approaches take in a buggy program pand some correctness criterion in the form of a testsuitet producing a modified program p primewhich passes all tests in t.despiterecentadvancesinautomatedprogramrepairtechniques existing approaches cannot be directly applied for fixing crashes found in mobile applications due to various challenges.
thekeychallengeinadoptingautomatedrepairapproachesto mobileapplicationsisthatthequalityofthegeneratedpatchesis heavilydependentonthequalityofthegiventestsuite.indeed anyrepairtechniquetriestopatcherrorstoachievetheintendedbehavior.
yet in reality the intended behavior is incompletely specified oftenthroughasetoftestcases.thus repairmethodsattemptto patch a given buggy program so that the patched program passes alltestsinagiventest suite t wecallrepairtechniquesthatuse test cases to drivethe patch generation process test driven repair .
unsurprisingly test drivenrepairmaynotonlyproduceincomplete fixes but the patched program may also end up introducing new errors becausethepatchedprogrammayfailtestsoutside t which werepreviouslypassing .meanwhile severaluniquepropertiesof testcasesfor mobileapplicationspose uniquechallengesfor test driven repair.
first regression test cases may not be available foragivenmobileapp a.whilepriorresearchesonautomatedtest generationformobileappscouldbeusedforgeneratingcrashing acm ieee 40th international conference on software engineering authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
icse may june gothenburg sweden shin hwei tan zhen dong xiang gao and abhik roychoudhury inputs regressiontestinputsthatensurethecorrectbehaviorsof aareoftenabsent.secondly insteadofsimpleinputs testinputs formobileappsareoftengivenasasequenceofuicommands e.g.
clicksandtouches leadingto crashesintheapp.meanwhile gui tests are often flaky their outcome is non deterministic for the same program version.
as current repair approaches rely solely on the test outcomes for their correctness criteria they may not be able to correctly reproduce tests behavior and subsequently generate incorrect patches due to flaky tests.
anotherkeychallengeinapplyingrecentrepairtechniquesto mobile applications lies on their reliance on the availability of source code.
however mobile applications are often distributedas standard android .apk files since the source code for a given version of a mobile app may not be directly accessible nor actively maintained.moreover whilepreviousautomatedrepairtechniques areappliedforfixingprogramsusedbydevelopersandprogrammers mobile applications may be utilized by general non technical users who may not have any prior knowledge regarding source code and test compilations.
wepresentanovelframework called droixforautomatedrepair of crashes in android applications.
in particular our contributions can be summarized as follows android repair weproposeanovelandroidrepairframework that automatically generates a fixed apk given a buggy apk and aui test.android applicationswerenot studiedinprior workin automated program repair butvarious researches on analysis and automated testing illustrate the importance of ensuring the reliability of android apps.
repairing ui based test cases differentfromexistingrepairapproaches based on a set of simple inputs our approach fixes a crash with a single ui event sequence.
specifically we employtechniques allowing end users to reproduce the crashing event sequence by recording user actions on android devices instead of writing test codes.
the crashing input could be either recorded manually byusers or automatically generatedby gui testingapproaches .
lifecycle aware transformations ourapproachisdifferentfrom existing test driven repair approaches since it does not seek tomodify a program to pass a given test suite.
instead it seeks torepair the crashes witnessed by a single crashing input by em ploying program transformations which are likely to repair the root causes behind crashes.
we introduce a novel set of lifecycleaware transformations that could automatically patch crashing androidappsbyusingmanagementrulesfromtheactivitylifecycle and fragment lifecycle.
evaluation we propose droixbench a set of reproducible crashes in open source android apps.
our evaluation on defects shows that droix could repair bugs and seven of these repairs are syntactically equivalent to the human patches.
background lifecycle in android different from javaprograms android applications donot have a single main method.
instead android apps provide multiple entry pointssuchas oncreate andonstartmethods.viathesemethods android framework is able to control the execution of apps and maintain their lifecycle.oncreate onstart onresume onpause onstop onactivitycreated ondestroy oncreateview oncreate onattach onstop onpause onresume onstart ondetach ondestroy ondestroyview activity launched activity running activity shutdown fragment is destroyedonrestart created started resumed paused stopped destroyedfragment is activefragment is added user navigates to the activity user returns to the activityapp process killeduser navigates to the activity app with higher priority need memory the fragment returns to the layout from back stackanother activity comes into the foreground the activity is no longer visible the activity is finishing or being destroyed by the systemuser navigates backward or fragment is removed replacedfragment is added to the back stack then removed replaced activity lifecycle fragment lifecycle figure activity lifecycle fragment lifecycle and the activityfragment coordination figure1showsthelifecyclesofactivityandfragmentinandroid.
eachmethodinfigure1representsalifecycle callback amethod that getscalled given achange ofstate.
lifecycle transitionobeys certainprinciples.forinstance anactivitywiththepausedstate could move to the resumed state or the stopped state or may be killed by the android system to free up ram.
afragment isaportionof userinterfaceorabehaviorthat can beputinanactivity.eachfragmentcanbemodifiedindependentlyofthehostactivity activitycontainingthefragment byperforming a setof changes.
fora fragment itgoes through morestates than anactivityfrombeinglaunchedtotheactivestate e.g.
onattach andoncreateview states.
thecommunicationbetweenanactivityandafragmentneeds toobeycertainprinciples.afragmentisembeddedinanactivity and could communicate with its host activity after being attached.
the allowed states of a fragment are determined by the state of its host activity.
for instance a fragment is not allowed to reach theonstartstate beforeits host activity entersthe onstartstate.
a violation of these principles may cause crashes in android apps.
a motivating example weillustratetheworkflowofourautomatedrepairtechniqueby showinganexampleapp anditscrash.thecrashoccurredintransistor aradioappforandroidwith63starsingithub.according tothebugreport1 transistorcrasheswhenperformingtheevent sequence shown in figure a starting transistor b shutting it downbypressingthesystembackbutton c startingtransistor again and changing the icon of any radio station.
then it crashes with a notification transistor keeps stopping d .
listing shows thelogrelevanttothiscrash.thestacktraceinformationinlisting1 suggests that the crash is caused by illegalstateexception.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
repairing crashes in android apps icse may june gothenburg sweden a open transistor b press back c open again and change an icon d crashed with a notification figure continuous snapshots of a crash in transistor.
our automated repair framework droix performs analysis of the activity fragment coordination dashed lines in figure and reportspotentialviolationsinthecommunicationbetweenafragment and its host activity.
our manual analysis of the source code forthis appfurtherreveals that thecrashoccurs becausethefragment attempts to call an inherited method startactivityforresult atline482 whichindirectlyinvokesamethodofitshostactivity.
however the fragment is detached from the previous activity duringtheterminationoftheappandneedstobeattachedtoanew activityintherestartingapp.themethodinvocationoccursbefore thenewactivityhasbeencompletelycreatedandleadstothecrash.
fatal exception mainprocess org.y20k.transistor pid java.lang.illegalstateexception fragment m ainactivityfragment 82e1bec not attached to activity at android ... startactivityforresult fragment.java at y20k... selectfromimagepicker maina ctivityfragment.java listing stack trace for the crash in transistor if getactivity !
null startactivityforresult pickimageintent request load image listing droix s patch for the crash in transistor startactivityforresult pickimageintent request load image mactivity.st artactivityforresult pickimageintent request load image listing developer s patch for the crash in transistor droix defines specific repair operators based on our study of crashes in androidapps and the androidapi documentation see section .
one of the transformation operators identified through our study getactivity check is designed to check if the activity containing the fragment has been created.
the condition getactivity !
null prevents the scenario where a fragment communicates with its host activity before the activity is created.
listing shows the patch automatically generated by droix.
withthepatch method startactivityforresult willnotbeinvokedifthehostactivityhasnotbeencreated.therelatedfunction i.e.
changing station icon works well after our repair.
in contrast althoughthedeveloper spatchdoesnotcrashonthegiven input it introduces regressions.
listing shows the developer s patch where mactivity is a field of the fragment referencing its host activity.
when restarting the app this field still points tothepreviouslyattachedactivity.thedeveloper spatchexplicitlyinvokes startactivityforresult method of the previously attachedactivityinsteadofthenewlycreatedactivity.afterapplying thedeveloper spatch auserreportsthatthesystembackbutton nolonger functionscorrectlywhen changingthestation icon i.e.
pressing the back button does not close the app but mistakenly opensawindowforselectingimages .specifically theuserreports thefollowingeventsequencewhentheappfailstofunctionproperly open transistor tap to change icon press back twice open transistor tap to change icon press back twice .
wetest theapk generated bydroix with this eventsequence andweobservethatourfixedapkdoesnotexhibitthefaultybehaviorreportedbytheuser.hence webelievethatthe patch generated by droix works better than the developer s patch.
identifying causes of crashes in android applications to study the root causes of crashes in android apps we manual inspect android apps on github and api documentation as priorworkhasshowedsuccessinfindingbugsviaapidocumentation .
our goal is to identify a set of common causes for android crashes.
we first obtain a set of popular android apps by crawling github and searching for the word android app written in java using the github api2.
for each app repository we search forclosedissues resolvedbugreport withtheword crash .we focusonclosedissuesbecausethoseissueshavebeenconfirmedby the developers and are more likely to contain fixes for the crashes.
from the list of closed issues on app crashes we further extract issuesthatcontainatleastonecorrespondingcommitassociated withthecrash.thefinaloutputofourcrawlerisalistofcrashesrelatedclosedissuesthathavebeenfixedbythedevelopers.overall ourcrawlersearchesthrough7691githubclosedissueswhere1155 of these issues are related to crashes.
the relatively high percentage of crash related issues indicates the prevalence of crashes inandroidapps.amongthese1155issues 107oftheseissuesfrom different apps have corresponding bug fixing commits.
we manually analyzed all issues and attempted to answer two questions q1 what arethe possible root causesand exceptions that leadto crashes in android apps?
q2 how does the complexity of activity fragment lifecycle affect crashes in android apps?
westudy q2becauseasurveyofandroiddeveloperssuggests that the topmost reasons for nullpointerexception in android apps occur due to the complexity of activity fragment lifecycle .ourgoalistoidentifyasetofgenerictransformations that areoften usedby androiddevelopers in fixingandroid apps.
to gain deeper understanding of the root causes of each crash q1 andtoidentifytheaffectofactivity fragmentlifecycleonthelikelihoodofintroducingcrashes q2 wemanuallyexaminelifecycle management rules in the official android api documentations3.
our study shows that the most common exceptions are nullpointerexception .
illegalstateexception .
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
icse may june gothenburg sweden shin hwei tan zhen dong xiang gao and abhik roychoudhury table root cause of crashes in android apps category specific reason description github issues frequent exception type category total lifecycleconfiguration changes activity recreation during configuration changes .
nullpointer .02stateloss transaction loss during commit .
illegalstate getactivity activity fragment coordination .
illegalstate activity backstack inappropriate handling of activity stack .
illegalargument save instance uninitialized object instances in onsaveinstance callback .
illegalstate resourceresource related resource type mismatches .
nullpointer16.82resource limit limited resources .
outofmemory incorrect resource retrieve a wrong resource id .
sqlite callbackactivity related missing activities .
nullpointer .76view related missing views .
nullpointer intent related missing intents .
nullpointer unhandled callbacks missing callbacks .
nullpointer othersmissing null check missing check for null object reference .
nullpointer .34external service library defects in external service library .
nullpointer workaround temporary fixes for defect .
indexoutofbound api changes api version changes .
sqlite others project specific defects .
thehighpercentageof nullpointerexception confirmswiththe findings of prior study of android apps .
table shows the common root causes of crashes in android apps we investigated.
column category in table describes the high level causes of the crashes while the specific reasons columngivesthespecificcausesthatleadtothecrash.thelastcolumn category total presents the total percentage of issues that fits intoaparticularcategory.overall .
ofcrashesinourstudy occur due to the violation of management rules for android activity fragment lifecycles.
the reader can refer to section on the explanationoftheselifecycle relatedcrashes.meanwhile .
of the investigated crashes are due to improper handling of resources includingresourceseithernotavailable resource related orlimitedresourceslikememory resourcelimit .furthermore improper handling of callbacks contributes to .
of crashes.
note that this callback categorydenotesimplementation specificproblemsofdifferentcomponentsinandroidlibrary e.g.
activity viewand intent .among40.
ofnullpointerexceptionsthrowninthese crashing apps only .
is related to missing the check for null objects missing null check .
interestingly .
of the github issues include comments by android developers acknowledging the factthatthepatchissuedaremerelytemporaryfixes workaround for these crashes that may require future patches to completely resolve the crash.
overall table shows that the complexity of activity fragment lifecycle and incorrect resource handling are two general causes of crashes in android apps.
moreover missing null check in the other category also often leads to crashes in android apps.
strategies to resolve crashes our manual analysis of crashes in android apps identifies eight programtransformationoperatorswhichareusefulforrepairing thesecrashes.table2givesanoverviewofeachoperatorderived throughouranalysis.as missingnull check isoneofthecommon causes of crashes in table we include this operator s7 null check in our set of operators.
another frequently used operator that fixes crashes that occur across different categories intable is inserting exception handler s8 try catch which we alsoincludeintooursetofoperators.wenowproceedtodiscusstable supported operators in droix operator description s1 getactivity checkinsert a condition to check whether the activity containing the fragment has been created.
s2 retain object store objects and load them when configuration changes s3 replace resource id replace resource id with another resource id of same type.
s4 replace methodreplace the current method call with another method callwith similar name and compatible parameter types.
s5 replace cast replace the current type cast with another compatible type.
s6 move stmt removes a statement and add it to another location.
s7 null check insert condition to check if a given object is null.
s8 try catch insert try catch blocks for the given exception.
other program transformation operators in table and the specific reasons of crashes associated with each operator in this section.
retain stateful object configuration changes e.g.
phone rotation and language cause activity to be destroyed and recreated which allowsapps to adaptto new configuration transition from ondestroy oncreate .
according to android documentation4 developer could resolve this kind of crashes by either retainingastatefulobjectwhentheactivityisrecreatedor avoid ingtheactivityrecreation.wechoosethefirststrategybecauseitis more flexible as it allows activity recreations instead of preventing theconfigurationchangesaltogether.listing4presentsanexample that explains how we retain the optionobject by using the saved instance after the configuration changes to prevent null reference of the object s2 retain object .
public void oncreate b undlesavedinstancestate super.oncreate s avedinstancestate setretaininstance true retain this fragment new field for saving the object private static option saveoption public view oncreateview layoutinflater inflater viewgroup conta iner bundle s avedinstancestate saving and loading the object if option!
null saveoption option else option saveoption switch option.g etbuttonstyle crashing point listing example of handling crashes during configuration changes authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
repairing crashes in android apps icse may june gothenburg sweden commit transactions each fragment can be modified independently of the host activity by performing a set of changes.
each set of changes that we commit perform requested modifications atomically to the activity is called a transaction.
android documentation5specifiesrulestoprohibit committingtransactionsat certain stages of the lifecyle.
transactions that are committed indisallowed stages will cause the app to throw an exception.
forexample invoking commit after onsaveinstancestate will leadto illegalstateexception sincethetransactioncouldnotbe recorded during this stage.
we employ two strategies for resolving the incorrect commits s6 move stmt moving commit to a legal callback e.g.
onpostresume s4 replace method replacing commit with commitallowingstateloss .
communicationbetweenactivityandfragment thelifecycle ofafragmentisaffectedbythelifecycleofitshostactivity6.for example infigure1 whenanactivityiscreated oncreate the fragmentcannotproceedbeyondthe onactivitycreated stage.
invoking getactivity in the illegal stage of the lifecycle will return null sincethehostactivityhasnotbeencreatedorthefragment is detached from its host activity.
a nullpointerexception maybe throwninthe followingexecution.we employtwostrategiesforresolvingthisproblem s1 getactivity check inserting condition if getactivity null and s6 move stmt movinggetactivity to another stage when the host activity is created and the fragment is not detached from the host activity of the fragment lifecycle.
retrieve wrong resource id androidresources are the additional filesand staticcontentused inandroidsource code e.g.
bitmaps andlayout .aresourceid isoftheform r.x.ywherexrefersto the type of resource and y represents the name of the resource.
theresourceidis definedin xmlfilesand itisthe parameterof several android api e.g.
findviewbyid id andsettext id .
android developers may mistakenly use a non existing resource idwhichleadsto resources notfound exception.listing5shows a scenario where the developers change the string resource id s3 replace resource id .
intmsgstrid r.s tring.confirmation remove alert intmsgstrid r.s tring.c onfirmation remove file alert listing example of handling crashes due to wrong resource id incorrect type cast of resource toimplementuiinterfaces an android api8 findviewbyid id could be invoked to retrieve widgets view in the ui.
as each widget is identified by attributes defined in the corresponding xml files an android developer may misinterpret the correct type of a widget resulting in crashes due to classcastexception .
we repair the crash by replacing the type cast expression with correct type s5 replace cast .
listing shows an example where the imagebutton object is incorrectly type caster.
mdefinition textview findviewbyid r.id.
definition mdefinition imagebutton findviewbyid r.id.
definition listing example fix for incorrect resource type cast methodology figure3presentstheoverallworkflowofdroix srepairframework.
droixconsistsofseveralcomponents atestreplayer aloganalyzer amutantgenerator atestchecker acodechecker andaselector.
given a buggy apkpand ui event sequences uextracted from its bug report droix produces a patched apkp primethat passes uand has the minimum number of properties violations.
droixfixesacrashusingatwo phaseapproach.inthefirstphase droixgeneratesaninstrumented apkitologallexecutedcallbacks.
with the instrumented apk droix replays the ui event sequences uonadevice.theloganalyzerparsesthelogsdumpedfromthe execution extractsprogramlocations locsfromthestacktrace and identifies test level property rtorigusing the recorded callbacks.
inthesecondphase droixdecompiles apkptotheintermediaterepresentation.then ourmutantgeneratorproducesasetof candidate apps stored in the mutant pool by applying a set of operators at each location linlocs.
for each operator op our code checkerrecordscode levelproperty rccandbasedontheprogram structure of land the information in thrown exception.
for each candidate apkc droixreinstalls apkcontothedeviceandreplays uonapk c. then our log analyzer parses the dumped logs that includetheexecutioninformationofcallbackmethodstoextract new buggy locations and information of test level property rtcand.
givenasinput rtcandforapkc thetestcheckercompares rtorig withrtcandtocheckif apkcintroducesanynewpropertyviolations.finally ourevaluatoranalyzes rtcandandrccandtocompute the number of property violations and passes the results to the selector which chooses the best app as the final fixed apk.
.
test with ui sequences existing techniques in automated program repair typically rely on unit tests or test scripts to guide repair process.
as additionaluitestsforcheckingcorrectnessareoftenunavailable droix uses user event sequences e.g.
clicks and touches as input torepairbuggyapps whichintroducesnewchallenges these eventsequencesareoftennotincludedaspartofthesourcecode repository and reproducing these event sequences is often timeconsuming ensuringthatarecordedsequencehasbeenreliably replayed multiple times is difficult as ui tests tend to be flaky the test execution results may vary for the same configuration .
toreducemanualeffortinobtaininguisequences droixsupportsseveralkindsofeventsequences including asetofactions e.g.
clicks andtouches leadingtothecrashwhichcanberecorded using monkeyrunner9gui asetofandroiddebugbridge adb commands10 and scripts with a mixture of recorded actions and adb commands.
non technical users could record their actions with monkeyrunner whileandroiddeveloperscouldwriteadbcommands to have better control of the devices e.g.
rotate screen .
droixemploysseveralstrategiestoensurethattheuitestoutcome is consistent across different executions .
specifically for each ui test droix automatically launches the app from the home screen inserts pauses in between each event sequence terminates 9monkeyrunner contains api that allows controlling android devices 10adb is a command line tool that are used to control android devices authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
icse may june gothenburg sweden shin hwei tan zhen dong xiang gao and abhik roychoudhury operatorslog analyzerbuggy apk logs ui sequencemutant generatordecompiler evaluator selectorcode checkertest checkermutant bug report mutants pool te dh k apksfixed apkdroix bug locations violationsviolations figure droix s android repair framework table code level and test level properties enforced in droix level type description code levelwell formedness verify that a mutated apk is compilable and the structural type of the program matches the requires context of the selected operator.
bug hazard checks whether a transformation violates java exception handling best practices.
exception type checks whether a transformation matches a given exception type.
e.g.
insert null check should be used for fixing nullpointerexception exclusively test levellifecycle checks that the event transition matches with the activity and fragment lifecycle model figure .
activity fragment checks that the interaction between a fragment and its parent activity matches the activity fragment coordination model dashed lines in figure commit checks that a commit of a fragment s transactions is performed in the allowed states i.e.
after an activity s state is saved .
the apps after test execution and brings the android device back to home screen ensure that the last state of the device is the same as the initial state of the device .
moreover droix executes each ui testforatleastthreetimesinwhicheachtestexecutionhaspauses of different duration seconds inserted in between events.
.
fault localization our fault localization step pinpoints faulty program locations leadingtothecrash.sinceourapproachdoesnotrequiresourcecode nor heavy testsuite we leverage stack trace information forfault localization.
the stack trace contains the type of exceptions being thrown the specific lines of code where the exception is thrown and thelistofclassesandmethodcallsintheruntime stackwhentheexceptionoccurs.weusestacktraceinformation for fault localization because this information is often included inthebugreportofcrashes whichallowsustocomparetheactual exception thrown with the expected exception and prior study has shown the effectiveness of using stack trace to locate java runtime exceptions .
the stack trace information is given to our search algorithm for fix localization.
when searching for complex fixes once a fix using initial stack trace is generated it may enable other crashes leading to new stack traces and new fixes.
.
code checker and test checker instead of relying solely on the ui test outcome droix enforcestwo kinds of properties code level properties properties that are checked prior to test execution and test level properties properties thatareverified during aftertestexecution .theseproperties are important because they serve as additional test oracles for validatingcandidate apps and theycould compensatefor thelack of passing ui tests.
table3showsdifferentpropertiesenforcedindroix.
bughazard isacircumstancethatincreaseslikelihoodofabugbeingpresent inaprogram .arecentstudyofandroidappsrevealsseveralexception handling bug hazards and java exception handling best practices .
given an exception ethat leads to a crash our code checker categorizes eas either a checked exception an unchecked exception oranerrortodetermineifwecouldinsertahandler trycatchblock for e.accordingthejavaexceptionhandlingbestpractice errorrepresentsanunrecoverableconditionwhichshouldnot behandled hence ourcodecheckerconsidersinsertinghandler forruntimeerrorsahardconstraintandeliminatessuchpatches.in contrast inserting handlers for unchecked and checked exceptions are encoded as soft constraints that could affectthe score of a mutant.
meanwhile we encode the well formedness property and the exceptiontypepropertyashardconstraintsthatshouldbesatisfied.
given a previous lifecycle callback prevand a current lifecycle callback curr our test checker verifies if prev currobeys the activity fragment lifecycle management rules figure .
droix considers all test level properties as soft constraints because these propertiesmaynotbedirectlyrelatedtothecrash e.g.
resourcerelated crashes .
algorithm patch generation algorithm input buggy apk p operators op population size popsize ui test u program locations locs input fitness fit patch rc rt z result apk that passes uand contains least property violations pop initialpopulation apk p popsize while c pop.cp a s s e su do mutants mutate pop op locs apply op atl locs select mutant with least rcandrtviolations pop select mutants popsize fit end .
mutant generation and evaluation droixsupportseightoperatorsderivedfromourstudyofcrashesin androidapps section4 .table2showsthedetailsofeachoperator.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
repairing crashes in android apps icse may june gothenburg sweden algorithm presents our patch generation algorithm.
droix leverages evolutionary algorithm with and .
givenasinputpopulationsize popsize fitnessfunction fit anda list of faulty locations locs our approachiteratively generates new mutants by applying one of the operators listed in table at each locationin locs evaluateseachmutantbyexecutingtheinputui eventsequences u andcomputesthenumberofcode levelproperty rcand test level property rtviolations.
the generate and validate process terminates when either there exists at least one mutant in thepopulationthatpasses uorthetimelimitisexceeded.ourpatch generation algorithm differs from existing approaches that use evolutionaryalgorithm inwhichweuseadifferentpatch representation and fitness function.
specifically each mutant is an apk in our representation.
instead of using the number of passing testsasthefitnessfunction ourfitnessfunction fitcomputesthe number of code level and test level property violations.
implementation ourandroidrepairframeworkleveragesvariousopensourcetools tosupportdifferentcomponents.specifically ourloganalyzeruses logcat11 a command line tool that generates logs when events occuronanandroiddevice.weimplementtheeightoperatorsin table on top of the soot framework v2.
.
.
soot is a java optimization framework that supports analysis and transformation of java bytecode.
dexpler a module included in soot leveragesan dalvik bytecode disassembler to produce jimple a soot rep resentation which enables reading and writing dalvik bytecodedirectly .
we use the dexpler module in soot for our decompiler component infigure .tosupport the s4 replacemethod operator weuse the levenshtein distance toselect a method with similar method name and compatible parameter types.
our implementation for the s3 replace resource id operator uses android resourceparserinflowdroid toobtainaresourceidofthesame type.
as each compiled apk needs to be signed before installation we use jarsigner12for signing the compiled apk.
we re install the signed apk onto the device using adb commands13.
instead of uninstallingandre installing eachsignedapp appre installation allows us to keep the app data e.g.
account information and settings to save timein re entering the required information during subsequent execution of u. subjects whiletherearevariousbenchmarksusedinevaluatingtheeffectiveness of automated testing of android applications and theeffectivenessofrepairapproachesforcprograms arecentstudy showedthatthecrashesinthesebenchmarks cannot be adequately reproduced by existing android testing tools.
meanwhile android specific benchmark like droidbench does not contain real android apps and it is designed for evaluatingtaint analysistools.althoughempiricalstudiesonandroid apps investigated the bug reports of real android apps all existing benchmarks cannot be used for evaluating the effectiveness of analyzing crashes in android apps.
we introduce a new benchmark called droixbench that contains reproducible crashes in real world android apps.
apart from evaluating droix this benchmark could be used to assessthe effectiveness of detecting and analyzing crashes in android apps.
to facilitate future research on analysis of crashes we made droixbench publicly available at droixbenchisanewsetofandroidappsforevaluatingdroix.
appsusedforderivingtransformationoperatorsinsection4are excluded from droixbench to avoid the overfitting problem in the evaluation.
specifically we modified our crawler to find the most recentissues bugreports onandroidappscrashesongithub.our goal is to identify a set of reproducible crashes in android apps.
to reduce the time in manual inspection of these bug reports our crawler excludes issues without any bug fixing commits which isessentialforcomparingpatchquality unresolvedissues to avoid invalid failures and non android related issues e.g.
ios crashes .thisstepyieldsmorethan300githubissues.wefurther exclude defects that do not fulfill the criteria below device specificdefects.
weeliminatedefectsthatrequirespecific versions brands of android devices.
resource dependent defects.
we eliminatedefectsthatrequire specific resources e.g.
making phone calls as we may not be able to replicate these issues easily on an android emulator.irreproducible crashes.
we eliminate crashes that are deemed irreproducible by the developers.
evaluation weperformevaluationontheeffectivenessofdroixinrepairing crashesonrealandroidappsandwecomparethequalityofdroix s patch with the quality of the human patch.
our evaluation aims to address the following research questions rq1how many crashes in android apps can droix fix?
rq2how is the quality of the patches generated by droix compared with the patches generated by developers?
.
experimental setup we evaluate droix on defects from real android apps in droixbench.
table lists information about the evaluated apps.
the type column contains information about the specific type of exception that causes the crash whereas the testex column representsthetimetakeninsecondstoexecutetheuitest.overall droixbenchcontainsawidevarietyofappsofvarioussizes 115k lines of code and different types of exceptions that lead to crashes.
asdroixreliesonrandomizedalgorithm weusethesameparameters runs for each defect with popsize and a maximum of generations as in genprog for our experiments.
in each run wereportthefirstfoundamongthelowestscore minimum property violations patches.
each run of droix is terminated after onehourorwhenapatchwithminimalviolationsisgenerated.all experiments were performed on a machine with a quad core intel corei7 5600u2.60ghzprocessorand12gbofmemory.allapps are executed on a google nexus 5x emulator android api25 .
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
icse may june gothenburg sweden shin hwei tan zhen dong xiang gao and abhik roychoudhury table subject apps and their basic statistics app name description version loc type testex s transistor radio players1.
.
4k nullpointer .
.
.
4k illegalstate .
pix art photo editor1.
.
54k nullpointer .
.
.
60k nullpointer .
poetassistantpoet writing helper1.
.
12k nullpointer .
.
.
6k sqlite .
anymemo flashcard learning10.
.
29k nullpointer .
.
.
33k nullpointer .
ankidroid flashcard learning2.
.
73k illegalstate .
.7b1 73k classcast .
fdroidopensoure apprepository0.
.
50k illegalstate .
.
38k sqlite .
yalp app repository .
11k nullpointer .
labcoat gitlab client .
.
45k nullpointer .
gnucashfinance expensetracker2.
.
42k illegalargument .
.
.
40k nullpointer .
.
.
37k illegalargument .
noisecapture noise evaluator0.
.2b 10k nullpointer .
.
.2b 10k classcast .
connectbot secure shell client .
.
26k outofbounds .
k9 email client .
115k nullpointer .
openmf mifosx client .
.
75k illegalstate .
transdroid torrents client .
.0b1 37k nullpointer .
beem communication tool .
.7rc1 21k nullpointer .
for each defect we manually inspect the source code of human patched program and the source code decompiled from droix s patched program.
if the source code of automatically patched programdiffersfromthehumanpatchedprogram wefurtherinvestigatetheuibehaviorofpatchedprogramsbyinstallingboththe human generated apk and the automatically generated apk onto the android device.
for each apk we manually perform visual comparison of the screens triggered by a set of available ui actions clicks swipes after the crashing point.
definition1.
giventhesourcecodeofhumanpatchedprogram srchuman the codeof anautomaticallygenerated patch srcmachine the compiled apk of human patched program apkhuman the compiledapkofautomaticallygeneratedpatch apkmachine wemeasure patch quality using the criteria defined below c1 syntactically equivalent.
srcmachineis syntacticallyequivalent ifsrcmachineandsrchumanare syntactically the same.
c2 semantically equivalent.
srcmachineis semanticallyequivalent ifsrcmachineandsrchumanare not syntactically the same but produce the same semantic behavior.
c3 ui behavior equivalent.
apkmachineis ui behaviorequivalent toapkhuman iftheui state atthe crashingpoint afterapplying the automated fix is same as the ui state at the crashing pointafterapplyingthehumanpatch.twoui stateareconsidered tobesameiftheiruilayoutsaresame thesetofeventsenabledare same andtheseeventsagain recursively leadtoui equivalent states.
ui behavior equivalence of apkhumanagainstapkmachine is checked manually in our experiments.
c4 incorrect.
welabela apkmachineas incorrect if apkmachine leads to undesirable behavior e.g.
causes another crash but this behavior is not observed in apk human.
c5 better.
we label a apkmachineas better when apkhuman leads to regression witnessed by another ui test urwhereas apkmachinepassesur.
formally c1 c2 c2 c3 hence a generated patch thatissyntacticallyequivalenttothehumanpatchissuperiorto both semantically equivalent patch and ui behavior equivalentpatch.
we note that in general checking whether a patch is se mantically equivalent to the human patch c2 is an undecidable problem.ho wever in ourmanualanalysis thecorrectbehaviorfor all evaluated patches are well defined.
while c1andc2investigate thebehaviorofpatchesatthesource codelevel weintroduce c3 tocomparethebehaviorofpatchesatthegui level.weconsider c3because our approach uses gui tests for guiding the repair process.furthermore sinceourapproachdoesnotrequiresourcecode direct manual checking of source code may be sometimes tedious.
.
evaluation results table5showsthepatchqualityresultsfordroix.the time columnintable5indicatesthetimetakeninsecondsacross10runs for generating the patch before the one hour time limit is reached.
onaverage droixtakes30minutestogenerateapatch.meanwhile the repair columndenotesthenumberof plausiblepatches apks that pass the ui test generated by droix.
overall droix generates plausible patches rows marked with out of evaluated defects.ouranalysisofthe9defectsthatarenotrepairedbydroix reveals that all of these defects are difficult to fix because all the corresponding human patches require at least lines of edits.
the fix type column in table shows the operator used in eachpatch refertotable2forthedescriptionofeachoperator .
the null check operator is the most frequently used operators used in six patches and of these patches are syntactically equivalenttothehumanpatches .theseresultsmatchwiththehighfrequencyof null check operatorinourempiricalstudy .interestingly wealsoobservethatthe getactivity check operator tendstoproducehighqualitypatchesbecausethisoperatoraims to enforce the activity fragment property that checks for the coordination between the host activity and its embedded fragment.
the syntactic equiv.
column in table shows the patches that fulfill c1 while the semantic equiv.
column denotes patches thatfulfill c2.similarly the ui behaviorequiv columndemonstrates the number of fixed apks that fulfill the c3 criteria.
particularly we consider the patch generated by droix for anymemo v10.
.922as semanticallyequivalent becausebothpatchesusean objectofthesametyperetainedbeforeconfigurationchangesto fixa nullpointerexception buttheobjectisretainedindifferent programlocations i.e.
notsyntacticallyequivalent .meanwhile droix generates three apks that are ui behavior equivalent tothe human generated apks.
interestingly we observed that al though the human patches for these defects require multi lines fixes thebugreportsfortheseui behaviorequivalentpatchesindicate that specific conditions are required to trigger the crashes e.g.
mspinner.getselecteditemid !
invalid row id forthe gnucashv2.
.
defect .asthese conditionsaredifficult totrigger authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
repairing crashes in android apps icse may june gothenburg sweden table patch quality results app version time s fix type repair syntactic equiv.
semantic equiv.
ui behavior equiv.
others transistor1.
.
.
.
getactivity check better pixart1.
.
.
.
null check triangle poetassistant1.
.
null check triangle .
.
anymemo10.
.
.
.
retain object ankidroid2.
.
.7b1 try catch text missing fdroid0.
.
replace method .
yalp .
labcoat .
.
null check gnucash2.
.
.
.
try catch triangle .
.
connectbot .
.
try catch text missing noisecapture0.
.2b null check .
.2b replace cast k9 .
try catch crash openmf .
.
getactivity check beem .
.7rc1 null check transdroid .
.0b1 null check fromtheuilevel synthesizingpreciseconditionsisnotrequired for ensuring ui behavior equivalent.
the others columnintable5includesonepatchthatisbetter than the human patch marked as and three patches that areincorrect markedas .weconsiderthepatchfortransistor v1.
.
to be better than human patch as it passes regression test stated in the bug report whereas the human patch introduces a newregression seesection3fordetailedexplanations .fortwo of the incorrect patches we notice that some texts that appear on the screen of human apks are missing in the screen of fixed apks text missing .
meanwhile the crash in k9 v5.
occurs due to an invalid email address for a particular contact.
in this case the human apk treats the contact as a non existing contact while the patched apk displays the contact as unknown recipient andcrashes when the unknown recipient is selected.
we think that boththehumanapkandthepatchedapkcouldbeimproved e.g.
prompttheusertoenteravalidemailaddressinsteadofignoring thecontact .althoughthepatchgeneratedbydroixfork9violates the bug hazard property catching a runtime exception we select this patch as no other patches are found within the time limit.
droixfixes15outof24evaluatedcrashes sevenofthese fixesarethesameasthehumanpatches onerepairissemantically equivalent three are ui behavior equivalent.
in one rare case we generate better repair.
threats to validity weidentifythefollowingthreatstothevalidityofourexperiments operators used.
whilewederiveouroperatorsfromfrequentlyusedoperatorsinfixingopensourceappsandfromandroidapi documentation our set of operators is not exhaustive.
reproducing crashes.
we manually reproduce each crash in our proposedbenchmark.aswerelyonandroidemulatorforreproducingcrashes thecrashesinourbenchmarkarelimitedtocrashes thatcouldbereliablyreproducedonandroidemulators.crashes that require specific setup e.g.
making phone calls may be more challenging or impractical to replay.crashes investigated.
as we only investigate open source android apps in our empirical study and in our proposed benchmark our results may not generalize to closed source apps.
we focus on open source apps because our patch analysis requires the availabilityofsourcecodes.nevertheless asdroixtakesasinputandroid apk itcouldbeusedforfixingclosedsourceapps.weleavethe empirical evaluation of closed source apps as our future work.patch quality.
during our manual patch analysis at least two of the authors analyze the quality of human patches versus the quality of automatically generated patches separately and meet to resolve any disagreement.
as most bug reports include detailed explanationsofhumanpatchesandtheexpectedbehaviorofthe crashing ui test the patch analysis is relatively straightforward.
related work testing and analysis of android apps.
manyautomatedtechniques androidripper acteve a3e collider dynodroid fsmdroid fuzzdroid orbit sapienz swifthand andworkbymirzaeietal.
areproposedtogeneratetestinputsforandroidapps.ourapproachisorthogonalto theseapproachesandthetestsgeneratedbytheseapproachescould authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
icse may june gothenburg sweden shin hwei tan zhen dong xiang gao and abhik roychoudhury serveasinputstoourandroidrepairsystem.severalapproachesfocusonreproducingcrashesinjavaprojects .meanwhile crashscope automaticallydetectsandreproducescrashesin androidapps.
ourbenchmarkwith24 reproducible crashescould beused forevaluatingthe effectivenessofthese approaches.similar to flowdroid we implement ourfix operators on top of the soot framework and we use activity lifecycle information for our analysisofandroidapps.insteadofconsideringonlytheactivity lifecycle as in flowdroid we also encode fragment lifecycle and activity fragmentcoordinationastest levelproperties.reran could precisely record and replay ui events on android devices including gestures e.g.
multitouch .
while our approach allowsui sequences in forms of scripts recorded in the user interface the record and replay mechanism in reran could allow droixto handle more complex ui events.
although our code checker incorporates some java exception handling best practices listed in recentstudyofandroidapps ourempiricalstudyofcrashes that occur in android apps goes beyond prior study by performing a thorough investigation of the common root causes of android crashes.
automated program repair.
several techniques angelix astor clearview directfix genprog par prophet nopol relifix have been introduced to automaticallygeneratepatches.thereareseveralkeydifferences of our android repair framework compared to other existing repair approaches.
firstly instead of relying on the quality of the test suite for guiding the repair process our approach augmentsa given ui test with code level and test level properties for rank ing generated patches.
secondly existing approaches could nothandle flaky ui tests as they may misinterpret the test outcomeof ui tests and may mistakenly produce invalid patches.
finally our repair framework modifies compiled apk and each test executionisperformedremotelyonandroidemulators whereasother approaches modify source code directly where each test is being executedonthesameplatformasothercomponentsoftherepair system.otherstudiesforautomatedrepairusebenchmarkforcprograms whereas droixbench contains a set of reproducible crashes for android apps.
qacrashfix and work by azim et al.
use android apps as dataset for experiments without any android specific study of cause for crashes.
their repair operators are android agnostic.
specifically qacrashfix merely add delete replace single node in the abstract syntax tree wheareas work by azim et al only inserts fault avoiding code that is similar to workaround identified in our study in section .
toeliminate invalid patches anti patterns are proposed as a set of forbidden rules that can be enforced on top of search based repair approaches .
although our code level and test level properties could be considered as different forms of anti patterns that are examinedpriortoandaftertestexecutions weusethesepropertiesforselectingmutantsthatviolatefewerpropertiesinsteadof eliminating these mutants.
similar to droix that uses stack traceinformation for fault localization the work of sinha et al.
uses stack trace information for locating java exceptions .
however their approach only supports analysis of nullpointerexception whereas our approach could automatically repair different types of exceptions.other repairs of android apps energypatch fixes energy bugs inandroidappsusingarepairexpressionthatcapturestheresource expression and releases system calls .
the battery aware transformations proposed in aims to reduce power consumption of mobile devices.
several approaches generate security patches for android apps .
while energy bugs and security related vulnerabilities may cause crashes in android apps we present a generic framework for automated repair of android crashes focusing on crashes that occur due to the misunderstanding of android activity and fragment lifecycles.uirepair.
flowfixerisanapproachthatrepairsbrokenworkflow in gui applications that evolve due to gui refactoring.
sitar uses annotatedevent flowgraphforfixingunusableguitestscripts .
although droix takes as input ui test it automatically fixes buggy androidappsratherthantheinputsthatcrashtheguiapplications.
conclusions and future work we study the common causes of crashes in android apps.
our investigationrevealsthatappcrashesoccurduetomissingcallback handler .
improperhandling ofresources andviolationsofmanagementrulesfortheandroidactivityandfragment lifecycles .basedonouranalysisofpatchesissuedbyandroiddeveloperstofixthesecrashesandtheandroidapidocumentations that specify the correct usage of android api we derive a set of lifecycle awaretransformations.toreducetimeandeffortinfixing crashes in android apps we also introduce droix a novel android repairframeworkthatautomaticallygeneratesafixedapkwhen given as input a buggy apk and ui event sequences.
to encourage future research of android crashes we propose droixbench a benchmarkthatcontains24reproduciblecrashesoccurringin15 open source android apps.
our evaluation on droixbench demonstrates that droix could generate repair for of the evaluated crashes and seven of the automatically generated patches are syn tactically equivalent to the human patches.
althoughourrepairframeworkcurrentlyperformsanalysisand mutation of android apps on desktop machine while executing ui tests on an android emulator in the future it is feasible to havea standalone repair system that could be installed as an app thatautomatically fixes crashes occurring in other apps on android devices.sinceourguiinterfacedoesnotassumeanyprogramming knowledge our repair framework could potentially benefit general non technicaluserswhowouldliketohavetheirownversionsof fixed apps instead of waiting for the official releases.
moreover as weobservethatmanycrashesoccurduetothemisunderstanding of activity fragment lifecycle that are specified in the android api documentations wethinkthatdroixcouldbeusedasapluginthat automatically provides management rule violations together with patchsuggestionstoassistdevelopersinunderstandingandroid api specifications.
acknowledgement this research is supported by the national research foundation prime minister s office singapore under its corporate laboratory at universityscheme national universityof singapore andsingapore telecommunications ltd. the first author thanks southern university of science and technology for the travel support.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
repairing crashes in android apps icse may june gothenburg sweden