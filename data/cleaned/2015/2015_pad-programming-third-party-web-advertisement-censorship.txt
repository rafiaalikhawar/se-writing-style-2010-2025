pad programming third party web advertisement censorship weihang wang yonghwi kwon yunhui zhengy yousra aafer i luk kim wen chuan lee yingqi liu weijie meng xiangyu zhang and patrick eugster z department of computer science purdue university west lafayette indiana usa fwang1315 kwon58 yaafer kim1634 lee1938 liu1751 mengw xyzhang pg cs.purdue.edu yibm t.j. watson research center yorktown height new york usa zhengyu us.ibm.com ztechnische universit at darmstadt darmstadt germany peugster dsp.tu darmstadt.de abstract in the current online advertisement delivery an ad slot on a publisher s website may go through multiple layers of bidding and reselling until the final ad content is delivered.
the publishers have little control on the ads being displayed on their web pages.
as a result website visitors may suffer from unwanted ads such as malvertising intrusive ads and information disclosure ads.
unfortunately the visitors often blame the publisher for their unpleasant experience and switch to competitor websites.
in this paper we propose a novel programming support system for ad delivery called pad for publisher programmers who specify their policies on regulating third party ads shown on their websites.
pad features an expressive specification language and a novel persistent policy enforcement runtime that can selfinstall and self protect throughout the entire ad delegation chain.
it also provides an ad specific memory protection scheme that prevents malvertising by corrupting malicious payloads.
our experiments show that pad has negligible runtime overhead.
it effectively suppresses a set of malvertising cases and unwanted ad behaviors reported in the real world without affecting normal functionalities and regular ads.
i. i ntroduction web advertisements ads are probably the most ubiquitous mashups nowadays and are still growing substantially.
the annual revenue of us online advertising increased from billion to billion demonstrating a stunning compound annual growth .
they are the main source of income for many internet companies e.g.
google and facebook and nourish various online services e.g.
news and social networks .
web ads have been widely deployed on most high traffic websites.
in more than million popular websites participate in advertising campaigns .
under the hood a gigantic digital advertising system connects various parties and fulfills the complicated transactions among them.
websites join the ecosystem as publishers.
they offer pre allocated slots to ad networks and deliver bootstrapping javascript libraries hosted by the network to visitors.
these ad loading snippets are executed in visitor s browser.
they collect and send the visitor website profiles to the ad exchange.
this information is further shared with participating advertisers networks before the ad exchange conducts a payper impression auction.
advertisers evaluate its value based on the profiles and bid for a particular impression.
finally network network network advertiser advertiser advertiser publisher publisher publisher ad exchange sellbuy attackerfig.
.
ad network system.
additional javascript snippets are returned to the visitor and eventually load the actual ad content e.g.
adobe flashes videos images or texts from the auction winner.
however the impedance mismatch between mashup software devops and software engineering has already resulted in several challenging issues.
the nature of dynamically including source code from all over the world makes the traditional software engineering e.g.
modularity and security guidelines less applicable.
in the context of web ads although the ad exchange and impression bidding approach greatly improves the efficiency of the advertising business it brings risks to publishers because websites don t know the auction winners.
they have to blindly trust and deliver any contents from the ad networks to their visitors without any control.
undesired ads.
even though reputable ad networks filter malformed ads visitors still receive undesired ads that cause negative user experience or even endanger visitors systems.
such obnoxious practices easily alienate visitors and irreparably damage websites reputations .
besides a recent study shows that while undesired ads can bring in usd they cost publishers usd per thousand impressions meaning that websites are actually losing money by running such bad ads.
to make things even worse attackers are gaming the system and using this channel to spread malware.
as shown in fig.
attackers join the network and act as normal advertisers.
however instead of sending ads they trick the network and attempt to deliver malicious code to the website visitors.
exploiting the open nature of ad network attackers can even bid for high value targets based on their .
c ieeease urbana champaign il usa technical research240 authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
operating systems browser versions country locations and other identifying features.
by paying a small amount of money attackers can easily select the right type of targets from a huge number of internet users all over the world.
malvertising campaigns are becoming a prominent threat.
according to cyphort labs by malvertising increased to over incidents and generated over billion malicious ad impressions which is more than four per each person using the internet .
during a increase in malvertising attacks has been observed .
in addition it s believed that leveraging zero day exploits has made malvertising more effective.
in march visitors of the ny times the bbc newsweek the hill msn.com aol.com the weather network the hnl and realtor.com have seen ads trying to install malicious ransomware and trojans.
these popular websites have billions of visitors every month .
the websites themselves weren t compromised.
the problem was that the ad networks these sites use google appnexus aol rubicon were tricked into serving the malicious ads which would lead users to sites hosting an exploit kit .
the exploit kit then attempts to leverage browser vulnerabilities penetrate the sandbox and get into the target s computer.
in response to the chaos ad block software are widely used by website visitors.
according to a survey by pagefair an anti adblocking authority over million devices run ad blocking software globally in .
although adblockers can mitigate some of the problems caused by third party ads in the long run simply blocking ads will devastate the economic structure underlying the internet.
without the monetary revenue gained from ads various web services would go out of business which is to no one s benefit.
as such ad blocking is not a desirable solution to the problem.
our approach.
in this paper we propose pad a novel technique that allows publishers to program their policies to regulate ads rendered on their websites.
such regulations aim to protect website visitors from undesired ad related behaviors such as malvertising or intrusive ads and protect publishers from detrimental client side behaviors such as ad blocking.
the protection is enforced during the entire life cycle of the ad delivery disregarding layers of reselling and delegation.
pad allows publisher programmers to compose their regulation logic using an expressive language.
it further compiles policies to javascript js code that executes on a novel persistent runtime which can self install in each delegation layer and execute preemptively before any third party script.
the runtime also features a novel memory randomization mechanism that protects memory accesses to block malware at the entry points.
pad can be configured to disable certain regular js functionalities e.g.
pop ups based on the runtime context e.g.
the advertiser s domain .
pad integrates the recent advances in web page randomization to allow the publishers to randomize specified ad content instead of the entire web page as in to circumvent ad blocking.
in summary we make the following contributions.
we propose the novel idea of allowing publishers to program their regulation of ads displayed on their websites.
we develop a simple yet expressive language to program regulation policies.
policies are transparently compiled to js code that enforces the regulation.
we develop a novel subversion resilient runtime that ensures persistent regulations throughout the life cycle of ad delivery and features a novel memory protection technique to prevent malvertising.
our evaluation on alexa top global sites shows that pad has reasonable overhead and does not affect normal contents.
it successfully prevents a large set of real incidents of malvertising and undesired ads we have reproduced.
ii.
m otivation in this section we illustrate undesired ads by examples and motivate our approach.
a. malvertising like normal advertisers attackers can also participate in the impression bidding.
however instead of delivering ads they distribute malware.
when a website visitor satisfies the conditions geographic location browser versions etc.
she will receive the malicious code via the ad network.
to fly under the radar such code usually runs various checks on the execution context e.g.
existences of debuggers and vulnerable components before attempting to infect the victim.
recently a sophisticated campaign named adgholas was reported .
according to a cybersecurity company proofpoint the attackers used 22ad networks to distribute malicious code.
it affected legitimate sites including the new york times le figaro the verge pcmag ibtimes arstechnica daily mail telegraaf la gazetta dello sport cbs sports top gear urban dictionary playboy answers.com sky.com etc.
it was highly effective and infected thousands of victims per day.
depending on locations different malwares were delivered and installed on victim s computer.
gozi targeting at internet solutions for business was dropped in canada terdot.a aka deloader in australia godzilla loaded terdot.a in uk and gootkit in spain.
these malware have caused massive damages.
for example the banking trojan gozi steals banking information to automate the procedure of robbing online banking customers.
according to the indictment by the us department of justice gozi alone infected more than million computers and caused tens of millions of dollars in losses.
when an infected visitor logs into the online banking system the trojan injects form fields e.g.
fig.
that request additional information.
these sensitive financial data will be sent to the attackers.
gozi also allows attackers to spoof the victim s bank balance.
after transferring all available money gozi forces the victim s browser to display the original balance before the robbery .
now let s inspect how the adgholas campaign can effectively infect so many victims without being caught for such a long time.
fig.
shows the key steps which involve multiple parties redirections and anti monitoring checks.
the standard ad network bidding details are omitted.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
fig.
.
gozi injects forms to steal sensitive financial information .
victim ad network tinyurl.com www.
ad contentad content ads ads victim profile malicious banner steganography browserdefence.com target?clean banner no yes adssilent https redirectstegano exploit kit landing page landing page with flash file containing encrypted exploits targeted flash player ?no yes adsflash player version matched password for corresponding exploitmalware server adsflash player exploited request for malware malware adsmalware executed fig.
.
adgholas campaign dec. after receiving the sniffering scripts from the ad network visitors are profiled and filtered by a third party website browser defence.com.
if they are from the targeted regions they will get a banner with malicious code.
the next step is critical for evasion.
adgholas checks the client side environment and makes sure it s not being monitored.
this is done by executing a js snippet using the internet explorer vulnerability cve .
however adgholas follows a special and innovative design.
instead of retrieving the code explicitly it hides this malicious script using steganography techniques.
in particular this js snippet is encoded in the alpha channel of the banner image which defines the transparency of each pixel.
then the js snippet is decoded from the image and reconstructed on the fly.
if monitoring utilities such as anti virus software are not detected the visitor will be silently redirected to the landing page of the real exploit kit.
the kit is designed to target specific versions of the flash players.
if present the exploited flash player will download binary executables of backdoors spyware or trojans and execute them without user consents.b.
annoying ads besides malvertising some ads are not deliberately harmful.
however they may blink float around pop open a new window or automatically play sounds which are irritating.
hubspot research conducted a survey on annoying ads .
they interviewed internet users in the us uk germany and france in and found that pop ups and video ads are the most undesired ads.
agree that some ads should be disallowed.
say obnoxious ads damage publisher s reputation and should be filtered out.
there are already efforts on detecting undesired ads based on the observed behaviors.
ad blockers powered by predefined blacklists are widely used.
but they are not sufficient as they cannot suppress malvertising until their patterns are discovered and modeled.
instead we argue that allowing publishers to persistently regulate third party contents is a better solution.
particularly publishers may specify regulations for an ad slot which will be enforced for all transactions and delegations introduced by the ad slot.
fig.
a shows a sample policy supported by pad for the ad tag ad btf.
it disallows any ad with sound after the delegation chain becomes longer than steps we assume the top level ads vendors deliver multimedia ads properly .
fig.
b shows the ads without pad where sound related resources are highlighted by .
fig.
c shows the ads loaded with pad enabled where sound related tags are removed.
b ad playing noisy sound html ... div id ad btf ... iframe ... iframe ... iframe ... audio autoplay autoplay source src macalert.mp3 type audio mpeg audio ... iframe iframe iframe div ... html a enforcing policy rule with pad pad if depth then block sound pad html ... div id ad btf ... iframe ... iframe ... iframe ... !
audio tag is removed source tag is removed iframe iframe iframe div ... html c ad without noisy sound fig.
.
preventing ads playing sound iii.
p roblem statement the current ads system has a very open policy anyone can bid for and win an ad slot and can resell the slot to other parties.
the current system is fundamentally vulnerable to malicious undesired ads that are intentionally or unintentionally delivered by bidders.
we study and classify the commonly seen undesired ad behaviors in table i. table i commonly seen undesired adbehaviors category t ype description examples malv ertising u1 deliv ering malicious software via ads intrusi v e ads u2 disrupt na vigation behavior e.g.
popup information access pri vate information for tracking disclosure u3 fingerprinting bro wser system versions inappropriate ads u4 ads with inappropriate contents e.g.
violence nontransparent ads with encrypted encoded flashes ads u5 ads deli vered through http ad blocking u6 blocking le gitimate ads malvertising uses ad networks to deliver malicious software.
intrusive ads distract visitors and cause unpleasant experience.
for example some ads intentionally divert users attention authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
publisher page policy compiler ad code publisher pagepad runtime publisher page memory protection access control dom randomization automated runtime installer policy spec policy code ad code policy code ad code fig.
.
overview with audio or video.
information disclosure in ad delivery leaks sensitive user information.
third party ads often contain js code that collects information on the client side and sends them back to the advertisers.
in many cases sensitive information is collected causing privacy concerns.
for example user browsing history is often collected to retarget ads.
however exposing such history to nonreputable advertisers should be regulated.
examples of inappropriate ads include videos of violence for kids and ads from the publisher s competitors which should not be displayed on the publisher s web page .
although ad networks have rules to prevent inappropriate ad contents these rules are usually too general and contextinsensitive.
nontransparent ads use stealthy techniques for disguising themselves or preventing inspection.
for example a malicious ad may dynamically construct a malicious flash to avoid being detected.
ad blocking removes ads from web pages.
while undesired ads are suppressed ad blockers also block legitimate ads eventually damaging the ecosystem.
while ad networks strive to suppress undesired ads they usually lack the necessary context to perform the needed finegrained regulation.
for example they may not have enough information about the publisher site to determine what ads are deemed inappropriate.
they also lack the resources and mechanism to regulate the huge volume of ads.
note that after bidding ads are often loaded directly from the advertisers servers to the client without going through the ad networks.
we consider publishers to be the ideal party to regulate unwanted ads and third party contents because they have the comprehensive contexts.
they also have a strong incentive to deliver relevant ads to the right consumers.
in addition comparing to having centralized censorship on ad networks it is more scalable to do so on the individual client machines.
therefore our problem statement is to allow publisher developers to program their regulation of third party ads shown on their pages in a reliable and persistent fashion.
iv.
o verview we propose a novel programming support system for third party ad censorship called pad.
as shown in fig.
pad consists of three main components the policy specification language the policy compiler that compiles specification to js code and a runtime that facilitates regulations.
policy specification language.
pad provides a language for publisher developers to program their ad censorship.
the developers engineer their regulation logic within an ad tag in the publisher s content page using our language.
such tags indicate the locations of ads which are populated when the content page is loaded.policy compiler.
the policy compiler compiles censorship policies in a content page to the corresponding js code.
only compiled pages are deployed.
each ad tag has its independent policy code.
in other words censorship is ad tag specific.
this is because individual tags independently load ads from different sources at runtime requiring different regulations.
programming global censorship for an entire page or publisher domain is possible but we leave it to our future work.
pad runtime.
pad runtime consists of modules automated runtime installer ari xv c1 memory protection xv c2 access control xv c3 and randomization xv c4 .
they are essentially js code that is shipped to the client.
automated runtime installer ari .
ari is the core engine enforcing the regulating code in all delegation layers.
for multi layer ad networks pad monitors dynamically generated contents and propagates itself into the next layer.
memory protection.
based on our extensive study on malvertising campaigns in the wild we observe that the manipulation of consecutive memory regions in js or actionscript is the root cause of payload injection.
to mitigate malvertising attacks pad prevents payload injection by perturbing values in consecutive memory regions.
access control.
this module allows publishers to restrict undesired ads such as information leak ads and intrusive ads.
the module essentially intercepts and or masks some js apis that are critical for undesired ads.
randomization.
to circumvent client side ad blockers our runtime leverages an existing web page randomization technique webranz to bypass ad blockers blacklist.
v. d esign in this section we present the design of pad.
we describe each component in detail and reason about our design choices.
a. policy specifications program p s stmt s s1 s2jprotect sbjjblock caj randomize ajif e thens expr e cururl opujdepth opcj history containsfu1 u2 u3 g operator op !
j j j j subject sbj memoryjflash capability ca geo datajcookiejbrowser versionj flash player versionjembedded flashj loadingjmimetypejpopupjsoundj srcless iframejredirection attribute a canvas datajdom const c f0 g url cururl u fig.
.
language.
the policy specification language is presented in fig.
.
the language supports a few statements that specify the actions authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
pad if cururl !
doubleclick.com then block browser version pad ... div id google ads div 6fig.
.
publisher page code with policy specification script ari google ads script div id google ads script if cururl !
doubleclick.com object.defineproperty window navigator get function return null script ... div fig.
.
publisher page with compiled policy code for undesired ad behaviors for example protect memory block clients cookies or geo location data from being accessed by ad scripts and randomize dom to circumvent ad blockers.
the language also supports conditional branches to allow publishers to specify the conditions in which the above mentioned actions should be taken.
for example a publisher may wish to apply memory protection for certain ad networks by comparing the current domain cururl with some domain uspecified by the publisher.
we also support comparison of delegation history which records the entire ad delegation reselling history.
such history is quite useful.
for example a cyclic delegation chain i.e.
an ad dealer sells an ad slot and later buys it back may suggest abnormal behavior.
therefore the current domain the delegation depth and the delegation history are of special interest and explicitly modeled in the language.
publisher developers can use regular js together with our language to achieve maximum feasibility.
b. policy compiler given a content page with policy specs pad parses the page to a dom tree using htmlparser2.
it first adds the automated runtime installer at the beginning of the page to make sure it gets executed before any other elements are loaded.
it then traverses the tree to identify all ad tags and the corresponding policy specs.
the js statements in the specs are simply copied to the output page whereas the statements in our language are translated to the corresponding js code to fulfill the specific actions including updating critical state variables e.g.
delegation depth and invoking api functions provided by our runtime.
the details are elided.
fig.
and fig.
illustrate how the policy compiler compiles a program with access control specs.
in fig.
the publisher includes an ad with idof google ads at line and inserts a spec at lines to block browser versions from being fingerprinted.
in fig.
the compiled policy code is inserted at lines .
the compiled code redefines window.navigator and changes its getter to returning null when a read attempt is executed.
the code at lines is only effective at the current layer of ad delegation.
to propagate the policy codewhen inner frames are created the function ari at line invokes the automated runtime installer ari to self install the policy code along the entire propagation chain.
we will discuss the design of ari in sec.
v c1.
c. pad runtime algorithm automated runtime installer input a compiled web app with instrumentation guarding the 1st layer of each ad output enforcing policy specifications over the entire delegation chain during runtime 1procedure ari ads foradinadsdo depth history globalvar fdepth historyg policycode getpolicycode ad ifinneriframecreated then propagate policycode globalvar 9procedure propagate policycode globalvar globalvar.depth globalvar.depth globalvar.history globalvar.history cururl inject globalvar inject policycode ifinneriframecreated then propagate policycode globalvar automated runtime installer ari ari provides persistent protection along the ad delegation chain.
at each delegation layer new content such as html js flash inner frame can be dynamically generated via js functions such asdocument.write .
ari propagates pad s protection logic along the delegation chain.
alg.
describes the design of ari.
it takes a compiled publisher page with ads guarded by instrumentation code.
for each ad within the page ari initializes global variables such as the delegation depth line domain history line and extracts the policy code generated from compiler for each specification line .
when an inner iframe is created ari invokes a recursive function propagate to propagate the policy code and global variables to the next layer of delegation lines .
the recursive function propagate increments the delegation depth line and updates the domain history to include the current domain line .
then it injects the updated global variables and policy code into the current layer lines .
the recursive procedure continues to propagate if a next layer of iframe is dynamically generated.
html head script src pad.js ... ... head ... div id div gtp ad ... ... div ... html iframe id google ads iframe ... ... html head script src pad.js ... ... head html iframe iframe id ad creative ... ... html head script src pad.js ... ... ... script src ad content .js script ... html iframe publisher ad network advertiserpublisher s webpage ad request via js libs document .write iframe ... ... ad request via js libsf3f2a b c ad contentwebpage requestf1 ari rewr ites document .write document .write iframe ... ... ari rewr ites document .write fig.
.
recursively applied ari on multiple delegations fig.
depicts the code snippet of how ari enforces pad in the delegation layers.
the right side of fig.
shows a authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
webpage including dynamically generated ad content during the ad delivery process.
note that in the example the publisher already installed pad on their webpages by including script src pad.js ... a in fig.
.
when a user visits the website the web page with pad is loaded .
during the page load an ad request is initiated to ad networks to retrieve the ad contents e.g.
html js flash .
the ad contents are dynamically inserted into the webpage by creating an inner frame f2 .
note that the document.write at2 is executed within frame f1 where pad is already installed.
hence pad intercepts it at and inserts script src pad.js ... b to install itself within the new inner frame.
similarly another layer of delegation is dynamically inserted into the inner page f2 .
at pad inserts script src pad.js ... c to install itself into the new inner frame f3 where the actual ad is finally delivered.
since pad is propagated through delegations it can enforce the protections persistently.
memory protection in this section we first analyze memory management related attack vectors in ads.
then we introduce our memory protection runtime support which mitigates malvertising by corrupting malicious payloads.
memory management in web ads.
as ads include js flash contents they can allocate and access memory via js or actionscript as interfaces.
we first explain different ways of accessing memory and how malicious ads exploit them.
... .
var ary initialize .
ary change a value a an example of array b ary at line d ary at line c memory fig.
.
immutable object immutable objects.
immutable objects are objects whose previously stored values on the memory are not overwritten.
fig.
a illustrates a simple js as program that initializes an array and updates its fifth element.
fig.
b c show how the array is allocated in the memory.
note that array in js is actually implemented as a hash table and a set of pointers to elements.
more importantly it is immutable meaning that changing a value in the array does not change the previously stored value.
instead as shown in fig.
c a new memory buffer is allocated for the new value.
mutable objects mo .
some js and as objects can access memory directly.
we call such objects mutable objects.
unlike immutable objects mutable objects allow overwriting previously stored values in memory.
more importantly the buffer allocated for a mutable object is consecutive.
typedarray e.g.
uint8array uint16array anduint32array and dataview in js and bytearray vector in as are popular classesthat can create mutable objects.
besides canvas in js andimagedata are used to access image data e.g.
pixel colors .
they can create mutable objects too.
indeed many exploits leverage them to directly write consecutive memory by changing image data e.g.
pixel colors in rgba format .
consecutive immutable objects cio .
we call multiple immutable objects that may be allocated in consecutive memory consecutive immutable object.
for example in modern browsers e.g.
firefox and chrome array objects in js are allocated in consecutive buffers when they hold a primitive type e.g.
integer .
string objects are also allocated in consecutive buffers.
attacks on memory in malvertising.
we analyze popular malvertising campaigns and exploit kits used in attacks and find that most attacks exploit vulnerabilities in js as memory management.
in particular they use mutable objects to inject and trigger malicious payloads.
in the following paragraphs we explain details of such attacks and their root causes.
payload injection and triggering via mutable objects.
mutable objects are widely used to inject and trigger malicious payloads by overwriting critical values in memory e.g.
return addresses .
specifically upon the allocation of a mutable object a new buffer is allocated and the corresponding memory address and length are stored in memory.
when the mutable object is used the address pointing to the start of the buffer is retrieved in order to compute the address for the access.
if the address or the length of the allocated buffer is compromised an attacker can access arbitrary memory just like accessing this mutable object.
such compromise is often achieved through vulnerabilities such as type confusion .
payload injection via cio.
as consecutive memory buffers are allocated for cio they can be leveraged to inject payloads like heap spraying.
however immutable objects cannot be directly used to write arbitrary memory and heap spraying itself does not trigger the injected payload.
therefore to launch an attack the attacker must rely on another vulnerability to trigger the injected code.
algorithm memory protection via value randomization input a js statement such as new uint32array output a uint32array object with value encoded 1procedure overloaded uint32a rray values valuesinmemory uint32array values.length fori i values.length i do valuesinmemory encode values this.values uint32array valuesinmemory return this input a js statement such as u32arr.indexof output return the index of from 7procedure overloaded index of elem valuesinmemory this.values fori i valuesinmemory.length i do values decode valuesinmemory return this.indexof values mitigating malvertising via memory protection.
we mitigate malvertising via memory protection which is driven by the procedure of attacks being launched using mutable objects authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
and consecutive immutable objects.
malvertising attacks are conducted in two critical steps.
first a malicious payload is injected into the victim s memory via legitimate channels e.g.
loading an image with a payload prepared by an exploit kit and heap spraying is often used due to address space randomization techniques.
later the payload is triggered and executed by exploiting vulnerabilities.
as these two steps are essential to its success malvertising can be suppressed by breaking either step.
we describe how we achieve this via value and data layout randomization.
value randomization encoding decoding values .
pad breaks a malicious payload by perturbing values in memory.
in particular it encodes values written to memory via mo and cio and decodes them upon retrieval using the same key employed in encoding.
in this scenario malicious payload is encoded before being injected to memory.
however since a malicious payload is always executed natively without going through the js as interfaces it is not properly decoded before execution and hence broken.
alg.
illustrates how value randomization is realized for uint32array objects.
specifically when a new uint32array object is created instead of storing the arguments as array values the overloaded constructor lines encodes each element and the encoded values are stored in memory.
when the statement invokes indexof on the previously created object theuint32array.indexof is overloaded lines .
to return the index of element i.e.
the values in memory are decoded and the native implementation of indexof is invoked to return lines .
data layout randomization.
pad also randomizes the underlying memory layout for js as objects to break a malicious payload which is quite sensitive to memory structures.
in fact attackers leverage cios to inject payloads mainly because they provide a convenient and reliable way to hold the carefully crafted payload in a consecutive sequence of buffers.
to randomize memory layout when a new cio is created pad creates new dummy objects and inserts them in between the original buffers.
for instance when a program creates an array pad constructs instead where rrepresents a random value.
as a result if an attacker tries to inject malicious rop payloads with cio the random values placed between rop gadgets will break the exploit.
note that the semantics of the array is not broken as when the array is accessed we translate the index of the real values skipping the inserted r. access control as discussed in sec.
v b the policy compiler compiles the specification program and redefines objects such as window.navigator to block the access to particular objects and achieve access control.
during runtime the redefined getters will be invoked rather than the native functions.
for example as illustrated in fig.
line any read access to the browser information from domains other than doubleclick.com viawindow.navigator is restricted.
security sensitive objects and objects related with intrusive ads are identified and redefined during runtime.
we omitthe discussion of other objects as they are similar to abovementioned case.
randomization webranz is integrated into pad.
webranz is a web page randomization technique which protects advertisements from being blocked by ad blockers.
specifically it randomizes urls and dom element properties e.g.
idandname which ad blockers rely on to locate and remove ads.
however webranz is not sensitive to ad tags.
instead its randomization technique is applied to the entire page resulting in a high overhead.
pad only performs randomization on ad contents within ad tags specified by publishers.
by so publishers can deliver ads without being blocked by ad blockers with less overhead.
as the randomization technique is not our focus details are omitted.
d. threat model pad assumes publishers and website visitors are benign while the ad networks and advertisers may be malicious.
note that in most malvertising campaigns the malicious party is the advertiser.
while the ad networks might also be compromised protecting compromised publishers is beyond the scope of our paper.
in fact if a publisher is compromised any operation in the compromised page cannot be trusted.
similarly protecting visitors with compromised systems e.g.
os kernel browser is out of our scope.
accessing original definitions.
an attacker may try to bypass pad by locating and directly using the original functions or classes.
a straightforward way is scanning all variables to find the ones holding the original versions.
for example window in js can be used to enumerate all defined global variables.
by recursively resolving the global variables one may gain access to any variable including the variables holding the original definitions.
to prevent this we disable variable enumerations viaobject.defineproperty as a part of our runtime installer.
note that object.defineproperty is protected so an attacker cannot abuse this interface.
moreover even though it is not enumerable if the variable names are statically defined they can be directly accessed by names.
hence we generate random names for the variables that contain original definitions.
the name is randomized on each load to make it a moving target.
removing our protection.
an attacker may try to remove our protection by replacing classes and methods overwritten by pad with their own version.
to prevent this we use defineproperty to make classes and methods we modified read only.
specifically we set writable property to false and override defineproperty to prevent further changes.
as we do it at the very beginning of each delegation no js code including malicious one can disable our definition.
disabling automated runtime installer.
as pad s protection depends on ari which installs itself and pad an attacker may try to disable ari.
however to achieve this the attacker needs to bypass our methods by calling the original ones which we made impossible as discussed above.
in brief one cannot remove our methods as they are readonly e.g.
writable false .
to prevent any attempts authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
table ii characteristics of malicious adcampaigns ad date publisher ad networks first ad redirect n a propellerads clickadu etc.
n a yahoo msn n a broxu.com n a re venuehits foundationarcet.or g n a re venuehits top4do wnload.or g answers.com doubleclick zedo etc.
rfihub .com nalsee.com n a .
.
.
japanese ne ws sites n a n a wira ku.com n a a.horsered.com netw ork tools.com n a ox.help.or g hindustantimes.com n a static.rcs7.or g marica.bg n a serve.intelelink.net centralpark.com n a saw .piroscia.com urbantoronto.ca n a reserv e.sandystrong.or g onlinene wspapers.com n a c.ic.com.au n a n a zamcheck.or g n a n a stat.litecsys.com proof of concept poc sample.
n a publisher ad traffic is redacted or not included in sample.
to change thewritable property of object we override defineproperty to disallow change requests.
vi.
e valuation pad is implemented in javascript and actionscript leveraging a set of node.js utilities.
we investigated the following research questions to evaluate the effectiveness of pad to regulate third party ads over the complex ads delegation process.
rq1 how effective is pad on preventing malvertising?
rq2 how effective is pad on preventing information leak ads non transparent ads inappropriate and intrusive ads?
rq3 how much runtime overhead does pad incur?
table iii malicious adcampaigns attack vectors ad exploit kit payload cve report attack v ector neutrino trojans dataview steg ano spyw are bytearray magnitude cerber bytearray magnitude cerber unrepor ted bytearray angler ransomw are bytearray kaixin pecompact2 t rojan vector angler spyw are uint32array vector angler poweliks bytearray sweet orange zemot vector nuclear crypto w all vector sweet orange gimemo t rojan vector sweet orange zusy t rojan vector nuclear zemot vector nuclear zusy t rojan vector sweet orange trojan dropper vector nuclear zbot sp yware vector ransomw are.
downloader.
a. experimental methodology to answer the research questions we run pad on real world ad examples.
specifically we collect malvertising ad samples for rq1 and undesired ads for rq2 .
we gather the source code of publisher web pages and host them on our own web server.
for the cases in which the publisher is not reported or intentionally redacted we set up a test page to include the undesired ad s on our web server.
b. experimental results rq1 malvertising attacks.
table.
ii and iii show the malicious ad samples and the memory protection enforced.column publisher lists the websites redirecting to malware through ad networks.
first ad redirect andad networks show the first malicious redirect and the ad networks involved in each malicious campaign.
we collect samples of malvertising in the wild and proof of concept poc samples from online malvertising reports.
of them are exploiting adobe flash player samples for internet explorer and for microsoft edge.
note that it is very hard to collect malvertising samples from the wild as most malicious campaigns simply change their ips or ad networks once they are caught.
moreover malvertising attacks that exploit zero day vulnerabilities make them very difficult to be detected.
we have validated that all attacks can be suppressed by one line of memory protection specification.
note that pad provides a general protection hence it prevents anunreported case ad too.
rq2 undesired ads.
we investigate how pad benefits the protection against intrusive ads u2 information disclosure ads u3 inappropriate ads u4 and nontransparent ads u5 .
table.
iv summarizes our findings.
column adand date are the reference and date of the undesired ad.
note that entries with are ads that are active as the time of paper submission.
the table also shows the publisher involved in each ad campaign and the access control specification publishers can leverage to suppress each undesired ad.
for example ad on nytimes.com redirects users to a malicious page.
developers can leverage our specification language block redirection to disable redirections.
on youtube.com directs users to a flash ad which fingerprints users browser.
to prevent users browsers being fingerprinted youtube developers can specify block browser version with pad.
preschool sites funology.com andtwistynoodle.com serve inappropriate ads to children via ad retargeting service.
publishers can use pad to block ads from particular domains.
ad serves from ad network domain ero advertising.com embedded a flash ad onstopmalvertising.com to perform ddos attacks.
block embedded flash can be used to block such ads.
as shown in the result all undesired ad behaviors are prevented by enforcing our access control policies.
a detailed case study is discussed in vi c3.
page w o pad page with pad 7average .
average .
std .
std .
fig.
.
page load latency rq3 runtime overhead.
finally to understand the runtime overhead induced by pad we study the average latency of rendering a web page with and without pad.
we choose alexa top websites load each page times and calculate the average load time.
as shown in fig.
a web browser takes a slightly longer time to render a web page when it is enforced with our protection.
this is because pad introduces additional javascript and the browser needs extra authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
time to parse the code the self propagating enforcement intercepts the multiple layers of ad delivery on the fly.
as the size of additional javascript is small and the interception is lightweight the overhead of rendering a page with pad protection is negligible .
to avoid different ads being loaded across runs of the same website we save all the contents including ads and host them on our own proxy.
we also used a plugin to check each page load event.
the plugin is designed in such a way that any unsuccessful load causes the browser to hang forever.
in our experiment we have not encountered any such cases.
this suggests that pad does not affect normal functionalities including ads .
table iv access control on undesired adbehaviors type ad date publisher access contr ol spec u2 watchfomn y.tvblock popuptorrentz.eu nytimes.com block redirection u3 n ablock mimetype n a youtube.com block browser version fileserv e.com block flash player version u4 funology.com twistynoodle.com ifcururl xxx.com realstreamunited.tv then block loading stream2w atch.cc u5 n a randomize canvas data n a block loading n a block srcless iframe gope go.com block embedded flash n a stopmalvertising.com the ad is active now.
n a publisher is redacted or not included in report.
c. case study in this section we show three case studies to demonstrate how pad prevents undesired ad behavior in practice.
type confusion vulnerability in microsoft edge type confusion vulnerabilities have been reported lately in the js engine chakra of microsoft edge.
when an ad is delivered js can be injected for logging and dynamic ad delivery.
unfortunately a malicious advertiser can also inject a malicious js file to exploit the vulnerabilities to execute malicious code.
var dv new dataview new arraybuffer exploit cve 2016 7201 ... ... var ropptraddr ... address of stack var rop for var i i rop.length i dv.setuint32 retptraddr.add i rop contents of stack memory injected payload 0x20564d603fa 0x20560000000 0x211d000a2f5 0x211d000a2cd ... b w o pad c with pad 0x0101030665d704fb 0x0101030661010101 0x01010312d101a3f6 0x01010312d101a3ce ... a malicious javascript program cve 0x0101... 0x0101... 0x0101... 0x0101... 0x0101... fig.
.
malicious js program exploiting dataview fig.
a shows a malicious js program which exploits two vulnerabilities cve and cve .
in particular it first creates a dataview object which will be used to inject a malicious payload at line .
then at line it leverages the vulnerabilities to obtain a corrupted dataview object dv .
specifically it exploits cve which is a type confusion vulnerability to obtain the ability to modify a target address of dataview when it reads and writes.
as we discussed in sec.
v c2 a dataview object internally stores a pointer to a buffer which holds its value and the length of the buffer.
cve essentially changes the pointer of the buffer via a type confusion vulnerability.
as a result after line the js program can read and write arbitrary memory through the corrupted object dv.
specifically by changing the first argument of setuint32 which specifies an offset of the dataview s buffer for writing a value an attacker can overwrite values on any address he she wants to.
then at line it obtains a stack address containing a return address by exploiting address information leak.
we omit the detail due to the space limit.
at line it constructs a malicious rop payload rop within an array.
finally the program injects the malicious payload at lines through thesetuint32 method.
note that dvis already compromised so that it can point to arbitrary buffer.
therefore by providing addresses pointing to the program s stack it injects the malicious payload.
pad protects the attack by mutating input values passed to dataview.
in particular pad overrides the dataview.setuint32 to mutate any input parameter.
in this example to make the discussion easier we mutate the input by adding to every byte of a value passed to setuint32 .
for example a 0x64d603fa input value will be mutated to 0x65d704fb.
note that in our implementation we use a one time pad encoding scheme.
hence we apply different mutations every time.
fig.
c shows an example of a corrupted stack with a simple addition for each byte .
observe that such a small addition completely breaks the functionality of the payload and leads the exploit to a crash as the execution jumps to an unmapped memory.
in addition to overriding setters e.g.
setuint32 we do also override getters e.g.
getuint32 to decode retrieved values in order to enable seamless execution of benign program operations via dataview.
the decoding performs the exact reverse operation of the encoding process.
for example if we encode by adding 0x1 to the values we decode by subtracting 0x1 at getters invocation.
pixel bender parser vulnerability in adobe flash player similar to the type confusion attack in microsoft edge vector in as can be corrupted by a vulnerability on pixel bender parser which is a high performance graphic programming interface for image processing.
var vt new vector.
int ... exploit cve ... ... var ropptraddr ... address of stack var rop for ... vt rop fig.
.
malicious as program exploiting vector fig.
shows a malicious flash file which contains as code exploiting cve vulnerability.
at line the code authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
first allocates a vector.
the function at line represents exploiting the vulnerability in order to overwrite the length ofvector.
note that vector in as and dataview in js have similar internal representations and thus share the same problems of the vulnerable length information.
by overwriting the length ofvector an attacker can gain arbitrary memory access.
similar to the edge case it prepares rop gadgets and stack addresses then injects the rop payload at line .
note that it uses the operator to inject the payload instead of invoking a function.
to handle this pad also overrides the operator by using defineproperty with index e.g.
and so on .
note that in js as obj is equivalent to obj.name.
hence we override obj.
obj.
and so on.
as in js pad prevents the attack by encoding the values passed through operator.
preventing geo location information access personalized ads are chosen based on the profile of targeted customers.
while it is valuable to advertisers collecting sensitive information to deliver targeted ads is quite controversial.
when multiple ad networks are involved it is hard to know and control who collects what information.
hence it is important for publishers to protect their customers sensitive information from being collected by ad networks or advertisers.
div id div gtp ad1 ... script navigator.geolocation.
getcurrentposition ... script ... div ... div id div gtp ad1 ... script navigator.geolocation.
getcurrentposition ... script ... div a ad accesses geo location b install pad with policy spec script src pad.js script pad block geo data pad ... div id div gtp ad1 ... ... div c ad regulated by pad script navigator.geolocation.
getcurrentposition function return null script fig.
.
preventing geo location accesses in this case study we show how pad enables a publisher to protect its customer s geo location from being disclosed to ad networks and advertisers.
fig.
a shows the publisher web page without pad.
the tag div with id div gpt ad1 serves as an ad slot on the page.
shows the js code loaded as a part of the ad delivery.
it accesses the geo location of the customer via the js interface navigator.geolocation.getcurrentposition.
fig.
b shows how pad can be employed to enforce the geo location access control.
first the publisher developer includes script src pad.js script at the beginning of the page fig.
.
then she can add policy specblock geo data as shown in fig.
to enforce that blocks geo data on any delegation any url .
fig.
c shows how pad enforces the policy at runtime.
specifically pad first overrides navigator.geolocatio n.getcurrentposition to intercepts the access to geo location.
when getcurrentposition is invoked pad checks the current specifications and applies actions accordingly.
in this case the access control for blocking geo location takes effect.
pad returns empty geo location information instead of returning the real location .
besidesblocking flexible fuzzing methods such as reducing location accuracy can be easily supported in pad.
vii.
r elated work malvertising detection.
zarras et al.
investigated the source of malvertising and showed that every publisher without an exclusive agreement with the advertiser is likely to serve malicious ads.
xing et al.
performed a large scale study on malvertising in ad injecting browser extensions.
odoswiff detects malicious flash files based on known patterns in the code and execution traces.
in particular it statically looks for invalid images suspicious jumps and apis used in known exploits.
madtracer detects malvertising based on rules learned from the ad delivery paths.
stringhini et al.
and mekky et al.
identify malicious content based on http redirections.
poornachandran et al.
proposed a classifier based malvertising detection approach.
as learning based detections rely on patterns found in known attacks they may not catch unknown attacks.
in contrast we break the payloads that are carefully crafted for specific defects we can stop the attacks even targeting at zero day vulnerabilities.
ads and security policies.
alt presents an advertising platform based on adaptive profiles where visitors can setup profiles to obtain favorable ads.
adjail is a framework for publishers to specify confidentiality and integrity policies on ads.
adsentry allows publishers and end users to specify access control policies for ads.
gui et al.
surveyed android apps and identified several undesired consequences of ads including hidden costs and complaints.
they further studied mobile ad reviews to identify complaint topics .
hussein et al.
use a runtime verification tool to enforce security specification for java.
ghotbi and fischer presents a fine grained role and attribute based access control model.
we focus on developing a policy language for publishers so that they can easily specify how pad operates.
viii.
c onclusion we propose a novel programming support system pad to regulate third party ads.
pad allows publisher programmers to specify and enforce their ad regulation policies throughout the entire ad delegation chain.
this is enabled by a self installing and self protecting runtime.
pad also features an ad specific memory protection scheme that prevents malvertising.
our experiments show that pad has negligible overhead and can effectively prevent real world malvertising and undesired ads.
acknowledgment we thank the anonymous reviewers for their constructive comments.
this research was supported in part by darpa under contract fa8650 c nsf under awards and onr under contracts n000141410468 and n000141712947 erc grant fp7 and bmbf project crisp.
any opinions findings and conclusions in this paper are those of the authors only and do not necessarily reflect the views of our sponsors.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.