understanding and detecting evolution induced compatibility issues in android apps dongjie he state key laboratory of computer architecture institute of computing technology cas university of chinese academy of sciences beijing china hedongjie ict.ac.cnlian li state key laboratory of computer architecture institute of computing technology cas university of chinese academy of sciences beijing china lianli ict.ac.cnlei wang state key laboratory of computer architecture institute of computing technology cas university of chinese academy of sciences beijing china wanglei2011 ict.ac.cn hengjie zheng state key laboratory of computer architecture institute of computing technology cas university of chinese academy of sciences beijing china zhenghengjie ict.ac.cnguangwei li state key laboratory of computer architecture institute of computing technology cas university of chinese academy of sciences beijing china liguangwei ict.ac.cnjingling xue university of new south wales school of computer science and engineering sydney australia jingling cse.unsw.edu.au abstract the frequent release of android os and its various versions bring many compatibility issues to android apps.
this paper studies and addresses such evolution induced compatibility problems.
we conduct an extensive empirical study over different android versionsand4 936androidapps.ourstudyshowsthatthereare drastic api changes between adjacent android versions with averagely140.8newtypes .6newmethods and979.2newfields being introduced in each release.
however the android support library provided by the android os only supports less than ofthenewlyaddedmethods withmuchlesssupportfornewtypes and fields.
as a result .
of android apps write additional codetosupport differentosversions.furthermore .
ofthe supporting codes share a common pattern which directly comparesvariable android.os.build.version.sdk int withaconstant version number to use an api of particular versions.
basedonourfindings wedevelopanewtoolcalledictapifinder to detect incompatible api usages in android applications.
ictapifindereffectivelycomputestheosversionsonwhichanapi maybeinvoked usinganinter proceduraldata flowanalysisframework.itdetectsnumerousincompatibleapiusagesin361outof apps.
compared to android lint ictapifinder is sound and corresponding author permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed forprofitorcommercialadvantageandthatcopiesbearthisnoticeandthefullcitation on the first page.
copyrights for components of this work owned by others than acm mustbehonored.abstractingwithcreditispermitted.tocopyotherwise orrepublish topostonserversortoredistributetolists requirespriorspecificpermissionand ora fee.
request permissions from permissions acm.org.
ase september montpellier france association for computing machinery.
acm isbn ... .
to reduce the false positives by .
.
we have reported the issuesto13appsdevelopers.atpresent 5ofthemhavealreadybeen confirmedbytheoriginaldevelopersand3ofthemhavealready been fixed.
ccs concepts software and its engineering automated static analysis software reliability software safety keywords android compatibility incompatible api usage android evolution acm reference format dongjie he lian li lei wang hengjie zheng guangwei li andjingling xue.
.
understanding and detectingevolution induced compatibility issues in android apps.
in proceedings of the 33rd acm ieee internationalconferenceonautomatedsoftwareengineering ase september montpellier france.
acm new york ny usa 12pages.
introduction android is the most popular mobile operating system with over market share .
the number of android applications is increasing at an alarming speed with about new apps re leased on google play every month .
however android os is released frequently and it is a well known challenge for the applicationdeveloperstodealwithcompatibilityissuesondifferent os versions .
this challenge is now a hot topic on internet forums such as stack overflow different topics and the developershavetodealwithcomplaintsfromusersaboutthepoor compatibility of their apps frequently.
there are no mature tools to detect evolution induced compatibility issues for android apps i.e.
compatibility issues caused by android system evolution.
existing studies have investigated authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
ase september montpellier france dongjie he lian li lei wang hengjie zheng guangwei li and jingling xue severalaspectsoftherelatedissues.forexample previousworks try to understand software reuses in android apps and find them heavily depend on android api.
mcdonnell et al.
studiedhowfastandroidapievolvesandtheimpactofapievolution on the compatibility issues of android apps.
li et al.
studied inaccessible android apis and concluded that inaccessible apis used in apps are neither forward nor backward compatible.
ficfinder uses api context pairs manually extracted from known compatibility issues to detect unknown fragmentationinduced compatibility issues.
although these works are helpful in understanding evolution induced compatibility issues for android apps littleisknownonhowdevelopersfixsuchissues whether theseissuesarecommoninappsandwhataretheirrootcauses.in addition existing studies have not investigated these issues down to the source code level.
hence they cannot provide deeper insights e.g.
common fixing patterns to understand and mitigate evolution induced compatibility issues.
to better understand evolution induced compatibility issues in androidapps weconductanextensiveempiricalstudyoverthe most popular android os versions and android apps.
we findthat91.
ofandroidappswritespecificcodetodealwith evolution inducedcompatibilityissues.thisisduetothedrastic api changes induced by android evolution and the insufficient support from the android support library there are .
new types .
new methods and .
new fields being introduced ineachnewsdkreleaseandonly21.
newtypes .
new methods and .
fields are supported by the support library.
furthermore wefindthatfixingevolution inducedcompatibility issues in android apps is usually very simple .
of themcompare the variable android.os.build.version.sdk int abbreviated assdk int with a constant integer value directly to check the versionsoftheunderlyingandroidos.webelievethesefindings can provide guidance to detect diagnose and fix evolution induced compatibility issues.
based on our findings we develop ictapifinder a new tool to automatically detect incompatible api usages in android apps.incompatibleapiusagesareonetypeofevolution inducedcompatibilityissueswhichinvokeapimethodsnotsupportedbythe underlyingandroidversions.theyareseriousbugswhichoften crash the apps and throw java.lang.nosuchmethoderror exceptions.
ictapifinder computes on which android versions each api canbeinvoked usinganinter proceduraldata flowanalysisframework.
it then checks whether an api invocation is incompatible ornotbyexaminingeachspecificandroidsdkversion.wehave implemented ictapifinder in soot and have applied it to android apps downloaded from f droid where apps have been found to be problematic.
we have manually analyzed the bug reports from randomly selected apps and have found that our tool could effectively reduce .
false positives compared to android lint a tool available in android sdk.
we have reported our findings to their original developers for of the apps reportedissueshavebeenacknowledgedbytheiroriginaldevelopers and3ofthemareconsideredascriticalbugswhichhavealreadybeenfixed.notethatonealready fixedbugisactuallycausedbyan external library which cannot be found by android lint and isalsodifficulttodiagnoseforthedevelopers.tosummarize this paper makes the following contributions we conduct the first empirical study of evolution induced compatibilityissuesonlarge scale real worldandroidapps apps and android os versions .
our findings can help to better understand and characterize such issues and shed lights on future studies on this topic.
weproposeanewmethodtoautomaticallydetectincompat ibleapiusagesinandroidapps bypreciselycomputingthe reachable android os versions for each api the os versions onwhichtheapimaybeinvoked usinganinter proceduralcontext sensitivedata flowanalysisframework.ourmethoddrasticallyimprovestheprecisionofexistingtools reducing the false positives of android lint by .
.
we design and implement a new tool ictapifinder to automaticallydetectincompatibleapiusagesinandroidapps.
ictapifinder have detected incompatible api usage bugs in out of apps.
we have reported our findings to theiroriginaldevelopersfor13randomly selectedapps reportedissueshavebeenacknowledgedand3criticalissues have already been fixed.
the rest of this paper is organized as follows section 2presents the necessary background information.
section 3describes our empirical study.
we propose our detection method in section and evaluate it in section .
we discuss the threats to validity in section 6and summarize related works in section .
finally section8concludes the paper.
background android is a fast evolving system.
the platform provides apis i.e.
android sdk to its applications as the programming interfaces.
theseinterfaceskeepchangingasandroidevolves.byconvention versions of android sdks are differentiated using a unique integer identifier named apilevel .theapilevelstartsfrom1 andat present the api level of the latest sdk version is .
.
declare sdk versions in android apps listing example code snippet to declare sdk versions.
uses sdk 2android minsdkversion 3android targetsdkversion 4android maxsdkversion android apps need to declare their supported sdk versions via the uses sdk element in their manifest files i.e.
androidmanifest.xml .
as shown in listing there are attributes given integer values minsdkversion.
theminsdkversion value declares the minimum api level supported by an app.
the app will not be installed on an android system if its minsdkversion value is larger than the api level of the underlying system.
targetsdkversion.
thetargetsdkversion value defines the api level that an app targets at.
android adopts the backward compatibleapibehaviorsofthedeclaredtarget sdkversion evenwhentheappisrunningonahighersdk version.thisdesignaimstoensureconsistentbehaviorof the apps on different sdk versions.
maxsdkversion.
themaxsdkversion value gives the maximum platform api level on which an app can run.
this authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
understanding and detecting evolution induced compatibility issues in android appsase september montpellier france attributeisalreadydeprecatedsinceandroid2.
apilevel .
thedeclaredsdkversionsonlysuggestonwhichversionsan app can be installed.
in practice app developers commonly use the runtime value of variable sdk int to check the sdk version of the underlying system .
.
android support library android os provides the android support library as a basic solution to tackle the increasingly severe evolution induced compatibility issues.
this library was firstly released in .
it hassince become the most widely used android library .
the androidsupportlibraryconsistsofacollectionoflibrarieswhichcan roughly be divided into two groups compatibility and component libraries .
compatibilitylibrariesfocusonbackportingfeaturesfornew sdk releases.
it provides wrappers for a subset of interfaces or types ondifferentsdkversions.insteadofinvokingapisprovided by the sdk directly apps can call the wrappers in the supportlibrary.
as such apps developed for a new sdk version may be abletorunonprevioussdkversions withoutmodification.the major compatibility libraries are v4 and v7 appcompat.
component libraries implement features that are not part of the standard framework.
these self contained libraries can be easily addedorremovedfromaprojectwithoutconcerningfordependencies.themajorcomponentlibrariesincludev7 recyclerviewand v7 cardview.
in this paper we focus on the compatibility libraries since the component libraries do not handle compatibility issues.
.
android lint androidlintisacodescanningtoolintroducedinadt android development tools .
it checks for various potential bugs and optimizationimprovements.thetoolintegratedinthelatestversion of android studio features more than default checks.
one of them called apidetector aims to detect incompatible api usages.
this check scans through all invocations to android apis.
it warns about an invocation to a particular api if it is not available on sdk versions supported by the app as declared in its manifest file.
lint ignores code snippets annotated with certain annotations e.g.
targetapi and suppresslint .
although not mentioned in any documents we notice that lint avoids false positives by ignoring code patterns when an api is invoked in an ifstatement whose condition compares variable sdk int to an integer value to check the underlying android sdk version.
empirical study the study tries to address the following three research questions.
rq1 root cause whataretherootcausesofevolutioninduced compatibility issues?
rq2 issueseverity howcommonaretheseissuesinreal android apps?
rq3 issuefixing howdoandroiddevelopersfixevolutioninduced compatibility issues in practice?
.
methodology to answer the above research questions we collect a large set of data consisting of android sdk versions together with the androidsupportlibraryintheseversions and4 936apps.this subsection presents our datasets and analytical methods.
table list of selected android sdk versions.
level revision shares types methods fields android .
.2 r2.
.
android .
.2 r1.2b .
android .3 r3.
.
android .4 r1.
.
.
.
android .
.2 r3 .
android .
.1 r9 .
android .
.1 r9 .
android .
.0 r7 .
android .
.2 r9 .
android .
.0 r9 .
android .
.0 r9 .
.
.
datasetscollection.
weconsider apilevels 27inour research.
table 1presents the selected android sdk versions column2 andtheirmarketshares column3 .theotherversions arenotselectedsincetheirmarketsharesarenegligible.apilevel is specific to wearable devices thus it is not included in our study either .
we compile the sources of these sdk versions downloadedfromaosp .foreachversion weextractitssdk android.jar and the corresponding support library for further study.thelastthreecolumnsintable 1givethenumberoftypes methods and fields in each sdk version respectively.
weconductourstudyusingalargesetofthird partyapps in apk format without source code downloaded from the androzoorepository .androzooisaspecializedrepositoryforthe researchcommunity andwetotallydownload8 047appsfromit.
in this study we only consider apps targeting our selected apilevels i.e.
targetsdkversion value ranges from to and apps are selected.
table list of manually inspected apps.
the apps in f droid with the most usage counts of variable sdk int are selected.
app release kloc sdk ints org.telegram.messenger .
.0a .
com.poupa.vinylmusicplayer .
.
.
.
org.glucosio.android .
.
foss .
com.amaze.filemanager .
.
.
im.vector.alpha .
.
.
185com.github.axet.maps .
.
google .
179com.biglybt.android.client .
.
.
173eu.kanade.tachiyomi .
.
.
165org.bottiger.podcast .
.
.
165es.usc.citius.servando.calendula .
.
.
table2lists the open source apps downloaded from fdroid a popular open source app store for manual inspection.
the 10apps are selected becausethey frequently usethe variable sdk int which is commonly used by developers to check specific sdkversionsandaddresscompatibilityissuesonthoseversions.
we write a crawler to download all latest version of the total apps in f droid.
the apps which use variable sdk int for authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
ase september montpellier france dongjie he lian li lei wang hengjie zheng guangwei li and jingling xue the most number of times are chosen.
column gives the usage counts of variable sdk int for each app.
we manually inspect the sourcecodesofthe10apps tounderstandhowdevelopersaddress evolution induced compatibility issues in practice.
.
.
analytical methods.
to answer rq1 we compare the differencesbetweenany twoadjacentsdkversions.specifically we check whether any newly introduced apis are supported by its corresponding android support library or not.
to answer rq2 we usesoot toscanthe4 936appsdownloadedfromandrozoo and count how many times the variable sdk int is used.
in our experiments we assume that variable sdk intis mostly used to test the underlying sdk version and address evolution induced compatibility issues.
we manually inspect the code snippets where sdk intis used for the apps in table to answer rq3 and validate the above assumption.
.
findings a type b method c field figure differences between adjacent sdk versions.
.
.
rq1 root cause.
finding androidsdkversionevolutionleadstosignificant api changes.
figure1comparesthedifferencesbetweentwoadjacentsdkversions.weobservedramaticchangesasandroidsdkevolves.on average .8newtypes .6newmethodsand979.2newfields are introduced as the android sdk evolves into a new version.
finding android support library provides support for less than of the new introduced apis.
theandroidsupportlibraryisintroducedtoeasecompatibility issuesintheandroidecosystem.wearecuriousabouthowwell theyaddresscompatibilityissuesbetweendifferentsdkversions.
in our research we compare any two adjacent sdk versions by checkinghowmanynewlyintroducedapis types methods and fields aresupportedbytheandroidsupportlibrary.weconservativelyassumethatanapiissupportedbytheandroidsupportlibraryifitisusedinthelibrary.thisgivesusanoptimisticestimation sincetherearealsonormalusagesbesidesthoseaswrapper methods.
disappointingly the support ratio is only .
for new types .
fornewmethods and5.
fornewfields suggesting insufficientsupporttoaddresstheprevalentcompatibilityissues.
table api changes supported by the android support library.
supported new introduced adjacent levels type method field 17vs18 18vs19 19vs21 02221vs22 6422vs23 82323vs24 24vs25 25vs26 finding without considering api behavioral changes of apps can directly run on the next android version withoutany modification.thus evolution inducedcompatibility issues are mainly introduced from api behavioral changes and new features in later sdk versions.
1000apk figure distribution of apps using abandoned apis.
figure2counts how those apis abandoned in the next sdk version are used in android apps.
the interesting fact is that appsoutofthetotal4 697appsdonotuseanyabandonedapis.
hence ifnotconsideringapibehavioralchanges wecanconclude that apps can run on a later sdk version without any modification.thisimpliesthatdevelopersaddressevolution induced compatibility issues mainly because they need to adapt api behavioral changes or use new features in later sdk versions.
answer to rq1 to summarize the main causes of evolution induced compatibility issues in android apps are the drastic api changes induced by android evolution and the insufficient support from the android support library.
as a result app developers often have to deal withevolution inducedcompatibilityissuesinordertouse latest features and support multiple sdk versions.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
understanding and detecting evolution induced compatibility issues in android appsase september montpellier france .
.
rq2 issue severity.
finding .
of apps write specific code to address evolution induced compatibility issues.
we use soot to analyze the apps downloaded from androzoo where32appscannotbeprocessed.amongtheremaining apps apps use variable sdk int usages in the android support libraries e.g.
classes whose name started with android.support.
are excluded suggesting that .
of apps checktheunderlyingandroidsdkversionstoaddressevolutioninducedcompatibilityissuesintheirimplementation.wealsocount howmanytimes sdk int isusedineachapp.onaverage anapp uses variable sdk intfor .
times figure .
figure sdk intusage counts in apps finding less than .
apis are frequently used and sdk intis the most frequently used field.
figure4studies the usages for each android api apis have never been used by the apps we processed and only .
apis are used by more than apps.
we have manually inspected the apis with more than one million usage numbers.
they can be classified into three categories apis belong to the jdk library with in java.lang.
2i njava.util.
and in java.io.
30apisstartwith android.
with8in android.os.parcel 5inandroid.util.log 4inandroid.os.bundle 3inandroid.content.
intent 2inandroid.app.activity andandroid.os.binder andother 6in6diffrentpackages respectively theremaining3apisallbelong toorg.json.jsonobject .
moreover we find that sdk int is the only field with more than one million usage counts which also confirmsourfindingthattheappsdevelopersfrequentlyhandle evolution induced compatibility issues by themselves.
4679api figure distribution of apis by usage counts.
answer torq2 evolution inducedcompatibilityissues are very common and about .
of apps write specific code to deal with such issues.
.
.
rq3 issue fixing.
finding6 mostfixingpatternsareverysimple complicated patterns are rare.
we have manually inspected the apps in table and found several common patterns to address evolution induced compatibility issues.
the most common practice is to invoke different apis directly on different versions according to the runtime value ofsdk int.
forexample listing 2shows acode snippetextractedfrom com.amaze.filemanager wherethesdkapimethod quitsafely instead of quit is used after api level .
listing2 commonpracticetoaddressevolution inducedin compatibility issues.
1if sdk int let it finish up first with what it s 3handlerthread.quitsafely else 5handlerthread.quit frequently thedevelopersintroducewrappermethodstodeal withevolution inducedcompatibilityissues.thecodesnippet also extracted from com.amaze.filemanager in listing 3invokes different password encrypt wrappers cryptutil.aesencryptpassword andcryptutil.rsaencryptpassword fordifferentsdkversions where different sdk apis are invoked by the wrappers accordingly.
listing address evolution induced compatibility issues using wrapper methods.
1if build.version.sdk int build.version codes.m 2returncryptutil.aesencryptpassword plaintext else if build.version.sdk int 4returncryptutil.rsaencryptpassword context plaintext else 6returnplaintext inadditiontodirectlycheckthevalueof sdk int inanifstatement developers sometimes check the value of sdk int using differentformsofexpressions e.g.
ternaryexpressions.listing 4uses ternaryexpressionstodecidetheframesizefordifferentandroid versions.
listing address evolution induced compatibility issues using ternary expression.
1layouthelper.createframe build.version.sdk int ?
2build.version.sdk int ?
localecontroller.isrtl ?
gravity.left gravity.right gravity.bottom 4localecontroller.isrtl ?
localecontroller.isrtl?
complicatedpatternsareusuallyappliedtoadaptacompletenew type.thesepatternsarerareinreal worldapps non existinthe10 appsweanalyze butverycommonintheandroidsupportlibrary.
forexample android.support.v4.view.viewcompat isatypeusedto adaptdifferentversionsoftype android.view.view .listing5shows the simplified code snippet.
it uses different inner types to wrap theapis fordistinctsdk versions lines2 then initializesthe static instance according to a particular sdk version lines .
finding the most common practice .
of usages checkstheunderlyingsdkversionbycomparingthevariablesdk int directly with a constant api level value.
wehavemanuallyinspectedallusagesofvariable sdk intin the apps in table .
there are usages in total in the source codes of the apps usages in external libraries excluded.
theusagepatternscanbeclassifiedinto3categories sdk intis authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
ase september montpellier france dongjie he lian li lei wang hengjie zheng guangwei li and jingling xue directlycomparedwithaconstantvalue andthecomparisonresult isusedinconditionsof ifstatements c1 thevalueof sdk int is propagated toother variablesappearing in ifconditions e.g.
via field stores and loads this is also a complicated pattern involving complex dependencies c2 control flow irrelevant usages like logprinting c3 .
listing complicated fixing strategy in viewcompat.
1public class viewcompat 2interface viewcompatimpl voidsetelevation view view floatelevation 5static class baseviewcompatimpl implements viewcompatimpl override public void setelevation view view floatelevation 10static class eclairmr1viewcompatimpl extendsbaseviewcompatimpl ... 11static class gbviewcompatimpl extendseclairmr1viewcompatimpl ... ...... 13static class kitkatviewcompatimpl extendsjbmr2viewcompatimpl ... 14static class lollipopviewcompatimpl extendskitkatviewcompatimpl public void setelevation view view floatelevation view.setelevation elevation ... 20static class api24viewcompatimpl extendsmarshmallowviewcompatimpl ... 21static final viewcompatimpl impl 22static final int version android.os.build.version.sdk int if buildcompat.isatleastn impl newapi24viewcompatimpl ...... else if version impl newlollipopviewcompatimpl ...... else impl newbaseviewcompatimpl 34public static void setelevation view view floatelevation impl.setelevation view elevation table4gives the usage counts of variable sdk int by categories.mostoftheusages .
arecontrolflow related columns and i.e.
the value of sdk intis used directly or indirectly in ifconditions.
in addition most usages .
adopt the simple commonpractice c1 i.e.
directlycomparevariable sdk int witha constant value to check the sdk version of the underlying system.
theapp org.telegram.messenger isanexception itstoresthevalue ofsdk int tostaticfield util.sdk int whichisthencheckedfor times.
there are also many statements in that app printing the valueofsdk int.fortheother9apps thepercentageofcontrol flow relatedusages columns2and3 andthepercentageofthe simplecommonpractice c1 column2only are97.
and95.
respectively.
answer to rq3 most evolution induced compatibility issue fixing patterns are very simple.
in particular the mostcommonpractice .
checks thesdkversionof the underlying system by directly comparing the variable sdk int with a constant value.table categorized usage counts of variable sdk int.
app name c1 c2 c3 org.telegram.messenger com.poupa.vinylmusicplayer org.glucosio.android 0com.amaze.filemanager 1im.vector.alpha 3com.github.axet.maps 4com.biglybt.android.client eu.kanade.tachiyomi org.bottiger.podcast 0es.usc.citius.servando.calendula incompatible api usage detection according to our findings .
of apps try to address evolutioninduced compatibility issues by checking the underlying sdk version in their implementation.
the developers need to use the right version of api on each supported sdk version.
however this processiserror proneandoftenleadstoincompatibleapiusages.a query ongoogle and stack overflowusing the keyword android nosuchmethoderror gives us results and topics respectively april17 .itisbecomingaprevalentproblem.however there are no tools to detect these issues precisely and effectively.
as a result many android apps are poorly tested .
android lint can be used to detect incompatible api usages.
however itisnotcommonlyusedbythedevelopersduetoitshigh false positive rates.
listing 6gives an example.
the api used on line9isintroducedintosdkafterlevel11 butthe minsdkversion issetto10.hence a java.lang.nosuchmethoderror exceptionwill be thrown crashing the app on sdk version .
for this example androidlintwillreporttwoissues online9andonline12 respectively.
the report on line is a false positive because lint does not apply inter procedural analysis and does not consider contextsensitivity.
in addition lint cannot detect incompatible api usages in external libraries leading to false negatives.
currently android development uses gradle as the automated building tool and apps rely heavily on external libraries.
listing example code snippet with incompatible api usage.
minsdkversion targetsdkversion .
2public class mainactivity extendsactivity 3privatetextview mview 4protected void oncreate bundle bundle ... if build.version.sdk int wrapper mview c s null i else mview.startdrag c s null i api1 11privatewrapper view v clipdata c ... v.startdraganddrop c s o i api2 .
detection method we develop a new inter procedural dataflow analysis to detect incompatible api usages.
definition .1gives the necessary and sufficient conditions for incompatible api usages.
definition .
.
for any app the use of an api is incompatible if and only if it satisfies the following three conditions authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
understanding and detecting evolution induced compatibility issues in android appsase september montpellier france thereexistsasdkversionwhoseapilevelislargerthan or equal to the declared minsdkversion value of the app.
the api is used by the app on that sdk version.
theapiisnotincludedinthesdkofthatparticularversion.
it istrivial to check thefirst and last conditions as implemented inandroidlint.thechallengeliesinhowtodeterminewhether an api is used or not on a given sdk version.
we formulate this challengeintoaclassicalinter proceduraldata flowanalysis which computes the set of reachable android versions for each api usage in a context sensitive manner.
we compute the set of reachable sdk versions at each program point for the app under evaluation.
at the entry point the set includesallsdkversionsdeclaredinthemanifestfileoftheapp e.g.
from minsdkversion to the largest level .
this set is updatedatprogrampointscheckingsdkversions.weconsiderthe common practice where the variable sdk int is directly compared toaconstantintegervalue finding7 andthecomparisonresult is used as conditions of ifstatements.
these ifstatements are referred to as checkpoint statements.
the set of reachable sdk versions in the true or false branch of the checkpoint statement areupdated accordingly.
equations 2give the data flow functions where chked iis defined according to the condition of checkpointstatements.forexample iftheconditionis sdk int thenchked i assuming minsdkversion is1 and chked i .
ini uniondisplay.
p pred i out p out i ini chked itrue branch of checkpoint statement ini chked ifalse branch of checkpoint statement ini otherwise.
for each usage of apii we check whether apiiis included in anyreachablesdkversionattheusagepointornot.ifnot abug is reported.
.
implementation apk issue reportchecker path tracerreporterbuild icfg ifds solversdk paths android .jar sdk android .jar android .jar sdk ...... ...... api available versions icfgicfg api use reachable versions figure the architecture of ictapifinder.
weimplementictapifinder incompatibleapiusagefinder in soot.
the tool detects incompatible api usages in android apps by analyzing the .apk file of an app directly.
... ... if build.version.sdk int wrapper mview c s null i else mview.startdrag c s null i private wrapper view v clipdata c ... v.startdraganddrop c s o i ... ... ... call flow return flownormal flow call to return flow figure6 illustrationexampletodetectincompatibleapiusages in listing .
figure5depictsthearchitectureofourimplementation.webuild theinter proceduralcontrolflowgraph icfg forandroidapps using soot s spark call graph construction algorithm .
the inter procedural data flow solver is implemented on top of heros acommonlyusedifdsframework .tocheckwhether agivenapiisincludedinaparticularsdkversionornot weuse doop a framework for points to analysis of java programs to extractapisfromsdk android.jar fileanduseadatalogengine logicblox to load api information for each sdk version.
previousworks extractsuchinformationfromasdkdocument called api versions.xml which is not as accurate .
next we give a brief description on how the ifds framework computes reachable sdk versions at each program point and how we detect incompatible api usages using an example.
.
.
ifdsframework.
ifdsisaclassicalcontext sensitiveinterproceduraldataflowanalysisframework.thisframeworkcanbe used to find precise solutions to a general class of inter procedural data flow analysis problems where the set of data flow facts dis a finite set and the data flow functions are distributive.
theifdsframeworkformulatesthedataflowanalysisproblem intoageneralgraphreachabilityproblemonasupergraphextended from icfg.
nodes are elements in the finite domain of data flowfacts and edges encode the semantics of transferring functions.
therearefourtypesofedges normal flowedgestopropagatedataflow facts within a procedural and call flow edges return flow edges andcall to return flowedgestopropagatedata flowfacts inter procedurally.asshowninfigure foreachprogrampoint in the icfg there is a set of nodes in the extended supergraph where each node represents an sdk version number at a program point.
edges connect nodes representing the same sdk version numberatsuccessiveprogrampoints topropagatethereachable sdk version to the next program point.
at a checkpoint statement c line6 anedgefromanodebefore candafter cexistsonlyifits correspondingsdkversionnumbersatisfiesthecheckedcondition.
an sdk version is reachable at a program point if there exists a pathfromtheentrytoitscorrespondingnodeofthesdkversion at that program point.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
ase september montpellier france dongjie he lian li lei wang hengjie zheng guangwei li and jingling xue .
.
detection example.
figure6shows how we detect incompatible api usages in the example in listing .
at the program point before line the reachable sdk versions are as declared in the manifest file.
line is a checkpoint statement.
according to equation the reachable sdk versions at line and line are and respectively.
line invokesthe wrappermethod.sothereachablesdkversionsatline are propagated to line along the call flow edges.
at the checking stage ictapifinder does not report the false positive in line since the api used on line exists in sdk versions according to the extracted information.
however theapiusedonline9doesnotexistinsdk10.hence ictapifinder reports an incompatible api usage bug on line .
evaluation in this section we evaluate ictapifinder using the total realworld open source android apps from f droid a popular opensource app store .
we do not test with the apps from androzoo since it will be difficult to verify the results without source code information.
all experiments are conducted on an intel r core tm i5 4590boxwith4cpucoresand16gbmemory.theunderlying os is ubuntu .
.
lts.
our evaluation aims to answer the following two research questions rq4 precision of ictapifinder can ictapifinder provide more precise detection results for apps developers?
rq5 usefulnessof ictapifinder canictapifinderhelp to detect unknown incompatible api usages in real world androidapps?canitprovideusefulinformationforapps developers to diagnose and fix incompatible api usage issues?
.
rq4 precision of ictapifinder 389apk num figure distribution of apps in f droid by incompatible api usage counts we apply ictapifinder to all apps using the latest version available in f droid i.e.
the total apps in f droid.
the apppl.hypeapp.endoscope 5 cannotbeprocessedbysoot .on average our tool processes an app in .
seconds.
the most timeconsumingappis com.nextcloud.client 30000399 whichtakes3 mintues and seconds to analyze.
figure 7shows the numberof incompatibleapi usages reported byour tool inthe total appsweanalyzed.ictapifinderfindsincompatibleapiusagesin .
of the total apps.
although the apps developers have made extensive efforts to address compatibility issues many apps still suffer from incompatible api usages.
werandomlyselect20outofthe361appswithincompatibleapi usage issues for manual inspection.
table 5lists the apps we choose.the app and version columnsgivetheirnamesandversions respectively.column4and5presentthenumberofincompatible api usages reported by android lint and ictapifinder respectively.
ictapifinder is sound in reporting incompatible api usages becauseofanover approximatestrategyusedbytheifdssolver.
hence itwillnevermissanyincompatibleapiusagebugs.however android lint often suffers from false negatives because it will skip processing sources with certain annotations e.g.
suppresslint targetapi .
in this experiment we remove these annotation tags for a fair comparison.
in addition lint does not process libraries thusoftenmissesincompatibleapiusagebugsinexternallibraries.
tominimizetheeffectofsuchkindoffalsenegatives weconservativelyaddallissuesreportedbyictapifinderinexternallibraries into that of lint.
bycomparingcolumn lintand ictapifinder wefindthat the issues reported by ictapifinder are significantly less than that of lint.
on average ictapifinder can effectively reduce the false positive rate of android lint by .
.
answer to rq4 in conclusion ictapifinder largely reduces the false positive rate of android lint by .
.
it processes an app within seconds on average.
.
rq5 usefulness of ictapifinder wehavemanuallycheckedallreportsgeneratedbyictapifinder forthe20appsintable .columns t pand f ppresentthe results.ictapifinderreports217issuesinthe20apps including71 falsepositives withafalsepositiverateof32.
.mostofthefalsepositivesareduetoimprecisionintheinter proceduralcontrol flow graph ouralgorithmsoundlyassumesthatallcomponentsinan apk are directly reachable from the entry without considering the complicated conditions to trigger a component.
aftermanualinspection webelievethat13appssufferfromreal incompatible api usages and have reported them to their original developers.
at present we have received confirmation from the developers of the apps com.vonglasow.michael.qz the 6th app com.xargsgrep.portknocker the 7th app com.zegoggles.smssync the9thapp and org.severalproject the16thapp .theseissues are color flagged in red in table .
the issues we reported in the appcom.zegoggles.smssync the 9th app are actually false positivessinceitappliesacomplicatedstrategytoaddressincompatible api usages which is not considered in our current implementation.
for the app it.feio.android.omninotes.foss the 12th app although we did not receive any confirmation from its developers directly the developers have added a development tag to our reports in their issue tracking system suggesting further action needed.
these issues are color flagged in orange in table .
the issueinjonas.tool.saveforoffline the14thapp iscolor flagged authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
understanding and detecting evolution induced compatibility issues in android appsase september montpellier france table effectiveness of ictapifinder over randomly selected apps id app version lint ictapifinder tp fp com.github.premnirmal.tickerwidget .
.
de.christinecoenen.code.zapp .
.
ca.rmen.android.networkmonitor .
.
com.easytarget.micopi .
.
com.prhlt.aemus.read4speechexperiments .
com.vonglasow.michael.qz .
com.xargsgrep.portknocker .
.
com.ymber.eleven .
com.zegoggles.smssync .
.
beta7 de.devmil.muzei.bingimageofthedayartsource .
de.kromke.andreas.unpopmusicplayerfree .
it.feio.android.omninotes.foss .
.
jackpal.androidterm .
.
rebuild jonas.tool.saveforoffline .
.
net.opendasharchive.openarchive.release .
.
alpha org.servalproject .
org.openintents.notepad .
.
org.sensors2.osc .
.
org.smssecure.smssecure .
.
unstable org.softeg.slartus.forpdaplus .
.
.
ingreenbecausewecansuccessfullytriggerthisbugandcrashthe app.
in the following we discuss some real incompatible api usages detected by our tool.
.
.
jonas.tool.saveforoffline.
this app the 14th app downloadswebpagesforoff linereading.its minsdkversion value is16.theappinvokestheapi android.webkit.websettings.setmediaplaybackrequiresusergesture whichisintroducedintosdkafter version .
we run this app on a galaxy s3 api level device rented from wetest .
the app directly crashed while browsingoff linepagesandthrewa java.lang.nosuchmethoderror exception.
.
.
com.xargsgrep.portknocker.
this app the 7th app is abasicportknockerclientandits minsdkversion valueis10.ituses theexternalcomponent com.ianhanniballake.localstorage.localstorageprovider whichisinheritedfromtheapi android.provider.
documentsprovider .
however this api is introduced since sdk version .
we reported the issues to the original developers and they confirmed them in a days.
the issues are fixed in revision 7f37522 byincreasingtheapp s minsdkversion to19.thiskind of incompatible api usages are very common since third party libraries are frequently used in apps.
it is also very difficult to avoidbythedevelopers.notethatandroidlintdoesnotprocess externallibraries.
ictapifindersuccessfullyfinds theseincompatible api usage issues demonstrating its effectiveness.
.
.
org.servalproject.
thisapp the16thapp alsocalled batphone providesfreeandsecurephone to phonevoicecalling smsandfilesharingoverwi fi withouttheneedforasimcardoracommercialmobiletelephonecarrier.thisapp s minsdkversion valueis8whileitusestheapi java.lang.string void string byte int int java.nio.charset.charset whichisaddedintosdksince level9.thedevelopersthankedusandfixedthisissueinrevision 05e784a byusing java.lang.string void string byte int int java.lang.string on sdk version .
theaboveexamplesshowthatictapifindercandetectcritical unknown incompatible api usage issues in real world android apps including these issues deeply hidden in external libraries.such issues are very common but hard to be detected by the developers and android lint.
to help with bug diagnosis and verification we also implement apathtracerwhichprovidesupto10possiblereachablepathsto thedevelopersforeachincompatibleapiusage.ourbugreports present the api usage the incompatible versions as well as the reachablepathswhichcouldhelpthedeveloperstoquicklydiagnose and fix incompatible api usages.
answer to rq5 ictapifinder is useful in detecting unknownincompatibleapiusages.wehavefoundnumerous realincompatibleapiusagesin13ofthe20appsmanually inspected whereissuesreportedin5appshavealready been confirmed or directly triggered.
it also demonstrates itseffectivenessbyreportingincompatibleapiusagesin externallibraries whicharecommonbutdifficulttofind bydevelopersandandroidlint.thereportofictapifinder includes detailed information such as reachable paths and incompatibleversions whichishelpfulfordevelopersto quickly diagnose and fix the reported issues.
discussions .
threats to validity subjectselection.
thevalidityofourempiricalstudyresultsmay be subject to the threat that we only manually inspect android appsassubjectsinanalyzingevolution inducedcompatibilityissuesfixingpatterns.however these10appsareselectedfrom1 candidateappsfromf droidastheycontainthemostnumberof fixingpracticestoaddressevolution inducedcompatibilityissues with a total number of usages of the variable sdk int.
more importantly the findings obtained from studying these apps have been proven to be useful in detecting unknown incompatible api usages in real world apps.
errors in manual inspection.
our study may suffer from errorsinmanuallyanalyzingcodesnippetswhichusesvariable sdk int toaddressevolution inducedcompatibilityissues.toreducethis authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
ase september montpellier france dongjie he lian li lei wang hengjie zheng guangwei li and jingling xue threat we follow the widely adopted cross validating method to ensure the correctness of our results.
assumptions.
in our empirical study we make two assumptions.
the first assumption is that usages of variable sdk intall addressevolution inducedcompatibilityissues.inpractice there also exist other usages such as log printing.
ho wever these usages onlyaccountforlessthan11.
ofthetotalusagesinourstudy.
another assumption is that a new api is supported by the android supportlibraryifitisusedinthesupportlibrary.thisisaconservative assumption since there are also normal usages of the api.
the api support ratio provided by the android support library will be even lower.
hence it does not affect our conclusion that the support from the android support library is insufficient.
android os evolution.
the last threat may come from the strategy of android evolution.
all our empirical findings are based oncurrentmajorandroidversions.however androidisafastevolving system and many os versions will be gradually phased out.
there may be significant changes in the android ecosystem to address evolution induced compatibility issues.
we cannot guarantee that our findings still hold in the remote future.
.
further reduce false positives in our empirical study we have classified the usages of sdk int intothreecategories.ictapifinderonlyconsidersthemostcommon practice c1 .therearealsocomplicatedcaseswhichrequireprecise pointer analysis to track dependencies of variable sdk int or complicated fixing strategies as in list .
we plan to address these issues in our future work.
most of the false positives are due to the imprecision of our inter proceduralcontrolflowgraph icfg .currently theicfgwe use is actually same as the one in flowdroid which conservatively assumes that all components in android apps are directly reachablefromtheentrypoint withoutconsideringthecomplex control flows to trigger a component.
however this is not true.for example some activity can only be reached after the call to startactivityforresult .
hence a more precise icfg which is required to further reduce false positives.
in general it requires controlflowspecialization andreflectionanalysis to build the precise icfg.
related work to the best of our knowledge we are the first to quantify android evolution inducedcompatibilityissueswithdatafromalargebodyofrealandroidappsandprovidetooltodetecttheseissues.existing work have studied the general android api evolution problem and fragment induced compatibility issues.
android api evolution.
the maintenance of mobile applications remains to be largely undiscovered in the software maintenance field .
api evolution is a frequently research topic in this area.mcdonnelletal.
haveperformedanempiricalstudyon apistabilityandadoptioninandroid inwhichtheyshowedthat android is rapidly evolving at a rate of averagely api updates permonth.however comparedtothefastevolvingapis ittakes much longer time on average to adopt new versions in android apps.
linares et al.
have shown that android api changes willtriggermorestackoverflowdiscussions.work and investigated the relationship between the popularity of android apps and the sdk api changes.
their empirical study pointed out that morepopular androidapps generally tendto useapis thatare less change prone.
the above works are helpful in learning evolution inducedcompatibilityissues.thispaperextendsexisting worksbyshowingtherootcausesandquantifyingtheseverityof evolution induced compatibility issues in real android apps.
our findings facilitate effective detection and diagnose of evolutioninduced compatibility issues in practice.
android compatibility issues.
android fragmentation also causes portability and compatibility issues within the entire an droid ecosystem .
a few recent works have been trying to address these fragmentation induced compatibility issues.
ham et al.
proposed adevice api level check method.their methodrecordsthetestresultsofandroidapiforeachdevicein a pre stored database which is then used to check api usage information and detect compatibility issues.wei et al.
manually extract api usage information referred to as api context pair from existing compatibility issues and use such information to detectfragmentation inducedcompatibilityissues.thelatestwork cid detectsevolution inducedcompatibilityissuesbybuilding a so called conditional call graph which is not context sensitive.
this paper targets evolution induced compatibility issues and we applyacontext sensitivedata flowanalysistoautomaticallydetect incompatibility issues without manual annotation.
conclusion and future work this paper conducts an extensive empirical study on evolutioninducedcompatibilityissuesinandroidapps.ourstudiesdiscoverthefollowinginterestingfindings theandroidsupportlibraryprovides support for less than of the new apis in each release andmostapps .
needtoaddressevolution inducedcompatibilityissuesintheirimplementation.themostcommonpractice .
adoptsasimplecodepattern.thesefindingsarehelpfor future research on this topic.
basedonourfindings wedevelopictapifinder whichdetects incompatible api usage issues in android apps based on interproceduraldata flowanalysis.ictapifinderdetectsincompatible api usage issues on apps out of the apps we tested.
it issoundandcaneffectivelyreducethefalsepositivesofandroid lint by .
.
inthefuture weplantoautomaticallyverifythebugsictapifinder detected.
we also plan to give useful fixing suggestions to developers by mining equivalent apis on different android sdks.
acknowledgement thisworkissupportedbytheinnovationresearchgroupofnationalnaturalsciencefoundationofchina 61521092and61672492 the national key research and development program of china 2016yfb1000402and2017yfb0202002 thenationalnaturalsciencefoundationofchina u1736208 andaustraliaresearchcouncil grants dp170103956 .