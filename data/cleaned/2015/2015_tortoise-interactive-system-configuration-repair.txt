tortoise interactive system configuration repair aaron weiss northeastern university boston ma usa weiss ccs.neu.eduarjun guha y uriy brun university of massachusetts amherst amherst ma usa arjun brun cs.umass.edu abstract system configuration languages provide powerful abstractions that simplify managing large scale networked systems.
thousands of organizations now use configuration languages such as puppet.
however specifications written in con figuration languages can have bugs and the shell remains the simplest way to debug a misconfigured system.
unfortunately it is unsafe to use the shell to fix problems when a system con figuration language is in use a fix applied from the shell may cause the system to drift from the state specified by the configuration language.
thus despite their advantages configurationlanguages force system administrators to give up the simplicity and familiarity of the shell.
this paper presents a synthesis based technique that allows administrators to use configuration languages and the shell in har mony.
administrators can fix errors using the shell and the technique automatically repairs the higher level specification written in the configuration language.
the approach produces repairsthat are consistent with the fix made using the shell produces repairs that are maintainable by minimizing edits made to the original specification ranks and presents multiple repairs when relevant and supports all shells the administrator maywish to use.
we implement our technique for puppet a widely used system configuration language and evaluate it on a suite of benchmarks under repair scenarios.
the top ranked repair is selected by humans of the time and the human equivalentrepair is ranked .
on average.
i. i ntroduction modern computing systems are large complex and need to be reconfigured frequently to address changing threats and requirements.
the job of a system administrator is to perform these tasks.
for example if a web server is under attack she may reconfigure a firewall if a new security patch is available she may deploy it if an intrusion detection system is needed she may set it up and ensure it does not interfere withnormal operations.
system administration is a difficult task and the majority of large organizations use system configuration languages to make the job easier.
for example puppet is deployed at over companies chef has over million downloads and ansible was quickly bought by red hat a few years after its release.
unfortunately updating system configurations is a surprisingly difficult task and several recent high profile computing failures have been caused by configuration updates gone wrong.
for example in some google app engine customers suffered a two hour service outage due to a configuration error that was triggered during an application server update .
in the new y ork stock exchange suffered an outage that halted trading for four hours because a software update wentawry .
in facebook suffered a .
hour outage that was again caused by a faulty configuration update .
in that incident a system for verifying system configurations actually exacerbated the problem.
this paper focuses on puppet the most widely deployed system configuration language but our work generalizes to other configuration languages see section viii .
puppetconfigurations known as manifests have the following key features.
first manifests are declarative parameterizable and support modular composition.
for example puppet has an online repository of nearly community supported manifests.
second manifests make systems reproducible.
for example if a new web server is needed a system administrator can quickly set it up if she already has a web server manifest.finally manifests support centralized management.
puppet uses a client server model where all manifests are maintained on a centralized server and propagated to client machines.
manifests may have bugs and even bug free manifests need to be updated to address changing requirements.
however there are many cases where manifests make changes harder toapply than they should be.
a small change such as creating a new user adding a firewall rule or starting a service is easy to perform with the command line shell using commands suchas useradd iptables and service that are familiar to administrators.
the shell also lets the administrator explore the state of the system and unlike a manifest typically provides immediate feedback when the administrator makes a mistake.
by contrast editing a manifest is much harder.
first in a large manifest that uses high level user defined abstractions it can be difficult to find where and how an update should be made.
second the only way to test an update is to redeploy it which can take anywhere from minutes to hours.
finally an update may have unintended effects especially if the update is in a function that is called from multiple contexts.
the natural solution to this problem is to use a manifest and the shell simultaneously.
for example a manifest could specify the state of the machine while small updates are made using the shell.
unfortunately it is not safe to make changes from the shell when a manifest is in use because the actual state of the system will no longer match the state specified in the manifest a phenomenon known as configuration drift.
our approach.
we present a new approach to repairing system configurations called imperative configuration repair which bridges the gap between the shell and system configuration lan978 .
c circlecopyrt2017 ieeease urbana champaign il usa t echnical research625 authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
manifest buggy shell commands to fix machine soft constraintshard constraints smt formula solutions ranked list of patches to input manifestconstraint generator smt solver patch generatortortoise fig.
the user deploys a buggy puppet manifest and uses the shell to fix the machine state.
tortoise automatically produces a ranked list of manifest repairs that preserve the changes made in the shell.
guages.
imperative configuration repair is a program synthesisbased technique that allows a manifest to be automatically repaired given a sequence of shell commands to guide the desired system state.
therefore instead of running the risk of configuration drift we allow system administrators to use a familiar shell to fix errors with the confidence that the mani fest will be updated automatically.
our approach has several important properties our repair procedure is consistent the synthesized repair is guaranteed to preserve all changes made in the shell that are within the scope of the system model so there is no configuration drift.
our repair procedure preserves the structure and abstractions in the manifest.
therefore we synthesize maintainable patches.
when multiple consistent repairs exist we rank them and present several alternatives in a comprehensible manner.
our approach places no restrictions on how the shell is used and works with allexisting shells.
we have implemented our approach in a tool called tortoise which is outlined in figure and works as follows suppose the administrator needs to update a machinethat is managed by a puppet manifest.
tortoise allowsher to directly update the machine using ordinary shellcommands.
behind the scenes tortoise uses ptrace to record all system calls and file system changes made from the shell.
when she is done tortoise builds a model of the original manifest and the updates from the shell in a languagecalled p. the model treats the shell updates as hard constraints and the original manifest as soft constraints.
tortoise translates the p model into logical formulae for1package apache2 ensure present 3service apache2 ensure running 5file etc apache2 sites enabled piedpiper.conf 6content virtualhost 7documentroot var sites piedpiper virtualhost 10file var sites piedpiper ensure directory source puppet sites piedpiper owner root mode recurse remote 17package service 19package file 21file service fig.
managing a single website.
an smt solver specifically z3 str .
these formulae produce queries which we solve using cegis .
tortoise interprets each solution produced by the smt solver as a patch to the puppet manifest ranks the patches in an intuitive way and presents the most likely patches to the user.
finally the user selects the patch she wishes to apply.
although different patches have different effects tortoise guarantees that all patches are consistent and preserve the changes that the user made from the shell in step .
we evaluate tortoise on an existing suite of puppet manifests .
we identify a total of scenarios where the manifests would need repair.
however instead of repairing the manifests directly as a system administrator would normally have to do we directly update the system using the shell and use tortoise to synthesize the repair to the manifest.
the highest rank repair tortoise synthesized was the correct repair of the time and the correct repair was in the top five tortoise synthesized repairs of the time.
tortoise and our benchmarks are available at the rest of this paper is organized as follows.
section ii motivates our approach with an example.
section iii details tortoise s expressiveness.
section iv presents the p language and describes the translation from puppet manifests and system call traces to p. section v describes how tortoise converts p constraints to logical formulae for an smt solver how models returned by the solver are interpreted as repairs and how these repairs are ranked.
section vi evaluates tortoiseand section vii summarizes our work s limitations.
finally section viii discusses related work and section ix concludes.
ii.
a c onfigura tion repair scenario to motivate the need for imperative configuration repair we first present a simple manifest that sets up a web server figure .
this manifest has a bug and we describe how a system administrator would find and fix the bug using the shell and then how tortoise automatically synthesizes the repair to the manifest by observing the administrator s shell commands.
a manifest is a declarative specification of the expected system configuration.
a manifest specifies a set of resources their state and their interdependencies.
each resource consists authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
of a type for example package file o rservice a title interpreted based on the type for example the title of a file is the path of the file whereas the title of a package is the name of the package and a dictionary of attributes to configure the resource such as specifying that a package should be present or absent or that a file refers to a directory.
figure shows a manifest with four resources the apache2 package which must be present on the system the apache2 service which must be running the filepiedpiper.conf that sets up and the directory containing the site s files which are copied from the puppet master server indicated by the puppet prefix .
the manifest also specifies three dependencies the apache2 package must be installed before the service the apache2 package must be installed before piedpiper.conf is created and the apache2 service is notified restarted when piedpiper.conf changes.
this manifest will successfully deploy but that does not guarantee that the resulting system configuration is correct.
in fact the manifest in figure has a bug if we visit www.
piedpiper.com we will get an http forbidden error.
repairing the configuration in the shell.
when the system administrator discovers this problem she considers that a error may either indicate that the client does not have permission to access the requested resource or that the server is misconfigured and cannot access a needed file.
for security reasons the server does not send a detailed error message to the client.
therefore the only way to debug the problemis to inspect the web server log.
the administrator runs the following command tail var log apache2 error.log the log contains the line permission denied which indicates that the permissions on the site directory may be incorrect.
to investigate this the administrator now runs the following command stat var sites piedpiper the result of this command returns the directory s owner which isroot and its permissions which is .
this indicates that the directory is not readable by others including website visitors.
the fix is to make the directory readable by all chmod var sites piedpiper now the administrator can refresh the page and verify that the error is fixed.
unfortunately the state of the machine has now drifted from state specified in the manifest.
using this manifest to configure a second web server will lead to the same problem and the administrator will have to manually apply the same fix.
worse puppet itself will undo the fix on this server!
any changes to the manifest e.g.
to install more software will cause puppet to re apply all resources and revert the permissions back to their original broken state.
when using puppet it is safe to perform read only actions to explore the machine state using the shell e.g.
to view logs or inspect permissions.
however it is unsafe to use the shell to perform updates.1package apache2 ensure present 2service apache2 ensure running 4define website title root 5file etc apache2 sites enabled title.conf content virtualhost title documentroot var sites root virtualhost file var sites root ensure directory source puppet sites root owner root mode recurse remote 18website root piedpiper 19website piperchat.com root piperchat fig.
a website abstraction.
for exposition the inter resource dependencies are elided.
tortoise solution.
tortoise allows the administrator to fix the bug using the shell without the risk of configuration drift.
to do so tortoise first translates the manifest into a program written in p that models all the effects that the manifest has on the file system.
the model is lengthy but only a small fragment is relevant to this repair 1rlet title etc sites piedpiper from str 2rlet mode from int ... 4chmod title mode the code uses the chmod command to set the mode.
however instead of using constants for the mode and the directory name the command refers to the repairable variables on the first two lines.
each repairable variable specifies an original value and arepair space of alternate values.
for example on line the original mode is but can be repaired to any bit integer if needed.
after producing this model tortoise translates the observed system calls issued by the shell into an assertion also expressed in p. in this case the assertion is as follows 5assert mode var sites piedpiper the only way for this assertion to hold is if the value of mode is repaired to and the value of title is left unchanged.
this repair to the p model corresponds to changing line of figure to mode .
this is exactly the change the administrator would have made herself.
however in more sophisticated manifests there may be several alternative repairs that tortoise ranks and presents to the user as patches.
user defined abstractions in puppet.
we now consider a more sophisticated example manifest that uses puppet s abstractions to manage a second website piperchat.com.
the na ve approach is to duplicate and tweak the configuration for piedpiper.com.
but a better approach is to create a custom website type known as a defined type in puppet for managing a website that is parameterized by the domain nameand site directory.
this custom type allows websites to be configured with just one line each lines and in figure .
suppose the system administrator built this abstraction before fixing the permissions problem thus both websites produce the same error.
she discovers the error by visiting piedpiper.com as she did earlier witnesses the error and then uses the shell to diagnose and fix the problem as before using the chmod command.
without tortoise there are two problems authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
1define website title root https false 2if https ... lots of configuration ... 3else ... same as before ... fig.
optional support for https.
the configuration has drifted from the manifest as before and the other website remains broken.
tortoise solution.
there are two ways to correct the manifest to be consistent with the system state change line to be consistent with the shell and affect both websites mode change line to be exactly consistent with the shell and leave the other website unaffected title piperchat ?
there are situations where either type of repair may be desired.
the first repair generalizes a change made to one instance to all instances of the same type whereas the second kind of repair is necessary to specify special case behavior.
in general tortoise cannot know which kind of repair is desired so it presents both repairs to the administrator.
since special cases are the exception tortoise ranks the repairs in the order shown above.
notice that both repairs update a line of code that is within a defined type so tortoise is not limited to working with puppet s built in abstractions.
reusing abstractions.
tortoise can also repair resources that instantiate user defined types as the next example shows.
suppose the administrator wants to start using https to secure websites.
modern web browsers block https servers from loading javascript from unsecured domains.
therefore sites need to be carefully upgraded to ensure that all third party code is served over https too.
for this reason it makes sense to migrate one website at a time.
the process of upgrading to https involves specifying the certificate private chain ciphers and several other details that are difficult to get right the first time.
moreover there is a risk that a faulty edit to the website type will inadvertently break the other website too.
therefore it is safer to directly edit the apache configuration file for instead.
apache has a command line tool to catch syntax errors apachectl configtest that the administrator may use for this task.
once the server is workingcorrectly the administrator can abstract the changes to make it easier to migrate other servers by adding an optional https parameter to the website type as sketched in figure .
however the configuration has again drifted from the manifest.
in this case tortoise detects that the configuration forpiedpiper.com is a concrete instance of the abstraction and automatically adds the https attribute website root piedpiper https true this repair is notable because it repairs an instantiation of a type that is not built in to puppet.
summary.
we have presented three ways in which tortoise allows a system administrator to use puppet and a shell in1file filea content test 3define t x prefix 4if prefix file dir x content test 6else file x content test 9t x fileb prefix true 10t x filec prefix true fig.
repair example.
harmony benefiting from the unique strengths of each tool.
in all cases tortoise synthesizes maintainable patches and ensures that no configuration drift occurs.
iii.
t hetortoise repair space puppet s own linting tools can help administrators fix syntax errors and type errors.
however there are three more waysin which a manifest may need to change.
tortoise helps administrators make the third type of change listed below.
adding removing or modifying dependencies.
the dependencies in a manifest impose a partial ordering on resources.
although puppet automatically inserts certaindependencies auto requires others need to be specified explicitly by the administrator.
missing dependencies can cause a manifest to raise an error during deployment.
tortoise does not correct dependency errors but this is the subject our prior work .
creating new abstractions.
a powerful feature of puppet is its ability to create new abstractions defined types and classes to make manifests modular and reusable.
for example in section ii we created a website abstraction to help manage a website.
tortoise does not help the user create new abstractions.
however given a manifest that has user defined abstractions tortoise can perform repairs within them.
creating deleting and updating resources.
tortoise supports repairs that involve deleting resources and creating new resources including instances of user defined abstractions.
in addition tortoise supports repairs thatinvolve creating deleting and modifying attributes of existing resources as detailed next.
the rest of this section gives examples of tortoise supported repairs.
we describe individual repairs in isolation but a singlerepair may involve several repairs of the kind illustrated below.
a. supported repairs the most significant class of repairs that tortoise performs involves adding removing and updating attributes on existing resources.
puppet has dozens of resource types and each type has several attributes that can dramatically change how theresource is interpreted.
what makes tortoise powerful is its ability to correct the attributes of both built in and user defined resources.
to illustrate this we use the manifest in figure which has one defined type t and creates three files.
it creates filea directly but uses the type tto create dir fileb and dir filec .
an interesting feature of tis that it checks to see if the prefix attribute is set and if it is it builds a filename using string interpolation.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
add new attribute.
tortoise can add new constant valued attributes to a resource.
for example in figure if the administrator uses the shell to change the owner of filea to alice tortoise will add the attribute owner alice to the corresponding resource.
if she instead changes the owner of dir fileb toalice then tortoise suggests two possible changes in order add an attribute on line that affects filec too owner alice change line to create a special case for fileb which does not affect filec title fileb ?
owner alice owner root delete existing attribute.
tortoise can also delete attributes.
for example if the administrator changes the owner of filea back to root it will suggest removing the owner attribute.
update existing constant.
in section ii we saw that tortoise can update the value of constants in attributes.
the same mechanism allows tortoise to update attribute titles.
for example renaming filea to filea2 causes tortoise to update the manifest to refer to the new file line of figure .
a harder repair involves renaming the files that are created in directly by the defined type.
for example we could rename dir fileb in three ways if renaming the file part e.g.
to dir fileb2 the repair is in the instantiation of t line .
if renaming the directory part e.g.
to dir2 fileb the repair is in the definition of t line .
if renaming both e.g.
to dir2 fileb2 the repair must affect both locations.
tortoise supports all three repairs.
create and delete resource.
tortoise can create and delete resources.
for example if the user deletes filea tortoise suggests removing line from the manifest.
on the other hand if the user creates a new file dir filed with the same content specified in the definition of t tortoise suggests two fixes create a new file or create a new tresource.
b. repair consistency a key property of tortoise is that it produces consistent repairs a repair is guaranteed to preserve all changes made using the shell that are within the scope of tortoise s system model.
section iv presents this model in detail but at a highlevel we model certain essential properties of regular files anddirectories such as their contents and permissions.
in contrast tortoise does not support repairs that affect running processes or special files such as the proc file system.
for example many changes to the proc file system are lost after reboot but can be persisted by editing certain configuration files in the etc directory.
these kinds of repairs are straightforward in principle but would require a lot of engineering.
iv .
f rom manifests and shell commands to p section iv a introduces our modeling language p that provides a uniform way to model the semantics of manifests theatomic expressions a str string bool boolean n integer undef undefined x v ariable reference expressions e a file?
a test ifarefers to a file dir?
a test ifarefers to a directory exists?
a test ifarefers to a file or directory defined?
a test if not undef e1 e2 string concatenation comparisons and boolean connectives statements c letx e v ariable declaration if e c1elsec2conditional c1 cn block statement chmod e e2 set permissions of e1toe2 chown e e2 set owner of e1toe2 mkdir e create directory write e e2 create file e1with contents e2 other file system operations rletx afromrletxbea but can be repaired to r assert e assertion repair spaces r finite set of alternatives str any string or undef int n anyn bit number or undef fig.
p syntax constraints generated from shell commands and the space of possible repairs.
sections iv b and iv c describe primitive and user defined resources.
section iv d describes how we model repairs that create and delete resources.
finally section iv e details how manifests and shell commands are translated to p. section v will describe translating p into formulae for an smt solver.
while it is possible to directly translate manifests and shell commands into constraints using p has two advantages it is much easier to model the semantics of manifests in p since it has imperative file system operations and we can simplify p programs before generating constraints which makes constraint solving scalable.
a. the p modeling language p is an imperative language with primitive operations that manipulate files so it allows us to model the side effects that resources have on system state.
in addition it has two features that facilitate repair it has repairable variable declarations which are ordinary variables that are augmented with a repair space of alternate values and it has assertions which we use to constrain repair spaces.
intuitively a single p program with repairable variables represents a space of possible programs ranked by the number and kinds of repairs made.
the key to our approach is to translate manifests to p programs with repairable variables and to turn shell commandsinto p assertions that rule out programs that are not consistent with the user s repair.
file system operations.
figure shows the syntax of p which consists of statements expressions atomic expressions and repair spaces.
atomic expressions include constants and variable