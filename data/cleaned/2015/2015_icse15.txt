detecting inconsistencies in javascript mvc applications frolin s. ocariza jr. karthik pattabiraman ali mesbah university of british columbia vancouver bc canada ffrolino karthikp amesbah g ece.ubc.ca abstract higher demands for more reliable and maintainable javascript based web applications have led to the recent development of mvc model view controller frameworks.
one of the main advantages of using these frameworks is that they abstract out dom api method calls which are one of the leading causes of web application faults due to their often complicated interaction patterns.
however mvc frameworks are susceptible to inconsistencies between the identifiers and types of variables and functions used throughout the application.
in response to this problem we introduce a formal consistency model for web applications made using mvc frameworks.
we propose an approach called a urebesh that automatically detects inconsistencies in such applications.
we evaluate a urebesh by conducting a fault injection experiment and by running it on real applications.
our results show that a urebesh is accurate with an overall recall of .
and a precision of .
it is also useful in detecting bugs allowing us to find real world bugs in applications built on angularjs a popular mvc framework.
i. i ntroduction with the usage of client side javascript in web applications becoming more and more ubiquitous there is increasing demand to write javascript code that is reliable and maintainable.
in an empirical study we analyzed over bug reports to learn what specific characteristics javascript faults possess i.e.
their root cause impact and propagation .
we found that the majority of reported javascript faults are domrelated meaning the error leading to the fault propagates into the parameter value of a dom api method call.1such faults often result from a developer s incomplete or erroneous understanding of the relationship between the javascript code and the dom leading to inconsistent interactions between these two entities thereby causing failures.
partly in response to these issues javascript libraries known asmvc frameworks have recently been developed.
mvc frameworks such as angularjs backbonejs and ember.js use the well known model view controller mvc pattern to simplify javascript development in a way that abstracts out dom method calls.
this is accomplished by giving programmers the ability to define model objects which are then directly embedded in the html code typically via a double curly brace notation such that any changes in these objects values will automatically be reflected in the dom 1dom stands for document object model which is a data structure used to represent the hierarchy of html elements in the webpage and their properties.and vice versa a process known as two way data binding .
the frameworks thus eliminate the need for web programmers to explicitly set up dom interactions in javascript.
unfortunately despite the apparent advantages mvc frameworks are still susceptible to consistency issues akin to dom javascript interactions .
in particular these frameworks rely on the use of identifiers to represent model objects and controller methods definitions and uses of these identifiers are expected to be consistent across associated models views and controllers.
moreover due to javascript s loose typing which is retained in these mvc frameworks the programmer must ensure that the values assigned to model objects and returned by controller methods are consistent with their expected types depending on how they are used.
since model objects and controller methods are primarily used to represent major functionalities of the web application any inconsistencies between these identifiers and types can potentially lead to a significant loss in functionality hence avoiding these inconsistencies is crucial.
in addition these inconsistencies are often difficult to detect because multiple model view controller groupings exist in the application and no exceptions are thrown or warnings provided in the event of an inconsistency.
to tackle this problem we introduce an approach to automatically detect inconsistencies between identifiers in web applications developed using javascript mvc frameworks.
our design conducts static analysis to separate the three main components model view and controller in these applications find the identifiers defined or used in these components infer the types associated with these identifiers and compare the collected identifiers and type information to determine any inconsistencies.
we implement our approach in a tool called aurebesh which finds inconsistencies in angularjs applications the most popular javascript mvc framework used in practice.
since mvc frameworks for javascript are fairly new few papers have explored their characteristics.
for the most part prior work in this area does not include observations on the properties of existing mvc frameworks but rather proposes new mvc frameworks fitted towards a specific goal .
other papers analyse existing javascript mvc frameworks with particular focus on their maintainability .
to the best of our knowledge our paper is the first to identify the consistency issues in javascript applicationsusing mvc frameworks 2and the first to propose a design for automatically detecting inconsistencies in such applications.
we list the following as our main contributions we identify consistency issues pertinent to identifiers and types that are present in javascript mvc applications.
these consistency issues point to potential problems within the application we devise a general formal model for mvc applications.
this model helps us reason about the way variables and functions are used and defined throughout the application which in turn allows us to more clearly define what constitutes an inconsistency among them in the application we introduce an automatic approach to detect identifier and type inconsistencies in mvc applications.
this approach uses static analysis and only requires the application s client side source code we implement our design in an open source tool called aurebesh which works for angularjs applications and we perform a systematic fault injection experiment on aurebesh to test its accuracy and we subject a urebesh to real world applications to assess its ability to find real bugs.
we find that a urebesh is accurate .
recall and precision and can find bugs in real mvc applications bugs in applications five of which were acknowledged by the developers .
ii.
r unning example the traditional application of mvc in web applications is to provide a clear separation between the application data and the html output that represents them on the server side.
recent javascript mvc frameworks represent the next logical step i.e.
applying the mvc model to the client side to separate javascript i.e.
data and controls from the dom i.e.
the output .
some popular mvc frameworks include angularjs backbonejs and ember.js.
of these angularjs is the most widely used with four times as many third party modules and github contributors and over times as many chrome extension users compared to the closest competitor backbonejs.
interest in angularjs has also increased significantly since with around questions in stackoverflow and related youtube videos.
this is more than the corresponding items for the other two frameworks combined.
for these reasons we focus on angularjs in this work.
we introduce the running example that we will be using throughout the paper.
this example is inspired by realworld bugs encountered by developers of angularjs applications .
the application which we will refer to as moviesearch initially takes the user to the search page figure where the user can input the name of a user via theinput element.
clicking on the list user s favourite movies button leads to the results page figure which displays the list of movies that corresponds to the user name 2for simplicity we will refer to such applications as mvc applications or javascript mvc applications .
input type text ng model username placeholder type username button ng click searchuser list user s favourite movies button fig.
.
html code of the search view search.html h3ng if userdata.display userdata.intro h3 ul ling repeat movie in userdata movie.name li ul div id moviecount ng pluralize count userdata.count when movieforms ng pluralize div br button ng click alertusername which user?
button fig.
.
html code of the results view results.html that has been input as well as the number of movies in the list.
in addition clicking on the which user?
button in the results page would display the current user name in an alert box for example if the user name is countsolo the alert would display the message the user is countsolo .
the code for this application contains two views one corresponding to the search page figure and the other corresponding to the results page figure implemented in html.
it also contains two models and two controllers implemented in javascript shown in figure .
an mvc application consists of model variables controller functions and groupings .
figure shows how model variables and controller functions are defined and used in relation to the models views and controllers.
it also shows how these models views and controllers form groupings.
model variables.
model variables refer to the objects where the model data is stored and are represented by identifiers defined within the scope of a particular model.
these model variables are defined in models and are used either polled or updated by associated views and controllers.
for instance thesearch model in the running example defines one model variable namely username figure line further the associated controller searchctrl and view search.html use this same variable in figure line and figure line respectively.
similarly the results model figure lines contains two model variables userdata andmovieforms these are used by the associated view results.html in various lines in figure .
controller functions.
controller functions as the name suggests are functions defined in the controller.
these controller functions are used in the view by attaching the function as an event handler to a view element.
as an example the searchctrl controller in figure lines defines one controller function searchuser which is subsequently used in the corresponding view search.html by setting it as1var searchapp angular.module searchapp 2searchapp.controller searchctrl function scope location model search scope.username controller searchctrl scope.searchuser function var id getuserid scope.username if id location.path results id 15searchapp.controller resultsctrl function scope routeparams model results scope.userdata movielist getlist routeparams.userid intro welcome user routeparams.userid display true count two scope.movieforms one movie other movies controller resultsctrl scope.
alertusername function alert the user is scope.username fig.
.
javascript code of the models and controllers 1searchapp.config function routeprovider routeprovider .when controller searchctrl templateurl search.html .when results userid controller resultsctrl templateurl results.html .otherwise redirectto fig.
.
javascript code of the routes the event handler of a button figure line .
also the resultsctrl controller in figure lines defines the controller function alertusername which is used in the corresponding view results.html in figure line .
groupings.
due to the dynamic property of web applications an mvc application can consist of multiple models views and controllers hence the programmer must specify which of these models views and controllers are associated with each other.
current mvc frameworks allow the programmer to specify these model view controller groupings by embedding the name of the model and controller in the view.
these groupings can also be specified using routers as in the case of the running example figure which links the search model andsearchctrl controller with the search.html view lines and the results model and resultsctrl controller with the results.html view lines .
model variablescontroller functionsm2modelsv2viewsc2controllersm1v1c1v3fig.
.
block diagram of the def use and grouping model for mvc framework identifiers.
solid arrows indicate a defines relation while dashed arrows indicate a uses relation.
models views and controllers connected with the same line types form a grouping.
iii.
c onsistency issues we now describe two types of consistency issues observed in mvc applications namely identifier consistency andtype consistency .
we focus on these issues in this paper.
identifier consistency.
model variables and controller functions are represented by identifiers in mvc applications.
these identifiers are written both in the javascript code when they are defined or used in the model or controller and in the html code when they are used in the view.
to ensure correct operation model variable identifiers used in the controller or view must be defined in the model and controller function identifiers used in the view must be defined in the controller .
while this seems straightforward to enforce at first sight the following factors complicate the process of maintaining this consistency.
an identifier is repeatedly used in both the html code and the javascript code.
even though dom interactions are abstracted out by mvc frameworks this repeated usage of identifiers across separate languages makes the application susceptible to identifier inconsistencies.
further the common practice of implementing models views and controllers in separate files sometimes maintained by separate programmers in collaborative projects increases the chances of such inconsistencies.
an application typically contains multiple models views and controllers grouped together.
hence the programmer must ensure the consistency not just of one model view controller grouping but of several groupings.
also these groupings must be set up correctly e.g.
via the routers or else an inconsistency may occur.
for instance the moviesearch application contains two identifier inconsistencies.
first the resultsctrl controller uses the model variable identifier username in figure line but this identifier is not defined in the results model it is only defined in the search model which is not grouped with resultsctrl this causes the alert box to display the user is undefined after clicking on the which user?
button.
second since the lielement in the results.html view loops over the userdata model variable figure lines instead ofuserdata.movielist the reference to movie.name infigure line will be undefined with respect to the results model this causes blank bullet points to be displayed.
type consistency.
in many cases the programmer will also need to ensure that the value that is assigned to a model variable or the value returned by a controller function has a type consistent with that variable or function s use in the view.
for example in angularjs the ng if attribute in the view must be assigned a boolean value a type inconsistency occurs if a model variable that contains a non boolean value or a controller function that returns a non boolean value is attached to the attribute.
ensuring this consistency is complicated by the fact that javascript is a loosely typed language.
moviesearch contains one such type inconsistency.
in figure line the userdata.count model variable is attached to the count attribute which expects to be assigned a value of type number however userdata.count is assigned a string in the corresponding results model figure line .
this leads to the disappearance of the message that shows the number of movies inside the div element with idmoviecount in figure .
iv.
f ormal model of mvc a pplications we propose a more formal abstract model for mvc based web applications to clearly delineate all the consistency properties of such applications.
this model also helps us describe our approach for automatically detecting inconsistencies.
definition mvc application .anmvc application is a tuple m v c w g wm wv wc gc gv f where mis the set of models vis the set of views cis the set of controllers wis the set of model variables and gis the set of controller functions.
additionally we define the following functions.
wm m!2windicates what model variables are defined in a model wv v!2windicates what model variables are used in a view wc c!2windicates what model variables are used in a controller gc c!2gindicates what controller functions are defined in a controller gv v!2gindicates what controller functions are used in a view f m v c!ftrue f alsegindicates the model viewcontroller groupings.
further a model variable in wand a controller function in gare represented by a tuple id ty where idrefers to the identifier and tyrefers to the type for controller functions this pertains to the return type .
the function i projects the idportion of these model variables and controller functions onto a set.
an mvc web application is consistent if and only if for every element m v c 2m v csuch that f m v c true the following properties hold property .
the view and controller only use model variables that are defined in the model 8 id2i wc c i wv v id2i wm m property .
the view only uses controller functions that are defined in the controller 8k k id2i gv v k id2i gc c property .
the expected types of corresponding model variables in the view match the assigned types in the model or controller 8 r id2i wv v r id2i wm m i wc c id r id ty r ty property .
the expected and returned types of corresponding controller functions match in the view and controller.
8k t k id2i gv v t id2i gc c k id t id k ty t ty v. a pproach to alleviate the consistency issues described we propose a static analysis approach for automatically detecting identifier and type inconsistencies in mvc applications.
we opt for a static instead of a dynamic approach for several reasons.
first static analysis is more lightweight than dynamic analysis in that the application does not need to execute in order to detect the inconsistencies this is especially useful during the development phase where quick relay of information about the code such as error messages is preferred.
second dynamic analysis requires user input i.e.
a sequence of user events and it is not always clear how to choose these inputs.
a dynamic approach may be suitable for tools that target specific bugs such as the javascript fault localization and repair tools we have previously developed since the steps to reproduce the bug are known in contrast our detector is not targeting a specific bug known to exist in the program but rather looking for these bugs without prior knowledge of how to reproduce them.
this is the same reason an inconsistency detector is preferred over a mechanism that simply displays an error message when an inconsistency is encountered during execution.
there are also several challenges in designing the above detector namely c1 model variables are often defined as nested objects e.g.
see figure lines and the variables defined inside these objects along with their types also need to be recorded thereby complicating the static analysis c2 sometimes aliases are used in the html code to represent model variables defined in the javascript code e.g.
the movie variable in figure line is an alias foruserdata.movielist userdata.intro etc.
.
the design needs to be capable of handling these aliases c3 since mvc applications can contain multiple models views and controllers the design needs to infer all the possible groupings to be checked a simple comparison ofallidentifiers and types collected does not suffice.
finally our approach assumes that the code does not contain any instances of eval .
this assumption is reasonable asdomextractorastextractorhtmlcodejavascriptcodefindcontrollersfindviewsfindmodelsfindinconsistenciescontrollersmodelsviewsinconsistenciesdomastfig.
.
block diagram of our approach.
javascript mvc frameworks encourage programmers to write in a more declarative style thus features used in vanilla javascript such as eval are rarely seen in mvc applications.
a. overview the goal of our automatic inconsistency detector is to find all instances that violate properties in section iv.
the block diagram in figure shows an overview of our approach.
as the figure depicts the approach expects two inputs namely the html template and the javascript code.
thedomextractor converts the html template into its dom representation which is used to simplify analysis of the html elements and attributes.
similarly the astextractor converts the javascript code into its ast representation.
the modules findmodels findviews and findcontrollers statically analyze the dom and the ast to populate the sets m v and c respectively.
in our approach we chose to represent a model m2mas a tuple of the form name ast where name is a unique identifier for the model and astis the subtree of the complete ast extracted earlier containing only the nodes and edges pertinent to the model for example the value of astfor the results model in figure would be the ast representing lines .
similarly a view v2 vand a controller c2care represented by name dom and name ast respectively.
section v b describes in more detail how the above sets are populated.
oncem v andcare all populated these sets along with the complete dom and ast are input into the findinconsistencies module see algorithm .
the output of this algorithm is a list of inconsistencies q. it starts by initializing the sets f as well as the identifier inclusion functions wm wv wc gc and gvwith the contents of m v andc lines here all the models views and controllers initially map to the empty set since the model variables and controller functions are still not known.
these mappings are updated as identifiers are discovered by the findidentifiers function described in section v c. likewise the mappings in fare updated in line by the findmvcgroupings function section v d .
lines are responsible for detecting the identifier and type mismatches and are described in detail in section v e. b. finding the models views and controllers the findmodels findviews and findcontrollers modules in figure populate m v andc respectively by locating the corresponding structures or blocks in the html and javascript code.
for example in angularjs models andalgorithm findinconsistencies input m the set of models input v the set of views input c the set of controllers input dom the complete dom input ast the complete ast output q list of inconsistencies 1q 2f f m v c f alse jm2m v2v c2cg 3wm f m jm2mg 4wv f v jv2vg 5wc f c jc2cg 6gc f c jc2cg 7gv f v jv2vg 8f indidenti f iers m v c wm wv wc gc gv 9f f indmvcgroupings m v c dom ast 10foreach m v c 2f m v c jf m v c truegdo foreach mv2wv v wc c do ifmv id 2i wm m then q q fidmismatch mv g end else if !matchingtype mv wm m then q q ftypemismatch mv g end end foreach c f2gv v do ifc f id 2i gc c then q q fidmismatch c f g end else if !matchingtype c f gc c then q q ftypemismatch c f g end end 27end add to m m is null?
findnextmodelvariable m fetch model m from m done updating m m yesno fig.
.
portion of findidentifiers that updates wmfor every model.
the other identifier inclusion functions are updated in a similar way.
controllers are added as the body of the function passed to the.controller method as a parameter see figure .
hence in this case locating the models and controllers involves finding the subtrees in the ast that are rooted at a callexpression for the method .controller and parsing the body of the function parameter.
similarly views are normally saved as separate html files so in most cases finding them is tantamount to identifying these separate files.
c. inferring identifiers the goal of the findidentifiers module which is invoked in algorithm line is to find the model variables and controller functions that are defined or used in every model view and controller that were found earlier see section v b thereby updating the mappings in the identifier inclusion functions .
figure illustrates how findidentifiers looks for model variables defined in every model.
a similar algorithm is used to find the model variables and controller functions used or defined in other entities.the functions findnextmodelvariable and findnextcontrollerfunction analyze the dom and the ast according to the syntactic styles imposed by the mvc framework being used.
in angularjs model variables are defined as a property of the scope variable in an assignment expression see figure lines and controller functions are defined similarly albeit the right side of the expression is a function object e.g.
figure lines and .
finding identifiers used in views however is trickier although identifiers appear as attribute values of dom elements in many cases they also typically appear in double curly brace notation as part of a text element e.g.
figure lines and hence text elements in the view s dom are also parsed since these may contain