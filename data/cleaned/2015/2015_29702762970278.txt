relda2 an effective static analysis tool for resource leak detection in android apps tianyong wu1 jierui liu1 xi deng2 jun y an1 jian zhang1 1state key laboratory of computer science institute of software chinese academy of sciences beijin g china 2technology center of software engineering institute of software chinese academy of sciences beijin g china 3university of chinese academy of sciences beijing china wuty liujr yanjun zj ios.ac.cn dengxi215 mails.uc as.ac.cn abstract resource leak is a common bug in android applications apps for short .
in general it is caused by missing release operations of the resources provided by android like camera media player and sensors that require programmers to explicitly release them.
it might lead to several serious pr oblems for the app and system such as performance degradation and system crash.
this paper presents relda2 a light weight scalable and practical static analysis tool for detecting resource lea ks in the byte code of android apps automatically.
it supports two analysis techniques flow insensitive for quick scanni ng and flow sensitive for accurate scanning and performs int erprocedural analysis to get more precise bug reports.
in addition our tool is practical to analyze real world apps an d has been applied to android apps including industry applications and open source programs.
we have found real resource leaks in these apps which we confirmed manually.
a demo video of our tool can be found at the website ccsconcepts software and its engineering automated static analysis keywords android apps resource leak static analysis byte code .
introduction to enrich user experience android phones contain a bunch of resources embedded in them such as gps camera media player and different kinds of sensors.
these resources require explicit user management that is the programmers need to request and release them manually.
missing release operations may cause performance degradation e.g.
huge permission to make digital or hard copies of all or part of thi s work for personal or classroom use is granted without fee provided that copies ar e not made or distributed for profit or commercial advantage and that copies bear this n otice and the full citation on the first page.
copyrights for components of this work owned by others than acmmustbehonored.
abstractingwithcreditispermitted.
t ocopyotherwise orrepublish to post on servers or to redistribute to lists requ ires prior specific permission and or a fee.
requestpermissionsfrom permissions acm.or g. ase september singapore singapore c circlecopyrt2016 acm.isbn ... .
memory consumption or even system crash.
we call this kind of defects resource leak in our work which is a common type of bugs in android apps for the developers may be careless or may misunderstand the android specification or they tend to focus on the user friendliness and functionality of their apps.
testing is a commonly used approach for detecting bugs in android apps .
however the testing effectiveness depends on the fault detection capability of test suites.
on the other hand static analysis a fully automatic approach can detect some incorrect behaviors and performance degradations of android apps without executing test cases.
however previous works on static analysis for android apps have not systematically investigated the resource leak pro blem yet.
there are several challenges for static analysis on android apps.
the first one is about component based and eventdriven nature of android framework.
the implicit callback mechanism provided by android system makes the generation of the precise call graph cg the essential part of static analysis very difficult.
the second one is how to perform inter procedural analysis for real world apps which m ay contain about dozens of thousands of methods.
a straightforward approach is to inline each invoked method however it may result in path explosion and is hard to be applied to large scale apps.
this paper presents relda2 resource leak detection for android a light weight scalable and practical static an alysis tool for detecting resource leak in android apps automatically.
our tool works on the byte code of the apps directly.
it provides an inter procedural analysis framew ork that is implemented with the summary based approach.
to make a trade off between scalability and precision our tool supports two analysis techniques flow insensitive and flow sensitive .
the flow insensitive analysis ignores the cont rol flow information and can quickly analyze an app while the flow sensitive technique can eliminate a number of false neg atives with more but acceptable time cost.
relda2 is platform independent easily deployed and prac tical to analyze real world android apps.
it has been applie d to industry apps and open source apps and we have found and confirmed real resource leaks in them.
.
relda2 in this section we introduce the system architecture and techniques used in relda2.
it takes an android app as inpermission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed for profit or commercial advantage and that copies bear this notice and the full citation on the first page.
copyrights for components of this work owned by others than acm must be honored.
abstracting with credit is permitted.
to copy otherwise or republish to post on servers or to redistribute to lists requires prior specific permission and or a fee.
request permissions from permissions acm.org.
ase september singapore singapore c acm.
... .
put and outputs the potential resource leaks in the apps.
note that there is a significant difference between our tool and other existing static analysis tools for android apps.
most of existing tools e.g.
do not analyze the dalvik byte code directly and they are built on top of static analysis tools like soot wala for java programs.
to analyze the android apps these tools have to translate the dalvik byte codes to some intermediate representation like jimp le or java byte codes.
several works have mentioned that the translation process may fail in some cases e.g.
especially in the deliberately modified apps.
besides the dalvi k byte code has a small instruction set and can be parsed by existing tools such as androguard and apktool .
the above issues motivate us to construct a pure dalvik bytecode oriented analysis tool for android apps.
.
system overview the high level overview of relda2 is shown in fig.
.
the resource table contains the target resources that we focus on while the callback graph cbg stores the information of implicit callbacks provided by the android framework.
currently we collect them according to the android reference and the users can customize the resource table based on their requirements.
more details about how to collect these information can be seen in our work .
our tool relda2 mainly consists of three parts as follows.
thepreprocess module disassembles the apk file into dex byte code and constructs a function call graph fcg containing the call relations of methods to perform inter procedural analysis.
theanalysis module employs the summary based approach to record the resource request and release operations of each method in the app.
the analysis process can be divided into two stages resource summary obtains all the resource operations in each method and implicit callback order handling refines the resource summaries with callback information.
thebug report module checks the resource summaries to determine whether the app has resource leaks and provides the trace information of potential defects to help developers locate the bugs.
figure high level overview of relda22.
fcgconstruction in the analysis of an android app we distinguish between local resources and global resources.
for a local resource resource declared and only used within a method we assume that developers want to release it when the method finishes.
to detect the possible leaks we can analyze each function separately if android apps only use local resources.
however in real world android apps the resources are usually requested in one function and released in another function.
we call this kind of resources global resources that should be released in all the paths that go through its request point or in the exit callbacks of the app.
to address this issue we construct the function call graph fcg to assist interprocedural analysis.
we give the fcg construction process as follows.
it first gets the main activities of the app then obtains all the reachable methods and constructs nodes and edges in the fcg.
each node indicates a method and each edge represents a method call relation.
for each method we traverse its instructions one by one.
when it comes to an invoke instruction we collect all the invoked functio ns of this instruction to construct the edges.
specially if th e instruction invokes an implicit callback we treat all of it s invoked methods as the callees according to the cbg.
.
analysis the analysis module analyzes the methods in the fcg to detect whether there are resource leaks.
to perform interprocedural analysis we leverage the function summary tech nique which can collect side effects as function summaries and reuse them in the function call sites.
this module can be divided into two steps resource summary and implicit callback order handling.
the first step generates the resource summary for each method.
here we define the resource summary of a method as a set of resource operations invoked by it directly or indi rectly.
depending on the analysis techniques the resource summary can be generated with or without the control flow information in the method a.k.a.
flow sensitive or flowinsensitive.
the flow insensitive technique carries out a s imple and fast checking on byte code in a sequential order.
we traverse all the methods of the fcg in a bottom up manner and construct their resource summaries.
on the other hand the flow sensitive technique generates the resource summaries according to the control flow graph cfg .
we use a model checker to systematically analyze all the methods from bottom to up as we find that the property of resource leak the resource that has been requested should be released eventually can be easily defined by a temporal logic formula and verified by a model checker.
for some of the methods are independent in fcg we can distribute the analysis workloads into multiple threads processes to re duce the execution time further.
in a word we can employ the flow insensitive method to process a quick checking and the flow sensitive one to perform a more precise but timeconsuming analysis.
the implicit callback order handling module rearranges the resource summaries with the calling orders from cbg.
for each callback order in the cbg we figure out its all possible execution sequences in the app.
then for each sequence we sum up the resource summaries of all the methods in the sequence as the summary of the first method in the sequence.
.
bug report the bug report module summarizes the analysis results and generates the report to assist the users to locate and fix the potential resource leaks.
for a potential resource leak we do not report the method that requests the leaked resource since there may exist multiple paths going through this method.
instead a bug report generated by relda2 contains the entry method that is the entry point of the path containing the resource leak and the corresponding resource release operation for fixing the leak.
here the entry method must be a callback defined in android system e.g.oncreate onclick that can only be invoked by android framework at runtime when some specific events are triggered.
the user may also want to know the method that directly invokes the resource request operation so tha t our bug report also gives the fcg of the reported entry method which contains all of its callee methods and its cfg.
with the above information the user can locate and fix the resource leak more easily.
.
implementation we implemented our main techniques on top of androguard an open source tool that maps dex apk format into full python objects in python language and developed a command line tool relda2.
to enhance the user experience we also developed a gui program with qt framework for user interaction.
recall the system architecture of our tool.
in the preprocess module we leverage androguard to decompress and disassemble the app into the dex byte code.
in the flowsensitive approach of the analysis module we also make use of it to generate the cfg of each method in the app.
the model checker used in relda2 is nusmv which is a symbolic model checker for computation tree logic ctl .
to implement our multi threading technique for accelerati ng the analysis efficiency we leverage the module multiprocessingprovided by python to distribute the analysis workload to multiple process.
different with the bugs related to the functionalities of the software the resource leaks can not be easily observed from the gui.
thus relda2 leverages the program instrumentation technique on the byte code of the app to record the resource related operations when the app is running.
speci fically relda2 first unpacks the app to get the smali a format of dex byte code files and then inserts the monitoring instructions into these files.
finally it repacks the smali fil es back to apk files.
we only insert a few instructions following the relevant resource operations so that the overhead of instrumentation can be omitted.
to sum up relda2 is easy to be deployed on different operating systems like linux and windows.
in addition the analysis process of the tool is fully automatic.
given an android app the user only needs to set the options and then run the tool to get the bug report.
.
usage in this section we will introduce how to use relda2 to analyze an android app.
when relda2 is launched the user can select the apk to be analyzed.
then it will first collect and show the basic information such as size the number of classes and methods see fig.
.
next the user needs to configure the options for analysis.
the major options are shown in fig.
that include four parts.
the resource part is used to configure which resources the user focuses on while the activity part decides which activities in th e app that the user wants to analyze.
the analysis strategy part gives the analysis algorithms flow insensitive or flow sensitive to be used and whether the multi thread techniqu e is used.
the output part configures the output information including the fcg and cfg of the method that has resource leaks and an instrumented apk modified from the analyzed apk by inserting a number of extra instructions into the original app for recording the resource related op erations.
figure basic information widget figure configuration widget after the configuration relda2 analyzes and checks the resource summaries to generate the bug report see fig.
.
if the summary of the method only contains the request operations that is there may be resource leaks then relda2 records the locations where the leaks occur.
relda2 also provide the cfg and fcg of the entry method containing the resource leak and an instrumented app.
the cfg and fcg help the user locate the resource leak while the instrumented apk makes bug confirmation process easier.
.
evaluation to evaluate the effectiveness of our tool relda2 we collected real apps that can be disassembled by androguard 764for our evaluation where apps are from two famous official app markets google play and wandoujia a popular market in china and apps are from an open source android app repository1.
the functionality of these apps are varied like sociality media game and they all use sever al resources.
due to the limit of the space we only show apps in table .
in this table the first column shows the origin of the apps open source community or app markets and the second column gives the name of the apps.
the third column shows the size of the apk file mb .
the size of our experimental apps range from tens of kb to dozens of mb.
the last two columns indicate the number of classes and methods in an app.
in our experiments we run the command line version of relda2 on an intel xeon .40ghz cores machine with 32gb memory and centos .
operating system.
figure bug report widget table the statistics of experimental applications origin app size class method open source communityandless .
bluechat .
foocam .
getbackgps .
impeller .
app marketsanydo .
baibiantorch .
bubeilisten .
budingticket .
checkcheck .
compass .
hikiplayer .
kuaipaiqr .
picsart .
yelp .
.
bugs detected relda2 reported that apps closed source apps and open source apps might have resource leaks and we tried to confirm these bug reports.
however there are currently specific tools publicly available to confirm whether the resource leaks in our bug reports are real bugs.
here we mainly used error guessing testing2to design appropriate test cases that can exactly trigger the resource leaks repor ted by our tool note that this technique can confirm a part of the reports the rest ones may also be real resource leaks .
totally relda2 detected potential resource leaks with flow insensitive technique and leaks with flow sensiti ve technique.
the precision rates of two analysis techniques a re .
and .
respectively.
in fact th e resource leaks detected by the flow insensitive approach ar e also found by the flow sensitive approach.
since our errorguessing testing is incomplete the real precision rate sho uld be greater.
table gives the detailed results of the apps in table where rep is the number of leaks reported by the tool and tp is the number of true positives we have confirmed.
here we count the values of tp and rep with merging the redundant reports that are caused by the same resource request statements if they can be fixed by inserting release operations in the same exit points.
table detected bugs appflow insensitive flow sensitive tp rep tp rep andless bluechat foocam getbackgps impeller anydo baibiantorch bubeilisten budingticket checkcheck compass hikiplayer kuaipaiqr picsart yelp .
casestudy in this section we present a case study to show how our tool helps the users to detect confirm and locate the resource leaks in their apps.
bluechat is an open source and light weight p2p chat app that uses the energy consuming resource bluetooth .
two devices connect each other with bluetooth and one can send messages to another.
fig.
shows a simplified code snippet of the process.
as soon asclientactivity is activated it first obtains an instance of bluetoothadapter the variable mbluetoothadapter in the method oncreate which is used to perform fundamental bluetooth tasks.
then it invokes the method startdevicesearch to search for the nearby devices.
at the beginning of the method startdevicesearch it turns on the local bluetooth adaptor by calling method mbluetoothadapter .ena ble .
however the developers forgot to turn off the bluetooth adaptor by calling the method mbluetoothadapter .disa ble in the ondestroy callback.
guessing 765relda2 can detect this resource leak and the bug report generated by it is shown in fig.
.
it consists of three parts the entry method system callback that contains the resource leak the system apis to request and release the resource.
to assist the developer locate the resource leak relda2 also provides an fcg that contains all callee methods of the reported entry method.
fig.
shows a part of the fcg that helps the user find the method clientactivity.startdevicesearch that directly requests the resource.
public class clientactivity extends activity protected void oncreate bundle savedinstancestate ...... mchatmanager newchatmanager this false mbluetoothadapter bluetoothadapter.getdefaultadapter ...... startdevicesearch private void startdevicesearch mbluetoothadapter.enable ...... public void ondestroy ...... mbluetoothadapter.canceldiscovery figure bluechat example method clientactivity.oncreate request api bluetoothadapter.enable release api bluetoothadapter.disable figure bug report of bluechat figure fcg of the method clientactivity.oncreate as mentioned before the resource leaks can not be easily observed from runtime information so we leverage the program instrumentation technique on the byte code of the ...... .
invoke virtual v1 landroid bluetooth bluetoothadapter enable z .const string v2 relda2 .const string v3 bluetoothadapter.enable .
invoke static range v2 .. v3 landroid util log d ljava lang string ljava lang string i ...... figure instrumented byte code of bluechatapp to record the resource related operations when the app is running.
in this case there is only one statement to request the resource mbluetoothadapter.enable thus we insert extra statements following this statement to log som e tipping information when the resource related operation i s executed.
fig.
shows a part of byte code after the instrumentation where line to are the instrumented statements.
when the users execute the instrumented app they can observe the logging information about the resource operations to confirm whether the resource leak occurs.
.
performance the analysis time of flow insensitive technique is within one minute for each app and it costs .
seconds on average.
the flow sensitive technique costs at most .
seconds about minutes and seconds about .
minutes on average.
table indicates the analysis time second and memory mb for the apps in table .
in our experiments our tool requires at most 1gb memory.
table analysis time and memory appflow insensitive flow sensitive time mem time mem andless .
.
bluechat .
.
foocam .
.
getbackgps .
.
impeller .
.
anydo .
baibiantorch .
.
bubeilisten .
budingticket checkcheck .
compass .
.
hikiplayer .
.
kuaipaiqr .
picsart .
.
yelp .
.
a anydo b bubeilisten c impeller d picsart figure analysis time under different number of threads 766relda2 also uses the multi thread technique to reduce the analysis time.
in our experiments we set the number of threads from to our machine has cpu cores .
fig.
shows the analysis time of the apps in table under different number of threads.
from this figure we can easily observe that the analysis time is significantly reduced and we give the empirical value for the number of threads as for there is little improvement when the number exceeds .
the analysis time of the single thread method is often five to seven times as much as that of the multiple thread method.
.
related work there are several researchers focusing on the resource leak problem in android apps.
d. yan et al.
proposed a model based approach to generate test cases for detecting resource leaks.
note that the resources they focused on are memory thread and binder.
y. liu et al.
aimed to find sensor related energy inefficiency problems in android apps by runtime verification.
in fact these problems are caused by the resource leaks of sensors.
k. kim and h. cha focused on no sleep energy bug which is also caused by the resource leaks.
they first analyzed the wakelock request and release mechanism in android platform and then monitored the kernel functions to detect the wakelock behavior.
each of these works only considers the leaks of one or two kinds of resources while we systematically collected the r esources that require developers to release them manually an d proposed a general approach to detect the leaks.
the event driven nature of android framework makes the generation of the precise control flow graph very difficult.
y. cao et al.
implemented edgeminer which can statically generate api summaries that describe implicit contro l flow transitions through the android framework.
s. yang et al.
considered user event driven components and th e related sequences of callbacks from the android framework to the application code.
they proposed a context sensitive analysis method to capture such callback methods.
.
conclusion this paper describes a light weight scalable and practica l static analysis tool for detecting resource leaks in androi d apps automatically.
it provides two analysis techniques an d supports inter procedural analysis.
tens of real resource leaks from popular commercial apps and open source programs have been found by our tool.
in the future we would like to design some techniques to support continuous upgrading android specifics and effective analysis.
in addition without the significant reduction of the efficiency we will implement more accurate analysis techniques e.g.
sym bolic execution to eliminate a number of false positives.
.