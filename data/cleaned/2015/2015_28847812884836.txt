finding security bugs in web applications using a catalog of access control patterns joseph p .
near university of california berkeley jnear berkeley.edudaniel jackson massachusetts institute of technology dnj mit.edu abstract we propose a speci cation free technique for nding missing security checks in web applications using a catalog of access control patterns in which each pattern models a common access control use case.
our implementation space checks that every data exposure allowed by an application s code matches an allowed exposure from a security pattern in our catalog.
the only user provided input is a mapping from application types to the types of the catalog the rest of the process is entirely automatic.
in an evaluation on the most watched ruby on rails applications on github space reported possible bugs previously unknown security bugs and false positives.
categories and subject descriptors d. .
software program veri cation keywords web application security access control bug nding introduction web application security holes represent a large and growing class of bugs.
programming frameworks and static analysis tools have begun to address bugs that violate generic crossapplication speci cations for example injection cross site scripting and over ow vulnerabilities .
however application speci c bugs like missing security checks have received less attention.
traditional solutions such as veri cation and dynamic policy enforcement techniques ask the user to write a speci cation of the intended access control policy.
we propose a speci cation free technique for nding application speci c security bugs using a catalog of access control patterns .
each pattern in our catalog models a common access control use case in web applications.
our catalog is based on the assumption that developers usually intend for a particular pattern to be applied uniformly to all uses of a given resource type an assumption supported by our permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed for profit or commercial advantage and that copies bear this notice and the full citation on the first page.
copyrights for components of this work owned by others than the author s must be honored.
abstracting with credit is permitted.
to copy otherwise or republish to post on servers or to redistribute to lists requires prior specific permission and or a fee.
request permissions from permissions acm.org.
icse may austin tx usa c copyright held by the owner author s .
publication rights licensed to acm.
isbn .
.
.
.
with real world applications.
our approach checks that for every data exposure allowed by an application s code our catalog also allows the exposure.
when the application allows a data exposure not allowed by the catalog we report that exposure as a security bug.
this process requires only that the user provide a mapping of application resources to the basic types such as user permission etc.
that occur in our catalog.
from this information alone application speci c security bugs are identi ed automatically.
we have implemented this technique in space security pattern checke r .space uses symbolic execution to extract the set of data exposures from the source code of a ruby on rails application.
the constraints associated with these exposures and the user provided mapping are passed through a constraint specializer which re casts the constraints in terms of the types in our pattern catalog.
then space uses the alloy analyzer to perform automatic bounded veri cation that each data exposure allowed by the application is also allowed by our catalog.
we applied space to the most watched open source rails applications on github.
we found that of the implement access control and space found bugs in of those a total of unique bugs.
both the symbolic execution and bounded veri cation steps of our technique scale to applications as large as 45k lines of code none of our analyses took longer than seconds to nish.
this paper makes the following contributions a highly automated technique for nding security bugs based on the idea of matching extracted access patterns to known safe patterns an initial catalog of common security patterns based on those we encountered in an analysis of real world applications an open source implementation 1space that has been used to nd previously unknown bugs in open source rails applications.
in section we describe space from the user s perspective and demonstrate its use to nd a bug.
in section we formalize our catalog of patterns and the technique used to check them against an application.
section describes our implementation of space and section details our evaluation of its e ectiveness.
in section we discuss related work and section contains our conclusions.
ieee acm 38th ieee international conference on software engineering class usercontroller applicationcontroller before lter signed inuser only show edit update before lter correct user only ... defshow user user.
nd params posts nd posts byuser id user.id editing true if signed in ?
end def edit user user.
nd params url user params end defupdate user user.
nd params if user.
update attributes user params redirect to user success editing successful !
else redirect to edit user path user.id error editing failed !
end end end figure controller code for mediumclone description example space security pattern checke r nds security bugs in ruby on rails2web applications and requires only that the user provide a mapping from application de ned resource types to the object types of the standard role based model of access control rbac .
space is otherwise completely automatic it analyzes the target application s source code and returns a list of bugs.
space is designed primarily to nd mistakes in the implementation of an application s security policy.
most often these mistakes take the form of missing security checks.
in this section we describe an example open source application mediumclone and demonstrate how we used space to nd security bugs in its implementation.
.
example application mediumclone mediumclone3is a simple blogging platform designed to mimic the popular web site medium.
using mediumclone users can read posts and log in to create new posts or update existing ones.
the site requires users to sign up and log in before writing posts and prevents users from modifying others posts.
a rails application is composed of actions each of which handles requests to a particular url within the application.
controllers are collections of actions each controller s actions implement an api for interacting with a resource exposed by the site.
resources are de ned using the activerecord library which implements an object relational mapper to persist resource instances using a database and which provides a set of built in methods for querying the database for resource instances.
figure contains a part of the controller code for mediumclone s usercontroller which provides a restful api for user pro les.
following the rest convention the show is for displaying pro les the editaction displays an html form for editing the pro le and submitting that form results in a post request to update action which actually performs the database update using update attributes .
the call to before lter installs a lter a procedure that runs before the action itself for the show and editactions.
the lter checks that the logged in user has permission to perform the requested action and redirects them to an error page if not.
this use of lters to enforce security checks is common in rails applications and helps to ensure that checks are applied uniformly.
mediumclone s security bug.
the code in figure fails to apply the correct user lter to the update action so an attacker can send an http post request directly to theupdate url of the mediumclone site to update any user pro le.
the lter isproperly applied to the editaction.
in our experience this kind of mistake is common the developer assumes the user will use the interface provided by the site in this case the editpage and will not craft malicious requests to constructed urls.
developers often fail to consider alternative paths not accessible through the interface and therefore omit vital security checks.
finding the bug using space .space compares the checks present in the application code against its built in catalog of common security patterns.
when the application code is missing security checks required by the patterns space reports a bug in the code.
space s security patterns are formalized in terms of rolebased access control rbac which de nes sets of users roles operations objects and permissions .space s formal models of security patterns enforce security checks by constraining relations between these sets.
in order to check these patterns against a piece of code the user provides a mapping of the application s resources to the sets of objects de ned in the rbac model.
mediumclone s user type represents the user type in the rbac pattern and posts are special rbac objects that have an owner.
the owns relation is de ned by our model of ownership and user owns means that the user eld of a post speci es its owner.
the user provides this mapping for mediumclone as follows space.analyze do mapping user rbacuser post ownedobject user owns end space requires the mapping above and mediumclone s source code it needs no further input or guidance from the user.
the mapping provided by the user translates between the rbac objects constrained by the pattern catalog and the resource types de ned in the application code.
space uses this mapping to specialize the constraints derived from the checks present in the code to the set of rbac objects so that the two sets of security checks can be compared.
space compares the specialized constraints against the constraints required by the pattern catalog.
when space nds a missing check it builds a counterexample demonstrating the security vulnerability caused by the missing check.
the counterexample is speci c to the application code under analysis it involves resource types de ned in the code rather than rbac concepts.
for mediumclone space produces the counterexample shown in figure a .
the update0 box indicates that an update is possible on the pro le of auser0 the target a a b figure space counterexample showing mediumclone security bugs a user can update another user s pro le b unauthenticated user nouser can update any post renaming of user to avoid clashes by the distinct auser1 the current user or currently logged in user .
this counterexample demonstrates a user updating another user s prole using the update action a situation that is not captured by our security pattern catalog.
the user pro le pattern explicitly requires that users can update their own pro les but no pattern exists that allows updating another user s pro le.
the bug can be xed by adding update to the list of actions for which the correct user lter is applied.
more bugs in mediumclone.
fixing the bug and runningspace again yields a new counterexample shown in figure b .
this counterexample suggests that post resources in mediumclone can be updated not only by users who did not create them but by users who are not logged in nouser at all!
the code for postcontroller checks that the user is logged in before performing the new create and editactions but omits this check for the update action class postcontroller applicationcontroller before lter signed inuser only new create edit ... end this bug is interesting because the intended security policy that users only modify their own posts is forgotten across the entire application codebase.
this mistake exempli es a class of bugs that are di cult to detect with testing or with our previously developed consistency checker derailer .
formal model this section formalizes our catalog and space s method for comparing it to a web application s code.
the rst step is to derive a list of data exposures from the application code representing the di erent ways users of the application can read or update data stored in the database.
second space uses the mapping de ned by the user to specialize each exposure s constraints to the objects constrained by the catalog.
finally space veri es that each data exposure allowed by the application code is also allowed by the catalog.
.
web applications we consider web applications in terms of sets of databases requests and resources .
an application de nes relations response and update describing in the context of a given database the resources sent to the requester and updatedin the database respectively.
note that the updates do not specify the resulting state of the database our concern is only whether modi cations can be made to particular resources and not the actual values of those modi cations.
databases p resources values response databases requests resources update databases requests resources space approximates these relations by using symbolic execution to build the exposures relation representing the application s set of data exposures operations fread writeg constraints rst order predicates over requests and databases exposures requests constraints operations resources the exposures relation characterizes the conditions under which the application code allows a particular resource to be read or written.
the formula db req res response means that if the application exposes resource res itmust be under conditions .
8db req res db req res 2response req read res 2exposures 8db req res db req res 2update req write res 2exposures space builds the exposures relation by symbolically evaluating each action of the web application under analysis passing symbolic values for the database and user supplied parameters.
space enumerates the symbolic values that can appear on a rendered page and constructs an exposure for each one.
these exposures have the form req read res wherereqis the original symbolic request is the path condition derived from the symbolic execution and resis the symbolic expression representing the exposed resource.
similarly when space nds a database update it constructs an exposure of the form req write res wherereqis the request is the current path condition and resis a symbolic expression representing the resource being updated.
example.
as a running example we take mediumclone s usercontroller bug from section .
for this controller s buggy update action space generates the exposure update user.pro le true write user meaning that when the application receives a request to update a user pro le of user it performs the modi cation without enforcing any constraints.
the exposure that correctly enforces the desired security policy by enforcing that the modi ed pro le is the current user s is instead update user.pro le user current user write user .
role based access control as a basis for representing security policies we adopt the role based access control model of sandhu et al.
specifically rbac .
the standard model of role based access control consists of sets users roles permissions and sessions over which the following relations are de ned to assign permissions and users to roles permission a permissions roles user a users roles we adopt the extension of this model by ferraiolo et al.
with objects andoperations where objects contains the 949targets of permissions which will correspond to the web application s resources and operations for our applications contains the operation types read and write already used in the de nition of the exposures relation.
this model de nes permissions to be a set of mappings between operations either read orwrite and objects allowed by that permission permissions p operations objects .
security pattern catalog the patterns in our catalog constrain the relations of the generic rbac model to speci cally allow certain behaviors.
each one of these pattern de nitions corresponds to a standard use case for resources in web applications in e ect the patterns whitelist common kinds of correct data accesses.
access pattern ownership.
in most applications resources created by a user belong to that user and a resource s creator is granted complete control over the resource.
to express this use case we de ne a relation owns between users and objects and then allow those owners to perform both reads and writes on objects they own owns users objects 8u o u o 2owns 9r u r 2user a read o r 2permissiona write o r 2permissiona access pattern public objects.
many applications make some resources public.
a blog for example allows anyone to read its posts.
this pattern de nes publicobjects to be a subset of the larger set of objects and allows anyone to read but not write those objects publicobjects objects 8u r o p o2publicobjects u r 2user a read o r 2permissiona access pattern authentication.
every application with access control has some mechanism for authenticating users and many security holes are the result of the programmer forgetting to check that the user is logged in before allowing an operation.
to model authentication this pattern de nes logged in a possibly empty subset of users representing the currently logged in users and constrains the system to allow permission only for logged in users except for public objects logged in users 8u r o op p u r 2user a op o r 2permissiona op read o2publicobjects u2logged in access pattern explicit permission.
some applications de ne a kind of resource representing permission and store instances of that resource in the database.
before allowing access to another resource the application checks for the presence of a permission resource allowing the access.
to model this use case this pattern de nes permissionobjects to be a subset of objects de nes a relation permits relating a permission object to the user operation and object it gives permission to and allows users to perform operations allowed by permission objects permissionobjects objects permits permissionobjects users operations objects 8u o p op p u op o 2permits 9r u r 2user a op o r 2permissiona access pattern user pro les.
applications with users tend to have pro le information associated with those users.
programmers commonly forget checks requiring that the user updating a pro le must be the owner of that pro le this pattern constrains the allowed writes so that no user can update another user s pro le pro le users objects 8u p 9r u r 2user a u p 2pro le write p r 2permissiona access pattern administrators.
many applications distinguish a special class of users called administrators that have more privileges than normal users.
we can represent these users with a special role called admin which grants its users full permissions on all objects admin2roles 8o read o admin 2permissiona write o admin 2permissiona access pattern explicit roles.
a few applications specify distinct roles and represent them explicitly using a resource type.
they then assign roles to users and allow or deny permission to perform operations based on these assigned roles.
this pattern introduces a level of indirection to allow mapping these resource level role de nitions to the rbac de ned set of roles roleobjects objects object roles roleobjects roles user roles users roleobjects 8ro r u ro r 2object roles u ro 2user roles u r 2user a .
mapping application resources to rbac objects to compare the operations allowed by an application to those permitted by our security patterns a mapping is required between the objects de ned in the rbac model and the resources de ned by the application.
in many cases this mapping is obvious a resource named user in the application for example almost always represents rbac users but in general it is not possible to infer the mapping directly.
space asks the user to de ne this mapping.
formally it is a mapping from types of application resources to types of rbac objects the mapping is a relation since some application resources may represent more than one type of rbac object.
the set of resource types can be derived from the application s data model which is present in its source code and the set of rbac object types is based on the formal model of rbac de ned here.
resource application de ned types rbac fuser object permissionobject ownedobject publicobject roleobjectg map resource rbac we also need to provide de nitions from the application for the new concepts introduced in our pattern de nitions publicobjects permissionobjects and the owns andpermits 950relations.
the map relation can be used to de ne public and permission objects but we must de ne a separate mapping from eld names of resources to the corresponding relations they represent in our security patterns.
we use map eldsfor this purpose.
fieldnames application de ned eld names relationnames fowns permits logged in object roles user rolesg map elds fieldnames relationnames finally we de ne session relating web application requests and the currently logged in rbac user session requests users the session relation is needed to determine the currently logged in user if any some requests are sent with no authentication of the application.
since rails has session management built in this mapping can be inferred automatically.
example.
based on the mapping provided for mediumclone in section space populates the mapping relations as follows resource fmuser mpostg map muser user mpost ownedobject fieldnames fauthor ...g map elds author owns .
finding pattern violations to nd bugs in a given application the goal is to nd exposures that are not allowed by some security pattern.
for each exposure in exposures this process proceeds in two steps.
to check exposure req op res .
build a specialized constraint 0from by substituting rbac objects for application resources using the map relation supplied by the user.
.
determine whether or not some pattern allows the exposure by attempting to falsify the formula u r 2user a op obj r 2permissiona whereu randobjare rbac objects corresponding to the current user sending reqand the resource res.
intuitively this formula holds when the conditions imposed by the application imply that some pattern allows the exposure.
building .we use map to build a specialized constraint 0from as follows replace each reference resto an application resource in with an expression f j res 2mapgrepresenting the corresponding set of possible rbac objects.
replace each eld reference o fld in with an expressionfo0j fld r 2map elds o0 o 2rgrepresenting a reference to the corresponding relation de ned by our security patterns.
intuitively this means replacing