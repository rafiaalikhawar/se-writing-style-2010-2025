fairness testing testing software for discrimination sainyam galhotra yuriy brun alexandra meliou university of massachusetts amherst amherst massachusetts usa sainyam brun ameli cs.umass.edu abstract this paper defines software fairness and discrimination and develops a testing based method for measuring if and how much software discriminates focusing on causality in discriminatory behavior.
evidence of software discrimination has been found in modern software systems that recommend criminal sentences grant access to financial products and determine who is allowed to participate in promotions.
our approach themis generates efficient test suites to measure discrimination.
given a schema describing valid system inputs themis generates discrimination tests automatically and does not require an oracle.
we evaluate themis on software systems of which come from prior work with explicit focus on avoiding discrimination.
we find that themis is effective at discovering software discrimination state of the art techniques for removing discrimination from algorithms fail in many situations at times discriminating against as much as of an input subdomain themis optimizations are effective at producing efficient test suites for measuring discrimination and themis is more efficient on systems that exhibit more discrimination.
we thus demonstrate that fairness testing is a critical aspect of the software development cycle in domains with possible discrimination and provide initial tools for measuring software discrimination.
ccs concepts software and its engineering software testing and debugging keywords discrimination testing fairness testing software bias testing acm reference format sainyam galhotra yuriy brun and alexandra meliou.
.
fairness testing testing software for discrimination.
in proceedings of 11th joint meeting of the european software engineering conference and the acm sigsoft symposium on the foundations of software engineering paderborn germany september esec fse pages.
permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed for profit or commercial advantage and that copies bear this notice and the full citation on the first page.
copyrights for components of this work owned by others than the author s must be honored.
abstracting with credit is permitted.
to copy otherwise or republish to post on servers or to redistribute to lists requires prior specific permission and or a fee.
request permissions from permissions acm.org.
esec fse september paderborn germany copyright held by the owner author s .
publication rights licensed to association for computing machinery.
acm isbn .
.
.
.
introduction software has become ubiquitous in our society and the importance of its quality has increased.
today automation advances in machine learning and the availability of vast amounts of data are leading to a shift in how software is used enabling the software to make more autonomous decisions.
already software makes decisions in what products we are led to buy who gets a loan self driving car actions that may lead to property damage or human injury medical diagnosis and treatment and every stage of the criminal justice system including arraignment and sentencing that determine who goes to jail and who is set free .
the importance of these decisions makes fairness and nondiscrimination in software as important as software quality.
unfortunately software fairness is undervalued and little attention is paid to it during the development lifecycle.
countless examples of unfair software have emerged.
in amazon.com inc. used software to determine the parts of the united states to which it would offer free same day delivery.
the software made decisions that prevented minority neighborhoods from participating in the program often when every surrounding neighborhood was allowed to participate .
similarly software is being used to compute risk assessment scores for suspected criminals.
these scores an estimated probability that the person arrested for a crime is likely to commit another crime are used to inform decisions about who can be set free at every stage of the criminal justice system process from assigning bond amounts to deciding guilt to sentencing.
today the u.s. justice department s national institute of corrections encourages the use of such assessment scores.
in arizona colorado delaware kentucky louisiana oklahoma virginia washington and wisconsin these scores are given to judges during criminal sentencing.
the wisconsin supreme court recently ruled unanimously that the compas computer program which uses attributes including gender can assist in sentencing defendants .
despite the importance of these scores the software is known to make mistakes.
in forecasting who would reoffend the software is particularly likely to falsely flag black defendants as future criminals wrongly labeling them this way at almost twice the rate as white defendants white defendants were mislabeled as low risk more often than black defendants .
prior criminal history does not explain this difference controlling for criminal history recidivism age and gender shows that the software predicts black defendants to be more likely to be pegged as at higher risk of committing a future violent crime than white defendants .
going forward the importance of ensuring fairness in software will only increase.
for example it s likely and some say inevitable that future ai powered weapons will eventually be able to operate with complete autonomy leading to a watershed moment in the esec fse september paderborn germany sainyam galhotra yuriy brun and alexandra meliou history of warfare for the first time a collection of microchips and software will decide whether a human being lives or dies .
in fact in the u.s. executive office of the president identified bias in software as a major concern for civil rights .
and one of the ten principles and goals satya nadella the ceo of microsoft co. has laid out for artificial intelligence is ai must guard against bias ensuring proper and representative research so that the wrong heuristics cannot be used to discriminate .
this paper defines causal software discrimination and proposes themis a software testing method for evaluating the fairness of software.
our definition captures causal relationships between inputs and outputs and can for example detect when sentencing software behaves such that changing only the applicant s race affects the software s sentence recommendations for of possible applicants.
prior work on detecting discrimination has focused on measuring correlation or mutual information between inputs and outputs discrepancies in the fractions of inputs that produce a given output or discrepancies in output probability distributions .
these approaches do not capture causality and can miss discrimination that our causal approach detects e.g.
when the software discriminates negatively with respect to a group in one settings but positively in another.
restricting the input space to real world inputs may similarly hide software discrimination that causal testing can reveal.
unlike prior work that requires manually written tests themis automatically generates test suites that measure discrimination.
to the best of our knowledge this work is the first to automatically generate test suites to measure causal discrimination in software.
themis would be useful for companies and government agencies relying on software decisions.
for example amazon.com inc. received strong negative publicity after its same day delivery algorithm made racially biased decisions.
politicians and citizens in massachusetts new york and illinois demanded that the company offer same day delivery service to minority neighborhoods in boston new york city and chicago and the company was forced to reverse course within mere days .
surely the company would have preferred to test its software for racial bias and to develop a strategy e.g.
fixing the software manually reviewing and modifying racist decisions or not using the software prior to deploying it.
themis could have analyzed the software and detected the discrimination prior to deployment.
similarly a government may need to set nondiscrimination requirements on software and be able to evaluate if software satisfies those requirements before mandating it to be used in the justice system.
in the u.s. attorney general eric holder warned that steps need to be taken to prevent the risk assessment scores injecting bias into the courts although these measures were crafted with the best of intentions i am concerned that they inadvertently undermine our efforts to ensure individualized and equal justice they may exacerbate unwarranted and unjust disparities that are already far too common in our criminal justice system and in our society.
.
as with software quality testing is likely to be the best way to evaluate software fairness properties.
unlike prior work this paper defines discrimination as a causal relationship between an input and an output.
as defined here discrimination is not necessarily bad.
for example a software systemdesigned to identify if a picture is of a cat should discriminate between cats and dogs.
it is not our goal to eliminate all discrimination in software.
instead it is our goal to empower the developers and stakeholders to identify and reason about discrimination in software.
as described above there are plenty of real world examples in which companies would prefer to have discovered discrimination earlier prior to release.
specifically our technique s job is to identify if software discriminates with respect to a specific set of characteristics.
if the stakeholder expects cat vs. dog discrimination she would exclude it from the list of input characteristics to test.
however learning that the software frequently misclassifies black cats can help the stakeholder improve the software.
knowing if there is discrimination can lead to better informed decision making.
there are two main challenges to measuring discrimination via testing.
first generating a practical set of test inputs sufficient for measuring discrimination and second processing those test inputs executions to compute discrimination.
this paper tackles both challenges but the main contribution is computing discrimination from a set of executions.
we are aware of no prior testing technique neither automated nor manual that produces a measure of a software system s causal discrimination.
the paper also contributes within the space of efficient test input generation for the specific purpose of discrimination testing see section but some prior work specifically in combinatorial testing e.g.
may further help the efficiency of test generation though these techniques have not been previously applied to discrimination testing.
we leave a detailed examination of how combinatorial testing and other automated test generation can help further improve themis to future work.
this paper s main contributions are formal definitions of software fairness and discrimination including a causality based improvement on the state of the art definition of algorithmic fairness.
themis a technique and open source implementation for measuring discrimination in software.
a formal analysis of the theoretical foundation of themis including proofs of monotonicity of discrimination that lead to provably sound two to three orders of magnitude improvements in test suite size a proof of the relationship between fairness definitions and a proof that themis is more efficient on systems that exhibit more discrimination.
an evaluation of the fairness of real world software instances based on software systems of which were designed with fairness in mind demonstrating that i even when fairness is a design goal developers can easily introduce discrimination in software and ii themis is an effective fairness testing tool.
themis requires a schema for generating inputs but does not require an oracle.
our causal fairness definition is designed specifically to be testable unlike definitions that require probabilistic estimation or knowledge of the future .
software testing offers a unique opportunity to conduct causal experiments to determine statistical causality one can run the software on an input e.g.
a defendant s criminal record modify a specific input characteristic e.g.
the defendant s race and observe if that modification causes a change in the output.
we define software to be causally 499fairness testing testing software for discrimination esec fse september paderborn germany fair with respect to input characteristic if for all inputs varying the value of does not alter the output.
for example a sentencerecommendation system is fair with respect to race if there are no two individuals who differ only in race but for whom the system s sentence recommendations differs.
in addition to capturing causality this definition requires no oracle the equivalence of the output for the two inputs is itself the oracle which helps fully automate test generation.
the rest of this paper is structured as follows.
section provides an intuition to fairness measures and section formally defines software fairness.
section describes themis our approach to fairness testing.
section evaluates themis.
finally section places our work in the context of related research and section summarizes our contributions.
software fairness measures suppose a bank employs loan software to decide if loan applicants should be given loans.
loan inputs are each applicant s name age race income savings employment status and requested loan amount and the output is a binary give loan or do not give loan .
for simplicity suppose age and race are binary with age either or and race either green orpurple .
some prior work on measuring and removing discrimination from algorithms has focused on what we callgroup discrimination which says that to be fair with respect to an input characteristic the distribution of outputs for each group should be similar.
for example the loan software is fair with respect to age if it gives loans to the same fractions of applicants 40and .
to be fair with respect to multiple characteristics for example age and race all groups with respect to those characteristics purple purple green and green should have the same outcome fractions.
the calders verwer cv score measures the strength of group discrimination as the difference between the largest and the smallest outcome fractions if of people 40get the loan and of people 40get the loan then loan is40 group discriminating.
while group discrimination is easy to reason about and measure it has two inherent limitations.
first group discrimination may fail to observe some discrimination.
for example suppose that loan produces different outputs for two loan applications that differ in race but are otherwise identical.
while loan clearly discriminates with respect to race the group discrimination score will be if loan discriminates in the opposite way for another pair of applications.
second software may circumvent discrimination detection.
for example suppose loan recommends loans for a random of the purple applicants and the of the green applicants who have the most savings.
then the group discrimination score with respect to race will deem loan perfectly fair despite a clear discrepancy in how the applications are processed based on race.
to address these issues we define a new measure of discrimination.
software testing enables a unique opportunity to conduct causal experiments to determine statistical causation between inputs and outputs.
for example it is possible to execute loan on two individuals identical in every way except race and verify if changing the race causes a change in the output.
causal discriminationsays that to be fair with respect to a set of characteristics thesoftware must produce the same output for every two individuals who differ only in those characteristics.
for example the loan software is fair with respect to age and race if for all pairs of individuals with identical name income savings employment status and requested loan amount but different race or age characteristics loan either gives all of them or none of them the loan.
the fraction of inputs for which software causally discriminates is a measure of causal discrimination.
thus far we have discussed software operating on the full input domain e.g.
every possible loan application.
however applying software to partial input domains may mask or effect discrimination.
for example while software may discriminate on some loan applications a bank may care about whether that software discriminates only with respect to applications representative of their customers as opposed to all possible human beings.
in this case a partial input domain may mask discrimination.
if a partial input domain exhibits correlation between input characteristics it can effect discrimination.
for example suppose older individuals have on average higher incomes and larger savings.
if loan only considers income and savings in making its decision even though it does not consider age for this population loan gives loans to a higher fraction of older individuals than younger ones.
we call the measurement of group or causal discrimination on a partial input domain apparent discrimination .
apparent discrimination depends on the operational profile of the system system s use .
apparent discrimination is important to measure.
for example amazon.com inc. software that determined where to offer free same day delivery did not explicitly consider race but made racecorrelated decisions because of correlations between race and other input characteristics .
despite the algorithm not looking at race explicitly amazon.com inc. would have preferred to have tested for this kind of discrimination.
formal fairness definitions we make two simplifying assumptions.
first we define software as a black box that maps input characteristics to an output characteristic.
while software is in general more complex for the purposes of fairness testing without loss of generality this definition is sufficient all user actions and environmental variables are modeled as input characteristics and each software effect is modeled as an output characteristic.
when software has multiple output characteristics we define fairness with respect to each output characteristic separately.
the definitions can be extended to include multiple output characteristics without significant conceptual reformulation.
second we assume that the input characteristics and the output characteristic are categorical variables each having a set of possible values e.g.
race gender eye color age ranges income ranges .
this assumption simplifies our measure of causality.
while our definitions do not apply directly to non categorical input and output characteristics such as continuous variables e.g.
intand double they and our techniques can be applied to software with non categorical input and output characteristics by using binning e.g.
age andage .
the output domain distance function definition .
illustrates one way our definitions can be extended to continuous variables.
future work will extend our discrimination measures directly to a broader class of data types.
500esec fse september paderborn germany sainyam galhotra yuriy brun and alexandra meliou acharacteristic is a categorical variable.
an input type is a set of characteristics an input is a valuation of an input type assignment of a value to each characteristic and an output is a single characteristic.
definition .
characteristic .
letlbe a set of value labels.
a characteristic over lis a variable that can take on the values in l. definition .
input type and input .
for all n n letl1 l2 .
.
.
lnbe sets of value labels.
then an input type xover those value labels is a sequence of characteristics x 1 2 .
.
.
n where for all i n iis a characteristic over li.
an input of type xisk l1 l1 l2 l2 .
.
.
ln ln a valuation of an input type.
we say the sizes of input kand of input type xaren.
discrimination can be measured in software that makes decisions.
when the output characteristic is binary e.g.
give loan vs. do not give loan the significance of the two different output values is clear.
when outputs are not binary identifying potential discrimination requires understanding the significance of differences in the output.
for example if the software outputs an ordering of hotel listings that may be influenced by the computer you are using as was the case when software used by orbitz led apple users to higher priced hotels domain expertise is needed to compare two outputs and decide the degree to which their difference is significant.
the output domain distance function encodes this expertise mapping pairs of output values to a distance measure.
definition .
output domain distance function .
letlobe a set of value labels.
then for all lo1 lo2 lo the output distance function is lo lo such that lo1 lo2 lo1 lo2 .
the output domain distance function generalizes our work beyond binary outputs.
for simplicity of exposition for the remainder of this paper we assume software outputs binary decisions a natural domain for fairness testing.
while true orfalse outputs corresponding to decisions such as give loan vs. do not give loan are easier to understand the output domain distance function enables comparing non binary outputs in two ways.
first a threshold output domain distance function can determine when two outputs are dissimilar enough to warrant potential discrimination.
second a relational output domain distance function can describe how different two inputs are and how much they contribute to potential discrimination.
definitions .
.
.
and .
could be extended to handle non binary outputs by changing their exact output comparisons to fractional similarity comparisons using an output domain distance function similar to the way inputs have been handled in prior work .
definition .
decision software .
letn nbe an input size let l1 l2 .
.
.
lnbe sets of value labels let x 1 2 .
.
.
n be an input type and let kbe the set of all possible inputs of type x. decision software is a function s k true false .
that is when software sis applied to an input l1 l1 l2 l2 .
.
.
ln ln it produces true orfalse .
the group discrimination score varies from to and measures the difference between fractions of input groups that lead to the same output e.g.
the difference between the fraction of green andpurple individuals who are given a loan .
this definition is based on the cv score which is limited to a binary input type or a binary partitioning of the input space.
our definition extends to the more broad categorical input types reflecting the relative complexity of arbitrary decision software.
the group discrimination score with respect to a set of input characteristics is the maximum frequency with which the software outputs true minus the minimum such frequency for the groups that only differ in those input characteristics.
because the cv score is limited to a single binary partitioning that difference represents all the encoded discrimination information in that setting.
in our more general setting with multiple non binary characteristics the score focuses on the range difference between the maximum and minimum as opposed to the distribution.
one could consider measuring say the standard deviation of the distribution of frequencies instead which would better measure deviation from a completely fair algorithm as opposed to the maximal deviation for two extreme groups.
definition .
univariate group discrimination score d .letkbe the set of all possible inputs of size n nof type x 1 2 .
.
.
n over label values l1 l2 .
.
.
ln.
let software s k true false .
for all i n fix one characteristic i. that is let m li and for all m m letk mbe the set of all inputs with i l m. k mis the set of all inputs with the ithcharacteristic fixed to be l m. let p mbe the fraction of inputs k k msuch that s k true .
and letp p1 p2 .
.
.
pm .
then the univariate group discrimination score with respect to i denoted d i s ismax p min p .
for example consider loan software that decided to give loan to of green individuals and to of purple individuals.
when computing loan s group discrimination score with respect to race drace loan .
.
.
.
the multivariate group discrimination score generalizes the univariate version to multiple input characteristics.
definition .
multivariate group discrimination score d .for all .
.
.
n fix the characteristics .
.
.
.
that is let m l m l .
.
.
m l let m m m m .
.
.
m m and m m m m letk m m ... m be the set of all inputs with l m l m .
.
.
l m .
k m m ... m is the set of all inputs with the characteristic fixed to be l m characteristic fixed to be l m and so on.
let p m m ... m be the fraction of inputs k k m m ... m such thats k true .
and let pbe an unordered sequence of all p m m ... m .
then the multivariate group discrimination score with respect to .
.
.
denoted d ... s ismax p min p .
our causal discrimination score is a stronger measure of discrimination as it seeks out causality in software measuring the fraction of inputs for which changing specific input characteristics causes the output to change .
the causal discrimination score identifies changing which characteristics directly affects the output.
as a result for example while the group and apparent discrimination scores penalize software that gives loans to different fractions of 501fairness testing testing software for discrimination esec fse september paderborn germany individuals of different races the causal discrimination score penalizes software that gives loans to individuals of one race but not to otherwise identical individuals of another race.
definition .
multivariate causal discrimination score d .let kbe the set of all possible inputs of size n nof type x 1 2 .
.
.
n over label values l1 l2 .
.
.
ln.
let software s k true false .
for all .
.
.
n let .
.
.
be input characteristics.
then the causal discrimination score with respect to .
.
.
denoted d ... s is the fraction of inputs k ksuch that there exists an input k ksuch that kandk differ only in the input characteristics .
.
.
ands k s k .
that is the causal discrimination score with respect to .
.
.
is the fraction of inputs for which changing at least one of those characteristics causes the output to change.
thus far we have measured discrimination of the full input domain considering every possible input with every value of every characteristic.
in practice input domains may be partial.
a company may for example care about whether software discriminates only with respect to their customers recall section .
apparent discrimination captures this notion applying group or causal discrimination score measurement to a subset of the input domain which can be described by an operational profile .
definition .
multivariate apparent discrimination score .
let k kbe a subset of the input domain to s. then the apparent group discrimination score is the group discrimination score applied to k and the apparent causal discrimination score is the causal discrimination score applied to k as opposed to applied to the full k .
having defined discrimination we now define the problem of checking software for discrimination.
definition .
discrimination checking problem .
given an input type x decision software swith input type x and a threshold compute all x xsuch that dx s or dx s .
the themis solution this section describes themis our approach to efficient fairness testing.
to use themis the user provides a software executable a desired confidence level an acceptable error bound and an input schema describing the format of valid inputs.
themis can then be used in three ways themis generates a test suite to compute the software group or causal discrimination score for a particular set of characteristics.
for example one can use themis to check if and how much a software system discriminates against race and age.
given a discrimination threshold themis generates a test suite to compute all sets of characteristics against which a software group or causally discriminates more than that threshold.
given a manually written or automatically generated test suite or an operational profile describing an input distribution themis computes the apparent group or causal discrimination score for a particular set of characteristics.
for example one can use themis to check if a system discriminates against race on a specific population of inputs representative of the way thealgorithm computing group discrimination.
given a softwaresand a subset of its input characteristics x groupdiscrimination returns dx s the group discrimination score with respect to x with confidence conf and error margin .
groupdiscrimination s x conf 1mingroup maxgroup testsuite initialization 2foreach a where ais a value assignment for x do r initialize number of samples count initialize number of positive outputs while r max samples do r r k newrandominput x a new input kwith k.x a testsuite testsuite k add input to the test suite ifnotcached k then no cached executions of kexist compute s k evaluate software on input k cacheresult k s k cache the result else retrieve cached result s k retrievecached k ifs k then count count ifr sampling threshold then after sufficient samples check error margin p count r current proportion of positive outputs ifconf.zvalueq p p r then break achieved error with confidence conf maxgroup max maxgroup p mingroup min mingroup p 22return testsuite dx s maxgroup mingroup system will be used.
this method does not compute the score s confidence as it is only as strong as the developers confidence that test suite or operational profile is representative of realworld executions.
measuring group and causal discrimination exactly requires exhaustive testing which is infeasible for nontrivial software.
solving the discrimination checking problem definition .
further requires measuring discrimination over all possible subsets of characteristics to find those that exceed a certain discrimination threshold.
themis addresses these challenges by employing three optimizations test caching adaptive confidence driven sampling and sound pruning.
all three techniques reduce the number of test cases needed to compute both group and causal discrimination.
section .
describes how themis employs caching and sampling and section .
describes how themis prunes the test suite search space.
.
caching and approximation groupdiscrimination algorithm and causaldiscrimination algorithm present the themis computation of multivariate group and causal discrimination scores with respect to a set of characteristics.
these algorithms implement definitions .
and .
respectively and rely on two optimizations.
we first describe these optimizations and then the algorithms.
502esec fse september paderborn germany sainyam galhotra yuriy brun and alexandra meliou test caching.
precisely computing the group and causal discrimination scores requires executing a large set of tests.
however a lot of this computation is repetitive tests relevant to group discrimination are also relevant to causal discrimination and tests relevant to one set of characteristics can also be relevant to another set.
this redundancy in fairness testing allows themis to exploit caching to reuse test results without re executing tests.
test caching has low storage overhead and offers significant runtime gains.
adaptive confidence driven sampling.
since exhaustive testing is infeasible themis computes approximate group and causal discrimination scores through sampling.
sampling in themis is adaptive using the ongoing score computation to determine if a specified margin of error with a desired confidence level conf has been reached.
themis generates inputs uniformly at random using an input schema and maintains the proportion of samples p for which the software outputs true ingroupdiscrimination or for which the software changes its output in causaldiscrimination .
the margin of error for pis then computed as error z r p p r where ris the number of samples so far and z is the normal distribution z score for the desired confidence level.
themis returns if error or generates another test otherwise.
groupdiscrimination algorithm measures the group discrimination score with respect to a subset of its input characteristics x .
as per definition .
groupdiscrimination fixes x to particular values line to compute what portion of all tests with x values fixed produce a true output.
the while loop line generates random input assignments for the remaining input characteristics line stores them in the test suite and measures the count of positive outputs.
the algorithm executes the test if that execution is not already cached line otherwise the algorithm retrieves the software output from the cache line .
after passing the minimum sampling threshold line it checks if error margin is achieved with the desired confidence line .
if it is groupdiscrimination terminates the computation for the current group and updates the max andminvalues lines .
causaldiscrimination algorithm similarly applies test caching and adaptive sampling.
it takes a random test k0 line and tests if changing any of its x characteristics changes the output.
if k0 result is not cached line the algorithm executes it and caches the result.
it then iterates through tests kthat differ from k0in one or more characteristics in x line .
all generated inputs are stored in the test suite.
the algorithm typically only needs to examine a small number of tests before discovering causal discrimination for the particular input line .
in the end causaldiscrimination returns the proportion of tests for which the algorithm found causal discrimination line .
.
sound pruning measuring software discrimination definition .
involves executinggroupdiscrimination andcausaldiscrimination over each subset of the input characteristics.
the number of these executions grows exponentially with the number of characteristics.
themis relies on a powerful pruning optimization to dramatically reduce thealgorithm computing causal discrimination.
given a softwaresand a subset of its input characteristics x causaldiscrimination returns dx s the causal discrimination score with respect to x with confidence conf and error margin .
causaldiscrimination s x conf 1count r testsuite initialization 2while r max samples do r r k0 newrandominput new input without value restrictions testsuite testsuite k0 add input to the test suite ifnotcached k0 then no cached executions of k0exist compute s k0 evaluate software on input k0 cacheresult k0 s k0 cache the result else retrieve cached result s k0 retrievecached k0 foreach k k k k0 x k. k0.
do all inputs that match k0in every characteristic x testsuite testsuite k add input to the test suite ifnotcached k then no cached executions of kexist compute s k evaluate software on input k cacheresult k s k cache the result else retrieve cached result s k retrievecached k ifs k s k0 then causal discrimination count count break ifr sampling threshold then once we have sufficient samples check error margin p count r current proportion of positive outputs ifconf.zvalueq p p r then break achieved error with confidence conf 25return testsuite dx s p number of evaluated characteristics subsets.
pruning is based on a fundamental monotonicity property of group and causal discrimination if a software sdiscriminates over threshold with respect to a set of characteristics x then salso discriminates over threshold with respect to all superset of x .
once themis discovers that s discriminates against x it can prune testing all supersets of x .
next we formally prove group theorem .
and causal theorem .
discrimination monotonicity.
these results guarantee that themis pruning strategy is sound.
discriminationsearch algorithm uses pruning in solving the discrimination checking problem.
as section .
will evaluate empirically pruning leads to on average a two to three order of magnitude reduction in test suite size.
theorem .
group discrimination monotonicity .
letxbe an input type and let sbe a decision software with input type x. then for all sets of characteristics x x x x x dx s dx s .
proof.
let dx s .
recall definition .
that to compute dx s we partition the space of all inputs into equivalence classes 503fairness testing testing software for discrimination esec fse september paderborn germany algorithm discrimination search.
given a software swith input type xand a discrimination threshold discriminationsearch identifies all minimal subsets of characteristics x xsuch that the group or causal discrimination score ofswith respect to x is greater than with confidence conf and error margin .
discriminationsearch s conf 1d initialize discriminating subsets of characteristics 2fori .
.
.
x do foreach x x x ido check subsets of size i discriminates false forx ddo ifx x then supersets of a discriminating set discriminate theorems .
and .
discriminates true break ifdiscriminates then continue do not store x dalready contains a subset testsuite d discrimination s x conf testsfor group or causal discrimination with respect to x ifd then x is a minimal discriminating set d.append x such that all elements in each equivalence class have identical value labels assigned to each characteristic in x then compute the frequencies with which inputs in each equivalence class lead sto a true output and finally compute the difference between the minimum and maximum of these frequencies.
let p and p be those maximum and minimum frequencies and k and k be the corresponding equivalence classes of inputs.
now consider the computation of dx s .
note that the equivalence classes of inputs for this computations will be strict subsets of the equivalence classes in the computation.
in particular the equivalence subset k will be split into several equivalence classes which we call k k .
.
.there are two possibilities either the frequency with which the inputs in each of these subclasses lead sto a true output equal the frequency of k or some subclasses have lower frequencies and some have higher than k since when combined they must equal that of k .
either way the maximum frequency of the k k .
.
.
k j subclasses is k .
and therefore the maximum overall frequency p for all the equivalence classes in the computation of is p .
by the same argument the minimum overall frequency p for all the equivalence classes in the computation of is p .
therefore p p p p and therefore x x dx s dx s .
theorem .
causal discrimination monotonicity .
letx be an input type and let sbe a decision software with input type x. then for all sets of characteristics x x x x x dx s dx s .
proof.
recall definition .
that the causal discrimination score with respect to x is the fraction of inputs for which changingthe value of at least one characteristic in x changes the output.
consider k the entire set of such inputs for x and similarly k the entire set of such inputs for x .
since x x every input in k must also be in k because if changing at least one characteristic inx changes the output and those characteristics are also in x .
therefore the fraction of such inputs must be no smaller for x than for x and therefore x x dx s dx s .
a further opportunity for pruning comes from the relationship between group and causal discrimination.
as theorem .
shows if software group discriminates against a set of characteristics it must causally discriminate against that set at least as much.
theorem .
.
letxbe an input type and let sbe a decision software with input type x. then for all sets of characteristics x x dx s dx s .
proof.
let dx s .
recall definition .
that to compute dx s we partition the space of all inputs into equivalence classes such that all elements in each equivalence class have identical value labels assigned to each characteristic in x .
it is evident that same equivalence class inputs have same values for characteristics in x and the ones in different equivalence classes differ in at least one of the characteristics in x .
now dx s means that for fraction of inputs the output istrue and after changing just some values of x producing an input in another equivalence class the output is false .
this is because if there were fraction of inputs with a different output when changing the equivalence classes then dx s would have been .
hence dx s .
evaluation in evaluating themis we focused on two research questions rq1 does research on discrimination aware algorithm design e.g.
produce fair algorithms?
rq2 how effective do the optimizations from section make themis at identifying discrimination in software?
to answer these research questions we carried out three experiments on twenty instances of eight software systems that make financial decisions.1seven of the eight systems seventeen out of the twenty instances are written by original system developers we reimplemented one of the systems three instances because original source code was not available.
eight of these software instances use standard machine learning algorithms to infer models from datasets of financial and demographic data.
these systems make no attempt to avoid discrimination.
the other twelve instances are taken from related work on devising discrimination aware algorithms .
these software instances use the same datasets and attempt to infer discrimination free solutions.
four of them focus on not discriminating against race and eight against gender.
section .
describes our subject systems and the two datasets they use.
1we use the term system instance to mean instantiation of a software system with a configuration using a specific dataset.
two instances of the same system using different configurations and different data are likely to differ significantly in their behavior and in their discrimination profile.
504esec fse september paderborn germany sainyam galhotra yuriy brun and alexandra meliou .
subject software systems our twenty subject instances use two financial datasets.
the adult dataset also known as the census income dataset 2contains financial and demographic data for 45k individuals each individual is described by attributes such as occupation number of work hours capital gains and losses education level gender race marital status age country of birth income etc.
this dataset is well vetted it has been used by others to devise discriminationfree algorithms as well as for non discrimination purposes .
the statlog german credit dataset3contains credit data for individuals classifying each individual as having good or bad credit and including other pieces of data for each individual such as gender housing arrangement credit history years employed credit amount etc.
this dataset is also well vetted it has been used by others to devise discrimination free algorithms as well as for non discrimination purposes .
we use a three parameter naming scheme to refer to our software instances.
an example of an instance name is acensusrace .
the a refers to the system used to generate the instance described next .
the census refers to the dataset used for the system instance.
this value can be census for the adult census income dataset or credit for the statlog german credit dataset.
finally the race refers to a characteristic the software instance attempts to not discriminate against.
in our evaluation this value can be race or gender for the census dataset and can only be gender for the credit dataset.
some of the systems make no attempt to avoid discrimination and their names leave this part of the label blank.
prior research has attempted to build discrimination free systems using these two datasets .
we contacted the authors and obtained the source code for three of these four systems a c and d and reimplemented the other b ourselves.
we verified that our reimplementation produced results consistent with the the evaluation of the original system .
we additionally used standard machine learning libraries as four more discrimination unaware software systems e f g and h on these datasets.
we used scikit learn for e naive bayes g logistic regression and h support vector machines and a publicly available decision tree implementation forfand for our reimplementation of b. the four discrimination free software systems use different methods to attempt to reduce or eliminate discrimination ais a modified logistic regression approach that constrains the regression s loss function with the covariance of the characteristics distributions that the algorithm is asked to be fair with respect to .
bis a modified decision tree approach that constrains the splitting criteria by the output characteristic as the standard decision tree approach does and also the characteristics that the algorithm is asked to be fair with respect to .
cmanipulates the training dataset for a naive bayes classifier.
the approach balances the dataset to equate the number of 4the credit dataset combines marital status and gender into a single characteristic we refer to it simply as gender in this paper for exposition.
the credit dataset does not include race.inputs that lead to each output value and then tweaks the dataset by introducing noise of flipping outputs for some inputs and by introducing weights for each datapoint .
dis a modified decision tree approach that balances the training dataset to equate the number of inputs that lead to each output value removes and repeats some inputs and flips output values of inputs close to the decision tree s decision boundaries introducing noise around the critical boundaries .
configuring the subject systems.
the income characteristic of the census dataset is binary representing the income being above or below .
most prior research developed systems that use the other characteristics to predict the income we did the same.
for the credit dataset the systems predict if the individual s credit is good or bad .
we trained each system separately on the census and credit datasets.
thus for example the gcreditinstance is the logistic regression based system trained on the credit dataset.
for the census dataset we randomly sampled .5k individuals to balance the number who make more than and less than and trained each system on the sampled subset using characteristics to classify each individual as either having above or below income.
for the credit dataset we similarly randomly sampled individuals to balance the number with good and bad credit and trained each system on the sampled subset using the characteristics to classify each individual s credit as good or bad .
each discrimination aware system can be trained to avoid discrimination against sensitive characteristics.
in accord with the prior work on building these systems we chose gender and race as sensitive characteristics.
using all configurations exactly as described in the prior work we created instances of each discrimination aware system.
for example for system a we have acensus genderand acensusrace two instances trained on the census data to avoid discrimination on gender and race respectively and acredit gender an instance trained on the credit data to avoid discrimination on gender.
the left column of figure lists the twenty system instances we use as subjects.
.
race and gender discrimination we used themis to measure the group and causal discrimination scores for our twenty software instances with respect to race and separately with respect to gender.
figure presents the results.
we make the following observations themis is effective.
themis is able to verify that many of the software instances do not discriminate against race and gender and identify the software that does.
discrimination is present even in instances designed to avoid discrimination.
for example a discrimination aware decision tree approach trained not to discriminate against gender bcensus gender had a causal discrimination score over more than of the individuals had the output flipped just by altering the individual s gender.
the causal discrimination score detected critical evidence of discrimination missed by the group score.
often the group and causal discrimination scores conveyed the same information but there were cases in which themis detected causal discrimination even though the group discrimination score was 505fairness testing testing software for discrimination esec fse september paderborn germany system race gender instance group causal group causal acredit gender .
.
acensus gender2.
.
.
.
acensusrace .
.
.
.
bcredit gender .
.
bcensus gender36.
.
.
.
bcensusrace .
.
.
.
ccredit gender .
.
ccensus gender2.
.
.
.
ccensusrace .
.
.
.
dcredit gender .
.
dcensus gender0.
.
.
.
dcensusrace .
.
.
.
ecredit .
.
ecensus0.
.
.
.
fcredit .
.
fcensus0.
.
.
.
gcredit .
.
gcensus0.
.
.
.
hcredit .
.
hcensus .
.
.
.
figure the group and causal discrimination scores with respect to race and gender.
some numbers are missing because the credit dataset does not contain information on race.
low.
for example for bcensus gender the causal score was more than higher than the group score .
vs. .
.
today s discrimination aware approaches are insufficient.
the bapproach was designed to avoid a variant of group discrimination as are other discrimination aware approaches but this design is at least in some conditions insufficient to prevent causal discrimination.
further focusing on avoiding discriminating against one characteristic may create discrimination against another e.g.
bcensus genderlimits discrimination against gender but discriminates against race with a causal score of .
.
there is no clear evidence that discrimination aware methods outperform discrimination unaware ones.
in fact the discrimination unaware approaches typically discriminated less than their discrimination aware counterparts with the exception of logistic regression.
.
computing discriminated against characteristics to evaluate how effective themis is at computing the discrimination checking problem definition .
we used themis to compute the sets of characteristics each of the twenty software instances discriminates against causally.
for each instance we first used a threshold of to find all subsets of characteristics against which the instance discriminated.
we next examined the discrimination withacensusrace d r .
ccensus gender d m .
bcensus gender d m r .
dcensus gender d m .
d r .
d c .
d .
dcensusrace d m .
d m .
d m r .
d r .
ecensus d m .
bcensusrace d .
fcensus d c r .
ccredit gender d a .
d r e .
ccensusrace d a .
gcensus d e .
d .
d r .
figure sets of sensitive characteristics that the subject instances discriminate against causally at least and that contribute to subsets of characteristics that are discriminated against at least .
we abbreviate sensitive characteristics as a ge c ountry g ender m arital status r ace and r e lation.
respect to each of the characterists in those sets individually.
finally we checked the causal discrimination scores for pairs of those characteristics that are sensitive as defined by prior work e.g.
race age marital status etc.
.
for example if themis found that an instance discriminated causally against capital gains race marital status we checked the causal discrimination score for capital gains race marital status and then race marital status .
figure reports which sensitive characteristics each instance discriminates against by at least .
themis was able to discover significant discrimination.
for example bcensus genderdiscriminates against gender marital status and race with a causal score of .
.
that means for .
of the individuals changing only the gender marital status or race causes the output of the algorithm to flip.
even worse fcensusdiscriminates against country and race with a causal score of .
.
it is possible to build an algorithm that appears to be fair with respect to a characteristic in general but discriminates heavily against that characteristic when the input space is partitioned by another characteristic.
for example an algorithm may give the same fraction of white and black individuals loans but discriminate against black canadian individuals as compared to white canadian individuals.
this is the case with bcensus gender for example as its causal discrimination score against gender is .
but against gender marital status and race is .
.
prior work on fairness has not considered this phenomenon and these findings suggest that the software designed to produce fair results sometimes achieved fairness at the global scale by creating severe discrimination for certain groups of inputs.
this experiment demonstrates that themis effectively discovers discrimination and can test software for unexpected software discrimination effects across a wide variety of input partitions.
.
themis efficiency and the pruning effect themis uses pruning to minimize test suites section .
.
we evaluated the efficiency improvement due to pruning by comparing the number of test cases needed to achieve the same confidence 506esec fse september paderborn germany sainyam galhotra yuriy brun and alexandra meliou group causal acredit gender934 .
.
acensusrace7 bcredit gender934 bcensusrace6 ccredit gender934 ccensusrace7 dcredit gender934 dcensusrace7 .
.
ecredit ecensus fcredit fcensus gcredit gcensus .
.
hcredit .
.
hcensus .
.
arithmetic mean geometric mean .
figure pruning greatly reduces the number of tests needed to compute both group and causal discrimination.
we present here the computation that is needed for the experiment of figure finding all subsets of characteristics for which the software instances discriminate with a score of at least for a confidence and error margin .
.
for each technique we show the number of tests needed without pruning divided by the number of tests needed with pruning and the resulting factor reduction in the number of tests.
for example reducing the number of tests needed to compute the group discrimination score from to 2ndrow is an improvement of a factor of .
and error bound with and without pruning.
figure shows the number of test cases needed for each of the twenty software instances to achieve a confidence level of and0.05error bound with and without pruning.
pruning reduces the number of test cases by on average a factor of 849for group and 148for causal discrimination.
the more a system discriminates the more effective pruning is making themis more efficient because pruning happens when small sets of characteristics discriminate above the chosen threshold.
such sets enable pruning away larger supersets of characteristics.
theorem .
formalizes this statement.
theorem .
pruning monotonicity .
letxbe an input type andsands be decision software with input types x. if for all x x dx s dx s respectively dx s dx s then for all x x if themis can prune x when computing discriminationsearch s conf then it can also prune x when computing discriminationsearch s conf .
proof.
for themis to prune x when computing discriminationsearch s conf there must exist a set x x such that d x s .
since d x s d x s when computingdiscriminationsearch s conf themis can also prune x .
the same argument holds for group discrimination d. we measured this effect by measuring pruning while decreasing the discrimination threshold decreasing effectively simulates increasing system discrimination.
we verified that pruning increased when decreased or equivalently when discrimination increased .
for example themis needed tests to find sets of characteristics that bcredit genderdiscriminated with a score of more than .
but only tests when we reduced to .
.
similarly the number of tests for fcreditdropped from to when lowering from .
to .
.
this confirms that themis is more efficient when the benefits of fairness testing increase because the software discriminates more.
.
discussion in answering our two research questions we found that stateof the art approaches for designing fair systems often miss discrimination and themis can detect such discrimination via fairness testing.
themis is effective at finding both group and causal discrimination.
while we did not evaluate this directly themis can also measure apparent discrimination definition .
via a developer provided test suite or operational profile.
themis employs provably sound pruning to reduce test suite size and becomes more effective for systems that discriminate more.
overall pruning reduced test suite sizes on average two to three orders of magnitude.
related work software discrimination is a growing concern.
discrimination shows up in many software applications e.g.
advertisements hotel bookings and image search .
yet software is entering domains in which discrimination could result in serious negative consequences including criminal justice finance and hiring .
software discrimination may occur unintentionally e.g.
as a result of implementation bugs as an unintended property of self organizing systems as an emergent property of component interaction or as an automatically learned property from biased data .
some prior work on measuring fairness in machine learning classifiers has focused on the calders verwer cv score to measure discrimination .
our group discrimination score generalizes the cv score to the software domain with more complex inputs.
our causal discrimination score goes beyond prior work by measuring causality .
an alternate definition of discrimination is that a better input is never deprived of the better output .
that definition requires a domain expert to create a distance function for comparing inputs by contrast our definitions are simpler more generally applicable and amenable to optimization techniques such as pruning.
reducing discrimination cv score in classifiers as our evaluation has shown often fails to remove causal discrimination and discrimination against certain groups.
by contrast our work does not attempt to remove discrimination but offers developers a tool to identify and measure discrimination a critical first step in removing it.
problem specific discrimination measures e.g.
the contextual 507fairness testing testing software for discrimination esec fse september paderborn germany bandits problem have demonstrated that fairness may result in otherwise suboptimal behavior .
by contrast our work is general and we believe that striving for fairness may be a principal requirement in a system s design.
counterfactual fairness requires output probability distributions to match for input populations that differ only in the label value of a sensitive input characteristic .
counterfactual fairness is related to causal fairness but can miss some instances of discrimination e.g.
if loan shows preferential treatment forsome purple inputs but at the same time against some other similar purple inputs.
fairtest an implementation of the unwarranted associations framework uses manually written tests to measure four kinds of discrimination scores the cv score and a related ratio mutual information pearson correlation and a regression between the output and sensitive inputs.
by contrast our approach generates tests automatically and measures causal discrimination.
causal testing computes pairs of similar inputs whose outputs differ.
however input characteristics may correlate e.g.
education correlates with age so perturbing some characteristics without perturbing others may create inputs not representative of the real world.
fairml uses orthogonal projection to co perturb characteristics which can mask some discrimination but find discrimination that is more likely to be observed in real world scenarios somewhat analogously to our apparent discrimination measure.
combinatorial testing minimizes the number of tests needed to explore certain combinations of input characteristics.
for example all pairs testing generates tests that evaluate every possible value combination for every pair of input characteristics which can be particularly helpful when testing software product lines .
the number of tests needed to evaluate every possible value pair can be significantly smaller than the exhaustive testing alternative since each test can simultaneously contribute to multiple value pairs .
such combinatorial testing optimizations are complementary to our work on discrimination testing.
our main goal is to develop a method to process test executions to measure software discrimination whereas that is not a goal of combinatorial testing.
advances in combinatorial testing e.g.
using static or dynamic analyses for vacuity testing or to identify configuration options that cannot affect a test s output can directly improve efficiency of discrimination testing by identifying that changing a particular input characteristic cannot affect a particular test s output and thus no causal discrimination is possible with respect to that particular input.
we leave such optimizations to future work.
it is possible to test for discrimination software without explicit access to it.
for example adfisher collects information on how changes in google ad settings and prior visited webpages affect the ads google serves.
adfisher computes a variant of group discrimination but it could be integrated with themis and its algorithms to measure causal discrimination.
themis measures apparent discrimination by either executing a provided test suite or by generating a test suite following a provided operational profile.
operational profiles describe the input distributions likely to be observed in the field.
because developer written test suites are often not as representative of field executions as developers would like operational profiles cansignificantly improve the effectiveness of testing by more accurately representing real world system use and the use of operational profiles has been shown to more accurately measure system properties such as reliability .
the work on operational profiles is complementary to ours themis uses operational profiles and work on more efficient test generation from operational profiles can directly benefit discrimination testing.
meanwhile no prior work on operational profile testing has measured software discrimination.
causal relationships in data management systems can help explain query results and debug errors by tracking and using data provenance .
for software systems that use data management such provenance based reasoning may aid testing for causal relationships between input characteristics and outputs.
our prior work on testing software that relies on data management systems has focused on data errors whereas this work focuses on testing fairness.
automated testing research has produced tools to generate tests including random testing such as randoop nighthawk jcrasher carfast and t3 search based testing such as evosuite testful and etoc dynamic symbolic execution tools such as dsc symbolic pathfinder jcute seeker symstra and pex among others and commercial tools such as agitar .
the goal of the generated tests is typically finding bugs or generating specifications .
these tools deal with more complex input spaces than themis but none of them focus on testing fairness and they require oracles whereas themis does not need oracles as it measures discrimination by comparing tests outputs.
future work could extend these tools to generate fairness tests modifying test generation to produce pairs of inputs that differ only in the input characteristics being tested.
while prior work has tackled the oracle problem typically using inferred pre and post conditions or documentation our oracle is more precise and easier to compute but is only applicable to fairness testing.
contributions we have formally defined software fairness testing and introduced a causality based measure of discrimination.
we have further described themis an approach and its open source implementation for measuring discrimination in software and for generating efficient test suites to perform these measurements.
our evaluation demonstrates that discrimination in software is common even when fairness is an explicit design goal and that fairness testing is critical to measuring discrimination.
further we formally prove soundness of our approach and show that themis effectively measures discriminations and produces efficient test suites to do so.
with the current use of software in society critical ways fairness testing research is becoming paramount and our work presents an important first step in merging testing techniques with software fairness requirements.
acknowledgment this work is supported by the national science foundation under grants no.
ccf iis and cns .
508esec fse september paderborn germany sainyam galhotra yuriy brun and alexandra meliou