understanding and detecting callback compatibility issues for android applications huaxun huang the hong kong university of science and technology hong kong china hhuangas cse.ust.hklili wei the hong kong university of science and technology hong kong china lweiae cse.ust.hk yepang liu southern university of science and technology shenzhen china liuyp1 sustc.edu.cnshing chi cheung the hong kong university of science and technology hong kong china scc cse.ust.hk abstract the control flows of android apps are largely driven by the protocols that govern how callback apis are invoked in response to various events.
when these callback apis evolve along with the android framework the changes in their invocation protocols can induce unexpected control flows to existing android apps causing various compatibility issues.
we refer to these issues as callback compatibility issues.
while android framework updates have received due attention little is known about their impacts on appcontrol flows and the callback compatibility issues thus induced.
to bridge the gap we examined android documentations and conducted an empirical study on real world callback compatibility issuestoinvestigatehowtheseissueswereinducedbycallbackapi evolutions.basedonourempiricalfindings weproposeagraphbased model to capture the control flow inconsistencies caused by api evolutions and devise a static analysis technique cider to detect callbackcompatibility issues.our evaluationof cider on 20popular open source android apps shows that cider is effective.
itdetected new callback compatibility issues in these apps among which issues were confirmed and issues were fixed.
ccs concepts software and its engineering software verification and validation human centeredcomputing smartphones general and reference empirical studies keywords androidapi empiricalstudy staticanalysis callbackcompatibility shing chicheungandyepangliuarethecorrespondingauthors.liliweiisalsoa visiting student at the southern university of science and technology.
permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed forprofitorcommercialadvantageandthatcopiesbearthisnoticeandthefullcitation on the first page.
copyrights for components of this work owned by others than acmmustbehonored.abstractingwithcreditispermitted.tocopyotherwise orrepublish topostonserversortoredistributetolists requirespriorspecificpermissionand ora fee.
request permissions from permissions acm.org.
ase september montpellier france association for computing machinery.
acm isbn ... .
reference format huaxun huang lili wei yepang liu and shing chi cheung.
.
understanding and detecting callback compatibility issues for android applications.
inproceedings of the 33rd acm ieee international conference on automated software engineering ase september montpellier france.acm newyork ny usa 11pages.
introduction androidappsareevent driven.
callbackapis overriddenandimplemented in android apps are invoked by the underlying operating system in response to various events.
the control flows of androidappsarelargelydrivenbythecallbackapiinvocationprotocols whichdefinehowcallbackapisareinvokedtohandleevents.
however callbackapisarefastevolvingalongwiththeandroid system .suchevolutionscanchangecallbackapiinvocation protocolsandcauseappstoexhibitinconsistentcontrolflowswhen runningondifferentversionsofandroidsystem.theseinconsistencies make it difficult for app developers to correctly maintain programdependenciesamongdifferentoverriddencallbackapis across different api levels.
as a result various compatibility issues arose.inthispaper werefertosuchissuesinducedbycallbackapi evolutions as callback compatibility issues.
severaltechniqueshavebeendevisedtohelpanalyzethecontrol flowsamongcallbackapisforandroidapps.forexample flowdroid can construct dummy main methods to emulate the execution orders of lifecycle callback apis for activity components of android apps.
barros et al.
also presented a technique to detectimplicitcontrolflowsinandroidprograms.whilethesetechniques helprecover controlflows for androidapps noneof them canidentifyinconsistentappcontrolflowscausedbythecallback apievolutions.researchershavealsostudiedtheevolutionsofandroid apis.
linares et al.
analyzed how change proneness and error pronenessofandroidapisaffecttheratingsofandroidapps.mcdonnelletal.
analyzedthehistoricaldataofasetofandroid apps to understand the relationship between api evolutions and api adoption.
wei et al.
conducted the first longitudinal study on the evolutions of permissions in the android ecosystem.
weiet al.
investigated the fragmentation induced compatibility issuesinandroidappsincludingthosethatareinducedbyandroid apievolutions.whilethesepiecesofworkstudiedtheevolutions of android apis none of them considered the changes in callback authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
ase september montpellier france huaxun huang lili wei yepang liu and shing chi cheung api invocation protocols introduced by these evolutions and the control flow inconsistencies thus induced to android apps.
in this paper we first study the evolutions of callback apis to see how they can affect the invocation protocols of callback apis.
we characterize the callback compatibility issues induced by such theevolutions.
to thisend we conductedan empirical study based on the api reference in android developers android api differences reports android open source project and 100callbackcompatibilityissuesfrom50open sourceandroidapps.
our study aims to answer the following two research questions rq1 callback api evolutions and invocation protocols howdotheevolutions ofcallbackapischangethe apiinvocationprotocols?
are there any frequently evolved callback apis?
rq2 causes of callback compatibility issues how do the evolutions of callback apis induce callback compatibility issues?
are there major issue inducing causes?
in answering rq1 we identified two common types of callback api evolutions api reachability change andapi behavioral modification.theformertypechangesthereachabilityofcallbackapis while the latter type changes the invocation conditions and behaviors of the concerned callback apis.
both of the two types of changes in callback api evolutions can alter app control flows and induce callback compatibility issues.
in answering rq2 we observedthatcallbackcompatibilityissuescommonlyaroseifapps fail to properly handle inconsistent control flows induced by the callbackapievolutions.thismotivatesustoproposeagraph basedmodeltocapturesuchinconsistentappcontrolflowswhenrunning on different api levels for the analysis of callback compatibility issues.
basedontheseobservations weproposecider a callbackcompatibility issuedetectorbasedonstaticanalysis.itleveragesour proposed graph based model to generate callback control flow graphs capturing inconsistent control flows of callback apis in androidapps.toevaluatetheperformanceof cider weapplied it to real world open source android projects collected from github .
cider successfully detected previously unknown callbackcompatibilityissues achieving92.
precision.itsignificantly outperformed lint a widely used static analyzer for androidapps bydetectingmorecallbackcompatibilityissueswhile generatingmuchfewerfalsepositives.wereportedourdetected issuestotheoriginaldevelopersofthecorrespondingandroidapps for their feedback.
among the issues were confirmed by the developers and nine of them were fixed shortly afterwards.
this showsthatcidercanpreciselydetectcallbackcompatibilityissues ofinterest tothe androidapp developers.insummary thispaper makes the following contributions we conducted an empirical study to understand the callback apievolutionsintheandroidofficialdocumentsandframework code andfurthercharacterizedtheirimpactonappcontrolflows.
we also investigated the changes in callback api invocation protocolsandidentifiedmajorcausesofcallbackcompatibility issues.
our dataset is available at .
we formulated a graph based model to capture app control flow inconsistenciesinducedbycallbackapievolutions.basedonthis model weproposedastaticanalysistechniquecidertodetect callback compatibility issues in android apps.
!
!
!
!
!
figure a ccfg with five callback apis.
weevaluatedcideron20open sourceandroidapps.cideroutperformedawidely usedstaticanalyzer lint andsuccessfully detected13previously unknowncallbackcompatibilityissues of which were confirmed or fixed by the app developers.
background callbackapisandcallbackcontrolflowgraph.
androidapps are event driven.
callback apis see figure 1for examples encapsulatecodethatshouldbeexecutedtohandlevarioussystemand user events.
due to the event driven paradigm control flows of an android app are mainly determined by flow of triggering events.
in other words an android app s execution is largely driven by control flows across callback apis.
inthispaper weleveragetheconceptof callbackcontrolflow graph ccfg tocapturethecontrolflowsbetweencallbackapis in android apps and discuss the issues induced by the evolution of the callback apis.
ccfg was introduced by yang et al.
to aid control flow analysis for android apps.
figure 1shows an example of a simplified ccfg.
a ccfg is a directed graph that consists of two types of nodes callback node andhelper node.
callback nodes represent the invocations of callback apis while helper nodes represent branch and join points of control flows.
as shown infigure therearefivecallbacknodesintheccfg eachofwhich islabeledwiththenameofthecorrespondingcallbackapiandthe concerned library class.
node b1andj1are two helper nodes indicating that the subsequent callback apis of the branch node b1can be executed in any order until the join node j1is reached.
edges between the nodes in a ccfg represent the transfer of control flows between the nodes i.e.
the order of execution .
for example theedgebetweenthecallbacknodes onoptionsmenuselected and oncreateoptionsmenu indicates that the oncreateoptionsmenu callback will be invoked after the onoptionsmenuselected callback completes its execution.
androidapievolutionsandcallbackcompatibilityissues.
theandroidframeworkisfastevolving.by2017 therewerealready differentandroidapi levels .
eachapilevelintroducesapi authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
understanding and detecting callback compatibility issues for android applications ase september montpellier france !
.
.
.
!
.
.
.
!
.
.
.
.
figure the patch for wordpress issue .
updates for various purposes such as adding new features bug fixing performance optimization and code restructuring.
these updates can induce compatibility issues in android apps .
whilenon callbackapisareimplementedintheandroidframeworkandcanbedirectlyinvokedbyandroidapps callbackapis are invoked by the android system in response to occurred events.
callback apis are often overridden and customized by developers to implement app specific functionalities.
as the android framework evolves the callback apis and their invocation protocols also evolve.sincetheinvocationprotocolsofcallbackapisaffectapp control flows the evolutions of callback apis and changes in their invocation protocols can have significant influence on android apps runtime behavior.
various compatibility issues would arise if such changes which might be subtle are not timely identified and properlyhandled.thisisparticularlythecaseifanappcontainscertaincodethathascontrol datadependenciesonmultiplecallback apis.thismotivatesustostudyandroidcallback apievolutions and their induced compatibility issues which are referred to as callback compatibility issues hereafter.
motivating example this section presents an example to illustrate how callback api evolutionscaninducecallbackcompatibilityissuesanddiscusses the challenges of the issue detection.
the example is extracted from issue in wordpress a popular website and blog builderwithmorethan5milliondownloads.accordingtotheissue report wordpress would crash due to a nullpointerexception npeforshort causedbytheevolutionofalifecyclecallbackapiin afragment whichisanandroiduser interfacecomponentwithits ownlifecycle .inandroidapps a fragment slifecyclecallback apis need to be carefully implemented to respond to the events that would cause the fragment to change its lifecycle stage.
the crashwasinducedbyanewlifecyclecallback onattach context offragment whichwasintroducedatandroidapilevel23.the callbackcanbeimplementedtohandletheusereventsthatcausea !
a b figure the ccfg for the code snippet in figure .
fragment tobeattachedtoaparentcomponent.weexplainhow wordpressissue6906aroseduetothecallbackapievolutionbelow.
figure2gives the relevant code snippet of the crashing issue and the patch written by the developers.
in line the variable mactivity isinitializedinthecallback onattach context .the variableislaterusedinanothercallback onactivitycreated line .
figure 3shows the ccfg for the code snippet in figure .
the edges in figure a indicate the control flows between the concerned fragment callback apis at api level or higher.
according to the ccfg the following three callback apis will be invoked sequentially onattach context onattach activity andonactivitycreated .
however the callback api invocation sequence differswhen theapi levelis lower than23 where onattach context will be skipped and only onattach activity andonactivitycreated willbeinvokedasshowninfigure b .
this is because the callback api onattach context was first introducedatapilevel23andthusunavailableatapilevelslower than23.whenwordpressrunsonadevicewithanapilevellower than onattach context will not be invoked and the variable mactivity its default value is null will not be initialized.
as a result theinvocationof onactivitycreated willleadtoannpe.
tofixthisissue wordpressdevelopersrevisedthecodeof onattach activity to properly initialize mactivity if the runtime api level is lower than lines .
the above issue arose due to a ccfg inconsistency induced by the evolution of the callback api onattach context at api level .
the inconsistency affects the def use chain of the variable mactivity .sinceinter callbackdataflowsarecommoninandroid apps such callback api evolutions can easily induce compatibilityissues.todetectsuchissues wenotonlyneedtohaveadeep understanding of ccfg inconsistencies caused by callback api evolutions but also need to analyze the dependencies between app callbackapis.tothebestofourknowledge noneoftheexisting studies on android compatibility issues investigated the impact of callback api evolutions on app control data flows and intercallbackdependencies .tobridgethegap weconducted an empirical study to understand the callback compatibility issues inducedbycallbackapievolutionsinandroid.thestudyresults further guided us to design a technique to automatically detect the issues.
empirical study methodology .
study setup for answering rq1 toanswerrq1 weconductanempiricalstudytounderstandthe evolutions of android callback apis and the changes in callback api invocation protocols.
the empirical data come from the api authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
ase september montpellier france huaxun huang lili wei yepang liu and shing chi cheung table keywords used in rq2.
compatibility compatible compat deprecated deprecation honeycomb kitkat jellybean icecreamsandwich lollipop marshmallow nougat gingerbread oreo api build.version reference in android developers android api differences reports andtheandroidopensourceproject .inorderto haveacomprehensiveunderstandingofthecallbackapievolutions wechosetoanalyzetheandroidframeworkfromapilevel1.we describe the process in the following.
wefirstneedtolocatealistofcallbackapisfromtheapireferencesinceitdoesnotprovidealistofcallbackapis.toachievethis we study the specifications of well known callback apis triggered bythelifecycleeventsof activity fragment andservice which arethekeycomponentsofandroidapps.weidentifiedthecommon characteristicsoftheseapispecificationsandformulatedoursearchcriteriatolocatecallbackapis.specifically wecollectedthreekinds of apis the apis whose name starts with on the apis whose description includes keywords callback or listener theapiswhosedescriptioncontainsentenceswithatleastoneword from each of the following two sets of keywords case insensitive called invoked notified and when before after .w e treatedtheseapisascallbackapicandidatesandextractedtheir information from api reference.
as a result we identified 589callback api candidates out of android framework apis.
then two of the authors cross examined these api candidatestofurtherfilteroutnoisesinthesetofcandidatesandkept onlycallbackapisfortheempiricalstudy.eventually wecollected2 589callbackapistoformourcallbackapilist denotedas lapi .
we further identify the evolutions of the callback apis in lapi.
however simplyanalyzingtheapireferenceisinadequatebecause such a constantly evolving document can be incomplete e.g.
they do not provide information for certain removed apis .
to obtain morecompleteinformationofandroidcallbackapis wefurther analyzed android api differences reports which provide the full history of android framework api updates.
for each callback api update wethenstudieditsassociatedcodecommitsintheandroid open source project aosp for short .
specifically we studied thecodechanges relatedcommentsandcommitlogstounderstand how each update affects the callback api invocation protocol.
.
study setup for answering rq2 in rq2 we aim to understand how callback api evolutions canaffect the software quality of android apps and characterize the inducedcallbackcompatibilityissues.toachievethis weneedto constructa datasetofcallback compatibilityissuesfromreal world android apps.for data collection we searchedtwo popular opensource app hosting platforms f droid and github .
we collectedtheandroidappsthat haveatleastonecommitafter october actively maintained have received at least stars popular and haveapublicissuetrackingsystem traceable .thisresultedinasetof275apps.forthese275candidateapps we further searched for patched callback compatibility issues by mining their code repository.
specifically we searched for commitlogs issue reports and code diffs that contain the keywords listed in table1.
these keywords include the names of major api levels the name of the commonly used class to check the runtime api level build.version andseveralgeneraltermsrelatedtocompatibility e.g.
weobservedthatdevelopersoftenuse api torepresent apilevel whendiscussingissues .toensuretheusefulnessofthe dataset we only collected callback compatibility issues that can occur on devices with an api level or above older api versions havenomarketshare .asaresult weobtained100realcallback compatibilityissuesfrom50outofthe275appsasourempirical studydataset.foreachcollectedissue wecarefullyidentifiedthe evolved callback apis and studied how the callback api evolutions affected the concerned app s ccfg and induced callback compatibility issues.
we also analyzed the corresponding issue reports and issue fixingcodecommits whichcontainpatches tounderstand the practices of android developers to fix callback compatibility issues.
empirical study results .
rq1 callback api evolutions and invocation protocols asdiscussedearlier toanswerrq1 weidentifiedtheupdatesfor each callback api in lapi.
in the resulting dataset we observed four ways of callback api evolutions api introduction api deprecation apibehavioralmodification andapiremoval.wefurther examinedthecodecommitsinaospthatintroducedtheupdatesof callbackapistostudythecommonchangesintheapis invocation protocols.
we present our findings in this section.
.
.
callback api invocation protocol change.
there are two majorcategoriesofchangestothecallbackapis invocationprotocols due to callback api evolutions.
reachability change.
in most cases a callback api s reachability is changed when it evolves making it accessible only at specific android api levels.
for example the onattach context callbackapidefinedinthe fragment classwasintroducedatapi level23.therefore thecallbacksthatoverrideitcannotbeinvoked at runtime when the api level is below .
there are suchevolvedcallbackapis.theevolutionsaltertheinvocationproto cols of the concerned callback apis by enabling or disabling the apis invocationsdependingontheruntimeapilevels.thiscan significantly affect the control flow of android apps.
in section .
we will show that the reachability changes of callback apis can commonly induce callback compatibility issues in android apps.
apibehavioralmodification.
thereare37callbackapiswhose behaviorswereupdated.theupdatesdidnotadd removeorchange thereachabilityofcallbackapis butledtoapibehavioralmodification.inourdataset weobservedthreecommontypesofsuch evolutions apideclarationchanges e.g.
thecallbackapi onnotificationposted smodifier abstract wasremovedinapilevel callingconditionororderchanges e.g.
sinceapilevel11 ifthe api invalidateoptionsmenu which declares that the options menu has changed is called the callback api oncreateoptionsmenuwill also be called by the system when the options menu needs to be displayed and the values passed to method pa rameters change e.g.
the second parameter of the callback api authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
understanding and detecting callback compatibility issues for android applications ase september montpellier france !
a b figure ccfg node inconsistency example.
onnewpicture webview picture will always receive a null reference since api level .
such behavioral modifications will causespecificchangestotheapis invocationprotocolssincethe concerned api may undergo different behavioral changes.
as a result thecallbackcompatibilityissuesinducedbysuchcallbackapi evolutionsare also specific to theconcernedcallback apis.
we will further discuss these callback compatibility issues in section .
.
.
.
commonly evolved callback apis.
we analyzed the callback apisthathavebeenupdatedsincetheirfirstintroductionandobserved that most of them are defined in four classes activity fragment service and webview.
these classes are commonlyused by android apps for ui displays activity andfragment backgroundtasks service andwebbrowsing webview .their callbackapisaccountfor25 ofthecallbackapisin lapi.around ofallapiupdatesinourdatasetarerelatedtothecallbackapisinthesefourclasses.frequentupdatesofsuchcommonly usedcall backapiscaneasilycausecallbackcompatibilityissuesthatwould affect a large number of android apps.
this motivates the need of automatedtoolstosupportcallbackcompatibilityissuedetection.
inthenextsection wewilldiscusshowcallbackapievolutionscaninduce callback compatibility issues by changing app control flows.
with this knowledge we then propose a technique for callback compatibility issue detection.
answertorq1 callbackapievolutionscanmodifyapiinvocationprotocols changingthereachabilityorfunctionalityof theevolvedapis.suchmodificationsaffectappcontrolflows.
frequent updates of callback apis in a few widely used classes commonly induce callback compatibility issues.
.
rq2 causes of callback compatibility issues inrq2 westudyhowthecallbackapievolutionsobservedinrq1 can change app ccfgs and induce callback compatibility issues.
weinvestigatedthe100callbackcompatibilityissuescollectedfrom open source projects on github section .
.
we found that all these issues arose from two types of ccfg inconsistencies induced by callback api evolutions.
.
.
ccfg structural inconsistency.
a vast majority of the issues out of arose from the ccfg structural inconsistencies across api levels.
ccfg structural inconsistencies occur when the setofnodesoredgesofanapp sccfgchangesacrossdifferentapi a b !
!
figure ccfg edge inconsistency example.
levels.
from the issues we found that the callback compatibility issues arising from node inconsistencies and those arising from edge inconsistencies differ in nature.
in addition the issues arising from node inconsistencies are most common.
ccfg node inconsistency.
there are issues induced by ccfg nodes that exist in some api levels but disappear in other apilevels.thisiscommonlycausedbyapireachabilitychanges section5.
.
.theintroductionofacallbackapiatanapilevel adds a new node to concerned ccfgs while the removal of an api deletes a node from the ccfgs.
in both cases the node can only be found in the ccfgs for certain api levels.
this would lead toinconsistentappbehaviorsacrossdifferentapilevels causing callback compatibility issues.
with further examination we found that the absence of a ccfg node can destruct variable def use chains or eliminate the invocations of key apis that can cause user perceivable app behaviors.
our motivating example in section 3gives an instance of such inconsistencies.
in the example the onattach context nodeisabsentfromtheapp sccfgforapilevelslowerthan23.
the absence of the node destructs the def use chain of the variable mactivity causing the app to crash.
the commit 2681e87 inbitmask filedanotherissueinducedbyinvokingakeyapi inacallbacknodethatisabsentinccfgsforspecificapilevels.
figure4showstheinconsistentccfgs.asthefigureshows the apidisplayisinvokedinthecallbackapi onviewstaterestored to display information on the screen.
since this callback api is not availableuntilapilevel17 theapi displaywillnotbecalledwhen bitmaskrunsondeviceswithanapilevellowerthan17.asaresult the information cannot be properly displayed.
the root cause ofthis issue is that some apis that can cause perceivable changes atruntime e.g.
display arenotinvokedbecauseofccfgnode absence.thismotivatesustomaintainalistofsuchapistosupport the automateddetection of callbackcompatibility issues viastatic analysis section .
.
ccfg edge inconsistency.
the remaining of the issues were induced by ccfg structural inconsistencies that occurred whenthesetofccfgedgesvariedacrossdifferentapilevelswhile thesetofccfgnodesremainedthesame.suchedgeinconsistencies can also destruct variable def use chains and cause callback compatibility issues by scrambling the execution order of callback apis.
for example the commit 467d6e8 of keepassdroid d oc umented an issue caused by ccfg edge inconsistency.
figure shows the concerned ccfgs.
before api level the android systemwillonlytriggerthecallbackapi oncreateoptionsmenu each authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
ase september montpellier france huaxun huang lili wei yepang liu and shing chi cheung timewhentheusersopentheoptionsmenuandbeforethatthe oncreatecallback of the menu s enclosing ui component must have been invoked.
however at api level a new api invalidateoptionsmenu wasintroducedfordeveloperstoforcetheinvocation ofoncreateoptionsmenu .thismakesitpossibletoinvoke oncreateoptionsmenu before oncreate .inthiscase theusestatement ofmentryinoncreateoptionsmenu can be executed before the def statement of mentryinoncreate causing the app to crash.
.
.
ccfg non structural inconsistency.
the remaining of the 100issueswerecausedbyccfgnon structuralinconsistency.in these cases the sets of nodes and edges in ccfgs stayed the same but the behaviors of the callback apis were inconsistent across different api levels.
the non structural inconsistencies were inducedbythebehavioralmodificationsofcallbackapissuchasapi modifier changes from abstract to non abstract api triggeringcondition changes and so on.
for instance developers of omninotes encountered an issue of this type issue .
the issue was induced by a change in the modifier of the callback api onnotificationposted .
at api level the api is changed from abstract to non abstract.
when the api is overridden the subclass version invokes the superclass version.
this works well on devices withanapilevel21orabove becausethesuperclassversionofthe api is a concrete method .
however when the app runs on devices withanapilevellowerthan21 itwouldcrashsincethesuperclass version of the api is an abstract method that cannot be invoked.
tosummarize callbackapievolutionscaninducevariousccfg inconsistencies.such inconsistenciescanaffect appruntimebehaviors and cause callback compatibility issues.
among our studied issues amajorityofthemwerecausedbystructuralinconsistencies of ccfgs.
as discussed in section .
.
ccfg structural inconsistencies often destruct variable def use chains or eliminate theinvocations of key apis that can cause user perceivable app be haviors.
it should be noted that the occurrence of these callback compatibilityissuesheavilydependsonhowdevelopersoverride and implement the callback apis we observed that definitions and usages of variables and api invocations commonly occur in the methodbodyoftheoverriddencallbackapisinandroidprograms .
thismotivatesustocombineccfginconsistenciesandtheanalysis of the callback code to automatically detect callback compatibility issues for android apps section .
answer to rq2 callbackcompatibilityissuesarecommonly inducedbytwotypesofappccfginconsistenciesarisingfrom callbackapievolutions.amongthem ccfgstructuralinconsistencies which could affect app control flows caused the majority of our studied issues.
automated detection of callback compatibility issues in section .
we made a key observation that callback compatibilityissuesarecommonlyinducedbyccfgstructuralinconsistencies atdifferentapilevels.thestructuralinconsistenciescandestruct variable def use chains or eliminate the invocations of key apis thatcancauseuser perceivablechanges e.g.
uidisplayapis .thismotivates us to construct an app s ccfg at each api level to detectpotentialcallbackcompatibilityissues.however analyzingthe controlflow inconsistenciesinduced bycallback apievolutions is challengingbecausepreciselyconstructinganapp sccfgatanapi level is non trivial as an app component can implement many callbacks and the timing of their invocations can be non deterministic.
to address this challenge we first propose a graph based model callback invocation protocolinconsistency graph pi graph to capture the structural invocation protocol inconsistencies occur ringinanappacrossapilevels section .
.thenweproposea techniquecider whichleveragesthepi graphmodel todetect callback compatibility issues caused by ccfg structural inconsistencies section .
.
for issues induced by ccfg non structural inconsistencies which are much less common we leave them to our future work.
.
the pi graph model a pi graph is a directed graph that models the inconsistencies in the callback api invocation protocols across multiple api levels.
api graphiscreatedbasedondifferentversionsoftheandroid softwareplatform.therearetwocategoriesofnodesinapi graph callback node ncdenoting a callback api and two types of helpernodes npreandnsucdenotingtheprecedingandsucceeding point of pi graph respectively.
an edge e angbracketleftns ne apilevel angbracketright indicatestheexecutionorderoftwocallbacknodes neandns ne will be executed after nsif the runtime api level is within the intervalapilevel whereapilevel isintheform inwhich a andbspecifythelowestandhighestapilevel respectively.apigraph only contains the nodes for those callback apis that reside in the same class as the evolved callback api.
figure6 a shows an pi graph example.
in this example the pi graph captures the ccfg structural inconsistencies induced by the evolution of the callback api onattach invoked by wordpress across multiple api levels as discussed earlier in section .
besides the preceding node npreand the succeeding node nsuc there are two callback nodesrepresenting two corresponding callbackapis.
fouredgesinthegraphindicatethedifferentexecutionordersof thecallbackapisfordifferentapilevelintervals.forexample edge circlecopyrtin the figure indicates that onattach activity can be executedaftertheexecutionof onattach context whenapilevelis within .basedonthepi graphmodel wecangeneratesimplified ccfgs for android apps by traversing the pi graph along edgesthat arelabelled withdifferentapi levelintervals.
thegenerated ccfgs can then facilitate control flow analysis for android apps with regard to different api levels.
in the next section we willdiscusshowpi graphcanbeusedtogenerateappccfgsand detect callback compatibility issues.
to demonstrate the usefulness of the pi graph model we manuallyderivedsevenpi graphsbyanalyzingapireferenceandthe framework source code.
these seven pi graphs concern different callback apis in the classes activity fragment and webviewclient.accordingtoourempiricalstudy theevolutionsofthese callback apis commonly caused callback compatibility issues on recent android versions.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
understanding and detecting callback compatibility issues for android applications ase september montpellier france algorithm callback compatibility issue detection.
input an android apkfileapk a list of pi graphs a list of key apis .
output detected compatibility issues 1apk.apilevels getapilevels apk.confi 2foreach in do 3apk.classlist getclassesfrompigraph .apilist 4foreachcinapk.classlist do genccfgfrompigraph c apk.apilevels foreachccfg in do ifcheckusewithoutdef ccfg then report a callback compatibility issue.
ifcheckmissingkeyapis then report a callback compatibility issue.
.
the cider approach ciderleveragespi graphsto detectcallbackcompatibilityissues in android apps by constructing simplified app ccfgs for different api levels.
the ccfgs integrate app code into predefined pi graphs.ciderthenperformsstaticanalysisontheccfgsto detect callback compatibility issues.
algorithm describes the running process of cider.
it takes an android app in apkformat a list of predefined pi graphs denotedas andalistofkeyapis denotedas asinput.ciderfirst checks the configuration file of the app under analysis to obtain itssupportedapilevels getapilevelsinline1 .foreachpi graph in cider first identifies all app classes that extend the class that defines the callback apis in by invoking getclassesfrompigraph line .
for each class cgoing to be checked cider generates a set of simplified app ccfgs denoted as for different apilevelintervalsbasedon genccfgfrompigraphinline5 and performs static analysis to detect use without def line and missing key apis line9 issuesasdiscussedearlier section .
.
.
if any callback compatibility issue is detected cider reports its issue location and issue type lines and .
generatingccfgsfrompi graph.
toapproximatetheapp controlflowsindifferentapilevelsandsupportcallbackcompatibility issue detection cider generates app ccfgs based on pigraphs.
figure a shows the pi graph capturing the evolutions ofthecallbackapisthatinducedthewordpressissueinfigure .
given an app and a pi graph cider identifies all different apilevel intervals associated with the edges e.g.
and in figure a .
it also identifies the supported api levels of the givenappbycheckingtheattributes android minsdkversion and android maxsdkversion in the app s configuration file i.e.
androidmanifest.xml .
cider then generates a ccfg for each supportedapilevelinterval ran ebytraversingthepi graphalong alledgeswhoseassociatedapilevelintervaliswithin ran eand addingthecallbacknodesassociatedwiththeedges.ifacallback api is implemented in the app under analysis the code in the methodbodywillbeaddedtothecallbackapi sccfgnode.figure6 b shows the ccfg for api level interval which is b c ... !
a ... ... !
!
!
!
figure6 thestepsofgeneratingappccfgsfrompi graph.
a is an example of pi graph related to the wordpress issue section .
b is a simplified ccfg generated by ciderforwordpress.theccfgdescribestheapp scontrol flowsamongthecallbackapismodeledbythepi graphin a at an api level in .
c is an ccfg of the app after inserting the node of a callback api that is not in the pi graphin a .theplaceofinsertionisdeterminedbytheinvocation order of the callback apis specified in the apireference.
generatedwiththepi graphinfigure a andthecodesnippet infigure .twocallbackapinodesareincludedintheccfgas they can be reached along the edges whose associated api level is within .sincetheapi onattach context isimplemented itscorrespondingccfgnodecontainsthecodeinthemethodbody.
so far the generated ccfg only includes the callback apis that are in pi graph models.
note that the control flow inconsistencies caused by callback api evolutions may propagate to other callback apis that are not modeled by pi graphs.
to analyze the dependenciesbetween thecallbackapis inpi graphmodelsand other implementedcallbackapisinanapp ciderfurtherrecoversthe executionordersbetweenthecallbackapisinthegeneratedccfgs and other callback apis.
specifically we maintain a set of callback nodesforeachedgeintheccfg.anodewillbeaddedtothissetif its represented callback api can be executed between the callback apis represented by the start and end nodes of the ccfg edge.
for simplicity weassumethatthestartandendnodesarebothcallbacknodes.thecaseswherethestartorendnodeisahelpernodecanbe handledin asimilar way.
forthepurpose ofadding suchcallback nodes we studied the specifications of all callback apis defined in the classes that we extracted pi graphs from.
for example we extracted arule fromthe apireference that onactivitycreated should be executed after onattach activity .
cider will then create a callback node for onactivitycreated and add it into the callbacknodesetoftheedgeconnecting onattach activity and nsucasshowninfigure c .oneshouldnotethatthecontrolflows between the callback apis that are not in the pi graph models would stay unchanged at different api levels and thus may not induce callback compatibility issues.
for this reason we do not maintain orders between the set of callback nodes associated with ccfg edges.
for those callback apis of which the execution order cannot be inferred from the api specifications cider inserts them into all possible callback node sets in ccfgs.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
ase september montpellier france huaxun huang lili wei yepang liu and shing chi cheung identifying callback compatibility issues.
after generating ccfgs for different api level intervals cider conducts control flow analysis to detect callback compatibility issues.
it detects two common types of issues by analyzing each generated ccfg use without def.
cider checks each ccfg and detects any variablesthatareusedbeforebeingdefined.specifically cideridentifiesthesetofdefandusestatementsforallcallbacknodesineach ccfg including those nodes in the callback node set of each edge.
for each statement that uses a variable cider checks whether the variablehasbeendefinedinanycallbacknodesthatare inthe corresponding pi graph model and executed before the use statement.ifavariableisusedwithoutbeingdefined ciderreports a warning of use without def.
missing key apis.
cidercomparestheinvocationsofkeyapis inthelistofccfgsgeneratedfordifferentapilevels.asdiscussed in section .
the bitmask issue invoking such apis will cause perceivableappbehaviorssuchaspoppingupanotification.asa result missinginvocationsofsuchapisincertainapilevelscan induceinconsistentappbehaviorsthatcanbeobservedbyusers.
cider will report a warning of missing key apis if the invocations ofkeyapis whicharemanuallyidentifiedfromourempiricalstudy dataset are inconsistent among ccfgs for different api levels.
accordingtoourempiricalstudy theabovetwotypesofcallback compatibilityissuescommonlyoccurinreal worldandroidapps.
therefore weimplementedtwocheckersfordetectingtheseissues inthecurrentversionof cider.ourevaluationresultsshowthatthe twocheckerscanalreadyhelpdetectalargenumberofrealcallback compatibility issues.
in future cider can be further extended with othercheckerstodetectmoretypesofcallbackcompatibilityissues.
evaluation we implemented cider on top of soot a static analysis framework for android apps and java programs.
our current implementation of cider encodes seven differentpi graphs concerning keyapis whichareextractedfromourempiricalstudydataset.
in this section we evaluate cider with open source android apps.
we aim to answer the following two research questions rq3 effectiveness cancidereffectivelyandpreciselydetect callback compatibility issues in real world android apps?
rq4 usefulness canciderprovideusefulinformationforandroid app developers to facilitate the diagnosis and fixing callback compatibility issues?
.
experimental setup to answer the above research questions we collected opensourceandroidappsfromgithubthatsatisfythefollowingthree constraints contain at least one commit after october i.e.
actively maintained do not overlap with any projects selected forourempiricalstudy and useatleastoneofthecallbackapisinthesevenpi graphsencodedincider.weusedthelatestversion ofthese20androidappsasourevaluationsubjectstoexamineif cidercandetectnewcallbackcompatibilityissuesinthem.table gives the basic information of the subjects including the projectname theapp scategoryinformationprovidedbygoogle playstore ifapplicable therevisionusedinourexperiment the number of stars on github the number of downloadson google playstore if applicable and the number of lines of code.asshowninthetable thesubjectsarediversified covering different app categories.
they are also non trivial containing thousands to hundreds of thousands of lines of code.
intheexperiments weconfiguredcidertoreportthelocation and type use without def ormissing key apis of each detected issue.toevaluatetheeffectivenessof cider wecompareditwitha baseline tool lint .
lint is a static analyzer that scans the source files of android apps to find common bugs including callbackcompatibility issues.
since lint is integrated in android studio it has been widely used by android app developers to improvethe software quality of their products.
for comparison we ran lint on the same experimental subjects to detect potential callback compatibilityissues.wemanuallycheckedtheissuesreportedby cider and lint to categorize them into true positives tp and false positives fp .
for fairness we excluded those issues that are reported by lint but are not related to any callback apis in our extractedpi graphs.whencategorizingeachissue wecarefully examinedtherelevantsourcecode.wewouldonlycategorizean issue as a true positive if it can cause the corresponding app tobehave inconsistently at different api levels.
to further evaluatethe usefulness of cider we reported the true issues detected by cidertotheoriginalappdevelopersforconfirmationandfeedback.
allexperimentswereconductedonanimacwithanintelcorei5 cpu .4ghz and 16gb ram.
.
results of rq3 effectiveness of cider as shown in table cider detected issues in nine subjects amongwhich13aretruepositives i.e.
theprecisionis92.
.thisshowsthatcidercanpreciselydetectcallbackcompatibilityissues in android apps.
cider reported one false positive in kolab notes.
weinvestigatedthisfalsepositivetounderstandthelimitationof cider.asdiscussedinsection theccfgsgeneratedbyciderdo not capture the execution orders between callback apis that are notinpi graphs suchorderswouldstayunchangedatdifferent api levels .
this can cause imprecision in control flow analysis.
for instance when analyzing kolab notes cider reported a use without def issue because a variable defined in an evolved callback api was later used in a callback that handles a click event.
theevolvedapicannotbeexecutedatsomeapilevelsandthus ciderdeterminesthatthevariablecanbeusedwithoutadefinition and reported the issue.
however after manually reviewing thisissue we found that the app developers have already fixed this problembyincludingadefinitionofthevariableinanothercallback api notinthepi graphs whichcanbecalledaftertheexecution of the evolved api and before the execution of the click eventhandling callback.
in our evaluation subjects cider reported only this false positive suggesting that such imprecision in control flow analysis may not affect cider s effectiveness in practice.
table2alsopresentstheresultsoflint.lintdetectedtworeal callback compatibility issues but reported false positives.
the twotrueissuesreportedbylintwerealsoreportedbycider.weinvestigated the false positives and found that lint simply reports theusageofdeprecatedcallbackapiswithoutanalyzingwhether suchusagewouldreallyaffectanapp sruntimebehavior.forexample in the app calendula lint generated a warning suggesting authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
understanding and detecting callback compatibility issues for android applications ase september montpellier france table evaluation subjects and results.
no.
project name category last commit starsdownloads kloccider lintissue statustpfptpfp afwall tools 71e6c66 500k .
fixed calendula health c476575 1k .
ccctv education 667a83c .820208confirmed 4duckduckgo kotlin tools 2d7d379 1m .
fixed 5foss browser e08f5b6 .
kolab notes productivity 14ba3c3 1k .
7materialfbook 2cb3c61 .
8network monitor tools 0e17b95 50k .
nyaapantsu 53ad9a8 .
ooni probe tools 60cbd70 100k .91002146confirmed 11openkeychain communication 100k .
osmand maps b7a539f 5m .
fixed padland productivity 38f7e66 .
fixed passandroid travel 2d50ff4 1m .
ring communication 20d4221 1m .
10011831not fixed 16sg for steamgifts entertainment 59fe959 1k .
17simple solitaire card 1483ee1 10k .
fixed 18suntimeswidget c9a3c00 .
19survivalmanual books 13b1f43 1m .
uber ride 4d77c38 .
fixed total thattheuseofcallbackapi onreceivederror isnotrecommended astheapihasbeendeprecatedsinceapilevel23.however theuse ofthisapidoesnotaffecttheapp scontrolflowatapilevelshigherthan while it is still necessary to use the api to support the app to run on lower api levels.
in contrast cider analyzes the control flowinconsistenciesinducedbythecallbackapievolutions.itis capable of precisely identifying the impact of an evolve callback api on an app s control flow.
answer torq3 cidercanpreciselydetect callbackcompatibility issues in android apps.
with control flow analysis based onpi graph cidercanoutperformlintandeffectivelyreduce the number of false positives.
.
results of rq4 usefulness of cider to evaluate the usefulness of cider we reported the true issues it detected to the app developers for their feedback.
for each issue we reported the issue location the root cause and potential patches for fixing the issue.
to avoid overwhelming the app developers for each concerned android app we submitted only one bug report including all true issues cider detected in theapp.
so far we have received developers replies for nine bug reports.
eight of the nine .
bug reports concerning detected issues havebeenconfirmedbytheappdevelopers amongwhich nineissuesmentionedinsixbugreportshavealreadybeenfixed.forexample fortheapposmand wereportedanissue that atoastnotificationfordisplayingnetworkerrorswillnotbeshownondeviceswithanapilevellowerthan23becausethefunctionality is implemented in a callback api that was not introduced until the apilevel23.withthedetailedinformationprovidedbyus osmanddevelopersquicklyrealizedtherootcauseoftheissueandfixedthe issue by following our suggestions.
this shows that the callbackcompatibility issues detected by cider are useful for improvingthe software quality of android apps.
it also indicates that the knowledge learned from the apps in our empirical study can be generalized to other android apps.
the only bug report that was not confirmed by the app developers is ring issue .
in this bug report we reported an issuewhereacallbackapicannotbeinvokedatapilevelslower than .
the callback api invokes another api that would change the title of an action bar widget.
as a result when the app runs ondeviceswithanapilevellowerthan23 thetitleoftheaction barwidgetwillnotbesetproperly.weconsideredthisissueasa true positive.
however the app developers of ring said that the issuewereportedresidesinsomelegacycodeandtheactionbar widget isno longerdisplayed.
inother words evenif thekey api is not invoked in certain cases it would not cause any perceivable consequences.thisindicatesthatthedeterminationofwhetherthe missinginvocationofakeyapiwouldreallyinduceinconsistent app behaviors can depend on app specific runtime contexts.
it is a challenge for static analysis to derive such runtime contexts and determine perceivable impacts of invoking certain apis.
in future weplantoexplorethepossibilityofapproximatingsuchruntime contextssothatcidercanbettermodelappbehavioralinconsistencies induced by the callback api evolutions.
this will further improve the performance of cider.
answer to rq4 callback compatibility issues reported by ciderareusefultoandroiddevelopers.theknowledgelearned fromthe50appsinourempiricalstudycanbegeneralizedto help improve the software quality of other android apps.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
ase september montpellier france huaxun huang lili wei yepang liu and shing chi cheung discussions incompleteness of the key api list.
cider takes a list of key apiswhoseexecutioncancauseuser perceivableoutcomesasinput to detect callback compatibility issues induced by the missing invocations of these apis.
in this paper we manually built a list containing24apisbasedonourempiricalstudydataset.thelistis by no means complete.
this may cause cider to miss real callback compatibilityissues leadingtofalsenegatives.infuture weplan toexplorewaystoautomaticallylearnmorekeyapisfromvarious sources such as api documentations to address this problem.
timeliness of the empirical dataset.
since android is evolvingquickly itsframeworkcodeandofficialdocumentsareupdated constantly.duetosuchevolutions ourempiricalstudydatasetmay becomeoutdatedsomeday.however ourmainfindingssuchasthecontrolflowinconsistenciesinducedbythecallbackapievolutions may not easily get outdated.
errors in manual inspection.
our study involved much manual work.
for example we manually identified callback apis by analyzingapi reference.such manualprocesses aresubject toerrors.
this poses a threat to the validity of our findings.
to mitigate the threat two of the authors independently performed all manual inspectionsandcross validatedtheirresults.wealsoreleaseour dataset for public access .
related work .
android compatibility issues therearemanyexistingstudiesontheevolutionandfragmentationoftheandroidecosystemaswellastheresultingcompatibility issues.
mutchler et al.
analyzed one million free android apps and observed that compatibility issues induced by android fragmentation are of serious concern to the entire app development community.mcdonnelletal.
studiedandroidapievolution and its impact on api usage.
bavota et al.
explored how the fault pronenessandchange proneness ofandroidapiscanaffect appratings.horaetal.
studiedthedevelopers responsestothe android apievolutions.
fan etal.
investigated android framework crashes and disclosed that one major cause for the crashes is api evolutions.
li et al.
studied deprecated android apis and the developers reactions.
hu et al.
studied the compatibility issues in android webview.
however none of the existing studiesanalyzedhowandroidevolutionscanchangecallbackapis invocation protocols and affect app control flows.
in this paper we systematically analyzed the changes in callback api invocation protocols and how such changes can cause compatibility issues.
another work by wei et al.
proposed a tool ficfinder to detect fragmentation induced compatibility issues which include compatibility issues induced by android api evolutions the fo cus of this paper .
ficfinder can detect issues that are caused by invocationsofcertainissue inducingapis.itleveragesbackward slicingforissuedetectionbutdoesnotpreciselyanalyzeappcontrol flows.
in comparison cider models inconsistent app control flows atdifferentapilevelsanddetectscallbackcompatibilityissuesinduced by such control flow inconsistencies.
these issues cannot be detected by ficfinder.
.
android control flow analysis ourtechniqueanalyzesthecontrolflowsofandroidapps.there are several relevant techniques.
for example blackshear et al.
proposedatechniquethatabstractsappcontrolflowsbydiscardingirrelevantflowswhileretainingtheexecutionordersofevent handlersthatareusefulforcontrolflowanalysis.yangetal.
proposedtheconceptcallbackcontrolflowgraph ccfg which is also used in our work.
they also proposed a technique to gen erate ccfgs for android activity components by analyzing the invocationcontextsofcallbackmethods.arztetal.
designed flowdroid which performs control flow analysis of android apps by synthesizing dummy main methods to model the executions of callback methods.
sun et al.
proposed a technique to detect codereusebymeasuringthesimilaritiesofappcontrolflowgraphs.
wuetal.
designedatechniquetodetectunauthorizedoperations in android apps by leveraging control flow analysis.
gordon etal.
proposedastaticanalysistooldroidsafethatcombines app runtime execution models and precise control flow analysis to detect the leakage of sensitive data in android apps.
safi et al.
proposeddeva astaticanalysistechniquetodetectanomaliesinducedbynondeterministictimingfortriggeringevents.whileall thesetechniquesleveragedappcontrolflowanalysis noneofthem considered the inconsistencies of app control flows at different api levels.tothebestofourknowledge ourworkisthefirstthatfocusesonstudyinghowtomodelappcontrolflowinconsistenciesat different api levels and leverage the model to automatically detect callback compatibility issues.
conclusion inthispaper weconductedanempiricalstudytounderstandandroid callback api evolutions.
we found that the evolutions of androidcallbackapiscancausesignificantchangesintheapis invocation protocols.
such changes can affect app control flows and induce various compatibility issues.
based on the findings we proposedagraph basedmodel pi graph tocapturethechangesof android callback api invocation protocols.
we further designed a staticanalysistechniqueciderthatleveragesthepi graphmodels toautomaticallydetecttwocommontypesofcallbackcompatibilityissues.weimplementedciderandevaluateditsperformanceusing20open sourceandroidapps.theresultsshowthatcidercanprecisely detectreal and previously unknowncallback compatibility issues.
in future we plan to extend cider to support the detection ofmoretypesofcallbackcompatibilityissues.wealsoplantoenhance cider s performance by better approximating the impact of its detected control flow inconsistencies on app runtime behaviors.
acknowledgment theauthorsthankthease2018reviewersandhkustcastle membersfortheirconstructivefeedback.thisworkissupported by the hong kong rgc grf grant the msra collaborativeresearch fund nvidia academicprogram and thehongkong phd fellowship scheme.
the authors also would like to thank the southernuniversityofscienceandtechnologyforthegenerous support on the research and travel.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
understanding and detecting callback compatibility issues for android applications ase september montpellier france