rescue crafting regular expression dos attacks yuju shen state key lab for novel software technology nanjing university nanjing china denny.syj hotmail.comyanyan jiang state key lab for novel software technology nanjing university nanjing china jyy nju.edu.cnchang xu state key lab for novel software technology nanjing university nanjing china changxu nju.edu.cn ping yu state key lab for novel software technology nanjing university nanjing china yuping nju.edu.cnxiaoxing ma state key lab for novel software technology nanjing university nanjing china xxm nju.edu.cnjian lu state key lab for novel software technology nanjing university nanjing china lj nju.edu.cn abstract regular expression regex with modern extensions is one of the most popular string processing tools.
however poorly designedregexes can yield exponentially many matching steps and lead toregexdenial of service redos attacksunderwell conceived string inputs.
this paper presents rescue a three phase gray box analytical technique to automatically generate redos strings to highlightvulnerabilitiesofgivenregexes.rescuesystematically seeds by a geneticsearch incubates by another geneticsearch and finally pumps by a regex dedicated algorithm for generat ing strings with maximized search time.
we implemenmted therescue tool and evaluated it against practical regexes in real worldprojects.theevaluationresultsshowthatrescuefound moreattackstringscomparedwiththebestexistingtechnique and applying rescue to popular github projects discovered ten previously unknown redos vulnerabilities.
ccs concepts securityandprivacy softwareandapplicationsecurity domain specific security and privacy architectures software and its engineering search based software engineering software defect analysis software testing and debugging keywords regular expression denial of service redos genetic algorithm acm reference format yuju shen yanyan jiang chang xu ping yu xiaoxing ma and jian lu.
.rescue craftingregularexpressiondosattacks.in proceedingsof the 33rd acm ieee international conference on automated software engineering ase september3 montpellier france.
acm new york ny usa 11pages.
yanyan jiang and chang xu are the corresponding authors.
permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed forprofitorcommercialadvantageandthatcopiesbearthisnoticeandthefullcitation on the first page.
copyrights for components of this work owned by others than acmmustbehonored.abstractingwithcreditispermitted.tocopyotherwise orrepublish topostonserversortoredistributetolists requirespriorspecificpermissionand ora fee.
request permissions from permissions acm.org.
ase september montpellier france association for computing machinery.
acm isbn ... .
introduction regularexpression regex amini programforstringpatternmatching extraction and replacing has been one of the most popular stringprocessingtools.featuredwithvariousgrammaticalextensions e.g.
lookarounds namedgroups atomicgroups backreferences conditionals and possessive quantifiers regexes are widelyusedincrawlers texteditors webapplications searchengines databases command line utilities to name but a few.
however poorly designedregexescanyieldexponentiallymany matching steps leading to timeout consequences despite that a regex s matching usually terminates in polynomial or even linear time of its concerned pattern and given input s a string s length.
such timeout triggering inputs can easily result in algorithmicdenial of service dos attacks aka.redosattacks .
a recent report showed that hundreds of popular websites are threatened by redos and it is thus natural and necessary to validate regexes against such possible vulnerabilities.
thispaperpresentsrescue athree phasegray boxanalytical technique for automatically detecting redos vulnerabilities i.e.
finding a timeout triggering input string for a given regex.
with suchatool developersorthird partysoftwarequalityteamscan perform redos security checks early in the software development.
thedifficultyofautomatedredosdetectionismainlyattributed tothecomplexityofmodernregex languageextensions.aformal languageofmodernregexesisbeyondthedescriptionrangeofa thompson nfa .
transforming such regexes to automata isalready achallenge and henceexisting staticanalyzers e.g.
pumping analysis transducer analysis nfa ambiguity analysis or adversarial automata construction areneithersoundnorcompleteinhandlingtheseextensions.on the other hand state of the art dynamicanalyzers e.g.
black box fuzzers like slowfuzz lack the understanding to the actual regexmatchingprocedureandcommonlyfallshortwhenredos vulnerability is hidden in deep states of a regex s matching.
this paper tackles the redos detection problem by observing thatthemostpracticalwaytoimplementaregexengineistoadopt thee nfa backtracking searching approach1 e nfa stands for extendednon deterministicfinite stateautomata andthatregexes canthusbeeffectivelyanalyzedbymerely focusingon e nfastates.
1popularregexenginesaremostlyimplementedinthisway e.g.
thebuilt inregex modules in java python javascript etc.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
ase september montpellier france y. shen y. jiang c. xu p. yu x. ma and j. lu in particular an e nfa state and its corresponding recursion stack distinctlydetermineanintermediatestateintheregex matching process and the whole search time in the matching is proportional tothenumberof e nfastatesevertraversed matchingsteps during thematchingprocess .weobservethattofacilitateasuccessful redos attack reaching a particular statein ane nfa is of the mostimportance andthatsuchstateinformationissufficientfor guiding an effective redos search.
with such observations the recursionstack whichisengine dependentanddifficulttoencode can be safely removed from consideration in the redos detection andtargetedredosstringscanstillbeeffectivelygeneratedbya geneticalgorithmfocusingmerelyonsearch profilingdata thusapplicable to almost all major regex engines with only marginal non intrusive changes .
this motivates for our proposal of a gray box search based algorithm for systematically finding an input string that maximizes the number of matching steps using regex search profiling data as the following three phases explain theseeding phase takes a regex and its e nfa as input and uses a genetic seeding algorithm to search for a diverseset of seed strings that can best cover the e nfa s states.
we adopt existing search based techniques and leverage a new genetic representation by maintaining a string seffective prefix andredundant suffix to better characterize the string s matching procedure.
theincubatingphase germinatestheseedstringsusingasimilar genetic algorithm but with a different fitness function tosearchforthoseattackstringcandidates whichmaximizetheratiosbetweenthematchingstepssofarandtheirstring lengths.
this incubating phase resembles existing gray box search techniques .
thepumping phase trims and enhances the slowest string candidateintheincubatedpopulationbyalocalsearchalgorithm for eventually crafting a malicious input string that willresultinasignificantnumberofmatchingstepsinthe given regex s matching triggering a real redos attack in practice.
weimplementedourthree phasetechniqueasrescueinjava a redos detection tool that can thoroughly analyze given regexes for their redos vulnerabilities requiring merely slight profilingchanges to the concerned regex engines.
we evaluated rescue using29 088regexesandcomparedrescueagainstfourstate ofthe art redos detection techniques.
we also applied rescue to highly starred github projects for redos vulnerability detection.
the evaluation results show that rescue found more redos strings compared with the best existing technique and has acomparabletimecostwithexistingnativecimplementationof fuzzing even if our profiled java regex engine is one or two magnitudesslower.theapplicationtogithubprojectsfoundten previously unknown redos vulnerabilities.
in summary this paper made the following contributions weproposedathree phasetechniqueforautomaticanalysis ofregexesandsystematicdetectionoftheirredosvulnerabilities.
the technique can be applied to all mainstream regex engines based on e nfa and backtracking to the best of our knowledge.
we implemented rescue in java and evaluated it using realworld regexes.
the evaluation results show that rescue outperformedstate of the arttechniquesanddetectedpreviously unknown redos vulnerabilities in popular opensource projects.
therestofthepaperisorganizedasfollows.weprovidebackground of regex and redos in section 2followed by the algorithm description in section .
the implementation of the rescue tool is discussed in section 4and its evaluation results are presented in section .
related work is discussed in section 6and finally section7concludes the paper.
background .
regexes regex engines and redos regular expression regex a mini program for compact description offormallanguages wasoriginatedin1950s andbecomes one of the most popular string processing tools.
in the years of development practitionersextendedregexeswithrichfeaturesto facilitate powerful and elegant handling of string pattern matching tasks characterclasses lookarounds namedgroups atomicgroups backreferences etc.empoweredwiththeseextensions regextoday is one of the most handy string processing tools.
regexpatternmatchingisconductedwiththesupportofa regex engine.
since regexes with extensions are context aware2 a modernregexcouldnolongerbeconvertedtoadeterministicornondeterministic finite state automaton as opposed to the classical textbookcase .asaresult regexenginesmusthaveto search forregexmatches andthusthestate of the artregexenginesadopt a similar algorithmic framework as follows convertingthegivenregexintoadatastructurewhichextendsanon deterministicfiniteautomaton i.e.
an e nfa inwhicheachvertexrepresentsapatternmatchingrelated operation and conducting a backtracking search to find whether there exists any path that matches the given input string.
such a framework runs in polynomial or even linear time in mostcases.however inrarecasesofa non match allpossiblepaths would be examined and a regex engine can run in exponential time of the input string s length.
for example a regex from reglib !
.
recognizescommentsinanhtmlfile.patternmatchingwithsuch a particular regex is usually fast even if the input is of a megabyte length.
however a python regex engine can get stuck with the following shortinput string3 !
!
!
!
!
!
!
!
iamredos therefore when regexes are used to process untrusted inputs e.g.
formssubmittedbyaninternetuser suchtime out triggering casescanmakesoftwarevulnerabletodenial of serviceattacks orredosattacks.
2for example the regex ?
!
1?
tests whether the expression consists of a prime number of 1s.
3thedevelopermisplaceda .
intheregex anditcanbeexpandedin o 2n many ways in representing a string of length n. authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
rescue crafting regular expression dos attacks ase september montpellier france rescue seeding phase incubating phase pumping phasenfa regexempty set coverage fitness functiongaseed set ratio fitness functionga populationeffective substring candidate trim pump figure overview of the rescue technique for automated redos string generation.
.
automated detection of redos vulnerabilities regexesareusuallyembeddedinapieceoflargesoftwareandlack thoroughtestingoranalysis.theyarethus notdefendedagainst redosattacks .afewregexenginesprovidematchinglimits e.g.
pcre toalleviatetheimpactofredos.however even such a minimal effort is not widely adopted in practice4 not to mention that setting a time limit cannot fully tackle the redos issue when a server is flooded with timeout triggering regexes.
therefore anautomatedtoolforfindingredosstringsbecomes adesirablesolutiontowarndevelopersofsuchpotentialvulnerabilities and then refactoring the concerned regexes early in the software development .
depending on whether actual regex matchingsare conducted suchatool iseither static basedpurely on the given regex or dynamic based on the profiling results of regex matchings .
staticredosanalysesfindvulnerableconstructs viastaticrules orpatterns inthe e nfarepresentationofaregex .
such analyses can be sound and complete for certain kinds ofregexes butcaneasilyreportfalsepositiveattackstringsormiss redosvulnerabilities.takingthebackreferenceasanexample itisextremelydifficulttoknowwhatitsvaluecanbeinabackreference e.g.
without actually conducting the regex matching.
dynamic redos analyses on the other hand conduct actual regexmatchingandusethematchingresultstoguidefurthergeneration of potentially vulnerable strings e.g.
fuzzing .
therefore a dynamic analyzer usually seamlessly handles regex extensions and reports only true positive redos strings.
the major drawback of dynamic analysis is that finding a timeout triggering string is itselftime consuming andthusexistingblack boxtechniquesguided byacost effectivenessvaluecanmissredosvulnerabilitiesthat require a certain cost ineffective prefix to trigger.
our rescue presented in this paper exploits both the static knowledgeofaregex thepumpablepropertyofregexes andthe genetic search guided by the profiling data collected along with the regex s matching process .
4for example even popular editors like atom and libreoffice hang or crash when regexmatchinggetstimeout e.g.
conductingpatternmatchingof .
bythetime of this paper being written.
the rescue algorithm thissectionelaboratesonourthree phaserescuealgorithmfor automated redos detection as illustrated in figure .
.
methodology overview the redos detection is a searchproblem i.e.
given a regex r a n alphabet e.g.
english alphabet and symbols and a maximal input length lscript finding redos r lscript argmax s 1 ... lscriptregexmatchtimer s .
thesearchtime regexmatchtime dependsnotonlyontheinput regexandtheinputstring butalsoontheunderlyingregexengine implementation e.g.
the regex search algorithm and supported regexextensions .thecomplexityofaregexengineimplementationmakesstaticregexanalysistechniques neither sound nor complete.
our evaluation later shows that these techniques reported false positives and found less true positive redos vulnerabilities when applied to a practical regex engine.
on theotherhand existingheuristicsearchtechniques e.g.
black box fuzzing mayalsofailtorecognizeredosvulnerabilities.such search algorithms are usually guided by the cost effectiveness of a string i.e.
thesearchtimedividedbythestring slength.whenthe redosvulnerabilityrequiresalesscost effectiveprefixtotrigger thesearchislikelytobetrappedinlocaloptimumsolutions leaving the redos vulnerability undetected.
theselimitationsofexistinganalysisofsearchtechniquesmotivate us to design our rescue technique to dive into the actualregex search procedure for an effective redos string generation.
rescue consists of three phases theseedingphase explores the regex engine s behaviors undervariousinputs.inparticular theseedingphasefocuses onreachingasmany e nfastatesoftheregexaspossible regardless of the search time.
theincubating phase searchesfor redos candidatestrings with maximized search time as guided by a cost effective measurementonthebasisoftheseedstringsgeneratedinthe firstphase.theincubatingphaseworksonthehypothesis thatredosstringscanbegeneratedbysuccessivelyapplying mutation and crossing over operations to the seeds.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
ase september montpellier france y. shen y. jiang c. xu p. yu x. ma and j. lu thepumping phasefinallyenhancestheredoscandidate strings by a local search of removing redos irrelevant characters and copying pasting part of a string to obtain a truly redos string of maximized search time.
our three phase rescue technique inherits several important ideas from existing work.
both the seeding and incubating phases belong to genetic search extensively studied in the search based software engineering domain .
in particular the incubating phase is guided by the cost effectiveness and resembles the black box time complexity attack fuzzing .
the pumping phasegeneralizestheideaofstaticanalysisforfindingpumpable constructsinaregex toadynamiclocalsearchproblem.putting themtogetherplusaseedingphaseforgeneratinguseful artifacts in crafting redos strings yields our rescue technique which is elaborated on as follows.
.
notations and definitions .
.
strings regexes andregexpatternmatching.
weusewidely usednotationsfordescribingstringsandregexes .astringsis asequenceofcharactersfromanalphabet .s i denotesthe ithcharacterinstring s i s ands i j denotesthesubstring s i s i ...s j .theemptystringisdenotedby .forexample givens redos s d ands os .
two strings xand ycanbeconcatenated yielding x yorsimply xy.concatenating x hello andy world yieldsxy helloworld .
aregular expression ris the string representation of a formal language i.e.
a set of strings l r .
for rhello ?
hello l rhello hello .
given a string sand a regex r the regex pattern matching problemisequivalenttotestwhetherthereexistsasubstring s i j l r .
anotherrelevantproblemisthelanguageinclusiontestonwhether s l r and regex matching can be reduced to the testing of language inclusion.
.
.
e nfa for regex matching.
modern regex engines usually first compile a regex to an extended non deterministic finite automaton e nfa which is usually implemented in a modern regex engine .ane nfacanberegardedasagraph g v e inwhich each vertex v vdenotes an e nfa state and each matching step node v visassociatedwith anengine specificfunction fvto performstatetransitioninregexmatching.forexample thejava regex engine constructs the e nfa shown in figure 2forrhello.
theregexengineconductsamatchingbymaintainingitsmatching states usually a stack either explicitly or implicitly by recursion storing a sequence of angbracketleftvi pi ti angbracketrightwherevi vis ane nfa state p s is a position in s6 and some engine dependent statesti.
initially s0 angbracketleftv0 angbracketright wherev0 vis the initial e nfa state.
ineachmatchingstep theregexenginepops angbracketleftv p t angbracketrightfromthe matching stack and pushes fv s p t onto the stack sis the input string .
multiple values of angbracketleftv p t angbracketrightmay be pushed to represent non deterministic choices.
this stack based mechanism provides versatile supports forregexextensions.
successfulmatching ofa ?
is the lookahead extension of regex.
6this potentially unbounded storage makes regex with extensions context aware.v0 begin v1 lookahead ?
... v2 grouphead index storage v3 slicehello v4 grouptail index storage v5 nodeexitv6 repeat v7 charclass a z v8 nodeacc figure the compiled e nfa of regex ?
hello single character is simply done by pushing angbracketleftv prime p t angbracketright while a failed matching pushes nothing which is equivalent to backtracking .fv s p t of lookahead and repetition nodes in figure 2are defined as follows fornodev1 lookahead it pushes angbracketleftv6 p angbracketrightthen angbracketleftv2 p angbracketright suchthatwhenthematchinggroup node v2 nodev5 is successfully matched the matching restarts at nodev6.
fornodev6 repetition dependingonthecurrentrepetition countt angbracketleftv8 p angbracketrightis pushed when t for matching the subsequent parts otherwise angbracketleftv7 p t angbracketrightis pushed for a repeated matching with a count of t .
therefore the regex matching procedure is sophisticated due to the runtime stack e.g.
there can be transitions from v4tov6 even if they are not connected in g as opposed to the classical nfa .
however the e nfa backtracking mechanism also providesguidancetowardseffectivesearchforanalyzingregexes using a genetic algorithm.
.
.
regexmatchingtraces.
thoughtheregexmatchingprocedure is sophisticated and engine dependent all known regex enginescanbemodifiedtoproduce positionaltrace orsimply trace during matching which is denoted by r s angbracketleftx0 p0 angbracketright angbracketleftx1 p1 angbracketright ... angbracketleftxm pm angbracketright wherexi vis ane nfa state and pi s is a position in the inputstringdenotingthestartingpositionofthenextstringpattern matching.
angbracketleftxi pi angbracketrightdenotes that the i th regex matching attempt is to find a match when picharacters in shave been matched ate nfa state xi.
essentially the trace is obtained by discarding theengine dependentstates ti inthematchingprocedure.
r s encodes sufficient information to guide an effective genetic search towards redos strings in rescue.
forrhello thee nfa shown in figure ands1 helloworld ands2 hellopanda conducting regex matching in java yields the same traces rhello s1 rhello s2 angbracketleftv0 angbracketright angbracketleftv1 angbracketright angbracketleftv2 angbracketright angbracketleftv3 angbracketright angbracketleftv4 angbracketright angbracketleftv5 angbracketright angbracketleftv6 angbracketright angbracketleftv7 angbracketright angbracketleftv5 angbracketright angbracketleftv7 angbracketright angbracketleftv5 angbracketright angbracketleftv7 angbracketright angbracketleftv5 angbracketright angbracketleftv7 angbracketright angbracketleftv5 angbracketright angbracketleftv7 angbracketright angbracketleftv5 angbracketright angbracketleftv8 angbracketright .
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
rescue crafting regular expression dos attacks ase september montpellier france for two traces r s1 angbracketleftxi pi angbracketright and r s2 angbracketleftx prime i p prime i angbracketright w e consider r s1 and r s2 equivalent inregexmatchingif r s1 r s2 andxi x prime ifor all i r s1 .
therefore s1 helloworld ands2 hellopanda haveequivalenttracesinmatching against rhello.
furthermore we define the effective prefix ep s s k where k max angbracketleftx n angbracketright r s n andtheredundantsuffix rs s s k s isthe restpartof s.obviously s ep s rs s .wedistinguishbetween ep andrsbecauseregexenginessometimesfirstchecktherestlength oftheinputstringtoshortpaththesearching anddeletingsuch tails may lead to an irreproducible trace.
for example the effective prefixes of both helloworld and hellopanda are hello .
finally a byproduct of regex compilation is a set of string slices slice whichcontainssubstringsof rusedintheregexmatching procedure.forexample sliceforrhellois hello corresponding tothevertex v3 .stringsin sliceareusefulintheoffspringproduction by mutation or crossover operators in a genetic algorithm.
.
the genetic search framework boththeseedingphaseandtheincubatingphasearegeneticsearch whichsharethesameclassicalgeneticalgorithmframework .a geneticalgorithmsearches foroptimalsolutionsin asearchspace by representing each solution as an individual a chromosomealike data structure and maintaining an evolving population of individuals.
given an initial population the genetic algorithm iteratively breeds offspring by cross over andmutation operators and produces a new generation of population under the guidance of the principle of natural selection an individual of a higher fitness functionvalue has a higher chance to survive.
boththeseedingphaseandtheincubatingphasesharethesame genetic representation and offspring generation but differ in the initial population the fitness function and the selection strategy.
.
.
genetic representation.
we directly use a string to represent each individual in the population p s1 s2 ... sn si because a string naturally resembles a genome.
each generation ofthepopulationproducesitsoffspringbyrandommutationand cut concatenationofstrings andthenewgenerationisbredbythe selection under a fitness function f s p .
.
.
offspring generation.
given a population p its offspring are generated by crossing over and mutating the strings in p. thecrossoveroperator s1 s2 interleavestheeffectiveprefixes ofs1ands2.
in particular s1 s2 randomly splits ep s1 x1y1 ep s2 x2y27 and returns s1 s2 x1y2rs s2 x2y1rs s1 .
intuitively the effectiveprefixesep s1 andep s2 areinterleaved x1y2andx2y1 with their suffixes appended.
themutationoperator s returnsarandommutantof s where u sliceisarandomstring eitherarandomcharacterin or a random string constant in the regex s corresponding automaton 7if not otherwise stated the random selection of x xreturns each xwith the same probability of x .
appending uin ep s inserting uto a random position in ep s deleting a random substring in ep s duplicating a random substring in ep s reversing a random substring in ep s .
it is worth noting that both and operate on the effective prefixep s and keeps rs s unchanged because the redundant suffixrs s has not been involved in the matching procedure.
nevertheless keepingasufficientlylong rs s isalsonecessarybecause theregexenginemaycheckwhether rs s issufficientlylongfora successful matching.
then the offspring are generated by applying and to randomly selected individuals in the population p and newly generatedoffspringwhosetraceisequivalenttoanexisting r s for s pisconsideredredundantandisimmediatelydiscarded.furthermore wegavetheindividualsofhigherfitness f s p values a higher probability in generating offspring by crossover or mutation pr f s p summationtext.
s prime pf s prime p .
.
the seeding phase searching for diverse e nfa states theseedingphasetriestofindapopulation pseedofstringsthat coversasmany e nfastatesaspossibleandbasically ignoresthe search time8.
the initiate population of the seeding phase p0consists of constantstrings sliceintheautomatonplussomerandomstringsin the alphabet of .
abinaryfitnessfunction fseed s p isusedintheseedingphase whichsummarizeswhetherthematchingtrace r s coverssome uniquee nfa states in the population p. formally let v s uniontext.
angbracketleftx n angbracketright r s vdenotethesetoftraversed e nfastatesintheregex matching procedure fseed s p v v s .v nelement uniontext.
s prime p s v s prime otherwise.
afteranewpopulation p primecontainingcrossedoverandmutated strings is generated the seeding phase selects a minimal set of stringsp p primeas the population in the next iteration which satisfies uniontext.
s p v s uniontext.
s pv s .p is generated by sequentially considering each s pand discarding the strings without any uniquely covered e nfa state in v s .
.
the incubating phase searching for redos candidates the incubating phase incubates the seeds to find a population of strings of maximized regex matching time.
therefore the initial population of the incubating phase p0 pseed.
8in contrast to the existing technique that directly searches towards a larger running time we use the seeding phase to find redos strings of a long cost ineffective prefix.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
ase september montpellier france y. shen y. jiang c. xu p. yu x. ma and j. lu algorithm the pumping algorithm input a stringsand a designated length lscript s lscript output a pumped redos string 1begin 2strim s 3fori s to1do s prime strim i strim i strim try to remove the i th character iffincub s prime fincub s then strim s prime 7s strim 8m i j 9fori 1to s do forj i 1to s do s prime s i s i j s j s repeating s i j twice iffincub s prime mthen m fincub s prime i i j j 14k floorleftbig lscript s j i floorrightbig maximum allowed number of pumps 15returns i s i j k s j s the fitness function in the incubating phase fincub s r s s measurestheaveragecost effectivenessofeachcharacterin s.such afitnessfunctionnaturallyguidesthesearchtowardsredosstrings short strings costing a substantial amount of matching steps .
furthermore wesimultaneously maintain a diversepopulation to avoidbeing stuckat a local optimum.
givena newlygenerated population p prime let f p prime summationdisplay.
s p primefincub s be the average of fitness function values we first select p s p prime fincub s f toincludeanystringfitterthantheaverage andthenaddbacka minimal set of strings to maintain exactly the same e nfa state coveragebyenumeratingallstrings s p primeandadding stop if v s notsubseteql uniontext.
s p v s .
.
the pumping phase enhancing redos candidates for a successful attack the pumping phase selects such incubated string of the highest cost effective ratio s argmax s pfincub s andpumpsit into a highly effective input string for slowing down theregexmatchingprocedure.theidea andthename hasbeen inspired bythe pumping lemma which isalso used inthe static detection of redos vulnerabilities pumpinglemma .foranyregularlanguage l thereisa p such that any string w lof w pcan be written as w xyz wherey nequal andthestrings xz xyz xyyz ... constructedbyrepeating yzero or more times are still in l. in other words there may exist a substring that can be repeated and does not affect the matching results9.
therefore the pumping phase trims those unnecessary characters in s and pumps a carefully chosen substring to finally reach a string that requires a large number of matching steps as shown in algorithm .
the trimming algorithm lines removes unnecessary charactersbytryingtoremoveeachsinglecharacterandcheckswhether sucharemovalyieldsahigherfitness fincubvalue line5 .trimmingisalsousedtoreducethelengthoftheredundantsuffix rs s .
then the pumping algorithm lines enumerates all substrings in s i j and tries to pump one once yielding s prime s i s i j s j s and finally pumps the most profitable substring lines to obtain our redos string.
implementation we implemented rescue in java.
the implementation has approximately lines of java code and lines of python scripts10 and is composed of the following components a modified version of java regexstandard library for collecting profiling data r s .
animplementationofthegeneticalgorithmsdescribedin section3.
a series of scripts for handle miscellaneous tasks e.g.
regex extraction and syntax translation.
.
the modified regexlibrary the java regexstandard library compiles a regex into an e nfa ande nfa s state transitions are implemented by calling an e nfa state represented by an instance of class node s corresponding matchmethod.theslices sliceareextractedfromthe slicenodes.
thematchingtrace r s iscollectedalongwiththeregexmatchingeachtimewhenthe matchmethodofa nodeinstanceisinvoked.
inthematchingprocedure wealsokeeptrackofalistof angbracketleftxi pi angbracketright and maintain the pivot index k which splits the effective prefix and the redundant suffix for string s i.e.
k ep s .
such collected information suffices for conducting our three phase redos vulnerability detection.
.
the genetic algorithm implementation weadopttheearlyexitmechanisminboththeseedingandincubatingphaseswhenmatching ragainstastring s prequiresmore than 105matching steps to terminate and directly move on to the pumpingphase.this treatmentpreventsthesearchfromhanging when regex matching is extremely time consuming.
theparametersforthegeneticsearcharesettotypicalvaluesin existing literatures .
in both the seeding and incubating 9evenifthepumpinglemmadoesnotholdforextendedregexes suchapumpable structure may exist for crafting redos strings.
the pumping phase searches for such structures by enumerating substrings in s. 10the rescue tool is publicly available at authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
rescue crafting regular expression dos attacks ase september montpellier france table the regex sets for evaluation.
name number description reglib 992online regex examples from regexlib.com snort 499regexes extracted from the snortnids for data packet filtering corpus 597regexes from scraped pythonprojects phases we set the population size p .
the crossover rate is setto5 andthemutationrateissetto10 .bothphasesterminate after iterations in case that the early exit mechanism is not triggered.
the pumping phase also adopts the early exit mechanism.
if repeatingasubstring s i j yieldsmorethan106matchingsteps largercomparedwiththeearlyexitthresholdintheseedingand incubatingphases thepumpingphaseexitsearlierbyreturning theresultsofpumping s i j .finally ifapumpedstringyieldsmore than 108matching steps we consider that rescue has successfully generated a redos string.
.
miscellaneous utilities though we implemented the tool in java we also implemented scriptsforextractingregexesfromsourcecodewritteninotherprogramminglanguages inparticular python javascript andphp and converting the extracted regexes into the java regex syntax.
these scripts further helped us check the regexes from popular github open source projects and all detected vulnerabilities are discussed later in section .
.
evaluation the evaluation mainly concerns the following two aspects of rescue effectiveness is rescue effective in detecting redos vulnerabilities?
does it outperform existing techniques?
can itdetectredosvulnerabilitiesinreal worldprojects even written in other programming languages?
efficiency can rescue run within a reasonable amount of time?
.
experimental settings we collected threesetsof regexes regexes intotal from the evaluation of existing redos vulnerability detection techniques as listed in table and the following techniques are compared rescue presented in this paper.
slowfuzz adynamicgeneticfuzzingtechniqueforfinding an input that maximizes the running time.
rxxr2 a static redos vulnerability analyzer based on pumping analysis.
rexploiter another static redos vulnerability analyzer based on pumping analysis.
nfaa a static analyzer based on matching malicious patterns in regexes.foreachregex weruneachevaluatedtechniqueunderthedefault setting to obtain a redos string of maximum length lscript andtheresults theredosstringandthestatistics arecollectedfor evaluation and comparison.
this size represents a typical scenario inhandlinguntrusteduserinputs e.g.
afieldinawebformthat is constrained by a moderate length limit .
we consider an output redos string successfully exploiting the redos vulnerability true positive if it takes more than 108matching steps when applied to the java regex engine.
we set a ten minute time limit to the genetic search in both rescue and slowfuzz.
when the search exceeds the time limit rescue terminates regardless of its running phase while slowfuzz outputs the current population.
eachtechnique ssupportedregexextensionsareshownintable2.rxxr2 rexploiter andnfaaparseaninputregexusinga built in parserand are independent ofthe underlyingregexengine.
in other words these techniques output a potentially vulnerable stringregardlessoftheactualmatchingprocedure andmayproduce false positives.
for slowfuzz we chose the one with the largest matching steps astheredosstringinslowfuzz sfinal roundpopulation.slowfuzzisimplementedincandlinkedwiththe unmodified pcre2regexengine whichisdifferentfromourevaluationenvironment.tobest alleviate such a difference for a fair comparison we also appliedrescue generated redos strings to the pcre2 engine for cross validation of the effectiveness.
wealsoevaluatedtheeffectivenessofeachphase seeding incubating andpumping inrescuebytemporarilydisablingeach phaseandstudythecorrespondingnumberofsuccessfullygenerated redos strings.
allexperimentswereconductedonaserveroffourhexa core intel xeon x7460 processors cores in total and 64gb ram running ubuntu .
.
.
effectiveness evaluation results .
.
overall results.
the overall evaluation results are shown intable3.consideringthejava8regexengine allredosstrings generatedbyalltechniquesfoundthat227regexesarevulnerable thereexistsastringofnomorethan lscript 128charactersbutcosting more than 108matching steps .
rescuefound186 ofthesevulnerabilitiesandsignificantly outperformsalltheothertechniques.thebestexistingtechnique rxxr2 found accounting for of all the known vulnerable regexes vulnerabilities.
compared with rxxr2 rescue found more vulnerabilities.
slowfuzz also successfully identified vulnerableregexes butisevenlesseffectivecomparedwithrxxr2.
wealsoobservedthatstaticanalysesreportfalsepositives dynamicanalysessearchtowardsthevulnerabilitycriteriaandalways report true positives .
the best existing technique rxxr2 reported false positive cases and rexploiter and nfaa only reported a tinyfractionoftruepositives.thissupportedourclaimthatmodern regex engines are complex and static analyses fall short.
wecross validatedthegeneratedredosstringstothepcre2 regex engine implemented in c which is highly optimized and is severalmagnitudesfasterthanthejavastandard regexlibrary.the pcre2 behaves quite differently than the java regex engine and authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
ase september montpellier france y. shen y. jiang c. xu p. yu x. ma and j. lu table supported regex extensions of each evaluated technique.
features rescue slowfuzz rxxr2 rexploiter nfaa set operations check lookarounds ?
?
!
?
?
!
check check backreferences check check check non capturing groups ?
check check check named groups check check atomic groups ?
check check conditionals ?
?
check greedy quantifiers m n n m check check check check check lazy quantifiers ?
?
?
?
?
check check check check check possessive quantifiers ?
check check table the overall evaluation results.
vul.
denotes the number of vulnerabilities found and fp denotes the number of false positives output strings that costs less than matching steps .
technique vul.
fptp rate avg time s rescue .
slowfuzz .
rxxr2 .
rexploiter .
.
nfaa 714n a .
summary table the evaluation results of removing a phase.
the coveragecolumncontainstheaverage e nfastatecoverage.
variant vul.avg time s coverage rescue .
.
without seeding .
.
without incubating .
.
without pumping .
.
almost all java redos strings quickly terminate on pcre2.
consideringtheredosstringsforjavafoundbyslowfuzzandrescue only slowfuzz and rescue exceed a matching time of 1ms and the median matching time of rescue is merely longer than slowfuzz.
ontheotherhand thejavaregexengineislessoptimized whose behaviorresemblesthejavascript pythonregexengine.thoughwe cannot evidently prove that rescue is more effective in finding redosinstancesthanslowfuzzforpcre2 usingsuchalessoptimized engine facilitates us finding previously unknown vulnerabilities that cannot be detected by any evaluated technique.
finally the evaluation results also show that rescue cannot detectalltheseknownvulnerabilities.thoughfinding82 ofthem is a quite promising r esult there is still space for improvement and we will address this in the future work.
.
.
effectiveness of the phases.
by removing a single phase in rescue weevaluatedtheeffectivenessofeachphase.theresultsare shown in table indicating that all the seeding incubating and pumping phase contributed to the effectiveness of rescue.
removal of the seeding phase has the least impact less vulnerabilities detected on the effectiveness.
the seeding phase pays an additional .
seconds time cost to drastically improvethe e nfa statecoverage whichisworthy inanalyzingcomplex regexes and finding potential vulnerabilities hidden in the deep states of a regex.
at first glance one might thought that the seeding phase is not very much useful in rescue however recall that in the incubating phase we force the population to maintain a high nfa state coverage i.e.
the incubating phase subsumes the seeding phase to someextend.furthermore bothseedingandincubatingphasesuse the identical genetic representation and mutation cross over operators the seeding phase uniquely contributed to of rescue discovered redos strings.
removal of the incubating has a significant impact on the effectiveness.
this is expected because the incubating phase searches towards a string to maximize the matching efficiency which is the core of a dynamic algorithmic complexity fuzzer .
removal of the pumping phase has the largest impact on the effectivenesssimplybecausewesetamuchsmallerthresholdintheincubatingphase 5matchingsteps comparedwiththethreshold of a successful redos attack 108matching steps which is usually reached in the pumping phase .
in contrast slowfuzz directly searches for a algorithmic complexity because the pcre2 en gine is hundreds times faster than the instrumented java regex engineinrescue and slowfuzz snativecgeneticsearchimplementation including mutation cross over operators is much moreefficientthanrescue.rescueusesthepumpingalgorithmto alleviate the issues caused by the relatively inefficient implementation.
the redos strings found by rescue without pumping are consideredrelativeeasycasesthat redoscouldbetriggeredbya simple fuzzing.
withoutincubatingorpumpingphases rescuewouldbeless effective than existing techniques in finding redos vulnerabili ties.
the incubating phase creates redos attack candidates and thesestringsarebeingfurtherenhancedbytheregex designated pumping algorithm.
therefore we believe that the effectiveness of rescue is truly attributed to our carefully designed three phase regex aware algorithms.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
rescue crafting regular expression dos attacks ase september montpellier france running time s regexes figure the histogram of rescue runtime over all evaluated regexes .
efficiency evaluation results the fifth column of table 3shows the average time of processingaregex andfigure 3displaysthedetailedruntimehistogram statisticsof rescue.rescuehasacomparablerunningtimewith slowfuzz lessthanonesecondperregex evenifthejavaregex engine with our profiling modifications is magnitudes slower than thenativecregexenginepcre2.webelievethatsuchefficiency is due to our regex designated algorithms which quickly generate cost effective redos strings.
.
case study redos in popular github projects we searched the github for highly starred python and javascript projectsthatcontaineither editor web app ordatabase inthe project description.
we downloaded projects scanned them forregexes andtestedtheseregexesusingrescueinthedefault setting.
rescue found ten previously unknown redos vulnerabilities or defects in these projects and we reported them in the projects correspondingissuetrackingsystems.sixreportshavebeenconfirmed and several have already been fixed by the respective developer.some confirmed cases and simplified rescue generated redos strings are discussed as follows.
meteor 39k stars is a javascript app platform.
one of its regexes which is used to recognize comments in an html document is found vulnerable by rescue 1var hashhtmlblocks function text 2text text.replace n n !
?
s ?
n g hashelement vulnerable to n n !
n n !
n n !
... vx0 n n n !
!
n n n n !
vx0 n n !
this complex regex uses regex grammar extensions the ?
lookaround andthusstaticanalysesfailtoparseit.furthermore theredosvulnerabilityrequiresbothacertainprefixandacertain suffix to trigger making a black box fuzzing fall short.
none of the evaluated techniques can detect this vulnerability except for rescue.tui.editor .3k stars is a javascript wysiwyg markdown editor.
rescue found that its syntax highlighting component may be significantly slowed down under particular input combinations 1const strikeregex .
.
vulnerable to af af af af af af afxdhd ... 4const strike commandmana ger.command markdown ... 6hasstrikesyntax text return strikeregex.test text ... ace 17k stars is the ajax.org cloud9 code editor written in javascript.theregexforsyntaxhighlightingmayalsobestuckand thus impair the entire application 1this.removecapturinggroups function src varr src.replace ?
.
?
g function x y return y ?
?
x vulnerable to ?
?
?
... ?
?
x t x t return r open states .5k stars is a python crawler for gathering official pdffilesontheinternet.afterscanningallregexesinthesource code rescuefoundtwovulnerableregexes andoneisshownas follows 1defscrape lower self 2text ... 3days ... forday in enumerate days ifday date day else events re.split r n ?
w s?
n day vulnerable to na097a097a...097a4199613918 therefore amaliciouswebpagemaysetupacraftedpdffile and hang the crawler.
insummary webelievethattheevaluationresultsconfirmedthe effectiveness and efficiency of rescue in detecting redos vulnerabilities.thejavaimplementationfound49 morevulnerabilities compared with the best evaluated technique and has a comparable running time with a native c black box fuzzer.
the tool also detected cross language redos vulnerabilities in popular real world projects.
related work .
regex and redos regex is widely used in real world software projects.
for example a survey of regex usage shows that regex occurs in python projects.
current regexes have multiple flavors and also have different implementations of their matching engines .
however some regex grammars depend heavily on a backtrackingalgorithmandhavenotconsideredcarefullytheirunderlying formalization .
this fact on one hand makes e nfa backtracking irreplaceable and on the other hand sometimes makes these matching engines suffer from redos.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
ase september montpellier france y. shen y. jiang c. xu p. yu x. ma and j. lu redos isoneformofalgorithmiccomplexityattacks and this kind of attacks can be used to craft low bandwidth denialof service threats and even be used to attack some intrusion detection systems .
.
existing redos detection techniques due to the existence of such redos vulnerabilities researchers have proposed various techniques for detecting potential redos vulnerabilities before given regexes are fed to their matching engines.
existing redos detection tools can be mainly classified into two types as we discuss below.
.
.
staticanalysis.
thislineofworkisdedicatedtoformalize regex grammars and statically search attack patterns from them.however up to now there is still no static analysis tool that can formalizeallregexgrammarsandsupportcompleteredosanalysis.
we introduce several representative tools below.
rxxr2 isaredosstaticanalysistooldevelopedfrom rxxr .theauthorsproposedageneralattackstringpattern intheformof prefix pumpablestring suffix .to usethispattern they convert given regexes into an e nfa structure and with an efficientpatternmatchingalgorithm theysearchforinstancesof this pattern in the e nfa.
however due to the restrictions of their proposed e nfa converter regexes with extended grammars is out of the scope of their analyses.
rexploiter is a tool that not only detects redos vulnerabilities but also conducts taint propagation analysis to exclude user input unreachable regexes.
however this tool builds on a similar nfa alike structure as in rxxr2 and this foundation makes it also unable to parse extended regexes.
weidemanet.
al.
usea staticanalysismethodbased onthe pnfa todevelopannfaatoolfordetectingredosvulnerabilitiesforregexes.pnfaisanewautomatonmodel whichcan describenotionslike backreferencesandnamedgroups.however new attack string patterns based on this model need exploration and improvement.
sugiyama et.
al.
propose detecting redos vulnerabilities by simulatingtheregexmatchingprocessbyatreetransducer.they showthattreetransducingisformallyequivalenttoregexmatching andthatredosvulnerabilitiescanbedetectedbyanalyzingthetree transducer s size increment with trials of manual inputs.
however sincethisprocessreliesonhumanknowledge itisnotsubjectto automation.
.
.
dynamic fuzzing.
this line of work takes the idea of fuzz testing fromthesoftwaretestingcommunity.withthesupportofruntimeanalysis thiskindoftoolleavestheregexparsingto existing regex matching engines and is devoted only to generating time consuming strings for exposing potential redos vulnerabilities.
we also introduce several representative tools below.
slowfuzz is a general algorithmic complexity attack tool based on dynamic fuzzing.
it uses an evolutionary fuzzer based on libfuzzer to search for those inputs that can trigger a large number of edges in the control flow graph of the programunder testing.
however due to its generic nature slowfuzz has no knowledge about regex structures and this fact can cause some deep states of the program unreachable leading to false negatives.sdlfuzzerisanotherdynamicfuzzerforredosdetection developed by bryan sullivan from microsoft in .
however this tool has no longer been maintained and has no further update since then.
therefore the tool does not support many extended regexgrammars e.g.
lookarounds namedgroups atomicgroups backreferences and lazy or possessive quantifiers.
.
redos prevention or alleviation redosattackscanalsobepreventedoralleviatedbytwotreatments namely equivalent regex conversion and regex matching speedup as we discuss below.
.
.
equivalent regex conversion.
this treatment tries to find equivalentinvulnerableregexestoreplacetheoriginalonesthatare vulnerable to redos attacks.
for example cody kenny et.
al.
proposeapplyinggeneticalgorithmstofindanequivalentregexthat describes the same language as the given original regex and at the sametimeisfreeofanyredosvulnerability.thentheoriginalregex canbesafelyreplacedwithout affectingfunctionalities.however one limitation is that due to the lack of a testing input set that canenumerate allstringsin thelanguage theapproachmay not guarantee the equivalence between the newly generated regex and its corresponding original regex.
.
.
regexmatchingspeedup.
speeduptreatmentsforregex matching are possible for special cases where regexes contain only simple grammars whose matching can be optimized by dedicated techniques.
for example matching for basic regexes can be significantly speed up by parallel algorithms gpu based algorithms state merging algorithms and techniques that convert nfas to dfas .
we note that this can only alleviate the redosvulnerabilityproblem buttheconcernedregexesthemselves are still subject to complexity attacks.
conclusion this paper presents rescue a three phase technique to automatically detect regular expression denial of service redos vulnerabilities.
rescue seeds incubates and finally pumps an initial populationofstringstoobtainaredosattackstringwhosematching timeismaximized.theevaluationresultsshowthatrescueoutper formsstate of the arttechniquesindetectingredosvulnerabilities andfoundpreviouslyunknownvulnerabilitiesinpopulargithub open source projects.
finally the evaluation results also suggestthat there is space for improvement.
we plan to further enhance thethree phasealgorithmsformoreeffectivedetectionofredos vulnerabilities.