automatic test image generation using procedural noise matthew patrick matthew d. castle richard o. j. h. stutt and christopher a. gilligan department of plant sciences university of cambridge united kingdom mtp33 mdc31 rs481 cag1 cam.ac.uk abstract it is di cult to test programs that input images due to the large number of pixel values that must be chosen and the complex ways these values interact.
typically such programs are tested manually using images that have known results.
however this is a laborious process and limited in the range of tests that can be applied.
we introduce a new approach for testing programs that input images automatically using procedural noise and spatial statistics to create inputs that are both realistic and can easily be tuned to have speci c properties.
the e ectiveness of our approach is illustrated on an epidemiological simulation of a recently introduced tree pest in great britain oriental chestnut gall wasp.
our approach produces images that match the real landscapes more closely than other techniques and can be used alongside metamorphic relations to detect smaller arti cially introduced errors with greater accuracy.
ccs concepts software and its engineering !software creation and management software testing and debugging keywords software testing image processing test data generation .
introduction images are used as program inputs in elds such as medical imaging material analysis computer vision and urban environmental modelling .
the outputs of this software are often used to make important and sometimes even life critical decisions.
it is therefore essential to test the software thoroughly under a variety of conditions to ensure it will work correctly when needed.
for example facial recognition failed to identify the suspects after the boston marathon bombing even though their photographs were in an fbi database .
the problem was that the permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed for profit or commercial advantage and that copies bear this notice and the full citation on the first page.
copyrights for components of this work owned by others than the author s must be honored.
abstracting with credit is permitted.
to copy otherwise or republish to post on servers or to redistribute to lists requires prior specific permission and or a fee.
request permissions from permissions acm.org.
ase singapore c copyright held by the owner author s .
publication rights licensed to acm.
isbn .
.
.
.
.
4database photographs were taken under controlled conditions whereas the images taken at the scene were of poor quality and from far away.
we should therefore test image software with a large number of variations of each image.
imaging software is often tested using an established data set for which the expected results are known .
examples include the berkeley segmentation data set and the caltech object category data set .
publicly available image data sets make it possible to compare the performance and accuracy of commonly used imaging techniques.
however suitable data sets are unlikely to exist for software that performs bespoke operations.
it is labour intensive and can be error prone to create new data sets for each application so automated test data generation would be useful.
automated test data generation techniques can quickly produce a set of test data with speci c properties .
however few attempts have been made to address the challenges posed by image inputs.
it is di cult to generate test images automatically because of their high dimensionality large number of pixel values .
the relationships between pixel values are also often more important than the individual pixels themselves.
to address these challenges we introduce a new automatic approach for generating test images that have speci c target properties.
our approach can be used to generate variations of existing images or to explore the input space of all possible images that could be used.
the approach introduced in this paper uses procedural noise and spatial statistics two techniques from very different elds.
procedural noise has its origins in computer graphics for lms and video games .
it allows complex natural looking images to be constructed using simple tunable parameters.
by contrast spatial statistics arose from a need to understand complex processes in geography and geology .
they are used to characterise compare and make predictions about patterns in the spatial arrangements of values.
despite their di erences we have found these two techniques complement each other.
our approach combines procedural noise and spatial statistics in the following way .
multiple nested layers of procedural noise generate realistic images according to a set of parameters .
the parameters are optimised with a genetic algorithm using spatial statistics as the tness function .metamorphic testing is applied to compare the software output using the optimised images as input permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed for profit or commercial advantage and that copies bear this notice and the full citation on the first page.
copyrights for components of this work owned by others than acm must be honored.
abstracting with credit is permitted.
to copy otherwise or republish to post on servers or to redistribute to lists requires prior specific permission and or a fee.
request permissions from permissions acm.org.
copyright is held by the owner author s .
publication rights licensed to acm.
ase september singapore singapore acm.
... .
we illustrate our approach on a speci c example involving a highly complex epidemiological simulation which inputs images representing the geographic distribution of host species and outputs a stochastic prediction of the epidemic progress over time.
the results of this work represent a preliminary viability study of our approach.
after showing our approach to be successful on this case study we will continue our research by applying it to a wide variety of software producing test images with a diverse range of properties.
.
literature review there have been other attempts to generate images automatically for testing.
guderlei and mayer generated pixel values at random and positioned discs and squares randomly on the image.
just and schweiggert combine randomly produced red green and blue layers into colour images.
it is also possible to modify existing images e.g.
koljonen and alander applied motion blur and gaussian pixel noise to images of materials under stress and strain to test their optical extensometer still functioned correctly.
mantere and alander used a genetic algorithm to create test images for digital halftoning that maximise the di erence between the halftoned and original image.
they found evolving pixel values to be slow even on 16x16 images so optimised the position size and colour of shapes.
there are four main problems with the previous work .precision and generate images randomly so cannot be used to achieve speci c properties .e ciency found pixel value optimisation infeasibly slow even with very small images .flexibility adds noise to existing images it cannot be used to test software with new images .scalability the largest image generated in the previous work was just 256x256 pixels .
.
our approach in contrast with previous research our approach can be used to create more complex images with greater e ciency.
the images produced by our approach are tuned to speci c target properties using spatial statistics as the tness function to a genetic algorithm.
this allows us to test precise features of the software by evolving multiple di erent images with the same properties.
rather than optimising the value of each pixel separately we evolve simple parameters of procedural noise that have an e ect across the entire image.
this greatly simpli es the search space to make optimisation more e cient .
our approach is also highly exible able to automatically tailor the images generated to be similar to those used by the particular software under test.
it is scalable to larger images than those in the previous studies the images generated in this paper are 389x252 pixels .
the following subsections outline the main components of our approach procedural noise genetic algorithms spatial statistics and metamorphic testing and algorithm summarises the steps involved in generating test image data.
.
procedural noise the most basic form of procedural noise is white noise .
white noise is produced by sampling individual pixel values independently using a pseudo random number generator.
although its probability distribution may be adjusted white noise does not take into account the relationships betweenalgorithm automated test image generation choose target moran s i and pixel value histogram initialise candidates random number of layers each composed of sub layers frequencies and amplitudes while stopping condition not met do generate images from candidates using perlin noise transform images to match pixel value histogram calculate moran s i values on generated images select ttest images smallest di erence in moran s i apply mutation and crossover to update population end while utilise the ttest images in metamorphic testing neighbouring values.
images therefore appear patternless and cannot immediately be used to describe natural processes.
nevertheless more realistic images can be produced by combining and transforming white noise in various ways.
these transformation functions are used to create multiple complex sequences of values that may be reproduced using a set of simple parameter values and a random seed .
this is helpful for our purposes as we do not need to store every image we evaluate just the parameters that were used.
perlin noise is a well known procedural noise function that generates values by combining random vectors produced using white noise at each vertex of an interpolation grid.
unlike white noise the output of perlin noise changes smoothly from one value to the next.
perlin noise is parametrised by its frequency grid resolution and amplitude the size of contribution it makes to the image .
layers of perlin noise produced using di erent parameters can be added together to create more complex and natural looking images .
the frequencies and amplitudes of each layer are attenuated to create a fractal like e ect.
in our approach we combine multiple sets of attenuated perlin noise layers each with a di erent initial frequency and amplitude.
this allows for heterogeneity to occur at multiple levels of detail and for some layers to be made more prominent than others.
.
genetic algorithms we decided to tune the parameters of our image generation technique using a genetic algorithm because procedural noise generation is stochastic and we found the tness landscape to be noisy.
under these conditions local search techniques such as hill climbing can become stuck in local optima.
genetic algorithms avoid this problem by balancing the exploitation of existing solutions and exploration of new values using variation and selection .
variation creates new candidates by mutating and recombining the existing solutions.
the ttest candidates are selected and the weaker candidates removed so as optimisation progresses there is a trend towards increasingly tter solutions.
in our approach candidate solutions are structured as variable length lists whereby each item in the list represents a layer of noise with a speci c initial frequency amplitude and random seed .
this information is su cient to reproduce the image without needing to store the individual pixel values of each candidate considered by the genetic algorithm.
.
spatial statistics spatial statistics are used to characterise real world processes from a variety of elds including economics criminology urban environmental studies and epidemiology .
655first order metrics such as population density measure the composition of a landscape i.e.
how much of each property the landscape has in each area .
by contrast second order metrics assess the landscape s con guration i.e.
whether there are spatial patterns in the data .
our approach makes use of both rst and second order spatial statistics.
we use a rst order statistic histogram of pixel values to ensure images are generated according to a target distribution.
the images produced by our technique have their pixel values scaled such that the desired histogram distribution is achieved.
this is done before the moran s i tness score calculation to ensure this step does not a ect the second order spatial properties of the resulting images.
moran s i measures autocorrelation by comparing the values that occur in a particular neighbourhood with the average value for the landscape.
it is based on pearson s correlation coe cient see equation and measures how values change over di erent spatial lags i.e.
distances between pixels .
a positively auto correlated landscape which has all the high values clustered into one region and all the low values in another will have a moran s i value around .
by contrast a negatively auto correlated landscape which has an alternating pattern of high and low values will have a moran s i value around .
a landscape with complete spatial randomness will have a moran s i value of .
i np ip jwi jp ip jwi j xi x xj x p i xi x wi jis a matrix of neighbourhood weights between iandj .
metamorphic testing for many complex programs such as the epidemiological simulation in our case study it is di cult to know what the correct outputs of the software should be without using the software itself to nd out the answer.
it is therefore just as challenging to construct a test oracle as it is to develop the software correctly in the rst place.
metamorphic testing addresses this problem by circumventing the need to calculate the expected output values directly.
instead they use information about how the output is expected to change when the inputs are adjusted in a particular way.
in this paper we illustrate how the images produced by our approach can be applied to metamorphic testing of an epidemiological simulation.
we evolve images that have the same spatial properties as the original landscape and compare the outputs of the simulation on each image.
since the spatial properties are the same epidemics should progress at a similar rate.
however our simulation is stochastic so it produces a di erent result each time it is used.
we therefore compare the distributions of areas under the epidemic progress curves using a kolmogorov smirnov test.
if the distributions are di erent there may be a fault in the software.
.
implementation details we use a form of perlin noise known as ridged turbulence f x jperlin x j .
each dynamically evolved layer is composed of eight sub layers with persistence .
and lacunarity .
.
initially each candidate is given a poisson random number of layers with rate .
.
the amplitude for each layer is set to a uniform random number between and and the initial frequency is set according to the equation exp 5i wherei2 is the index of each layer.our genetic algorithm uses gaussian mutation single point recombination and roulette wheel selection.
the probability of mutation is .
and the probability of recombination is .
.
we use a population size of and a xed number of generations .
candidate images have their pixel value scaled using a log log histogram with bins.
moran s i is measured over spatial lags using the euclidean distance between pixels.
the calculated values are compared for relative di erence with the target values for the image using the sum of squares di erence metric.
.
case study we illustrate our approach on a simulation of oriental chestnut gall wasp ocgw .
an image is input representing the density of hosts in each grid cell plus initial conditions then the simulator outputs a set of curves predicting how the pest is likely to spread.
it is important the results are correct as they are used to advise government policy decisions for control.
however ocgw was rst observed in great britain in and so far has only been found at a few sites in south east england.
this lack of data makes it di cult to know what the correct outputs should be so metamorphic relations are important for testing.
we use the relation that landscapes which have the same spatial properties should produce the same epidemiological results.
in particular we are interested in knowing whether the parameter rate of secondary infection is processed and interpreted correctly.
this is important as it a ects how quickly an infected host infects the hosts that surround it.
.
research questions rq1 do the images produced by our technique match the target properties more closely than those produced by alternative techniques?
this question is evaluated by setting the target properties to be the same as the original image using the moran s i statistic and pixel value histogram .
we compare our technique with two alternatives random image generation and the poisson cluster process pcp to generate images that recreate these properties.
the alternative approaches are often used in spatial ecology research.
if our technique is successful the progress of the epidemic on the original image should be more similar to that on the images produced by our approach than the other two techniques.
rq2 is our technique more e cient at creating suitable images than the alternative techniques?
in addition to being able to create test images with the target properties it is also important our technique is e cient.
if it takes too much time then it may be di cult to use our technique in practice.
we therefore compare the rate at which images produced by our technique approach the target properties i.e.
lower the tness score and the time that is taken for these images to be produced.
if our approach is more e cient it should be able to achieve the target properties more quickly than the alternative techniques.
rq3 can our technique be used to nd faults more e ectively than the alternative techniques?
finally we consider the fault nding e ectiveness of 656the images produced by our technique using metamorphic relations.
arti cial faults are introduced into the parameter of the simulation the rate of secondary infection .
as the value of is increased we expect a di erence to be detected more often i.e.
fewer false negatives .
however when is left unchanged no difference should be detected most of the time few false positives .
in this way we can compare our technique with the alternative approaches in terms of the number of false negatives and positives it produces.
.
experimental methodology our original image represents the sweet chestnut landscape in kent where ocgw was rst found in great britain see figure produced using data from the forestry commission sub compartment database and national forest inventory.
the landscape resolution is set to 250m which makes the image x pixels.
we evaluate the epidemiological similarity of the new images with the existing image by running simulations from di erent starting locations on each of images produced by the techniques random pcp and perlin see figure .
random images are produced with a single layer of white noise we select the ttest solutions found using the same number of evaluations as the pcp and perlin noise approaches but pcp was extended using our multi layer evolutionary approach.
each layer consists of clusters and each cluster contains points.
points are normally distributed with the centre of each cluster following a poisson distribution.
amplitude is interpreted as with our perlin noise technique but instead of frequency we optimise the variance of the cluster distribution.
our pcp approach is therefore a novel technique but it was necessary to augment it this way to provide a competitive alternative.
figure example landscape images .
results .
answer to rq1 there are two ways in which we can compare the images produced by the techniques under evaluation with the original image of the sweet chestnut landscape.
first we should consider spatial statistics.
since moran s i is used in the tness function for our genetic algorithm these di erences provide information as to how well the optimisation process has achieved our target spatial statistics i.e.
similarity with the original image .
we can then evaluate how similar the outputs of the simulation are for each image in terms of the rate at which ocgw spreads.
this tells us how e ective optimising the spatial statistics has been in achieving epidemiological similarity with the original image.
table summarises the di erences in spatial statistics and epidemiological properties between the original image and the images produced by each technique random image generation the poisson cluster process and perlin noise proposed by this paper .
spatial di erences are measured usingthe sum square error in moran s i. unsurprisingly the differences are far greater for the random technique than for pcp or perlin.
this may be because random image generation is not optimised using the genetic algorithm applied by the other two techniques.
however the di erence is times larger for the poisson cluster process than for our perlin approach.
it is therefore not just the genetic algorithm that makes the di erence the image generation technique is also important.
perlin noise produces more realistic images and makes it easier to achieve spatial similarity by providing parameter values that have an e ect across the entire image.
figure .
shows the mean progress curves of ocgw in simulations run using the images produced by each technique.
although the simulations had not yet reached a point of equilibrium we stopped them after years as predictions made further into the future seem over reaching.
the di erences between the techniques are very clear.
epidemics take o very slowly when the images are produced randomly.
some of the poisson cluster process images o er realistic results but the variance is much higher.
images produced using our perlin approach are by far the most representative in terms of the similarity of their epidemic progress curve.
the areas under the epidemic progress curves auc conrm these results numerically see table .
the mean difference in auc for perlin noise is over times smaller than pcp and times smaller than the randomly produced images.
it is also signi cant that the auc results match the moran s i results when ordered by size of di erence.
in both cases perlin noise images are most similar to the original whereas randomly produced images are the least similar they also have the smallest variance since they are spatially homogeneous .
this suggests moran s i is a suitable metric for optimisation since images with the smallest di erences in moran s i are also the most similar epidemiologically.
table spatial and epidemiological di erences moran s i auc mean sd mean sd random .
.
.
pcp .
.
.
.
perlin .
.
.
.
figure ocgw epidemic progress curve .
answer to rq2 we evaluate rq2 by investigating the amount of time required by each technique to generate test images and the rate 657at which the tness of the images improves.
table shows random image generation is the fastest technique taking .
minutes on average whereas the poisson cluster process is the slowest minutes on average .
despite the large variance for pcp all these di erences are statistically signi cant student s t tests with bonferroni correction give p values of and for the di erences between random and pcp random and perlin pcp and perlin respectively with cohen s d e ect sizes of .
.
and .
respectively.
random image generation is therefore the fastest of the three techniques.
figure .
shows how the moran s i sum square error improves as more candidates are evaluated.
random image generation only reduces the error by .
of its initial value which makes it ine cient despite its advantages in speed.
by contrast pcp and perlin noise substantially reduce their error as optimisation progresses by .
for pcp and .
for perlin noise .
their tness had not quite stabilised after generations so this is likely to have improved further but we need to be aware most testers will only be willing to wait for a certain amount of time.
our perlin noise approach is more e cient than pcp as it reduces the error by a greater amount over a xed number of generations and each generation takes less time.
pcp may be slower because it adds times more layers than perlin noise as it struggles to match the target properties see table .
further improvements might be possible by simplifying the spatial statistic e.g.
reducing the number of lags or procedural noise e.g.
reducing the number of layers but we need to trade this against accuracy in the result.
table execution time and number of layers time min layers mean sd mean sd random .
.
.
n a pcp .
.
.
perlin .
.
.
.
figure optimisation progress .
answer to rq3 finally rq3 is evaluated by introducing arti cial faults into the input parameter of the simulations run on the generated images.
we then count the number of negative results of kolmogorov smirnov tests comparing the distribution of areas under the epidemic progress curves on newlyproduced images with those of the original image.
we consider a result to be negative if the p value is greater than .
.
it is necessary to compare the distributions of values in this way since the simulation we are testing is stochastic.
however there is still a possibility some p values will be greater than .
due to random chance.
we address this problem by running simulations on di erent images starting each one from a di erent location and then counting the number of negative results out of the images.
figure .
shows the results of these experiments.
we can interpret them in terms of the numbers of false positives and negatives.
a false positive occurs when a test indicates a fault that does not exist.
to see these we need to look at the results where i.e.
no change has been made .
the number of false positives is out of for our perlin noise approach but for pcp and for the random image generation.
unless perlin noise is used we are likely to conclude the simulation is faulty when it is correct.
the number of false negatives can be seen when is increased.
random image generation produces no false negatives but this is misleading since its epidemic progress curve is too dissimilar to produce any negative results.
pcp has its highest number of negative results when is increased by i.e.
it has more false negatives than true negatives.
the highest number of negative results should occur when but the pcp epidemic progress curve lies below that of the original image see figure .
so arti cial faults that increase move it closer to the correct position.
our perlin noise approach is the most useful of the three techniques since it has the lowest number of false positives and its general trend is to reduce the number of false negatives as the size of the fault gets larger i.e.
as increases .
there are a couple of points at which the number of false negatives increases when it should be decreasing but this is likely to be due to stochasticity.
however it only reaches zero false negatives once is increased by depending on the application this could be considered a large fault .
increases in may be detected by considering cases in which there are more than positives as a possible fault.
we could also increase the number of runs and lower this cut o further but this is likely to be more expensive .
figure ocgw negative results .
threats to validity we were careful to address any internal threats to validity by repeating our experiments over trials on im658ages produced using each technique.
since we are comparing three di erent approaches random image generation poisson cluster process and perlin noise we need to be aware of the multiple comparisons problem.
therefore when using the student s t test we applied the bonferroni correction.
external threats to validity are potentially more signi cant to our work.
we have shown our approach to generate test images more e ectively than the alternatives but there is no guarantee it will work as well for other software.
we plan to evaluate this issue in our future work.
however the approach we have presented is modularised so that it is easy to adjust each component to further tailor its performance.
.
conclusions programs that input images are di cult to test because of the large input domain of pixel values that need to be explored.
we have introduced a new approach to address this problem using procedural noise spatial statistics genetic algorithms and metamorphic testing.
our approach can be applied to generate complex natural images that are tuned to speci c properties for use in testing.
the image generation process is controlled by a set of simple parameters that can be e ciently evolved by a genetic algorithm.
we illustrated our approach on a stochastic spatially explicit simulation for a tree pest in great britain.
this software is di cult to test because of its complexity and the lack of a suitable oracle or test data.
however we showed that in situations such as this we can use our technique to produce new image test data with similar spatial properties as the original image.
by applying metamorphic relations this test data can be used to identify faults more accurately with fewer false positives than the alternative techniques.
.
further work we intend to continue this work by applying our approach to software in a variety of di erent elds such as medical imaging material analysis and computer vision.
we will also use the images our technique produces to test software in new ways e.g.
through other metamorphic relations.
the aim of future work will be to discover the capabilities of our approach identifying the types of software and tests it is most e ective for.
throughout this process we will evaluate the various implementation decisions we have made using sensitivity analyses on each application so as to tune our approach to be as e ective as possible in every situation.
we will extend our approach for use with images that have a more complex structure such as those which involving several distinct parts.
one way to achieve this is by combining our approach with the shape overlaying technique of other researchers .
each shape can contain a di erent texture produced by our approach.
we can use our approach to generate images with a wide variety of target properties not just those that match the original images.
we will therefore investigate how best to explore these options considering techniques such as fuzz testing and program analysis to generate suitable test images as e ciently as possible.
.