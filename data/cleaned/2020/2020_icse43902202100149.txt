app s auto login function security testing via android os level virtualization wenna song wuhan university wuhan china swenae whu.edu.cn yi xiang wuhan university wuhan china xiangyi whu.edu.cnjiang ming the university of texas at arlington arlington tx usa jiang.ming uta.edu y uan chen wuhan university wuhan china sairen whu.edu.cnlin jiang independent researcher xian china pppaass .com jianming fu wuhan university wuhan china jmfu whu.edu.cnhan yan wuhan university wuhan china cool.yim whu.edu.cn guojun peng wuhan university wuhan china guojpeng whu.edu.cn abstract limited by the small keyboard most mobile apps support the automatic login feature for better user experience.
therefore users avoid the inconvenience of retyping their id and password when an app runs in the foreground again.
however this auto login function can be exploited to launch the so called data clone attack once the locally stored auto login depended data are cloned by attackers and placed into their own smartphones attackers can break through the login device number limit and log in to the victim s account stealthily.
a natural countermeasure is to check the consistency of devicespecific attributes.
as long as the new device shows different device fingerprints with the previous one the app will disable the auto login function and thus prevent data clone attacks.
in this paper we develop vpdroid a transparent android oslevel virtualization platform tailored for security testing.
with vpdroid security analysts can customize different device artifacts such as cpu model android id and phone number in a virtual phone without user level api hooking.
vpdroid s isolation mechanism ensures that user mode apps in the virtual phone cannot detect device specific discrepancies.
to assess android apps susceptibility to the data clone attack we use vpdroid to simulate data clone attacks with most downloaded apps.
our experiments on five different virtual phone environments show that vpdroid s device attribute customization can deceive all tested apps that perform device consistency checks such as twitter wechat and paypal.
vendors have confirmed our report as a zero day vulnerability.
our findings paint a cautionary tale only enforcing a device consistency check at client side is still vulnerable to an advanced data clone attack.
i. i ntroduction with the prosperous development of the android system and mobile networks the apps running on android keep updating constantly to meet the fast growing demand of smartphone users.
in addition to the standard functionalities such as communication and entertainment apps are now performing various critical tasks such as social networking gps navigation iot device remote control and mobile payment .
inevitably large amounts of private data e.g.
user credentials are stored in the smartphone.
therefore the corresponding author guojpeng whu.edu.cn.
key laboratory of aerospace information security and trust computing ministry of education school of cyber science and engineering wuhan university.cyber arms race between bypassing user authentication and its countermeasure has transformed into an intensive tug of war.
according to v erizon s data breach investigation report of network intrusions exploited weak or stolen credentials.
over the past decade the attacks to take over smartphone user accounts also generated a large body of literature.
we particularly examine the high impact attacks and find out that their root causes lie in either fundamental design flaws or the system s underlying vulnerabilities.
just as severe security vulnerabilities in android password manager apps allow attackers to access the stored credentials man in the middle mitm attacks exploit the password reset vulnerability to crack a mobile user s account password and the recently developed app virtualization technique defies android unique user id mechanism causing guest apps vulnerable to the shared everything threat .
in this paper we focus on the security risk caused by mobile apps auto login functions which belongs to client side tampering vulnerabilities .
most of the existing mobile apps support automatic login to optimize the user experience.
it avoids the hassle of retyping user id and password in a small keyboard when reaccessing the app.
mobile users have gotten used to using the autologin feature due to its convenience.
however if an attacker steals the auto login depended data from a user s device and replaces his data with the user s the attacker can bypass the login device number limit and access the user s account without raising suspicion we call it as a data clone attack.
in this paper the meaning of credential or the auto login depended data is a token or user identity.
initial investigations have studied this threat but all of them are limited to victim identity theft on a rooted device.
furthermore they missed an important fact an increasing number of apps check device consistency to prevent client side tampering if they detect any device specific discrepancies their auto login functions will be disabled.
we present a new attack model that can break through the paying subscriber limit on non rooted devices.
for many subscription based apps such as netflix amazon prime ieee acm 43rd international conference on software engineering icse .
ieee video and apple music their revenue models impose a maximum number of the same user s login from different devices at a time.
for example netflix s basic plan only allows to stream high definition hd video on one device at a time.
a fraudster first pays netflix s basic plan fee.
then he leverages an oem made phone clone app to launch a data clone attack.
the oem made phone clone app can copy private data between the same oem phones without rooting devices.
in this way the fraudster enjoys the premium plan service watching hd video on multiple screens at the same time.
this new attack model can even enable non paying customers to use premium services completely free of charge.
to assess android apps susceptibility to data clone attacks we perform an empirical study on most downloaded apps from american and chinese android app markets study .
study is presented in iii.c we perform data clone attacks with real devices.
our tested apps have billions of users in total.
after performing data clone attacks we can successfully bypass user authentication and access apps including facebook snapchat qq and weibo.
we further study the failure causes of the remaining apps and find out that they have already taken actions to secure the auto login function.
the most common strategy is to check the consistency of device footprints when the app is resumed such as checking android id mac address and international mobile equipment identity imei .
if any device specific discrepancies are detected the app will disable the automatic login and users have to retype their id and password manually.
some critical apps e.g.
paypal can even fingerprint a rooted device and the android runtime hooking framework xposed which can create an app virtualization environment to modify device attributes.
not wanting to stop there we explore android os level virtualization to develop a transparent device attribute editing platform named vpdroid .1vpdroid provides a customizable native performance virtual phone vp environment on a single physical device.
the vp runs a standard android environment and security analysts can configure the vp with up to options to simulate a smartphone s profiles.
vpdroid facilitates testing an app s capability of detecting the change of device as well as the resilience against the data clone attack.
vpdroid is a heavily modified version of cells which is the first mobile os virtualization solution to support running virtual phones on a single os instance.
unfortunately cells s virtualization methods to many hardware devices e.g.
filesystem network display and power have been obsolete since android .
.
besides cells lacks virtualization support for bluetooth gps and android debug bridge adb .
we improve the multiplexing of hardware devices in two ways rewriting kernel drivers e.g.
gps to adapt to new android version updates we develop a new user level device virtualization mechanism to virtualize proprietary devices which are completely closed source.
more importantly vpdroid supports editing the vp s device specific attributes.
we carefully design where to edit device attributes all customization functions are executed outside of the vp .
our isolation design vpdroid means running a virtual phone on android system.ensures that a user mode app running in the vp is unaware of device specific differences.
vpdroid has been tested to work seamlessly across android .
and android .
.
we repeat study in section vii but on top of the custom virtual phone.
we install vpdroid in a google nexus 6p smartphone and redo study by configuring the vp as five different environments xiaomi redmi note redmi note 4x huawei honor 6x honor and google nexus 6p .2in each vp we can compromise all of the most popular apps accounts including apps that perform device consistency checks.
we have made responsible disclosure to the app vendors and of them have confirmed our report as a zero day vulnerability.
at last we discuss possible countermeasures to defeat data clone attacks.
our study demonstrates that only enforcing device consistency checks is still vulnerable to an advanced data clone attack.
in a nutshell we make the following three significant contributions our work reveals the security risk of android apps autologin functions.
in a addition we introduce a new attack model that can break through the paying subscriber limit on non rooted devices.
we improve the android os level virtualization technique to develop a transparent device attribute editing platform.
security analysts can simulate more diversified vps on a single device.
all of our tested apps are deceived into thinking that the device is not changed.
vpdroid has broad applications that rely on a virtual phone environment.
our clone attack demo video https youtu.be cs6lxbdgpxu shows that vpdroid enables the attacker to bypass kakaotalk s device consistency check and the victim is unaware that her account has been compromised.
we release vpdroid s source code at ii.
b ackground and rela ted work in this section we first discuss the security risk of automatic login in mobile apps.
existing works on exploiting android apps auto login functions are limited.
then we introduce oem made phone clone apps which we take as a vector to clone private data.
at last we describe the principle of android os level virtualization which is the foundation of vpdroid.
a. automatic login in mobile apps limited by the small scale touchscreen typically only one app is running in the foreground of a smartphone and users frequently switch to other apps in the background.
it is rather cumbersome having to type id and password every time users access an app.
to optimize the user experience most mobile apps support the automatic login feature by default.
as a result users only need to input their id and password at their first login time.
after that users can access the app smoothly without retyping their id and password.
for all of our tested apps their auto login functions still work even when we kill their processes and restart them later.
most auto login functions store user credential data locally and complete the authentication process with the app server 2two nexus 6p phones are different in cpu model and rom size.
1684automatically.
user credential data are the security tokens used to certify a user s identity with the app server.
after the user first enters id and password to go through the authentication process the app locally stores user credential data for future verification purposes.
android provides four options to save app private data internal file storage external file storage shared preferences and databases.
user credentials are typically stored either in the form of keyvalue pairs as sharedpreferences or structured data in an sqlite database.
both of them are under the private directory of data data and other apps typically do not have the privilege to access them.
b. exploiting auto login function works and limitations if attackers steal the locally stored auto login depended data and put them under the same directory of a different phone attackers can leverage the auto login feature to bypass the authentication from the server side.
this means attacks can automatically log in to the victims accounts without knowing their id and password.
we take wechat a social media app with over billion daily active users as a case study.
wechat stores aesencrypted user credentials in a sqlite database file enmicromsg.db .
this file is under the directory of data data micromsg in which xxxx...xxxx is the bit md5 value of a file name.
in addition to enmicromsg.db we find wechat s auto login function also relies on multiple files under the same directory and a system configuration file data data micromsg systeminfo.cfg .
systeminfo.cfg is an xml plaintext containing the connection information with the app server.
apparently only cloning enmicromsg.db is not enough at all.
note that the exact files that are needed by the auto login function vary on a case by case basis.
therefore the best strategy is to clone all of the data under data data to the target device.
recent papers have exploited the pervasive auto login feature in android apps .
these studies share two common assumptions the victim s device has been rooted.
attackers either have physical access to the victim s rooted device or the malware to steal credential data has been installed on the rooted device.
rooted android devices are very common in countries outside of north america especially in asian countries.
tencent research shows that of chinese users had a rooted device .
besides according to the official android security report large families of harmful applications use privilege escalation exploits to root devices.
these papers demonstrated the feasibility of data clone attacks with a very small number of apps only six apps in total.
however none of them take device consistency checks into consideration.
we still take wechat as an example to explain the limitation of existing work .
we clone all of the data under data data micromsg to a new smartphone but we still cannot automatically log in to wechat.
wechat pops up the login interface and asks us to retype id and password.
the root cause is the change of a smartphone environment is almost udphexiihu lqghu 6hqvruv hylfh 1dphvsdfh lqx .huqho 3rzhu 5rrw 1dphvsdfh 9luwxdo 3krqh ruhjurxqg 9luwxdo 3krqh dfnjurxqg figure cells kernel level device virtualization overview.
the vp running in the foreground is displayed at any time and always given direct access to hardware devices.
instantly detected by wechat and then it terminates the autologin process.
we find wechat detects device footprints such as phone number imei and bluetooth address.
in our dataset a total of apps such as chrome apple music kakaotalk and paypal also conduct a similar detection when invoking their auto login functions.
bianchi et at.
also simulate device public information to bypass user authentication.
they exploit an entire class of apps that only rely on device public information to authenticate the user to their backends.
however in our tested most downloaded apps no one adopts such a weak authentication scheme including whatsapp and viber that were once vulnerable in this paper.
another major difference is that they customize only device public profiles in the xposed framework by hooking apis.
by contrast we improve os level virtualization to deliver an open source more transparent device attribute editing platform which can edit device artifacts without user level api hooking.
c. oem made phone clone apps iii b will describe paying subscriber fraud in which a fraudster leverages oem made phone clone apps to launch data clone attacks on non rooted devices.
phone clone apps are getting popular in various android app markets.
all of the top android phone manufacturers custom their own phone clone apps such as samsung smart switch huawei phone clone and xiaomi mi mover.
most of them have been downloaded more than million times.
these oemmade phone clone apps have a unique advantage they have the privilege to call android backup api on the same oem phones.
therefore in addition to contacts call logs photos and data in external storage they are able to transfer app private data in data partition between the same oem phones without rooting devices.
for example smart switch can seamlessly transfer app private data and home layouts 1685between galaxy devices and it is similar for other oem made clone apps.
this advantage brings users great convenience when they upgrade their devices the cloned smartphone just becomes the replica of the old device and apps behave exactly as if they are still on the old device.
d. android os virtualization we apply android os level virtualization to editing devicespecific artifacts.
mobile virtualization means running multiple separate instances of smartphone environments on the same physical device.
unlike desktop and server machines resource constrained mobile devices limit the adoption of hypervisor based virtualization while os level virtualization becomes an acceptable option.
cells is the first lightweight os level virtualization solution to run multiple isolated virtual phones on a single android instance.
in each virtual phone vp a user can execute unmodified apps and perform normal smartphone operations.
cells made most hardware device virtualization in the linux kernel layer and figure shows an overview of cells s kernel level virtualization architecture.
the vp running in the foreground is displayed at any time and always given direct access to hardware devices .
cells invents a new device namespace mechanism to support efficient hardware resource multiplexing and each vp is associated with a unique device namespace for device interaction.
to make various hardware devices aware ofdevice namespaces cells virtualizes kernel interfaces in three ways create a device driver wrapper modify a device subsystem modify a device driver.
unfortunately cells s design lacks flexibility.
many heavilymodified kernel drivers are susceptible to new android version updates.
since android .
cells s virtualization to many hardware devices has been obsoleted.
in addition it also lacks device virtualization solutions for bluetooth gps and adb their artifacts are commonly used to fingerprint different devices.
even cells s commercial version cellrox3 is only compatible with android .
.
our work bridges the gap in mainstream android versions.
iii.
p aying subscriber fraud device consistency check in this section we first describe the unique benefit of exploiting auto login functions to bypass user authentication.
next we introduce a new data clone attack model payingsubscriber fraud.
then we perform data clone attacks with most downloaded apps.
our results show that data clone attacks are a real threat to both the app economy and user privacy especially when skilled attackers are able to simulate a hi fi smartphone environment.
a. data clone attack s advantage compared to the case that the attacker can intercept the user s password the unique benefit of the data clone attack is much stealthier.
the reason is that the login process by typing the user s id and password would trigger the detection of the login device number limit on the server side.
many apps only 3cellrox mobile virtualization platform can only use one phone number for kakaotalk.
if you are already using this phone number on another device you can no longer use the kakaotalk on that device.
cancel continuere verification is required as your device information has changed.
the data stored on your device will be preserved even if you reverify your account ok a b figure kakaotalk s warning notifications.
allow a single user to log in from one device at a time.
this means the legal user and the attacker cannot be online simultaneously by typing the user s id and password.
for example when an attacker logs in to a messaging app kakaotalk from a different phone by typing the victim s id and password the attacker s phone will receive a warning notification as shown in figure a .
however our key observation is counting the number of login devices is not affected by multiple auto login attempts from the same device which leaves a backdoor for us to break through the login device number limit.
as a result the user s sensitive data will be in jeopardy without raising suspicion.
if a social messaging app is compromised in this way the adversary can not only review chat history in real time but also impersonate the victim to send messages.
our demo video shows such an identity theft example.
when the legal user is online the attacker cannot log in to kakaotalk by typing the same user s id and password.
furthermore kakaotalk can detect the change of a new device.
it disables the auto login after we copy the data in the directory of data data kakaotalk to a new device see figure b .
in contrast we perform a data clone attack after we customize vpdroid s vp with the old phone s profiles.
we find the victim and the attacker can be online at the same time without raising suspicion.
b. paying subscriber fraud the subscription based app economy thrives in mobile markets and customers have acclimated to the idea of regular payments for a better service .
typical examples are the apps that provide video and music streaming services such as y outube netflix amazon prime video iqiyi and y ouku video.
for a subscription based app only a paying subscriber can enjoy its premium service and it also enforces the maximum number of the same user s login from different devices at a time.
for example netflix s premium plan allows at most four screens that a user can watch on simultaneously.
as counting the number of login devices is typically not affected by multiple auto login attempts from the same device even with a non rooted device a fraudster can use an oemmade phone clone app to perform data clone attacks and break through the paying subscriber limit.
figure illustrates such an example and eventually the fraudster can access android premium apps in multiple devices without payments.
although figure shows a single user fraud case once this attack model is turning into full fledged coordinated attacks wwdfnhu qvwdoo qvwdoo 3krqh 3krqh 6lqjoh 8vhu udxg l l rwvsrw 6hqg edfnxs gdwd 5hfhlyh dqg uhvwruh gdwd 1hwiol rq 3ulph 9lghr .. r rrjoh 3od 0xvlf l4l l rxnx 7hqfhqw 9lghr 0dgh 3krqh orqh ss xwrpdwlf orjlq uhtxhvw 6xffhvvixo ss 6huyhu 3krqh figure data clone attacks distribute auto login depended data for the paying subscriber fraud.
in the android black market malicious actors can infringe the revenue model of subscription based apps resulting in tremendous financial losses to software vendors.
most of the zero day vulnerabilities that we found belong to this category and the leading app vendors such as netflix amazon xiaomi tencent and alibaba have confirmed our findings.
c. experiments with most downloaded apps we test data clone attacks with popular apps from american and chinese android app markets where have the largest user base in the world.
the selection criteria are the app is among the top apps in that market it has more than million downloads.
after that we have to install each app on a real device to test whether it can work properly.
for example some apps have regional restrictions.
finally we obtain top apps from google play store and top apps from huawei xiaomi app markets.
their distributions are shown in the second column of table i. one of them is the subscription based app which relies on the user s regular payments to provide a better service.
besides it also uses the number of connected clients in their pricing model.
the citation provides more details to advocate the subscription based app economy.
for the smart home apps we also purchase related smart home devices including one smart lock two security cameras and one smart light bulb to test whether we can control them after launching a data clone attack.
there are three ways to collect backup data from victim users for launching a data clone attack.
like the assumption held by related work attackers either have physical access to the victim s rooted device or the malware to steal credential data has been installed on the rooted device.
if we assume that the users devices are not rooted attackers can still exploit phone clone app vulnerabilities to intercept private user data.
cve is such a zeroday vulnerability we found.
we exploit this vulnerability and perform the mitm attack during data transmission.
for example when the app sets up a wi fi hotspot to transfer data between two phones we can perform arp spoofing to successfully intercept data frames on the wlan and then launch a data clone attack.
a concurrent work from acsac demonstrates this type of vulnerability is popular.
as thetable i the number of successes when performing dataclone attacks with real devices xposed based sandbox and vpdroid respectively.
xposed based sandbox and vpdroid have been configured to match the victim phone s profiles.
apps real device xposed vpdroid social media payment subscription smart home sum users who perform the subscription fraud has full control of the device they can use the oem made phone clone app to test subscription apps.
the third column of table i lists the number of successes when performing data clone attacks with real devices.
we can automatically log in to out of apps.
table ii shows the examples of these compromised apps including prominent apps that have been downloaded for more than one billion times e.g.
facebook whatsapp qq and sina weibo .
the attacks on smart home apps result in a more severe consequence because we can remotely control all smart devices associated with our tested smart home apps.
for example we are able to unlock the smart lock and turn off the smart light bulb and security cameras.
d. device consistency check for the remaining failed cases when we run them in the new device they exhibit one of the following responses the app terminates and exits the app requests the user to type id and password again.
many apps also pop up a new window showing that the app is running on a different device.
therefore it is very likely that these apps have already detected the change of device and thus disabled the automatic login.
to confirm our conjecture we clone these apps to an xposed based device attribute editing tool xxsqmanager .
it provides a virtual environment on top of the android framework in which a user can edit device attributes via api hooking and thus deceive guest apps.
we install xxsqmanager in huawei honor .
this tool provides 65configuration options and we edit all of them as the same profiles with our old phone xiaomi redmi 1687table ii the successful examples of data clone attacks with real devices.
due to the space limit we only list top apps in the number of downloads.
type apps social mediafacebook qq instagram snapchat whatsapp messenger tinder telegram pinterest sina weibo paymentpinduoduo didi letgo iherb offerup postmark shpock gofundme banggood lazada subscriptionnetflix amazon prime video kkbox hulu bbc news y ouku video amazon music iqiyi netease cloud music smart home mi home smart camera table iii the successful cases that are newly added when performing data clone attacks in xposed based sandbox.
type apps social medialine microsoft outlook douban toutiao baidu tieba tiktok douyin wickr bigo live paymentbest buy netease kaola ctrip 5miles geek kfc subscription tunein radio qingting fm note .
for the attack model of paying subscriber fraud as fraudsters own the device in advance they can run a third party device information tool to collect complete device artifact data.
the xposed column of table i shows the number of successes when performing data clone attacks with an xposedbased sandbox.
compared to the experiment with real devices we have compromised apps that are newly added see table iii .
our new experiment confirms that some apps have already performed some device consistency checks to secure their auto login functions but their detections can be easily evaded by the user level api hooking mechanism.
however the app virtualization technique is not entirely transparent to guest apps .
for example xposed s hooking mechanism leaves identifiable fingerprints in package names call stack methods suspicious native methods and shared objects loaded into memory .
we find some cloned apps such as alipay and apple music can also detect the existence of xposed based sandbox and thus prevent data clone attacks.
in what follows we explore os virtualization to provide a transparent and customizable virtual environment.
iv .
vpd roid system design we develop a lightweight android os level virtualization architecture vpdroid to assist apps account security testing.
with vpdroid security analysts are able to configure different device attributes according to a target phone s profiles and then boot up a virtual phone vp environment that closely approximates the target device.
moreover our solution enables device attribute editing operations not to interfere with the host device s normal operations.
to deceive the cloned apps into thinking the smartphone is not changed vpdroid has to meet two requirements req1 req2 req1 the vp always gets direct access to hardware devices this design provides a close to native virtual environment with high performance.
req2 user mode apps in the vp are imperceptible to the change of device this requires our virtualization and device attribute customization functions are invisible to user mode apps running in the vp .
vpdroid is built on top of cells because its foreground vp design meets req1 .
however cells exhibits three major limitations.
cells fails to meet req2 it is not designed to edit device attributes.
like api hooking cells s user level device virtualization modifies the vp s application framework layer which can be detected by vp s apps.
cells s kernellevel device virtualization to many hardware devices are not compatible with android .
and later versions anymore.
we improve cells significantly to achieve our requirements on mainstream android versions.
a. overview figure provides an overview of vpdroid s system architecture.
please note that as a virtualization framework vpdroid can smoothly run five virtual phones.
however only the vp running in the foreground can always directly access all hardware devices which is indispensable to satisfying both req1 and req2 .
therefore we maintain one vp in this paper.
the isolated vp runs a stock android userspace environment.
vpdroid utilizes linux namespaces as well as the device namespace introduced by cells to transparently remap os resource identifiers to the vp .
the vp has its private device namespace so that it does not interfere with the host.
we keep cells s kernel level device virtualization methods that still work in recent android versions including input e.g.
touchscreen and input buttons and sensors e.g accelerometer and light sensors .
we also keep the custom process celld in the host device s root namespace.
celld manages the starting and switching of vps and it also coordinates our adb virtualization adb is used for copying data to the vp .
since android .
android os has introduced a new vendor interface between the android os framework and the vendor implementation .
we improve cells s kernel level device virtualization methods in the binder power management and core network resource to be compatible with device changes in new android systems.
our key method is to rewrite the source code of kernel drivers so that they are aware of the device namespace.
besides we add gps virtualization by rewriting dev gss driver to support multiple connections.
vpdroid system development is heavy in engineering.
in the next two sections we present our two significant improvements to cells.
first we design a new user level device virtualization solution with better portability and transparency than cells see v .
second vpdroid can customize the vp s device attributes but this function is not offered by cells see vi .
v. n ewuser level device virtualiza tion for cells s obsolete device virtualization solutions rewriting every kernel driver is error prone and complicated.
especially some hardware vendors provide proprietary software 168888vhu ohyho hylfh 9luwxdol dwlrqfhoo6huylfh hoo lqghu qsxw 1dphvsdfh slg xwv pqw qhw xvhu lsf ghylfh lqx .huqho1hwzrun1hwzrun 3rzhu oxhwrrwk7hohskrq lvsod qsxw lqghu9luwxdol hg hylfhv urxs fkurrw lqghu 6huylfh 6kdulqj6xuidfh olqjhu lil6huylfh hylfh 1dphvsdfh 3ur oxhwrrwk 6huylfh 5l 3ur rvw 5rrw 1dphvsdfh oxhwrrwk l l lvsod 5l 3rzhu0dqdjhu 6huylfh6huylfh0dqdjhu qsxw0dqdjhu rfdwlrq0dqdjhu 6huylfh1hw 6huylfh hoo v yluwxdol dwlrq uhxvhg e urlg .huqho hyho hylfh 9luwxdol dwlrq hoo v yluwxdol dwlrq prglilhg e urlg 1hz yluwxdol dwlrq dgghg e urlg 6hqvruv 6hqvruv.huqho ohyho hylfh 9luwxdol dwlrq lohv vwhp xglr 9luwxdo 3krqh figure vpdroid s device virtualization architecture kernel level user level and our changes to cells.
stacks that are completely closed source.
without hardware vendor s support it would be difficult if not impossible to virtualize them in the kernel.
vpdroid s user level virtualization offers a flexible and portable alternative without leaving any in guest virtualization component .
our mechanism contains two methods to virtualize different devices.
binder service sharing.
for the system services that are registered in servicemanager e.g.
wifiservice we develop a new way to virtualize them.
binder is the inter process communication ipc mechanism in android.
the binder driver is a custom pseudo driver with no corresponding physical device.
we first modify the binder driver data structure e.g.
context mgr node procs and dead nodes to ensure that the vp has its own binder driver data structure.
in addition we create a new specific handler in binder s data structure and make it point to the host s context mgr node .
ascontext mgr node is associated with servicemanager with this handler the vp can access the host phone s servicemanager node.
therefore this mechanism allows a service process in the vp to share the corresponding service in the host system.
furthermore we leverage selinux technology to enforce which services in the host system can be shared by the vp .
in vpdroid wifi configuration are virtualized in this style.
device namespace proxy.
for the anonymous services that are not registered in servicemanager as the kernel does not have their binder node andbinder ref structures we cannot apply binder service sharing.
instead we virtualize them by creating a new device namespace proxy in the hostuserspace only.
this proxy communicates the vp service through binder service sharing or socket.
it distinguishes the vp s request from the host s request by their associateddevice namespaces and interacts with kernel drivers to respond to the vp s request.
in vpdroid telephone are virtualized using this method.
next we use wifi configuration and telephone as examples to present our new user level device virtualization mechanism.
a. binder service sharing wifi configuration wifi configuration and status notifications occur in the userspace.
wpa supplicant is a user level library that contains wireless network service code 0in figure .
cells replaces wpa supplicant inside the vp with a wifi proxy which forwards all configuration requests from the vp to the host s wpa supplicant .
in contrast we leverage our proposed binder service sharing to achieve the same goal but leaving no change in the vp s userspace.
in the android system wifiservice calls the library of wpa supplicant to detect wifi connections and such information is sent through networkagent to connectivityservice which answers app queries about the state of network connectivity.
we use the binder service sharing mechanism to share wifiservice between the vp and the host system.
the blue two way line in figure represents the workflow to answer a wifi status query from the vp s app .
besides we create a new networkagent in the host system and bind it to the vp s device namespace.
as shown in figure s red line to automatically forward network status notifications to the vp rvw 8vhuvsdfh lqx .huqho rvw lqghu lil6huylfh1hwzrun jhqw 1hwzrun jhqw zsdbvxssolfdqw l l dyd 1dwlyh qwhuidfh 6huyhu olhqw lqghu vhuylfh vkdulqj93 8vhuvsdfh rqqhfwlylw 6huylfh lil0dqdjhu ss lqghu 7kh dss lq uhfhlyhv qhwzrun vwdwxv qrwlilfdwlrqv 7kh zruniorz wr dqvzhu d l l vwdwxv txhu iurp wkh dss lq figure vpdroid leverages binder service sharing mechanism to virtualize wireless configuration management.
we also use the binder service sharing mechanism to transfer the new networkagent to the vp s connectivityservice.
finally the vp succeeds in receiving the status notifications of wifi connectivity.
b. device namespace proxy telephony figure a shows the standard android radio interface layer.
as smartphone vendors customize their own proprietary radio stack cells adopts a user level device namespace proxy to provide a separate telephony functionality for a vp .
a vp has its own proxy radio interface layer ril library.
the ril proxy is loaded by radio interface layer daemon rild and connects to celld running in the host s root namespace and celld in turn communicates the hardware vendor library to respond to the vp s requests.
however the ril proxy is visible to vp s apps which does not meet our req2 .
as shown in figure b we implement a socket interface based proxy scheme only in the host userspace and it does not require the assistance of celld.
in the host s radio interface layer we create a rild proxy between the communication flow of android telephony java libraries ril java and rild.
then we create another two standard unix domain sockets in the proxy.
one socket connects to the ril java of the vp and the other one connects to the ril java of the host system.
the ril java in the vp communicates with the host system s proxy and the proxy passes the communication data e.g.
dial request and sim to the host system s rild.
in turn the rild proxy passes the vp related arguments e.g.
call ring and signal strength to the vp s ril java over a socket.
vi.
c ustomize the vp sdevice attributes based on the new android os level virtualization framework we go one step further to customize the vp s device attributes.
figure shows the workflow.
vpdroid users provide a configuration file build.vpdroid.prop in advance which stores device specific attributes in the form of key value5 dyd 9hqgru 5lo rvw 8vhuvsdfh ulyhuv dvhedqg lqx .huqho ulyhuv lqx .huqho dvhedqg5 dyd rvw 8vhuvsdfh 5lo 9hqgru d qgurlg 5dglr qwhuidfh d hu e urlg 5dglr qwhuidfh d hu93 8vhuvsdfh 5l 3ur dyd figure vpdroid virtualizes telephony by creating a device namespace proxy in the host userspace only.
pairs.
we classify these key value pairs into three categories android system properties user level virtualized device properties and kernel level virtualized device properties.
each category has a different customization method.
besides we incorporate multiple namespaces to isolate our customization.
android system properties.
android system properties stored in the init process s shared memory describe the configuration information of the smartphone such as brand model serial number imei and android id.
these const values have nothing to do with our device virtualization.
other processes enquire about android system properties at run time by calling property get an api for native code to read the data in the shared memory from other processes.
when booting up the vp we enforce the vp s init process to load the customized android system properties from build.vpdroid.prop into the vp s shared memory space 1in figure .
user level and kernel level customization.
the customized data for both user level virtualized and kernel levelvirtualized devices are loaded into the host init process s shared memory .
we use the ipc namespace for the host and vp shared memory isolation .
our customization functions are located at the places where we just finish user level device virtualization or kernel level device virtualization .
all of the customization functions work in a similar style.
they first determine whether the current query request is from the vp or the host by checking the associated device namespace.
for a user level customization function if the query is from the vp it calls property get to get the customized data from the host s shared memory and then returns the custom data to the vp .
however for a kernellevel customization function the customized data loaded into the init process have no privilege to enter the kernel space.
therefore we create a new system call to copy data from the userspace to the kernel space .
the advantages of vpdroid customization.
compared with existing android device attribute editing tools our customization solution revels distinct advantages.
first 16906kduhg 0hpru 8vhu ohyho yluwxdol hg hylfh 3urshuwlhv rvw lqlw surfhvv .huqho ohyho yluwxdol hg hylfh 3urshuwlhv surshuw bjhw xvwrpl hg vfdoo71 1dphvsdfh rvw 0hpru exlog urlg surs hv hv393 0hpru qgurlg vwhp 3urshuwlhv lqghu 6huylfh 6kdulqj 3ur 3urfhvvhv 1dphvsdfh lvsod xvwrpl dwlrq xqfwlrqv oxhwrrwk rvw 8vhuvsdfh.huqho ulyhuv 1dphvsdfh dwwhu xvwrpl dwlrq xqfwlrqv .huqho 9huvlrq.huqho 6sdfh93 urlg hylfh 9luwxdol dwlrq rfdwlrq 7hohskrq surf phplqir surf fsxlqir vwhp 3urshuwlhv 9luwxdol hg hylfh 3urshuwlhv hoo 6lwh figure vpdroid s workflow of customizing device specific attributes.
.
.
.
.
.
linpack quadr.
2d 3dmark quadr.
i o sunspider networknative phone vp a normalized nexus 6p results00.
.
.
.
.
linpack quadr.
2d 3dmark quadr.
i o sunspider networknative phone vp b normalized nexus 6p results00.
.
.
.
.
linpack quadr.
2d 3dmark quadr.
i osunspider networkna ve phone vp c normalized nexus 6p music results .
.
.
.
.
linpack quadr.
2d 3dmark quadr.
i osunspider networkna ve phone vp d normalized nexus 6p music results01282563845126407688961 no apps browser browser emailbrowser email calend rna ve phone vp e nexus 6p memory usage in mb01282563845126407688961024 no apps browser browser emailbrowser email calend rna ve phone vp f nexus 6p memory usage in mb figure vpdroid s performance measurements.
quadr.
is short for quadrant all of our customization functions do not rely on any userlevel api hooking mechanism and they are executed outside of the vp s runtime environment.
this means our device customization is invisible to vp s user mode apps.
although our user level device virtualization allows the vp s process to share certain services in the host system with the device namespace isolation a user mode app running in the vp is still unaware of device specific differences.
second our vp s customization does not interfere with normal operations on the host device.
system modifications without leveraging oslevel virtualization lack flexibility and compatibility.
besides they are very difficult to achieve the same transparent and stealthy capability as vpdroid as blindly changing return values of apis syscalls is likely to cause system crashes or exceptions e.g.
bluetooth system services keep restarting .
due to the multiplexing of hardware devices vpdroid avoids incompatibility issues by decoupling device attribute editing operations from normal operations on the host device.vpdroid now can support customizing device configuration options which span a broad spectrum of device attributes.
we collect these options from existing work on the android device artifact detection.
to the best of our knowledge vpdroid offers the most comprehensive android device attribute editing options so far.
vii.
vpd roid ev alua tion the vp images are created on a pc and downloaded to the host device via usb.
we provide a control center app for vpdroid users to efficiently switch between the vp and the host system.
to start a new vp to simulate a different device a user takes the following three steps exiting the original vp updating and replacing a new build.vpdroid.prop configuration file stating a new vp via the control center app.
this section first provides performance measurements to show that vpdroid reveals native performance.
in our second experiment we use the data clone attack as a case 1691study to evaluate vpdroid s capability on device attribute customization.
our results show that vpdroid substantially increases the success rate of the data clone attack.
a. performance measurements we measure runtime overhead and memory usage using two google nexus 6p phones that are different in cpu model and rom size nexus 6p arm cortex a53 adreno gpu 3g ram and 32g rom and nexus 6p arm cortex a57 adreno gpu 3g ram and 64g rom .
we follow similar experimental settings with cells s paper in sosp .
our runtime overhead measurement contains two scenarios.
the first one is running a set of benchmark apps on vpdroid s vp and a native phone respectively.
the second one is running the same benchmark apps on the vp and the native phone but simultaneously with an additional background music player workload.
all results are normalized against the performance of running the same benchmark apps on the latest manufacturer stock image available for google nexus 6p but without the background workload.
each benchmark app is designed to stress some aspect of the system performance linpack v1.
for cpu quadrant advanced edition v2.
.
for 2d graphics and file i o 3dmark v2.
.
for 3d graphics sunspider v1.
.
for web browsing and networking using busybox wget v1.
.
to download a single 409m video file through a pc s wi fi hotspot.
figure shows the normalized runtime overhead and memory usage on two nexus 6p phones.
compared to cells 1vp s data vpdroid reveals the same level of variability in measurement results and it is even better than cells in quadrant i o sunspider and network results from to .
cells s performance data were obtained using nexus and nexus s. we admit that the hardware upgrade caused by nexus 6p also favorably impacts our results.
the deviations between vp and native phone in figure a figure d represent the additional overhead caused by vpdroid s device virtualization.
the negligible deviations indicate no user noticeable performance difference between running in vpdroid and running natively on the phone.
the major difference from cells is memory usage.
for example after booting up vp with no apps running cells s memory usage is mb but this number increases to mb for vpdroid.
as would be expected the android os s size is also bloating.
as shown in figure e and figure f the memory usage in the vp is less than the native phone in all workload cases.
the reason is due to the lightweight os level virtualization the memory consumed by kernel services only occurs at the host device.
b. virtualization assisted data clone attack we repeat our data clone attacks with most downloaded apps see iii c in vpdroid.
in particular we take google nexus 6p as the host machine and configure the vp environment as xiaomi redmi note redmi note 4x huawei honor 6x honor and google nexus 6p respectively.
these five vp environments represent five victim devices and we provide five different device attribute configuration files for vpdroid to load.
in spite of the diversity we achieve the same resultstable iv zero day vulnerabilities that we found.
the third column shows the vulnerability id or the vendor s confirmation time.
the app s name in bold represents this app takes the device consistency check to protect its auto login function.
app v endor vul.
id or conf.
time netflix netflix prime video amazon kugou music tencent vulbox tencent video tencent iqiyi iqiyi y ouku video alibaba wps office kingsoft zhihu zhihu cnvd university mooc netease cloud classroom netease unipus unipus cnvd dragonfly fm dragonfly cnvd liulishuo laix cnvd cad quick look glodon cnvd vivavideo quwei cnvd yizhibo yizhibo cnvd smart camera qihoo mi home xiaomi mi mover xiaomi cve for all cases.
the last column of table i shows the success number of data clone attacks in vpdroid we can compromise all of the most popular apps accounts.
compared with the attacks on a real device vpdroid wins by additional apps among them 86apps can detect xposed based sandbox but fail to detect vpdroid.
note that our attacks failed at first for some apps that rely on android accountmanager apis to manage the auto login function e.g.
y outube google play twitter and skype .
the reason is accountmanager stores auto login depended data under the directory of data system xx rather than data data .
after we copy the data system xx folder to the virtual phone in our second try out our data clone attacks succeeded.
to make sure no app can detect the change of device in vpdroid we perform another comparative experiment with an oem made backup app.
it has the privilege to call android backup api on the same oem phones so it can backup and restore user private data in data partition.
we first use this oem made backup app to backup our tested apps and then restore them.
next we keep a record of the apps whose auto login functions still work after backup restore.
we treat the effect of this experiment as launching a data clone attack on the same device.
however if one of these apps fails to automatically log in after we clone its auto login depended data to the vp it means this app finds vpdroid s environment is different from the original device.
however we did not find such a counterexample.
this confirms that our device virtualization and customization are transparent to cloned apps.
vendor reaction .
table iv lists the zero day vulnerabilities we have identified.
we find that chinese vendors take our findings more seriously than american vendors.
for example netflix confirms our vulnerability finding but they treat it as a single user fraud threat.
we confirm that with the latest netflix version .
.
our data clone attack without vpdroid still succeeds.
by contrast chinese vendors such as alibaba tencent and iqiyi have labeled our findings as high middle severity vulnerabilities.
we speculate that chinese 1692vendors are more vulnerable to paying subscriber fraud.
for example iqiyi an online video app with more than million users has labeled our report as a high severity vulnerability and added device consistency checks in the new release version.
however we have evaluated the latest version of iqiyi in vpdroid and found that vpdroid can still bypass the newly added device consistency checks.
viii.
d iscussion the most fundamental method against data clone attacks is that a mobile app never stores user credential data in local files.
however this strategy at the cost of sacrificing usability only works for critical apps that do not require frequent user interactions.
another direction is to leverage a trusted execution environment e.g.
arm trustzone to encrypt decrypt user credential data before use.
as the decryption key is stored in the trustzone environment data clone attacks cannot copy the decryption key to another device together with encrypted user credential data and therefore the server will fail to verify the login credentials.
the recent papers truapp and imvisor explore the feasibility of protecting app integrity and sensitive data with trustzone and rubinov et al.
s work partitions a critical app automatically for trustzone .
a natural response to breaking through the login device number limit is to monitor concurrent sessions at the app server side.
unfortunately the variable nature of mobile devices e.g.
the switch of wifi hotspot and cellular data makes it difficult to determine an adequate number of concurrent sessions.
the previous work has pointed out that although many apps do not permit duplicate logins from different devices they do allow multiple session requests from the same device id.
our evaluation also confirms that most apps allow maintaining two or more connections per user.
as the login from vpdroid shows a different ip address from the victim s ip a possible countermeasure is to detect multiple concurrent ips at the server side.
however this strategy cannot completely thwart data clone apps.
for quite a few apps such as facebook and the smart home apps we tested they do allow multiple logins from different devices.
we do not assume that detecting the presence of vpdroid is strictly impossible but it can prohibitively increase the cost.
if an app in the vp has the root privilege it can find out the footprint of our user level device virtualization.
for example vp s telephony java libraries do not interact with vp s rild.
the auto login function could check the consistency of some obscure device properties that are not covered by us and finding all of them is an open problem.
ix.
c onclusion in this paper we characterize research and evaluate the data clone attack and its client side countermeasure device consistency check.
our technical contribution is to develop a transparent device attribute customization platform via android os level virtualization.
our evaluation with mostdownloaded apps demonstrates that the data clone attack is an imminent threat leading to great losses to the app economy and user privacy.
we wish our study and open source vpdroidhelp researchers redesign apps auto login functions and evaluate the device artifact detection capability.