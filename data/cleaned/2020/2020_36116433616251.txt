etherdiffer differentialtesting onrpcservicesof ethereum nodes shinhae kim the affiliatedinstitute of etri daejeon southkorea shinhae1106 nsr.re.krsungjae hwang sungkyunkwanuniversity suwon southkorea sungjaeh skku.edu abstract blockchain is a distributed ledger that records transactions among usersontopofapeer to peernetwork.amongall ethereumisthe most popular general purpose platform and its support of smart contracts led to a new form of applications called decentralized applications dapps .
a typical dapp has an off chain frontend andon chainbackendarchitecture andthefrontendoftenneeds interactionswiththebackendnetwork e.g.
toacquirechaindata ormaketransactions.therefore ethereumnodesimplementthe officialrpcspeci f icationandexposeauniformsetofrpcmethods to the frontend.however the speci f ication is not sufficient in two points lackofclari f icationfornon deterministiceventhandling and lack of speci f ication for invalid arguments.
to effectively discloseanydeviationscausedbytheinsufficiency thispaperintroduces etherdiffer that automatically performs differential testing on four major node implementations in terms of their rpc services.
etherdiffer f irst generates a non deterministic chain bymulti concurrenttransactionsandpropagationdelay.then it appliesourkeytechniquescalledproperty basedgenerationand type preserving mutation to generate both semantically valid and semantically invalid yet executable test cases.
etherdiffer executesthetestcasesontargetnodesandreportsanydeviationsin errorhandlingorreturnvalues.theevaluationshowedtheeffectiveness of our test case generation techniques with the success ratiosof98.
and95.
respectively.also etherdiffer detected different classes of deviations including implementation bugs such as crash and denial of service bugs.
we reported of the detectedclassestothespeci f icationandnodedevelopersandreceived acknowledgementsaswellasbugpatches.lastly itsigni f icantly outperformedtheofficialnodetestingtoolineverytechnicalaspect.
we believethatourresearch f indingscan contributeto more stable dapp ecosystem byreducing the inconsistenciesamong nodes.
ccs concepts software and its engineering software testing and debugging theoryofcomputation programanalysis securityandprivacy distributed systems security .
sungjae hwang is the corresponding author.
permissionto make digitalor hard copies of allorpart ofthis work for personalor classroom use is granted without fee provided that copies are not made or distributed forpro f itorcommercialadvantageandthatcopiesbearthisnoticeandthefullcitation onthe f irstpage.copyrights forcomponentsofthisworkownedbyothersthanthe author s mustbehonored.abstractingwithcreditispermitted.tocopyotherwise or republish topostonserversortoredistributetolists requirespriorspeci f icpermission and or a fee.
request permissions from permissions acm.org.
esec fse december san francisco ca usa copyright heldby the owner author s .
publicationrightslicensed to acm.
acm isbn ... .
blockchain ethereumnodes rpc services differential testing acmreference format shinhaekimandsungjaehwang.
.etherdiffer differentialtestingon rpcservicesofethereumnodes.in proceedingsofthe31stacmjointeuropean software engineering conference and symposium on the foundations of software engineering esec fse december san francisco ca usa.acm newyork ny usa 12pages.
introduction ablockchainisadistributedledgerontopofapeer to peernetwork andrecordstransactionsamongusers.itistechnicallyagrowinglist ofdatastructurescalledblocks andeachpeersharesthesamecopy of the list to prevent any arbitrary modi f ications.
a block contains various transactionaland network state data suchas transactions eventlogs andaccount states.
when a usersubmits a transaction one of the peers forms a block with the transaction and broadcasts ittothenetwork.oncereceived eachpeerindividuallyvalidates the incoming block and appends it at the end of its chain.
since introducedbysatoshinakamotoin2009 blockchaintechnology has mademuchprogressandbecame atop future trend .
out of all ethereum is the most popular general purpose blockchain platform with billion dollars of market capitalization .
itconsistsofethereumpeersreferredtoas nodes andsupports general purposesmartcontracts.thecontractsareprogramsthat are implemented in high level programming languages like solidity and deployed on the network.
users can execute their functions bysubmittingtransactionswith contractaddressesand arguments speci f ied.
as smart contracts enable the automation of service logic there has been a popularity increase in decentralized applications dapps .accordingtostatistics thereexist2 ethereumdappsspanningovervariousserviceslikepaymentsand auctions and31 usersmade atotalof79 transactionsina single day.
also the top dapps have the transactionvolume of approximately6.88billiondollars intotal .
a decentralized application consists of an off chain frontend and an on chain backend.
the frontend is what users interact with and thebackend isa number ofsmartcontracts to handle core application logic.
however the off chain component needs frequent interactions with its backend network for e.g.
acquiring chain states ormakingnewtransactions.
therefore ethereumnodes offer remote procedure call rpc services and expose a set of rpcmethodsthatthefrontendcanrelyon.meanwhile thereare anumberofdifferentimplementationsofethereumnodesindifferent programming languages.
according to the official ethereum page esec fse december3 san francisco ca usa shinhaekim andsungjae hwang this makes the network stronger and more diverse.
theidealgoalistoachievediversitywithoutanyclient dominatingto reduce any singlepointsoffailure.
to enable uniform rpc services among nodes the ethereum foundation de f ines an official speci f ication that their rpc method implementations should comply to.
the speci f ication has a briefdescriptionofeachmethodandde f inesregularexpressions for valid arguments and return values.
however the speci f ication is not sufficient in two points.
first it has no clari f ication on expected behaviorsincaseofnon deterministicchainevents.forexample whilethere wasaquestioninethereummagiciansforum what stheexpectedbehaviorof eth getlogs iftheblockhashdoesnot correspondtoanyblock?this isnotjust atheoreticalconsideration sincechainreorganizations mightcause ablockhash to nolonger be valid.
thequestionercon f irmedthatsomeimplementationsreturn error code with an unknown block message while others simply return an empty array.
second the speci f ication does not state anything on return values in case of invalid arguments such as values out of the allowed ranges.
while there was an attempt to standardize error codes among nodes the proposal has been stagnant formore thanthree years.it canbe problematicif nodes behavedifferentlyasatleast63 ofdappsrelyonthird partynode providers thatmaintainapoolofvarioustypesofnodesand seamlesslyservewithadifferentonebasedonblack boxloadbalancers .forexample abugreportininfura themostdominant node provider showcases that a user unconsciously experienced inconsistent results when they queried the latest block number .
toeffectivelyinvestigateanydeviationsintermsofrpcservices thispaperpresents the f irstsyntax andsemantics aware differential testing approach.
also we implemented etherdiffer that applies our approach to four different node implementations that together takeupapproximately99.
ofthemainethereumnetwork .
tofacilitatebetterunderstanding wede f ineafewtermsasfollows de f inition1 non deterministicchain .ifagenerationmechanism producesadifferent chaineverytime thestateofwhichisunpredictable the resultingchain iscallednon deterministic.
de f inition semantically validness .atest caseis semanticallyvalid if allmethodcallarguments matchthe expectedsemantics.
de f inition3 semantically invalidness .atestcaseissemanticallyinvalidif any argument disconformsto the expectedsemantics.
particularly this research overcomes three technical challenges the generation of semantically valid test cases the generation of semantically invalid yet executable test cases and the enforcementofchainstateconsistencyamongnodespriortotest case executions.
etherdiffer f irst constructs a local network that consists of four nodes each from a different implementation as well as auxiliary nodes for chain evolution.
then it generates a non deterministic chain by making multiple and concurrent transactionsthatactivelyproduceeventlogsandstatechanges.also we made minimum instrumentation on the nodes to mimic real world propagationdelay andtrigger non deterministic chain events.
ontopofthegeneratedchain etherdiffer overcomesthe f irst twochallengesbyourkeytechniques property basedgenerationandtype preservingmutation.we f irstde f inedadomain speci f ic language dsl thatcapturesthetypeandsemanticrequirement whichwecall property foreachmethodargument.then weconvertedthespeci f icationofrpc triggeringmethodsintoourdsl which we denote as specdsl.
based on specdsl etherdiffer generatessemantically validtemplatecodewhereallargumentssatisfy their properties.
the template code is yet another valid test case but not boundto a speci f ic rpc servingnode.also etherdiffer stochasticallymutatesoneoftheargumentstoturnthetemplate codesemantically invalid whilepreservingtheexecutability.then itproducesasetoffourtestcasesbybindingthetemplatecodewith eachtarget node andcross checkstheir executionreturn values.
thelastchallengeistoenforcethechainstateconsistencyamong nodeswhenexecutingtestcasesasitsinconsistencycanleadtofalse alarms.etherdiffer implements a two phase architecture generation and testing phase.
during the generation phase the auxiliary nodes operate to evolve the chain.
then once the chain reaches thecon f iguredheight theiroperationsstopand etherdiffer begins its testing phase after all target nodes are synced.
also we implemented a save and restore strategy asa transaction sending testcasechangestheoriginalchainstate.theevaluationshowed that our techniques generated both semantically valid and invalidyet executabletestcaseswiththesuccessratiosof98.
and95.
respectively.also etherdiffer detected48deviationclassesincluding11implementationbugssuchascrashanddenial of service bugs.
we reported of the detected classes and received