managing data constraints in database backed web applications junwen yang university of chicago usa junwen uchicago.eduutsav sethi university of chicago usa usethi uchicago.educong yan university of washington usa congy cs.washington.edu alvin cheung university of california berkeley usa akcheung cs.berkeley.edushan lu university of chicago usa shanlu uchicago.edu abstract database backed web applications manipulate large amounts of persistent data and such applications often contain constraints thatrestrictdatalength datavalue andotherdataproperties.such constraintsarecriticalinensuringthereliabilityandusabilityof theseapplications.inthispaper wepresentacomprehensivestudy on where data constraints are expressed what they are about how often they evolve and how their violations are handled.
the results show that developers struggle with maintaining consistent dataconstraintsandcheckingthemacrossdifferentcomponentsand versions of their web applications leading to various problems.guidedbyourstudy wedevelopedcheckingtoolsandapi enhancements that can automatically detect such problems and improve the quality of such applications.
introduction .
motivation constraints are often associated with data used in software.
these range from describing the expected length value uniqueness and other properties of the stored data.
correctly specifying and checkingsuchconstraintsarecrucialforsoftwarereliability maintainabil ity andusability.thisisparticularlyimportantfordatabase backed webapplications whereahugeamountofdatageneratedbymillionsofusersplaysacentralroleinuserinteractionandapplication logic.
furthermore such data persists in database and needs to continueservingusersdespitefrequentsoftwareupgrades and datamigration .asaresult consistentlyandcomprehensively specifyingdataconstraints checkingthem andhandlingconstraint violationsare of uttermost importance.
to better understand these challenges consider an issue reported by users of redmine a popular project management web application written using ruby on rails.
when a user tried to createawikipage sheinitiallyleftthe titlefieldempty whichled tothe titleisinvalid errormessageshownnexttothe titlefield she then put in a long title but got a title is too long maximum is permissionto make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed forprofitorcommercialadvantageandthatcopiesbearthisnoticeandthefullcitation on the first page.
copyrights for components of this work owned by others than acm mustbehonored.abstractingwithcreditispermitted.tocopyotherwise orrepublish topostonserversortoredistributetolists requirespriorspecificpermissionand ora fee.
request permissions from permissions acm.org.
icse may seoul republic of korea 2020association for computing machinery.
acm isbn ... .
!
figure crossstack data constraints characters error finally she tried a title a little shorter than characters butthewebpagethencrashedwithallthefilledcontent lostwithsomeunreadabledatabaseerror displayed.
it turned out that different constraints were specified for the titlefield across different components in redmine.
as shown infigure1 thefront endhtmlfile views wiki new.html.erb usedaregularexpression .
tospecifythatthetitleshouldhavea positivelength theapplicationmodelfile models wiki.rb instead usedrails validates length of apitolimitthemaximumtitle length to be finally in the database schema file schema.rb the titlefieldisdeclaredas varchar limitingthemaximumlength to be .
thisexample illustrates how common it is for database backed webapplicationstospecifyandcheckconstraintsforthesamepiece of data in different code components the front end browser the applicationserver andthedatabase.assuchcomponentsareoften separatelydevelopedandmaintained theycouldholdconflicting assumptions about the same piece of data.
such inconsistencies canlead tovariousreliability andusabilityproblems.
particularly apieceof datathatpassesallbutthedatabase checkingoftenleads to a web page crash as in the above example.
consider another example in diaspora the most popular social network application written using ruby on rails according to application stars in github .
in earlier versions the password lengthisallowedtobethreecharactersorshorter.inoneversion developersdecidedthatpasswordsshouldbelonger probablyfor security concerns.
they then added a constraint ...... to the password field of the log in page requiring the password to be at least characterslong.
asa result manyusers whose passwordswere .
oe oufsobujpobm pogfsfodf po 4pguxbsf ohjoffsjoh table highlight results of our study alltheidentified issues are in latest versions of these applications rq1 how are constraints specified in one software version?
how .
per loc many?
.
per data field of data fields have constraints where?
in db in application in front end24 of application constraints are missing in db rq2 how are constraints specified across versions?
of versions contain constraint changes of changes tighten constraints on existing data fields rq3 what led to real world constraint problems?
where of studied issueswhat of studied issueswhen of studied issues how of studied issues rq4 can we identify constraint problems in latest version?
where string fields have length constraints in db but not in app.
fields forbidden to be nullin app.
but nullby default in db fields required to be unique in app.
but not so in db in ex clusion constraints specified in app.
but missed in db133 conflicting length numericality constraints between app.
and db what incorrect case sensitivity constraints identifiedhow missing error message problems identified api default error message enhancement preferred in user study shorter than characters can no longer log in and are shown with the unhelpful please use the required format error.
thisexampledemonstratesthatinasoftwareworldwherenothingenduresbutchange itischallengingtomakelong livingpersistentdataendurefrequentcodechanges whichmayintroduce neworevenconflictingrequirementstopersistentdatafields.such a conflict can lead to upgrade failures user unfriendly error pages and software misbehavior like that in the above examples.
insummary effectivelymanagingconstraintsforthehugeamount of persistent data in database backed web applications short as web applications is critical and challenging.
to understand the challenges involved we first perform a comprehensive study to understand the specification checking maintenance and violation handlingof data constraints in web applications.
.
contributions in this paper we aim to answer four key research questions about real worlddatabase backedwebapplications aslistedintable1bycomprehensivelystudyingthesourcecode thecommithistory and the issue tracking system of popular ruby on rails applications thatrepresent most common web application categories.
for rq1 we wrote scripts to collect and compare constraints expressed in various components of the latest versions of the applications.
we found that about three quarter of all data fields are associated with constraints.
in total there are hundreds to over one thousandconstraints explicitly specified in each application averaging1.
.6constraintsspecifiedper100linesofcode.data presenceanddatalengtharethetwomostcommontypesofconstraints while complicated constraints like the relationship among multiplefieldsalsoexist.wealsofoundthathundredstothousands of constraints specified inthe database are missing in the application source code and vice versa which can lead to maintenance functionality andperformanceproblems.thedetailsarepresented in section .forrq2 wecheckedhowdataconstraintschangethroughout the applications development history.
we found that about of all thecode changes related todata constraints is aboutadding new constraints or changing existing ones on data fields that have alreadyexistedinsoftware.thesechanges regardlessofwhether theyareduetodevelopers earliermistakesorwarrantedbynew code features can easily lead to upgrade and usage problems for datathatalreadyexistsinthedatabase.thedetailsareinsection5.
for rq3 we thoroughly investigated real world issues that are related to data constraints.
we categorize them into four major anti patterns inconsistency of constraints specified at different places which we refer to as the whereanti pattern inconsistency between constraint specification and actual data usage in the application which we refer to as the whatanti pattern inconsistencybetween data constraintsbetween differentapplicationversions whichwerefertoasthe whenanti pattern and problemswithhowconstraint checkingresultsaredelivered i.e.
unclearormissingerrormessages whichwerefertoasthe how anti pattern.
these four anti patterns are all common and difficult to avoid by developers they led to a variety of failures such as web pagecrashes silentfailures software upgradefailures poor userexperience etc.
the details are presented in section .
forrq4 wedevelopedtoolsthatautomaticallyidentifymany data constraint problems in the latest versions of these applications as highlighted in table .
we found around where problems including many fields that have important constraintsspecified in the database but not in the application or vice versa as well as over fields that have length or numericality i.e.
numericaltypeandvaluerange constraintsspecifiedinboththe database and the application but the constraints conflict with each other.
we also found issues in which the field is associated withcase insensitiveuniquenessconstraints butareusedbythe application in a case sensitive way the what anti pattern as well as two problems related to missing error messages the how anti pattern .
we manually checked around randomly sampled problems and found a low false positive rate across differenttypesofchecks.nottooverwhelmapplicationdevelopers we reported of these problems to them covering all problem categories.wereceived49confirmationfromthedevelopers nofeedback yet to the other reports among which our proposedpatches for of those problems have already been merged into theirapplicationsor included in the next major release.
wealsodevelopedarubylibrarythatimprovesthedefaulterror messagesoffiverailsconstraint checkingapis.weperformeda user study with results showing that web users overwhelmingly prefer our enhancement.
the details are presented in section .
overall this paper presents the first in depth study of data constraintproblemsinwebapplications.ourstudyprovidesmotivationsandguidelinesforfutureresearchtohelpdevelopersbetter managedataconstraints.wehavepreparedadetailedreplication packageforthedata constraint issuestudyandthedata constraint checking tools inthis paper.
thispackage is available onthe webpageofouropen sourcehyperloopproject aprojectthataims to solve database related problems in orm applications.
table different types of constraints in web apps run timecheck source code specification specification location location language api front end view html reg.
expression applicationservermodel ruby built in validation api model ruby custom validation api model controller ruby custom sanity check databaseservermigrationfiles ruby activerecord migration api migrationfiles sql sql altertable queries background .
architecture of web applications applications built using the ruby on rails framework are structured using the model view controller mvc architecture.
for example when a web user submit a form through a url like acontroller action wikis create is triggered.
this action takes in the parameters fromtherequest e.g.
release intheurlas params and interacts with the database by calling the activerecord api implementedbytherailsobject relationalmapping orm framework.
rails translates activerecord function calls into sql queries awritequeryinthiscase whoseresultsarethenserializedinto modelobjects e.g.
the wikimodel and returned to the controller.
thereturnedobjectsarethenpassedtothe viewfilestogenerate a webpagethat issent backto users.
eachmodel isderived from activerecord and is mapped to a database table by rails.
a view file ends with .erbor.haml usually involves multiple languages includinghtml javascript and ruby.
.
constraintsin web applications weroughlycategorizedataconstraintsintothreetypesbasedon where they are checked and specified as shown in table .
front endconstraints.
developerscanuseregularexpressions to specify constraints about a particular html data field insidea view file such as the pattern .
for the titlefield in figure .
the majority of such constraints are related to persistent data maintained by the database.
suchconstraintsarecheckedwhentheusersubmitsawebform.
failuretovalidatewillcausetheformsubmissiontofail withan error message specified by developers shown next to the correspondinghtmlfield withallthepreviouslyfilledcontentsremain on the page.
application constraints.
rails developers use validation functionstospecifyconstraintsofdatafieldsinmodelclasses.similar mechanisms exist in other orm frameworks such as validatorfunctions in django and validator annotations in hibernate .
avalidationfunctionisautomaticallytriggeredeverytimewhen the application saves an object of the corresponding model class i.e.
whentheormframeworksavesthecorrespondingrecordinto the database .
validation failure will cause the corresponding form tofail.theerrormessageassociatedwiththevalidationfunction will be shown to web users if developers put error checking and error messagedisplaycode in the view file.rails validation functions include built in ones which cover many common constraints like text field lengths i.e.
validates length of asshowninfigure1 contentuniqueness validates uniqueness of content presence validates presence of as wellascustomones wheredevelopersexpressmorecomplicated constraintslike keeping a strict order among multiple fields.
developerscanalsoconstrainadatafieldthroughcustomsanity checks althoughthey are uncommon in rails.
databaseconstraints.
many data columns are associated with constraints inside the database db like the varchar constraint shown in figure .
these constraints are specified in the ap plications migration files which are used to alter database schema over time.the majorityofthem morethan .
in ourstudied applications arespecifiedthroughrailsmigrationapis andare veryrarelyspecifiedthroughsqlqueriesdirectly 30casesacross all applications we checked .
these constraints are checked by the db when an insertor updatequerytothecorrespondingcolumnsisissued eitherby the application or db administrator .
if the check fails the application will throw an activerecord statementinvalid exception toindicateanunderlyingdberror.unfortunately inpractice developers almost nevercatch such exceptions it is caught in only cases across thousands of model object saves across the applicationswestudied .hence oncetriggered thewebuser ssessionwill most likely crash with all the filled in contents lost with a cryptic sql error shown to users.
why are the constraints distributed across components?
front end constraints are specified for web form input data which isoftenrelatedtodbrecord e.g.
usedasqueryparameters compared with query results etc.
.
validation functions and db constraintsarespecifiedonlyfordatabasefields andarecheckedright before saving data into the db.
the expressiveness of these two are similar most constraints that are expressible using validation functions can also be written using sql queries or migration apis andviceversa.complicatedconstraintsexpressedusingcustomvalidation functions can be expressed in the db layer as constraint checks or custom stored procedures.
however neither layer can replacetheothergiventheexistenceof backdoors e.g.
dbadministratorsupdatingdata using thedb console or sharingthe same db across multiple applications.
both are common practices .
methodology .
applicationselection there are many orm frameworks available e.g.
ruby on rails django hibernate etc.
.amongthem railsisthemostpopularon github.thus westudied12open sourcerubyonrailsapplications including the top two most popular ruby applications from sixmajor categories of web applications on github discourse ds and lobster lo are forums gitlab gi and redmine re are collaborationpplications spree sp androrecommerce ro are ecommerce applications fulcrum fu and tracks tr are task management applications diaspora da and onebody on are socialnetworkapplications openstreetmap os andfallingfruit ff aremapapplications.allofthemhavebeenactivelydeveloped for years with hundreds to tens of hundreds of code commits.
table of data constraint issues in our study and the total of issues in the issue tracking system ds lo gi re sp ro fu tr da onff os studied total table data constraints in web applications ds lo gi re sp ro fu tr da on ff os db app 176html total loc 62k 11k 122k 35k 31k 17k .7k 13k 21k 14k .8k 14k col colc882 colc75 loc linesof code.
col number of data columns stored in the database.
col c. numberofcolumnsassociatedwithconstraints.customsanitychecknotconsidered.
.
issueselection section studies the root causes and symptoms of real world data constraintproblemsusing114reportssampledfromtheabove12 applications issue tracking systems.
for the applications that have medium size issue databases i.e.
total reports we randomly sampled reports for each.
for redmine and gitlab which have more than reports we randomly sampled reports for each.
for fallingfruit which only has reports we took all of them.
among the resulting sampled reports we manually checked all the reports that contain keywords like data format data inconsistency data constraint format change format conflict etc.
we finally obtained reports that are truly related to data constraints as shown in table .
constraints in one version to understand how many constraints are specified in software where they are located and what they are about we wrote scripts to extract data constraints from the latest version of the applications described in section .
our scripts obtain a web application s abstractsyntaxtree checkwhichrubyvalidationapisandmigrationapis are used and analyze their parameters.
inthispaper ourscriptcoversalltypesofconstraintslistedin table2exceptforcustomsanitychecksandrawsqlconstraints.
botharerarelyusedintheseapplications e.g.
rawsqlconstraintsare only specified in fewer than times across all applications .
note that when we report inconsistency or missing constraints we manually check to make sure the inconsistency missing constraintisnot causedbyourscriptnot coveringthesetwotypesof constraints.
.
how many constraints are there?
as shown in table there are many constraints in these applications.
across all applications of data columns areassociated with constraints and there exists .
to .
constraint specifications for every lines of code.summary.
data constraint specification widely exists in all types of web applications.
their consistency maintenance and handlingaffect the majority of the application data.
.
where are the constraints?
as shown in table db constraints are the most common contributingto of allthe constraints.applicationconstraints contribute10 whilefront endconstraintsarefew.itissurpris ingthatthenumberofdbconstraintsdifferssignificantlycompared to application constraints as both are supposed to be applied to agivenpieceofpersistentdata section2.
.furthermore inconsistenciesbetweenthemcanleadtoapplicationcrashesasinthe example shown in figure .
this led to the next few study items.
whatdb constraints are missing in applications?
table5 examinesover4 000dbconstraintsthataremissinginapplications.
alarmingly aboutonequarterofthesemissingconstraints more than1 000intotal involvestring textdatawheredevelopersdid not specify any length constraints in the application yet length constraintsareimposedbythedb.forexample whenevercreatingatablecolumnoftype string usingrailsmigrationapi bydefault rails framework forces a length constraint of character in the database yetmanyofthesestringfieldshavenolengthconstraints specified through application validation functions.
this mismatch could lead to severe problems if a user tries to submit a long paragraph articleinsuchaseeminglylimitlessfield hisapplicationwillcrashduetoafailed insertquery asshowninfigure1.infact we foundmanyreal worldissuesreportingthisproblem sec.
.
ultimately leading to developers adding the corresponding constraints in the application layer.
about2 ofthemissingconstraints 101intotalacrossthe12 applications are associated with data fields that do not exist in the application.someofthemareupdatedandreadthroughexternal scripts but never through the web application others are deprecatedfieldsthathavealreadybeenremovedfromtheapplication but not dropped yet from the db.
although this does not lead to immediatesoftwaremisbehavior thesecasesreflectchallengesin datamaintenanceandcouldcausefunctionalityproblemsinthefuture.
in addition they cause performance problems as the database needs to maintain deprecated data.
about one third of the missing constraints are automatically satisfied by rails or the db and are hence benign.
this includes presence and numericality constraints associated with foreign key fields foreignkey foreignkeyfieldsareautomaticallygenerated byrailsandsatisfypresenceandnumericalityconstraintsinthe db.meanwhile therearealsoconstraintsthatareguaranteedby the db selfsatisfied like presence constraints guaranteed by non null default values specified in the db uniqueness constraints guaranteed by an auto increment property in the db etc.
the remaining one third of the constraints other are difficulttoanalyzeautomatically.basedonourmanualsamplingand checking most are already satisfied by how the application processesand generatescorresponding datafields.although theydo not cause problems currently developers should nonetheless beinformedaboutthem sothatcodechangescanbetestedagainst these constraintsto prevent regression failures.
table constraints in db but not in application ds lo gi re sp ro fu tr da on ff os all strlength absentdata foreignkey selfsatisfied others table constraints in application but not in db only built in validation constraints are listed ds lo gi re sp ro fu tr da on ff os all presence unique inclusion exclusion regex numeric .
false positive analysis besidesthe others rowintable5 the other4rowsarecountedbyourstatic checkingscript.tocheckthe accuracyofourscript werandomlyexamined102casesfromthese 4rows.amongthesecases wefound7falsepositives 5arenotdb constraintsbutaremistakenlyidentifiedduetosyntaxnothandledbyourscript strlength casesactuallybelongto others asthe length requirement is guaranteed by application semantics.
these cases include strlength cases among which are false positives 3a r en o td bconstraints and belong to others .
whichapplicationconstraintsarenotindatabase?
nearly of the constraints specified through application validation are missing in the db.
table breaks down the ones specified through built invalidationfunctionsbasedontheconstrainttype 412intotal .
these missing constraints allow users to directly changepersistentdatausingsqlqueriesinwaysthataredisallowedby theapplication causingfunctionalityorevensecurityproblems.
furthermore someofthesemissingconstraintsrepresentmissed query optimization opportunities such as improving cardinality estimationin query plan generation using such constraints .
about half of these missing constraints are presence constraints.
thatis afield fisrequiredtobenon nullintheapplication butis notrequiredsointhedb theirdefaultvaluesareironicallyset tobenullinthedb.whenusersoradministratorsdirectlyinsert recordsinto thedbwithoutspecifyingthe valueforafield f the dbwouldaccepttheserecordsandputnullinto f.subsequently when such records are retrieved and used in the application that assumesall fto be non null software failures could occur.
another category of missing constraints that can easily cause problemsareuniquenessconstraints.withoutbeingspecifiedinthedb auniquenessconstraintoften cannotbeguaranteedbytheapplication webuserscouldmakeconcurrentupdaterequests 1itiscommonthatdatabaseadministratorsdirectlychangedatabasedatausingqueries andscripts bypassingtheapplicationserver.table top popular types of different layer db presence length numericality uniqueness .
.
.
.
app.
presence length uniqueness numericality inclusion .
.
.
.
.
html presence length format .
.
.
thatsaveduplicatevaluesintothedb violatingtheuniquenessconstraintand causingsoftware failures and maintenance challenges.
regularexpressionandinclusion exclusionconstraintsarerarely found in the db layer.
while these can be enforced via procedures orenumtypes they are not natively supported by the rails db migrationapisandhavetobeexplicitlyspecifiedviasql which might be a reason why they tend to be missed in the db.
inclu sion exclusion constraints limit the value of a field to a small set of constants and would be very useful in avoiding data corruption saving storage space and improving database performance e.g.
through db selectivity optimization if they are present.
the single numeric constraint in table is a phone number fieldthatisspecifiedtobenumericinapplicationbutstoredasa string in the database.
false positive analysis we randomly sampled and examined cases from each of the main categories in table presence unique in ex clusion regex .
out of the sampled cases are falsepositives 1inthe4categories respectively syntax corner cases caused our script to identify spurious presence constraint and theremaining are related to conditional constraints.
summary.
hundreds and thousands of database constraints do not exist in application and vice versa.
the majority of thesediscrepancies can actually lead to bad user experience missing stringlengthconstraints databasemaintenancechallenges data fieldsthatarenolongerusedintheapplication codemaintenance challenges constraints implicitly guaranteed by the application logic data corruptions software failures or sub optimal database performance missing db constraints .
they can be avoided by implementingconstraintsintheapplicationandassqlconstraints in the database.
however in practice inconsistencies are likely inevitable if we only rely on developers manual effort.
it would be helpful to develop automated techniques that coordinate database and applicationconstraints.
.
whattypes of constraints are there?
standard types.
table shows the most popular constraint types among all front end application built in validation and db constraints.thetop2mostpopulartypesareconsistentlypresence and length.
customvalidationconstrainttypes.
customvalidationfunctions are used much less often than built in ones but are not rare contributing about to slightly over of all application validation functions across the applications avg.
across all apps .
werandomlysampled50customvalidationfunctionsandfound that more than half of them are used to check multiple fields at the sametime 27outof50 likethefunction presence of content table app.
versions with constraint changes version c dslogi re sp ro futr da on ff os version version c187 version c59 alltypes in table except for custom sanity checks are considered.
red apps use a release as a version black apps use every commits as a version.
in the statusmessage model from diaspora which requires that at least one of the fields textorphotosbe non empty.
these custom validations seldom have corresponding constraints in db only out of the we sampled exist in db.
customsanitychecktypes.
wealsosampled20sanitychecks on input parameters from the controller code of applications.
amongthese20checks themajority areindeedcheckinginputs that are related to persistent data stored in the db.
among these are about data constraints including presence and inclusion constraints while the others are related to conditional data update re processing.amongthese5constraints only1isspecified in an application validation function and none exists in the db.
summary.
althoughsimpleconstraintslikepresence length and numericality are the most common more complicated con straints such as those involving multiple fields are also widelyused.
most of the custom constraints are missing from the db while constraints reflected by sanity checks are often missing in boththeapplicationanddb.futureresearchthatcanautomaticallyreasonaboutcustomsanitychecksandcustomvalidationfunctions can greatly help to identify and add missing constraints.
constraints across versions thesoftwaremaintenancetaskforwebapplicationscomeswiththe extra burden of database maintenance including both data format changes likeaddingordeletingatablecolumn anddataconstraint changes like changing the length requirement of a password field.
in this section we study how constraints evolve across versions and the related data maintenance challenges.
how often do constraint related changes occur?
we first checked the first commit of each application and found nodata constraintsinallbut3applications ds lo ff .forallapplications the majorityof the constraints were added in later commits.
asshownintable8 avg.
acrossallapps ofcode versionscontaindataconstraintsthataredifferentfromthosein its previous version indicating that constraint changes are common.
note that for most applications we treat one code release as oneversion for4applicationsthatdonotspecifyrelease version information we treat every code commits as one version.
whattriggeredchanges?
we categorize all the cross version changesaboutdbconstraintsandapplicationvalidationconstraints into three types add column adding constraints to a data column that did not exist in previous version add constraint adding constraints to an existing data column that was not asso ciated with that specific type of constraints like adding a length constraint to a data field that had no length constraint previously v r l 5h 6s 5r x 7u d 2q kdqjh frqvwuldqwv gg frqvwudlqwv gg froxpqv figure breakdown of of adding changing constraints change constraint changing the detailed requirement of a constraintthat already existed in previous version.
what is alarming from the result figure is that the addcolumn type only contributes to around or lower than of changes in out of the applications.
on the other hand of constraint changes across all applications are adding new types of constraints to columns that already existed in earlier versions i.e.
tightening the constraints indicating that constraint addition is often developers after thoughts.
changing existing constraints is much less common but is still not rare contributing to more than of constraint changes in applications.
summary.
itisproblematicthataroundormorethanaquarter ofconstraint relatedcodechangesinmostapplicationsareabout adding constraints to already existing data columns.
this indicates awidelyexistingvulnerabilitythatallowsconstraint violatingdatato be stored into the database before the correct constraints are im posed.toolsareneededtohelpdevelopersaddsuitableconstraints whenever a new data column is created and warn of data that is incompatiblewith the newly added constraints.
constraint related issues we categorize real world issues into types as shown in table .
.
where is the constraint specified?
as discussed application and db constraints for the same data field can be inconsistent with each other.
such inconsistencies contributed to out of the issues.
applicationconstraintslooserthandbconstraints.
13out of issues fall into this category.
in of them the constraintis completely missing in application layer while the rest one issuehappensbecausethelengthconstrainthasasmallervaluein database layer than in application layer.
in these cases a record saving operation would pass the application server s checking but failinthedb causingawebpagecrashwithanunhandledrawdb error thrown to end users which is often difficult to understand and causes poor user experience.
the example discussed in figure is an illustration.
application constraints stricter than db constraints.
out of issues fall into this category.
in of them applicationconstraints are not defined in database layer at all while the rest two are caused by that length constraint has smaller value in applicationlayerthanindatabaselayer.inthesecases theapplication misbehaves as the administrator user directly changes databaserecords through sql queries in a way that violates application constraints.thishappensquiteoften.forexample spree an table data constraint issues in real world apps ds lo gi re sp ro fu tr da on ff osm sum where whatvs.
code vs.user when how sum !
!
!
!
!
figure constraint mismatch in spree on line shopping system has issues caused by administrators modifyingdatabasecontentthroughdirectsqlrequests.discourse even has scripts that bypass model constraints to import other forumapplications data.
figure3showssuchanissue inspree.asshownin b each lineitem isassociatedwitha variant objectanda presence constraint is used to ensure the existence of every associated variant.
this ensures that an expression like item.variant.image in a is never null.
however this constraint does not exist in the database.
in this bug report an adminstrator accidentally deleted a variant record in the db that is associated with a lineitem record and that led to a null pointer error when he tried to display an order through the code in figure 3a.
summary.
asshownbyreal worldissues inconsistenciesbetween application and database constraints cause problems including web page crashes and poor user experience.
considering the hundreds and thousands of constraints that exist in the db but not inapplicationandviceversa seesection4.
thisproblemcouldbe muchmoresevereandwidespreadthanwhatreflectedbytheissue reports.
automatically detecting such constraint inconsistencies will be very helpful which we further explore in section .
.
what is the constraint about?
the most common problem is a mismatch between how data is supposedtobeusedintheapplicationandtheconstraintsimposed on it.
this accounts for out of issues.
.
.
conflict with user needs.
users sometimes would relax an existingconstraint suchasincreasingtheinputlengthofnamefield intrackerfrom30to100 redmine .thesecontribute toabout10 oftheissuesinour study.developersusuallysatisfy the users desires and change constraints accordingly.
summary.
forcertaintypeofconstraints likethelengthconstraint itisdifficulttohaveonesettingthatsatisfiesallusers needs.
it would be helpful if refactoring routines can be designed to turn a fixed setting constraint into configurable.
figure type conflict example in redmine figure case sensitivity conflict example in gitlab .
.
conflict with application needs.
manyconstraintsarecreated to guarantee program invariants that are crucial to applications functionalcorrectness.constraintsthatareinsufficientorevenconflictingwithhowthecorrespondingdataisusedbytheapplication contributeto more than one third of all the issues in our study.
type conflicts .these constraints treat a data field as having a general type but the application uses the data field in a more specialized way that demands tighter constraints.
in one redmine issue ausernoticedthatshecaninputinvaliddateslike withouttriggeringanyerrors.thisproblemhappenedbecauseredmine only useda regular expression d d d to make sure the input follows the yyyy mm dd format without moredetailedchecking.tosolvethisproblem redminelateradded value.to date to check whether the input can really be converted to a date or not in the custom validate function shown in figure .
casesensitivityconflicts.
uniqueness isacommonconstraint associated with a data field to avoid duplication like preventing twousersfromhavingthesameid.acommonproblemisthata field is written to the db in a case sensitive way of uniqueness whileusedorsearchedinacase insensitiveway orviceversa.such inconsistencycan leadto severe software misbehavior.
inagitlabissue auser sprofileemailisallinlowercase but she committedcode with anupper case letterin her email which then cannot be matched to herprofile.
what is annoying was that shewasunabletoaddthedifferentcasingasanalias asgitlabsaid the email was already in use.
this happens because when a useremailisstoredintodb theuniquenesscheckingiscaseinsensitive abc example.com istreatedthesameas abc example.com.
however when the application searches for code commit using emailastheindex thesearchiscasesensitive codecommitted by abc example.com cannot be retrieved by a search using abc example.com.
the patch made the search also case insensitive thus always converting the input email to pure lowercase before the search as shown in figure .
boundary value conflicts.
therearecaseswherecertainvalues of a data field are allowed by the application logic but disallowed by the constraints.
for example in the typical checkout flowof spree users would enter their delivery details then proceed to a payments page to enter discounts and payment details and then finallyarriveataconfirmationpage.however inonespreeissue ausercomplainedthatwhensheenteredadiscountcouponthat reduced the price to zero which was actually a valid use case the application did not allow him to proceed and instead redirected backtothedeliverypage.thesourceofthebugwasaconstraint in the model layer models spree order.rb which incorrectly requiredthevalueofthe totalfieldtobestrictlygreaterthanzero.
summary.
failuresymptomsofthesebugsarequitedifferent from all the other types of bugs where when how .
they canleadtoseveresoftwaremisbehaviororevendisableanentire featureofawebapplication.itwouldbeidealifaprogramanalysis tool can compare how a data field is used in software and identify inconsistency between how it is used and how it is constrained.
this is challenging for generic data types and data usage but is feasiblefor specific types of problems which we explore in sec.
.
.
when is the constraint created?
whenupgradinganapplication sometimesnewlyaddedorchanged constraints might be incompatible with old data.
issues are caused by such inconsistency across versions.
the failure symptomsvarybasedonthedifferentprogramcontextwherethetighter constraintis checked.
read path .when a constraint is newly created or tightened alongadb recordloadingcodepath e.g.
front endconstraintor application sanity check changes an incompatible new constraint can cause failures in loading old data and hence severe functionalityproblems.the diaspora examplein section 1belongs to this category thepassword slengthrequirementtightenedandhenceinvalidated many old passwords.
write path .when a constraint is newly created or tightened alongapaththatintendstosavearecordtothedatabase e.g.
all the application validation constraints and database constraints theincompatibilitybetweenthenewconstraintandolddatacan be triggered under the following two circumstances.
first all the old data in the database will be checked against thenewsetofdbconstraintsduringamigrationprocessduring applicationupgrade.inconsistencybetweenolddataandnewdb constraintscancauseanupgradefailure.forexample onegitlab issue complainsthattheyfailedtoupgradefromversion9.
.5to .
.0dueto notnullviolation duringdatamigration.asshownin figure6 the decription html columnwasaddedtogitlabbefore version9.
.
inthe ... migrationfile andwasfilledwith nullsbydefault.2lateron inthe ... migration shown in the figure a non null constraint was added to the column throughtheapi change column null withparameter false.this causedmanyusers upgradetofailbecausethereweremanyold recordswithadefault nullinthatcolumn.thepatchremovedthe non null constraint to the description html column as shown in figure .
second evenifalltheolddataisvalidatedagainstdbconstraints andtheapplication hassuccessfullyupgraded theold datamight stillconflictwithnewconstraintsspecifiedthroughtheapplication validationapisthatdidnotexistinthepriorversion.thiscanlead toproblemswhentheapplicationallowsuserstoeditanexisting record users may have trouble in saving an edited record back.
in onediscourseissue ausercomplainedthatshemadeasmall edit to an old post s title but was unable to save with an error 2when no default value is specified in add column nullis used as the default value.
figure old data conflicts with new constraints in gitlab message stating that the title was invalid.
it turned out that the title slengthconstrainthasbeenchangedfrom30to20charactersin theapplication svalidationfunction.thatoldpost stitlecontained characters the small edit did not change the title length.
so the old post can still be loaded by the application but cannot be saved back after suchsmall edits.
summary.
giventhefrequentconstraintadditionandchanginginwebapplications itisinevitablethatolddatamaybecome incompatible with new constraints.
it would be helpful if automated tools can provide warnings for developers when constraints becometighterinanewversion particularly ifthemigration file has high probability to fail e.g.
specifying a constraint that conflicts with a column s default value then developers should fix themigrationfile iftheapplicationallowseditingolddata thendevelopersshouldprobablyaddexplicitwarningtousersaboutthe risk of editing old data and finally the case of having tighter constraintsthatlimitthereadingofolddatashouldbeavoided.we explore this in section .
.
how are the checking results delivered?
constraintviolationiscommoninwebapplications aswebusers cannot anticipate all the constraints in advance and will inevitably input constraint violatingdata.
consequently delivering informativeandfriendlyerrormessagesiscrucialtowebapplications user experience.
issues in our study are about this problem.
these issues are mostly related to application validation constraints.railsvalidationapisprovidedefaulterrormessagesthat aremostlyclear.3however developerssometimesforgottodisplay the error message associated with the validation apis cases and sometimesoverride the default message with uninformative genericmessages 12cases whichledtousercomplaints.forexample inadiasporaissue ausercomplainedthatwhenhetried to post a long article the posting failed with an unhelpful error message failedtopost!
developersfoundoutthattheircodein posts controller forgottorendertheerrormessagedefinedin post svalidationfunction.thepatchfixedthisproblemandwould displaythe required length limit as shown in figure .
summary.
developersshouldberemindedtodisplayerrormessagesassociatedwithvalidationapis.futureidesshouldautomatically synthesize default error checking and error message display code.
improving the quality of default and custom error message is crucialto user experience.
we will explore this in section .
3section7discussescaseswhenthedefaultmessageisunclearandhowweenhanceit.
figure unclear error message in diaspora solutions evaluation wenowdiscussourexperienceinbuildingtoolstoautomatically discover the anti patterns discussed earlier.
we focus on applying them to the latest versions of the studied applications as these represent potential bugs that have not been discovered.
.
where issues asdiscussedinsection4.
ourscriptscanautomaticallyfindmore than string length db constraints that are missing in application and more than application built in validation constraints that are missing in the db.
we reported of them covering different types with of them already confirmed by developers from applications lo ds ff .
inaddition weextendedourscriptstoautomaticallyfindconflicting cases where the same type of constraint like length is specifiedforthesamedatafieldinbothdatabaseandapplication but the exact constraint requirement is different.
as shown in table our checker reported conflicting constraints in total.
our manual checking confirmed that of them are true conflicts and are false positives.
these133conflictsinclude84caseswhereapplications length constraints are tighter than the db s cases in the other way case where the columns referenced by uniqueness constraints did not exactly match and cases where the range or type of numeric values allowed in db did not match the corresponding restrictioninthemodel.forexample ourresultsshowedthat inthe tracks application there was a string field description in model todofor which the length in db was limited to characters but was limited to in the model.
we reported this mismatch to developers and received confirmation that it was indeed a bug.
as anotherexample wefound5instancesinopenstreetmapwhere developers meant to require fields to be integers in both the db and application.
however developers had typos in their use of validation apis which caused the application level numericality constraintstobesilentlyignored.wereportedthistodevelopers whothen fixed the bug.
as an example of range mismatch there was a case in spree where the field pricemust be greater than or equal to zero.
however in the db the field type was decimal which allows negative values.
among the false positives were caused by our tool s limited ability in handling non literal expressions and the others were relatedtoourtool sinabilitytodistinguishbetweenarraylength and stringlengthvalidations.
.
what issues webuiltacheckertodetect case sensitivityconflicts discussedin section6.
.
.ourcheckerfirstidentifieseveryfieldthathascasetable mismatch constraints between db model ds lo gi re sp ro fu tr da on ff os length db looser length db tighter uniqueness numericality false positives total table our enhancement to default error messages default enhanced inclusion of invalid have to take values from a b ... exclusion of reserved cannot take values from a b ... confirmation of invalid case does not match with earlier input uniqueness of invalid notuniquein case in sensitive comparison associated o is invalid field f of object o is invalid insensitive constraints specified by the validation api validates uniqueness of field andcase sensitive false then checks all the statements that issue a read query to load such a field to see if the loading is ever done in a case sensitive way.
to identify all thosereadqueries weusedanexistingstaticanalysisframeworkfor rails to identify case sensitive loading we check whether the queryisdirectlyorderedbythefield .order field orfiltered on the field .where field params without case conversion.
our checker found issues in latest versions in lobsters 3inredmine 2intracks.ourmanualcheckingconfirmedthese are all bugs no false positives .
we also got confirmation from developersoflobstersandredmine.redminehasalreadyadded ourpatch to their next major release .
.
.
.
whenissues given two code versions to detect inconsistency between old data andnewconstraints weextendourscriptthatexaminesconstraint changes across versions section to see if new constraints are added or existing constraints are tightened.
we then further check whethertheapplicationallowseditingexistingdbdata whether the default value conflicts with the new changed constraint and whetherthemigrationfileupdatesthecorrespondingcolumninthe database whichisacommonwaytoavoidincompatibilityproblems.
dueto space constraints we omit details of the algorithm.
we applied our checker to the applications.
it did not find problems with the latest upgrade of these applications.
.
how issues improving built in error messages.
rails built in validation apis provide default error messages that are used by developers in most cases only overridden in of the cases across all studied applications.consequently havinginformativedefaultmessagesis crucial.
table user study results task input attempts w modified attempts w default decrease inclusion .
.
associated .
.
task of users prefer modified prefer default no preference exclusion confirmation uniqueness wefoundthat5apis defaultmessagescanbemoreinformative as shown in table .
for example validates confirmation of ensuresthatafieldanditsconfirmationfieldhavethesamecontent.
instead of only saying the input is invalid we add information on whether the matching failure is caused by case sensitivity so theusercandecidewhethertochangejustthecaseortheactual value.asanotherexample validates associated checksifevery fieldofasub object o whichisassociatedwithanotherobject is valid e.g.
a photo is a nested object of profile and has fields source url width height .
if the validation of any field of o fails the default message states only that the entire ois invalid.
our enhancement lets the user know which specific field e.g.
source url or width or height is incorrect and how to revise.
wehaveimplementedalibrary i.e.
arubygem tooverwrite therailsdefaulterrormessagewithouradvancedones.ourgem redefined the existing error message generation functions with customonesthat incorporated more information.
user study.
toevaluateourerror messagechanges werecruited participants using amazon mechanical turk mturk .
the participants are all live in us and are at least years old withhigher than mturk task approval rate.
we asked users to perform two tasks.
first users provided answers to questions such as enteratitle firstname andlastname ortryandenteraunique value for a given category.
if they fail to provide a valid answer we either provide them with the rails default error message or our improved error message.
in each case we track the numberof retries required for the user to reach a valid input and if they cannot after retries we skip to the next question.
each user was given of these tasks.
in the second task we provide a webpagescreenshot of a question and an incorrect answer input to that question.thequestionsarebasedontheapplicationswestudied.
we then show two options for error messages the default message and the improved message.
we ask the user to rate which error messagewouldbemorehelpfulinarrivingatavalidinput.each user was given of these tasks.
asshown intable for thefirsttask ourenhanced errormessages reduced the number of tries users took to reach valid inputs byabout30 forthesecondtask wefind74 ofuserspreferred our enhanced error messages depending on the type of validation.
detecting missed error messages.
developers are required to provide error messages for custom validations through the apiobject.errors.add msg .
we extend our script that identifies custom validation functions to further check if an error message is provided.
we found one case in diaspora where the error message is missing.
this is actually a severe problem since rails uses thecountoferrormessagestodeterminethevalidityofanobject an invalidobjectcanthenbeincorrectlytreatedasvalidandleadto applicationfailures.wereportedthisbugtodiasporadevelopers whohave confirmed that this is indeed a bug.
detectingmissederrorrendering.
sincetherearemanyways torendererrormessagesonawebpage itisdifficulttoautomatically detect this problem.
we randomly chose html pages withformsacross12applications andmanuallycheckediferror messagescaused by invalid inputs were rendered.
we found onecase where the message would never be rendered on a page in openstreetmap that asks users to input a url when the input has animproperformat thewebpagemarksthefieldwithredcolor withoutrenderingtheerrormessageassociatedwiththeconstraint.
discussion .
impactof false positives our scripts for checking constraints inconsistency across layers hassomefalsepositives ofwhichthevastmajoritycomefromtwo types of constraints string length constraints in database presence constraints in applications.
the remaining false positives are due to some validation migration api call parameters being derived from function calls or non constant expressions which we do not currently evaluate.
such false positives have limited impact on the paper s findings and are already considered in our finding presentation rq1 this has little impact.
the overall trends like many data fieldsassociated withconstraints dbcontaining mostconstraints will not be affected by these small number of false positives.
rq2 this has negligible impact.
for instance the number of versionswithconstraintchangesremainsthesameevenifwedo not considerthe above two types of constraints rq3 there is no impact since the real world issue study is conducted manually rq4 thishasnegligibleimpact.allfindingsintable1stillhold astheyeitherarenotrelatedtothosetwotypesofconstraintsorare reportedwithfalsepositivesalreadyprunedorcarefullyconsidered.
for instance although our script reported database string lengthconstraintsmissingintheapplication weintentionallyonlyhighlight stringfields... insteadof1 intable1 exactly because wehave takenthe potentialimpact of falsepositives into account.
.
threatsto validity internal threats to validity as discussed in section .
and we only considered db constraints declared through rails built in migrationapis butnot thosethrough sqlqueries which areextremelyrare fewerthan30acrossall12applications .ouranalysis covers only native db types such as string numeric and datetime types and excludes non native db types such as json spatial or ipformat whichtogetheraccountforlessthan1 ofallcolumns.
front endconstraintsspecifiedthroughjavascriptfileswerenot considered.finally ourstaticcheckershavefalsepositivesasdiscussed in section .
and .
externalthreatstovalidity the12applicationsinourstudy clearlymaynotrepresentallreal worldapplications the114issues studiedalsomaynotrepresentallconstraint relatedissuesinthese applications the participants of our user study from mturk maynotrepresentallreal worldusers.overall wehavetriedour best to conduct an unbiased study.
asdiscussedinsection2.
otherormframeworks likedjango and hibernate also let developers specify application and database constraintslikethatinrails.wesampled22constraint relatedissue reports from the top popular django applications on github and observed similar distributions as shown below.
where what what when how sum vs.code vs.user django cms zulip redash related work verifyingdata constraints.
priorworkhasinvestigatedverifyingdatabase relatedconstraints.adsl verifiesdata model related invariants e.g.
whether each todo object is associated withaprojectobject usingfirstorderlogic whiletheinvariants are provided by users using their invariant language.
singh and wang check whether a set of db constraints still hold when db schema evolves while caruccio conducts a survey of related workin thisdomain.
pan proposesa methodto leverage symbolic execution to synthesize a database to verify different typesofconstraintslikequeryconstructionconstraints dbschema constraints query result manipulationconstraints etc.
verifyingwebapplicationsusingconstraints.
anotherline of work focuses on using constraints provided by the db or applicationforapplicationverificationandsynthesis likeverifying the equivalence of two sql queries db applications synthesizinganewdbprogramwithanewschemegiventhe originalprogramwith anold scheme andhandling chainsofinteractive actions .
othertypesofdataconstraints.
muchpreviousresearchhas looked at how to specify security privacy related data constraints and how to verify or enforce those constraints across different components of database backed applications .
these constraints are currently not supported by web application frameworks and are orthogonal to this study.
leveragingconstraintstoimproveperformance.
usingdatabaseconstraintstoimprovequeryperformanceisalreadywidely adopted in database systems.
for example wang leverages foreignkeyconstraintstoacceleratethesamplingofjoinqueries.
other work leverages db data constraints to find an equivalent but more efficient query plan for instance chestnut adds constraints as extra assumptions to help synthesize better query plans andquro leveragesdataaccessconstraintstooptimizetransactionalapplications.althoughmuchworklookedathowtoleverage data constraints little work has been done on studying how the constraintsaredefinedandusedindb backedapplications orwhat are the common issues related to these data constraints.
our work revealsthatdevelopersarespendingalotofeffortmanagingconstraints and suffer many problems that are hardly paid attentionto in research work.
these findings open new research opportunities like automating constraint consistency check or making the constraintchangeseasier fordevelopers.
empiricalstudy of web applications.
past empirical studies lookedatdifferentaspectsofwebapplications likeorm related performance problems and client side performance problems but not data constraint problems.
conclusion specifying and maintaining consistent and suitable constraints for dataiscrucialtoensuretheapplicationcorrectnessandusability.
in this paper we thoroughly studied how data constraints have beenspecified maintained andledtoreal worldissuesin12representative open source db backed applications.
our study shows that tooling support is needed to help developers manage data constraints and our checkeris the first step towards providing such support.
acknowledgement this work is supported in part by the nsf through grants ccf1837120 cns iis oac andthecomputationresourcefromchameleon cloud darpaawardfa8750 doeawardde sc0016260 theintel nsfcapacenter giftsfromadobe google andceresresearch center for unstoppable computing.
we thank madan musuvathi and suman nath from microsoft research for inspiring us to startthis research direction.