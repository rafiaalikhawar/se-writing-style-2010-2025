scenario based test reduction and prioritization for multi module autonomous driving systems yao deng macquarie university sydney nsw australia yao.deng hdr.mq.edu.auxi zheng macquarie university sydney nsw australia james.zheng mq.edu.aumengshi zhang meta menlo park ca usa mengshizhang fb.com guannan lou macquarie university sydney nsw australia guannan.lou mq.edu.autianyi zhang purdue university west lafayette in usa tianyi purdue.edu abstract when developing autonomous driving systems ads developers often need to replay previously collected driving recordings to check the correctness of newly introduced changes to the system.
however simply replaying the entire recording is not necessary given the high redundancy of driving scenes in a recording e.g.
keeping the same lane for minutes on a highway .
in this paper we propose a novel test reduction and prioritization approach for multi module ads.
first our approach automatically encodes frames in a driving recording to feature vectors based on a driving scene schema.
then the given recording is sliced into segments based on the similarity of consecutive vectors.
lengthy segments are truncated to reduce the length of a recording and redundant segments with the same vector are removed.
the remaining segments are prioritized based on both the coverage and the rarity of driving scenes.
we implemented this approach on an industrylevel multi module ads called apollo and evaluated it on three road maps in various regression settings.
the results show that our approach significantly reduced the original recordings by over while keeping comparable test effectiveness identifying almost all injected faults.
furthermore our test prioritization method achieves about to and to improvements over three baselines in terms of both the average percentage of faults detected apfd and top k. ccs concepts software and its engineering software testing and debugging .
corresponding authors xi zheng mengshi zhang.
permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed for profit or commercial advantage and that copies bear this notice and the full citation on the first page.
copyrights for components of this work owned by others than acm must be honored.
abstracting with credit is permitted.
to copy otherwise or republish to post on servers or to redistribute to lists requires prior specific permission and or a fee.
request permissions from permissions acm.org.
esec fse november singapore singapore association for computing machinery.
acm isbn .
.
.
.
autonomous driving testing reduction test prioritization regression testing acm reference format yao deng xi zheng mengshi zhang guannan lou and tianyi zhang.
.
scenario based test reduction and prioritization for multi module autonomous driving systems.
in proceedings of the 30th acm joint european software engineering conference and symposium on the foundations of software engineering esec fse november singapore singapore.
acm new york ny usa pages.
introduction autonomous driving has been through quick development in recent years and found several new business models such as driverless taxis driverless buses and last mile robotic delivery .
nowadays modern autonomous driving systems adss such as apollo make use of machine learning models and logic based controllers in tandem to process rich sensor data e.g.
images gps point clouds and plan driving trajectories.
to ensure the robustness and reliability of adss autonomous driving companies often conduct extensive on road testing as well as simulation based testing to cover various driving scenarios.
for example google waymo has a fleet of virtual vehicles traveling eight million miles per day in simulation .
waymo has also conducted on road test for more than million miles in .
despite the significant investment on testing software bugs still slip through and cause vehicle recalls and traffic accidents .
therefore new ads testing methods are in urgent need to ensure the safety of autonomous vehicles .
during ads development and testing a common practice is to reuse driving recordings collected from on road testing or simulation to test new updates to adss such as replacing a traffic light detection model with a new model.
this is similar to regression testing in traditional software systems .
however it is costly to simply replay the entire recordings to test a change since some recordings include many redundant driving scenes that are not necessary to repetitively test.
in particular a recent study finds that ads practitioners wish to have tool support to accelerate the testing process and reduce the cost of testing .
test reduction and prioritization techniques have been widely investigated in traditional software engineering .
however these techniques are not directly applicable to adss.
first arxiv .01546v1 sep 2022esec fse november singapore singapore yao deng xi zheng mengshi zhang guannan lou and tianyi zhang test cases in adss are driving recordings with time series sensor data rather than discrete program inputs as in traditional software.
therefore it requires extra care to reduce driving recordings.
second test coverage metrics used in existing techniques are not applicable to multi module adss since adss contain both logic based code and machine learning models.
while many testing techniques have been proposed for adss most of them focus on test generation rather than test reduction or prioritization.
furthermore many of them can only handle a single driving model rather than a multimodule system.
to the best of our knowledge only two recent techniques have been proposed to address test reduction or prioritization for adss .
however they can only handle limited driving scenarios e.g.
road shapes only.
furthermore both of them require access to test configuration files e.g.
the road map to extract road features rather than directly from driving recordings.
this limits their utility and generalizability in practice.
to fill the research gap we propose a novel framework called strap scenario based testreduction andprioritization that automatically extracts and analyzes rich driving scenarios from driving recordings.
in particular we formally define a driving scene schema with rich features e.g.
pedestrians traffic lights stop signs and interactions.
we further leverage the publish subscribe communication mechanism to dynamically extract semantic information related to corresponding features from the communication channels between different modules in an ads.
this publish subscribe communication mechanism is adopted by most multi module autonomous driving systems and robot operating system in general .
given a driving recording strap first plays it to extract the corresponding semantic information in each frame of the recording from the communication channels of the ads under test.
the extracted semantic information is encoded to vectors for the ease of comparison and clustering.
then strap slices the driving recording into continuous segments with the same frame vector.
lengthy segments are truncated to reduce the length and redundant segments with the same vector are removed.
furthermore to expose potential errors e.g.
collisions early strap sorts the remaining segments based on the coverage of different driving scene features and the rarity of these features.
this heuristic is inspired by coverage based test prioritization approaches in traditional software engineering as well as observations that corner cases or rare driving scenarios are more likely to detect faults .
we implemented strap for an industry level multi module ads called apollo and evaluated it in terms of test reduction capability rq1 test effectiveness of reduced recordings rq2 and bug detection speed after prioritization rq3 .
we created a benchmark of driving recordings on three different types of road maps in a simulator called svl .
we further developed a mutation testing tool to systematically inject errors to different modules of apollo and evaluated the effectiveness of reduced and prioritized ads tests.
the experiment results show that strap reduces over of given driving recordings and thus significantly reduces the testing time in ads regressing testing the reduced driving recordings have comparable test effectiveness they detected of injected faults that were detected by the original driving recordings the diversity based test prioritization method in strap achieves and improvement compared with a coverage basedmethod related to code change chronological prioritization and random prioritization.
there are three main contributions of this work we propose a general scenario based test reduction and prioritization framework for multi module autonomous driving systems that adopt the publish subscribe communication mechanism.
we make a regression testing benchmark publicly available.
the benchmark includes driving recordings on three different kinds of road maps as well as a mutation testing tool that systematically injects errors in different ads modules in apollo and evaluates test effectiveness.
.
with this benchmark future researchers can systematically evaluate their ads testing methods in various regression settings.
we conduct experiments on an industry level multi module ads and demonstrate the test reduction capability and test effectiveness of our proposed framework.
the rest of the paper is organized as follows section introduces the background of current ads testing practice and multi module adss.
section formulates testing reduction and prioritization problems.
section describes proposed testing reduction and prioritization methods.
section introduces experiment settings.
section demonstrates experiment results.
section introduces related works.
section describes threats to validity of the work.
section concludes the paper.
background .
ads testing practices in the industry two primary methods of testing adss in the industry are on road testing and simulation based testing .
the goal is to cover various driving scenarios especially corner cases and check consistency and generalizability of adss in these scenarios.
such testing processes will produce massive amounts of log data including sensor data e.g.
video recordings point clouds and outputs of ads modules e.g.
obstacle detection results speed control commands .
these log data will be further processed for regression testing in a simulation environment.
when an ads is updated it will be tested by replaying previously logged sensor data and comparing the system outputs of the new ads with previous outputs e.g.
collision or deviation .
however replaying an entire recording takes a long time and computation power.
alternative some ads developers will manually label and clip recordings to obtain specific driving scenarios e.g.
overtaking merging for testing.
yet since this requires a lot of manual effort it cannot be done in a large scale.
.
multi module adss modern adss such as baidu apollo and autoware are composed of multiple modules to process rich sensor data and make trajectory plans.
a typical multi module ads includes perception localization prediction planning and control modules as shown in figure .
similar to robot operating systems ros these modules in an ads communicate and coordinate with each other 1our benchmark has been open sourced in an anonymous github repository at https github.com itseg mq strapscenario based test reduction and prioritization for multi module autonomous driving systems esec fse november singapore singapore predictionplanningtraffic light detection localization imuperception prediction planning localization subscribepublish module channel messageinputs camera imu lidar traffic light detectionobstacle detectionoutputs brake steeringlidar imageobject detection io control sub module figure the architecture and data flow of a multi module ads through the publish subscribe communication mechanism .
each module maintains its channel s to publish module outputs.
specifically when a module generates its output at a timestamp it packages the output as a message and publishes the message into its channel.
each module also subscribes to one or more channels of other modules to obtain needed data.
figure gives an overview of an multi module ads based on the architecture of apollo.
as the autonomous vehicle is driving sensors such as cameras and lidars continuously capture environment information package collected data to messages and send messages into the corresponding channels.
in the perception module a traffic light detection model subscribes to the message from the image channel and detects traffic lights in the images.
the model predictions are then published to the traffic light detection channel.
similarly the obstacle detection model subscribes to both the image channel and point cloud channel to detect and classify obstacles on the road such as vehicles and traffic cones.
the detection results are published to the obstacle detection channel.
the prediction module subscribes data from localization traffic light detection and obstacle detection channels to predict the trajectories of detected obstacles.
the prediction result is published to the prediction channel which is subscribed by the planning module.
finally the planning module generates the trajectory of the ego vehicle while the control module subscribes data from the planning channel and outputs the control commands such as steering angles and brakes.
.
regression testing on driving recordings a driving recording includes all sensor data and module outputs that are packaged as messages in different channels during the running of an ads as shown in figure .
mathematically given a start time point taand an end time point tb adriving recording is denoted as ra b. suppose it contains nchannels ci a b i n .
each channel ci a bcontains all messages mi jcreated in the time period denoted as ci a b mi j a j b wheretjis the timestamp when a message is created.
given a timestamp ta a framefais a slice of a recording that contains all channel messages created at timestamp ta denoted as fa mia i n .
therefore a driving recording can be seen as a list of frames denoted as ra b fi a i b .
arecording segment sa b is a clip of the driving recording containing frames created in where a a b b. however since different modules are invoked in different time orders and frequency the number of messages and the creation time of messages in different channels are not quitetable terminology definitions terminology symbol meaning recording ra ba log file that stores sensor data and module outputs in different channels from the timestamp tatotb.
channel ca message queue to store the outputs of a module message mathe output of a module created at the timestamp ta frame fa a slice of the recording at timestamp ta segment sa b sia list of frames created from tatotb theithsegment in a segment list frame feature ian attribute to represent specific driving scenario related semantic information in a frame frame feature value va ithe value of the frame feature ifor the framefa frame vector vaa vector va va ... van to represent the framefa segment vector svi a vector to represent the segment si aligned.
this message alignment problem is discussed and solved in section .
.
.
table summaries terminologies and notations in this paper.
messages in a channel can be used to perform regression testing on the module that subscribes to the channel.
for example suppose a driving recording ra bwithmframes the image channel cimg a binra bwithmmessages of collected images and the traffic light detection channel clight a bwithmmessages of traffic light detection results.
when the traffic light detection system is updated by replaying the driving recording the new version of traffic light detection system can take images from the recording frames and output detection results.
then by comparing the new detection results with the original detection results in the traffic light detection channel clight a b we can check whether inconsistent model predictions or discrepancies are introduced.
for example if a traffic light detected as in red by the old traffic light detection system but it is detected as in green by the new one it implies a potential fault.
other ads modules can be tested in the same way.
problem formulation in this section we formulate the test reduction problem and the test prioritization problem in ads testing.esec fse november singapore singapore yao deng xi zheng mengshi zhang guannan lou and tianyi zhang feature traffic lightframe message message message message is there any pedestrian crossing the road?
is the traf fic light in red?
frame v ectorization feature pedestriant1t2t3 tn t4 segments reduced segmentsordered segmentst1 ta tb tn recording frames with feature vectors t1t2t3 tn t4 aligned driving recordingdriving recording scenario features semantic encoding function set frame vector weights of semantic encodings figure the architecture of proposed regression testing reduction and prioritization method test reduction given a driving recording ra b a test reduction method should output a list of recording segments s s1 s2 ... sn denoted as s ra b wherenis the number of recording segments.
the total time cost of replaying recording segments in sshould be less than the time cost of replaying ra b. meanwhile sshould be able to detect the same number of faults asra b. more specifically test reduction shall comply with two constraints n i t si t ra b and n i si sut ra b sut wherenis the number of recording segments t is a function to output replaying time cost of a given segment or recording sut is the testing module and represents the number of detected faults in the testing module using the input segment or recording.
test prioritization givennrecording segments s s1 s2 ...sn that detectmfaults in the new version of an ads module test prioritization aims to sort the recording segments and obtain a list p wherepiis the execution order of the recording segmentsi.
for example if p1 the recording segment s1will be the fifth to replay.
the sorted recording segments should detect all mfaults as early as possible.
approach figure shows the overview of our approach strap .
first given a driving recording strap performs message alignment across different channels and converts messages in each time frame into vectors based on a driving scene schema section .
.
second strap slices the given recording into segments based on the similarity of consecutive vectors.
long segments of the same continuous vectors will be truncated and redundant segments will be removed section .
.
third the remaining segments are prioritized based on the coverage of driving scene features and the rarity of these features section .
.
.
recording alignment and vectorization .
.
recording message alignment.
as different modules in ads run asynchronously and in different frequencies the timestamp and the number of messages in different channels are not aligned.
for example in apollo the localization module logs a message every t0 t1 t t3 t0 t1 t3 t t0 t1 t3 t 2step step reference channel target channel reset timestamp copy the message and reset timestampfigure an example of message alignment .
second while the prediction module logs a message every .
second.
since the messages in different channels are not aligned raw driving recordings cannot be used as is for comparison and clustering.
therefore we need to align them first.
we propose a novel message alignment algorithm to address this issue.
specifically we choose the channel containing most messages as the reference channel to align messages of other channels i.e.
target channels .
given the reference channel cref at each time we retrieve two consecutive messages mi refandmi reffrom it and obtain their creation timestamps tiandti .
then for the target channel if the message is generated between ti ti we reset the timestamp of the message to ti as shown in step 1of figure .
then we iterate over the reference channel and the target channel to check whether at tithere is a corresponding message in the target channel.
if no message is found we copy the prior message atti 1in the target channel and reset its timestamp to tias shown in step 2of figure .
in this way we align all channels to ensure that the aligned driving recording can be sliced to a list of frames.
.
.
schema based recording vectorization.
given an aligned driving recording strap converts each frame into a vector v where each dimension represents specific semantic information in a driving scene.
we formally define a schema for a variety of semantic information in a driving scene as shown in figure .
a drivingscenario based test reduction and prioritization for multi module autonomous driving systems esec fse november singapore singapore scene object scene object dynamicobject staticobject dynamicobject actor action actor vehicle pedestrian cyclist unknown vehicle truck car bus van cyclist bicyclist motorcyclist tricyclist action stop cruise change lane overtake cross ... staticobject traffic light stop sign crosswalk intersection traffic cone ... unknown trafficlight color shape orientation color red green yellow black shape square round orientation vertical horizontal figure part of the driving scene schema scene is represented as a list of static or dynamic objects.
a dynamic object is defined of an actor e.g.
vehicles pedestrians etc.
and an action of the actor e.g.
stop cruise etc.
.
a static object can be traffic light stop sign crosswalk interaction traffic cone etc.
an object can have subcategories and also properties.
our driving scene schema is designed as a general schema for all driving systems.
yet one can customize it based on the concrete channel messages logged by an ads.
for example in apollo each detected object is also logged with its coordinates and heading direction if movable .
such information can also be encoded as new dimensions in the vector.
the encoding function in our current implementation only considers the existence of different types of objects and their properties in a driving scene.
given channel messages in a time frame it parses the channel messages into a list of objects based on the schema and flattens the list of extracted objects and their properties into a vector of integers using label encoding.
specifically is a reserved code for none i.e.
undetected objects or properties .
this encoding function also enforces a specific ordering of objects based on their types for the ease of vector comparison in the next step.
for example consider a driving scene that contains vertically aligned round traffic lights with the red light on.
the corresponding feature dimensions in the final vector is where is the unique code for traffic light is the code for red is the code for the round shape and is the code for vertical alignment.
if no traffic light is detected the four dimensions are all set to .
after vectorization a driving recording is represented as a list of vectors where each vector corresponds to each time frame in the recording.
in regression testing if one or more updated ads modules are given as input strap will further simplify the vectors by only retaining features obtained from the channels that the updated modules subscribe or publish to.
for example suppose only the traffic light detection model is updated.
since the traffic light detection model takes raw images as input and publishes prediction results to the traffic light detection channel features obtained from the traffic light channel e.g.
traffic light color shape and orientation will be retained in the final vectors.
to avoid over simplifying the vectors we specify several features that should always be preserved in the final vectors including stop sign intersection and crosswalk.
frame vectors frame vectors after smoothing get majority vectorsliding windowfigure smoothing frame vectors with a sliding window .
test reduction .
.
segmentation.
strap slices the given recording into segments based on the similarity of consecutive vectors.
if vectors in a consecutive time range are the same then they will be sliced into one single segment.
for example in a hour driving recording if the ego vehicle drives on a highway with no new objects detected for minutes the vectors for each time frame in this minutes will be the same and therefore this minutes will be sliced into a single segment.
in practice we noticed that due to noises in raw sensor data and the uncertainty of dl models channel messages often contain glitches exceptional predictions that only exist for a very short period of time e.g.
.
second .
such glitches often do not lead to abnormal ads behavior since they only exist very shortly and ads make decisions based on a sequence of time frames not just one.
however it has a significant impact on our segmentation algorithm.
specifically it will lead to many tiny segments since a glitch will produce an exceptional vector that is different from its preceding and following vectors.
to handle this issue strap smooths glitches in the list of vectors using a sliding window as shown in lines 16of algorithm .
figure illustrates this process with a sliding window of vectors n .
when smoothing is finished we split frames into segments.
each segment contains a list of frames represented by the same vector which is denoted as the segment vector.
.
.
segment reduction.
strap adopts two strategies to reduce the length and the number of segments.
first for each driving segment as each frame in the segment is semantically equivalent i.e.
represented by the same vector strap only keeps the first n frames in the segment.
strap keeps n frames rather than one frame because certain ads modules such as the planning module rely on a sequence of frames to make a decision not just one frame.
in our current implementation for apollo we experimented with different number of frames and finally set n to roughly seconds .
second as each segment reflects a unique driving scenario we only keep one unique segment and remove those segments with identical segment vectors.
by combining these test reduction strategies we obtain a list of reduced segments as test cases to evaluate ads modules.
.
test prioritization coverage based prioritization methods have been widely investigated in traditional software systems.
these methods sort test cases based on the total or additional coverage of program statements or branches .
inspired by these methods we propose the notion of semantic coverage of different driving scenes by countingesec fse november singapore singapore yao deng xi zheng mengshi zhang guannan lou and tianyi zhang algorithm recording segmentation and reduction input v a list of frame feature vectors with size n nis the number of frames l the clip length of a segment w the sliding window size output s a list of reduced driving segments sv a list of segment vectors 1stemp svtemp initiate the start and end indices of a segment 3ss se create an empty list to save smoothed feature vectors 5vtemp smoothing using sliding window 7fori 1tondo obtain the window of frame feature vectors ifi w 2then window v else ifi n w 2then window v else window v i w i w end end set vtemp as the majority vector in the window vtemp .append majority window 20end recording segmentation 22fori 2tondo ifv v ori nthen se i else stemp .append vtemp svtemp .append vtemp reset segment indices ss se i end 31end clip each segment to length l 33foreachsinstemp do 34s clip s l 35end drop segments with the same segment vector 37s sv 38fori 1tostemp .length do if!sv.contain svtemp then sv.append svtemp s.append stemp end 43end 44return s sv algorithm coverage and rarity based prioritization input v a list of frame feature vectors with size n q n is the number of frames qis the number of elements in a frame feature vector sv a list of segment vectors with size m q mis the number of segments after test reduction output p a list of segments execution order with size m 1weights initialize a list weights to save the weights of feature elements and a list rarity to save the rarity degree of segments 3fori 1toqdo weights rarity 6end calculate weights of feature elements 8fori 1toqdo weights n n j 1nonzero v 10end weight normalization 12fori 1toqdo weights weights q j 1weights 14end calculate rarity of each segment 16fori 1tomdo rarity q j weights sv 18end get indices of rarity after descending sorting 20p descendingargsort rarity 21return p the number of non zero feature dimensions in a vector.
note that is a preserved code that indicates the corresponding object or property does not exist.
intuitively a driving scene with a traffic light and a pedestrian in a crosswalk has a higher coverage than a driving scene with only a pedestrian.
however only considering the coverage of driving scenes may not be sufficient.
since adss are equipped with dl models for perception and prediction common driving scenes are less likely to expose faults compared with rare driving scenes or corner cases since common driving scenes are prevalent in training data.
this phenomenon has been observed by several existing works in ads testing .
therefore we should also take into account the rarity of driving scenes when prioritizing recording segments.
we define a new prioritization method that accounts for both the coverage and rarity of different driving scenes.
first given a driving recording represented by a list of frame vectors r v1 v2 ... vn we calculate the rarity score of each dimension in the vector by the formula at line 9of algorithm where nis the number of frames nonzero v 1whenv .
the formula presents that the semantic information occurring less times in a driving recording has a higher rarity score.
the process is shown in lines 10ofscenario based test reduction and prioritization for multi module autonomous driving systems esec fse november singapore singapore algorithm .
then we normalize weights to lines 14of algorithm .
then for each recording segment represented by its segment vector it sums the rarity score of non zero feature elements in the corresponding segment vector lines 18of algorithm .
finally we sort the list of recording segments in descending order based on the rareness of recording segments.
the sorted indices of the recording segments list is obtained as the execution orders of recording segments.
experiments .
research questions to evaluate the effectiveness of strap we conducted experiments to answer the following research questions rq1 to what extent can the proposed test reduction method reduce a given driving recording?
rq2 compared with an original recording how effective is the reduced recording in detecting faults?
rq3 compared with alternative prioritization methods how effective is the proposed test prioritization method in detecting faults?
we implemented and evaluated strap on an industry level ads apollo .
.
we chose apollo .
since it is a mature version with stable modules.
we constructed our experiment as follows.
first we collected driving recordings from a simulator svl .
then we injected mutants into the source code of apollo to simulate the module changes with faults.
third we tested the traffic light detection module the obstacle detection module the planning module and the prediction module to build baselines.
finally we applied strap to split driving recordings generated reduced and prioritized test segments and evaluated strap s effectiveness.
.
benchmark creation we created simulation environments using svl .
svl is a high fidelity simulator to render driving environments which provides bridges to connect with adss such as apollo and autoware.
the rendered driving environment is fed to an ads via the bridge.
then the ads outputs control commands and sends them back to svl to render the next driving scene based on the control commands.
we collected driving recordings from three maps including cubetown gomentum and shalun in svl to create three testing suites.
specifically cubetown is a simple map containing a circular road.
gomentum as shown in figure and shalun are reconstructed maps based on real world autonomous vehicle testing e.g.
on road testing environments.
these three maps cover the various driving environments in urban and rural areas.
the weather condition and non player characters e.g.
vehicles and pedestrians behaviors are randomly generated by the simulator in default settings.
for each test suite the destination waypoints are randomly generated by the simulator.
to collect sufficient data we manually inspected the waypoints and chose those waypoints with the most complex trajectories.
when apollo .
was connected with svl we ran a recorder in apollo to record all channel messages generated during the simulation.
in the end collected test suites contain driving recordings of different lengths cubetown .
seconds gomentum .
seconds and shalun .
seconds .
for each driving recording figure the gomentum map in svl figure a bug detected by replaying the recording segment.
a new traffic light detection model classifies a red light as a green light which is inconsistent with the previous run we applied proposed reduction method to obtain reduced driving segments.
each driving segment is separately replayed to test the ads.
to ensure that apollo is in a correct state before replaying each segment strap replayed the one second before the segment in the original recording to initialize modules and restore system states.
we modified the source code of four modules to simulate the module change with faults.
for those modules under test we implemented a mutation testing tool to randomly inject mutants into the source code.
the mutants include commonly used mutation operators such as replacing arithmetic operators changing constant values changing variable values and changing condition operators where the generated mutants can simulate real faults234.
an example5is shown in figure .
for each module 9c files were randomly selected for mutation and totally 36regression testing benchmarks are created for each test suite.
.
evaluation metrics for rq1 we used the reduction ratio of testing time to reflect the effectiveness of the test reduction method which is defined as the length of the reduced driving recording over the length of the original driving recording.
2changing constant values 3changing condition statement 4replacing arithmetic operators november singapore singapore yao deng xi zheng mengshi zhang guannan lou and tianyi zhang a a real fault of correcting buffer size b a mutant of changing constant value figure an example of real and artificial fault.
for rq2 we used the fault coverage to reflect the quality of the test reduction method which is defined as the ratio of the number of the detected faults in reduced driving recording over the number of the detected faults in the original driving recording.
in our work we defined a fault as the inconsistency of a module output before and after code changes e.g.
injecting a mutant .
since each output is a driving segment we applied the frame vectorization approach to such output and retrieved the frame vector list representing the output.
for the outputs before and after change we compared each frame pair.
intuitively if we find any mismatched frame pairs we claim an inconsistent case is detected.
to reduce the systematic noises introduced by apollo .
we recognized the inconsistency only when more than of frames were mismatched.
this treatment was proposed since our benchmark study showed that the inconsistency rate could be up to when we replicated experiments on the benchmarks.
we calculated the number of faults from the reduced and the original driving segments.
for those detected faults we manually checked the visualized driving segments before and after a ads module change and removed semantically identical faults e.g.
red traffic light is recognized as green as shown in figure to improve experiment quality.
for rq3 we used metrics top k andaverage percentage of faults detected apfd to evaluate the effectiveness of test prioritization.
given ndriving segments containing mbugs top k measures the amount of segments required for finding the first fault.
apfd measures the capability of fault detection per percentage of test cases execution.
the calculation of apfd is shown in formula apfd m i 1tfi mn 2n wherenis the number of test recording segments mis the number of faults tfiis the index of the first segment that detects fault i. for example if tf2 it means the second fault is detected at the first time when replaying the third prioritized recording segment.
a higher apfd value means the test suite can find all faults faster.
figure test reduction percentage when updates are made on different ads modules .
experiment settings for test reduction experiments we clipped each segment by keeping its first 45frames as explained in section .
.
to evaluate the test prioritization method we created three baselines.
the first baseline sorts the segments in chronological order i.e.
ch .
the second baseline randomly sorts the segments i.e.
rd .
specifically we randomly sorted the reduced segments by 100times and evaluated the average performances using top k and apfd.
for the third baseline we first identified the code change in which function in the source code.
then we counted the number of calls on the changed function for each recording segment based on the apollo running log data.
finally we sorted recording segments in descending order by the number of calls on the changed function i.e.
cc .
in addition we marked the proposed semantic coverage method as scand the rarity and semantic coverage based method as rsc in section .
all experiments were conducted on a ubuntu pc with intel i7 .2ghz 32gb of memory and a nvidia gtx 1080ti gpu.
results .
rq1 test reduction capability figure shows the test reduction percentage for three test suits on four testing modules.
the result shows that for the planning module in gomentum the reduction ratio of testing time achieves .
similarly the reduction ratio of testing time for the planning module in cubetown achieves .
a similar pattern can be observed for the traffic light detection and obstacle detection modules in gomentum and cubetown where the test reduction ratios are in general close or above .
we noticed the test reduction ratios are relatively lower for modules in shalun to37 .
we speculated the main reason is that shalun contains more complex driving scenarios and finergranularity frame feature encoding functions can be explored besides just using existence of semantic information.
we also noticed that test reduction ratios for all test suites on the prediction module are relatively lower than on other modules.
we manually inspected the output from the prediction module in apollo and noticed that the trajectory prediction for vehicles in the ads tends to fluctuate a lot.
for instance for a vehicle in front of the ego vehicle thescenario based test reduction and prioritization for multi module autonomous driving systems esec fse november singapore singapore prediction module in one frame detects the vehicle is driving in a straight line ahead but in the next frame the prediction result is the vehicle is turning right.
such dynamic prediction changes across frames will result in different semantic feature encoding for continuous frames for the prediction module thus impacting the reduction ratios.
nevertheless the reduction ratio is still promising with the minimum reduction ratio of in the prediction module.
.
rq2 rq3 test effectiveness of test reduction and prioritization in table we present the effectiveness of the reduced recording in detecting faults on the left hand side.
for the traffic light detection system besides shalun in other two test suites the fault coverage is .
for shalun the fault coverage is .
which is also promising.
for the 6missing faults we manually inspected the traffic light module output and noticed for vertical traffic light in shalun in other two suites the traffic lights are mostly horizontal the module output sometimes gave wrong bounding box for traffic lights in a very short duration but the glitch is within our threshold for smoothing .
this might contribute to the 6missing faults as such short duration glitch is embedded in those driving frames discarded.
the smoothing threshold is empirically retrieved as the best value for apollo through our pilot study.
overall the fault coverage achieves on average .
which proves the reduction technique is effective across four modules in different test suites.
we also present on the right hand side of table the comparison results of our proposed scandrsc against the baselines using top k and apfd metrics.
for each module in a specific test suite the presented results are the averaged values on nine benchmarks.
we observed that rsc outperforms other baselines for all test suites for prediction module both in top k and apfd.
similarly for planning module rsc also outperforms others both in top k and apfd except in the shalun test suite for top k .44vs1.0both in ccand sc .
we speculated that even a specific driving segment containing the rarest semantic information are ranked as the top in rsc this driving segment does not contain faults.
however empirically the correlation between semantic rareness and faults is very positive as shown in the table as a general trend.
for obstacle module rsc has lower value in apfd than the baselines .47vs0.51in ch in gomentum.
similarly in traffic light detection system rsc outperforms all other baselines in top k but for apfd has lower value both in gomentum .76vs0.82insc and shalun .
vs0.56insc .
we believe because the semantic information in both traffic light and obstacle detection modules are largely static.
thus capturing rarest information in such modules has fluctuating performance either scoring the best in top k capturing the first error fastest or apfd capturing all the errors fastest .
in summary on average that our method rsc achieves the best performance across all modules in different test suite with .58for top k and .61for apfd.
related work .
test reduction and prioritization test reduction and prioritization are two approaches to reduce the cost of regression testing.
test reduction also called test minimization seeks to reduce the size of a test suite by removingredundant test cases.
test prioritization aims to maximize some desired properties such as the rate of fault detection by sorting test cases.
the comprehensive overview of regression testing techniques can be checked in the survey .
the typical test reduction techniques contain heuristic methods and genetic algorithm based approaches .
different heuristics and search algorithms were applied to select a minimal set of test cases that achieve the same test requirements e.g.
branch coverage and code coverage as the original test suite.
for test prioritization many coverage based prioritization methods were proposed to maximize structural coverage or code coverage early.
the idea behind these methods is that the early maximization of structure coverage will improve the chance to detect faults early .
these existing test reduction and prioritization methods target on traditional programs.
however they cannot be directly applied on adss with time series inputs.
inspired by traditional coverage metrics in this paper we propose rarity and semantic coverage based test prioritization method.
there are a few works related to test reduction and prioritization on adss.
in lu et al.
conducted experiments to evaluate the performances of five search algorithms for prioritizing driving scenarios and defined objective functions e.g.
the probability of collision for optimization.
however it does not account for the coverage of different modules in an ads which limits its prioritization capability.
in our work the test reduction process is automated based on frame vectorization calculated by the data in driving recordings.
furthermore we evaluate our method on four ads modules.
in birchler et al.
proposed a prioritization method to sort driving scenarios of lane keeping systems.
in their work testing suites are maps with different shapes turns and other properties.
they extracted features of maps and sorted them using genetic algorithms.
in our work testing suites are different driving recordings and the testing modules are perception prediction and planning modules.
we split driving recordings to recording segments for further test reduction and prioritization.
.
autonomous driving testing the research of testing on adss mainly focused on the generation of rare or error prone driving scenarios.
in tian et al.
proposed to apply different affine transformations to generate new testing images to evaluate the steering angle prediction of cnn based driving models.
in zhang et al.
proposed to use generative adversarial networks gans to generate high quality testing images such as driving scenes on rainy and snowy days.
in deng et al.
proposed to generate driving scenarios based on traffic rules to test driving models for speed prediction.
in zhou et al.
proposed to use adversarial attack methods to generate adversarial billboards in driving scenarios.
in gambi et al.
generated crash driving scenarios based on police reports.
several search based methods were proposed to find and generate driving scenarios leading to crash or deviation of ego vehicles .
while most work targeted on e2e driving models or advanced driver assistance systems adas some recent works started investigating on industry level adss.
in garcia et al.
systematically analyzed bugs in apollo and autoware based on their github repository commits.
in li et al.
proposedesec fse november singapore singapore yao deng xi zheng mengshi zhang guannan lou and tianyi zhang table effectiveness of the test reduction and prioritization methods in detecting faults top k apfdtest suite ads module total faults covered faultsch rd cc sc rsc ch rd cc sc rsc cubetown traffic light13 .
.
.
.
.
.
.
.
.
.
gomentum .
.
.
.
.
.
.
.
.
.
shalun .
.
.
.
.
.
.
.
.
.
.
total .
.
.
.
.
.
.
.
.
.
.
cubetown .
.
.
.
.
.
.
.
.
.
gomentum .
.
.
.
.
.
.
.
.
.
shalun .
.
.
.
.
.
.
.
.
.
totalobstacle .
.
.
.
.
.
.
.
.
.
cubetown planning42 .
.
.
.
.
.
.
.
.
.
gomentum .
.
.
.
.
.
.
.
.
.
shalun .
.
.
.
.
.
.
.
.
.
total .
.
.
.
.
.
.
.
.
.
cubetown .
.
.
.
.
.
.
.
.
.
gomentum .
.
.
.
.
.
.
.
.
.
shalun .
.
.
.
.
.
.
.
.
.
totalprediction .
.
.
.
.
.
.
.
.
.
.
total total .
.
.
.
.
.
.
.
.
.
.
av fuzzer to search safety violations of apollo in the urban driving environment using genetic algorithms .
in ebadi et al.
searched testing scenarios for obstacle detection of apollo.
our work focus on test reduction and prioritization based on driving recordings.
.
driving scenario identification driving scenario identification is the task of identifying driving scenarios and converting driving scenarios to vectors.
after this a few downstream works such as scenario clustering and anomaly detection can be implemented.
currently only a few works in the software engineering community researched in this direction.
in andrea et al.
proposed a method to detect potential misbehaviors of an ads.
the main idea is to train a reconstructor to reconstruct the current driving scenario single image or a sequence of images .
if the reconstruction error exceeds a threshold the driving scenario is most likely an anomalous scenario and the autonomous vehicle may misbehave in the scenario.
in this work we identify driving scenarios based on the module outputs in the driving recording and convert each frame to a feature vector.
we then use feature vectors for testing reduction and prioritization.
beyond se community some existing work targeted driving scenario vectorization.
in harder et al.
proposed scenario2vector to characterize a driving image from three aspects actors actions andscene .
then based on the text description of the driving image key elements belonging to the above three categories are extracted and converted to vectors or matrices.
in our work we also describe key elements of driving scenarios from these three aspects.
however we use them to define a driving scene schema to describe corresponding semantic information occurred in a driving scene.
on the other hand we do not use them together to characterize a driving scenario.
for different testing modules we extract data from its publish channel messages to encode semantic information described in the schema.in zhao et al.
proposed using convolutional neural network cnn and gated recurrent unit gru network to learn feature representations for driving videos.
in balasubramanian et al.
proposed to use self supervised learning to learn better feature representations for driving recordings.
in our work we treat a driving recording as a combination of multiple driving scenarios.
we create and calculate frame level features for driving recording segmentation.
threats to validity we discuss threats to validity from three aspects external validity construct validity and internal validity proposed in .
external validity the external validity is generalizability of the proposed method.
in this work we conduct experiments on an industry level ads apollo to evaluate the effectiveness of the proposed test reduction and prioritization methods.
these methods are also available for other multi module adss that apply publishsubscribe communication mechanism among modules and save module outputs in driving recordings e.g.
autoware that adopts ros .
internal validity the internal validity is that in ads modules there are many non deterministic algorithms which makes module outputs have slight differences when the module runs on the same input multiple times .
this problem may introduce uncertain faults when we compare the outputs of the old and new versions of suts.
to solve the problem we use a sliding window based smoothing algorithm to remove noises.
furthermore we set the threshold to evaluate inconsistent outputs as to ensure the detected inconsistent output is caused by the new version of sut.
in this work we inject mutants into apollo source code to create regression benchmarks.
the effectiveness of mutation testing are suitable for software testing experimentation .
in this way we explore common faults in different ads modules and ensure every time we only change one file in an ads module.
we doscenario based test reduction and prioritization for multi module autonomous driving systems esec fse november singapore singapore not use commits in apollo github commit history as regression benchmarks because most commits are relevant to the update of multiple modules.
construct validity the construct validity is that we conducted experiments on apollo .
not apollo .
that is used in other papers .
the reason is that now for apollo .
the camera based perception module does not work and lidar based perception is unstable in svl6.
in this work we evaluated our methods on three maps.
we tested two other maps i.e.
borregas avenue and san francisco but we found that apollo is not able to control the ego vehicle stably.
this issue has been reported by apollo users78.
therefore we excluded these two maps from the experiment.
we will keep tracking these issues and try to include more maps for experiments in the future work.
for mutant rejection we did not directly mutate dl models in apollo because the models are encapsulated in binary files.
alternatively we mutated c files that are related to dl model configuration and model input output to simulate bugs in dl models.
for example by mutating the output of the obstacle detection model we can simulate incorrect model predictions.
conclusion this paper proposes strap to reduce the cost of regression testing in industry scale multi module adss.
since such adss are largely built upon publish subscribe mechanism we define a driving scene schema and for different modules under test we extract frame data from its publish channels and encode semantic information described in the schema as frame feature vectors.
based on such feature vectorization we propose a test reduction algorithm to split original driving recordings to recording segments each of which reflects a unique driving scenario.
we also propose semantic coverage based and rarity based test prioritization to order the reduced recording segments as test inputs for ads modules.
in our work testing suites are different driving recordings and the test modules are perception prediction and planning modules in adss.
in our evaluation using an industry level multi module ads and three road maps in diverse regression testing settings we prove strap is able to significantly reduce the length of original driving recordings to77 has promising fault coverage of .
and achieves .58for top k and .61for apfd beating the state of theart baselines.
this work is a pioneering work to utilize frame level features for driving recording segmentation.
with manually defined driving scene feature schema we have achieved promising results in both test reduction and prioritization.
as future directions for se community based on this open sourced work automated feature extraction from driving recording can be explored along with more intelligent smoothing algorithms.