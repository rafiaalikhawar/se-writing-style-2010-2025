characterizing transaction reverting statements in ethereum smart contracts lu liua b lili weib wuqi zhangb ming wenc yepang liua shing chi cheungb adepartment of computer science and engineering southern university of science and technology shenzhen china bdepartment of computer science and engineering hong kong university of science and technology hong kong china cschool of cyber science and engineering huazhong university of science and technology wuhan china lliubf liliwei wzhangcb scc cse.ust.hk mwenaa hust.edu.cn liuyp1 sustech.edu.cn abstract smart contracts are programs stored on blockchains to execute transactions.
when input constraints or security properties are violated at runtime the transaction being executedby a smart contract needs to be reverted to avoid undesirableconsequences.
on ethereum the most popular blockchain thatsupports smart contracts developers can choose among threetransaction reverting statements i.e.
require if...revert andif...throw to handle anomalous transactions.
while these transaction reverting statements are vital for preventingsmart contracts from exhibiting abnormal behaviors or suffer ing malicious attacks there is limited understanding of howthey are used in practice.
in this work we perform the firstempirical study to characterize transaction reverting statementsin ethereum smart contracts.
we measured the prevalence ofthese statements in verified smart contracts from populardapps and built a taxonomy of their purposes via manually an alyzing transaction reverting statements.
we also comparedtemplate contracts and their corresponding custom contracts tounderstand how developers customize the use of transaction reverting statements.
finally we analyzed the security impact oftransaction reverting statements by removing them from smartcontracts and comparing the mutated contracts against theoriginal ones.
our study led to important findings.
for example we found that transaction reverting statements are commonlyused to perform seven types of authority verifications or validitychecks and missing such statements may compromise the secu rity of smart contracts.
we also found that current smart contractsecurity analyzers cannot effectively handle transaction revertingstatements when detecting security vulnerabilities.
our findingscan shed light on further research in the broad area of smartcontract quality assurance and provide practical guidance tosmart contract developers on the appropriate use of transaction reverting statements.
index t erms ethereum smart contract transaction reverting statement empirical study security vulnerability i. i ntroduction smart contracts are programs stored on blockchains to execute transactions.
in recent years smart contracts have been widely used for various purposes such as to offer financialservices .
ethereum is the largest decentralized platformfor smart contracts with the second biggest blockchain marketcapitalization .
there are over one million transactionsexecuted on ethereum daily .
as smart contracts are often used to manage valuable user assets their security is of paramount importance.
anoma lous transactions caused by various runtime errors should yepang liu and shing chi cheung are the corresponding authors.if msg.sender !
owner revert require msg.sender owner if msg.sender !
owner throw fig.
.
examples of transaction reverting statements be detected and reverted promptly to prevent undesirableconsequences such as financial losses.
in solidity the mostpopular programming language for ethereum smart contracts there are three statements that can help detect runtime errorsand revert transactions namely require if...revert andif...throw.
figure shows the example uses of these transaction reverting statements to revert transactions submitted by unauthorized senders.
while all three statementscan revert transactions when anomalous conditions occur thefirst two would refund the unused gas to transaction senders.
transaction reverting statements are frequently used in smart contracts.
our analysis reveals that over of smart contracts use transaction reverting statements in certain ways.surprisingly this figure is even higher than that of general purpose if statements.
these statements are also frequently discussed in the solidity developers community.
we searchedon stack overflow the most popular q a website forprogrammers using the keywords require revert and if throw under the tag solidity .
as of august thereare already questions related to the three transaction reverting statements many of which have been viewed thou sands of times.
transaction reverting statements can effectively help prevent smart contracts from exhibiting abnormal behaviors orsuffering malicious attacks.
for example in the swc reg istry which indexes common smart contract weaknesses there is a kind of weakness called unchecked call re turn v alue swc .
this weakness occurs whenthe return value of a message call is not properly checkedin a smart contract.
to ease understanding we give anillustrative example in figure .
in the code snippet thecallnotchecked function does not check the returnvalue of callee.call line .
when the execution of callee.call fails the callnotchecked function would not do anything.
this may cause serious and irreversibleconsequences e.g.
the contract announces to the caller witherror execution information that the call has been executed 36th ieee acm international conference on automated software engineering ase 36th ieee acm international conference on automated software engineering ase .
ieee .
ase51524.
.
.
ieee 1function callnotchecked address callee public callee.
call 5function callchecked address callee public require callee.
call fig.
.
an example of the unchecked call return v alue weakness successfully but actually the call fails.
to fix the weakness developers are suggested to add a require statement to check the execution status of callee.call such as in line of callchecked so that the anomalous transactions can be reverted and the unused gas can be returnedto the transaction sender upon unsuccessful execution ofcallee.call .
as we can see from the above example appropriate uses of transaction reverting statements can help improve the re liability and security of smart contracts.
however there islittle research on transaction reverting statements.
without acomprehensive understanding of how these statements are usedin practice one cannot design tools to effectively identifythe inappropriate uses of such statements or formulate goodpractices to help smart contract developers.
we conductedthe first empirical study to characterize transaction revertingstatements in ethereum smart contracts to bridge the gap.specifically we investigated the following four research ques tions rq1 prevalence are transaction reverting statements commonly used in ethereum smart contracts?
rq2 purpose what are the major purposes of using transaction reverting statements in smart contracts?
rq3 developer customization are there differences between template contracts and custom contracts in termsof using transaction reverting statements?
rq4 security impact are there any security consequences if transaction reverting statements are missing insmart contracts?
for the study we constructed a dataset of template contracts and dapp contracts which were collected from popular template code repositories and real world dapps with millions of transactions.
to answer rq1 wemeasured the code density of transaction reverting statementsand compared it with that of general purpose if statements in smart contracts.
to answer rq2 we built a taxonomyof the purposes of transaction reverting statements via aninductive coding process .
to answer rq3 we lever aged a code clone detector to identify contracts developerscustomized from popular used contract templates and studiedhow developers customize transaction reverting statements ata fine granularity of clauses of conditions based on templatecontracts.
to answer rq4 we analyzed the security impactof transaction reverting statements by removing them fromsmart contracts and comparing the mutated contracts againstthe original ones.
our major findings include over of our analyzed smart contracts use transactionreverting statements.
comparatively only .
of themuse general purpose if statements.
this shows that transaction reverting statements are pervasively used in real world smart contracts and may play important roles inassuring the correct execution of transactions.
transaction reverting statements are commonly used toperform seven types of security critical checks such asverifying user authorities.
developers are most likely to strengthen transaction reverting statements by adding clauses variables ornew transaction reverting statements.
the customizedtransaction reverting statements are commonly used forrange checks and logic checks.
the lack of transaction reverting statements may introducesecurity issues to smart contracts.
existing smart contract se curity analyzers show weak support in handling transaction reverting statements when detecting security vulnerabilities.
to summarize the main contribution of this work is the character study of transaction reverting statements in ethereum smart contracts.
to the best of our knowledge thisstudy is the first of its kind.
the findings can facilitate furtherresearch in smart contract quality assurance and provide prac tical guidance to smart contract developers on the appropriateuse of transaction reverting statements.
our data are releasedon github for public usage .
the organization of the remaining sections is as follows.
in section ii we introduce some related background knowledge.section iii presents how we constructed four datasets ofsmart contracts for empirical analysis.
then in section iv wepresent the design of the empirical study to answer the fourresearch questions and introduce our data analysis methodolo gies and empirical findings.
we discuss threats to the validityof our studies in section v. after that we discuss relatedworks in section vi and conclude our work in section vii.
ii.
b ackground this section presents the background and explains the terminologies used in the paper.
a. smart contracts dapps smart contracts are autonomous programs running on blockchains like ethereum .
the execution of smart contracts does not rely on a trusted third party and is fullydecentralized.
dapps are decentralized applications that canoffer end users various functionalities.
the core logic ofdapps is backed by smart contracts to meet the requirementsof applications.
solidity is the most popular high levellanguage to program ethereum smart contracts.
in this paper we focus on the smart contracts written in solidity.
b. error handling statements solidity uses state reverting exceptions to handle errors.
it provides four statements to deal with errors namely require if...revert assert and if...throw.i f 631these statements identify the occurrence of erroneous conditions they will throw an exception and revert the blockchainand contract state to the state before the execution of thetransaction.
the four error handling statements can be furtherdivided into the following two categories transaction reverting statements refer to the require if...revert and if...throw statements that are used to check for erroneous conditions.
before ver sion .
.
solidity provides the if...throw statement for reverting transactions.
as the language evolves there are two more alternatives namely require and if...revert to replace if...throw since solidity .
.
.
the if...throw statement is officially deprecated in solidity .
.
.
these statements can all triggerstate reversion when erroneous conditions occur.
the onlydifference between if...throw and the two replacements is that if...throw will use up all remaining gas when errors occur while the two replacements will refund theremaining gas to the transaction sender.
the assertion statement assert should only be used for debugging purpose which are not supposed to exist inproduction code.
if a specified assertion is violated it meansthat the contract has a bug which needs to be fixed.
in our study we focus on transaction reverting statements.
since if...throw statement is already deprecated we mainly investigate the use of require andif...revert statements in real world smart contracts.
in the following of this paper transaction reverting statements refer to require andif...revert statements if not otherwise specified.
c. template contracts custom contracts writing a smart contract is non trivial for developers especially when there is a high demand for security .
tofacilitate contract development and prevent vulnerabilities template contracts are provided by industrial institutions and organizations for different use cases.
these template contractsare usually well maintained and provide many high qualityor fully functional components for reuse.
in practice manydevelopers copy or reuse components in template contracts intheir own contracts which we call custom contracts t os a v e efforts and ensure security.
developers customizations mayadd delete or modify existing transaction reverting statementsfor various purposes.
d. solidity components smart contracts written in solidity are put in .sol files each of which may contain one or more components of three kinds contracts libraries and interfaces.
template contract codebases often provide a set of such solidity componentsthat developers can reuse.
iii.
d a taset construction to investigate our research questions we constructed four datasets of smart contracts for empirical analysis.
this sectionexplains how these datasets were constructed.table i informa tion of thedapp contract da taset category contracts total loc avg loc transactions exchanges .
finance .
gambling .
game .
high risk .
marketplaces .
social .
utilities .
others .
total .
a. crawling dapp contracts as of april over million smart contracts have been deployed on ethereum .
despite the large volume many ethereum smart contracts are deprecated or rarely used withfew transactions .
in our empirical study we aim to analyzerepresentative smart contracts that are often used in real life.for this purpose we chose to collect smart contracts frompopular dapps.
such collected smart contracts are of higherquality more frequently used and better maintained.
specifically we collected smart contracts from all dapps indexed by dapp.com a popular dapp collectionwebsite in february by referring to the contract ad dresses listed in the description of dapps.
we found that mostdapps have less than contracts but the dapp uniswapis an exception.
uniswap is a decentralized exchangethat allows users to exchange one kind of token for anotherkind.
it has smart contracts because there is a con tract factory which will create a contract for every directlyexchangeable token pair on uniswap and most such createdcontracts share the same code.
to reduce the impact of dataimbalance we randomly selected contracts for uniswap i.e.
downsampling .
for the other dapps we collected all theaddresses of their used smart contracts listed on dapp.com.then we leveraged the apis provided by etherscan anethereum block explorer to collect contract source codes.
intotal we collected smart contracts and of them areverified ones with source code available which will be usedin the subsequent studies.
table i provides the demographicinformation of the verified contracts.
as we can see they are from different categories contain hundreds of linesof code on average and have a large number of transactions.
b. collecting template contracts template contracts play an important role in the ethereum ecosystem.
when reusing them developers may customize the transaction reverting statements.
to study such customizations we built a dataset of custom contracts and the correspondingtemplate contracts.
for template contracts we collected themfrom four data sources which contain smart contracts that arewidely used on ethereum.
for custom contracts we explainhow to identify them in the next subsection.
table ii showsthe popularity of the data sources of template contracts andwe introduce each of them in the following.
632table ii thepopularity of templa te contract data sources data source github stars repository forks openzeppelin 10k .5k aragonos consensys .1k eips .2k .4k openzeppelin is a library for secure smart contract development which provides reusable contract templates suchas implementations of token standards to help build customcontracts.
we collected contracts from openzeppelin.
aragonos is a smart contract framework for buildingdecentralized organizations dapps and protocols.
we col lected contracts from aragonos.
consensys provides solidity smart contract code forsimple standards compliant tokens on ethereum.
we col lected contracts from consensys.
besides the above data sources we also collected finaleips e thereum i mprovement p roposals with reusable template contracts from the erc website .
in total we collected template contracts.
c. identifying custom contracts it isn t easy to associate template contracts with custom contracts because developers rarely explicitly specify the templates they reuse to write smart contracts.
to identifycustom contracts we leveraged a code clone detection tool smartembed to calculate the code similarity between the270 template contracts and our collected dapp contracts.if the code similarity between a dapp contract and a templatecontract is higher than or equal to we consider thatthe dapp contract is a custom contract based on the templatecontract.
via this process we identified a set of customcontracts based on template contracts.
we give more detailsof the custom contract dataset in section iv c. d. creating mutated contracts to investigate the security impact of transaction reverting statements in smart contracts we constructed a dataset of mutated contracts by removing all transaction reverting state ments in the contracts.
the mutated contracts were lateranalyzed by existing smart contract vulnerability detectiontools to assess their security.
a detailed description of themutated contracts is given in section iv d. iv .
e mpirical study with the four datasets we conducted a large scale empirical study aiming to understand the use of transaction revertingstatements in smart contracts identify good bad practices and provide suggestions to help developers appropriately usetransaction reverting statements and inspire future research.in this section we present our data analysis methodology andempirical findings for each of the four research questions listedin section i.table iii code density of conditional sta tements conditional statement typetotal lines of statementscode density transaction reverting statement .
if...throw statement .
general purpose if statement .
a. rq1 prevalence study methodology to answer rq1 we measured the prevalence of transaction reverting statements in smart contracts.
specifically we first identified all the transaction reverting statements in the dapp contracts and then com puted the code density of these statements.
following existingpractices we computed code density for transaction reverting statements as loc lot where loc is the lines ofcode of a contract and lot is the lines of transaction revertingstatements.
similarly we also computed the code density forgeneral purpose ifstatements and if...throw statements for comparison.
note that we separately analyzed general purpose if if..throw and if...revert statements.
when an if statement is used with throw orrevert w e will not consider it as a general purpose ifstatement since it is used to revert transactions.
in addition we counted the num ber of transaction reverting statements within a if...throw orif...revert code block as one.
finding in our analyzed smart contracts transactionreverting statements are more frequently used than general purpose ifstatements.
among all the contracts .
contracts contain transaction reverting statements while only .
contracts contain general purpose if statements.
table iii gives the detailed results where the column total lines of statements lists the total number of the concerned statements in the whole dataset and the code density column shows the average code density per contract for each type of statement.as shown in the table transaction reverting statements aremore frequently used than general purpose if statements in terms of both metrics.
on average there is one transaction reverting statement per .
lines of code while general purpose if statements are used once per .
lines.
finding .
of our analyzed smart contracts are still using the deprecated if...throw statements which may cause unnecessary financial loss to users.
as explained in section ii b if..throw statements can also help revert transactions but using them would incuradditional costs of gas and induce unnecessary financial loss tothe contract users.
as a result require andif...revert statements were introduced in solidity .
.
as replace ments and if..throw was officially deprecated since solidity .
.
in .
however we found that .
of our analyzed smart contracts are still using if...throw statements.
besides in smart contracts .
there existsa mixed use of if...throw andrequire statements.
we 633further collected the solidity versions used in these contracts.
our results showed that contracts .
still usesolidity versions before .
.
.
such contracts can only use thedeprecated if...throw statements to revert transactions.
the users who submit transactions to these contracts maysuffer from unnecessary costs of gas.
answer to rq1 transaction reverting statements are more frequently used in smart contracts than general purpose if statements.
there are still a non negligible proportion of contracts using deprecated if..throw statements which may incur unnecessary gas consumptionwhen transactions revert.
implication transaction reverting statements may play an essential role in assuring the correct execution of transactions.
researchers working on smart contract qualityassurance and security analysis should pay more attentionto such statements as inappropriately using them may leadto abnormal contract behaviors or financial losses.
b. rq2 purpose study methodology to understand the purposes of using transaction reverting statements we manually analyzed ourcollected smart contracts with the following two steps step statement selection.
since there are transaction reverting statements in the dapp contracts it is infeasible to analyze all of them manually.
for our study we randomly selected of these statements representingthe whole set with a confidence level of and a confidence interval of .
for the template contracts we analyzedall transaction reverting statements in them.
step constructing the purpose taxonomy.
to understand and categorize the purposes we first sampled of the557 transaction reverting statements for a pilotconstruction of the taxonomy.
similar to many existing em pirical studies we followed an open coding procedure toinductively create the categories of our taxonomy in a bottom up manner.
two authors read all the sampled transaction reverting statements and the corresponding contracts to un derstand their purposes.
the two authors also consideredthe string arguments of the transaction reverting statementsprovided by the contract owners and the comments around thetransaction reverting statements when comprehending the con tract code.
they categorized the statements independentlyand marked those unclear or insufficient categories.
they thendiscussed and adjusted their category tags during meetingswith the help of a third author to resolve conflicts.
in thisway we successfully constructed the pilot taxonomy.
based on the coding schema in the pilot taxonomy the two authors continued to label the remaining transaction reverting statements for two more iterations.
in these two itera tions the two authors went back and forth between categoriesand transaction reverting statements to refine the taxonomy.the conflicts of labeling were again discussed during meetingsand resolved by the third author.
in this way we adjusted thepilot taxonomy and obtained the final results.
we used thecohen s kappa score to measure the agreement betweenthe two authors.
the overall score is .
indicating that thetwo authors had a high agreement on the taxonomy.
as shown in table iv the final taxonomy is organized into two categories each of which is further divided into sub categories.
there is no overlap between these sub categories i.e.
a clause in a transaction reverting statement can only beclassified into one of them.
the table also provides illustrativeexamples collected from our datasets to ease understanding.
finding transaction reverting statements are commonly used to perform seven types of authority verifications orvalidity checks.
authority verification.
of the clauses in the transaction reverting statements in the dapp contracts are forauthority v erification.
the figure for the template contractsis of .
authority v erification aims to check whether agiven contract address or token id is authorized by the contractowner for the sake of security address authority check is to check whether a given address mostly the address of the transaction sender isauthorized by the contract owner.
we observed two types ofaddress checks.
one is to check whether the given addressequals to a specified address.
the other is to check whetherthe given address is within a list of authorized addresses.
theproportions of transaction reverting statements that performaddress authority checks in dapp contracts and template con tracts are .
and .
respectively.
t oken v erification.
tokens are value counters stored in a contract which are mappings of addresses to accountbalances.
token verification checks whether a given tokenid is authorized i.e.
within the mappings of addresses.
theproportions of transaction reverting statements that performtoken verification in dapp contracts and template contracts are2.
and .
respectively.
validity check.
of the clauses in the transaction reverting statements in the dapp contracts are forvalidity checks.
the figure for the template contracts is 144of .
generally validity checks are performed to check ifcertain runtime values are valid i.e.
satisfying pre definedconditions.
we observed five sub categories of validity checks logic check refers to the use of logical operators to check the validity of certain runtime values.
such checksare commonly seen in the conditions of transaction revertingstatements such as checking the return value of a low levelfunction call checking the value of a boolean flag and so on.
.
dapp contracts and .
template contracts containtransaction reverting statements for logic checks.
range check is to check whether a runtime value e.g.
an input is within a specific range.
.
dapp contractsand .
template contracts contain transaction revertingstatements for range checks.
overflow underflow check is to check whether an input value crosses the limit of the prescribed size for a datatype.
.
template contracts contain transaction reverting 634table iv thepurposes of using transaction reverting sta tements in the paragraphs .
categoryfirst level sub categorysecond levelsub categorydescription illustrative example authorityv erificationaddressauthoritycheckequal toa specificaddresscheck whether a contract addressis equal to a bytes addressspecified by the contract owner.require msg.sender address nonfungiblecontract withina specificaddress listcheck whether a contract addressis in a address list provided bythe contract owner.require isauthorized msg.sender msg.sig tokenv erification some developers use a token idto identify a contract address.the verification of the token idis actually the verification ofa contract address.require exists tokenid uri query for nonexistent token exists maps a token id to a contract address using a mapping to verify the contract address.
v aliditychecklogiccheck check runtime valuesusing logical operators.require !
mintingfinished rangecheck check whether the value ofa variable is within a value range.require underlyingbalance not have any liquidity deposit overflow underflowcheck check whether the value of thevariable is out of range of thedeclared data type.require z x y x arithmeticcheck check runtime values againstarithmetic constraints.require b!
c a b addressv aliditycheck check whether a contract addressis a valid one.require owner !
address statements for overflow underflow checks while the ratio is only .
for dapp contracts.
we further investigated thecorresponding template contracts and found that many of themadopt the safemath library which provides safe number operations to protect contracts from overflow underflow vul nerabilities.
this also shows that template contracts emphasizemore on security comparing than ordinary dapp contracts.
arithmetic check is to check whether the value of a variable violates common constraints in arithmetic operations such as divided by mod etc.
these checks are notfrequently performed comparing to the above categories.
only0.
dapp contracts and .
template contracts containtransaction reverting statements for arithmetic checks.
address v alidity check is to check whether a contract address is valid.
note that this is different from the addressauthority check discussed above which is to check whetheran address is an authorized one a valid address may not beauthorized .
for example a common address validity check isto check whether a contract address is equal to address in an ether transfer function.
when the address is zero anew contract will be created instead of transferring ether.
toavoid such cases address validity checks should be performed.
.
dapp contracts and .
template contracts containtransaction reverting statements for address validity checks.
during our manual analysis three clauses could not be categorized into the above sub categories.
since they are notcommon we do not further discuss them in the paper.
from the above analysis we can see that dapp contracts and template contracts show differences in usingtransaction reverting statements.
.
template contracts contain transaction reverting statements for overflow under flow checks while the percentage in dapp contracts is only3.
.
besides dapp contracts show higher percentages inusing transaction reverting statements for logic checks rangechecks and address validity checks.
one possible reasonis that developers will consider more specific factors whenapplying smart contracts to a real ethereum environment which could be complicated since a smart contract may need tointeract with other contracts and user accounts.
comparatively developers should consider general factors when developingtemplate contracts and cannot anticipate the specific conditionsthat may arise in real environments.
answer to rq2 transaction reverting statements are commonly used to perform authority verifications andvalidity checks many of which involve security criticalconstraints.
template contracts and dapp contracts havedifferent purposes for using transaction reverting state ments.
implication since transaction reverting statements often check the runtime status of smart contracts against security critical constraints it is crucial to ensure theproper use of such statements.
future research canstudy the vulnerabilities induced by various misuses oftransaction reverting statements and propose detection orrepairing techniques to combat such vulnerabilities.
c. rq3 developer customization study methodology as discussed earlier many developers customize template contracts to develop their own smartcontracts.
in rq3 we aim to understand how developers cus tomize transaction reverting statements in template contracts.
635table v sta tistics of thepurposes of transaction reverting sta tements in dapp contracts and templa te contracts category first level category dapp contracts ratio template contracts ratio authority v erificationaddress authority check .
.
token v erification .
.
v alidity checklogic check .
.
range check .
.
overflow underflow check .
.
arithmetic check .
.
address v alidity check .
.
other .
.
total .
.
table vi contract pre processing result contracts interfaces libraries template contracts dapp contracts step mapping template custom contracts to answer rq3 the first step is to build a dataset containing template contracts and their corresponding custom contracts.however real world smart contracts rarely explicitly specifywhether they are customized from a certain template or not.to address this problem we leveraged code clone detectiontechniques to compute the similarities between each of ourcollected template contracts and the dapp contracts.
we con sidered a dapp contract customized from a template contractif the two contracts have a high similarity.
a smart contract can contain multiple components including contracts libraries and interfaces.
in practice differentcomponents are usually put in one file in dapp contracts while in template contracts a file usually contains a singlecomponent.
to normalize the two kinds of contracts we firstbroke down the dapp contracts into components and then com pared the contracts at the component level.
table vi presentsthe result after this pre processing step where contracts interfaces and libraries represent the number of individualcontracts libraries and interfaces respectively.
we then adopted a code clone detector smartembed to compare the dapp contracts with the template contracts.smartembed computes similarities between two contractsbased on word embeddings and it has been shown to be effec tive in code clone detection for smart contracts.
following theoriginal experiment setting of smartembed a dapp contractis considered a custom contract of a template contract if thesimilarity between these two contracts is higher than .
wechose this threshold because it achieves the highest recall inthe evaluation of smartembed.
as interfaces do not contain any statements we excluded them from our dataset.
in total we obtained contractsand libraries from dapp contracts that are similar to tem plate contracts.
these contracts and libraries form the customcontracts dataset for our subsequent analysis.
step detecting customization patterns we lever aged the custom contracts to investigate how developers cus tomized transaction reverting statements.
inspired by an exist ing study that characterizes changes to if statements we derived a taxonomy of possible customization patternsfor transaction reverting statements as shown in table vii.since transaction reverting statements are also conditionalstatements the change patterns of if conditional statements can also be applied to transaction reverting statements.
how ever we found that patterns identified in the existing work marked with in table vii are not sufficient to cover allcustomizations on transaction reverting statements.
to identifymore patterns we manually analyzed of the customized transaction reverting statements.
specifically we compared thetransaction reverting statements in the custom contracts withthose in the corresponding template contracts and identifiedcommon customizations by checking the conditions of thetransaction reverting statements.
via the sampling and manualanalysis we identified five more patterns.
to investigate the prevalence of the customization patterns and identify commonly used ones we implemented a staticanalyzer based on a solidity parser to automaticallyidentify the occurrences of each customization pattern.
foreach pair of a template contract and a corresponding customcontract we matched their functions by the function namesand input parameters.
functions with the same name andinput parameters are seen as matched function pairs.
for eachmatched function pair the analyzer parses the source codeinto ast trees extracts all transaction reverting statements and recognizes the customization patterns by comparingthe syntactic differences of the transaction reverting statementsin the two functions.
more details about the analyzer can befound on our project website .
finding transaction reverting statements in template contracts are commonly customized.
developers are mostlikely to strengthen transaction reverting statements by addingclauses variables or new transaction reverting statements.
table vii shows the frequency of each customization pattern.
in the custom contracts and custom libraries our analyzer identified occurrences of customization pat terns.
this indicates that developers commonly customizetransaction reverting statements in template contracts.
.
of the customizations are statement level changes involving 636table vii customiza tion pa tterns of transaction reverting sta tements category customization patterns description count percentage addadd clauses add new clauses to a condition.
.
add v ariables use new variables in the condition.
.
add statements add new transaction reverting statements.
.
sub total .
deletedelete clauses remove some clauses from a condition.
.
delete v ariables remove some variables used in the condition.
.
delete statements delete some transaction reverting statements.
.
sub total .
changemodify statement typeschange transaction reverting statements to other kinds of statements e.g.
change a require statement to an if statement while the condition remains the same.
.
modify clausesmake modifications to the clauses in the conditionof a transaction reverting statements.
.
sub total .
other cosmetic changesmodifications that do not change the semanticsof the transaction reverting statements.
.
total .
note patterns marked with are defined by an existing work .
the remaining patterns are newly identified by us.
the addition or removal of a transaction reverting statement.
.
lie in clause granularity including adding deleting and modifying a clause within the condition of a transaction reverting statement.
it is infrequent for developers to changetransaction reverting statements to other kinds of statementswhile keeping the condition unchanged .
.
in our dataset all of the four cases in this category are changing transaction reverting statements to general purpose if statements.
.
of the customizations fall into the add category .
fall into the delete category and .
involvedchanges.
besides .
customizations are cosmetic changes such as changing the order of clauses adding or removinga string message etc.
these changes do not alter the se mantics of the original transaction reverting statements.
theseresults show that developers are more likely to strengthen thetransaction reverting statements in template contracts.
finding the customized transaction reverting statements are commonly used for range checks and logic checks.
we further investigated the purposes of customizing transaction reverting statements.
we randomly sampled 100customized transaction reverting statements and manually an alyzed their purpose according to the taxonomy in table iv.
table viii shows the analysis results.
for the statements we identified customized clauses and categorizedthem accordingly.
the results indicate that the most frequentpurposes of the customized transaction reverting statementsare logic check .
range check .
and address validity check .
.
this is reasonable since custom contracts may need to deal with use cases different from thoseencountered by template contracts.
they would naturally havedifferent definitions of the validity of runtime values.
figure 3shows an example of a transaction reverting statement in acustom contract.require amount uint256 stake amount must not be zero.
fig.
.
an example customization with range check purpose require msg.sender ceo ceo only require msg.sender coo coo only require msg.sender cfo cfo only fig.
.
an example customization with address authority check purpose it is a stake contract that allows eip20 token to be staked.
staking is the process of investing tokens into the networkand get a reward for it.
compared with the eip20 tokentemplate contract the custom contract adds a transaction reverting statement to do range check to ensure that the staked amount provided by a staker is greater than which intendsto prevent the integer underflow vulnerability .
the other .
customizations are related to address authority check among which ten added statementsto perform authorization check on addresses and four deletedstatements for address authority check.
this is also understand able since custom contracts can have customized permissionsettings for different account types.
for example if there aremultiple authorized users with different identities the customcontract should add new transaction reverting statements toverify the identity of the transaction sender to prevent unau thorized operations as shown in figure .
637table viii thenumber of use purpose for customiza tion pa tterns of transaction reverting sta tements category sub category totaladd delete modify other add statements addclauses addvariables deletestatements deleteclauses deletevariables modifystatement types modifyclauses cosmeticchanges authorityv erificationaddress authority check token v erification v aliditychecklogic check range check overflow underflow check00 arithmetic check address v alidity check other total answer to rq3 transaction reverting statements in template contracts are commonly customized when developing smart contracts.
developers tend to strengthen transaction reverting statements mainly for logic and range checks.
implication the customizations of transaction reverting statements often serve security purposes.
future research may also focus on investigating the security impact of thecustomizations of transaction reverting statements.
d. rq4 security impact study methodology to answer rq4 we mutated the dapp contracts by removing the transaction reverting statements.
wethen leveraged smart contract security analyzers to detect thevulnerabilities in the original and the mutated contracts andcompared the detection results.
specifically we adopted astate of the art framework smartbugs to conduct thestudy.
it integrates nine smart contract security analyzers including honeybadger slither manticore etc.
collectively these nine analyzers can detect typesof vulnerabilities while many of them refer to the sametypes of vulnerabilities but have different names.
to unifythe vulnerability types we followed the existing practices and used dasp a smart contract vulnerability taxonomy to categorize the reported vulnerabilities.
another problemwith these analyzers is that they may generate many falsealarms due to the imprecise static analyses .
to mitigatethis problem we followed the existing practice and onlycounted those vulnerabilities that are reported by at least twoof the nine analyzers.
finding missing transaction reverting statements can introduce security vulnerabilities to smart contracts.
table ix presents the number of original dapp contracts and mutated contracts that are reported to contain vulnera bilities.
the number of vulnerable contracts increases afterremoving the transaction reverting statements.
in particular the number of contracts containing time manipulation and front running vulnerabilities increase significantly by .
and .
respectively.
this shows that transaction revertingstatements are useful in improving the security of smartcontracts.
to ease understanding we provide an example.figure shows a code snippet in a real smart contract.
aftertable ix thenumeber of contracts with a t least one vulnerability detected by multiple analyzers vulnerability category before after increase ratio access control .
arithmetic .
denial service .
reentrancy .
unchecked low calls .
front running .
time manipulation .
unknown unknowns .
before and after present the security vulnerability detection results for the original contracts and the mutated contracts respectively.
1function requirecorrectreceipt uint offset view private uint leafheaderbyte assembly leafheaderbyte byte calldataload offset require leafheaderbyte 0xf7 receipt leaf longer than bytes.
offset leafheaderbyte 0xf6 ... fig.
.
the number of vulnerabilities increases after mutation in contract0x9f91b5aa41b9fbdae6877593910586484d291f05.
removing the transaction reverting statement in line the contract is reported to have an underflow overflow vulnerability .
in this example both leafheaderbyte and offset are unsigned integers.
if line is removed the value ofleafheaderbyte in line can be smaller than 0xf7 which may lead to an underflow.
finding smart contract security analyzers can fail to analyze transaction reverting statements properly and inducefalse negatives in security vulnerability detection.
when inspecting the results reported by the nine analyzers we found that there are also cases where vulnerabilities inoriginal smart contracts disappear after removing transaction reverting statements.
this is counter intuitive as we have foundthat transaction reverting statements are commonly used forsecurity checks.
we found out that eight out of the ninecontract analyzers except maian used in our studysuffered from this problem.
we further inspected such cases 6381function contributewithaddress address contributor payable require msg.value mincontribamount uint contribvalue msg.value uint oldtotalcontributed totalcontributed totalcontributed oldtotalcontributed.add contribvalue uint newtotalcontributed totalcontributed if newtotalcontributed softcapamount oldtotalcontributed softcapamount softcapreached true endtime aftersoftcapduration.add now onsoftcapreached endtime ... fig.
.
the number of vulnerabilities decreases after mutation in contract 0x0abdace70d3790235af448c88547603b945604ea.
identified in our dataset.
figure shows a code snippet in a real smart contract.
the function contributewithaddress is reported to have a timestamp dependence vulnerability .
due to the direct use of now line which is an alias of block.timestamp a malicious block miner can manipulate the block s timestamp to gain profits from the contract.in this case the transaction reverting statement in line is notrelated to the vulnerability as it is not checking against blocktimestamp.
in other words after removing it the timestamp dependence vulnerability should still exist.
however the tool osiris does not report the vulnerability after removing thistransaction reverting statement.
this shows that osiris can befooled by the removal of transaction reverting statements andinduce false negatives.
we observed such cases in our dataset where the originally detected vulnerabilities disappeared after removingtransaction reverting statements.
in our future work we planto take a deeper look into this problem and investigate whyremoving transaction reverting statements can fool smart con tract security analyzers.
answer to rq4 missing transaction reverting statements can induce security vulnerabilities in smart contracts.
inother words transaction reverting statements can be usedto avoid vulnerabilities effectively.
however there arealso cases where removing irrelevant transaction revertingstatements can fool smart contract analyzers and inducefalse negatives in security vulnerability detection.
implication researchers need to further improve the effectiveness of smart contract security analyzers.
in particular properly dealing with transaction reverting statements is abasic and critical requirement for such tools.v.
t hrea ts to v alidity the validity of our study results may be subject to several threats.
first our selected template contracts may not besufficiently diverse or representative.
to mitigate this threat we considered the popularity of the templates in the selectionprocess.
the four template contract repositories are all widelyused by developers on github .
second we proposeda taxonomy to categorize the purposes of using transaction reverting statements in table iv.
there could be other ways tocategorize the purposes.
to address this threat we followed thewidely used open coding procedure to derive the results.
third our study results may be affected by human subjectivity whichis a common problem in qualitative coding .
to reduce thisthreat we followed the common research practices on manuallabeling by involving multiple people.
three authors iteratedthe labeling process three times to obtain the final taxonomy.this helped improve the reliability and generality of ourtaxonomy.
our data is also released for public scrutiny .fourth we used a code clone technique smartembed to identify custom contracts of template contracts and set thecode similarity threshold as following the experiments inthe original paper to reduce false negatives.
the chosen codeclone technique and threshold may affect the mapping results.also the subjects used when investigating rq3 are limited.we will keep expanding our dataset in the future and tryingother clone detectors to see if more reliable results can beobtained.
lastly we used a framework supporting nine smartcontract security analyzers to detect vulnerabilities in rq4.false positives and false negatives can both exist in the results.to reduce the threat we only kept results for items detectedas vulnerable by more than one analyzer.
besides the qualityof transaction reverting statements used in our constructedcontract dataset may affect the accuracy of the results sinceour analysis is based on the assumption that the transaction reverting statements analyzed are correct.
we plan to conductmore experiments and analyses in future studies to validateour findings further.
vi.
r ela ted work error handling statements.
v arious studies have been conducted to characterize error handling statements in otherareas.
filho et al.
studied the impacts of factors that affectthe exception handling code in aspect oriented programming aop techniques.
tian et al.
conducted a comprehensivestudy of error handling bugs and their fixes and implementederrdoc a tool to diagnose and repair error handling bugsin c programs automatically.
some other studies automatically detected and patched error handling bugs usinga variety of techniques.
different from the previous studies our work conducts the first empirical study on transaction reverting statements a type of error handling statements forethereum smart contracts.
it reveals the security impact oftransaction reverting statements which is specific to smartcontracts.
in terms of smart contracts several previous studies have discussed the usefulness of transaction reverting statements 639for providing defenses for vulnerabilities.
xue et al.
showed that the require statement could be used to prevent reentrancy vulnerability.
zhou et al.
observed thatmost smart contracts implemented defenses via transaction reverting statements to abort a transaction when noticing anattack.
however these studies only reported the use cases oftransaction reverting statements for specific purposes and didnot regard them as their major focuses.
in comparison ourwork is the first empirical study that systematically character izes the use of transaction reverting statements in real worldsmart contracts.
smart contract vulnerability detection.
in recent years there have been many studies targeting smart contract vul nerability detection.
static analysis methods inspected thecode of smart contracts without executing them.
examplesare oyente zeus v andal securify f framework and fether .
dynamic analysis methods check the runtime behavior of smart contracts to detectvulnerabilities.
nikolic et al.
employed inter proceduralsymbolic analysis and concrete validators for detecting realsecurity vulnerabilities.
ting et al.
constructed three kindsof graphs to characterize major activities on ethereum andproposed graph based techniques to detect security issues.while these studies proposed different techniques to detectvulnerabilities in smart contracts none discussed the securityimpact of transaction reverting statements.
our work showedthe prevalence of transaction reverting statements and con cluded the security impact of such statements.
our findingscan help improve security vulnerability detection techniquesfor smart contracts.
vii.
c onclusion and future work in this work we present the first empirical study on transaction reverting statements in ethereum smart contracts.through intensive analyses of real world smart con tracts and popular template contracts we showed thattransaction reverting statements are prevalent in smart con tracts.
they are often used to check the runtime status ofsmart contracts against security critical constraints.
our studycharacterizes the usage of transaction reverting statements inpractice and may shed light on future research in areas suchas smart contract security and quality assurance.
in the future we plan to extend our study by investigating the challenges in properly using transaction reverting state ments and identifying security issues induced by the misuseof transaction reverting statements.
we also plan to leverageour findings to improve the security vulnerability detectiontechniques for smart contracts.
a cknowledgment this work was supported by the national natural science foundation of china grant no.
and no.
hong kong rgc grf grant no.
hong kongrgc rif grant no.
r5034 and guangdong provincialkey laboratory grant no.
2020b121201001 .
lili wei was supported by the postdoctoral fellowship scheme of the hong kong research grant council.r eferences top smart contract use cases .com smartcontract use cases .
ethereum a secure decentralized generalized transaction ledger https ethereum.github.io yellowpaper paper.pdf.
coinmarketcap.
top cryptocurrencies by market capitalization ethereum daily transactions chart solidity documentation v0.
.
v0.
.
.
stack overflow website swc registry swc unchecked call return value swc .
openzeppelin contract library openzeppelin contracts.
aragonos smart contract framework aragonos.
ethereum smart contract best practices smart contract best practices .
ethereum improvement proposals c. b. seaman qualitative methods in empirical studies of software engineering ieee transactions on software engineering vol.
no.
pp.
.
dataset for characterizing transaction reverting statements in ethereum smart contracts w. zou d. lo p .
s. kochhar x. b. d. le x. xia y .
feng z. chen and b. xu smart contract development challenges and opportunities ieee transactions on software engineering .
ethereum in bigquery a public dataset for smart contract analytics dapp.com uniswap etherscan z. gao l. jiang x. xia d. lo and j. grundy checking smart contracts with structural code embedding ieee transactions on software engineering .
d. y uan s. park and y .
zhou characterizing logging practices in open source software in proceedings of the international conference on software engineering pp.
.
j. harty h. zhang l. wei l. pascarella m. aniche and w. shang logging practices with mobile analytics an empirical study on fire base arxiv preprint arxiv .
.
j. cohen a coefficient of agreement for nominal scales educational and psychological measurement vol.
no.
pp.
.
k. pan s. kim and e. j. whitehead toward an understanding of bug fix patterns empirical software engineering vol.
no.
pp.
.
python solidity parser swc integer overflow and underflow .io docs swc .
t. durieux j. f. ferreira r. abreu and p .
cruz empirical review of automated analysis tools on ethereum smart contracts inproceedings of the acm ieee 42nd international conference onsoftware engineering pp.
.
c. f. torres m. steichen et al.
the art of the scam demystifying honeypots in ethereum smart contracts in proceedings of the 28th usenix security symposium pp.
.
j. feist g. grieco and a. groce slither a static analysis framework for smart contracts in proceedings of the ieee acm 2nd international workshop on emerging trends in software engineering forblockchain pp.
.
m. mossberg f. manzano e. hennenfent a. groce g. grieco j. feist t. brunson and a. dinaburg manticore a user friendly symbolicexecution framework for binaries and smart contracts in proceedings of the ieee acm 34th international conference on automatedsoftware engineering pp.
.
decentralized application security project dasp maian swc block values as a proxy for time swc .
c. f. torres j. sch utte and r. state osiris hunting for integer bugs in ethereum smart contracts in proceedings of the 34th annual computer security applications conference pp.
.
github y .
chandra and l. shang qualitative research using r a systematic approach.
springer .
z. gao v .
jayasundara l. jiang x. xia d. lo and j. grundy smartembed a tool for clone and bug detection in smart contractsthrough structural code embedding in proceedings of the ieee international conference on software maintenance and evolution pp.
.
f. castor filho a. garcia and c. m. f. rubira extracting error handling to aspects a cookbook in proceedings of the ieee international conference on software maintenance pp.
.
y .
tian and b. ray automatically diagnosing and repairing error handling bugs in c in proceedings of the 11th joint meeting on foundations of software engineering pp.
.
w. weimer and g. c. necula finding and preventing run time error handling mistakes in proceedings of the 19th annual acm sigplan conference on object oriented programming systems languages andapplications pp.
.
m. susskraut and c. fetzer automatically finding and patching bad error handling in proceedings of the sixth european dependable computing conference pp.
.
j. lawall b. laurie r. r. hansen n. palix and g. muller finding error handling bugs in openssl using coccinelle in proceedings of the european dependable computing conference pp.
.
s. jana y .
j. kang s. roth and b. ray automatically detecting error handling bugs using error specifications in proceedings of the 25th usenix security symposium pp.
.
z. jia s. li t. y u x. liao j. wang x. liu and y .
liu detecting error handling bugs without error specification input in proceedings of the 34th ieee acm international conference on automatedsoftware engineering pp.
.
y .
xue m. ma y .
lin y .
sui j. ye and t. peng cross contract static analysis for detecting practical reentrancy vulnerabilities in smart con tracts in 35th ieee acm international conference on automated software engineering ase .
ieee pp.
.
s. zhou m. m oser z. yang b. adida t. holz j. xiang s. goldfeder y .
cao m. plattner x. qin et al.
an ever evolving game evaluation of real world attacks and defenses in ethereum ecosystem in proceedings of the 29th usenix security symposium pp.
.
l. luu d. h. chu h. olickel p .
saxena and a. hobor making smart contracts smarter in proceedings of the acm sigsac conference on computer and communications security pp.
.
s. kalra s. goel m. dhawan and s. sharma zeus analyzing safety of smart contracts.
in proceedings of the isoc network and distributed system security symposium pp.
.
l. brent a. jurisevic m. kong e. liu f. gauthier v .
gramoli r. holz and b. scholz v andal a scalable security analysis framework for smartcontracts arxiv preprint arxiv .
.
p .
tsankov a. dan d. drachsler cohen a. gervais f. buenzli and m. v echev securify practical security analysis of smart contracts inproceedings of the acm sigsac conference on computer andcommunications security pp.
.
k. bhargavan a. delignat lavaud c. fournet a. gollamudi g. gonthier n. kobeissi n. kulatova a. rastogi t. sibut pinote n. swamy et al.
formal verification of smart contracts short paper inproceedings of the acm workshop on programming languages and analysis for security pp.
.
z. yang and h. lei fether an extensible definitional interpreter for smart contract verifications in coq ieee access vol.
pp.
.
i. nikoli c a. kolluri i. sergey p .
saxena and a. hobor finding the greedy prodigal and suicidal contracts at scale in proceedings of the 34th annual computer security applications conference pp.
.
t. chen z. li y .
zhu j. chen x. luo j. c. s. lui x. lin and x. zhang understanding ethereum via graph analysis acm transactions on internet technology vol.
no.
pp.
.