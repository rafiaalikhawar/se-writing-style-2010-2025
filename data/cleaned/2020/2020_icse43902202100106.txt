shipwright a human in the loop system for dockerfile repair jordan henkel denini silvay leopoldo teixeiray marcelo d amorimy and thomas reps university of wisconsin madison madison wi usa yfederal university of pernambuco recife pe brazil jjhenkel reps cs.wisc.edu dgs lmt damorim cin.ufpe.br abstract docker is a tool for lightweight os level virtualization.
docker images are created by performing a build controlled by a source level artifact called a dockerfile.
we studied dockerfiles on github and to our great surprise found that over a quarter of the examined dockerfiles failed to build and thus to produce images .
to address this problem we propose s hipwright a human in the loop system for finding repairs to broken dockerfiles.
s hipwright uses a modified version of the bert language model to embed build logs and to cluster broken dockerfiles.
using these clusters and a searchbased procedure we were able to design rules for making automated repairs to dockerfiles.
with the aid of s hipwright we submitted pull requests with a .
acceptance rate to github projects with broken dockerfiles.
furthermore in a time travel analysis of broken dockerfiles that were later fixed we found that s hipwright proposed repairs that were equivalent to human authored patches in .
of the cases we studied.
finally we compared our work with recent state of theart static dockerfile analyses and found that while static tools detected possible build failure inducing issues in .
.
of the files we examined s hipwright was able to detect possible issues in .
of the files and additionally provide automated repairs for .
of the files.
keywords docker devops repair i. i ntroduction docker is one the most widely used tools for virtualization.
with of it companies using it docker has made an impact on developers day to day work.
developers use docker to author images via an artifact called a dockerfile.
images can be based on a variety of operating systems but primarily docker images are linux based.
dockerfiles are effectively a linear sequence of setup instructions that tell the docker engine how to prepare an image.
the final built image is then used to run docker containers.
these containers are similar to lightweight virtual machines.
each container starts with the clean environment specified by its originating docker image.
together images and containers allow for isolation scaling and reproducibility.
nonetheless we found that over of the analyzed samples of dockerfiles obtained in the wild sourced from github failed to build successfully.
this high a percentage is surprising because it runs counter to one of the core tenets of docker namely reproducibility.
furthermore it is outside of the scope of recent efforts to statically analyze dockerfiles equal contributions.to detect such failures.
for example hadolint can detect mistakes such as missing or incorrect flags e.g.
forgetting the use of assume yes y when invoking apt get install in a dockerfile.
this flag is required because a dockerfile build runs without interaction therefore forgetting this flag may cause the build to hang.
unfortunately while hadolint can detect such a mistake statically many breakages occur due to a change in the external environment andnot a change in the source dockerfile.
these observations add to the mounting evidence that external changes such as dependencies changing can often lead to broken build related artifacts .
as further evidence of this trend our prototype tool shipwright was used to guide accepted pull requests on github and for each of these patches the underlying issue was caused by a change in the external environment see section ii a for an example of one such change .the problem over a quarter of the github repositories with dockerfiles that we analyzed had a broken dockerfile.
current state of the art static analysis for dockerfiles is largely incapable of detecting and or repairing such broken dockerfiles.
given this situation our work seeks to meet the following high level goal our goal.
aid developers in automatically repairing broken dockerfiles with the hope of reducing the high percentage of broken dockerfiles that we observed on github.
a. contributions our work makes the following contributions technique.
we introduce a human in the loop approach to fixing broken dockerfiles tool.
we made available a tool implementing our technique and data.
we made available an extension of the binnacle dataset including build logs.
technique.
unlike previous approaches that attempt to mine patterns automatically and directly from dockerfiles s hipwright follows a human in the loop approach to build a repair database.
we include human supervision to broaden the effectiveness of s hipwright a fully automatic approach would limit the scope of repairs that could be detected.
shipwright is designed to act as a co pilot that can sidestep the limitations of a completely automatic approach with ieee acm 43rd international conference on software engineering icse .
ieee the goal of constructing a comprehensive database of repairs.
to build such a database s hipwright uses clustering human supervision and a search based recommendation system we built to leverage vast community knowledge bases such as stackoverflow and docker s community forum.
in general we require repairs to incorporate both some kind of pre condition pattern and a transformation function patch .
during clustering one challenge that s hipwright needs to address is the heterogeneity of the data which is a mixture of code and natural language.
the mixing of code and natural language makes it non trivial to design a featurization method for clustering.
therefore to address this challenge shipwright uses a modified version of google s bert model to embed dockerfile build logs.
by using a pretrained transformer based neural model we are able to sidestep tedious feature engineering and benefit from the diverse corpora on which bert based models have been trained.
using this embedding we perform clustering with hdbscan in the vector space of embedded build logs and use the results to cluster failing builds.
by using the vectors generated through bert we leverage the understanding encoded in bert s language model.
to our surprise we found that recent off the shelf language models work well in this domain.
using the generated clusters we employ human supervision to intuit for each cluster a likely root cause of failure and if possible engineer one or more automated repairs to save to s hipwright s database.
later s hipwright will use this human generated repair database to attempt automatic repair of failing dockerfiles.
tool.
the scripts to automate each of the steps of s hipwright see figure are publicly available at com star rg shipwright.
data.
we have identified a subset of dockerfiles from the binnacle dataset that are amenable to automated builds.
the dataset and filtering criteria are described in section iii.
we have built these files in context an expensive operation that requires hundreds of hours of compute time and captured detailed data from the results including logs from the builds.
these build logs represent a significant expansion of the data in the original binnacle dataset and it is our hope that this extended data will accelerate research on diagnostic tools for dockerfile analysis and repair.
this expanded data is available at b. evaluation we evaluated several aspects of s hipwright a summary of our results is as follows i broken dockerfiles are prevalent in the data we analyzed .
of dockerfiles failed to build.
ii even using optimistic criteria existing static tools are capable of identifying the cause of a failure in only .
.
of the broken dockerfiles.
iii s hipwright is capable of clustering broken dockerfiles and offering actionable solutions for files that clustered s hipwright provides automated repairs in .
of the cases for files that did not cluster shipwright is still able to provide automated repairs in18.
of cases.
iv in a time travel analysis we found that shipwright would be able to provide actionable solutions to .
of the dockerfiles that we found initially broken and then subsequently fixed in their respective repositories.
finally we used the reports from s hipwright to submit pull requests to still broken dockerfiles.
of these have been accepted.
these results provide initial yet strong evidence that s hipwright is useful to help developers fix broken dockerfiles.
ii.
s ources of build failures this section describes some of the distinct sources of problems that can lead to build failures in dockerfiles.
a. breaking changes in external files this kind of failure occurs when a dockerfile s external dependencies such as the file s base image or urls embedded within the file are changed often these changes external to the dockerfile will require a change in the dockerfile itself.
to illustrate this problem consider the case where the developer used latest to indicate the version of the base image of her dockerfile as in from ubuntu latest.
these base images are downloaded from docker hub a distributed database that is part of the docker ecosystem.
the problem with using latest is that a change to the base image may require changes to the dockerfile.
unfortunately there is no clear way to incorporate those required changes automatically.
for instance the python pip package is part of python and python is unavailable on ubuntu images higher than .
.
consequently a build on a dockerfile with the command apt get y install python pip will pass when the file is based on ubuntu images .
and lower but it will fail on higher versions including the latest lts version of ubuntu.
we used the s hipwright toolset to analyze and cluster hundreds of broken dockerfiles looking for common error patterns in their build logs and associated dockerfiles.
using a human in the loop process we then extracted patterns and associated them with candidate repairs.
for example when running the command docker build on the dockerfile from ubuntu latest...run apt get y install python pip... docker reports the message unable to locate package python pip on output.
when that message is present in the logs we found that the typical image in dockerfiles is ubuntu and the version is either undefined latest or .
.
we also noticed that this error message appears not only with python pip but with other packages as well.
we expressed these patterns with regular expressions to be checked against the dockerfile the static data and error logs the dynamic data .
for instance we expressed the pattern for the problem above with the regex from ubuntu latest .
unable to locate package .
2log.
note that such an expression defines a pattern over the dockerfile defines a pattern over the output log and uses the groups ... and .
to bind data to variables for later use.
figure shows two possible solutions to the problem above.
the first solution is to fix the base image to the most recent s o l u t i o n use v e r s i o n .
2from ubuntu .
3run apt g e t y i n s t a l l python p i p .
.
.
r e m a i n i n g code s o l u t i o n manually i n s t a l l t h e package 7from ubuntu l a t e s t 8arg debian frontend n o n i n t e r a c t i v e 9run apt g e t y i n s t a l l python2 c u r l s o f t w a r e prop .
.
.
add apt r e p o s i t o r y u n i v e r s e c u r l h t t p s .
.
.
get p i p .
py o u t p u t get p i p .
py python2 get p i p .
py .
.
.
r e m a i n i n g code fig.
solving python pip unavailable on ubuntu latest.
version with which the command can still be executed.
the following abstract operation characterizes the repair replace 0with .
.
the symbol 0refers to the regex group matching the ubuntu image in the dockerfile i.e.
... that must be replaced with one specific ubuntu version e.g.
.
.
the second solution is to install python and its toolset.
the following operation characterizes the repair add arg debian frontend ... after from ubuntu latest .
.
the symbol .
.
.
is a placeholder for the text associated with the second solution from figure .
shipwright records the association between a given pattern of build error and possible solutions such as the two repairs above.
from this information s hipwright is able to repair broken dockerfiles whose build logs match some of the pre recorded patterns.
table i describes this example under the row with id .
note that the repair operation consists of multiple possible solutions hence the comma and dots as we only show the first solution.
in this case s hipwright produces two versions of the dockerfile and the developer should choose which one suits best their needs.
we elaborate on s hipwright s workflow in the following sections.
it is worth noting that prior work has investigated the impact of breaking changes in package management systems e.g.
in the linux package manager npm maven etc.
.
s hipwright is not restricted to this kind of issue and is distinct from prior work on the application context and solution used.
section vii elaborates on related work.
b. inconsistent version dependency within project this kind of failure occurs when there is an inconsistency between the versions of a dockerfile and some of the files it