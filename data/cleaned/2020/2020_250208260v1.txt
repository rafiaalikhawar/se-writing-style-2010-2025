fixdrive automatically repairing autonomous vehicle driving behaviour for .
per violation yang sun1christopher m. poskitt1kun wang2jun sun1 1school of computing and information systems singapore management university singapore yangsun.
phdcs.smu.edu.sg cposkitt smu.edu.sg junsun smu.edu.sg 2state key laboratory of industrial control technology zhejiang university hangzhou china kunwang yml zju.edu.cn abstract autonomous vehicles a vs are advancing rapidly with level a vs already operating in real world conditions.
current a vs however still lag behind human drivers in adaptability and performance often exhibiting overly conservative behaviours and occasionally violating traffic laws.
existing solutions such as runtime enforcement mitigate this by automatically repairing the a v s planned trajectory at runtime but such approaches lack transparency and should be a measure of last resort.
it would be preferable for a v repairs to generalise beyond specific incidents and to be interpretable for users.
in this work we propose fixdrive a framework that analyses driving records from near misses or law violations to generate a v driving strategy repairs that reduce the chance of such incidents occurring again.
these repairs are captured in drive a high level domain specific language for specifying driving behaviours in response to eventbased triggers.
implemented for the state of the art autonomous driving system apollo f ixdrive identifies and visualises critical moments from driving records then uses a multimodal large language model mllm with zero shot learning to generate drive programs.
we tested f ixdrive on various benchmark scenarios and found that the generated repairs improved the a v s performance with respect to following traffic laws avoiding collisions and successfully reaching destinations.
furthermore the direct costs of repairing an a v minutes of offline analysis and .
per violation are reasonable in practice.
index terms autonomous vehicles autonomous driving systems multimodal large language models driving compliance i. i ntroduction autonomous vehicles a vs are currently undergoing rapid and promising development.
notably several level a vs which do not require driver intervention have been successfully deployed in real world traffic scenarios .
prominent examples include google waymo baidu apollo and tusimple .
these a vs are capable of performing critical tasks such as perception trajectory planning and actuation control.
however despite these advancements a vs are far from perfect and still lag significantly behind human drivers in terms of performance and adaptability.
for instance a vs sometimes exhibit overly conservative driving behaviour which can lead to situations where they become stuck on the road .
furthermore autonomous driving systems adss the brains of a vs responsible for perception decision making and control can also be overly aggressive and cause accidents under specific conditions .
such behaviours are often easily recognisable and avoidable by human drivers underscoring the need forsignificant improvements before a vs can match or surpass human driving capabilities.
existing work offers two categories of solutions to address these problems.
the first category uses rule based runtime enforcement to correct problematic behaviour directly .
for example when an ads encounters potential violations of specific property specifications e.g.
traffic laws one proposed solution outlined in redriver uses a gradient based algorithm to modify the a v s planned trajectory.
however these repairs are limited in scope and lack transparency since they are very low level and difficult for users to interpret.
furthermore they are meant to be a measure of last resort rather than a general correction to driving strategies.
the second category involves learning based methods which train adss to behave like human drivers using real driving data.
these approaches focus on exploring and summarising human driver behaviour patterns to guide the driving modes of adss such as imitation learning to replicate expert behaviour and train the ads to drive in a human like manner .
however these approaches often fall short due to the difficulty of capturing the nuanced decision making processes of human drivers from limited data leading to poor generalisation or overfitting to specific tasks.
consequently there is a need for an a v driving strategy repair approach that generalises beyond specific incidents and is interpretable for users.
multimodal large language models mllms appear to be intelligent and ideally suited for improving adss due to their advanced text and image understanding and reasoning capabilities .
trained on massive datasets mllms can interpret and replicate human driving behaviour thereby making ads decisions more explainable .
existing works e.g.
explore utilising mllms to replace parts of the ads such as perception planning and control thereby making the decision making logic more understandable.
for example gpt driver abstracts the perception and prediction results of the ads into language tokens then uses openai gpt .
to directly produce the planned trajectory along with explanations.
however the inherent latencies and uncertainty associated with generative models make it impractical to build an ads based solely on online mllms.
additionally there is a significant gaparxiv .08260v1 feb 2025non compliant record rules drive av prompt violation near miss mllm simulator fig.
overview of f ixdrive between natural language and the actual control commands for autonomous vehicles making it challenging to directly apply mllm generated solutions to real world driving tasks.
currently there are no practical approaches that leverage mllms in a manner that is both offline and compatible with existing ads frameworks such as apollo and autoware .
in this work we propose f ixdrive a method that analyses records i.e.
comprehensive log files from bad driving behaviours such as collisions near misses or law violations then generates general a v driving strategy repairs to reduce the chance of such incidents occurring again.
rather than modifying code or applying opaque low level fixes fixdrive produces repairs in drive a high level domain specific language dsl for specifying the driving behaviours that should occur upon certain triggers e.g.
approaching a traffic light .
f ixdrive identifies and visualises critical moments from incident records then utilises an mllm with zero shot learning to generate drive programs that repair the driving strategy.
this translation is executed offline and once per violation allowing our approach to leverage the reasoning capabilities of mllms while mitigating their latency issues.
additionally by generating repairs in a highlevel dsl they are more interpretable compared to those of low level gradient based approaches like redriver .
note that we categorise methods as either offline or online based on how they interact with runtime driving decisions.
for example an mllm that generates real time driving decisions based on the current driving context is classified as an online method.
conversely f ixdrive is an offline framework enhancing the ads through repair scripts generated before further runs.
an overview of f ixdrive is shown in figure .
users need only provide records from executed driving scenarios and the corresponding property specifications e.g.
traffic laws collision avoidance that were violated.
f ixdrive automatically identifies two critical moments from the records the near miss and the violation moments visualises them for a multimodal prompt then utilises a state of the art mllm openai gpt to generate driving strategy repair scripts in the drive dsl.
additionally openai s function calling is used to ensure that the mllm generates syntactically valid drive programs which are specified via a json schema.
the resulting program is then applied to the apollo ads dynamically adjusting the parameter settings of the planning module to repair its driving strategy at runtime.
we evaluated f ixdrive on a set of benchmark scenarios in which the ads violated various property specifications such as different traffic laws collision avoidance and successful 1 2 1 2 1ui 2 f x0 x1 xk fig.
specification language syntax where 1and 2are stl formulas iis an interval and fis a multivariate linear continuous function over language variables xi journey completion.
f ixdrive provided effective general driving strategy repairs that helped the ads successfully navigate these problematic scenarios without adversely affecting performance in normal scenarios.
additionally f ixdrive consistently generated effective a v driving strategy repairs with practically reasonable direct costs i.e.
less than minutes and typically around minutes of offline analysis and .
per violation.
ii.
b ackground and problem in this section we review the architecture of adss dsls for specifying safety properties and specifying high level driving behaviours the current capabilities of mllms and then formally define our problem.
a. overview of adss state of the art open source adss such as apollo and autoware share similar architectures.
these systems are typically organised into loosely coupled modules that communicate via message passing.
three of these modules are particularly relevant in our context perception motion planning and control.
the perception module receives sensor readings e.g.
from cameras or lidar processes them and publishes the resulting data to the motion planning module.
the motion planning module then classifies the current driving scenario into categories such as lane follow borrow lane and traffic light handling .
each scenario has distinct processing logic and key parameters.
for example the emergency pull over scenario involves two key parameters expected speed and stopping distance .
during an emergency pull over the vehicle is expected to rapidly decrease to the expected speed and then proceed to pull over with the stopping distance indicating how far the vehicle should travel before coming to a complete stop.
for more detailed information on how these key parameters work we refer the reader to .
for each scenario the motion planning module generates a corresponding planned trajectory based on the map destination sensor inputs and the state of the ego vehicle i.e.
the vehicle under ads control .
this planned trajectory outlines the vehicle s future positions at various time points taking into account the predicted environment which includes factors such as the anticipated movements of other vehicles npcs pedestrians and traffic light states.
finally the control module translates the planned trajectory into control commands e.g.
braking acceleration steering and signaling so that the ego vehicle follows the planned trajectory passing through the waypoints with the desired speed acceleration steering angle and gear position.program rule rule rule string literal trigger event trigger condition then action end event trigger event always fig.
abstract syntax of drive programs b. specifying safety properties in the context of a vs safety should not simply mean the absence of collisions but also adherence to the rules of the road that drivers are supposed to abide by.
to that end we adopt the property specification language used by lawbreaker as well as the project s existing specifications of the traffic laws of china and singapore.
the specification language is based on signal temporal logic stl and is evaluated with respect to traces of scenes providing a way to automatically determine whether a tester defined property was violated or not in a simulated run of the ads.
we highlight the key features of the specification language below the full syntax and semantics is given in .
the high level syntax of the language is shown in figure .
a time interval iis of the form where landuare respectively the lower and upper bounds of the interval.
following convention we write i to denote true ui and i to denote i .
intuitively u and are modal operators that are respectively interpreted as until always and eventually .
we omit the time interval when it is .
in general can be regarded as a proposition of the form f x0 x1 xk where fis a multivariate function and xifor all iin is a variable supported in the language.
example ii.
.
suppose we have a signal variable speed speed speed .
.
.
speed n which represents the autonomous vehicle s speed throughout its journey.
then we can create a simple boolean expression speed t 60to test whether the speed of the vehicle is larger than 60km h .
note that can be regarded as a proposition of the form speed t 0orspeed t .
to verify whether holds true at all time steps we can use the temporal logic symbol always resulting in the formula speed .
a specification is evaluated with respect to a trace of scenes denoted as 0 1 2. .
.
n where each scene iis a valuation of the propositions at time step i and 0 reflects the state at the start of a simulation.
the language follows the standard semantics of stl see e.g.
.
c. specifying driving behaviours the default output of a large language model llm is natural language which can be vague and challenging to utilise.
to obtain specific and actionable behaviours for a vs we need a robust method to ensure that the output of the llm is always valid and directly applicable to a vs. to achieve this we utilise the high level dsl drive which allowsrule drive slowly through a junction when there is an obstacle.
trigger entering junction condition obstacle distance leq is traffic light green then cruise speed until exiting junction end fig.
drive driving strategy repair example driving behaviours to be specified in simple rules that are triggered by contextual events e.g.
approaching a traffic light .
the abstract syntax of drive in ebnf format is shown in figure .
a drive program contains one or more rules each consisting of up to five parts a name or description expressed as a string a trigger which is an event that causes the rule to be applied zero or more conditions which constrain the application of the rule one or more actions which are assignments of driving related variables that are applied for the duration of the rule at most one exit trigger which is an event that ends the application of the rule.
intuitively events represent states monitored by drive as the a v drives through its environment.
for example the events entering junction andexiting junction are set to true when the a v is entering or exiting a junction respectively.
conditions specify what must be true of the current environment to allow the rule to be applied.
for example the conditions istraffic light green and obstacle distance leq indicate that the rule can take effect only when the traffic light ahead is green and the a v is within metres of an obstacle.
actions are tasks executed throughout the duration of a rule application.
for example the action cruise speed sets the default planning speed of the a v to km h. an overall example of a drive program is shown in figure .
this program indicates that within a junction if an obstacle is detected within metres and the traffic light ahead is green the default planning speed of the a v should be set to km h. for a detailed introduction to the grammar of drive we refer readers to .
d. multimodal large language models mllms mllms integrate and process multiple types of data including text images audio and video.
these models utilise the capabilities of large scale neural networks to comprehend and generate content across different modalities thereby offering more comprehensive and versatile ai functionalities.
state ofthe art mllms such as openai s gpt and google s palm e exemplify the advancements in this field.
gpt4 for instance can process textual inputs while simultaneously understanding and interpreting images enabling it to describe images answer related questions and seamlessly integrate visual information with textual content.
similarly palm e a large multimodal embodied language model integrates textual and visual data to enhance its ability to comprehend and interact with the physical environment.these models are trained on extensive datasets that encompass diverse forms of media which allows them to acquire a vast amount of general knowledge.
this training enables mllms to perform a wide variety of tasks such as generating detailed image captions providing contextually aware responses and enhancing search engines with improved understanding of visual queries.
the multimodal approach significantly enhances the model s utility making it capable of tasks beyond the scope of single modality models.
by integrating multiple types of data mllms are advancing the frontier of ai creating more intuitive and intelligent systems that better mimic human cognition and understanding.
e. the problem assuming the availability of a powerful mllm such as chatgpt with the capability to comprehend driving conditions and provide appropriate suggestions the challenge lies in efficiently leveraging this mllm to analyse records of a v violations and generate driving strategy repairs in drive that would prevent such violations occurring again in the future.
we formulate our problem as follows definition problem definition .given an mllm a record of the av in a scenario and a property specification of ads behaviour suppose that .
the objective is to utilise the mllm to generate drive programs based on the combination of and .
let denote the resulting record of the av by replaying the same scenario with the drive programs generated by the mllm applied.
the goal is to increase the likelihood of .
intuitively when a scenario is identified in which the a v violates specified properties we provide relevant information in the prompt to the mllm to enable it to understand the current situation.
the mllm then offers suggestions in the form of a drive program to help ensure such a violation does not occur again.
to maintain minimal and interpretable additional control logic the drive programs should be kept as small as possible.
this context highlights two critical requirements for our approach develop a method to automatically provide accurate and relevant information to the mllm ensure that the mllm s suggestions are translated into valid and effective drive programs.
iii.
o urapproach fixdrive our framework for obtaining general driving strategy repairs via mllms comprises three main steps.
first problem localisation which identifies when the violation of the specified properties occurred and any near miss situations.
second prompt generation which automatically generates the necessary text prompts and visualisations of specific driving conditions.
these specific conditions refer to the time steps when property violations and near miss situations occurred.
finally drive script generation which formats the mllm s responses into syntactically valid drive scripts ensuring the driving strategy repairs are executed by the ads.a.
problem localisation one possible way to allow a language model to comprehend a driving incident is to provide it with a complete record i.e.
a structured log file that captures all necessary data to recreate the driving scenario.
this log would include detailed information on the driving environment perception routing details predictions of other vehicles pedestrians and traffic lights as well as motion planning and control commands.
however processing such comprehensive records is computationally intensive costly and time consuming.
fortunately in driving scenarios where certain properties are violated there are always a few key moments that hold significant importance.
identifying these moments allows for a better understanding of the driving scenario and can also be automated.
for example aca v reduces the length of driving records by .
based on a causality analysis and correctly identifies causal events in .
of a set of generated accident records.
in this work we develop a lightweight approach based on a quantitative semantics to identify two critical moments the near miss andviolation moments .
the violation moment is the point at which a specific property is violated.
the near miss moment occurs a few time steps before the violation during which the violation is likely but has not yet happened.
for example if the property that the a v should follow is avoid collisions with other objects the violation moment is when the vehicle collides with another object while the near miss moment is when the vehicle fails to maintain a safe distance from other vehicles.
the logic is straightforward the violation moment represents the final outcome whereas the near miss moment could be the potential cause of the property violation.
we explain in the following how to identify them.
quantitative semantics.
to locate critical moments we need a method for quantitatively evaluating whether the current trace satisfies a given property.
to achieve this given a property specification and a driving record for the ads f ixdrive first constructs a trace from the record by evaluating all variables relevant to at each time point.
an execution trace is a sequence of scenes denoted as 0 1 .
.
.
n .
a scene is a tuple of the form f0 f1 .
.
.
f x where eachfiis the valuation of a variable.
these variables describe the status of the vehicle traffic signal states and traffic conditions.
for example variables such as isovertaking junctionahead n and npcahead n indicate whether the vehicle is changing lanes whether there is a junction ahead within nmetres and whether there is a vehicle ahead within nmetres respectively.
for a detailed introduction to these variables we refer the readers to .
next f ixdrive computes how close the ego vehicle will come to violating .
to measure how close a trace is to violating we adopt a quantitative semantics that produces a numerical robustness degree.
definition quantitative semantics .given a trace and a formula the quantitative semantics is defined as the robustness degree t computed as follows.
recall thatpropositions are of the form f x0 x1 xk .
t t f x0 x1 xk if is or t f x0 x1 xk if is or t f x0 x1 xk if is t f x0 x1 xk if is where tis the time step and t e is the valuation of expression eat time tin .
t t 1 2 t min 1 t 2 t 1 2 t max 1 t 2 t 1ui 2 t sup t1 t imin 2 t inf t2 1 t i t sup t t i t i t inf t t i t t t where t iis the interval given i .
note that the smaller t is the closer is to violating .
if t is violated.
we write to denote to denote t and to denote t .
note that time is discrete in our setting.
example iii.
.
let speed i.e.
the speed limit is 60km h. suppose is speed .
.
.
speed .
.
.
.
speed .
.
.
where the ego vehicle s max speed is50km h at the last time step.
we have min t t speed .
this means that trace satisfies and the robustness value is .
violation and near miss moments.
with quantitative semantics we can now introduce the method to locate the violation moment andnear miss moment .
given a trace 0 n let kdenote the prefix 0 k where k n. intuitively krepresents the first ktime steps of the original trace .
for the violation moment we identify the smallest kthat satisfies k .
for the near miss moment we adopt a user customisable threshold .
we aim to identify a time step ksuch that k and there does not exist a time step lsuch that l k and l .
note that is determined empirically in our evaluation see section iv .
intuitively kis the earliest time step when the robustness value falls below the threshold .
we identify the time step kusing a sequential search starting from k 0and incrementing kuntil we find a ksuch that k .
example iii.
.
let speed i.e.
the speed limit is 60km h. suppose the threshold suppose is 0 speed .
.
.
1 speed .
.
.
90 speed .
.
.
where the ego vehicle speed is increasing over time steps and the ego vehicle s max speed is90km h at the last time step.
we have min t t speed .
hence the specification is violated.
the following are computed in sequence 0 1 55 59 60 61 to identify the violation moment we find the smallest time stepkwhere k .
in this case k .
similarly the smallest time step kwhere k 5isk .
therefore the violation moment occurs at time step and the near miss moment occurs at time step .
b. prompt generation the input for an mllm can be in various formats such as images videos audio and text prompts.
given that mllms are trained on extensive datasets rich in knowledge we anticipate they will understand the prompts we provide much like an intelligent human.
in this work we utilise two types of prompts visualisations of driving conditions and text descriptions to convey essential information not covered by the visualisations.
visualisations of scenarios.
in the driving records of ads trajectories each time step contains extensive information such as the speed acceleration and steering angle of the a v as well as the positions of other vehicles and pedestrians.
while it is possible to describe this information in natural language it does not provide a direct impression of the driving scenario.
for example given the positions of the a v and another background vehicle it can be challenging to determine the exact direction of the background vehicle relative to the a v .
fortunately visualising the driving scenario can help alleviate this problem and state of the art adss such as apollo offer this capability.
detailed information including the positions of various objects can be effectively conveyed through visualisation by displaying a grid map that shows the relative positions of each object.
an example of this visualisation is shown in figure .
in this visualisation the upper left section labelled vehicle visualization displays the current driving conditions of the a v marked in blue other vehicles marked in green boxes pedestrians marked in yellow boxes cyclists marked in blue boxes and unknown objects marked in purple boxes .
each box includes numerical values indicating the distance to the a v and the current speed of the object.
the predicted trajectory of each object is shown as a coloured line.
the lower left section labelled console shows logs from the ads while the module delay section indicates the delay of each module.
the right section labelled vehicle dashboard shows the current status of the a v and the detected status of traffic lights ahead.
the pnc monitor section provides detailed information on the inner decisions of the planning and control modules.
this visualisation compactly encodes rich information in a human friendly manner.
this is important for the transparency of the approach it allows the mllm s decisions to be based on the same high level information that drivers work with instead of for example low level gradient based discrepancies.fig.
visualisation of a scenario which is provided to the mllm along with an overall prompt overall prompt.
the overall prompt consists of two parts the first part includes two images illustrating the visualisation of theviolation moment and the near miss moment as shown in section iii a and the second part is a text prompt.
our text prompts complement the ads visualisation by providing necessary additional information.
these prompts follow a specific workflow to enable automatic generation.
first we specify an identity for the mllm identity suppose you are a driver.
next since the visualisations do not contain weather information we provide information about the current weather conditions.
for example we state the following if there is no rain fog or snow and the visibility is more than metres weather there is nothing noteworthy about the weather.
to aid the mllm s understanding of the provided image we offer background details about the input image.
this includes describing different aspects of the visualisation to help the mllm to understand it background in these pictures the left side shows the visualisation of the driving record.
the right side displays the status of the traffic light vehicle speed and steering angle.
the green boxes indicate detected vehicles yellow boxes indicate detected pedestrians blue boxes indicate detected bicycles and purple boxes indicate unknown objects.
following this we describe the property specification that the a v is supposed to satisfy e.g.
the avoidance of collisions or adherence to traffic laws.
note that we use the original traffic laws from as input when the property is an stlbased traffic law specification.
for example if we are testing the property no collisions we would state rule you are supposed to follow the following rule avoid collisions with other objects.
then we specify the time gap between the violation moment and the near miss moment and clarify that the former image depicts the violation sequence the second picture was taken seconds later than the first picture capturing the moment when the rule violation occurred.
finally we provide some initial settings of the current ads to assist the mllm in making decisions default in the original ads the initial settings are max planning speed 72km h ... c. drive script generation the driving strategy repairs generated by the mllm must be in the correct format i.e.
pertaining to the drive grammar in section ii c. this is challenging to achieve with a language model alone as they have the potential to hallucinate and make mistakes.
mllms such as chatgpt however have added support for function calling which enables users to connect the models with external tools and design integrated workflows.
additionally openai s introduction of structured outputs ensures that the arguments generated by the model adhere precisely to a specified json schema as defined by the user in the function call.
in f ixdrive we implemented function calling based on a structured json schema that describes the syntax of drive programs.
this schema guides the mllm to produce outputs that are always structured as syntactically valid drive programs including all parameters and constructs mandated by the full drive grammar.
by leveraging this function weachieve a reliable and structured generation of drive scripts that align with expected syntax.
for an example of function calling with our json schema please see our repository .
our function is designed with several key principles in mind structural integrity we ensure that the structure of the output drive program always adheres to the syntax of drive.
specifically each program must include one trigger zero or more conditions one or more actions and at most one exit trigger.
the sequence is strictly enforced i.e.
trigger conditions actions followed by the exit trigger if it exists.
comprehensive descriptions to help the mllm fully understand the meaning and functionality of each element we add detailed descriptions to all events conditions and actions in natural language.
these descriptions are sourced from the official documents of ads and drive to ensure accuracy and clarity.
clear parameter definitions the unit parameters within events conditions and actions are clearly defined to avoid any potential misunderstandings.
this precision helps the mllm to generate accurate and contextually appropriate programs.
by adhering to these design principles integrating drive with an mllm facilitates the creation of actionable and precise programs that can then be applied in subsequent deployments of the ads to improve its driving strategy.
for more information on our prompts function calling and implementation details please refer to the source code .
iv.
i mplementation and evaluation a. implementation we have implemented f ixdrive for apollo .
the latest version at the time of our experiments and the widelyused mllm chatgpt version chatgpt turbo .
the simulator utilised in our experiments is the official dreamview plus provided by apollo .
.
our framework f ixdrive comprises three main components trajectory record analysis tool this tool identifies the specific time step at which the quantitative semantics of the trace fall below a specified threshold according to a given specification such as no collisions and adherence to traffic rules in different countries .
it enables us to precisely pinpoint the exact moment a violation occurs and to detect near miss situations where a violation is likely but has not yet occurred.
prompt generator this component generates both the text prompt and captures a visualisation of the driving conditions at specific time steps.
it organises this information into function calls for chatgpt.
essentially the the prompt generator automatically creates the input provided to the mllm based on specified criteria and recorded data.
translation and verification the response from the mllm is translated into a domain specific language drive which outlines general driving strategy repairs e.g.
stopping when a pedestrian is ahead .
an additional validity check ensures that the syntax is correct.
these strategy repairs are then verified using the simulator to ensure they enable the autonomous vehicle to successfully navigate the given scenario.
our implementation leverages some components from previous work.
specifically from lawbreaker we utiliseits specification language and the corresponding verification algorithm.
from drive we employ its dsl and backend support for applying new driving strategies in apollo.
b. evaluation our evaluation considers four research questions rqs rq1 does f ixdrive effectively repair the driving behaviour of an ads?
rq2 are these driving strategy repairs applicable to common driving scenarios?
rq3 how much effort is required to compute repairs?
rq4 what is the impact of using images for critical moments instead of text?
rq1 considers whether f ixdrive achieves its primary goal of being able to utilise mllms to effectively repair the driving behaviour of an ads following a violation event.
rq2 investigates the effectiveness of f ixdrive s driving strategy repairs based on a small sample of records in improving a v performance across different scenarios.
rq3 examines the computational effort needed to utilise f ixdrive .
rq4 validates the effects of using images in the prompt instead of ground truth values in textual prompts.
our experiments utilise both apollo .
and the apollo simulation platform referred to as apollo studio .
to account for simulator randomness e.g.
due to concurrency each experiment is repeated times and we present the averages.
we utilise a linux machine ubuntu .
.
lts with 32gb of ram an intel i7 10700k cpu and an rtx 2080ti graphics card.
rq1 does fixdrive effectively repair the driving behaviour of an ads?
to answer this question we employed a benchmark of scenarios provided by where apollo consistently violates specifications.
table i reports the effectiveness of our approach in preventing these violations compared to the original apollo and the runtime enforcement method redriver .
note that the threshold for f ixdrive is set to determined by an empirical experiment discussed later in this section.
the law column in the table denotes the specific property specification under which the a v is tested.
we adopted the formalisation of traffic laws reported in as part of our property specifications and evaluated whether fixdrive can be applied so that the ads follows them.
specifically we adopted four rules sourced from the regulations for the implementation of the road traffic safety law of the people s republic of china law38 law44 law46 and law53 .
these rules encompass regulations concerning traffic lights yellow green red speed limits for the fast lane speed limits under adverse weather conditions such as fog rain and snow and managing traffic jam respectively.
additionally we applied the property specifications no collision and finish journey to evaluate the a v as well.
the detailed property specifications of these two rules can be expressed as nocollision nearestnpc .
finish journey speed .
dest here the specification no collision requires that the distance to other objects always be greater than .
metrestable i performance comparison of f ixdrive redriver and apollo law scene driver fix pass robustness context no collisions1apollo .
the a v entered the intersection during a green light vehicles redriver .
but failed to yield to the straight moving fixdrive .
resulting in an accident.
s2apollo .
the a v fail to yield to the oncoming straight through traffic redriver .
at the stop sign and proceed to make a left turn at the intersection fixdrive .
resulting in an accident.
law38s3apollo .
.
.
the a v started and entered the intersection when the traffic light redriver .
.
.
was yellow.
fixdrive .
.
.
s4apollo .
.
.
the a v entered the intersection on a red light.
redriver .
.
.
fixdrive .
.
.
law44 s5apollo .
the a v is traveling in the fast lane and come to a stop due to redriver .
an static obstacle failure to change lanes to an available fixdrive .
lane on the right ultimately failing to reach its destination.
law46 s6apollo .
.
the a v continues to travel at speeds exceeding kilometres redriver .
.
per hour despite fog or rain.
fixdrive .
.
law53 s7apollo .
the a v is approaching a junction with traffic jam.
redriver .
fixdrive .
finish journey s8apollo .
the a v failed to overtake a stationary vehicle ahead and became redriver .
stuck.
fixdrive .
i.e.
nearestnpc .
.
the specification finish journey requires that the a v must not stop on the road i.e.
speed .
unless it is close to the destination i.e.dest .
we refer the readers to our repository in to see all the detailed specifications.
the fix column in table i shows the proportion of successful driving strategy repairs generated by f ixdrive .
a driving strategy repair is deemed successful only if it ensures that the a v causes no violations.
to evaluate this we repeat the generation process times for each driving record generating one unique driving suggestion per run.
each suggestion is then applied to the autonomous vehicle and tested for effectiveness in the same scenario through simulation allowing us to assess whether the repair successfully resolves the failure.
our empirical analysis indicates that while different suggestions may be generated for the same record they typically converge into a limited set of outcomes.
consequently repetitions are empirically sufficient to capture all possible outcomes.
the pass column indicates the proportion of runs that comply with traffic rules.
it signifies the success rate of each effective suggestion which is always for f ixdrive .
note that the mllm generates varied suggestions across runs due to inherent uncertainty.
however empirical analysis shows that most effective suggestions are consistent across trials.
therefore we select the most frequently successful suggestion to determine the final values in the pass and robustness column.
the robustness column in the table illustrates the robustness of the a vs regarding current traffic regulations.
the robustness value is calculated as the average performance of these effective suggestions.
for example the three values for the specification law38 indicate the robustness values for green light yellow light and red light related traffic laws respectively.
specifically the robustness value measures how closely the vehicle trajectory adheres to these rules.
a higher robustness value indicates a lower likelihood of violating traffic regulations whereas a lower value indicates a higherrule s1 rule1 trigger always condition front vehicle closer than then follow dist yield dist overtake dist obstacle stop dist obstacle decrease ratio endrule s1 rule2 trigger always condition is traffic light red traffic light distance leq then traffic light stop dist end fig.
drive driving strategy repair scripts for s1 likelihood of imminent violation.
a value less than or equal to0indicates a violation of the corresponding traffic rule.
furthermore if a regulation comprises multiple sub rules the robustness for each sub rule is sequentially presented.
as shown in table i apollo s success rate in these scenarios consistently remains below often reaching .
while redriver can prevent some of the violations sometimes there are still instances it cannot address.
in contrast the repairs by f ixdrive enable the a v to completely avoid accidents and violations.
this is because redriver focuses on a narrow case by case view making decisions based only on current perception and prediction and thus heavily depends on the accuracy of the ads s original predictions which may be wrong .
for example in scenario s1where an a v fails to yield to a straight moving vehicle redriver cannot prevent the violation because it cannot reverse the decision not to yield which was based on the prediction that the vehicle would not obstruct its path.
in contrast in the driving strategy repairs generated by f ixdrive as shown in figure the first program dynamically adjusts parameters such as follow distance yield distance overtake distance stop distance and obstacle response rate when a vehicle is within metres ahead.
additionally the second program ensures safety by adjusting the a v s stop distance when approaching a red light and the distance to the stop line is less than metres.
this adaptive approach based on a global perspective continuously modifies the vehicle s driving style as conditions change thereby effectively avoiding accidents before theytable ii effectiveness of f ixdrive across varying s1 s2 s3 s4 s5 s6 s7 s8 occur.
due to the inherent uncertainty of the generative model the proportion of successful repairs sometimes falls below as shown in fix column .
however our evaluation of fixdrive s time and cost efficiency in rq3 demonstrates that generating each driving strategy repair is both time efficient and cost effective mitigating this issue.
to further investigate rq1 we designed a second experiment to examine how varying f ixdrive s thresholds impact its effectiveness.
recall that the threshold defines the fault tolerance of f ixdrive determining what constitutes a nearmiss situation as discussed in section iii a. the detailed effectiveness evaluation for all thresholds is shown in table ii.
in this table the first column denotes the threshold value ranging from to .
the subsequent columns represent scenarios s1 to s8 as mentioned above.
if f ixdrive can provide driving strategy repairs that help the a v resolve the encountered problem i.e.
satisfy the corresponding specification within queries we mark it with a .
otherwise we mark it with a .
as show in table ii the threshold value significantly impacts f ixdrive s effectiveness in certain scenarios.
when the threshold is very small such as or the near miss moments are too close to the violation moment providing insufficient information about why the violation occurs.
conversely if is too large such as the near miss moment may not provide any useful information as there may be no indication of a potential violation.
this can lead to f ixdrive s failure to deliver effective programs.
for example in scenario s1 where the a v is making a right turn and fails to yield to vehicles going straight the timing of the threshold is critical.
when the threshold is set to values below the a v is already impeding the straight moving vehicles at the near miss moment making it difficult to implement effective changes.
conversely when the threshold is set to the a v has not started the right turn yet at the near miss moment and the potential problem has not yet arisen.
in some scenarios f ixdrive can be effective for all threshold values if the near miss moment does not provide critical information.
for example in scenario s6 where the vehicle exceeds km h in snowy conditions the critical information is that the a v exceeds km h at the violation moment.
since snow conditions remain consistent the choice of near miss moment does not affect f ixdrive s effectiveness.
rq2 are these driving strategy repairs applicable to common driving scenarios?
to answer this question we applied all the drive driving repair scripts generated by f ixdrive across the eight scenarios mentioned above.
in total there are different driving strategy repair programs.
for detailedtable iii performance of f ixdrive in official scenarios map num driver finish accident sunnyvale 114apollo fixdrive sanmateo 103apollo fixdrive apollo virtual 52apollo fixdrive information on these driving strategy repair programs we refer readers to .
we applied these strategy repairs to all the official scenarios provided by apollo across three maps sunnyvale san mateo and apollo virtual .
for the sunnyvale map there are different scenarios.
the san mateo map contains different scenarios while the apollo virtual map includes different scenarios.
these scenarios cover most situations encountered during daily city driving such as passing traffic lights yielding to pedestrians and priority vehicles cutting in changing lanes overtaking and making u turns.
for detailed descriptions of these official scenarios provided by apollo refer to .
first we compared apollo with f ixdrive i.e.
apollo with the driving repairs applied regarding completion rate andaccidents as shown in table iii.
regarding completion rate we evaluated whether the a v successfully reached the destination and completed the journey as indicated in the finish column.
all scenarios completed by apollo were also completed by f ixdrive .
additionally f ixdrive could finish extra scenarios where apollo got stuck.
for example in some scenarios apollo failed to overtake a stationary vehicle ahead because it followed too closely while f ixdrive completed these scenarios by maintaining a larger following distance.
regarding accidents we examined the number of accidents caused by apollo and f ixdrive as shown in the accident column.
f ixdrive not only avoided causing new accidents but also prevented an accident in one scenario.
it is important to note that all remaining accidents were not caused by the a v .
they were caused by irrational vehicles or pedestrians colliding with the driver from behind.
typically this occurred when the a v had reached its destination and stopped and another vehicle hit it from the back.
to further investigate rq2 we conducted an in depth analysis.
specifically for scenarios that apollo and f ixdrive successfully completed we analysed various aspects of the trajectories including the speed and acceleration at each point the distance to the nearest obstacle the total duration of vehicle stops and the energy consumption as shown in table iv.
regarding speed and acceleration we compared the speed and acceleration between apollo and f ixdrive as shown in the speed m s and acceleration m s2 columns.
both the average and maximum speeds were examined with the values in the table representing the averages across all scenarios.
overall the a v operated at slower speeds under apollo compared to f ixdrive .
however this does not imply that fixdrive drives more aggressively than apollo.
in fact fixdrive only increased its speed when there were no other vehicles or pedestrians nearby ensuring safe and considerate driving behaviour.
regarding obstacle distance we examinedtable iv performance comparison of f ixdrive and apollo in official scenarios map num driverspeed m s accelerate m s2 obstacle distance m stop time s energy j ave max ave max ave min sunnyvale 108apollo .
.
.
.
.
.
.
.
fixdrive .
.
.
.
.
.
.
.
sanmateo 94apollo .
.
.
.
.
.
.
.
fixdrive .
.
.
.
.
.
.
.
apollo virtual 42apollo .
.
.
.
.
.
.
.
fixdrive .
.
.
.
.
.
.
.
the average and maximum distances to other objects as shown in the obstacle distance m column.
the results indicated that f ixdrive maintained a greater distance from other vehicles despite its higher speed demonstrating both efficiency and safety.
regarding stop time we examined the time that the a v stopped on the road as shown in the stop time s column.
the results indicated that f ixdrive had less stop time than apollo suggesting a smoother driving experience.
regarding energy we provided a rough estimate of the average energy consumption for apollo and f ixdrive .
the energy was calculated using the formula pn t 2m v2 t v2 t where mis the vehicle s mass kg nis the length of the trace and vtis the speed of the a v at time step t. this formula measures the energy consumption based on changes in speed.
f ixdrive consumed more energy than apollo because it generally travelled at higher speeds which involved more frequent acceleration and deceleration processes.
based on these detailed checks we conclude that the driving strategy repairs provided by f ixdrive not only promote smoother driving but also contribute to fewer accidents underscoring its suitability for various common driving scenarios.
table v computational effort required by f ixdrive step s1 s2 s3 s4 s5 s6 s7 s8 trace 329s 351s 281s 127s 61s 63s 395s 529s localisation 187s 200s 167s 156s 134s 155s prompt .22s .24s .21s .23s .16s .17s .16s .
querytime .6s .4s .1s .9s .9s .6s .3s .8s input output overall time 527s 563s 462s 292s 210s 227s 624s 708s cost .
.
.
.
.
.
.
.
rq3 how much effort is required to compute repairs?
to answer this question we present a detailed breakdown of time and token consumption using model chatgpt turbo for fixdrive as shown in table v. the step column lists all necessary steps for f ixdrive to generate driving strategy repairs.
the trace step involves converting a given record into a trace.
the localisation refers to identifying near miss andviolation moments.
the prompt involves automatically generating prompts for the llm input while query denotes querying the llm for a response.
we detail the time consumption for each step all measured in seconds.
for the whole process the most time consuming steps involve two parts trace generation and moment localisation.
trace generation takes a few minutes due to the thousands of time steps within a trace typically about one hundred time steps per second.
moment localisation involves calculating the robustness value multiple times resulting in relatively high time consumption.
however since our method is offline trace generation and moment localisation need to be performed onlyonce per test case making the process efficient for practical use.
for each test case the whole process typically takes around minutes to perform always below minutes on a desktop with 32gb of ram an intel i7 10700k cpu and an rtx 2080ti graphics card which is a manageable effort.
additionally we measure the number of tokens required for querying the llm.
the input and output rows in the table v indicate the average number of input and output response tokens for chatgpt turbo.
the number of tokens including those for images is calculated using chatgpt s official tool .
at the time of experimentation the direct cost for million input prompt tokens was while million output response tokens cost .
this indicates that each driving suggestion costs less than .
making it affordable as shown in the last row of the table.
table vi comparison of f ixdrive and a text only method sceneperformance input token output token cost ours text ours text ours text ours text s1 .
.
s2 .
.
s3 .
.
s4 .
.
s5 .
.
s6 .
.
s7 .
.
s8 .
.
rq4 what is the impact of using images for critical moments instead of text?
fixdrive utilises visualisations of violation and near miss moments as part of its prompt for the mllm.
but what would happen if we described these scenarios using only textual prompts instead?
to explore this question we establish a text only prompt based method as our baseline.
to ensure a fair comparison we keep all other design elements consistent with f ixdrive except that descriptions of the violation and near miss moments are provided solely in text.
we extract key information from records following the lawbreaker methodology crafting detailed descriptions for each variable to ensure clarity.
these descriptions are formatted and refined using chatgpt turbo optimising them for mllm interpretation.
an example prompt is available in our repository for reference .
table vi compares f ixdrive and the text only method in terms of performance input output token usage and cost.
the performance threshold set at based on empirical experimentation discussed in rq1 includes repetitions per scenario.
the performance column shows the proportion of successful driving strategy repairs generated by f ixdrive referred to as ours and the text only method referred to as text .
here success indicates that the a v correctly follows the traffic rule after the repair.
the input output tokens columns display the average input and output token countsper query.
as shown using images significantly enhances performance while reducing costs per query.
images effectively convey spatial details that are challenging to capture in text yet are easily processed by the vision modality.
interestingly image prompts consume fewer input tokens than detailed text descriptions.
moreover text heavy prompts often result in more output tokens suggesting that the mllm is more prone to generating extraneous driving strategy repairs when overloaded with extensive text inputs.
threats to validity.
the inherent randomness of generative models and the limitations of the original ads introduce threats to validity.
first f ixdrive cannot guarantee the effectiveness of every generated suggestion.
to mitigate this we generate driving strategy repairs per case and evaluate them in an a v simulator leveraging fast and cost effective querying for robustness.
some scenarios remain beyond f ixdrive s full control such as rear end collisions where following distance depends on the trailing vehicle.
while risk reduction measures exist complete prevention is challenging.
moreover f ixdrive may propose valid repairs that prove ineffective due to ads design constraints.
for instance apollo s overly cautious behaviour might prevent overtaking even when f ixdrive suggests it.
refining text prompts can help address such issues.
integrating drive into an ads poses challenges but once incorporated it streamlines further modifications enabling efficient system refinement through various drive scripts.
v. r elated work a vs have been the subject of extensive research in recent years leading to significant advancements in their capabilities.
early efforts in a v development focused on improving core functionalities such as perception planning and control .
these areas are critical for enabling a vs to navigate complex environments safely.
however the limitations of a vs compared to human drivers particularly regarding adaptability and decision making in unpredictable scenarios have prompted further research into more intelligent systems.
several approaches have been proposed to address challenges encountered by a vs at runtime.
rule based systems have been used to ensure adherence to safety and traffic regulations.
for example runtime enforcement mechanisms monitor the vehicle s actions to prevent collisions and other unsafe behaviours .
similarly gradient based algorithms such as those in redriver offer real time solutions for handling property specification violations.
while these methods provide valuable safety nets their utility is limited by their narrower focus on specific tasks.
recognising the expertise of human drivers researchers have explored various ways to model and replicate human driving behaviour in a vs. imitation learning has emerged as a prominent technique for training a vs to mimic expert human drivers .
these methods aim to capture the nuanced decision making processes of human drivers to improve a v performance.
however challenges such as limited training data and the complexity of human driving behaviourhave hindered the generalisation of these approaches .
as a result there is a growing interest in developing more advanced systems that can better bridge the gap between human intelligence and a v technology.
the advent of mllms has opened new avenues for enhancing a v intelligence.
mllms with their advanced text and image understanding capabilities offer promising solutions for interpreting and replicating human driving behaviour.
they can provide natural language explanations for their decisions thereby enhancing transparency and trust .
existing research has explored the use of mllms in various components of a vs including perception planning and control .
for instance llm driver abstracts driving scenarios into 2d object level vectors and directly applies the llm output as control commands for the a v system.
gpt driver translates motion planner inputs and outputs into language tokens utilising llms as motion planners for a vs. wen et al.
evaluated the potential of chatgpt as an autonomous driving agent demonstrating its advanced scene understanding and causal reasoning capabilities.
these works primarily employ llms for object perception motion planning and actuation control within a v systems.
despite their potential the inherent delays and uncertainties associated with generative models pose challenges for real time a v operations.
additionally the gap between natural language and control commands remains a significant hurdle.
fixdrive in contrast is a framework that generates driving strategy repairs for a vs. by providing a general offline solution it ensures that mllms can generate general driving suggestions that are directly applicable to a vs. through comprehensive testing in various scenarios f ixdrive has demonstrated its effectiveness in improving a v decisionmaking and adherence to property specifications offering an advancement to the field of autonomous driving.
vi.
c onclusion we have proposed f ixdrive a framework that uses mllms to enhance adss by generating intelligent driving strategy repairs.
f ixdrive identifies critical moments in driving scenarios and generates prompts to ensure mllms produce valid suggestions in a dsl drive for direct application in an ads.
experimental results show that f ixdrive improves ads performance in various challenging scenarios providing efficient and cost effective driving suggestions.
this framework represents a step towards bridging the gap between human expertise and automated driving technology enhancing the adaptability and reliability of a vs. acknowledgment this research is supported by the ministry of education singapore under its academic research fund tier award id moet32020 .
any opinions findings and conclusions or recommendations expressed in this material are those of the author s and do not reflect the views of the ministry of education singapore.