transcode detecting status code mapping errors in large scale systems wensheng tang yikun hu gang fan peisen y ao rongxin wu guangyuan bai pengcheng wang and charles zhang the hong kong university of science and technology hong kong china wtangae yikunh gfan pyao charlesz cse.ust.hk xiamen university china wurongxin xmu.edu.cn tencent inc. china neobai hadeswang tencent.com abstract status code mappings reveal state shifts of a program mapping one status code to another.
due to careless programming or the lack of the system wide knowledge of awhole program developers can make incorrect mappings.
sucherrors are widely spread across modern software some of whichhave even become critical vulnerabilities.
unfortunately existingsolutions merely focus on single status code values while neverconsidering the relationships that is mappings among them.therefore it is imperative to propose an effective method todetect status code mapping errors.
in this paper we propose t ranscode to detect potential status code mapping errors.
it firstly conducts value flow analysisto efficiently and precisely collect candidate status code values that is the integer values which are checked by followingconditional comparisons.
then it aggregates the correlatedstatus codes according to whether they are propagated with thesame variable.
finally t ranscode extracts mappings based on control dependencies and reports the mapping error if onestatus code is mapped to two others of the same kind.
we haveimplemented t ranscode as a prototype system and evaluated it with 5real world software projects each of which possesses in the order of a million lines of code.
the experimental resultsshow that t ranscode is capable of handling large scale systems in both a precise and efficient manner.
furthermore it hasdiscovered 59new errors in the tested projects among which have been fixed by the community.
we also deploy t ranscode in wechat a widely used instant messaging service and havesucceeded in finding real mapping errors in the industrialsettings.
i. i ntroduction many large scale systems use status codes to represent program states.
there are mappings among status codes since a system may describe the same program state at different levelsof abstraction e.g.
disk failure v.s.
io error .
these mappingsare unfortunately error prone.
as an example cve 1records a vulnerability of apache httpd v2.
that is caused by a status code mapping error.
in figure the variable status receives status codes indicating the result of handling a client request.
in line a different code http internal yikun hu and peisen y ao are the corresponding authors.
ap proxy ajp request status ap get brigade 3if status !
apr success return http internal ... a 1int ap xml parse input status ap get brigade 3if status !
apr success result http bad request return result b fig.
.
a cve a status mapping error found in apache httpd v2.
later causes a dos vulnerability.
b a correct error handling example that returns the correct status code.
the status code alias names have beensimplified.
is returned to the caller status code mapping for any status codes that are not apr success .
such mappings make the server to keep re processing incorrect requests2.
as a consequence a malicious client could launch a denial of serviceattack against a server.
worse still these mapping errorsare hard to be detected since they seldom cause immediatesymptoms e.g.
program crashes .
the imperative of thisresearch is to propose a practical solution to detect such statuscode mapping errors.
to achieve this goal we have to address two challenges.
the first challenge is how to efficiently and precisely trackthe propagation status codes c1 .
simply tracking the prop agation of status codes via data flow analysis inevitably in troduces false results because some infeasible paths disallowsome status codes to pass through.
however employing path sensitive analysis would worsen the scalability issue because for every path we need to check whether each status codecan pass through by constraint solving.
owing to the presenceof massive status codes in large scale systems it would becomputationally expensive to solve feasibility queries for eachpath per status code.
for instance even just status codes inthe linux kernel will touch all file systems and storage devicedrivers burdening solvers with a high cost in feasibilityvalidation.
36th ieee acm international conference on automated software engineering ase 36th ieee acm international conference on automated software engineering ase .
ieee .
ase51524.
.
.
ieee the second challenge is how to automatically infer the functionality correlated status codes c2 .
mappings originate from program state shifting represented by status codes reflecting the correlation among them.
therefore such corre lation is essential knowledge for determining mapping errors.unfortunately such knowledge is not explicitly available in aprogram.
in particular as a convention the developer definesfunctionality correlated status codes e.g.
http responsecodes in various data structures where many are undocu mented and might even be distributed across random sourcefiles.
there are also numerous efforts on differentiating error status codes and non error codes that are not applicable forreasoning correlated status codes.
in particular some programsperform checks in the form of if err that coarsely take positive numbers as errors and vice versa.
however existingstudies discard the correlation of status codes e.g.
httpresponse codes are only used to making server responses andconsist of both errors and non errors.
this paper proposes t ranscode that automatically detects status code mapping errors via inconsistencies in mappings.
itfirstly conducts a path sensitive value flow analysis to collectcandidate values of state codes.
a domain inference algorithmis then applied according to whether one function transitivelyreceives status codes from another.
after that t ranscode extracts mappings on control flow graphs and then reinforcesthem with domain information.
at last mapping errors arereported if one status code is inconsistently mapped to twoother correlated relations.
specifically to tackle the challenge of the efficient and precise status code value collection c1 we present aninterpolation guided algorithm that mitigates the costs of frequently invoking solvers.
the insight of the approach is thatsome common infeasible paths could filter many invalid statuscodes.
to tackle the challenge of reasoning correlations ofstatus codes c2 we propose an approach that automaticallyinfers functionality correlated status codes from value flowsof status codes.
we base it on a convention that each functionoutputs status codes of correlated functionalities only.
we evaluated t ranscode on five real world software projects each of which has .
.
million lines of code.the experimental results show that t ranscode can precisely and efficiently obtain status code values during propagationand infer their functionality correlation.
for each project theabove analysis is finished within half an hour.
moreover itfinds new errors in the tested projects of which have been fixed by the developers.
in summary the paper makes the following contributions we introduce t ranscode a novel approach for detecting mapping errors occurring among status codes.
to thebest of our knowledge this work is the first research effortfocusing on status code mappings.
we implement the prototype of t ranscode which is capable of handling real world large scale applicationsprecisely as well as efficiently.
we conduct the experiments on five real world softwareprojects and discovered 59new errors among which have been fixed by the community.
ii.
t ranscode in a nutshell in this section we first use an example to illustrate the incorrect status code mapping problem.
we then present anoverview of our approach to resolving this problem.
figure a is a code snippet that contains a mapping error.
lines are the status codes defined via two types of datastructures.
in function f two mappings are present giving two branches that go to different return statements.
in particu lar upon a status code declined returned by function f0 a new status code http bad request is returned composing a mapping from declined tohttp bad request on lines .
similarly a mapping from declined to http ok can be found on lines .
however these two mappings de facto make an error because the same statuscode ok is mapped to two different http response codes.
hence mapping errors like this and the one in section i not only lead to error mishandling but also compromise theprogram.
how to detect the above mapping error is a non trivial task.
it first requires precisely revealing the propagation ofstatus codes.
for instance the value check at line decideswhether the variable rv will continue to propagate some status code values.
a second imperative is to determine whichstatus codes represent the same sort of functionality becausethe inconsistencies only occur when two destination statuscodes are functionality correlated.
for example http ok and http bad request are highly correlated since they are all http response codes.
the challenging part of this goal ishow to automatically infer such correlations without any priorknowledge because they are mostly project specific heuristics.these heuristics for grouping status codes include naming data structures and values that often vary widely from onecode base to another.
needless to say that providing theknowledge requires expertise and tedious examination of thesource code.
to conquer the beasts we propose a systematic approach namely t ranscode of which a workflow is given in figure .
we begin with collecting the status code returned each function as the initial summaries via a path sensitive value flow analysis iv a .
these summaries are further examinedfor inferring the underlying correlations of status codes that is whether two status codes are of the same kind iv b .
at last aided with the correlations we can demystify mapping errorsby exposing the inconsistencies between status codes map pings where destination status codes are correlated iv c .
as a running example figure b exemplifies how our value flow analysis tracks the propagation of sta tus codes.
specifically function f inherits the status codes from function f1 thus resulting in a summary ok declined done suspended .
the summary is then reduced to ok declined because neither done norsuspended can become a return value as they are obviously filtered by the condition rv done .
to further !
!
.
.
.
!
!
.
.
!
!
.
!
.
.
!
!
.
.
.
!
.
.
fig.
.
a motivation example.
fig.
.
system overview of t ranscode group correlated status codes we unify the overlapping sets of status codes returned by some functions such that twogroups of status codes ok declined done suspended and http ok http bad request are established and clearly distinguishable from one another.
as revealed bycontrol flow paths at lines two status code mappingsare identified as well figure c .
thus the two mappings compose an inconsistency since they both occur betweentwo groups of status codes.
that is the inconsistency oftwo mappings declined mapsto http ok anddeclined mapsto http bad request reveals the culprit of a mapping error.
iii.
p roblem formula tion in this section we first present the fundamental definitions and terminologies and then formulate the mapping errordetection problem.
a. preliminaries we begin with the formal definitions of status codes and their domains definition iii.
status code .
a status code cis a constant integerc zserved as program state indicators.definition iii.
status code domain .
a status codes domain is a set of status codes c c c2 ... c n describing the states of a functionality independent software feature3.f o r simplicity we abbreviate status code domain to domain for short in the rest of the paper.
example iii.
.
consider the program in figure .
http bad request is a status code from http domain d representing a type of http response errors.
the domain is also used to differentiate status codes with the same value butdifferent meanings.
a status code mapping occurs when a status code stops propagating and in the same function a new status code startsto propagate.
formally a mapping instance can be defined interms of status codes and domains definition iii.
status code mapping .
the mapping relation is formalized as a partial function in mathematics between a domain cand a co domain d denoted by c arrowrighttophalfd such that there exists at least one status code c c and another status code d d satisfying c d. in the remaining sections we use an alternative representation to explicitly mark a mapping with its corresponding domain and co domain c c mapsto d d .
example iii.
.
as exemplified in figure there is a mapping declined c mapsto http bad request d at lines where declined is a status code received from a call site to f1at line .
b. problem statement mapping errors originate from inconsistencies.
as illustrated in the former section one status code might be mapped 3it is a formalized definition originated from apple .
4the mapping of a mapping might be inferred across many functions but not specific to local facts within one function.
5the pairing representation always