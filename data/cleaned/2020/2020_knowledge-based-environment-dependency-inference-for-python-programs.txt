knowledge based environment dependency inference for python programs hongjie ye state key lab of computer sciences institute of software chinese academy of sciences university of chinese academy of sciences beijing china yehongjie19 otcaix.iscas.ac.cnwei chen state key lab of computer sciences institute of software chinese academy of sciences university of chinese academy of sciences beijing china wchen otcaix.iscas.ac.cnwensheng dou state key lab of computer sciences institute of software chinese academy of sciences university of chinese academy of sciences beijing china wsdou otcaix.iscas.ac.cn guoquan wu state key lab of computer sciences institute of software chinese academy of sciences university of chinese academy of sciences beijing china gqwu otcaix.iscas.ac.cnjun wei state key lab of computer sciences institute of software chinese academy of sciences university of chinese academy of sciences beijing china wj otcaix.iscas.ac.cn abstract besides third party packages the python interpreter and system libraries are also critical dependencies of a python program.
in our empirical study programs are only compatible with specific python interpreter versions and programs require specificsystem libraries.
however existing techniques mainly focus on inferring third party package dependencies.
therefore they can lack other necessary dependencies and violate version constraints thus resulting in program build failures and runtime errors.
thispaperproposesaknowledge basedtechniquenamedpyego whichcanautomaticallyinferdependenciesofthird partypackages the python interpreter and system libraries at compatible versions for python programs.
we first construct the dependency knowledge graph pykg which can portray the relations and constraints among third party packages the python interpreter and system libraries.then byqueryingpykgwithextractedprogramfeatures pyegoconstructsaprogram relatedsub graphwithdependency candidatesofthethreetypes.itfinallyoutputsthelatestcompatible dependencyversionsbysolvingconstraintsinthesub graph.we evaluate pyegoon 891single filepython gists open source wei chen is the corresponding author.
weichen wenshengdouandguoquanwuarealsoaffiliatedwithnanjinginstitute of software technology and university of chinese academy of sciences nanjing china.
permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed forprofitorcommercialadvantageandthatcopiesbearthisnoticeandthefullcitation on the first page.
copyrights for components of this work owned by others than acmmustbehonored.abstractingwithcreditispermitted.tocopyotherwise orrepublish topostonserversortoredistributetolists requirespriorspecificpermissionand ora fee.
request permissions from permissions acm.org.
icse may pittsburgh pa usa association for computing machinery.
acm isbn ... .
projects and jupyter notebooks.
the experimental resultsshowthatpyegoachievesbetteraccuracy .2xto3.5xhigher than the state of the art approaches.
ccs concepts softwareanditsengineering softwarelibrariesandrepositories software maintenance tools maintaining software keywords python environment dependency inference version constraint knowledge graph acm reference format hongjie ye wei chen wensheng dou guoquan wu and jun wei.
.
knowledge based environment dependency inference for python programs.in 44thinternationalconferenceonsoftwareengineering icse may pittsburgh pa usa.
acm new york ny usa pages.
introduction python programs depend on third party packages i.e.
python libraries the python interpreter and system libraries.
missing andincompatibleenvironmentdependenciescanresultinprogram build failures and runtime errors.
developers need to infer environment dependencies for python programs due to the following reasons.
first many open sourcepython programs e.g.
python gists and jupyter notebooks in github do not explicitly declare their dependencies or miss some dependencies .
second python libraries are usually frequentlyupdated maybecomedeprecated orareremoveddueto security issues .
third a program migrating from one environmenttoanothermayfailduetooverlookingrequiredsystem libraries which are usually not explicitly documented.
besidesthird partypackages pythonprogramsalsodependon specificsystemlibrariesandthepythoninterpreter.inourempirical ieee acm 44th international conference on software engineering icse authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
icse may pittsburgh pa usa hongjie ye wei chen wensheng dou guoquan wu and jun wei study on gists sampled from hg2.9k we find that gists suffer from runtime errors due to incompatible python interpreter versions and24gistsfailduetomissingsystemlibraries.despite theimportanceofsystemlibraryandpythoninterpreterdependencies we find that only half of our investigated programs declare compatiblepythonversions andonlyaquarterofprojectsdocument dependent system libraries.
therefore an effective approach isstillrequiredto digandbuildthefullrequireddependencies .
some studies have tried to address python program environment dependency issues.
the prior work infers third party packages and system libraries for single file python programs but they only recommend the latest package versions without concerning version constraints.
snifferdog infers dependent python libraries for jupyter notebooks based on api usage analysis butit neglects system libraries and the python interpreter.
pipreqs apopularopen sourcetool onlyfocusesonthird partypackages and does not pay attention to system libraries and the python interpreter.
thispaperproposesaknowledge basedtechniquenamedpyego which can automatically infer dependencies at compatible versions forpythonprograms.pyegoconsidersdependenciesofthird party packages the python interpreter and system libraries.
based on a thoroughanalysisoftheknowledgerequiredforenvironmentdependencyinferences wefirstconstructthedependencyknowledge graph pykg which can portray the three types of dependencies andtheir relations.then facilitatedwith pykg pyegoinfersenvironment dependencies for a python program via static program analysis and constraint solving.
it extracts program features and takesthemasinputstoquerypykgforthecandidateversionsof possibledependencies.thedependencycandidatesformaprogram relateddependencysub graphwiththeirinterrelations.pyegofurtherinfersthelatestcompatibledependencyversionswithinthe sub graph by solving constraints among the candidates.
in essence pyego is an exploratory step towards automating dependency inferences for python program.
we evaluate pyego on hg2.9k containing singlefile python programs by resolving importerrors with inferred environment dependencies.
in addition we evaluate pyego on morecomplexpythonprojectsand4 836jupyternotebooks.overall pyego achieves .
and .
accuracy respectively which is .2x to .5x higher than the state of the art approaches.
in summary this work makes the following contributions.
weproposeadependencyknowledgegraphanditsconstruction approach.
pykg can portray the relations among third party packages the python interpreter and system libraries.
we propose a knowledge based environment dependency in ference technique pyego which regards constraints among a programanditsdependenciesandcaninferthelatestcompatible dependency versions of three dependency types i.e.
third party packages the python interpreter and system libraries.
the evaluations on hg2.9k open source projects and jupyternotebooksrevealthatpyegoismoreeffectivethanstateof the art approaches.
motivation in this section we perform an empirical study for investigatingthe prevalence of environment dependency issues.
then we use an example to analyze the challenges of environment dependency inference for python programs.
finally we present an overview of our approach addressing the challenges.
.
empirical study oursmall scaleempiricalstudyconcentratesondependenciesissuesrelatingtothepythoninterpreterandsystemlibrariesbecause the prior work has confirmed that python packages are indispensabletoprogrambuildsandexecutions.thisempiricalstudy is dedicated to answering the following two research questions.
rq1 to what extent do open source python projects provide documentedenvironmentdependencies?whatkindsofdependencies are documented?
rq2 besides python packages do the python interpreter and system libraries affect python program builds and executions seriously?
toanswerrq1 werandomlysample100popularpythonprojects ongithubwithmorethan1000stars.weidentifytheirdependency declarationfilesandinvestigatewhatkindsofdependenciesthey document.wefindthat 79outof100projectsdeclarethird party packagedependencies 51projectsdeclarecompatiblepython interpreterversions and only27projectsdeclaresystemlibrary dependencies.inaddition we categorize dependencydeclaration files.
requirements.txt is the most popular declaration file of100projects buttheyonlyrecordthird partypackagedependencies.
dockerfile pipfiles and conda yaml files can record dependencies of the python interpreter and system libraries but only projects use declaration files of these types.
findings most open source python projects document their third partypackagesdependencies.however onlyhalfoftheinvestigatedprojectsdeclaretheircompatiblepythonversions and evenworse onlyaquarterofprojectsdeclaresystemlibrarydependencies.
moreover although requirements.txt is most prevalent they do not document the dependencies of the python interpreter and system libraries.
toanswerrq2 werandomlysample100gistsfromhg2.9k .
wemanuallyconstructruntimeenvironmentsforthesegistsand investigate the encountered problems.
only out of gists can executesuccessfullybysimplyinstallingthethird partydependentpackages.fortheremaining58gists 34gistsencounterruntimeerrorsduetoincompatiblepythonversionsbecause19and15gists are only compatible with python2 and python3 respectively.
gists fail to build or execute due to missing system libraries.in addition we investigate the top voted python questions in stack overflow.
we find that of questions are relevant to incompatible python interpreter versions and of questions arerelevanttothird partypackageinstallationfailurescausedby missing some system libraries.
findings the python interpreter and system libraries are critical dependencies of python programs.
unfortunately more than half of the gists experience build failures and execution errors due to incompatible python versions or missing system libraries.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
knowledge based environment dependency inference for python programs icse may pittsburgh pa usa figure an example code snippet and its dependencies.
insummary besidesthird partypackages thepythoninterpreter and system libraries are also indispensable but few techniques concern them in practice.
.
motivating example figure1showsapythoncodesnippetofagithubproject animplementation of superglue network1.
the code snippet belongs todemo superglue.py superglue forshort runningsuperpoint and superglue features matching an anchor image with live images .table1lists superglue sfeasibledependencies where the expressions in brackets e.g.
greaterorequalslant3.
are version constraints.
superglue s dependencies include third partypackage.third partypackagesarethebasicinstallationunitsinsteadoftheircontainedmodules.therefore torch opencv python and matplotlib aredirect dependencies as they containthedirectlyusedtop levelmodules torch cv2 matplotlib line3 andthesecond levelmodule cm.besides numpy pillow pyyamlaretransitivedependencies sincethedirectdependencies may use them.
systemlibrary.somethird partypackagesarepartiallyimplemented in c and the c code may depend on system libraries.
libopencv contrib is a system level dependency as the thirdparty package opencv python depends on it.
thepythoninterpreter.thepythoninterpreterisnecessaryfor providingapythonenvironmentandstandardmodules.
pathlib andargparse line are standard modules installed with the python interpreter and pathis a second level module in pathlib.
localmodule.a codesnippetmayuse othermodulesimplemented in a program itself such as models line implemented inanotherfile models.py .however wedonotregardlocalmodules as they are self contained resources.
besides theimportedmodulesimplyversionconstraintsonsuch dependencies including pathlib is introduced since python .
.
third partypackageversionconstraint.
matplotlib .
.
is thelatestversion anditrequiresthetransitivedependency pillow greaterorequalslant6.
.
.moreover matplotlib opencv python andtorchdepend onnumpysimultaneously and the latest versions of the first two packagesrestrict numpylaterthan1.16and1.
.
respectively.thus numpy greaterorequalslant1.
.
is a version constraint restricting numpycompatible with all the other third party packages using it.
challenges .thisexampleindicatesthatinferringdependencies for a python program has several difficulties.
a python package includes at least one module and the namesofthepackageandthemodulecanbedifferent whichmakes developershavetoknowtowhatpackagestheimportedmodules belong when reusing open source code.
system libraries are necessary transitive dependencies used bytheimportedmodules butfewdocumentsrecordthedependent relationsbetweenthird partypackagesandsystemlibraries.the priorworkfindsmissedsystemlibrariesbyiterativelyanalyzing runtime error logs with expensive costs.
the differences in contained modules would restrict versions ofadependentthird partypackage.therefore additionalefforts have to be taken to identify the compatible package versions.
theimportedstandardmodulesandleveragedsyntaxfeatures implicitly restrict compatible python interpreter versions but it is not easy to uncover such constraints in the target program code.
complexinterdependentrelationsanddependencyversion constraintsamongaprogramanditsdependenciesmayresultin versionconflicts .therefore adependencyatthelatestversion maybeincompatible andinconsequence thelatestcompatible versionofeachdependencyhastobefiguredout.inotherwords weshouldfollowtheoptimizationprincipleof usingdependencies asnewaspossible whenmultiplecompatibleversionsexistbecause installingthelatestversionsfollows pip sworkingmechanism and may fix bugs and security vulnerabilities in prior versions .
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
icse may pittsburgh pa usa hongjie ye wei chen wensheng dou guoquan wu and jun wei table environment dependencies of the example code dependent resource version python .
greaterorequalslant3.
opencv python .
.
.
matplotlib .
.
torch .
.
numpy .
.
greaterorequalslant1.
.
pillow .
.
greaterorequalslant6.
.
libopencv contrib3.
.
.
dfsg 4ubuntu0.
pyyamlis not a necessary transitive dependency as thedirect dependency torch .
.
no longer uses it figure knowledge graph model limitations of the existing work .
the state of the art approaches pipreqs dockerizeme andsnifferdog mainly focusoninferringthird partypackagedependencies.weexecute pipreqs and dockerizeme to infer dependencies for superglue.
without regarding the version constraint of the python interpreter dockerizeme takes python2.
as the default interpreter and fails with importerror no module named pathlib .
this is because the standard module is introduced since python .
.
although we use python .
or later dockerizeme still fails with another importerror as itcannot identify thedependency between opencv python andlibopencv contrib3.
.
pipreqsdirectlyusesthelocalpythonenvironmentandwould alsofail withthe importerror ifthe pythonversion isolder than .
.besides pipreqspaysnoattentiontodependentsystemlibraries and hence it still fails even if we use a compatible python version.
snifferdog infers dependencies forjupyter notebooks.
notably wecannotsuccessfullyexecutesnifferdogsinceitspublicrepository doesnotofferthecriticalcomponentapi bank.although snifferdog analyzes modules functions and classes in third party packages itslimitationsare notregardingpythonversionconstraint and dependent system libraries and simply taking the latest package versions containing used apis as dependencies.
.
our approach overview as a result much knowledge is required for dependency inferences.
syntax features and standard modules of each python interpreter version are required for identifying compatible python versions.
modulesineachthird partypackageversionshould beknowntodeterminewhatpackageversionsarecompatible.
dependenciesbetweenpythonpackagesandsystemlibrariesarerequiredforinstallingdependentsystemlibrariesproactively.
versionconstraintsamongthird partypackagesandbetween the python interpreter and third party packages are required to avoid incompatibilities and dependency conflicts dcs .
wearemotivatedtodesignaknowledge basedandconstraintawaretechniquetoinferenvironmentdependenciesatthelatest compatible versions.
the technique comprises two main parts i.e.
a knowledge graph offering knowledge relevant to the three types ofdependenciesandatoolinferringpythonprogramdependencies by solving version constraints.
in the first part we propose a dependency knowledge graph model to portray the relations among third party packages the pythoninterpreter systemlibraries andotherrelatedentities.then we identify multiple sources from which we acquire data and informationrelatingtotherequiredknowledge.finally weextract knowledge from the data with several methods and construct a dependency knowledge graph pykg.
in the second part we design a technique pyego to infer dependencies for python programs.
given a program pyego extracts its syntaxandmodulefeaturesandgetstheprogram relateddependencycandidatesfrompykg.afterthat weproposedependency constraintsaccordingtothedependencyinferencerequirements andpyegoinfersfinaldependenciesfromthecandidatesbysolving dependency constraints.
knowledge graph construction we structure the required knowledge as a dependency knowledge graph whose model is illustrated in figure .
dependency knowledge graph is defined as g v e where v ni i greaterorequalslant0 ni f c lt ls ms mt isasetofvertices relevant to dependencies meaning a vertex can be the python interpreter c athird party package lt asystem library ls a third partymodule mt astandardmodule ms andasyntaxfeature f .
e ej j greaterorequalslant0 ej dep asso is a set of edges of two relationtypes i.e.
depend on andassociated with arerepresented by symbols and respectively.
table lists the symbols used in this definition.
ontheonehand depend on relationsdescribeinter dependencies among the three types of dependencies.
in particular a third party package can depend on other packages the python interpreter andsystemlibraries andasystemlibrarymaydependonotherlibraries.
in addition the dependent relations between such dependency versions also specify the version constraints among them.
on the other hand associated with relations describe features of third party packages and the python interpreter.
thus the knowledge graph model characterizes a third party package version withthethird partymodulestheycontain.italsocharacterizesaspecificpythonversionwithitsstandardmodulesandthesupportedsyntax features.
.
data source table3liststhesourcesfromwhichwedirectlyacquiredataand information where pypi is the world class python library repository hosting 300k third party open source packages and from which we crawl the most popular ones and their inter dependent relations authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
knowledge based environment dependency inference for python programs icse may pittsburgh pa usa table symbols in dependency knowledge graph model symbol description cpython interpreter ltthird party package lssystem library flanguage syntax feature msstandard module mtthird party module depend on relationship associated with relationship table data sources of dependency knowledge source acquired data information pypi top popular third party packages at each version libraries.io popularity measured by sourceranks of third party packages apt information of system libraries python docs syntax features of python versions python environmentspython versions and their standard modules libraries.io provides sourceranks thatmeasurethepopularity of open source python libraries apt is the official system software repository of debian family operating systems provisioning system libraries pythonofficialwebsite offerspythoninterpreterversions and from which we download and install python at various versions.weanalyzeinstalledpythonenvironmentsandextractthe standard modules onlinepythondocuments providenewfeatures userguidance and other information on each python version.
notethatwesampledatainsteadofcrawlingalltomakeatradeoff between the expensive cost of exhaustively acquiring data and adequate verification and demonstration of our work.
table also lists what data and information we acquire from the data sources.
.
knowledge extraction weproposeseveralmethodsforextractingknowledge particularly syntaxfeatures dependencyversionconstraintsofthird partypackages and dependencies between third party packages and system libraries from the obtained data.
.
.
syntax feature extraction and representation.
syntaxfeaturessupportedbyeachpythoninterpreterversionarescatteredin onlinedocumentsandusuallydescribedinnaturallanguage and hence how to extract and present such knowledge is concerned.
wenoticethatthe what snew documentofeachpythonversion explains new features compared with the previous version such as what s new in python .
.
therefore we extract context free syntax features from the new features section in each feature document because such features can be directly recognized in atarget program withoutneeding to analyze program contextsand other factors.for example positional only parameters pep is a context free syntax feature can be recognized when a symbol appears like a parameter in a function definition based on the static analysis.
conversely dictionary merge update operators pep isnotasuchfeatureasthe context i.e.
operandtypes mustbeconcerned.besides otherfeatures like newparser pep irrelevanttosourcecodearealsodiscarded.
in this way we systematically investigate feature documents of sixpythonversionsandrecognize26context freesyntaxfeatures syntax features for short hereafter .
c v f1 f2 denotes the syntax features supported by the python interpreter at version v or a version range .
furthermore toautomatesyntaxfeaturerecognitionforatarget python program wemanually transform19 outof the26 extracted syntaxfeaturesintoregularexpressions.forexample theknowledgeofthefeature positional onlyparameters introducedsince python .
is represented as c greaterorequalslant3.
def s .
?
.
notably we do not present all extracted syntax features due to space limitations and they are available in our released knowledge graph.
.
.
version constraint extraction and module identification.
a third party package s metadata usually provides information on contained third party modules compatible python versions and version constraints on its dep endent packages.
ho wever such information is scatteredin several metadata files and evenworse some information is incomplete or absent.
forathird partypackageversion lt v weextractitscompatible python versions and dependent third party packages by analyzing its metadata in the files metadata and requirements.txt .
the obtainedinformationisrepresentedas lt v c vc andlt v lt1 v1 lt2 v2 wherec vc is compatible python versions and lt1 v1 lt2 v2 is a set of dependent package versions.
thedifferencesincontainedthird partymodules particularly lower levelmodules areimportantfordistinguishingversionsof a package.
however the file top level.txt in a package only records its top level modules.
therefore we traverse each packagetop downtogetitsmodulesateachlevel.theinformationis represented as lt v mt1 mt2 .
.
.
dependency inference between third party packages and system libraries.
as aforementioned dependencies between a package and its system libraries are absent.
we mine such dependency knowledge with two methods i.e.
a association mining based dependency inference and b similarity based dependency inference.
since the former is similar to that proposed in prior work we only elaborate on the latter below.
we observe that some pip installable third party packages have similarapt installable distributions with slight differences in their names and structures.
for example python matplotlib a naptinstallable package is similar to the package matplotlib onpypi as their names are similar and they both contain the same top level modules matplotlib pylab and mpl toolkits .
moreover if anapt installable package depends on a set of system libraries ls1 ls2 the similar pip installable one is likely depending on authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
icse may pittsburgh pa usa hongjie ye wei chen wensheng dou guoquan wu and jun wei them too.thus wecangetdependentsystemlibrariesofan aptinstallable packagewiththecommand apt cache depends .and then we search for the similar pip installable package lt o ft h e apt installable one l prime t by measuring the comprehensive similarity equation1 betweentheirnames equation2 andcontained top level modules equation .
ltandl prime tare similar only if their similarity exceeds a threshold set with .
in practice.
in equation2 lcstr returnsthelongestcommonsubstringoftheirnames andmax returns the max length of their names.
in equation module returns the top level module set of a package.
s lt l prime t sn lt l prime t sm lt l prime t sn lt l prime t lcstr lt l prime t max lt l prime t sm lt l prime t module lt module l prime t module lt module l prime t the inferred dependency knowledge is represented as lt ls1 ls2 .
for instance opencv python libopencv contrib3.
means the pip installable package opencv python dependsonthe system library libopencv contrib3.
.
.
knowledgegraphconstructionandupdate we organize extracted knowledge as a knowledge graph named pykg which is stored in neo4j a popular graph database.
at the time of writing pykg contains about thousand nodes and .
million relations.
pykgisextensibleandevolvable.ontheonehand pykgcan update periodically as most data acquisition and knowledge extraction are automated.
for each existed package pykg re accesses pypiandcomparesthelocalandtheonlineversions.ifthelatest versionisnotfetched pykgautomaticallycrawlsit analyzesits metadata extracts corresponding knowledge and makes a synchronization.
in practice pykg synchronizes every threemonths and each synchronization takes about .
days.
on the other hand pykgcanincrementinasimilarwayforcrawlingnewpackages and extracting relevant knowledge.
environment dependency inference figure3depictspyego sworkflow.thefirststepextractsimported modules and used syntax features of a target program via static analysis.
next pyego gets dependency candidates by querying pykg with extracted modules and syntax features.
finally pyego outputs the inferred dependencies at the latest compatible versions based on constraint solving.
.
program feature extraction foratargetprogram p pm m greaterorequalslant1 comprisingasetof .pyfiles pyego extracts p s features i.e.
used syntax features imported third party modules and standard modules.
for each python file pi lessorequalslanti lessorequalslantm inp pyego matches the code against each regular expression inpykg that represents a syntax feature and groups identified syntax features in a set s pi .
pyegoparses piintoanabstractsyntaxtree ast andextracts itsusedmodulesfrom importstatements.next inassistance with pykg pyego filters out local modules and groups the remainingonesinastandardmoduleset ms pi andathirdparty module set mt pi respectively.
inthisway pyegoiterativelyanalyzesall .pyfilesandintegrates theirfeaturesas f p s mt ms wheres mtandmsdenote p ssyntaxfeatureset third partymoduleset andstandardmodule set respectively.
for example superglue s sec.
.
feature set includes s meaning no special syntax feature is identified ms ar parse pathlib pathlib.path and mt cv2 torch matplotlib matplotlib .cm .
.
dependency candidate identification pyego identifies p s dependency candidates by querying pykg withf p .
python interpretercandidates .
pykg returns all python versionsnotonlysupportingallsyntaxfeaturesin f p .sbutalsocontainingallstandardmodulesin f p .msasaninterpretercandidate setc p cv1 cv2 .thus c p impliespythoninterpreter version constraint of p. for example the usage of standard module pathlib makes superglue compatible with python .
or later as the module is introducedsincepython3.
.therefore itscandidatepythonversion set is c super lue cv .
lessorequalslantv lessorequalslant3.
the latest python version is .
.
third party package candidates .
for each third party modulemtinf p .mt pykgreturnsallthird partypackageversions containingthemodule i.e.
lt mt .inthisway allpossiblethirdparty packages directly used in pare grouped in lt p .
on the otherhand pyegoconstructs l prime t p thatcomprisesalltransitive dependent third party packages of p. thisstepconcernsthefollowingcaseandheuristicallyfiltersthe initialthird partypackagecandidates.foramodulesimultaneouslycontainedinseveraldifferentthird partypackages weheuristically select the most popular package instead of all for the followingreasons packages containing the same modules may conflict withoneanother and takingallthepackagesasdependency candidateswouldincreasethetimecostofthesubsequentdependencyinference.forexample cv2isamodulein opencv python opencv python headless and opencv contrib python .
thus we select opencv python as the candidate due to its popularity withsourcerank in libraries.io .
system library candidates .pykg returnssystem librarieson which any element in lt p orl prime t p depends.
pyego takes all returned system libraries as p s dependency candidates of system libraries i.e.
ls p .
targetprogramcentricdependencygraph .p sdependency candidates form a subgraph of pykg g prime v prime e prime where the vertices in v primeare dependency versions in c p lt p l prime t p ls p e primecontains dependent relations among them.
without loss of generality we denote a dependency nat version vasnv whose dependency candidates in g primeisdep nv .
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
knowledge based environment dependency inference for python programs icse may pittsburgh pa usa figure pyego s workflow of inferring environment dependencies for a python program.
figure a part of superglue s dependency graph.
figure4showsapartof superglue sdependencygraphformed byitsdependencycandidates.forsimplicity eachvertexisannotated with a symbol plus a number representing a specific version.
for example the dependencies of vertex ma34 i.e.
matplotlib .
.
are represented as dep ma34 py39 pl82 np20 .
.
dependency inference as aforementioned a package s latest version is preferred but it is not always feasible due to dcs and version constraint violations.
therefore several requirements in inferring p s dependencies from the candidate set are summarized i.e.
the inferred dependencies must be compatible with one another necessary and as new as possible.
to this end pyego infers dependencies by solving dependency constraints with an optimization objective.
dependency constraints .
suppose g v e g g prime i s the graph formed by p s final inferred dependencies.
it should satisfy the following constraints.
existenceconstraint restricts gmustcontainthepythoninterpreter and all p s directly dependent third party packages i.e.
nv1 i c p lt p nv2 j g. v ni nj.for example in figure python opencv python matplotlib andtorchare dependencies must be installed.
in contrast pyyaml is not necessary if torch .
.
th18 is chosen.
uniqueconstraint restricts gtocontainonlyoneversionof each dependency n i.e.
nv1 i nv2 j g. v ni nequalnj.
for example in figure one can choose either torch .
.
or torch .
.
th01 but cannot choose both at the same time.
version constraint restricts each dependency nvin gmust be compatible with all the other resources depending on it i.e.
nv1 i g. v nv2 j dep nv1 i nv3 k g. v nj nk nv3 k dep nv1 i .
for example in figure one cannot choose matplotlib .
.
andpython .
py35 atthesametime since matplotlib .
.
is not compatible with python .
.
optimization objective .
we harmonize the latter two requirements above into an optimization objective.
pyego sorts all versions of each dependency ning primefrom the oldest to the latest as a vectorver n nv1 nv2 nv0 .
notably nv0is avirtual versiondenotingnoversionsof nareselected.therefore theoptimizationobjectiveisrepresentedasequation4 where index n denotes the index of the selected version in ver n .
for example index n if the oldest version in ver n is selected.
nis the set of all dependency candidates not their versions of p. o max n nindex n to maximize o pyego first tries to select nv0 i.e.
not install any version of n and ifnis necessary or a constraint violation occurs it replaces nv0with the latest version of nsatisfying all its relevant version constraints.
to this end pyego exploits thefamous smt solver z3 to obtain the optimized solution i.e.
the final inferred environment dependencies such as the inference result of the example listed in table .
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
icse may pittsburgh pa usa hongjie ye wei chen wensheng dou guoquan wu and jun wei evaluation toevaluatetheeffectivenessandefficiencyof pyego weanswer the follow research questions rqs .
rq3 howeffectiveispyegoininferringdependenciesforpython programs?
rq4 doespyegooutperform state of the art approaches?how better is pyego than others?
rq5 howefficientispyegoininferringdependenciesforpython programs?
forrq3 pyegoinfersenvironmentdependenciesforpython programs in the dataset hg2.9k complex python projects collectedfromgithub and4 836jupyternotebooks.weevaluate dependency inference results in terms of accuracy andaverage inferred dependencies.
forrq4 weexecutepipreqs anddockerizeme withthe datasetshg2.9k the100collectedprojectsandthe4 836jupyter notebooksandcomparetheirresultswiththoseof pyego.notably snifferdog isanotherrelatedwork butwecannotreplicateits experimentandquantitativelycompareitwithpyegoasitisnot executable due to the lack of critical component api bank.
forrq5 we compare pyego with pipreqs and dockerizeme in terms ofaverage execution time.
.
methodology .
.
datasets.
threedatasetsareusedinevaluations i.e.
hg2.9k 100open sourcepythonprojects and4 836jupyternotebooks.
hg2.9k contains python gists i.e.
single file python programsfromgithubgistservice experiencing importerrorshard to fix in the prior work .
inaddition followingthecriterialistedbelow wecreateadataset sdcontaining100real worldopen sourcepythonprojectscollected from github.
executable i.e.
runningwithouterrorsonceallthedependencies are configured well documented i.e.
document their dependencies explicitly popular i.e.
having at least hundreds of stars diverse i.e.
varying in forms and application types.
the projects in sd arethird partypackages applications and tutorials belonging to machine deep learning internet development database security computer vision and natural language processing a project can belong to multiple types .
on average these projects contain python files with .py extensions lines of code loc and import statements.
besides wecreateadatasetjpdcontaining4 836jupyternotebooks.
snifferdog provides a list of notebooks in its repositories and we try to download the notebooks and convert them into python files.
notebooks fail in download or conversion andwetaketherest4 836notebooksasthefinaldataset.
notably we comment out magic commands contained in the notebooks as they cannot be executed by cpython interpreter.
.
.
evaluation metrics.
equation measures the effectiveness of dependency inference where inf pro rams is the number of programs whose environment dependencies are successfully inferredwithinadataset.followingthecriterioninthepriorwork an inference is considered successful only if the program does not encounter importerrors anymore.
in addition since the projects in sd record dependencies originally we further compare their inference results with the documented dependencies to check whethertheinferredenvironmentdependenciesaresemantically correct.
accuracy inf pro rams totalpro rams .
.
experimental environment.
ourexperimentsareperformed onacomputerrunning ubuntu .
lts with8 core3.50ghz cpu and gb ram.
.
answer to rq3 experimental result .
table shows the dependency inference results of pyego for programs in the three datasets.
pyegosuccessfullyinfersdependenciesfor1 334outof2 .
gistsinhg2.9k .41third partypackagesand2.31system librariespergistonaverage.amongthe1 334gists pyegoinfers python .
for gists python .
for gists and python .
for gists respectively.
pyego successfully infers dependencies for out of projects in sd .
dependencies .
third party packages and .
system libraries per project on average.
the accuracy on sdissignificantlyhigherthanthatonhg2.9ksinceeachprojectinsdiscompleteandexecutableoriginally.therefore theywouldnotencounter importerrors causedbymissinglocalmodules.among the projects pyego infers python .
for projects python2.
for projects and other python versions for projects.
we inspect theinferenceresults ofthe62projectsand findthat4resultscontainlater dependencyversions butthey donotchange thetarget projects executionsemanticsastheusedapisintheimportedthirdparty package versions do not change.
for example jd assistant declares it depends on pycryptodome .
.
while pyego infers version .
.
.
we inspect the change log of pycryptodome and confirm the used apis i.e.
crypto.publickey.rsa and crypto.cipher.pkcs1 v1 5 do not change since .
.
.
thus we consider the inferred result is correct.
pyegosuccessfullyinfersdependenciesfor2 945outof4 .
notebooksinjpd .51dependencies .30third partypackages and .
system libraries per project on average.
among the notebooks pyego infers python3.
for notebooks python2.
for gists and other python versions for notebooks.
failurerootcausesanalysis .weinspectprogramsfailingwith incorrectdependencyinferenceresultsandanalyzetherootcauses.
overall the root causes are classified into several categories.
missingdependencies.first someprogramsfailduetomissing third partypackages.takethecodesnippetbelowasanexample pyegoinfers numpy .
.
andscipy .
.
butfailstofigure outwhatpackagecontainsthemodule sparsesvd astheknowledge is absent.
import scipy.sparse import numpy import sparsesvd second some programs fail to install third party packages because of missing required system libraries.
for example installing authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
knowledge based environment dependency inference for python programs icse may pittsburgh pa usa table dependency inference results of pyego and two state of the art approaches tool acc adp atp at sec.
hg2.9kpyego .
.
.
.
pipreqs .
.
.
.
dockerizeme .
.
.
.
sdpyego .
.
.
.
pipreqs .
.
.
.
dockerizeme .
.
.
.
jpdpyego .
.
.
.
pipreqs .
.
.
.
dockerizeme .
.
.
.
acc is the dependency inference accuracy adp is the average inferred dependent packages including system libraries and third party packages atp is the average inferred dependent third party packages at is the average execution time.
dbus python without the system library libdbus dev leads to error package requirements dubs .
were not met .
pyegofailstofigureoutonwhatsystemlibrariesthethird party package depends.
third some programs fail due to missing extradependencies.
some third party packages are installed optionally pep i.e.
theywouldnotbeautomaticallyinstalledunlessaskingforthem explicitly.
for example xlrdis anextradependency of pandas which would not be automatically installed with pip install pandas .executingfunction pandas.read excel without xlrd the program would encounter an import error i.e.
importerror missing optional dependency xlrd ... .
incompatibledependencyversions.first someprogramsfail due to incompatible dependency versions induced by incorrect version constraints documented in third party packages metadata.
forexample pyarrow .
.
specifiesitiscompatiblewith python .
.
however it is incompatible with python .
and would fail with installing build dependencies ... error.
.
second some programs fail due to incompatible classes or functions in third party package versions.
for example the function numpy.rank is removedsince numpy .
.
unfortunately pyego cannotidentifysuchanincompatiblechangeasitfocusesonfeatures at module granularity.
incompatible operating systems.
some programs fail due to their dependent third party packages are os specific.
for example pyobjc core isonlycompatiblewith os x andinstallingitinlinux would fail with error pyobjc requires macos to build.
conditional dependency.
a program conditionally declares its dependencies on standard modules specific to python2 and python3 intry catch orif else code blocks for being compatible with both python versions.
in the code snippet below cpickle andpicklearestandardmodulesspecificto python2andpython3 respectively.
pyego does not consider the importstatements context and cannot find a python version containing both modules.
1try import cpickle as pickle 3except importerror import pickle5.
answer to rq4 table4listsalldependencyinferenceresultsofthethreeapproaches including pyego .
since pipreqs and dockerizeme do not consider python versions we config them with python .
for hg2.9k following the original experimental setting of dockerizeme and config them with python .
the version most projects compat ible with for sd and jpd.
notably our replicated evaluation ondockerizeme with hg2.9k is slightly different from the original i.e.
itsuccessfully infersdependencies for888 insteadof 892gists.
thereasonisthatsomepackagesthatdockerizemerecordshave beenremovedfrom pypiandcannotbe downloadedandinstalled anymore.
overall pyego reaches the highest accuracy on both datasets.
in particular pyego saccuracyisabout3.5x .4xand0.2xhigherthanthatof pipreqs on the datasets hg2.9k sd and jpd respectively pyego saccuracyisabout0.5x .7xand0.3xhigherthanthatof dockerizeme on the datasets hg2.9k sd and jpd respectively.
in comparison dockerizeme reaches the lowest accuracy on sd since it does notconsiderthehierarchicalstructureofapythonprojectand only analyzes .py files at the top level.
pipreqs reaches the lowest accuracy on hg2.9k as it does not concern system libraries and python version constraints.
thereasons of pyego outperforming theother approachesare summarized as follows.
finer grained module analysis .
pipreqs and dockerizeme only focus on top level modules while pyego analyzes lowerlevelmodules inaddition.in comparison lower levelmodules are usually distinctive features for third party package versions and pythonversions.inthecodesnippetbelow urllibexistsinboth python2 and but the second level module urllib.parse is only in python3.
on the other hand dockerizeme and pipreqs infer the codesnippetdependson google api python client throughthe top level module oauth2client .
however only versions between .0and1.2ofthepackagecontain oauth2client.appengine .consequently dockerizeme and pipreqs recommend the incompatible latest version .
and conversely pyego infers the package at version .
and solves the importerror.
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
icse may pittsburgh pa usa hongjie ye wei chen wensheng dou guoquan wu and jun wei table pairwise comparison results programs adp atp at sec.
hg2.9k pyego .
.
.
hg2.9k pipreqs .
.
.
hg2.9k pyego .
.
.
hg2.9k dockerizeme .
.
.
sd pyego .
.
.
sd pipreqs .
.
.
sd pyego .
.
.
sd dockerizeme .
.
.
jpd pyego .
.
.
jpd pipreqs .
.
.
jpd pyego .
.
.
jpd dockerizeme .
.
.
the top two sub datasets are gists in hg2.9k whose dependencies are inferred byboth pyego and pipreqs and both pyego and dockerizeme.the middle two sub datasetsare projects in sdwhosedependenciesareinferredbybothpyegoandpipreqs andbothpyegoanddockerizeme.thebottomtwosub datasets are projects in jpd whose dependencies are inferred by both pyego and pipreqs and both pyego and dockerizeme.
import urllib.parse from oauth2client import appengine discoveringmoredependentsystemlibraries .pipreqsdoes notconsidersystemlibraries anddockerizemeonlydiscoverssuch dependencies based on association mining.
in comparison pyego discoversmoredependencieswithanadditionalsimilarity based approach sec.
.
.
for instance pyego discovers avdepending onlibavcodec dev and pyldapdependingon libldap2 dev and libsasl2 dev .
such knowledge helps pyego achieve high accuracy.
pythonversioncompatibilityawareness .dockerizemetakes python2.7asthedefaultinterpreter andpipreqsonlyusesthelocal python versions directly .
however not all programs are compatible with pre installed python versions.
pyego analyzes syntax features and standard modules used in programs and thus pyego recommends a compatible python version for each target program.
dependency conflicts prevention .
both pipreqs and dockerizeme simply take the latest package versions without concerningdependency conflicts.
pyegoavoidspotential dcsbysolving constraints among dependencies.
for example in the followingcode snippet the latest version of torchmeta andtorchvision are1.
.0and0.
.
respectively.however torchmeta .
.
dependson torchvision .
.
.thus installingthelatestversions of both packages would result in a dc.
conversely pyego installs torchmeta .
.
andtorchvision .
.
and avoids the dc.
from torchvision import models from torchmeta.utils.data import batchmetadataloaderonaverage pyegoinfersthefewestthird partypackages atp butalittlemoresystemlibrariesthanpipreqsanddockerizeme.on the one hand although pipreqs does not consider system libraries someprogramshappenedtodependonsystemlibrariesinstalledin default.ontheotherhand someobtaineddependenciesbetween systemlibrariesandthird partypackagesarefalsepositives resulting in unnecessary system libraries.
however a little more false positives is an acceptable price to pay for the higher accuracy.
tomakeamorethoroughevaluation weperformasetofpairwisecomparisons.thatis wecomparepyegowitheveryotherapproachbasedontheprogramswhosedependenciesaresuccessfully inferred by both.
for example we compare pyego with pipreqsbased on the gists whose dependencies are successfully inferred by both of them.
table lists the pairwise comparison results.
we noticethatpyegocaninferdependenciesformostprogramswhosedependenciesaresuccessfullyinferredbypipreqsanddockerizeme.
.
answer to rq5 wecomparepyegowithdockerizemeandpipreqsintermsoftheir average execution time.
as table shows pyego runs .2x and .5xfasterthanpipreqsanddockerizemeonhg2.9k aswellas .1x and .8x faster than pipreqs and dockerizeme on jpd respectively.pyegoruns3.1xfasterthandockerizeme butalmostequallytopipreqsonsd.however unlikepipreqs whichimmediatelyexitsonceencounteringa syntaxerror causedbyincompatiblepython versions duringprogramanalysis pyegotriestheotherpython version until it finds a compatible one.
pyego runs faster on all sub datasets in the pairwise comparison since pipreqs would no longer encounter any syntaxerrors and exit immediately.
pyego avoids online queries by storing the obtained knowledge in pykg locally and thus its performance bottleneck becomes querying knowledge graph pykg.
hence we partially cache pykg in practice to speed up pyego.
t ake the dataset sd as an example pyego takes .52s in a dependency inference on average withcache .79xfasterthanwithoutcache.incomparison pipreqs only locally records modules in third party packages and has toquery pypi for the latest version increasing its time overhead.on the other hand dockerizeme runs slowly because it directly accesses its knowledge base step by step without leveraging cache.
discussion we discuss some future work to deal with limitations.
more comprehensive knowledge acquirement.
pyego is limited in the equipped domain knowledge e.g.
pykg stores only a small part e.g.
third party packages in pypi of domainknowledge.
thus pyego does not know to what packages the unrecognized imported modules belong.
therefore we will continuously and incrementally enrich pykg by acquiring more domain knowledge.
os specificdependencyidentification.
ourfailurerootcause analysis found that some third party packages are compatible with specificoses e.g.
macos.currently pyegoconcentratesondependencies in linux and we will enrich pykg with os level com patibility information in the future.
finer grained feature utilization.
functionsandclassesare alsoimportantfordistinguishingversionsofthepythoninterpreter authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
knowledge based environment dependency inference for python programs icse may pittsburgh pa usa andpackages especiallyinsituationswheretwoversionsofapackage only differ in implementation details.
however pyego only concerns module level features and cannot recognize the functionand class level differences.
we will extract and utilize such finergrainedfeaturesinstandardandthird partymodulesforimproving dependency inference accuracy.
conditional dependency identification.
pyego fails to inferconditionaldependencies fortargetprograms.wewillexplore context aware program analysis to identify such dependencies.
threats to validity internal validity threats come from the acquired knowledge particularly the dependencies between third party packages and system libraries.thesimilarity andassociation baseddependencymining mayintroducefalsepositives sec.
.
.wemitigatethethreatby leveraging a comprehensive metric for increasing the accuracy of similarity based mining and setting the threshold with a moderately high value to filter out more false positives.
theexternalvalidityconcernsthegeneralityofourwork.we evaluate pyego by resolving importerrors for single file python programs.
in particular each program in hg2.9k is a hard gist whose importerrors cannot be resolved by the naive algorithm .
the experimental result reveals that pyego is more effectivethanstate of the artapproaches.ontheotherhand we evaluatepyegoon100real worldprojectsselectedfromgithub basedonseveralcriteriaand4 836jupyternotebooks.theseprojects aremorecomplexwithmultiplecodefiles.theexperimentalresult shows that pyego is scalable to infer dependencies for complex pythonprojectsofvarioustypes andmostinferreddependencies do not change execution semantics.
construct validity refers to the suitability of our evaluation measures.likethepriorstudy wethinkadependencyinference is successful only if the target program no longer experiences importerrors .weevaluatethedependencyinferenceresultofa pythonprojectmorestrictly.adependencyinferenceofacompletepythonprojectissuccessfuliftheprojectcanexecutecorrectlyandtheinferenceisconsistentwithitsoriginallydeclareddependencies.
related work dependency inference .
the most relevant work is dockerizeme snifferdog and pipreqs .
dockerizeme infers thirdpartypackageandsystemlibrarydependenciesusingacombination of static analysis dynamic analysis and association rule mining.
pipreqs apopularopen sourcetool generatesa requirements.txt filefor apython programbased on importstatementsanalysis.
it resolvestheinconsistenciesbetweenpackagenamesandmodule names based on a pre constructed dictionary and queries pypi onthefly.snifferdog analyzesjupyternotebookstodetermine candidates for required packages and versions based on a database of apis.
pyego is more effective since it concerns more dependencies considersversionconstraintsamongdependencies and is configured with rich and detailed dependency knowledge.
dependency conflict management .
watchman detects dcsinthepypiecosystem.riddle generatesteststocollect crashingstacktracestofacilitatedcissuediagnosisofjavaprojectsbased on the empirical study findings .
pradel et al.
p r o posed a detection strategy for dcs between javascript libraries.libharmo detects library version inconsistencies for java maven projects and interactively suggests a harmonized version withtheleastharmonizationefforts.sensor synthesizestest casestotriggerinconsistentbehaviorsoftheapiswiththesame signatures in conflicting java library versions.
breakingchangedetection .pydfix detectsandfixesunreproducibility in python builds caused by breaking changes of dependencies.v2 detectsbreakingchangesbasedonpython program crash information.
it fixes crashes by repeatedly building environmentsandrunningprogramswithinferreddependencies in atrial and error manner inducing intolerable time overhead.
mezzettietal.
presentedatechnique typeregressiontesting to detectbreakingchangesinnode.jslibraries.throughcross project testing and analysis debbi detects backward behavioral incompatibilities between java software libraries and client software projects.mujahidetal.
leveragedautomatedtestsuitesofother projectsdependinguponthesamedependenciestotestnewlyreleasednpmpackage versions.
pythonecosystemstudy .valievetal.
performedamixedmethods study on ecosystem level factors affecting the sustainabilityofopen sourcepythonprojects.bommaritoetal.
and chen et al.
conducted empirical studies on pypi and language features respectively.
vu et al.
found that pypi is an attractive targetforattackerstotrickdevelopersintousingmaliciouspackages.theystudiedtheattacksandproposedanapproachtoidentify combosquatting and typosquatting packages automatically.
conclusion configuring a python program execution environment is non trivial due to complex dependencies.
this work proposes an automated dependency inference technique pyego.
assistedwith a dependencyknowledgegraph pyegoconsidersdependenciesof third party packages thepython interpreter and systemlibraries andinfersdependenciesforaprogrambyconstructingitsdependency graph and solving constraints in it.
the evaluation shows that pyego is more effective and efficient than the state of the art approaches.
in the future we plan to enhance pyego in several aspects e.g.
consideringfiner granularityfeatures improvingdependencyminingbetweensystemlibrariesandthird partypackages automating language feature identification and representation.
data availability pyego and its experimental data are publicly available at https github.com pyego pyego.