mando guru vulnerability detection for smart contract source code by heterogeneous graph embeddings hoang h. nguyen ehoang l3s.de l3s research center leibniz universit t hannover hannover germanynhat minh nguyen nmnguyen smu.edu.sg singapore management university singaporehong phuc doan phuc.dh194647 sis.hust.edu.vn hanoi university of science and technology hanoi vietnam zahra ahmadi ahmadi l3s.de l3s research center leibniz universit t hannover hannover germanythanh nam doan me tndoan.com independent researcher atlanta georgia usalingxiao jiang lxjiang smu.edu.sg singapore management university singapore abstract smart contracts are increasingly used with blockchain systems for high value applications.
it is highly desired to ensure the quality of smart contract source code before they are deployed.
this paper proposes a new deep learning based tool mando guru that aims to accurately detect vulnerabilities in smart contracts at both coarse grained contract level and ne grained line level.
using a combination of control ow graphs and call graphs of solidity code we design new heterogeneous graph attention neural networks to encode more structural and potentially semantic relations among di erent types of nodes and edges of such graphs and use the encoded embeddings of the graphs and nodes to detect vulnerabilities.
our validation of real world smart contract datasets shows that mando guru can signi cantly improve many other vulnerability detection techniques by up to in terms of the f1 score at the contract level depending on vulnerability types.
it is the rst learningbased tool for ethereum smart contracts that identify vulnerabilities at the line level and signi cantly improves the traditional code analysis based techniques by up to .
.
our tool is publicly available at .
a test version is currently deployed at and a demo video of our tool is available at .
ccs concepts computing methodologies !machine learning approaches security and privacy !software security engineering .
keywords heterogeneous graphs graph neural networks vulnerability detection smart contracts ethereum blockchain permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed for pro t or commercial advantage and that copies bear this notice and the full citation on the rst page.
copyrights for components of this work owned by others than acm must be honored.
abstracting with credit is permitted.
to copy otherwise or republish to post on servers or to redistribute to lists requires prior speci c permission and or a fee.
request permissions from permissions acm.org.
esec fse november singapore singapore association for computing machinery.
acm isbn .
.
.
.
reference format hoang h. nguyen nhat minh nguyen hong phuc doan zahra ahmadi thanh nam doan and lingxiao jiang.
.
mando guru vulnerability detection for smart contract source code by heterogeneous graph embeddings.
in proceedings of the 30th acm joint european software engineering conference and symposium on the foundations of software engineering esec fse november singapore singapore.
acm new york ny usa 5pages.
introduction smart contracts are increasingly used for creating and enforcing high value business transactions such as stock purchases life insurance certi cates inventory management and supply chain payment and tracking since their rst introduction in the 1990s by nick szabo .
blockchain based smart contracts provide append only non repudiation and transparency for their executions preventing double spending or breaches of contracts.
on the other hand like traditional software programs smart contracts can still contain programming bugs or vulnerabilities intentionally or unintentionally created by their programmers1.
such bugs or vulnerabilities may have more serious impact than those in traditional software as the buggy smart contracts once deployed to a blockchain are irreversible unless self destructed and may lead to huge nancial losses if misused by attackers.
thus it is highly desirable to have methods for detecting vulnerabilities in smart contract code during their early development and before deployment.
in this paper we propose a new tool with a new method for representing smart contracts as specialized graphs and learning their patterns automatically via graph neural networks on a large scale to detect vulnerabilities at both the line level and contract level accuracy.
in particular we represent ethereum smart contract source code written in solidity as heterogeneous contract graphs that combine control ow graphs cfgs and call graphs cgs using unique properties of solidity to capture contract code semantics and we design specialized metapaths for the graphs and build heterogeneous attention graph neural networks to learn multi level embeddings of the contract code in various levels of granularity which are then used together with known instances of smart contract vulnerabilities to train classi ers that can recognize 1in this paper we use the two terms bug and vulnerability interchangeably.
esec fse november singapore singapore hh nguyen nm nguyen hp doan z ahmadi tn doan and l jiang figure a sample vulnerability detection page of mando guru for an ethereum smart contract includes summary detection results for seven bug types top code snippet left and its corresponding heterogeneous contract graph right .
line with a yellow background is the root cause of a reentrancy bug left the nodes containing the reentrancy bug are highlighted with red right .
vulnerabilities accurately in new smart contract code at both linelevel and contract level.
our tool is named mando guru .w e have constructed a dataset containing both buggy and clean smart contracts and compared mando guru with several state of theart and conventional baselines.
our validation results show that mando guru outperforms the baselines in both contract and line level vulnerability detection with signi cant improvements.
related work existing studies have proposed methods to detect vulnerabilities either based on traditional program analysis testing veri cation techniques e.g.
or based on machine learning and deep learning e.g.
.
traditional techniques often rely on some bug patterns manually de ned by experts leading to low scalability as the techniques can be slow in performing extensive checks on large codebases for complex patterns low generalizability as new patterns need to be manually de ned for new types of bugs or new programming languages for smart contracts .
deep learning techniques alleviate the problem by automatically learning bug patterns from certain representations of existing code such as syntax trees data control dependency graphs etc.
still the learning based techniques have treated the trees graphs as attened sequences or conventional graphs disjointing each other and has not utilized particular kinds of control ow and call relations in the contract code to capture their semantics more comprehensively.
moreover they often treat nodes and edges in the tree and graph representations of source code homogeneously ignoring ne grained di erences in their types and locations.
there may be only one recent study on using heterogeneous graphs for source code representation but it has not yet been applied to smart contracts.
as a result they could only search for coarse grained whole graph level smart contract vulnerabilities which are not accurate enough to locate the line level locations of vulnerabilities.
besides some approaches also apply graph neural networks for vulnerability detection suchas devign and ivdetect .
however they are designed for other languages and unsuitable for solidity.
usage figure 1illustrates mando guru s main user interface and core features.
more speci cally after a user submits a solidity source le using the submit button on the top mando guru scans the input and summarizes the coarse grained contract level detection results of seven bug types the red green buttons near top .
a red button indicates a bug type detected for the contract and users can click it to show the ne grained line level detection results.
on the left side of the gure the source code lines containing detected bugs would be highlighted with a yellow background.
the right side visualizes the corresponding heterogeneous contract graph of the input contract.
if a node is detected having a bug it is colored red.
when users hover the pointer over a node the node details will be shown and when they click a node the code lines relevant to that node will be marked with the red border on the left.
besides the core features mando guru also provides various statistics charts for general analyses of the generated heterogeneous contract graphs.
in particular after getting the detection results users could click the show statistics button to get three extended charts including the number of clean and buggy nodes running time for coarse grained and ne grained detection and the density of each bug type.
we explain in detail the charts in our demo video.
tool design implementation figure 2illustrates an overview of mando guru with three main components backend restful apis and frontend .
backend plays a vital role with several core sub components such as heterogeneous representation for the generated graphs from input smart contracts heterogeneous graph fusion custom multi metapaths extraction heterogeneous graph neural network and vulnerability detections in coarse grained and ne grained levels.
the technical details of backend are described in .
the frontend component services 1737mando guru vulnerability detection for smart contract source code by heterogeneous graph embeddings esec fse november singapore singapore backend frontendcontrol flow graph cfg generationcall graph cg generationheterogeneous cfg cg fusionnode feature initializationmando guru heterogeneous graph neural network labeled smart contracts for trainingnew smart contract for predicting coarse grained detectioncustom multi metapaths extraction restful apisvisualizationprediction resultsstatisticsheterogeneous representationfine grained detectionfigure overview of the mando guru tool.
are used to visualize the prediction results and the statistics of the analyzed smart contracts.
restful apis are implemented as a bridge to communicate between the backend and the frontend.
.
backend .
.
heterogeneous representation for the generated control flow graphs and call graphs.
first to generate the basic control ow graphs and call graphs we use slither to process the source code of each input ethereum smart contract.
then we convert the graphs into heterogeneous forms called heterogeneous control ow graphs hcfgs andheterogeneous call graphs hcgs to represent the relations of di erent node and edge types and graph topologies.
in particular a heterogeneous graph is de ned as a special graph consisting of multiple type of nodes or edges.
unlike some recent studies that use only homogeneous graph structures and lead to loss of valuable information on the code semantics in smart contracts one primary contribution of mando guru is to focus on capturing and retaining more structures and semantics of source code through our heterogeneous representations.
.
.
fusion of heterogeous control flow graphs and heterogeous call graphs.
an hcfg can represent each function in a smart contract and it contains an entry node corresponding to the entry point header of the function.
generally a smart contract may be considered as a set of hcfgs since it consists of more than one function.
the invocation relations among the functions in one contract or between contracts are represented by hcgs.
the structures of the heterogeneous graphs can be shared or combined to enrich information for graph learning.
hence we design a sub component as a core fusion of hcgs and hcfgs into a global graph.
accordingly the hcg edges of a contract act as bridges to link the discrete hcfgs of the contract functions into a global fused graph.
we call the fusion graphs as heterogeneous contract graphs .
intuitively for each and every function node 8in the call graph the function control ow graph is attached to the function node 8at the entry node of and thus the call graph is expanded with control ow graphs to produce the heterogeneous contract graph db8 .
the heterogeneous graph generation also allows us to expand the generalizability of theproposed method to other programming languages e.g.
c c java with minor modi cations.
.
.
node feature initialization.
in the default setting of mando guru the one hot vectors based on node types are used to initialize node features.
besides various state of the art node embedding techniques can be plugged into mando guru to capture the graph topology and extract the node features.
for a more comprehensive validation of the e ectiveness of various initialization of node features we use both embedding methods for homogeneous graphs e.g.
node2vec and embedding methods for heterogeneous graphs e.g.
metapath2vec see section .
.
.
extraction of custom multi metapaths.
a metapath is a path in the form of !
!...
!
which de nes relations i.e.
edge types from node types 8to 1in a heterogeneous graph.
the length of is the number of relations in .w e extract length metapaths of each node type pair from a heterogeneous contract graph since learning the extracted metapaths can be an e ective way to learn the graph structures .
similar to the method used in han we only focus on metapaths of length to capture the relations between each node type pair and its neighbors and to prevent the explosion of metapaths when the generated heterogeneous contract graphs contain a dynamic number of node types reaching eighteen in some large smart contracts with ve di erent connections per node type and pre de ning all possible metapaths with any length according to all possible node types and edge types would lead to an exponential explosion of metapaths increased data sparsity and reduced accuracy in training data.
in addition the heterogeneous contract graphs have mostly treelike structures with very few of their own back edges induced by the loop related statements in the smart contracts source code leading to the lack of metapaths connecting many types of leaf node in the graphs.
therefore we customize the length metapaths by re ecting the relation 8between adjacent nodes from type 8to type 1and also from 1to 8to extract multiple metapaths.
.
.
heterogeneous graph neural network.
our unique heterogeneous graph neural network learns to weigh the importance of every metapath and node by the node level attention mechanism and can handle multiple dynamic custom metapaths without prede ning the list of input metapaths.
in particular with the initialized node features node embeddings 4q 8for each node 8whose type is q then we construct a corresponding weighted node feature by a linear transformation.
next we measure the weight of the c th metapath according to the node type q of pair by leveraging the self attention mechanism between 8and9.
we concatenate all node embedding q 8corresponding to all node type q of all node 8to generate a uni ed embedding vector for a node which is used to train a ne grained bug classi er.
the average of all node embeddings in a graph is used as the graph embedding which is used to train a coarse grained bug classi er.
also we employ the multi layer perceptron mlp with a softmax activation function for predicting with the inputs depending on the type of detection tasks.
moreover the loss function for the training process is cross entropy and the parameters of our model are learned through back propagation.
1738esec fse november singapore singapore hh nguyen nm nguyen hp doan z ahmadi tn doan and l jiang .
.
coarse grained detection and fine grained detection.
first mando guru classi es if a contract is clean or contains a type of vulnerabilities at the contract level by using coarse grained graph classi cation.
next mando guru identi es the actual locations of the vulnerabilities in the smart contract source code at the line level using ne grained node classi cation.
providing line level locations of vulnerabilities is one of our primary contributions while the previous graph learning based methods e.g.
only report vulnerabilities at the contract or function level.
.
restful apis and frontend mando guru is based on the fastapi framework to create our restful apis as well as validation data to handle the requests and respond the detection results to the frontend services.
also we use a token for each request to validate and reduce the unexpected demands to our system via the basic http authentication method.
all restful apis in mando guru are implemented and provided under post methods.
besides to ensure the mando s overall performance we encode the source code of smart contracts to base64 format before processing.
our apis could be categorized into two groups depending on the request purposes from the frontend component services coarse grained requests for predicting whether a source code has any bug and fine grained requests for getting the lines and nodes detected as having bugs.
our frontend web application is built on reactjs and apexchartsjs libraries.
when users submit a source le to our web app it scans through the le for a total of seven bug kinds supported and returns the summary and details of detection results for each bug type.
we also provide some sample smart contracts in a dropdown menu which may help the users who lack the solidity source les to test mando guru more exibly.
the detection results are then visualized by interactive graphs and highlighted code snippets for users to double check them easier.
tool validation .
setup our evaluaiton uses two tasks i contract level vulnerabilty detection and ii line level vulnerabilty detection.
we combine the three following datasets for our training smartbugs curated solidifi benchmark and clean smart contracts from smartbugs wild .
in total we have clean contracts and annotated buggy contracts.
we use the following four state of the art methods as the graphbased neural network comparison methods node2vec line graph convolutional network gcn and metapath2vec .
we use the output embeddings of the homogeneous and heterogeneous graph neural networks in two ways in our validation first directly as the baselines for the coarse grained graph classi cation tasks and ne grained node classi cation tasks.
second each of the graph neural networks is plugged into mando guru as the topological graph neural network the generated embeddings are considered the node features besides those based on the node type one hot vectors of the default setting and then fed to mando guru heterogeneous graph neural network hgnn .
we also used six detection tools built upon traditional software engineeringtechniques manticore mythril oyente securify slither and smartcheck .
we use f1 score and macro f1 scores to measure the performance of our node graph classi cation for the detection tasks.
f1score is used to validate the models performance when nding bugs and is also called buggy f1 .
macro f1 is considered to avoid biases in the clean and bug labels.
.
empirical results contract level vulnerabilty detection mando guru outperforms baseline gnns.
e.g.
an improvement of in both metrics is achieved by mando guru over the best baselines for detecting the front running type of bugs.
the node feature generatation methods help mando guru outperform all the baselines and it shows that our architecture is general for plugging in various kinds of gnns.
being competible with slither makes mando guru more e ectively with various versions of solidity mando guru is able to nd newly appeared bugs that graph learning methods struggle to achieve.
line level vulnerabilty detection mando guru outperforms conventional tools signi cantly with improvement up to .
compared to the best performing tools for the reentrancy type of bugs.
it can be explained by i more cfg structures retained by our heterogeneous graphs and ii the exibility of our architecture.
our method beats the results of the baseline gnns where the macro f1 scores of our model is up to higher than the ones of the baseline gnns.
conventional detection tools perform well in detecting arithmetic bugs because they mostly use symbolic execution and such technique is suitable for detecting arithmetic bugs .
however mando guru performance is still on par with the tools.
conclusion this paper presents a new tool mando guru for detecting vulnerabilities in ethereum smart contracts written in solidity.
our detection technique is new based on a kind of heterogeneous attention graph neural networks that learn the embeddings of combined control ow graphs cfgs and call graphs cgs of solidity smart contract code.
we can generate both node level and graph level embeddings of smart contracts and train classi ers to recognize various types of vulnerabilities in smart contracts at both the ne grained line level and the coarse grained contract level.
our validation on some datasets curated from the real world shows that mando guru can detect seven types of smart contracts more accurately on average than several baseline methods and thus is a promising complement to other vulnerability detection techniques.