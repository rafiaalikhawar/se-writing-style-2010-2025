towards automatically repairing compatibility issues in published android apps yanjie zhao monash university melbourne australia yanjie.zhao monash.eduli li monash university melbourne australia li.li monash.edu kui liu huawei hangzhou china liukui23 huawei.comjohn grundy monash university melbourne australia john.grundy monash.edu abstract theheavyfragmentationoftheandroidecosystemhasledtoseverecompatibilityissueswithapps includingthosethatcrashat runtime or cannot be installed on certain devices but work well on other devices.
to address this problem various approaches have been proposed to detect and fix compatibility issues automatically.
however theseallcomewithvariouslimitationsonfixingthecompatibilityissues e.g.
canonlyfixonespecifictypeofissues cannot dealwithmulti invocationissuesinasinglelineandissuesinreleasedapps.toovercometheselimitations weproposeageneric approach that aims at fixing more types of compatibility issues inreleasedandroidapps.tothisend ourprototypetool repairdroid provides a generic app patch description language for users to create fix templates for compatibility issues.
the created templateswillthenbeleveragedby repairdroid toautomaticallyfixthe correspondingissueatthebytecodelevel e.g.
rightbeforeusers install the app .
repairdroid can support template creations for os induced device specific and inter callback compatibility issues detected by three state of the art approaches.
our experimental results show that repairdroid can fix out of compatibility issues in randomly selected google play apps.
repairdroid isgenerictoconfigurenewcompatibilityissuesandoutperforms the state of the art on effectively repairing compatibility issues in released android apps.
ccs concepts software and its engineering software verification and validation softwaredefectanalysis softwaretestinganddebugging.
corresponding author.
permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed forprofitorcommercialadvantageandthatcopiesbearthisnoticeandthefullcitation onthe firstpage.copyrights forcomponentsof thisworkowned byothersthan the author s mustbehonored.abstractingwithcreditispermitted.tocopyotherwise or republish topostonserversortoredistributetolists requirespriorspecificpermission and or a fee.
request permissions from permissions acm.org.
icse may pittsburgh pa usa copyright held by the owner author s .
publication rights licensed to acm.
acm isbn ... .
android compatibility issue automated program repair acm reference format yanjie zhao li li kui liu and john grundy.
.
towards automatically repairing compatibility issues in published android apps.
in 44th international conference on software engineering icse may pittsburgh pa usa.
acm new york ny usa pages.
https introduction the heavy fragmentation problem of android many different android versions official and customized running on different devicesreleasedbyhundredsofmanufacturers hascausedsevere compatibility issues for the android ecosystem.
android phone usersoftenfindthatcertainappscannotbeinstalledontheirdevices or can be installed but will crash later on if a specific function is reached leading to poor user experiences.
actually as revealedby byron muhlberg there are over a billion android devices no longer supported by google.
hence the users of those devices will likelyencountercompatibilityissues especiallywhentheywant to leverage the latest android apps leading to serious problems in the mobile ecosystem.
toaddressthisproblem approacheshaveexploredvariousways to automaticallydetect compatibilityissues inandroid apps .forexample wei etal.
empirically looked into a set of fragmentation induced compatibility issues includingthoseintroducedbythird partymanufacturers in open sourceandroid apps.they furtherproposed atool called ficfinder to detect the previously characterized compatibility issuesautomatically.lietal.
proposedagenericapproachcalled cid whichdetectsapi relatedcompatibilityissuesbasedonandroidapilifecycleknowledgeminedfromtheofficial shistorical evolution android framework.
unfortunately the majority of these works only focus on detectingsomecompatibilityissues leavingmanyidentifiedissuesstill unfixed in real world android apps.
updating incompatible apis is a time consuming endeavor and app developers are also known to bereluctanttorepairtheirappsforfixingissuesyieldedbystatic analyzers .
app developers have to learn the usages of new apisinordertoreplacetheincompatibleoneswhilemaintaining ieee acm 44th international conference on software engineering icse authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
icse may pittsburgh pa usa yanjie zhao li li kui liu and john grundy backwardcompatibilitywiththeoldversion.thisgreatlyincreases the learning cost for developers.
tomitigatethis researchershaveproposedseveralautomated approachestorepairincompatibleapisforandroidapps.fazzini et al.
introduced appevolve to update incompatible apis based on examples of how other developers evolved their apps for the same changes.
similarly lamothe et al.
proposed an approach called a3 for supporting api migration through patterns mined fromsourcecodeexamplesviaabstractsyntaxtree ast .theseapproaches require the target code under repair written syntactically similar to the before and after update api change examples.
this makesthemhardtofindapplicableupdates asclaimedbythung etal.
.tothisend haryonoetal.proposedcoccievolve to onlylearnupdatesfromasingleafter updateexample.iteliminates theweaknessofappevolvebynormalizingboththeafter update example and the target app code.
nevertheless the serious issue of coccievolveis its inability toresolve all the valuesused as api arguments.
these can be expressed in various complex forms e.g.
field access expressions method invocations and object creations.
itsotherdrawbackisthepoorreadabilityofitsupdatedappcode results.itsauthorsfurtherextendtheirworkbyproposingandroevolve which addresses the limitations of coccievolve through theaddition ofdata flowanalysisand variablenamedenormalization.
unfortunately alltheaboveapproachesfocusonrepairingthe source code of android apps and hence cannot be applied to directlyrepairpublishedandroidapps.indeed astimegoesby many published android apps on popular app markets such as google play unless being timely fixed will become obsolete leading to pooruserexperiencesinthemobileecosystem.tocopewiththis marketmaintainers couldchoosetoremovethoseapps.however thismaynotbeagoodbusinessmodelasitmayreducethemarket s competitiveness i.e.
its competitors are providing more choices of appsforuserstoexplore.ifmarketmaintainersdonotremovethose apps certain apps in the market will not be able to be installed on users devicesorwillcrashafterinstallation.itwillalsocausepoor userexperiencesandcanevenharmthereputationofthemarket and the app developers per se.
asasupplementtoexistingrepairapproachesthatattemptto helpdevelopersindevelopinghigher qualityapps webelievethere isalsoaneedtoprovideapproachesforhelpingrepairpublished apps before they are installed on users devices at least in the timeperiodbeforetheirdevelopersexplicitlyupdatetheapps.this paper proposes a novel generic approach for repairing three types ofcompatibilityissues api deviceandcallback inducedproblems inpublishedandroidapps.sinceitisrelativelysimpletotransform java source code to bytecode and vice versa the approach targetingpublishedandroidapps withsmallchange couldalsobeappliedtorepairappsatthesourcecodelevel butnottheotherway around .
nevertheless we argue that source code and bytecodebasedrepairingapproachesarenotmutuallyexclusive.theycan co exist and complement each other.
indeed approaches targeting publishedapprepaircouldbeleveragedtoachieveemergentrepair while source code based approaches can come in later to gradually fix the issues.
for example market maintainers could leverage published app repairs to ensure the compatibility of their hosted apps with developers permission at app uploading or downloadingtime.thisisextremelyuseful especiallyforlegacyappsthatare lessfrequently willno longerbe maintained bytheirdevelopers.
correspondingly end usersareprovidedoptionstouseappsthat could not be running initially on their devices.
in this work we present a prototype tool repairdroid which leverages pre defined patch templates to instrument android apps so as to fix compatibility issues.
the templates are written by dedicated experts i.e.
app developers do not need to write patchesfor their apps based on a structural model that is both descriptiveandgeneric i.e.
agivenpatchshouldbeapplicabletoallandroid apps.
the instrumentation process involves control flow anddata flow analysis to locate and repair compatibility issues.
experimental results on thousands of real world android apps show that repairdroid is effective in automatically repair various types of compatibility issues.
in this research we make the following key contributions we have designed a novel app patch description languageand demonstrated that it is generic enough to be used tocreate fix templates for various compatibility issues.
the genericity is achieved by allowing users to directly leverage thesimplebutwell definedjimplegrammar i.e.
a3 address intermediaterepresentationthathasbeendesignedtosimplify analysis and transformation of java android bytecode to describe the patches.
wehavedesignedandimplementedaprototypetool repairdroid which follows given fix templates to automatically repair published real world android apps.
we have evaluated our approach against real world android apps.
experimental results show that our approach iseffectiveinrepairingandroidapps outperformsthestateof the art and achieves .
of successful repairing rate.
opensource.
thesourcecodeanddatasetsareallmadepublicly available in our artifact package .
motivation the heavy fragmentation of the android ecosystem has induced many types of compatibilityissues in android apps.
our research community has spent lots of effort on disclosing such issues including at least the following three types os inducedcompatibilityissues.
thisisoneofthemostcommontypesofcompatibilityissues whereissuesarecausedbythe evolution of the android framework.
during framework evolution new apis are regularly added to the framework while existing apisarealsoregularlydeprecatedandremoved.insomerarecases existingapismayalsobesemanticallychanged despitekeeping thesignatureoftheapisunchanged.theexamplegiveninlisting1 shows a deprecated api issue.
if android.os.build.version.sdk int for network nw cm.getallnetworks networkcapabilities nc cm.getnetworkcapabilities nw if nc !
null nc.hastransport networkcapabilities.transport wifi return true return false else return an.gettype connectivitymanager.type wifi authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
towards automatically repairing compatibility issues in published android apps icse may pittsburgh pa usa listing an example of an os induced compatibility issue.
api gettypeis deprecated at sdk level .
on devices running sdk versions larger than it is recommended to use api hastransport instead.
device specific compatibility issues.
these compatibility issuesareassociatedwithspecificdevicesrunningcustomizedandroid systems.
the problematic apps will only crash on certain deviceswhilebehavingnormallyonothers despiteallthedevicesrunning the same android framework version.
listing presents such anexamplethatwasinitiallyreportedbyweietal.
.theapi setrecordinghint dependsonaconditionalstatementthatchecks the device identifier against nexus .
only the condition to be true i.e.
the corresponding app is indeed running on nexus the api will be executed.
1camera mcamera camera.open 2camera.parameters params mcamera.getparameters ...... if android.os.build.model.equals nexus params.setrecordinghint true ...... 8mcamera.setparameters params 9mcamera.startpreview listing patch for camera preview frame rate issue on nexus excerpted from .
inter callback compatibility issues.
this type of compatibilityissueiscausedbythechangestoandroidsystemcallbacks also known as lifecycle methods .
such system callback methods are pre defined by the android system and will be directly executed whencertain conditionsare satisfied.listing3 illustratessuch an example that was initially reported by huang et al.
.
theonattach context callback method is only introduced from api level .ifthiscodeisrunningonsmartphoneswithearlierapilevels this callback method will not be executed.
subsequently the mactivityfield will not be initialized and its usage will likely throw nullpointerexception s. 1public void onattach context context super.onattach context mactivity browseractivity context ...... attachactivity browseractivity context public void onattach activity activity super.onattach activity if build.version.sdk int attachactivity browseractivity activity private void attachactivity browseractivity activity mactivity activity ...... listing the patch for wordpress issue .
the compatibility issue is caused by the fact that the callback method onattach context is not yet available before api level excerpted from .
all of these compatibility issues are equally critical to mobile apps as all of them will cause apps to crash leading to poor user experiences.compatibilityissue repairingapproachesshouldaim tofixallofthem.ho wever curr entstate of the arttoolsonlyfocus onrepairingapi inducedcompatibilityissues.automaticallyfixing othertypesofcompatibilityissues suchasdeviceorcallbackrelated ones has not yet been addressed.assummarizedintable1 existingapproachesalsocomewith many limitations.
for example coccievolve only attempts to fix incompatibleapiswithinasinglemethod.theirfollow upwork androevolve fixes this limitation by additionally introducing dataflow analysis into the fixing process.
compatibility issues withrespect to out of file variables and multi invocations in asingle line and compatibility issues in released android apps cannot be resolved by any of the state of the art.
table problematic android compatibility issues addressed by state of theart tools.
feature a3appevolve coccievolve androevolve out of method within file variables out of file variables to n replacement multi invocations in a single line fix in published android apps our approach repairdroid we introduce repairdroid a template based repair approach to automatically repair three kinds of compatibility issues in android apps.
figure presents an overview of repairdroid .
it has three keymodules templatebuildmodule tbm buglocation module blm and bug repair module brm .
below we detail these three modules.
existing fixes blm bug location modulebrm bug repair module bug free app tbm template build moduletemplates published app figure the working process of repairdroid .
.
tbm template build module thisfirstmoduleof repairdroid aimsatpreparingasetofsemantic templates for subsequent modules to repair published android apps.themaincontributionofthismoduleisagenericlanguage fordescribingapppatchtemplates.developersshouldbeableto easily leverage the language to create templates for fixing compatibility issues based on knowledge learned from the official androiddocumentation onlinequestionandanswerwebsitessuchasstackoverflow orexistingfixingsamplesminedfromtheevolutionof real world android apps.
the grammar of the language is straightforward.
as shown in figure it contains three blocks namely variable declaration block issue location block and patch block.
we now detail these three blocks respectively.
variable declaration block.
the first block provides a means for developers to specify all the variables involved in the template.
at the moment the language supports three types of variables.
variables to be directly reused from the original con text.
these variables appear in the original code statements used for locating problems and hence could be directly reused in the new code.
variablestobesearchedfromtheoriginalcontext.
these variables do not appear in the original code statements that authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
icse may pittsburgh pa usa yanjie zhao li li kui liu and john grundy variable declaration v0 boolean v1 any v2 type issue location condition template denotation replacement statements original statements or v0 condition expression if v0 true replacement statements else original statements figure2 thelanguagestructureforcreatingpatchtemplatesfor repairdroid .
are defined to locate the problems but do exist in the app context.hence backwarddata flowanalysisisdemandedto searchthedefinitionofthevariablesfordirectreuses.these variableswillbeexplicitlymarkedbykeyword as demonstrated in figure .
variablestobecreated.
thesevariablesaretotallynewto the app and hence need to be defined before applying the template.
issue location block.
the second block is provided for developerstospecifyhowthecompatibilityissuescanbeprogrammatically located.
developers first specify the issue type in square brackets tobefixedtosimplifythelocationprocess.thisisbecausedifferenttypesofcompatibilityissuesrequiredifferentstrategiesto locate them.
as inspired by the three types of compatibility issues summarized in section the language currently provides three issuetypes i.e.
and respectivelyforos induced device specific andinter callbackcompatibilityissues to guiderepairdroid for locatingcompatibility issues.
moreissue types could be added to the language if new types of compatibility issues are identified in the future.
like the variable declaration block the issue location block is alsorelativelyeasytoconfigure.inmostcases itonlyneedsone lineofstatementtospecifytheissue.forexample thecompatibility issues in the three motivating examples shown in section can be respectively specified by the issue location statements shown in listing .
inadditiontothetargetedapis condition alsospecifies the situation when the issue should not be considered even ifthe targeted apis or call methods are located.
taking line inlisting as an example if the invocation of the deprecated apigettype is already protected by an sdk version check i.e.
if build.version.sdk int this target should be ignored as there should have no compatibility issue in such a case.
templatedenotationblock.
thelastmoduleoftheapppatch languageisusedbydeveloperstospecifytheactualtemplatefor fixingthelocatedcompatibilityissues.thefixtemplateisdesigned to be written in jimple like pseudocode.
jimple is the default intermediate representation of soot a well known java android static analysis framework.
the reason why we choose jimple todescribe the template is that the instrumentation function of repairdroid isimplementedontopofsoot.itallows repairdroid to quickly apply the template to fix compatibility issues in a deployed app1.
as shown in figure the typical way to fix an os induced compatibilityissueistoreplacetheoriginalproblematicstatements with corrected new statements.
in practice we recommend the developers to always guard their newly introduced code through a conditionalcheck.whenthecheckreturnstrue thereplacement statements will be invoked.
otherwise the original statements will be executed and hence the original behaviors are kept.
void onattach android.content.context r0 this a0 parameter0 android.content.context specialinvoke r0.
android.app.fragment void onattach android.content.context a0 ... when !
v0 a0 virtualinvoke r0.
void attachactivity v0 return void onattach android.app.activity r1 this a1 parameter0 android.app.activity specialinvoke r1.
android.app.fragment void onattach android.app.activity a1 i1 android.os.build version int sdk int if i1 goto label 1 v1 a1 virtualinvoke r1.
void attachactivity v1 label 1 return void attachactivity r2 this a2 parameter0 return listing the template denotation block of the inter callback example.
listing5showsanexampletemplatedenotationblockforthe inter callbackexampleshowninlisting3.basedontheexample inlisting5 wefurtherintroduceseveralkeywords suchas torespectivelyrepresentcutandpasteoperations with whichtheycanbatchprocessstatementswithinthesetrange as shownatline5andline25.inspiredbysmpl onthebasisof ensuringtheuniversalityofthelanguage thetemplatesforthese threeissueshavedesignedsomespecialsymbols includingtheuse of some reserved words.
...when!
the ... operatorinsmplrepresentsanarbitrarysequence i.e.
any sequenceofstatementsoveranycontrolflowpath whichisalso used in our language.
for example the usage of when !
end of 1ideally wewouldliketosupportjavaasthelanguagefordescribingthepatchdirectly asitwouldbemoreconvenientforpatchwriters.however thiswillmakethepatch parsingstepdifficulttoachieveasessentiallyitasksforajavacompilertointerpret the random javacode.jimpleisasimplifiedjavarepresentationthatcouldbeanideal trade offsolution i.e.
notverydifficulttounderstandandwritebutcanbeinterpreted programmatically in practice thanks to soot .
authorized licensed use limited to lahore univ of management sciences.
downloaded on august at utc from ieee xplore.
restrictions apply.
towards automatically repairing compatibility issues in published android apps icse may pittsburgh pa usa android.net.networkinfo int gettype build.version.sdk int camera camera parameters getparameters build.model nexus fragment void onattach context build.version.sdk int listing examples of issue location statements for creating templates to fix the compatibility issues listed in the three motivating examples i.e.
listings respectively method atline5meansthatthereshouldbenooccurrencesof end of method in the matched control flow path that is the matching process continues to the end of the method.
although there are no complicated usages in the repair of the three types of compatibility issues introduced above our intention for this app patch language designistoensurethefuturescalabilityof repairdroid .tothisend can be replaced with other statements e.g.
tag statements such as label 1 to ensure that repairdroid can be guided to accurately collect statements.
in real world android projects the class inheritance feature has been frequently leveraged.
in order to improve the versatility of repairdroid we use to specify the superclass oftheclasstobesearched.forexample meansrepairdroid needs to search such a class that extends the superclass named android.app.fragment before performing subsequent work.
if the superclass does not need to be restricted areservedkeyword canbedirectlyusedtoindicatetheclasstowhichthecurrentmethodbelongs.
repairdroid will replace it with the actual value in the app when running on the brm module.
.
blm bug location module the second module of repairdroid takes as input the android apk to be analyzedand the semantic templates generated by the first moduleandoutputsthelocations atthestatementlevel indicating where the templates should be applied.
specifically this module takes the following three steps to achieve its purpose template parsing app pre processing and bug localization.
we now detail these steps respectively.
template parsing .
as a prerequisite to the following steps repairdroid firstreadsandparsesthesemantictemplatesgenerated bythetbmmodule.theparsingprocessutilizestheprincipleof finitestatemachinetoparsetheinputsemantictemplates.after theparsingstep eachsemantictemplateisstoredasastructured object that is readily available for further