automatic testing and improvementofmachine translation ze yusun key laboratory of hcst peking university moe szy pku.edu.cnjie m.zhang universitycollegelondon jie.zhang ucl.ac.ukmark harman facebooklondon universitycollegelondon mark.harman ucl.ac.uk mike papadakis universityof luxembourg mike.papadakis gmail.comluzhang key laboratory of hcst peking university moe zhanglucs pku.edu.cn abstract this paper presents transrepair a fully automatic approach for testingandrepairingtheconsistencyofmachinetranslationsystems.transrepaircombinesmutationwithmetamorphictesting todetectinconsistencybugs withoutaccesstohumanoracles .it thenadoptsprobability referenceorcross referencetopost process thetranslations inagrey boxorblack boxmanner torepairthe inconsistencies.
our evaluation on two state of the art translators googletranslateandtransformer indicatesthattransrepairhasa highprecision ongeneratinginputpairswithconsistenttranslations.withthesetests using automaticconsistencymetrics and manualassessment wefindthatgoogletranslateandtransformer have approximately and inconsistency bugs.
black box repair fixes and bugs on average for google translate and transformer.
grey box repair fixes bugs on average for transformer.manualinspectionindicatesthat thetranslationsrepaired by our approach improve consistency in of cases degrading it in and that our repairs have better translation acceptability in ofthe cases worse in .
keywords machine translation testingandrepair translation consistency acmreference format zeyu sun jie m. zhang mark harman mike papadakis and lu zhang.
.
automatic testing and improvement of machine translation.
in 42nd international conference on software engineering icse may 23 29 seoul republic of korea.
acm new york ny usa pages.
https introduction machinelearninghasbeensuccessfulinprovidinggeneral purpose naturallanguagetranslationsystems withmanysystemsableto corresponding and co first author.
hcst highconfidencesoftwaretechnologies.
permissionto make digitalor hard copies of allorpart ofthis work for personalor classroom use is granted without fee provided that copies are not made or distributed forprofitorcommercialadvantageandthatcopiesbearthisnoticeandthefullcitation on the first page.
copyrights for components of this work owned by others than acm mustbehonored.abstractingwithcreditispermitted.tocopyotherwise orrepublish topostonserversortoredistributetolists requirespriorspecificpermissionand ora fee.
request permissionsfrom permissions acm.org.
icse may 23 29 seoul republic ofkorea associationfor computing machinery.
acm isbn ... .
time .
nevertheless such translation systems are not perfect and the bugs that users experience have a different character from thoseontraditional non machinelearning based softwaresystems .
the consequences of mistranslation have long been studied and their effectshave been showntobe serious.for example the infamous historicmistranslation of article17of the treaty of uccialli reportedly ledto war .
such trulyprofound and far reaching consequences of mistranslation are also reportedly becoming a seriousandpotentsourceofinternationaltensionandconflict .
the consequences of mistranslation through machine based translatorshavealsobeenshowntobeserious.forexample machine translations have been shown to exhibit pernicious fairness bugsthatdisproportionatelyharmspecificuserconstituencies .
wehavefoundsuchexamplesoffairnessbugsinwidelyusedindustrialstrengthtranslationsystems.figure1showsseveralsuch googletranslateresultsforthelanguagepair english chinese .
ascanbe seenfromthefigure google translatetranslates good into hen hao de which means very good when the subject is men or malestudents .however interestingly butalsosadly it translates good into hen duo which means a lot when the subjectis women or femalestudents .
such inconsistency may confuse users and is also clearly unfair to female researchers in computer science producing a lot of researchisclearlyamorepejorativeinterpretation whencompared toproducing verygood research.toavoidsuchunfairtranslations atscale weneedtechniquesthatcanautomaticallyidentifyand remedy such inconsistencies.
to tackle this problem we introduce a combined testing and repairapproachthatautomaticallygeneratestestsforreal world machine translation systems and automatically repairs the mistranslationsfoundinthetestingphase.asweshowinthispaper weneedtorethinktheconventionalapproachestobothtestingand repairin order to apply themto naturallanguagetranslation.
existingworkhastestedwhethermachinetranslationsystems provide stable translations for semantically equal transformations suchassynonymreplacement e.g.
buy purchase orabbreviationreplacement e.g.
what s whatis .however noprevious 1thefourtranslationswereobtainedon23rdjuly .theseexamplesarepurely for illustration purposes and are not intended as a criticism of google translate.
it is likely that othermainstream translation technologies will havesimilarissues.
2similar issues also exist in translations between other languages.
with a cursory check wealreadyfoundacase with german chinese.
ieee acm 42nd international conference on software engineering icse icse may seoul republicof korea sun andzhang et al.
english ch inese google translation notes mendo goodresearch in computer science.nanrenzaij isuanji kexuefangmian zuole henhaodeyanjiu good henhaode very good women do goodresearch in computer science.n xingzaij isuanji kexuefangmian zuole henduoyanjiu good henduo a lot malestudents do good research in computer science.nanx uesheng zaijisuanjikexuefangmian zuolehen hao deyanjiu good henhaode very good femalestudents do good research in computer science.n xuesheng za ijisuanjikexuefangmian zuolehenduoyanjiu good henduo a lot figure1 examplesoffairnessissuesbroughtbytranslation inconsistency fromgoogle translate work has focused on the testing and repair of translation inconsistencyregardingcontext similartransformation thetransformation between sentences that have similar word embeddings yet sharecontextinthecorpus e.g.
simplegender basedtransformations such as boys girls .
inordertotacklethetestingproblem weintroduceanapproach thatcombinesmutation withmetamorphictesting .theapproachconductscontext similarmutationtogenerate mutated sentences that can be used as test inputs for the translator undertest.whenacontext similarmutationyieldsabove threshold disruptiontothetranslationofthenon mutatedpart theapproach reports an inconsistencybug.
traditional approaches to repairing machinelearning systems typicallyusedataaugmentationoralgorithmoptimisation.these approaches can best be characterised as to improve the overall effectivenessofthemachinelearner ratherthanspecificrepairsfor individual bugs they also need data collection labelling and model retraining whichusually have ahigh cost.
traditional approaches to repairing software bugs are white box becausethetechniquesneedtoidentifytheline s ofsource code that need s to be modified in order to implementa fix.
such approaches inherently cannot be applied to fix software for which sourcecode is unavailable such as third partycode.
our insight is that by combining the results of repeated and potentiallyinconsistent outputfromasystem wecanimplementa light weight black box repairtechniqueasakindof post processing phase that targets specific bugs.
our approach is the first repair technique to repair a system in a purely black box manner.
we believethatblack boxrepairhasconsiderablepotentialbenefits beyondthe specificapplicationof machinetranslationrepair.itisthe onlyavailableapproachwhenthesoftwareengineerispresented withbugsin systemsfor whichnosourcecode is available.
we demonstrate not onlythat black box repair isfeasible but that it can scale to real world industrial strength translation systems suchasgoogletranslate.wealsopresentresultsforgrey box repairfor whichthe predictive probability isavailable.
transrepairisevaluatedontwostate of the artmachinetranslation systems google translate and transformer .
in particular we focus on the translation between the top two most widelyspokenlanguages englishandchinese.theselanguageseachhaveover one billion speakers worldwide .
nevertheless only million people in china less than of the population are able to communicateviaenglish .sincesofewpeopleareableto speakbothlanguages machinetranslationisoftenattractiveand sometimes necessary andunavoidable.
our results indicate that transrepair generates valid test inputs effectivelywithaprecisionof99 transrepairautomaticallyreportsinconsistencybugseffectivelywiththelearntthresholds with ameanf measureof0.
.88forgoogletranslate transformer bothgoogletranslateandtransformerhaveinconsistencybugs.
automated consistency metrics and manual inspection reveal that google translatehas approximately36 inconsistent translations on our generatedtestinputs.
black box repair reduces28 and of the bugs of google translate and transformer.
grey box reduces ofthe transformer bugs.
manual inspectionindicates that the repaired translations improve consistency in of the cases reducingitinonly2 andhavebettertranslationacceptability3in27 ofthe cases worse in only approach thissectionintroducestheoverviewandthedetailsofeachstep for transrepair.
.
overview a high level view of transrepair is presented in figure .
from this figure it can be seen that transrepair automatically tests andrepairstheinconsistencyof machinetranslationbased onthe following three majorsteps automatictestinputgeneration.
thisstepgeneratestransformed sentences test inputs to be used for consistency testing.
foreachsentence transrepairconductssentencemutationsvia context similar word replacement.
the generated mutant candidates are filtered using a grammar check.
the mutants that pass thegrammarcheckarethenregardedasthefinaltestinputsforthe machinetranslatorunder test.
detailsare presentedinsection .
.
automatictestoraclegeneration.
thisstepintroducesthe generationoforacles whichareusedforidentifyinginconsistent translations bugs .inthisstep werelyonthemetamorphicrelationshipbetweentranslationinputsandtranslationoutputs.the idea is that translation outputs from both the original sentence anditscontext similarmutant s shouldhaveacertaindegreeof consistencymodulothemutatedword.weusesimilaritymetrics that measure the degree of consistency between translated outputs as test oracles.
details of this step are presented in section .
.
we explore four similarity metrics which are described in section .
.
automatic inconsistency repair.
this step automatically repairs the inconsistent translation.
transrepair applies black box and grey box approaches which transform the original translation basedonthe besttranslation among themutants.
we explore two waysofchoosingthebesttranslation oneusingpredictiveprobability the other using cross reference.
details of this step are given in section .
.
3weuse acceptability tocapturethepropertythatatranslationmeetshumanassessmentof a reasonable aka acceptable translation 975automatic testingandimprovementof machinetranslation icse may seoul republic of korea context similar m utation structural filteringsimilarity analysis probability or cross referencemachine translator automatic test input generation automatic test oracle generation automatic inconsistency repair word vectorword pair librarymutant candidates filtered mutantsoriginal translation mutant translationsfinal translationinconsistency?
yes best translationoriginal sentence wikipedia gigaword ontonotes text corporamachine translator translation mapping figure overview ofhow transrepair tests and repairs machinetranslation inconsistencies.
.
automatictestinput generation the inputgeneration processcontains the following steps.
.
.
context similaritycorpusbuilding.
toconductcontext similar wordreplacement thekeystepistofindaword s thatcanbereplaced with other s similar ones without hurting the sentence structure.thenewsentencegeneratedviawordreplacementshould yieldconsistent translations withthe original.
word vectors capture the meaning of a word through their context .tomeasurethesimilarity weusewordvectorstrained from text corpora.
in our approach the word similarity between two words w1andw2 denoted by sim w1 w2 is computed by the formula below where vxdenotesthe vector ofthe word x. sim w1 w2 vw1vw2 vw1 vw2 toconstructareliablecontext similarcorpus wetaketwowordvector models and use the intersection of their trained results.
the first model is glove which is trained from wikipedia data and gigaword .
the second model is spacy which is a multi task cnn trained on ontonotes including thedatacollectedfromtelephone conversations newswire newsgroups broadcastnews broadcastconversation andweblogs.when twowordshaveasimilarityof over0.
forboth models wedeem the word pair to be context similar and place it in the contextsimilarity corpus.
in total we collected word pairs using this approach.
.
.
translationinputmutation.
we introduce wordreplacement andstructuralfiltering respectively in the following.
word replacement.
for each word in the original sentence we searchtodeterminewhetherthereis amatchinourcorpus.ifwe find a match we replace the word with its context similar one and generate the resulting mutated input sentence.
compared with the originalsentence eachmutatedsentencecontainsasinglereplaced word.toreducethepossibilityofgeneratingmutantsthatdonot parse we only replace nouns adjectives andnumbers.
structural filtering.
the generated mutated sentence may fail to parse because the replaced word may not fit the context of the newsentence.forexample one and another arecontext similar words but a good one parses while a good another does not.
toaddresssuchparsingfailures weapplyadditionalconstraints to sanity check the generated mutants.
in particular we apply structural filtering based on the stanford parser .
suppose theoriginalsentenceis s w1 w2 ... wi ... wn themutatedsentence iss w1 w2 ... w i ... wn wherewiinsis replaced with w iin s .
for each sentence the stanford parser outputs l wi the partof speech tag of each word used in the penn treebank project .
ifl wi nequall w i we remove s from the mutant candidates because the mutation yieldschanges in the syntactic structure.
we manually inspect the quality of the generated inputs and report results in section .
.
automatic testoracle generation toperformtestingweneedtoaugmentthetestinputswegenerate with test oracles i.e.
predicates that check whether an inconsistencybughasbeenfound.todoso weassumethattheunchanged parts of the sentences preserve their adequacy and fluency modulo themutatedword.adequacymeanswhetherthetranslationconveysidenticalmeaning whetherthereisinformationlost added ordistorted fluencymeanswhetherthe outputis fluentandgrammaticallycorrect .
lett s andt s be the translations of sentences sands that were produced by replacing the word w ins withw ins .
thus wewouldliketocheckthesimilaritybetween t s andt s when ignoringthetranslationsforwords wandw .unfortunately itis noteasytostriptheeffectof wandw becausea wandw may change the entire translation of the sentences and b it is not easy to accurately map the words wandw with their respective one s in the translatedtext.
to bypass this problem we calculate the similarity of subsequencesof t s andt s andusethelargestsimilaritytoapproximate the consistency level between t s andt s .
algorithm showstheprocess.for t s andt s wefirstapplygnuwdiff to get the difference slices line .
gnu wdiff compares sentences onwordbasis andisusefulforcomparingtwotextsinwhichafew words have been changed .
with wdiff the difference slices of twosentences abcdf and bbcg hf arerepresentedas a d and b g h for the twosentences respectively.
thediffslicesof t s andt s aresavedtoset bsandbs .we then delete a slice from the translations one at a time line andline9 .eachslicecorrespondstoonesubsequencewiththis slice deleted.
for the example above ab cdf will have two subsequences bcdf deleting a and abcf deleting d .
4long slices are unlikely to correspond to the mutated word we thus only keep slices that arenolonger than words.
976icse may seoul republicof korea sun andzhang et al.
thesenewsubsequencesof t s t s areaddedintoset to tm line andline10 .
for each element in set to we compute its similarity5with each element in the set tm line .
thus we get to tm similarity scores where to and tm is the size of toandtm.
we then use the highest similarity as the result of the final consistency score lines .
thisconfigurationreducestheinfluenceofthemutatedword andhelpsto selectan inconsistencyupper bound.
even if the two subsequenceswiththelargestsimilaritycontainthereplacedword othersentencepartshaveworsesimilarity soitisunlikelythatthis caseis biasedbythe replacedword leads to false positives .
detailsabouttheexperimentalsetupandtheresultsofthethresholdsetuparediscussedinsection4.
.additionally weevaluatethe effectiveness ofourconsistency measurementsvia manualinspection.theseresults are presented insection .
.
algorithm pr ocessof obtaining consistency score data t s translation ofthe originalsentence t s translation of the mutant result conscore consistency scorebetween t s andt s 1bs bs wdiff t s t s 2to t s 3tm t s 4foreachsubsequence bs bsdo 5r deletesub t s bs 6to to r 7end 8foreachsubsequence bs bs do 9r deletesub t s bs 10tm tm r 11end 12conscore 13foreachsentence a todo 14foreach sentenceb tmdo sim computesimilarity a b conscore max conscore sim 17end 18end 19returnconscore .
automatic inconsistency repair wefirstintroducetheoverallrepairprocess thenintroducetwomutanttranslationrankingapproaches probabilityandcross reference .
.
.
overall repair process.
first we repair the translation of the original sentences and then we seek to find a translation for the mutant whichmustpass our consistency test.
algorithm2showstherepairprocess.for t s whichhasbeen revealed to have inconsistency bug s we generate a set of mutants and get their translations t s1 t s2 ... t sn .
these mutants andtheirtranslations togetherwiththeoriginalsentenceandits translation areput intoadictionary t line1 .wethenrankthe 5weexplorefourtypesofsimilaritymetricsinthispaper seefulldetailsinsection3.
.algorithm pr ocessof automaticrepair data s asentence input t s translation of s s1 s2 ... sn mutants of s t s1 t s2 ... t sn translations of the mutants result newtrans repairedtranslation for s 1t s t s s1 t s1 s2 t s2 ... sn t sn 2orderedlist rank t 3a s wordalignment s t s 4newtrans t s 5foreachsentenceanditstranslation sr t sr orderedlist do 6ifsr sthen br eak 8end 9a sr wordalignment sr t sr 10wi wr i getreplacedword s sr 11t wi gettranslatedword wi a s 12t wr i gettranslatedword wr i a sr 13ifisnumeric wi !
isnumeric t wi or isnumeric wr i !
isnumeric t wr i then continue 15end 16tr sr mapback t s t sr s sr a s a sr 17ifnot isnumeric wi andisnumeric wr i then ifstructur e tr sr !
structure t sr then continue end 21end 22ifist est s then so t so getrepair edresult s ifnotisconsistent t so tr sr then continue end 27end 28ne wtrans tr sr 29break 30end 31returnnewtrans elementsin t indescendingorder usingthepredictiveprobabilityorcross reference andputtheresultsin orderedlist line2 .
the details of probability and cross referenceranking are given in section .
.2andsection .
.
.
next we apply word alignment to obtain the mapped words between sandt s asa s line .
word alignment is a natural languageprocessingtechniquethatconnectstwowordsifandonly iftheyhaveatranslationrelationship.inparticular weadoptthe technique proposedbyliuet al.
whichusesalatent variable log linear model for unsupervised word alignment.
we then check whetherasentencepair sr t sr inorderedlist canbeadopted torepairtheoriginaltranslation.wefollowtherankingorder until we find one mutant translation that is acceptable for inconsistency repair.
ifsris the original sentence sr s it means the original translationisdeemedabetterchoicethanothermutanttranslations and so we will not touch it lines .
otherwise we do the same alignment to s1andt s1 as tosandt s .
the variables wi wr i 977automatic testingandimprovementof machinetranslation icse may seoul republic of korea denote the replaced words in s srand we get the translated words t wi t wr i throughthe alignment lines .
word alignment is not accurate.
if we directly map the translation by replacing t wr i witht wi it may lead to grammaticalerrorsorcontextmismatches.weadoptthefollowingstrategies to judge whether the replacement is acceptable.
we constrain thatwi wr iandt wi t wr i must belong to the same type i.e.
numeric or non numeric line .
if the replaced words are of the non numeric type we apply stanford parser to check whether the replacementwouldleadto structuralchanges line .
whenrepairingthetranslationofthemutatedinput line22 wegettherepairedresultoftheoriginalsentence line23 then checkwhetherthetranslationsolutioncandidateisconsistentwith therepairedtranslation ofthe originalsentence line24 .
ifnot we proceedby checking otherrepaircandidates.
.
.
translation ranking based on probability.
for a sentence s and its mutants s s1 s2 ...sn lett s be the translation of s let t si be the translation of mutant si.
this approach records the translation probability for each t si and chooses the mutant with the highest probability as a translation mapping candidate.
the translation of the corresponding mutant will then be mapped back togeneratethefinalrepairedtranslationfor susingwordalignment.
thisisagrey boxrepairapproach.itrequiresneitherthetraining datanorthesourcecodeofthetrainingalgorithm butneedsthe predictive probability provided by the machine translator.
we call this grey box because implementors may regard this probability information as an internalattribute of the approach not normally intendedto be available to end users.
.
.
translationrankingbasedoncross reference.
forasentence sanditsmutants s s1 s2 ...sn lett s bethetranslationof s and lett si bethetranslationofmutant si.thisapproachcalculatesthe similarityamong t s t s1 t s2 ...t sn andusesthetranslation that maps the best with the largest mean similarity score with other translations to map back and repair the previous translation.
thisisablack boxrepairapproach.itrequiresonlytheability to executethe translator under test andthe translation outputs.
experimentalsetup in this section we introduce the experimental setup that evaluates the test input generation translation inconsistency detection and translation inconsistencyrepair.
.
research questions we start our study by assessing the ability of transrepair to generate valid and consistent test inputs that can be adopted for consistency testing.hence we ask rq1 how accurate are the testinputs of transrepair?
we answer this question by randomly sampling some candidate pairs and checking manually whether they are valid.
the answer to this question ensures that transrepair indeed generates inputs that are suitable for consistency checking.
given thatwe found evidence that transrepair generates effectivetestpairs weturnourattentiontothequestionofhoweffective these pairsare at detecting consistency bugs.therefore we ask rq2 what isthebug revealing ability oftransrepair?toanswerrq2wecalculateconsistencyscoresbasedonsimilarity metrics to act as test oracles that determine whether a bug has been detected .
toassess the bug revealing abilityofthe transrepair we manually check a sample of translations and compare the resultingmanual inspection results withautomatedtest results.
havingexperimentedwithfaultrevelation weevaluatetherepair ability of transrepair to see how well it repairs inconsistency bugs.thus we ask rq3 what isthebug repairability oftransrepair?
to answer this question we record how many inconsistency bugs are repaired assessed by consistency metrics and manual inspection .
we also manually examine the translations repaired by transrepair andcheckwhethertheyimprovetranslationconsistency as well as quality.
.
consistencymetrics weexplorefourwidely adoptedsimilaritymetricsformeasuring inconsistency.foreaseofillustration weuse t1todenotethetranslation outputof the original translation input we use t2to denote the translation outputof the mutatedtranslation input.
lcs based metric .it measures the similarity via normalised length ofalongestcommon subsequence between t1andt2 mlcs len lcs t1 t2 max l en t1 len t2 inthisformula lcsisafunctionthatcalculatesalongestcommon subsequence between t1andt2thatappearinthesamerelative order.
for example an lcs for input sequences abcdgh and aedfhr is adh withalength of .
ed basedmetric .thismetricisbasedontheeditdistancebetweent1andt2.editdistanceisawayofquantifyinghowdissimilar two strings are by counting the minimum number of operations requiredtotransformonestringintotheother .tonormalise theeditdistance weusethefollowingformulawhichhasalsobeen adoptedin previous work .
med ed t1 t2 max l en t1 len t2 in this formula edis a function that calculates the edit distance betweent1andt2.
tf idf based metric .tf idf term frequency inversedocument frequency can be used to measure similarity in terms of word frequency.eachword whasaweightingfactor whichiscalculated based on the following formula where cis a text corpus in this paper we use the training data of transformer c is the sentence number in c fwisthe number of sentences that contain w. widf log c fw wethenrepresenteachsentencewiththebag of wordsmodel which is a simplified representation commonly used in natural language processing.
in this model the grammar and the word order is disregarded only keeping multiplicity i.e.
a b c a is representedas a b c namely invector .each dimension of the vector is multiplied with its weight widf.
we calculate the cosine similarity equation of the weighted vectors oft1andt2as theirfinal tf idf basedconsistency score.
978icse may seoul republicof korea sun andzhang et al.
bleu based metric .the bleu bilingual evaluation understudy isanalgorithmthatautomaticallyevaluatesmachinetranslation quality via checking the correspondence between a machine s output and that of a human.
it can also be adopted to compute the similarity between the translation of the original sentence and the translationofamutant.details description andmotivationforthe bleuscorecanbefoundinthetranslationliterature .dueto lack of spacewe only providean overview here.
bleufirstcountsthenumberofmatchedsubsequencesbetween sentences and computes a precision pn which is called modified n gramprecision wherenmeansthesubsequencelength .for example in sentences aabc s1 and abbc s2 thereare three gram subsequences in s2 ab bb andbc.
two of them are matchedwiththosefrom s1 abandbc.thus p2is2 .
as well as pn the calculation of bleu score also requires an exponential brevity penalty factor bp to penalise overaly short translations whichisshownbyformula5.
cdenotesthelengthof t si andristhe length of t s .
bp braceleftbigg1 if c r e r c ifc r the bleu score is finally computed by formula where wn n we usen inthis paper isthe uniform weights.
bleu bp exp parenleftbiggn summationdisplay.
n 1wnlogpn parenrightbigg .
since bleu is unidirectional i.e.
bleu s s nequalbleu s s we use the higher score for measuring the similarity between sand s .thisisconsistentwithourintentioninalgorithm1 togetan upper bound of the consistency thereby avoiding false positive claims abouttranslation bugs.
.
machine translators ourexperimentconsidersbothindustrialandstate of the artresearchorientedmachinetranslators.oneisgoogletranslate abbreviatedasgtintheresultssection awidelyusedmachinetranslation servicedevelopedbygoogle.theotheristransformer atranslatorstudiedby the research community.
we use google translate because it is an example of a system thatforcesustoperformblack boxrepairs wehavenoaccesstothe training data nor the code of thetranslation system and therefore anyimprovements bydefinition canonlyhavebeenachievedby a black box approach.
also of course it is a production quality mainstreamtranslationsystem makingtheresultsmoreinteresting.
we use the default setup to train transformer.
transformer is trained based on three datasets the cwmt dataset with parallel sentences the un dataset with parallel sentences and the news commentary dataset with parallel sentences as the training data.
the validation data tohelptunehyper parameters isalsofromthenewscommentary andcontains2 002parallelsentences.transformerrunswiththe tensor2tensordeeplearninglibrary .togetamoreeffective translator we trainthe modelfor epochs.
.
testset following previous machine translationresearch we use a test set from the news commentary dataset for both google translate and transformer.
the test set contains parallel sentences and are different from the training set and validation set.thechinesesentencesinourexperimentsareintheformof characters.
set6.
our experiments were conducted on ubuntu .
with 256gb ramandfourintele5 2620v4cpus .10ghz whichcontains 32coresalltogether.theneuralnetworksweusedwerealltrained onasinglenvidiatitan rtx gb memory .
results this section reports the results that answer our research questions.
.
effectiveness on input generation rq1 we start by answering rq1.
for each test sentence we generate mutantsandcheckwhethertheypassthestructuralfiltering see more in section .
.
.
in particular for each sentence we generate upto5mutantsthatpassthroughthefilter westudytheinfluence ofthenumberofmutantsinsection5 .forthe2 001testsentences 960mutantcandidatesaregenerated with17 268discardedby structuralfiltering.intherestofourexperimentweusetheremaining mutants which are paired with sentences as test inputs.
to manually assess whether these test inputs are qualified for detectingtranslationinconsistency werandomlysampled400of them.thefirsttwoauthorsmanuallycheckedthevalidityofthe inputs i.e.
whetherthereplacedwordinthemutantleadstogrammatical errors and whether the mutant ought to have consistent translationswiththe originalsentence.thisvalidationstepreveals three invalid mutants he was a kind spirit with a big heart kind sort two earthquakes with magnitude .
and .
respectively two six itis in itselfagreat shame great good.
theremaining397ofthe400meetthetwovaliditycriteria indicatingaprecisionof99 .weconcludethatourtwostrategiesfor theintersectionoftwoword2vecmodels andtheuseofstanford parserasafilterhaveahighprobabilityofyieldingvalidtestsentences.
the mutants and the manual assessment results can be foundonthe transrepairhomepage .
in the next section we use the mutants from the originalsentences toexaminethetesttranslationconsistencyof machine translation systems.
answer to rq1 transrepair has good precision for generatingtestsentencesthataregrammaticallycorrect andyieldconsistent translations.
.
inconsistency revealing ability of transrepair rq2 thissectionanswersrq2 i.e.
investigatestheinconsistency revealing abilityoftransrepair.toanswerthisquestion weinvestigate 6thechinese sentencesin ourexperimentsarein the form of characters.
979automatic testingandimprovementof machinetranslation icse may seoul republic of korea lcs tf idfbleu ed .
.
.
.
.
.
.
.
.
.
consistency metric valuescount figure3 histogramofmetricscores.alargenumberofmutant translations have similarity scores lower than one indicating many inconsistent translations rq2 .
the consistency metric values between the mutant and the original translations the manual inspection results of translation inconsistency.
we also explore how close the consistency metrics and manual inspection are in evaluating inconsistency.
consistencymetricvalues.
wetranslatethe4 692generatedinputs with google translate and transformer and compare them with the translations of the original sentences following the steps of algorithm .
for each mutant we calculate four consistency scores each one corresponding to one of the similarity metrics outlinedin section .
.
figure shows the histogram of consistency scores that are lower than .
.
as can be seen from the figure different metric values have different distributions yet overall all the four metrics reportalargenumberoftranslations i.e.
around47 ofthetotal translations with a score below .
indicating the presence of translation inconsistency.
table1showstheresultsofthereportedinconsistenttranslations withdifferentmetricthresholds.fromtable1 wecanseethatbugs remaineven for highly permissive consistency thresholds.
table1 numberofreportedinconsistencybugswithdifferentthresholdsbetween1.0and0.
.witha1.0thresholdthe translation is deemed buggy if there is any detected inconsistency.thelowerthethreshold themorepermissiveisthe criteriafordeemingbuggy.ascanbeseen bugsremaineven forhighlypermissive consistency thresholds rq2 .
thresh.
.
.
.
.
.6gtlcs ed tf idf bleu transformerlcs ed tf idf bleu manualinspectedinconsistency.
inaddition werandomlysample translations of the mutants.
two of them do not parse so weusetheremaining298translationsforanalysis.foreachmutant the first two authors manually inspected its translation and the translationoftheoriginalsentence.aninconsistencyisreported whenanyofthefollowingcriteriaaremet apartfromthemutated substitute word the two translations have different meanings have differenttones use differentcharacters for proper nouns.
manual inspection reveals inconsistent translations for google translate and inconsistent translations for transformer7.
correlation between metrics and manual inspection.
we compare metric scores and human consistency assessment results.
we split the298human labelledtranslationsintotwogroupsbasedonmanual inspection.
one is labelled as consistent translations the other islabelledasinconsistenttranslations.wethencheckthemetric valuescores in eachgroup.
.
.
.
.0lcs score manual check consistent manual check inconsistent figure comparison of metric scores and manual inspection of translation consistency.
there is a good agreement between metricscore valuesand humanassessment rq2 .
figure4showstheresults8.thepointsontheleft rightofthe dotted vertical line depict the metric values for the translations manually labelled as consistent inconsistent.
we observe that most points .
intheleftsectionhaveascoreof1.
.theleftsectiongenerallyhashigherscorevalues withameanvalueof0.
than the right part with a mean value of .
.
these observations indicatethatthemetricvaluesandmanualinspectiontendtoagree ontranslationinconsistency.itisworthnotingthatfigure4also showssomelowmetricvaluesontheleftsectionandhighmetric values on the right section which indicates the presence of false positives and false negatives of using metrics to assess consistency.
we analyse false positives and false negatives in more detail below threshold learning.
metric scores are continuous values.
to automaticallyreportinconsistency weneedtosetathresholdforeach metric.
in thispaper we choosea thresholdthat lets metric value judgement best resemble manual inspection results.
to do this we randomly sampled another translations from google translate andmanuallylabelthemasconsistentornot.wethenusedthese 7thecohen skappais0.
.95forgoogletranslate transformer indicatingthatthe inspectionresultsarehighlyconsistent.
8thisfigureshows only the lcsmetric.
fullresultsareonourhomepage .
980icse may seoul republicof korea sun andzhang et al.
labels to choose a threshold from .
to .
with a step of .
with the largest f measure score for each similarity metric.
the best thresholds for lcs ed tf idf and bleu identified in this way are .
.
.
.
withf measure scores .
.
.
.
respectively.whenametricvaluefallsbelowtheso identified threshold our approach willreport an inconsistencybug.
to know how well the chosen thresholds capture the boundary betweenconsistencyandinconsistency wetestthethresholdsusingthe298previouslysampledtranslations ongoogletranslate and transformer respectively.
the resultsare shown in table2.
a false positive fp in thetable means thethreshold judges atranslationasinconsistentbutmanualinspectionisconsistent.afalse negative fn in the table means the threshold judges a translation as consistent but manual inspection is inconsistent.
from the table theproportionoffalsepositivesandfalsenegativesareallbelow whichwe deem to be acceptable.
after a manual check of fps and fns we found that an fn may happen when there is a minor character difference but with a different meaning or tone.
for example in our results one mutant translation has an extra er means but which does not exist in the original translation.
manual inspection deemed this to be inconsistent while metrics did not.
an fp may happen when there are many different words in the two translations but they share the same meaning.
for example chinese phrases shang wei and hai mei you both mean not yet but the characters that express eachphraseare totallydifferent.
the harm that an fp in the testing process may bring lies in the possibility that our approach may make the translation worse.
section .
.2explores this possibility.
table precision recallforinconsistency revealing rq2 metric tn fn fp tp precision recall f meas.gtlcs .
.
.
ed .
.
.
tf idf .
.
.
bleu .
.
.81transformerlcs .
.
.
ed .
.
.
tf idf .
.
.
bleu .
.
.
overall number of inconsistency issues.
after identifying the thresholds weapplythemtothetranslationsofthe4 592generated inputs9 and check how many of them fall below the threshold.
it turns out that for transformer the inconsistent translation resultsarelcs ed tf idf bleu .thus overall abouttwofifthsofthetranslationsfall below our chosen consistency thresholds.
for google translate the inconsistent translation results are lcs ed tf idf bleu .
thisalsoshows that googletranslate isslightlybetter than transformer withrespect to consistency.
9we removed those translations used for threshold learning from our test set and used the remaining4 592inputsto conduct testing.table numberand proportionof repaired bugs rq3 .
metric probability cross reference gtlcs ed tf idf bleu transformerlcs ed tf idf bleu answers to rq2 the metrics have an f measure of .
.
when detecting inconsistency bugs for google translate transformer.bothmetricsandmanualinspectionrevealthatgoogletranslatehasapproximately36 inconsistenttranslations ontransrepairtest inputs.
.
bug repair ability rq3 .
.
improvement assessed by metrics.
we apply our repair approachesto allthe inconsistenttranslations and check how many translations can be repaired with our approach.
for each sentence we generate mutants for repair we study the influence of the number of mutants for repairinsection .
table3showstheresults whereeachcellcontainsthenumber andproportionofinconsistencybugsthattherepair approachrepairs.thecolumn probability representstheresultsforprobabilityreference grey box repair the columns cross reference represents the results for cross reference black box repair for google translate since the grey box approach is not applicable we only present the results for the black box approach.
fromthetable transrepairreduces onaverage ofbugsfor theblack boxapproachingoogletranslate.forthetransformer model we cansee the grey box approach repairs of bugs the black boxonerepairs19 to20 ofbugs.theseexperimentalresultsshowthatthegrey boxandblack boxapproachesareeffective at repairing inconsistencybugs.
.
.
improvement assessed by human.
program repair studies typically include a manual assessment process in order to validate their findings.
following a similar practice the first two authors manually checkedtherepairedresultsofthepreviously labelled298sampledtranslations.thegoalwasto checkwhether thechangesintranslationspatchedbyourrepairapproachimprove translationconsistency.sinceourrepairmayalsoimprovetranslationacceptability wealsocheckwhetherthechangesbringany translationacceptabilityimprovement.forcross referencebasedrepair wemanuallyassessedonlythelcsmetricsinceour previous results showedsimilar results among the othermetrics.
amongthe 298sentence pairs ofthem arereported as having translation inconsistency on google translate transformer by metrics.
our repair thus targets all these sentence pairs includingthetranslationsofboththeoriginalsentenceandthemutant.
theprobability basedrepairapproachfinallychanged58 outof 981automatic testingandimprovementof machinetranslation icse may seoul republic of korea pairs for transformer the cross reference based repair approach finally changed out of pairs for google translate transformer.
forthetranslationpairsthathavebeenmodifiedbytransrepair thefirsttwoauthors thenmanuallycomparedtwo dimensions the translation consistency before and after repair the acceptability of the translations for both the original sentence and the mutant before and after repair.
for each dimension the authors gave labels of improved unchanged or decreased consideringbothadequacyandfluency seeexplanationsofthesetwoterms in section .
.
table shows the results.
the first four rows are for google translate.
the remaining rows are for transformer.
the rows with overall show results of translation acceptability improvement among the translations for both original sentences and mutant sentences.
the rows with original mutant show the translation repairresults for original mutantsentences.
weobservethattransrepairhasagoodeffectivenessinimprovingtranslationconsistency.forexample onaverage translation pairs improve the consistency for google translate and transformer while all together we observe only translation consistencydecreases.wecheckedthesedecreased consistencyrepairs and foundthat for one case theoriginalsentence translation has beenimprovedbutnotforthemutanttranslation andthusafter repair theimprovedtranslationoftheoriginalsentencedoesnot match well with the unimproved translation of the mutant.
the remainingtwocasesarisebecausetherepairsoftheoriginalsentences decreased while our approach did not touch the mutant translations.
themainpurposeofourrepairapproachistoimprovetranslationconsistency.translationacceptabilityimprovementisa bonus ofourapproach.fromtable4 perhapstooursurprise therepair approach improves the translation acceptability for around one fourth repairs.
there are repairs with decreased acceptability.basedonourmanualinspection thereasonfordecreased acceptability is that occasionally the repair approach may trade quality for consistency.
answers to rq3 black box repair reduces on average bugs for google translate transformer.
greyboxrepairreducesonaverage30 bugsfortransformer.
human inspection indicates that the repaired translations improve consistency in of the cases reducing it in andhavebettertranslationacceptabilityin27 ofthe cases worse in .
extended analysisand discussion this section providesfurther details andanalysis.
exampleofrepairedtranslations .table5givessomeexamples of our improvement of mistranslation.
the first column is the translationinput thesecondcolumnshowstheoriginaltranslation 10the mean kappa score is for labelling translation consistency between the two humanlabels .97forlabellingthetranslationoftheoriginalsentence and0.81for labelling the translation of the mutantsentence.table improvement based on manual inspection rq3 aspect improved unchanged decreasedgt.lcstranslation consistency translation acceptability overall translationacceptability original translationacceptability mutant trans.lcstranslation consistency translation acceptability overall translationacceptability original translationacceptability mutant trans.probtranslation consistency translation acceptability overall translationacceptability original translationacceptability mutant output convertedtopinyin where wordsin italic explainthe mistranslated parts the last column shows our improvedtranslation.
effectiveness and efficiency of data augmentation .previousworkhasadopteddataaugmentationtoimprovetherobustness of machine learning models .
in our work concerning translators whosesourcecode isknown training data augmentationis alsoacandidate solution to increasetranslation consistency.
to investigate this option we designed experiments to study whetheraddingmoretraining datawouldyieldbettertranslation consistency.wecontrolledthetrainingdatasizeandused10 ... and of the original training data to build transformer respectively.figure5showstheresults.whenthesizeofthetraining data ratio is between .
and .
we did not observe a decreasingtrend.thisindicatesthataugmentingtrainingdatamayhave limited effectiveness inimprovingtranslation inconsistency.
.
.
.
.
.
.
.
.
ratio of training dataratio of bugs figure5 ratioofinconsistencybugswithdifferenttrainingdata size fortransformer.
dataaugmentationneedsmodelretraining.wefoundthatusing training data to train the translator model took as much as 19hoursunderourcurrentexperimentalconfiguration seemore details in section .
in practice data collection labelling and processing also needs time.
all together we find little evidence that augmentation is a complete solution to this translation repair problem.
comparedwithmodelretrainingapproachesliketrainingdata augmentation transrepair has the following advantages transrepair require neither the source code nor training data and is 982icse may seoul republicof korea sun andzhang et al.
table examples ofrepaired translations.
input original translation repairedtranslation femalestudentsdo goodresearchincomputerscience.
n xueshengzaijisuanjikexuefangmianzuole henduoyanjiu n xueshengzai jisuanji kexue fangmian zuole henhaodeyanjiu ifyouneedhelp youcanenjoytimelyservicesbypressinganearby oneofthe41call buttonsin thestation.ruguonixuyaobangzhu nikeyitongguoanfujin de41gehujiaoanniuxiangshoujishidefuwu.
bug one of isnot translated.
ruguonixuyaobangzhu nikeyitongguoanfujinde41 ge hujiao anniu zhong de yige lai xiangshou jishi de fuwu.
originaltitle canadapolicekill issupporters preparationsforhomemadebombdowntownattacknear theend.yuanshi biaoti jianada jingcha sha le wo de zhichizhe weihemazhizaobaozhadezhunbei.
bug is my .
yuanshibiaoti jianadajingchashalu iszhichizhe wei hema zhizaozhadan dezhunbei.
banpoliticalcampaignersandactivistsfromhandling completed postalvotesandpostalvote envelopes.jinzhi zhengzhi jingsuanzhe he huodongfenzi chuli wande youzheng xuanpiao he youzheng xuanpiao xifeng jinzhizhengzhijingsuanzhehehuodongfenzichuli yi wancheng deyouzhengxuanpiaoheyouzhengxuanpiao xifeng.
table6 numberofdetectedandrepairedbugswithdifferent numb erofmutants.
metricmutantnumber for testing mutantnumber for repair lcs ed tf idf bleu either completely black box or requires only predictive probability grey box transrepair can have lower repair cost since it does not need additional data and does not require model retraining transrepairismoreflexible becauseitenablestherepairofa specific bugwithouttouchingotherwell formed translations.
efficiency of transrepair .the cost of transrepair includes bothtestingand repair.underourcurrentexperimentalconfiguration seemoredetailsinsection3 themeantimefortestingis .97spersentence themeantimeforrepairis2.68spersentence fortheprobability basedapproach and2.93sper sentence forthe cross reference basedapproach.thus withcurrentexperimental configuration whenusingtransrepairtooptimisethereal timeonline machine translation for a sentence that is deemed non buggy it wouldtakeless than 1second for theend usertoreceiveafinal translation.
for a sentence that is deemed buggy it would take less than4 seconds testing andrepair to getafinal translation.
influence of mutant number .we generate mutants during bothinconsistencytestingandrepair.forthetest repairprocess our default configuration generates atmost 16mutantsfor each sentence.
to investigate how the number of mutants affects the testing and repair performance we repeat our experiments with or3 mutantsfortest generation andwith4or8 mutantsforrepair.
wethencomparethenumberofrevealedinconsistencybugsand the number of bugs that our approaches repair.
for repair we only present results of grey box repair approach in the paper due to space reason as shown by table .
the full results are available on our homepage .
we observe that during testing using more mutants helps to reveal more inconsistency bugs.
it is the same for repair but using mutants during repair also has an acceptable effectiveness.application scenario .transrepaircanbeappliedendtoend.
givenatranslationinputandamachinetranslator ourapproach will automatically test and repair the translation output and give a new translation outputto the end user.
related work software testing research has typically targeted traditional nonmachine learning based software systems.
however the recent rise in the real world importance of machine learning has resulted inaconcomitantriseinthelevelofresearchactivityinsoftware testing for machine learning .
at the same time software repairconceptsandtechniques remainrelativelyunder explored formachine learning systems.in this section we review therelationshipofourproposedmachinetranslationtestingand repairwithpreviousworkontestingandrepairmachinetranslation systems whichmainly focusontranslation robustness.
translation robustness testing .to test translation robustness researchershaveexploredhowperturbationsonthetestinputs affect translations.
heigold et al.
studied three types of character level noisytestinputsthataregeneratedviacharacter swapping word scrambling and character flipping.
they found that machine translation systems are very sensitive to slightly perturbed sentences that do not pose a challenge to humans.
belinkov and bisk had a similar conclusion not only on synthetic noise but also on natural noise naturally occurring errors like typos and misspellings .tohavemorediversetestcasesforrobustnesstesting zhaoetal.
usedgenerativeadversarialnetworks gans .
they projected theinput sentence to a latent space which is then usedfor searching for test sentences close to the input.
theseworktargetsrobustnesstesting.thetestinputsaresynthetic errors or naturally occurring errors.
the test oracles are usually bleu scores which are bounded with human oracles.
our approachtargetstranslation consistency andwe generateconsistent test inputs by context similar word replacement instead of involvingerrors.ourapproachalsodoesnotrequirehumanoracles duringtesting.
sunandzhou proposedmetamorphicrelationsformachine translation.therearetwomajordifferencesbetweenourworkand theirs theirworkconcernstestingonly wealsorepair their testinput generationmerely replaceshumannamesbefore likes or hates and brands after them our approach is comparatively more exhaustive.
983automatic testingandimprovementof machinetranslation icse may seoul republic of korea translation robustness improvement .to improve translationrobustness previousworkrelieslargelyondataaugmentation i.e.
to add noisy data into the training data and to retrain the model.someworkusedmodel independentdatageneration also called black box data generation .
heigold et al.
belinkov and bisk andsperberetal.
usedsyntheticnoisetoretainthe model.karpukhinetal.
evaluatedtheimpactofpercentages of syntheticnoiseto the training set.
someworkusesmodel dependentdatageneration white box datageneration .ebrahimietal.
introducedanapproachthat relies on an atomic flip operation.
this operation generates tests byswappingcharactersbasedonthegradientsoftheinputvectors.
cheng et al.
proposed a gradient based method to generate adversarial sentences byconductingwordreplacement.
there is also work on improving robustness via optimising the learning algorithms.
belinkov and bisk proposed to use a structure invariant representation for synthetic noise in the network.theyfindthatacharactercnnrepresentationismorerobust thanothers.chengetal.
introducedstabilitytrainingbyadding anewcomponentfordiscriminatingthenoiseinthetrainingset.
thiscomponentreducestheimpactofthenoise andyieldsmore stable translations when makingsynonymousperturbations.
these previous approaches target overall robustness improvementforalltranslations ratherthanfixingspecificmistranslations.
conclusion in this paper we presented transrepair the first approach that automaticallytestsandimprovescontext similartranslationconsistency.transrepairtakesasentenceandappliesacontext similar mutation to generate slightly altered mutated sentences to be usedtotestmachinetranslationsystems.testingisperformedby translatingandcomparingtheoriginalwiththemutatedsentences.
tojudgeconsistency transrepaircalculatesthesimilarityofthe translation subsequences.
when context similar mutations yield above thresholddisruptiontothetranslationoftheunchangedpart transrepairdeemsthis tobe apotentialbug.
inadditionto testing transrepairalsoautomaticallyrepairsinconsistenciesinablackbox or grey box manner which post processes the translations withreference to the translations ofmutatedsentences.
acknowledgement zeyusunandluzhangaresupportedbythenationalkeyresearch anddevelopmentprogramofchinaundergrantno.2017yfb1001803.
jiem.zhangandmarkharmanaresupportedbytheercadvanced grant with no.
.
mike papadakis is supported by the luxembourgnationalresearchfunds fnr c17 is codemates.