ccgraph a pdg based code clone detector with approximate graph matching yue zou schoolofcomputerscienceandtechnology universityof science and technology of china hefei china zy1996 mail.ustc.edu.cnbihuan ban school of data science university of science and technology of china hefei china banbihua mail.ustc.edu.cn yinxing xue schoolofcomputerscienceandtechnology universityof science and technology of china hefei china yxxue ustc.edu.cnyun xu schoolofcomputerscienceandtechnology universityof science and technology of china hefei china xuyun ustc.edu.cn abstract softwareclonedetectionisanactiveresearcharea whichisvery importantforsoftwaremaintenance bugdetection etc.thetwo pieces of cloned code reflect some similarities or equivalents in the syntaxorstructureofthecoderepresentations.therearemanyrepresentations of code like ast token pdg etc.
the pdg program dependency graph of source code can contain both syntactic and structuralinformation.however mostexistingpdg basedtoolsare quitetime consumingandmissmanyclonesbecausetheydetect code clones with exact graph matching by using subgraph isomorphism.
in this paper we propose a novel pdg based code clone detector ccgraph thatusesgraphkernels.firstly wenormalize the structure of pdgs and design a two stage filtering strategy by measuring the characteristicvectors of codes.
then we detectthe code clones by using an approximate graph matching algorithm based on the reforming wl weisfeiler lehman graph kernel.
experimentresultsshowthatccgraphretainsahighaccuracy has both better recall and f1 score values and detects more semantic clones than other two related state of the art tools.
besides ccgraphismuchmoreefficientthantheexistingpdg basedtools.
ccs concepts softwareanditsengineering softwaremaintenancetools .
keywords clone detection program dependence graph wl graph kernel also with key laboratory on high performance computing anhui province.
yinxing xue and yun xu are the corresponding authors.
also with key laboratory on high performance computing anhui province.
permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed forprofitorcommercialadvantageandthatcopiesbearthisnoticeandthefullcitation on the first page.
copyrights for components of this work owned by others than acm mustbehonored.abstractingwithcreditispermitted.tocopyotherwise orrepublish topostonserversortoredistributetolists requirespriorspecificpermissionand ora fee.
request permissions from permissions acm.org.
ase september virtual event australia association for computing machinery.
acm isbn ... .
reference format yue zou bihuan ban yinxing xue and yun xu.
.
ccgraph a pdgbasedcodeclonedetectorwithapproximategraphmatching.in 35thieee acm international conference on automated software engineering ase september virtual event australia.
acm new york ny usa pages.
introduction softwaredevelopmentoftenhasthephenomenonofcopyingsimilar or identical code fragments from the existing source codes called code clones .
existing research shows that code cloning is veryimportantinthesoftwaredevelopmentandmaintenance likesoftwarerefactoring bugdetection copyrightplagiarism detection code evolution analysis.
in the various kinds of code clone detection approaches pdg program dependency graph basedapproachescanfindthecodeclonesbothinsyntactic similarity and semantic similarity.
as bellon et al.
noted pdg based approaches can also report non contiguous clones that cannot be perceived by other techniques.
however most pdg based approaches consume too much time because they matchgraphs exactly by using subgraph isomorphism since this is an np hardproblem .besides inexistingpdg basedapproaches manyofthecodeclonesaremissedduetousingexactorveryclose subgraphisomorphism.therefore notonlythepdg basedcodeclone detector with approximate graph matching can find more codeclones butalsomaketheprocessingtimefaster.inaddition there are some deep learning s such as oreo which encode softwaremetricsincludingpdgmetricsintovectorsandachieve good results.
however these methods are dependent on the initial training data and lack the interpretability of output results.
amongthesepdg basedapproaches liuetal.
proposeda classicpdg basedclonedetectionbyusingthevfsubgraphisomor phismalgorithm.andtheydidnotperformanyfilteringoperations onpdgcandidatesets.sincethevfsubgraphisomorphismalgorithm belongs to the method of exact graphs match this resultsin the expensive time cost.
for the issue of the high complexityof subgraph isomorphism gabel et al.
proposed a method ofmapping pdg to ast and used the similarity of ast to replace the similarity of pdgs.
although this metho dspeedsu p the clone detection itlosesalotofsemanticinformationandresultsinmany 35th ieee acm international conference on automated software engineering ase ase september virtual event australia yue zou bihuan ban yinxing xue and yun xu public static void loop1 int maxsize int index while index maxsize system.out.println index index a the source code of loop11 public static void loop2 int count int loopsize count for int i i loopsize i count i system.out.println i b the source code of loop2 figure the pdg based clone pair for loop printing.
index system.out.println index int maxsize index maxsize int index a pdg for loop1 int i i system.out.println i int count i loopsize int loopsize count count i b pdg for loop2 figure two pdgs for loops in figure .
missingclones.furthermore for theissueoflargepdgcandidate sets bothlietal.
andwangetal.
adoptedsomestrategies to modify the pdg and reduce the size of pdg candidate sets like removing irrelevant nodes and edges.
however they still do not avoid solving the issue of subgraph isomorphism directly.
besidestheprocessingtime therearemanyclonesmissedfor existingpdg basedapproaches.forexample thepdgsoftheoriginalandtheclonecodearegiveninfigure1.bothofthecodepieces implementthesamefunctionofloopprinting.however oneuses awhileloop and the other one uses a forloop and there are some otherdifferentstatements.fromthepdgsshowninfigure2 there isnoexactsubgraphisomorphismbetweenthetwopdgs butthere are some local similarities.
as we can see the diamond nodes in two graphs have similar outgoing and inbound edges.
moreover they have similar neighbor nodes which are assignment or declarationstatements andtheyhavesimilarcontroldependencieswith their neighbors.
also there are some other local similarities in the two pdgs which are not described in detail here.
however the existing pdg based methods cannot detect these local similarities.
therefore we adopt the approximate graph matching algorithm to detect these local similarities which are a kind of approximated pdg based code clones.
the approximate graph matching algorithms are mainly divided into two classes graph embedding and graph kernel methods .
graph embedding methods embed a graph into a low dimensional vectorbasedonthecharacteristicsofthegraph whichcanquantitativelymeasurethesimilaritybetweennodesandismoreconvenienttoapply.however thisdimensionalityreductionprocesslosesalotofgraphstructuralinformationandseverelyaffectstheaccuracy of the graph matching.
the graph kernel methods divide a graph into several sub structures as kernels and then calculate the similarity of the two graphs through their sub structures.
different decomposition methods and substructures correspond to different types of graph kernel methods.
for example the wl weisfeilerlehman graph kernel collects the labels of the adjacent nodes of each node in two graphs and measures the similarity of twonodes according to the similarity of the labels.
the more similarnodes in two graphs the closer the two graphs are.
this kind of methodnotonlyretainstheadvantagesofthelowcomputational costofthekernelfunctionbutalsocontainsvarioustypesofgraph informationsuchasdirectededgesandlabels.therefore thewl graph kernel is very suitable for calculating the similarity between pdg pairs.
besides the approximate graph matching based ongraph kernels has been successfully applied in the fields of humanfacerecognition networkanalysis andcompound classification .
inthispaper weproposeanovelpdg basedcodeclonedetector calledccgraph whichcanfindmorepdg basedclonesthanothertoolsandismuchfasterthanthosepdg basedtools.thisapproach reducesthesizeoftheoriginalpdgsatfirstandthenfilterspdg pairsbyatwo stagestrategywithcharacteristicsimilarities.finally ccgraph identifies clone pairs by an approximate graph matching algorithm based on wl weisfeiler lehman graph kernel algorithm.tosumup ourstudymakesthefollowingcontributions weadoptanapproximategraphmatchingalgorithmbasedon thewlgraphkernel.wlgraphkernelsortsandcompressesthe 932ccgraph a pdg based code clone detector with approximate graph matching ase september virtual event australia labels of all adjacent vertices of each node in each iteration andwecancalculatethesimilarityoftwographsbycomparingthe numberofsimilarnodesingraphs.wedesigntheiterationtimes accordingtothegraphdiameterandaddtheweightofeachiteration consideringthedistanceofthenodes.ourtoolcanacceleratethe comparison ofgraph similarityand detect moreclones thanstateof the art tools.
in the preprocessing stage we design a two stage filtering algorithm.first wecountsomenumericalcharacteristicsofpdg forroughfilterings suchasthesizeofpdg andclassifythesimilar pdgsintothesamecategory.then foreachcategory wecalculate the similarity of string characteristics like function names based onjarowinkler distance .besides weoptimizethestructure of pdgsby eliminating andmerging some irrelativenodes.
these strategies can reduce the size of candidate clone pairs greatly.
we present the whole pdg based clone detector called ccgraph reduce the candidate clone pairs scale in the preprocessing stage and adopt the approximate graph matching algorithm.
it can detect more pdg based clones than the latest clone detector oreo basedondeeplearningforjavaandbemuchfasterthanthe latest pdg based clone detector ccsharp for c code.
the rest of this paper is structured as follows.
section introducessomeconceptsanddefinitionsusedinourresearch.section3describesthedetailsofthemethodsproposedinourclonedetectionprocess.section4showstheimplementationandexperimentofour toolagainstsomeotherstate of the arttoolsonsomecodebases.
section and summarize the related work and discuss the limitationsofourapproach.finally section7concludesthepresent work with a discussion of future work of ccgraph.
preliminaries and definitions in this section we give the definitions of some important concepts andnotationsused inthedetectionwork likepdg subgraphisomorphism andthewlgraphkernelwhichisusedinourproposed method.
we also give the definitions of pdg based clones we need to detect.
.
program dependency graph aprogramdependencygraph pdg isalabeledanddirectedgraph ofthesourcecodetoshowsomedependencieslikefigure2.the nodesinpdgcanbeclassifiedintothesystemandstatementnodes.
thesystemnodesaregeneratedfrompdggenerationtools like function entrance or exit nodes which is not the specific code statement.thestatementnodesincludeeachstatementanditstype for them.
theedgesshowsomedependenciesbetweenstatementnodes suchasthedataandcontroldependencies.thecontroldependencyedge is from a control node to a next node if the condition controls thatthenextnodewillbeexecuted.thedatadependencyedgeis between two nodes that they all use the same variable or one of themassignsthevariableandthenothersuseiteitherdirectlyor indirectly like pointers.
there is one more dependency edge called executiondependency whichisbetweentwonodesifoneofthe nodes may only be executed after the other one.definition2.
.
programdependencygraph thepdgforacoding program is represented as g v e wherevis the set of nodes in the graph eis the set of edges in the graph v s isafunctionassigningtypestonodesinthegraph e sisa function assigning dependency types to edges.
.
subgraph isomorphism recently manypdg basedclonedetectionsdefinetheclonepair ofprogram pandp primeifandonlyifthereisasubgraphisomorphism relationship amongtheir pdgs.
themathematic definition ofsubgraph isomorphism is defined as below.
definition2.
.
graphisomorphism g1 v1 e1 1 1 isagraph isomorphismto g2 v2 e2 2 2 ifandonlyifthereisabijective function f v1 v2andf v2 v1satisfying 1 v 2 f v for any v v1.
e v1 v2 e1 e prime f v1 f v2 e2such that e e prime .
e v1 v2 e2 e prime f v1 f v2 e1such that e prime e .
definition .
.
subgraph isomorphism g1 v1 e1 1 1 is a subgraph isomorphism to g2 v2 e2 2 2 if and only if there is an injectivefunction f v1 v2thatthereisasubgraph s g2such thatfis a graph isomorphism from g1tos.
.
weisfeiler lehman graph kernel mathematically the method of graph kernels maps graphs to a vector feature space and calculates the graph similarity by their innerproductinthevectorfeaturespace.intheprocessofcalculating itdividesagraphintosubstructures andanycombinationof graph decomposition and substructure isomorphism judgment can be defined as a new graph kernel.
definition .
.
graph kernel gis a finite set of graphs ris a pointproductspaceandthefunction k g g risagraph kernel then there is a hilbert space fand a mapping function g f for all g1 g2 g k g1 g2 g1 g2 where means the inner product in hilbert space.
generally given two graphs g1 g2 and the substructures sequences s1 s1 ... s1 n1 ofg1and s2 s2 ... s2 n2 ofg2 where s1 iis the ithsubstructure of g1ands2 jis the jthsubstructure of g2 the graph kernel of g1andg2can be expressed as kr g1 g2 n1 summationdisplay.
i 1n2 summationdisplay.
j 1 s1 i s2 j where s1 i s2 j when s1 iands2 jare isomorphism else s1 i s2 j .
definition2.
.
weisfeiler lehmangraphkernel giventwographs g1 v1 e1 1 1 andg2 v2 e2 2 2 anditerationnumber h after the hthtime s iteration of wl subtree isomorphism algorithm we get the structures of two graphs as g1 h g1 lh g1 and g2 h g2 lh g2 .and lh g1 isthesetofnodelabelsfor g1in 933ase september virtual event australia yue zou bihuan ban yinxing xue and yun xu a given pdg g and g b multiple set label sorting c lable compression d reassignment of node labels figure computation of the wl graph kernel for one iteration the iteration h the wl graph kernel is expressed as k h wl g1 g2 k g1 g2 ... k g1 h g2 h k g1 h g2 h is the base kernel function of g1andg2 which calculates the number of same label pairs in node label sets lh g1 andlh g2 .
weisfeiler lehman wl graphkernel isanadvancedgraph kernel in recent years.
as shown in figure the wl graph kernel sorts the labels of all adjacent vertices of each node compresses these labels into a new shorter label based on a hash algorithm and then counts the same original and compressed labels in two graphs.afteroneiterationofcomputation thecompressedlabels denotesubtreepatternsorsub structuresinthegraph.forinstance in figure a the node denoted as v with label in g and the same label node denoted as v prime in g have same neighbor nodes with label and .
after collecting the neighbor node labels bothofthelabelsequencesof vandv primeare2 whichisshown infigure3 b .thenafterthelabelcompressionshowninfigure c thenewlabel of vandv primeis13.
afteroneiteration ofthewl graphkernelcalculating infigure3 d the vandv primehavethesame label which means that the local graph structures around vand v primeare the same.
when most of the nodes of the two graphs have thiskindofsimilarity wethinkthatthetwographsareverysimilar.
.
similarity of graphs based on wl graph kernel after the approximate graph matching we need to distinguish whether the original code fragments are clones according to the kernel value we calculated.
hence we need to define a measure ofsimilarity based on the wl graph kernel value after normalizing.
definition .
.
the similarity of pdg pairs given two program dependencygraphs g1 v1 e1 1 1 andg2 v2 e2 2 2 wemeasure the similarity of pdg pairs by the htime s iterations of wl graph kernel value as similarity g1 g2 k h wl g1 g2 v1 v2 the similarity value is between and and the code fragments ofg1andg2arecode clone whenthe similarity g1 g2 isbigger than the predefined threshold t. proposed method in this section we introduce the overview of the proposed method ofclonedetectionfirstlyandthendescribethedesignofthesimplification of pdg structures the characteristic vector extraction the filtering strategies and the approximate graph matching algorithm based on the wl graph kernel in details.
.
overview the overview of our proposed method is shown in figure .
it consistsoftwoprocessphases codepreprocessingandclonedetection.
codepreprocessinganalyzesthesourcecodefiles extractspdgsin functionlevel simplifiesthepdgstructures andfiltersthecandidate pdg pairs by characteristic vectors.
clone detection measures the similarity by calculating the wl graph kernel values of pdg pairsandidentifiesthecodecloneifpdgpairssatisfythethreshold condition.
934ccgraph a pdg based code clone detector with approximate graph matching ase september virtual event australia pdg pairs source program filespdg generationsimplification and filtering clone candidatesapproximate graph matching based on wl graph kernel clone pairsverifying preprocessing clone detectionprogram dependency graphs figure the overview of the proposed method.
.
simplification of pdg structures in the pdg generation we observed that there are a large number of system nodes and edges which are not related to code semantic information.
also there are some sub pdgs which link to other functionsbecauseoffunctioncallsinsourcecode.therefore we proposed two strategies to simplify the structure of pdgs eliminating meaningless nodes and merging function call sub pdgs.
.
.
eliminate meaningless nodes.
in the process of pdg generation systemnodesandsomeassistantparameternodesaregeneratedautomaticallybythepdggenerationtools.thesenodesdonot affecttheoriginallogicalstructureofthesourcecode.therefore we simply remove these nodes and the edges connected to them to reduce the size of pdgs.
.
.
mergefunctioncallsub pdgs.
inthepdgsofsourcecode the calls to other functions are plotted as a sub pdgs.
considering that the codes corresponding to these sub pdgs are not in the current file we simplify to merge the sub pdg part to one function callnode.thismergingoperationdoesnotloseanystructureinformationoftheoriginalpdgbutgreatlyreducesthesizeofpdgs.
we name the new node type fun callto represent the function call sub pdgs in original pdgs.
.
filtering of pdg pairs clonedetectionmakespdgpair wisecomparison andthescaleof pdg pairs increases exponentially with the number of pdgs.
therefore it isnecessaryto filterpdg pairsforreducing thetime consuming of clone detection.
we mainly filter pdg pairs from two aspects.
on the one hand we consider the size of pdg directly such as the number of nodes and edges in pdgs.
and for the case that the scale ratio of the two graphs is too big we filter these pdg pairs as other cloning detectionmethods.ontheother hand weadoptthefilteringstrategies accordingtosomeimportantinformationinpdgs suchasthedata type of input and output.
the overall pdg s characteristics are listed in table and the filtering process is structured as following subsections which is also shown in algorithm .
.
.
numericalsimilarityfiltering.
forthenumericalpartofthe characteristic vector we filter pdg pairs by the size of pdg and scale ratio firstly then calculate the cosine similarity between two numerical vectors.
pdg pairs are divided into categories according to their numerical similarity.algorithm characteristic vectors filtering input pis a character vector of code pdg g.p primeis a character vector of code pdg g prime.lis the threshold of node number in pdg characteristic.
tis the threshold of pdg pair s scale radio.
gsis the threshold of the string similarity and gnis thethresholdofthenumericalsimilarityofthecharacteristic vectors.
output ris the candidate pdg pairs for the clone detection function filter g g prime p p prime l t gs gn foreach code pdg gandpin clone codes do foreach code pdg g primeandp primein clone codes do ifsizeof g lorsizeof g prime lthen pdg pair g g prime is filtered else if min g g prime max g g prime tthen pdg pair g g prime is filtered else ifnumber similarity of p p prime gsthen r r g g prime continue else ifstring similarity of p p prime gnthen r r g g prime end if end for end for end function table the characteristic vector of pdg numerical characteristics description numofctrledges the control dependency edges.numofexcedges the excute dependency edges.numofdataedges the data dependency edges.
numofdeclnodes the variable declaration nodes.
numofassignnodes the assignment nodes.numofctrlnodes the control nodes.numofstatenodes the function state nodes.numofothernodes other types nodes.numofreference the number of reference variables.
string characteristics description returnpara the return parameters.
intropara the incoming parameters.
name the function name.
935ase september virtual event australia yue zou bihuan ban yinxing xue and yun xu sizefiltering intherealcodedataset manyfunctionsonly have a return statement.
this kind of clones has no reference value for practical application.
so we focus on those pdg pairs which have meaningful size.
and in the detailed implementation we set the sizethresholdas lines which is also a common filter standard of other clone detections like ccaligner .
scale ratio filtering we need to match pdgs in pairwise andthepairhavenopointinthereal worldifthescaleratio of two pdgs is too big like one pdg size is times than the other one.
we filter the pairs if the scale ratio of the two pdgs is bigger than the specific threshold.
numerical similarity filtering we extract the numerical vectorsaccordingtothecharacteristicsofpdgslikethenumber ofdifferentkindsofnodesandedges.nodetypesaredivided into a variable declaration assignment control statement function call and other kinds of statements.
connecting edges are classified as control dependency edge data dependencyedge andexecutiondependencyedgeaccordingtothe dependencyrelationship.
thenwe filterthose pdgpairs if thecosinesimilarityoftwovectorsdoesnotmeetthethresh oldweset.accordingtotheresultsofrepeatedexperiments we set a threshold of .
for numerical similarity filtering.
.
.
string similarity filtering.
in the characteristic vectors of pdgs somedimensionsarestringvariables likethefunctionname input parameters output variables.
for each category classified bynumericalsimilarity weneedtocalculatethestringsimilarity between these string part of vector to filter some pdg pairs.
since thestringpartsofvectorsareshortstringsandthe jarowinkler algorithmhasagreateffectonshorttextsimilaritycalculations wechoosethe jarowinkler distanceratio tomeasurethe stringsimilarity.thejaro winkleralgorithmgivesthestartingpart a higher score for the same string which defines a prefix range p.forthetwostringstobematched theprefixparthasthesame lengthasthepartialstringoflength l.consideringthediversity of string variables in reality we only filter those pdg pairs which jarowinkler distance ratio less than .
.
jaro distance jaro distance djof given strings a bisdj m a m b m t m themisthenumberofmatchingcharacters and tis half the number of transpositions a and b is the length of string aandb.
jarowinklerdistance jarowinklerdistance dwofgiving strings a bisdw dj l p dj djisthejarodistance of givenstrings aandb lis thelength of the prefixpartial match pisarangefactorconstantusedtoadjusttheweight of the prefix match but the value of pcannot exceed .
because the final score may exceed point.
the standard default setting of jarowinkler isp .
.
.
approximategraphmatchingbasedonwl graph kernel after the simplification of pdg structures and the filtering of pdg pairs we adopt the approximate graph matching algorithm to measure the similarity between the pdg pairs.considering the specialty of pdgs we choose to implement the approximate graph matching algorithm based on the wl graphkernel.
in all kinds of graph kernels the wl graph kernel canbe applied to directed and labeled graphs and it can process the attributesofnodesingraphs.wlgraphkernelhasabettertimeconsuming performance than the traditional kernels like randomwalkorshortest pathgraphkernel .also thereareopensource implementations of wl1graph kernel used in bioinformatics to compare protein structure and we can easily apply it to our tool withasecondarydevelopment.sincethewlgraphkernelhasgreat classificationperformanceanditisoneofthebestgraphkernels at present we choose to adopt our approximate graph matching algorithm based on wl graph kernel.
algorithm clonedetectionwithwlgraphkerneltestingof two graphs input thepdgpair g g prime allnodes vandlabels l v ofving andg prime n v isthesetof v primesneighbornodes misthenumberof iterationsofwlalgorithm tisthethresholdofpdgsimilarity ofgandg prime.
output ris the result set of pdg pairs after the clone detection function clone g g prime v l v n v m t foreach pair g g prime in candidate pairs do forithiteration in mtimesdo foreach node vingandg primedo m v summationtext.
l u u n v s v m v sorted by ascending order s v l v s v l v f s v when f summationtext.
summationtext.
statisfy f s v f s w if and only if s v s w end for wi m i m ki sizeof samelabel v sizeof total v end for k summationtext.
ki wi ifk tthen r r g g prime end if end for end function thestepsofourproposedalgorithmaredescribedindetailas following and shown in algorithm hash the label of each node in the pdg according to the grammar category as the initial label of the node.
set the hiterations for the wl algorithm.
in the hiterations each iteration collects the labels of the current node s neigh bors as a sequence and compresses the label sequence into a new label by using a local sensitive hashing algorithm.
ifthelabelsofthetwonodesarethesameaftertheiteration it is considered that the subtrees with the two nodes as the root node and the height of hare isomorphic.
936ccgraph a pdg based code clone detector with approximate graph matching ase september virtual event australia calculatethenumberofsamenodepairsbetweentwopdgs which is also the graph kernel value.
if the graph kernel values of the two pdgs satisfy the threshold range the two pdgs are considered as pdg based code clone candidates.
furthermore considering the different diameters of different clonepdgs wedynamicallysettheiterationsnumberaccording tothediameterofthesmallerpdg andcountthenumberofnodes with the same label between pdgs after each iteration.
besides weaddthe weightfactor h n htothe nthiterationtogive higher weight to the lower iterations because each node in source code is more affected by its neighbors than the nodes far away.
.
verifying after the approximate graph matching based on the wl graph kernel we get the kernel value of pdg pairs.
this step is to verify whether the candidates are code clones.
for each pdg pair we calculate the wl graph kernel value k h wl g1 g2 in the approximate graph matching and we measure thesimilaritybytheratioofthekernelvaluetothetotalnumberof nodesintwopdgsshownin section2.whenthesimilarityexceeds the threshold we set before we consider the code fragments of the pdgpairare code clone .tofurtherverifywhethertwopdgsare cloned or not we use the asymmetric coefficient ofdice similarity from another point of view which is defined as follows sim g1 g2 k h wl g1 g2 min v1 v2 .
where v1andv2arethenodesetsofpdg g1andg2.thesimilarity threshold is chosen with the best results among plenty of repeated experiments.
therefore we verify the two pdgs are code clones when their similarity is greater than or equal to .
.
evaluation in this section we design and implement the experiments of ourclonedetectionccgraphandempiricalevaluationagainstotherstate of the art clone detectors.
firstly we begin by introducing theenvironmentconfigurationofourexperiments.weintroduce the datasets used in experiments in detail and explain the reasons for choosing these datasets.
.
experimental configuration since most current pdg based clone detectors are commercial thatisnotopensource wechoosetheopensourceandexecutabletoolstobecomparedwithourapproach.forccode wechoosethelatest pdg based clone detector ccsharp for comparison both on artificialdatasetsandreal worlddatasets.however ccsharpcan notbeimplementedinjavacode.forjavacode thereisnotargetedpdg basedclonedetector.thereisaclonedetectororeo based on deep learning to be regarded as the candidate.
in the process of model training oreo uses some information of pdg as a part of featureinput soitcanfindsomepdg basedcodeclones.therefore we choose oreo for comparison on java datasets.
we also compare ccgraph with other baselines such as token based sourcerercc tofindoutmoretype 3clones weseta80 threshold ast based deckard also with an threshold on java datasets.
besides thereisnostandardpdgtestedbenchmarktomeasuretheaccuracyandrecallrateofclonedetectionmethods.forthis wemanually check the experiment results on the tested datasets.
forthepdggeneration weuseframa c2 togeneratepdgs ofccode.forjavaprograms wechoosethejavapdggenerator tinypdg3 based on an open source library.
all pdgs of c and java code are unified to .dotfile format.
after the pdg generation we used python scripts to parse .dotfiles and transform thesefilesintothespecifiedformatforsubsequentgraphmatching.
in the implementation of approximate graph matching we usedpythonand c tocalculate similaritybasedonsome relativeli braries.
all experiments are executed on the same machine with ubuntu14.04ltsoperationsystem withaquad corecpuand8gb of memory.
.
experimental datasets weperformedexperimentsonccgraphagainsttheccsharp on c code and oreo on java code on several code datasets.
thesedatasetsincludereal worldandartificialcodedatasets.since the pdg generation can only be applied to compilable code wechoose some high quality real world code datasets and developsome artificial code datasets from the real world codes by kinds of disguises to simulate the generation of code clones in daily programming .
the details of these code datasets are shown in table2 includingtheirloc lineofcode numberoffunctions and description.
table the details of datasets datasets loc functions description bcb decompress zip archive.
bcb initialize java eclipse projects.bcb load custom font.bcb get mac address string.
less linux text viewer.
postgresql dataset server.
artificial generated artificial dataset.artificial generated artificial dataset.
forccode wechoosethe lessandseveralmodulesof postgresql datasets.the lessdatasetis usedin ccsharp gplag and thepostgresql programisalsocommonlyusedinkindsofclone detector.andwealsogeneratetwoartificialdatasetsbasedonsomereal worlddatasetlikeleetcodeorcjsonbyusingamixtureoffourtypesdisguises formatchanging i.e.changespaces comments and layouts renaming type changing i.e.
rename variables functions reorderingstatements andcontrolsubstitution i.e.replacing whileloopswith for .thesedisguisesdonotaffecttheoverallsyntactic structure and pdg dependencies in original code but may not be detected by those tools using subgraph isomorphism.
forjavacode wechoosebigclonebench whichiscommonly usedinallkindsofclonedetectors.bigclonebench isalarge benchmark of manually validated clones by mining the big realworlddatasetijadataset .
000javasystems .thecurrent publicrelease versionof bigclonebenchcontains 8million clones 937ase september virtual event australia yue zou bihuan ban yinxing xue and yun xu of43 distinctfunctionalities .considering thebigclonebench is too big for us to calculate the accuracy and recall of our method we randomly select several small functionalities.
.
experimental results .
.
efficiency of pdg structure simplification.
we have tested theeffectofpdgstructuresimplificationonseveraltypicaldatasets.
these strategies effectively simplify pdgs and do not damage the original semantic information and the results of efficiency are shown in table .
according to the research the time costby graph matching grows exponentially with the growth of the numbers of nodes and edges in the graph.
therefore the reductionof pdg size by removing meaningless nodes and merging function call sub pdgs is very beneficial to the following processes of clone detection.
table efficiency of pdg structure simplification datasets languagesize of size of ratio of original files simplification simplification a files b b a less c 871kb 732kb .
postgresql c .7mb .6mb .49artificial c 436kb 408kb .
aritificial c .1m 891kb .
datasets languagesize of size of ratio of original files simplification simplification a files b b a bcb java 559kb 482kb .
bcb java 955kb 799kb .
bcb java .3mb .1mb .
bcb java .2mb 998kb .
.
.
efficiencyoffilteringstrategies.
thefilteringphaseisvery important in the whole clone detection.
we have implemented the heuristic filtering strategies and the results of filtering efficiencyare shown in table .
the filtering ratio refers to the number of pdg pairs after filtering divided by the number of total pdg pairs.
it can exclude the majority of candidate pdg pairs and helps to accelerate the graph matching process later.
to ensure the accuracy of our filtering strategies we conducted a sample check on the filtered pdg pairs.
we randomly selected20 pdg pairs for three times from the filtered pdg pairs of each dataset and determine the number of clone pairs misfiltered in the 20pdgpairs.accordingtotheresultsshownintable5 thenumber of ourmisfiltered clone pairsis verysmall which alsoverifies the effectiveness of our filtering strategies.
.
.
resultsofcodeclonedetection.
weevaluateccgraphwith the total clone quantity clone quality time cost and scalability.
the total clone quantity is the total number of clone pairs detected by tools which is shown in table .
the clone quality includes the precision recall rate and the f1 scorewe calculated which is shown in table and table .
the total clone result used in the recallrateistheunionoftheresultsgeneratedbyalltools.also we comparethe timecostofthewholeclone detection processwithtable efficiency of filtering strategies on datasets datasets languagetheoretical pdg pairs ration of pdg pairs after filtering filtering a b b a less c .
postgresql c .
artificial c .
aritificial c .
datasets languagetheoretical pdg pairs ration of pdg pairs after filtering filtering a b b a bcb java .
bcb java .
bcb java .
bcb java .
table the number of misfiltered clone pairs of sampling examinations datasets language1st 2nd 3rd experiment experiment experiment less c postgresql c artificial c aritificial c datasets language1st 2nd 3rd experiment experiment experiment bcb java bcb java bcb java bcb java ccsharpandmeasurethescalabilityondatasetsofdifferentscales which results are shown in figure and table .
the total number of clones.
we generate pdgs and detect clones in function granularity.
we measure the total number of clones by the number of clone pairs against other tools.
in the pdg filtering stage we exclude those codes in which the number of lines is less than .
and from the clone results shown in table we know that ccgraphhasobviousadvantagesinthenumberofclonepairsthan ccsharp in all cdatasets and oreo in all javadatasets.
as shown in table our approach can find more than twice as many pdg based clone pairs on artificial dataset as ccsharp.
andevenintheworstcase wecanfind30percentmorepdg based clonepairsthanoreo.thereasonisthatweadopttheapproximate graph matching reduce the requirement of clone matching and find some clone pairs missed by other tools.
clonequality.
clonequality includesprecision recallrate and f1 scorevalue.andwechoosethosesmallcodedatasetstomake it easier to calculate the precision and recall rate.
for precision we manuallycheckandevaluateallthedetectedclonepairstojudgeif they are real clones and calculate the ratio of all true positive code 938ccgraph a pdg based code clone detector with approximate graph matching ase september virtual event australia less postgresql artificial artificial ccsharp ccgraph a in preprocessing stage min less postgresql artificial artificial ccsharp ccgraph b in graph matching stage s figure time cost comparison between ccsharp and ccgraph table the number of clones detected by ccgraph against other tools dataset language ccsharp ccgraph less c postgresql c artificial c artificial c dataset language oreo ccgraph bcb java bcb java bcb java bcb java clones to all clones we detected.
precision tp tp fp where tpisthetruepositivepdg basedcodeclonesreportedby the tool and fprefers to the wrong clone pairs we detected.
for recall rate we define recall tp tp fn where tpis the same as precision definition fnrefers to the true clone pairs we missed and the denominator tp fnis the union result of the two tools as the total detected clones removing duplicate and fpelements .
we also define f1 score precision recall precision recall from the results shown in table and we find that our results are slightly less than ccsharp and oreo in accuracy when we also maintain a high level of accuracy which is acceptable in reality.
thelittlelossofaccuracyisbecauseoftheexamplesthatthetwopdgssharealmostthesamedataandcontroldependenciesintheir structurebutthe functionoftheirprograms isobviouslydifferent.
butourrecallrateissignificantlyhigherthanccshrapandoreo.
in the best case our recall rate is almost higher than ccsharp andoreo.besides wecalculatethef1 scorevalue andccgraphis at least better than ccsharp and oreo on each dataset.
table clone results on c code dataset datasets tools accuracy recall f1 score lessccsharp .
.
.
ccgraph .
.
.
postgresqlccsharp .
.
.
ccgraph .
.
.
artificial 1ccsharp .
.
.
ccgraph .
.
.
artificial 2ccsharp .
.
.
ccgraph .
.
.
timecostandscalability.
consideringthepdg basedclonedetectionismoretime consumingthanothertypesofclonedetection tools and the time of training datasets in oreo is hard to measure weonly comparethetimecostwithccsharp .
wedivide the overall time cost into preprocessing and graph matching time cost.andthetimecostresultsareshowninfigure5.thepreprocessingstageincludespdggeneration structureoptimization and filtering.
from the results shown in figure ccgraph reduces the time cost both on preprocessing and graph matching stages and accelerates the graph matching greatly than ccsharp .
also to ensure that ccgraph can be extended to larger code datasetsthanccsharp wecomparetheruntimeofthetwotools on datasets of different sizes.
from the results shown in table ccgraph is much slower than the token based detector oreo 939ase september virtual event australia yue zou bihuan ban yinxing xue and yun xu table clone results on java code dataset datasets tools accuracy recall f1 score bcb 5sourcerercc .
.
deckard .
.
.
oreo .
.
.
ccgraph .
.
.
bcb 11sourcerercc .
.
.14deckard .
.
.
oreo .
.
.
ccgraph .
.
.
bcb 15sourcerercc .
.
.
deckard .
.
.23oreo .
.
.
ccgraph .
.
.
bcb 38sourcerercc .
.
deckard .
.
.29oreo .
.
.79ccgraph .
.
.
becauseofthehightime consumingofgraphalgorithms.however ccgraph is faster than ccsharp the pdg based detector on all datasets anditcanalsorunnormallyonlarge scaledatasets while ccsharp can not be extended to large scale datasets at the levelof mlines of code.
this also shows that ccgraph has better scalability than ccsharp at least.
table9 timecostofccgraphandccsharpondatasetsof different sizes loc 10k 1m 10m 30m 50m ccsharp 14s 1h12m3s 8h1m18s oreo 2s 4m22s 24m12s 2h11m30s 4h36m12s ccgraph 4s 15m10s 2h21m10s 7h22m12s 17h48m21s related work therehavebeenmanykindsofcodeclonedetectionmethodsinthe literature rattan et al.
summarized many tools in his research.
thesemethodscanbedividedintotext based tokenbased ast based pdg based metric based and others like deep learning .
among the text based code clone detections the representative work compared the code fragments in the form of text.
baker proposed a parametric matching algorithm regarded the code line asa longstring andusedthe stringmatching algorithmtodetect completelyconsistentcodeclones.nicad detectedthepotential code clones using the longest common string subsequencescomparison.
johnson developed clone detection by a fingerpringting technique.
however these clone detections based on the textcanonlydetectthoseexactlythesamecodeclonesorclones withhightextsimilarity.consideringthevariouspracticalclonedetectionscenarios theindustrypaysmoreattentiontopdg based clone detections recently .
amongthetoken basedcodeclonedetections theyextractedthe tokensofsourcecodebylexicalanalysistoolsfirstlyandthencomparedthosetokensinsteadofkeywordssincetokenscantolerate moredifferentidentifiers.ccfinder isapopularclonedetector based on token but it does not support detecting the structural similarityofcodefragments.ccaligner isgoodatthoseclones with relatively concentrated changes but it will miss many pdgbasedclonesthatccgraphcandetect.sourcerercc performed great in detecting format transformation and renaming changes butonlylimitedtothetokensimilarity.thisalsomeansthatthey are not suitable for the detection of pdg based clones.
among the ast based code clone detections clonedr and deckard transformed the code into an abstract syntax tree ast anddetectedthesimilarsubtreestofindcodeclones.butthe transformation lost much structure information of code and this may lead to the missing of many code clones.
amongthepdg basedclonedetections.duplix andpdgdup bothdetectedpdg basedclonesusingprogramslicing andsubgraphisomorphismmatching.andthesemethodsallsufferedfromhightimeconsumingandmissedmanyclones which cannotbeappliedtolargescalecodedatasets.to improvethetime performance sargsyanetal.
modifiedpdggeneratedbyllvm through removing isolated nodes gplag used a lossy filter to reduce the plagiarism scale by characteristic vectors ccsharp proposedsomenewpdgmodificationandfilteringstrategie.however these pdg based clone methods only applied some simple filteringstrategieandusedtheexactgraphmatchingalgorithmlikesubgraphisomorphismtodetectpdg basedclones.thesemethodsstillhaveunacceptabletimeconsumptionandpoorscalability.also they have a big loss of code clones.
among the metric based clone detections they extracted the characteristicvectorsofsourcecodeandcalculatedthevectorsimi larities to detect code clones.
patenaude et al.
divided the code into different categories using the metrics.
balazinska et al.
and mayrand et al.
both extracted the vectors from the astof source code.
these methods based on metrics are very fast on detectingclonesbuttheyhaveahighfalse positiverateandmiss many clones because of the rough comparison.
there also exist some other techniques for clone detection such asdetectionsbasedondeeplearningtechniquesandcodebehaviors.
weietal.
proposedanapproachtolearntherepresentations and hamming distance of source code and detected code clones.
whiteetal.
proposedamodeltodetectcodeclonesbylearning the discriminating features of sourcecode.
yu used a new treebased convolution to detect semantic clones by capturing boththe structural information of a code fragment from its ast and lexical information from code tokens.
oreo and deepsim used the clones that are almost identical or very similar to train the deep learning model the ability to detecting clones with large differenceislimited.thedeeplearningmethodsalwayshavetoo much dependency on the training data and lack interpretability whichmaynotsuitableforsomespecialscenarios.theexperiments in section show that ccgraph can find more pdg based code clones than oreo.
940ccgraph a pdg based code clone detector with approximate graph matching ase september virtual event australia limitations therearealsosomelimitationstoourresearchwork.onelimitation isthattherearenoanyopenedandstandardbenchmarkdatasets forpdg based clonedetection methods.we cannot compareour approachwithotherclonedetectorsonanyunifieddatasets.therefore we need to perform our experiments on the code datasets to manually verify the accuracy and recall rate of clone results.
another limitationis that the existingpdg generators need tobe improved.
now both of the pdg generations of c code and java code can only be suited to the compliable programs.
this requires thatthe testdatasets mustbe acomplete compilable programand also limitsthe scopeof pdg basedclone detection.therefore we needtodevelopapdggeneratorforcodesegments.inthisway our approach can be more widely processed.
conclusion and future work in this paper we propose a pdg based clone detection work with an approximate graph matching algorithm called ccgraph.
we introducethepreprocessingstagetooptimizethestructureofpdgs and filter the scale of candidate clone pairs by a two stage strategy.
moreover wedesigntheapproximategraphmatchingalgorithm based on the wl graph kernel to detect the clone pairs.
finally we evaluateccgraphwithclonequantity clonequalityandscalability againstoreo andccsharp .the experimentresultsshow that our method performs better recall rate and f1 score value while maintaining high accuracy.
infuturework weplantofurtherimprovetheperformanceof ccgraph.
and we will consider investigating the pdg generation of more types of programming languages.
besides we want tointegrate the ccgraph into code development and managementsystems.
meanwhile we can develop some downstream applicationsbasedonccgraph suchassoftwarestructureanalysis bug detection and other software analysis applications.