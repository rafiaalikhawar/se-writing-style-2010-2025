achyb a hybridanalysis approachto detect kernel accesscontrol vulnerabilities yang hu the universityof texasat austin austin texas usa huyang utexas.eduwenxi wang the universityof texasat austin austin texas usa wenxiw utexas.educasen hunger the universityof texasat austin austin texas usa casen.h utexas.edu rileywood the universityof texasat austin austin texas usa riley.wood utexas.edusarfraz khurshid the universityof texasat austin austin texas usa khurshid ece.utexas.edumohittiwari the universityof texasat austin austin texas usa tiwari austin.utexas.edu abstract access control is essential for the operating system os security.
incorrect implementation of access control can introduce new attack surfaces to the os known as kernel access control vulnerabilities kacvs .
to understand kacvs we conduct our study on therootcausesandthesecurityimpactsofkacvs.
regardingthe complexity of the recognized root causes we particularly focus on two kinds of kacvs namely kacv m due to missing permission checks and kacv i due tomisusingpermission checks .
we find that over of these kacvs are of critical high or medium securityseverity resultinginavarietyofsecuritythreatsincluding bypasssecuritychecking privilegedescalation etc.however existingapproachescanonlydetect kacv m.thestate of the art kacv m detector called pexis a static analysis tool which still suffers from extremelyhigh false positive rates.
in this paper we present achyb a precise and scalable approach to reveal both kacv mandkacv i.achybis a hybrid approach which first applies static analysis to identify the potentially vulnerable paths and then applies dynamic analysis to further reduce the false positives of the paths.
for the static analysis achybimproves pexin both the precision and the soundness using the interface analysis callsitedependenceanalysisandconstraint basedinvariant analysis with a stronger access control invariant.
for the dynamicanalysis achybutilizesthegreyboxfuzzingtoidentifythe potential kacvs.
in order to improve the fuzzing efficiency achyb adoptsournovelclustering basedseeddistillationapproachtogeneratehigh qualityseedprograms.ourexperimentalresultsshow thatachybreveals potential kacvs in less than hours and 22ofthemarekacvs kacv mand3kacv i .incontrast pex reveals potentialkacvs in more than 11hours and only ofthemarekacvs all kacv m .furthermore achybsuccessfully uncovers new kacvs and of them kacv mand 1kacv i have been confirmedbykernel developers.
permissionto make digitalor hard copies of allorpart ofthis work for personalor classroom use is granted without fee provided that copies are not made or distributed forprofitorcommercialadvantageandthatcopiesbearthisnoticeandthefullcitation onthefirstpage.copyrights forcomponentsofthisworkownedbyothersthanthe author s mustbehonored.abstractingwithcreditispermitted.tocopyotherwise or republish topostonserversortoredistributetolists requirespriorspecificpermission and or a fee.
request permissions from permissions acm.org.
esec fse august 23 28 athens greece copyright heldby the owner author s .
publicationrightslicensed to acm.
acm isbn ... .
concepts security and privacy operating systems security software securityengineering .
keywords program analysis access control operating system acmreference format yang hu wenxi wang casen hunger riley wood sarfraz khurshid and mohit tiwari.
.
achyb a hybrid analysis approach to detect kernel access control vulnerabilities.
in proceedings of the 29th acm joint european software engineering conference and symposium on the foundations ofsoftwareengineering esec fse august23 28 athens greece.
acm newyork ny usa 12pages.
introduction access control is a fundamental and indispensable security mechanism for the os kernel.
it secures the resources in the os by blocking the accesses which violate authorization rules.
the linux kernelprovidesseveralaccesscontrolmodules includingaccess control list acl linux capabilities linux security module lsm etc.
thanks to these modules the linux kernel has been appliedinmanysecurity sensitive environments .
access control provides a security guarantee to the privileged functions i.e.
the kernel functions implementing the security critical kernel functionalities which ensures that privileged functions can be called only when the caller user has the permission.
this is usuallyachievedthroughthe accesscontroldecision returnedbythe permissioncheck i.e.
thekernelfunctionverifyingifthepermissionsgranted tothecaller userareconsistent withthecaller user operations .
the security guarantee is realized in two steps generating an access control decision via a permission check before calling a privileged function and enforcing the access control decision in the control flow so that the privileged function will not becallediftheaccesscontroldecisionisdenied.however attackers could break the security guarantee if the access control is incorrectlyimplementedintheabovetwosteps.thissecurityissueis knownas the kernelaccess controlvulnerability kacv .
to understand kacvs we conduct an empirical study in this papertolearntherootcausesandthesecurityimpactofkacvs.
we firstcollected101 kacvs fromthe national vulnerabilitydatabase .
aftermanual inspections weclassifykacvs intothree categories based on our identified three root causes.
given the esec fse august athens greece yang hu wenxiwang casen hunger riley wood sarfraz khurshid andmohittiwari complexityofonerootcause inthispaper weonlyfocusontwo categories namely kacv mwhich is due to missing permission checks and kacv iwhich is due to misusing permission checks.
according to the common vulnerability scoring system cvss .
of the kacv mandkacv iwere scored as high or critical security severity and .
were scored as the medium severity.
in addition our study found that kacv mandkacv icause a variety ofsecuritythreats includingbypasssecuritychecking privileged escalation denialofservices etc.
tothebestofourknowledge existingapproachescanonlydetect kacv m andnoworkhasbeenproposedtodetect kacv i.zhang et al.
propose a static analysis tool called pex which is the state of the art kacv mdetector.pexconducts its static analysis in three stepsincluding the permission check identification the privilegedfunctionidentification and3 theinvariantanalysisover the permission checks and privileged functions to uncover kacvs.
to identify permission checks pexrequires users to provide an incomplete list of permission checks.
it then performs program slicing toidentifythewrappersoftheinitiallyprovidedpermissionchecksasthenewpermissionchecks.next pexfindsan over approximation of the privileged functions with a control flow analysis to collect the kernel functions which always execute after permission checks.
last it performs a control flow based invariant analysistosearchforthepotentiallyvulnerablepathswhereaprivilege function is not preceded by any permission checks.
however pexsuffersfromsignificantfalse positiveratesduetothelimitation ineachstep.first thepermissioncheckidentificationisunsound especiallywhentheuser providedpermissioncheckslackdiversity.
second theprivilegedfunctionidentificationisimprecisedueto theweakover approximation.
third theinvariantanalysis isalso imprecise dueto the weakinvariant.
tomitigate the limitations of pex we present a precise scalable kacv detector called achybwhich is capable of detecting both kacv mandkacv i.achybis ahybridanalysis approach which first applies static analysis to identify the potentially vulnerable paths and then applies dynamic analysis to further reduce the false positives of the paths.
for the static analysis achybfollows the three steps of pex but with its own improvements for each step to enhanceboththeprecisionandthesoundness.forpermissioncheck identification achybperforms a semi automated interface analysis which is a soundy i.e.
mostly sound approach.
for privileged functionidentification insteadofusingcontrol flowanalysisas pex achybperforms our proposed callsite dependency analysis which is a data flow analysis that could significantly improve the precision.
forinvariantanalysis achybproposesastrongerinvariantandperformsaconstraint basedanalysistochecktheinvariant.toimprove the efficiency instead of conducting the standard inter procedural analysis achybconducts the lightweight intra procedural analysis byexploitingthe features ofaccess control.
moreover instead ofrequestinghuman efforttodo themanual inspection as pex achybapplies dynamic analysis to reduce the false positives of the potentially vulnerable paths identified.
the ideaistoidentifythefeasiblepotentiallyvulnerablepathsinwhich theaccesscontroldecisionsareeithermissing potential kacv m or denied potential kacv i .
to achieve this achybinjects invariant checksonthepotentiallyvulnerablepathsandconductsgreybox fuzzingtotriggerthesechecks.toimprovethefuzzingefficiency achybadopts our novel clustering based seed distillation approach to generatehigh qualityseedprograms.
for static analysis we implement achybon top of the llvm pass framework .
for dynamic analysis we build achybbased onthegreyboxfuzzercalled syzkaller .weperformanempirical evaluation of achybon the linux kernel v4.
.
.
as a result achybreports potential kacvs of which are kacvs including19kacv mand3kacv i.incontrast pexreports2 088potential kacvs of which are kacv m. besides the kacvs detected by achybcontain all the kacvs detected by pex.
we report new kacvs kacv mand 2kacv i to kernel developers.
by the time of the paper publication new kacvs kacv mand 1kacv i havebeenconfirmed.theresultsshowthat achybisnotonlymore precisethan pex butalsocapableofdetectingnewkacvs.inaddition achybtakes less than hours to detect thekacvs while pex takesmorethan11hours whichshowsthat achybismoreefficient thanpex.
the source code of achyband the dataset of our study arepubliclyavailableat .
the contributionsofthis paper are study.we did an empirical study on kacvs mainly in two aspects the rootcauses andthe security impactsof kacvs.
approach.
we present achyb which combines static and dynamicanalysistodetectboth kacv mandkacv iprecisely and efficiently.
to the best of our knowledge achybis the firsttoolthat iscapableof detecting kacv i. implementation.
weimplement achybontopofthe llvm andsyzkaller withabout5 linesof code.
empirical evaluation.
wedidanempiricalevaluationof achybon the linux kernel v4.
.
the experimental results show that achybis more precise and scalable than the stateof the arttool pex.
practicalimpacts achybisabletodetect7newkacvs ofwhichhave been confirmedbythe kernel developers.
a studyon kacvs westudythekacvsmainlyintwoaspects therootcausesandthe securityimpactofkacvs.inordertogetkacvs wefirstcollectall the cve reports related to kacvs from the national vulnerability database .
we use the cve search tool to find the cve reports that contain the keywords related to the access control suchas acl capability permission etc.wefilteredoutthe old cve reports on the kernel version lower than v2.
since we want to focus on the kacvs in the newer kernel versions.
as a result 101cvereportswerecollected.fig.
1ashowsthenumber ofcvereportsrelatedtothekacvsintherecent10years.wecan observe that from to kacvs were reported each year since .
next we extract the key information from the collected cve reports including the vulnerability descriptions the cvss ratings version3.
andthe patchesthat fixthe kacvs.
we manually inspect the vulnerability descriptions and patches in our collected cve reports to identify the root causes of the kacvs.
as a result we classify the kacvs into three categories basedontheidentifiedrootcauses asshowninfig.
1b.thefirst categoryiscalled kacv m whichreferstothekacvsdueto missing permission checks .
the secondcategory iscalled kacv i which referstothekacvsdueto misusingpermissionchecks .thethird 317achyb a hybrid analysis approachto detectkernelaccess control vulnerabilities esec fse august athens greece year kacv a kacvcounting across years kacv m .
kacv i17.
kacv s .
b root causes low .
medium38.
high .
critical .
c severityincvss bypass .
privilege escalation26.
dos .
information leakage .
others .
d securitythreats figure statisticalresults ofour kacv study.
fs namespace.c in the linux kernel v2.
.
2static int do change type ... ... missing the access control decision.
patch if !capable cap sys admin return eperm ... privileged function 10change mnt propagation m type ... figure anexample of kacv m. category is called kacv s which refers to the kacvs due to incorrectinternalaccesscontrolstates .thepercentageof kacv m kacv i andkacv sis30.
.
and51.
respectively.duetothecomplexityoftheinternalaccesscontrolstatesandthestatetransitions we leave kacv sdetection as our further research work.
in this paper weonlyfocusonstudyinganddetecting kacv mandkacv i. note that to the best of our knowledge no existing work has been proposedto detect kacv i. weshowtwoexamplesof kacv mandkacv i respectively.fig.
2showsakacv mexample.obviously thefunction do change type missescallingthefunction capabletocheckifthecallerhasthe permission i.e.
cap sys admin capability to call the privileged functionchange mnt propagation line10 .fig.
3showsakacv i example.thefunction vfs dedupe file range callsthepermission checkfunction capabletoqueryif thecaller hasthepermission i.e.
cap sys admin capability to call the privileged function stored in the function pointer dedupe file range line .
however dueto the incorrect usage of the access controldecision is admin line12 thereexistsafeasiblepathwheretheprivileged function is called when the access control decision is false i.e.
denied .
fig.1cshowsthevulnerabilityseverityof kcav mandkacv i which was measured in cvss v3.
ratings.
.
of the kcav m andkacv iwere scored as high or critical severity and .
were scored as the medium severity.
fig.
1dshows the statistics of the security threats caused by kcav mandkacv i based on the cve reports.
the most frequent security threat is bypassing securitychecking .
thesecondfrequentthreatistheprivilege escalation .
followed by the denial of service .
the nextistheinformationleakage .
.thedatashowsthat kacv m andkacv ihaveprofoundsecurityimpactsonthelinuxkernel .the1 fs read write.c in the linux kernel v4.
2intvfs dedupe file range ... direct callsite to a permission check 4boolis admin capable cap sys admin direct callsite to a non privileged funtion 6ret clone verify area ... ... 8for ... condition c1 ... if ... condition c2 ... else if !
is admin ... incorrect condition c3 ... else indiret callsite to a privileged function deduped dst file f op dedupe file range ... ... figure anexample of kacv i. goalofthispaper istoproposeapreciseandscalable approachto detectkacv mandkacv i. methodology .
overviewof achyb theoverviewof achybisshowninfig.
.theinputof achybisthe linux kernel under examination encoded in llvm intermediate representation ir theoutputisthedetectedkacvs kacv mor kacv i .achybiscomposedoftwophases thestaticanalysisphase left part of fig.
and the dynamic analysis phase right part of fig.
.thestaticphasefirstlytakesinthekernelirandoutputs the potentially vulnerable paths while the dynamic phase reduces false positives ofthosepathsandoutputs the kacvs.
specifically in the static analysis phase achybperforms a semiautomated interface analysis to identify the permission checks section3.
.
.
it then conducts a callsite dependency analysis to identify the privileged functions section .
.
.
finally achybproposes a stronger access control invariant over the detected permission checks and privileged functions and performs a constraintbased invariant analysis to get the potentially vulnerable paths section3.
.
.
in the dynamic analysis phase achybfirstly injects run time invariant checks on these potentially vulnerable paths 318esec fse august athens greece yang hu wenxiwang casen hunger riley wood sarfraz khurshid andmohittiwari kacv reportskernel ir permission check detection static invariant analysisprivileged function detection directed greybox fuzzing privileged functions static analysis dynamic analysis permission checksinvariant check injection kernel image seed distillation selected seeds potentially vulnerable path figure overview of achyb section3.
.
.next achybconductsseeddistillationtogenerate high qualityseedprograms andfinallyappliesthegreyboxfuzzing using those seed programs to trigger the injected invariant checks andgetthe kacvs section .
.
.
.
static analysis .
.
permission check identification.
the detection of kacv m andkacv irequires thefulllistof permission checks.since most permissionchecksarenotwelldocumented researchersareseeking toemployprogramanalysistoautomaticallycollectthepermission checks.pex identifiesthepermissionchecksbyutilizingcall graph slicing to search the wrappers of those permission checks given an incomplete list of the user provided permission checks.
thisapproachisunsound especiallywhentheuser providedpermissioncheckslackdiversity.
to mitigate the problem our insight is that we can firstly get an over approximation of the permission checks and further remove the false positives with manual efforts.
however a weak over approximation might significantly increase the manual efforts.to solvethisproblem achybperformsa soundy i.e.
mostly sound interface analysis to give a good approximation of the permission checks.
our approximation is based on the two key observations.
one is thatapermissioncheck is usuallyimplemented asanaccesscontrolinterface whichreferstoakernelfunctioninthe accesscontrolmodulethatcanbecalledbythefunctionsoutside the module.
the other one is that a permission check usually returnsanaccesscontroldecisionthroughaboolean integervariable.
based on these two observations achybcollects the access control interfaceswithbooleanorintegerreturntypestoserveasasoundy approximation ofthe permissionchecks.
after obtaining the approximation set of the permission checks instead of asking users to manually inspect every access control interface achybonlyrequests users tomanually inspecta fewselected ones.
achybachieves this in two folds.
first it performs a dependencyanalysisonthereturnvariablesoftheaccesscontrolinterfacestodividetheinterfacesintoseveralequivalenceclasses.the equivalenceclassofaccesscontrolinterfacesisdefinedindefinition3.
.here wesaythatavariable xdependsonavariable yiffthe1 kernel capability.c in the linux kernel v4.
... 3boolcapable intcap 4return ns capable init user ns cap 6export symbol capable 8boolns capable struct user namespace ns intcap 9return ns capable common ns cap true 11export symbol ns capable 13boolns capable noaudit struct user namespace ns int cap 14return ns capable common ns cap false 16export symbol ns capable noaudit ... figure anexample ofpermission checkdetection.
value ofydetermines the value of x.second for eachequivalence class we ask users to manually inspect only one representative of theclass.iftherepresentativeismanuallyidentifiedasapermissioncheck thenalltheinterfacesinthesameequivalenceclassare automatically taken as the permission checks otherwise all the interfaces in the equivalence class are not taken as the permission checks.
definition .
the equivalence class of access control interfaces .the interface fxand the interface fyare in the same equivalenceclassiffthereexistsakernelfunction fzsuchthatthereturn variables of both fxandfydepend onthe returnvariable of fz.
to illustrate we use an example in fig.
.
consider the three access control interfaces which are capable ns capable and ns capable noaudit .
based on the above definition of the equivalenceclass weknowthattheinterface capableisequivalentto the interface ns capable as the return variable of the interface capabledepends on that of the interface ns capable fzcan be fxorfyin definition .
.
besides the interface ns capable is equivalenttotheinterface ns capable noaudit asbothoftheir return variables depend on the return variable of the interface ns capable common .therefore thethree interfacesareclassified into one equivalence class.
if users manually identify any one of thethreeinterfaces e.g.
theinterface ns capable asapermission check thentheothers e.g.
theinterface capable andtheinterface ns capable noaudit will be automatically classified as permission checks.
in the end users only manually inspects one interface but identifies three permissionchecks.
.
.
privileged function identification.
besides the permission checks thedetectionof kacv mandkacv ialsorequiresalistof privilegedfunctions.unlikethepermissioncheckswhichcanbeapproximated bysyntactic features identifyingprivileged functions needs to exploit the semantic features.
to address this problem pex over approximates the privileged functions by finding thekernelfunctionswhoseexecutionsare dominated bythe permissionchecks.tobespecific ifacallsiteofthekernelfunction fxalways executes after a callsite of a permission check then pex identifies the function fxas the privileged function.
however this over approximation is weak and might cause high false positive 319achyb a hybrid analysis approachto detectkernelaccess control vulnerabilities esec fse august athens greece rates.
to illustrate we use the kacv iexample shown in fig.
.
sincethe callsite of a permissioncheck line4 dominatesthecallsite of the function clone verify area line pexclassifies the function clone verify area as a privileged function.
however thefunction clone verify area isactuallyanon privilegedfunction.
tolowerthefalse positiverates insteadofusingthecontrol flow analysisas pex achybappliesa more fine grained data flow analysisto over approximate the privilegedfunctions.
the data flow analysisisactuallya callsitedependency analysiswhichsearches for the kernel functions whose executions depend on the access controldecisions.thedefinitionofthecallsitedependencyisgiven in definition .
.
for the kacv i example in the fig.
the callsite of a privileged function line depends on the callsite of a permissioncheck capable line4 .becausetheaccesscontroldecision is admin returned by the permissioncheck is used in a condition line which determines the execution of the privileged function.
definition .
callsite dependency .a callsite cxdepends ona callsitecyiff the return value of cycontrols the execution of the callsitecx.
notethatidentifyingsuchdependencyusuallyneedsan interprocedural data flow analysis which is notorious for the scalability limitation .
to mitigate the issue achybperforms an intra procedural data flow analysis to identify the dependencies.
compared to the inter procedural analysis which extracts every data flows in the kernel the intra procedural analysis only focuses on identifying the data flows inside the body of each individual kernel function thereby achieving much better efficiency and scalability.
moreover the intra procedural analysis would not cause muchaccuracylossinapproximatingtheprivilegedfunctions as weobservethatformostkernelfunctionsexcludingthepermission checks the access control decision is only used insidethe function where it is defined and rarely used as an argument or a return variable.inotherwords theaccesscontroldecisionisrarelypropagated acrossthe kernel functions.
algorithm 1demonstratesourmethodtodetecttheprivileged functions.
achybfirstly gets the direct indirect callsites in each of the kernel functions excluding the permission checks line .achybthen conducts a callsite dependency analysis to get all the callsites that depend on the collected callsites of permission checks andstorethemintheset s line6 .next foreachcallsite in the set s excluding the ones of permission checks achyb identifiesitscalleesastheprivilegedfunctions line10 .toillustrate fig.
6presentstheintra proceduraldata flowanalysisforthe kacv iexampleshowninfig.
.achybfirstlydetectsallthecallsites inside the function vfs dedupe file range including the callsiteofthefunction capable line4 andthecallsiteofthefunctionsbtrfs dedupe file range andxfs file dedupe range line .
given a permission check list detected in the last section achybidentifies that only the function capable is a permission check.
next achybconducts a callsite dependency analysis based on the access control decision is admin returned by the permission check capable.
sinceis admin is used in an if condition line and controls the execution of the functions btrfs dedupe file range andxfs file dedupe range achyb classifies thesetwofunctionsas the privilegedfunctions.algorithm1 privilegedfunction detection algorithm.
input the kernel intermediate representation r the setofpermissionchecks fperm output the setofprivilegedfunctions fpriv function get priv functions r fperm fnon perm r.get functions fperm fpriv forf fnon permdo s f.get callsites fors sdo ifs.is perm callsite then s callsite dependence analysis f s fors s do if s .is perm callsite then fcallee r.get callees s fpriv fpriv fcallee returnfpriv vfs dedupe file range line bool is admin capable cap sys admin line if !
is admin ... line else statement data flow xfs file dedupe range btrfs dedupe file range control flow branch line deduped dst file f op dedupe file range ... control flow function call capable data flow figure an example to illustrate our privileged function detection algorithm.
btrfs dedupe file range and xfs file dedupe range are identified as privileged functions as their callsite in line depends on the callsite of thecapablefunction apermission check inline .
.
.
staticinvariantanalysis.
thegoaloftheinvariantanalysis is to identify the potentially vulnerable paths where the callsites ofprivilegedfunctionsarenotprotectedbythepermisionchecks.
themajorlimitationoftheexistinginvariantanalysisforkacv detection is that the defined invariant is not strong enough which may cause false negatives.
pex proposes an invariant for each path inthe control flow graph every callsite ofa privileged function mustbepreceded byat leastone callsiteofapermission check .
this invariantanalysiscannotrevealthe kacv iinfig.
astheindirect callsite of the privileged function s line always executes after the callsite ofthe permissioncheck capable line4 .
to mitigate the limitations achybfirstly proposes a stronger accesscontrolinvariant aprivilegedfunctionshouldnotbeexecuted 320esec fse august athens greece yang hu wenxiwang casen hunger riley wood sarfraz khurshid andmohittiwari when its corresponding access control decision is denied or not generated at all .
one straightforward way to check this invariant is to apply symbolic execution on every path from each entry of the kernel i.e.
the system calls to the callsites of the privileged function and solve the constraints collected along the paths.
however this method suffers from the path explosion and the high complexity of the path constraints.
achybadopts two strategies to make the constraint basedinvariantanalysisscalable.
onestrategyistoperformanintra proceduralanalysisinsteadof the inter procedural analysis based on the observation mentioned in section .
.2that the access control decision is rarely propagatedacrossthekernelfunctions.foreverypathwhichreachesa privileged function achybonlycollects the constraints inside the callerof the privileged function.by replacingthe inter procedural analysis with the intra procedural analysis both the path space and the complexity of the constraints can be largely reduced.
however since only partial path constraints are collected this analysis canonlyfind potentially vulnerablepaths.
achybfurtherreduces false positives among these paths using dynamic analysis which is introducedinsection .
.
the other strategy is to perform theabove analysis only on the non privilegedfunctionswhichcallatleastoneprivilegedfunctions.
this is based on our observation that the non privileged functions usuallyneedtorequestaccesscontroldecisionsbeforetheycallthe privileged functions while the privileged functions rarely request accesscontroldecisionswiththeassumptionthattheircallersrequestandchecktheaccesscontroldecisionsbeforehand.besides thereisnoneedtoconducttheanalysisonpermissionchecks as they never callprivilegedfunctions.
algorithm 2shows our invariant analysis algorithm.
achybfirst collectsallthekernelfunctionsexcludingthepermissionchecks and the privileged functions.
inside each of these functions achyb collectsthecallsitesoftheprivilegedfunctions line2 .itthengets alltheintra proceduralpaths withfiniteloopunrolling thatreach these callsites line6 .for each path achybobtains the callsites ofthepermissionchecksinthepath line8 .ifnosuchcallsite is found the path is taken as a potentially vulnerable path line .
otherwise achybfetches the access control decision and the path constraints and checks the satisfiability of the constraint which is theconjunction of thepath constraintsandan additional constraintstatingthatalltheaccesscontroldecisionsare denied line .
if the constraint is satisfiable which means that the path to the privileged function is feasible but the access control decisions in the path are denied the path is then identified as a potentiallyvulnerable path line16 .
we demonstrate our static invariant analysis using the relevant pathconditionsofthe kacv iexampleshowninfig.
.sincethere isacallsiteofaprivilegedfunctioninline16 achybanalyzesthe path to the callsite inside the function vfs dedupe file range .
for simplicity we consider the loop is unrolled only once.
the pathtothecallsiteoftheprivilegedfunctionincludeslines2 .
first achybcollects path constraints inside the function vfs dedupe file range c1 c2 and c3.
next achybgenerates an additional constraint c4 is admin false which indicatesthattheaccesscontroldecisionofthefunction capable isdenied line4 .then achybchecksifthefollowingconstraintalgorithm2 static invariantanalysisalgorithm.
input the kernel intermediate representation r the setofpermissionchecks fperm the setofprivilegedfunctions fpriv output the setofpotentiallyvulnerable paths ppot function static inv analysis r fperm fpriv fother r.get functions fperm fpriv ppot forf fotherdo spriv f.get priv callsites fpriv fors sprivdo plocal f.get paths s getpathsinside f whichreachthe callsite s. forp plocaldo sperm p.get perm callsites fperm ifsperm then ppot ppot p else d p.get dec var sperm c p.get path constraints c c d denied d d ifis satisfiable logicalandtext.
c cc then ppot ppot p returnppot issatisfiable c1 c2 c3 c4.
sincetheconstraintissatisfiable thepathisidentifiedasapotentiallyvulnerable path.
.
dynamicanalysis thedynamicanalysisfocusesonreducingfalsepositivesamongthe potentially vulnerable paths detected by the static analysis.
achyb achievesthisintwosteps.first achybinjectstherun timeinvariant checks to the kernel image as introduced in section .
.
.
then achybconductsgreyboxfuzzingtocoverthepotentiallyvulnerable paths so that the invariant checks can be triggered and the kacvs can be revealed as presentedinsection .
.
.
.
.
invariant check injection.
as mentioned in section .
.
the intra procedural invariant analysis would cause false positives.
to remedythisproblem achybrigorouslycheckstheaccesscontrolinvariantintheruntime.foreachpotentiallyvulnerablepath achyb instruments the kernel with a run time invariant check which is added exactly before the callsite of each privileged function.
as introduced in section .
.
the static invariant analysis can detect two kinds of potentially vulnerable paths reachable to the privileged functions the paths with missing permission checks and thepathswithdeniedaccesscontroldecisions.ifatestexecution triggers the run time checks and covers the potentially vulnerable path with missing permission checks the potentially vulnerable path is feasible and thus it is taken as the path that could reveal kacv m.similarly ifthepotentiallyvulnerablepathwithdeniedaccesscontroldecisionisfeasible thepathisconsideredtorevealthe kacv i.forthekacv iexampleinfig.
achybinjectsarun time 321achyb a hybrid analysis approachto detectkernelaccess control vulnerabilities esec fse august athens greece traces trace slicing trace embeddingtracing clusteringcluster selectionsampling real world programs seed programs trace slices vectorsclustersselected clusterskernel image potentially vulnerable paths sampled trace slicesconversion trace slices figure anoverview ofour seed distillation approach.
invariant check assert is admin before calling the privileged function line16 tocheckifthepotentiallyvulnerablepath line410 isfeasiblewhentheaccesscontroldecision is admin isfalse i.e.
denied .
.
.
greybox fuzzing with seed distillation.
greybox fuzzing has been widely used in patch testing bug detection and bug reproduction .achybregardstheinvariantchecksasthetargets andutilizesthegreyboxfuzzingtotriggerthem.tofurtherimprove the efficiency of fuzzing we propose a novel clustering based seed distillationapproachtogeneratehigh qualityseedprograms i.e.
sequences of system calls which could guide the fuzzer to rapidly approachtheinvariantcheckswithlesschanceofbeingtrapped.
fig.7brieflyshowsourseeddistillationapproach.
achybfirstcollectsexecutiontracesfromthereal worldprogramsinthelinux testproject ltp .wechooseltpbecauseitiswellmaintained by many companies such as ibm cisco red hat etc aiming at generatinggoodtestprogramsforthelinuxdevelopment.ithas alsobeenappliedbythestate of the artseeddistillationtoolcalled moonshine .aftercollectingthetraces achybthenperforms program slicing to split the traces into trace slices.
next achybdoes the trace embedding to get the vector representation of each trace slice and use the scikit learn machine learning framework to perform the k means clustering on the trace slices.achybselects the clusters which are closer to the potentially vulnerable paths.
detailsabout the trace embedding and the cluster selection are introduced in the following sections.
for each selected cluster achybrandomly samples a few trace slices and converts them into the seed programs.
these seed programs are finally fedto the greybox fuzzer.
traceembedding.
inspiredbytheexistingprogramembedding approaches we propose our trace embedding approach to convert the trace slices into vector representations.
first we convert all the trace slices into our defined multi relation graph which encodes the syntactic and semantic information of the trace slices.second weusethe pytorch biggraph system togeneratethevectorrepresentationforeachnodeinthegraphbasedonthe information from their neighbors.last we extract the embedding ofeachnode representing the trace slice as our trace embedding.
formally we define the multi relation graph as a directed graph represented by a tuple v r e wherevis a set of nodes ris a set of relations and eis a set of labeled directed edges xr y trace slice t c1 a2 n a1 trace slice t c1 a2 n a1 c2 a3 n a2 a1c1 a2 n a1 a2 a3 n1 n2 2 c2 a3 n a2 1 1 1 1 2 3 3b1 bn ... 2t1 t2figure anexample oftrace embedding.
wherex y vandr r. the multi relation graph depicts the following syntacticandsemantic informationintrace slices each trace slice consists of at least one system call each system call has its system call name its arguments if any and its return value if any each trace slice covers a set of code branches.
accordingly we define fivenodetypes torepresenta trace slice dented as t a system call denoted as c the name of a system call denoted as n theargument return valueofa system call denoted as a and the branchcoveredbyatraceslice denotedas b respectively.besides we definefive relation types as follows trace to call relations the relation ibetween the trace slicetanditsi th systemcall ciisdenotedas t i ci.
call to name arguments return relations therelation 1 between the system call cand its callname nis denoted as c 1 n the relation 2between the system call cand its argument aisdenotedas c 2 a therelation 3betweenthe systemcall candits return value visdenotedas c 3 v. trace to coveragerelation therelation betweena trace slicetandthe coveredcode branch bisdenotedas t b. fig.8showsthemulti relationgraphofabriefexample.thereare twotraceslices t1andt2intheexample.thetraceslice t1contains onesystemcall c1 andthetraceslice t2containsasequenceoftwo system calls c1andc2.
we get the vector representation of each nodeinthe graphwiththe nodeembedding and extractthevector representationsofallthetraceslicenodes t1andt2 asourtrace embedding.
clusterselection.
intuitively if the paths covered by a cluster of trace slices are similar to the potentially vulnerable paths the seed programs convertedfromthe traceslices inthe cluster are inclined to cover the potentially vulnerable paths with a few mutations.
ourclusterselectionisbasedonthisintuition.foreachpotentially vulnerablepath achybselectstheclusterwhichhasthemaximal path similarity to the path.
the path similarity is defined based on the jaccard distance between the potentially vulnerable path and the paths covered by system calls in the traceslices.
formally letpbe a potentially vulnerable path and qbe a set of paths which are covered by the clusters the path similarity between pandqis defined as s p q meanq q j b p b q where j x y x y x y andb p is the set of branches covered by p. the trace slices which are sampled from selected clusters are finally 322esec fse august athens greece yang hu wenxiwang casen hunger riley wood sarfraz khurshid andmohittiwari table the kacv detection precision of achybandpex.
perm refers to the number of detected permission checks.
priv refers to the number of detected privileged functions.
pvp refers to the number of detected potentially vulnerable paths.
wrn refersto thenumberofwarnings.
kcav refersto thenumberofdetected kacvs.
ac achyb pex module perm priv pvp wrn kacv precision perm priv pvp wrn kacv precision cap .
.
lsm .
.
dac .
.
total .
.
convertedtoseedprograms.supposethatthetraceslice t2infig.
8has been sampled from a selected cluster.
the seed program converted from t2consists of two system calls from t2 which is n1 a1 n2 a2 .
.
implementation weimplementthestaticanalysisof achybbasedonthellvmpass framework withabout3 200linesofc code.forthedynamic analysis we build the greybox fuzzing andthe seed distillation on topofthekernel greyboxfuzzercalledsyzkaller with about linesofgo code and600linesofpythoncode.
evaluation .
experimentalsetup baseline.
to evaluatethe kacv detectionperformanceof achyb we choose pex the state of the art tool for kacv detection whichhasitspubliclyavailableimplementation1 asourbaseline.
besides to evaluate our seed distillation approach we choose moonshine whichisthestate of the artseeddistillationtool as our baseline.
kernel version and compilation.
we evaluate achybon the linux kernel v4.
.
the version pexuses in its evaluation.
we compile the kernel source with the allyesconfig configuration using the clang 9toolchain andthe wllvmtool .
subjects.
we take all the three subjectmodules in the pexevaluationasoursubjects.theyarecommonlyusedkernelaccesscontrol modules includinglinux capabilities cap linux security modules lsm anddiscretionary access control dac .
environment.
all the experiments are conducted on a machine withtwointel r xeon r e5 2620v4processors 32logicalcores intotal and256 gbram.
the operating systemisubuntu20.
.
.
research questions we try to answer the three following research questions in our experiments question1.
howprecisely can achybdetectkacvs?
question2.
howefficiently can achybdetectkacvs?
question3.
canachybdetectnewkacvs?
.
rq1 detectionprecision to evaluate the detection precision we need to identify the kacvs fromthewarnings i.e.
potentialkacvs reportedby achyband manuallyinspectallthewarningsreportedbybothtools among whichweobtain15kacvsthathavebeenconfirmedbythekernel developersorreportedbytheauthorsof pex.then wemanually inspecttherestwarningsreportedby achybandidentify7warnings as new kacvs.
next we report these new kacvs to the kernel developers.
by the time of the paper publication they have confirmed2newkacvs.
.
.
the overall detection precision.
table1shows the detection precision of achybandpex.
for cap module the detection precision of achybis .
while the precision of pexis only .
.
forlsmmodule thedetectionprecisionof achybis29.
while theprecisionof pexisonly0.
.fordacmodule thedetection precisionof achybis57.
whiletheprecisionof pexisonly1.
.
we can also observe that among the three modules both tools perform with the highest precision on module dac perform with the second highest precision on module lsm perform with the lowestprecisiononmodulecap.intotal forallthethreemodules .
of the warnings reported by achybare kacvs while only .
of the warnings reported by pexare kacvs.
furthermore the kacvs detected by achybcontain all the ones detected by pex.
overall we can say that achybis much more precise than pexin kacv detection.
.
.
static and dynamic analysis.
table1also shows the intermediateanalysisresults whichcanhelpusunderstandhoweach analysisin achybcontributesto its precise detection.
permission check identification.
as for the permission check identification achybreports14 morepermissionchecksthan pex.
we manually inspect these permission checks and confirm that all of them are the real permission checks.
the results show that the soundyinterfaceanalysisof achybcanhelpidentifymorepermission checks than pex.
privileged function identification.
from table we can observethat achybreportsmuchlessprivilegedfunctionsthan pex.
tostudythequalityofthereportedprivilegedfunctions werandomly sample functions reported by achybandpex respectively.
after manually inspecting the sampled privileged functions wefoundthat83 ofthesampledprivilegedfunctionsidentified byachybare the real privileged functions while only of the sampled privileged functions identified by pexare the real privileged functions.
inaddition thereal privilegedfunctions detected byachybcontainalltherealonesdetectedby pex.ingeneral we canconcludethatourproposedcallsitedependencyanalysisimproves theprecision oftheprivileged functionidentification.
323achyb a hybrid analysis approachto detectkernelaccess control vulnerabilities esec fse august athens greece cap lsm dac total pvp achyb achyb pex figure the number of potentially vulnerable paths detected by the invariant analysis.
achyb pex refers to the resultsof pexinvariantanalysiswiththepermissionchecks and privileged functions detected by achyb.
pvp refers to thenumberofdetected potentially vulnerablepaths.
table the time cost in minutes of static analysis.
tperm refers to the time cost of permission check identification.
tprivreferstothetimecostofprivilegedfunctionidentification.tinvreferstothetimecostofinvariantanalysis.
toverall refersto thetotal timecostoftheentire static analysis.
ac tperm tpriv tinv toverall module achybpexachybpexachyb pexachyb pex cap .
.
.
.
.
.
.
.
lsm .
.
.
.
.
.
.
.
dac .
.
.
.
.
.
.
.
total .
.
.
.
.
.
.
.
invariant analysis.
the invariant analysis is based on the detectedpermissionchecksandprivilegedfunctions.toconductan apple to applecomparisonontheinvariantanalysis werun pex invariant analysis on the permission checks and privileged functions detected by achyb.
fig.9shows the number of potentially vulnerable paths detected by the invariant analysis of both tools.
pexreports853potentiallyvulnerablepaths while achybreports only potentially vulnerable paths.
after manually checking all the paths reported by pexunder the new configuration we foundthatthenumberoftherealvulnerablepathsreportedby pex is while the number of real paths reported by achybis as shownintable .therefore theprecisionof achybinvariantanalysis is .
while the precision of pexinvariant analysis is .
.
besides therealvulnerablepathsreportedby achybcontainallthe onesreportedby pex.theresultsshowthattheinvariantanalysisof achybis more precise and sound than the invariant analysis of pex.
dynamicanalysis.
finally wenoticethat33.
ofthepotentially vulnerablepathsarereportedaswarningsbyourdynamicanalysis.
we manually check the unreported paths and found that all of them arefalse positives.
in contrast pexdirectly reports allthe 088potentiallyvulnerablepathsaswarningswhichcausestheextremely high false positive rates.
the results show that our dynamic analysishelpsto reduce thefalse positives in kacv detection.
time hour .
.
.
.
.
.
.
.
triggered invariant checks adistill mdistill nodistill noseedfigure10 timeefficiencyintriggeringtheinvariantchecks usingfour seed distillation approaches.
.
rq2 detectionefficiency .
.
static analysis.
table2shows the time cost by the static analysis of achybandpex.
the results show that in total achyb is6.3xfasterthan pex.thetimedifferencesaresubtleinboththe permissioncheckdetectionandtheprivilegedfunctiondetection.
however thebigtimedifferenceslieintheinvariantanalysiswhere achybis .9x faster than pex.
in addition to the time costs of the automatedanalysis pexrequiresuserstoprovideaninitiallistof permissionchecks while achybrequiresmanualefforttoinspect therepresentativepermissioncheckcandidates.forallthethree subjectmodules the user provided listin pexevaluation contains permission checks while the candidate list produced by achyb only contains permission checks.
to measure the required manualeffortinthecandidateinspection eachstudentauthorinthis paperinspectsthe17candidatesindependently.asaresult each person spends minutes on average minutes in minimum and minutesinmaximum onthisinspection.
overall theresultsindicate that thestaticanalysisof achybis more efficientthan pex.
.
.
dynamic analysis.
to evaluate the efficiency of the dynamic analysis we focus on evaluating our proposed seed distillation approach.wechoosethestate of the artseeddistillationtoolcalled moonshine asourbaseline andconstructfourgroupsofthe seedprograms noseedprograms denotedasnoseed theseed programswhichareconvertedfromtheexecutiontraceswithout any distillation denoted as nodistill the seed programs which aredistilledfromtheexecutiontracesusing moonshine denoted as mdistill the seed programs which are distilled from the execution traces using achyb denoted as adistill .
we evaluate thetimeefficiencyandthenumberoftriggeredinvariantchecks ofachybusingeachseedgroup.togetthereliableexperimental results wefollowthefashionoftherecentresearchworkonfuzzing evaluation .foreachgroupoftheseedprograms werun achybwith logical cores in hours and repeat the experiment times.
we perform the mann whitney u test to analyze the significance ofthe performance differences.
fig.10shows the median percentageof thetriggered invariant checks.
we can observe that only about of the invariant checks can be triggered when no seed program is applied.
while the seed programswithoutdistillationhelptotriggermoreinvariantchecks 324esec fse august athens greece yang hu wenxiwang casen hunger riley wood sarfraz khurshid andmohittiwari table new kacvs detected by achyb.
id file path function type description status cap net core rtnetlink.c do setlink kacv i misusingthe cap net admin check.
confirmed cap drivers char random.c extract crng kacv m missingthe cap sys admin check.
confirmed cap net ipv6 addrconf.c addrconf join anycast kacv m missingthe cap net admin check.
ignored cap drivers tty sysrq.c sysrq do reset kacv m missingthe cap sys boot check.
ignored lsm kernel signal.c send sig info force sigsegv kacv m missingthe security task kill check.
ignored lsm ipc sem.c newary kacv i misusingthe security sem alloc check.
ignored dac fs coredump.c cn print exe file kacv m missingthe inode permission check.
ignored only of the invariant checks can be triggered.
furthermore thereislessthan5 improvementwhenusingtheseedprograms distilledbymoonshine comparedtousingtheseedprogramswithout any distillation.
when using the seed programs distilled by achyb more than of the invariant checks can be triggered.
furthermore the results of the mann whitney u test indicate that the triggered checks using achybseed distillation approach are significantlymore thanthetriggeredchecksusing the otherthree approaches all three p values of mann whitney u test are smaller than0.
.
basedontheaboveresults wecanconcludethat achyb seed distillation approach can significantly improvethe efficiencyof triggering theinvariantchecks.
.
.
theoveralldetectionefficiency.
asintroduced pexrequires human effort to remove the false positives of theresults produced byitsstaticanalysis while achybappliesdynamicanalysistoremove the false positives.
after manually inspecting the potentially vulnerable paths we find that achybhas successfully triggered all the invariant checks associated with kacvs in the first hours.
inadditiontothe112.5minutetimecostinthestaticanalysis .
minutesforautomaticanalysisand6minutesformanualinspectionofpermissioncheckcandidates achybsuccessfullydetectsall 22kacvsinlessthan8hours.onthecontrary pexspendsmore than hours on only the static analysis phase without taking into accountthetimetakenbythemanualfalsepositiveremoval.
the resultsshow that achybis moreefficientthan pex.
.
rq3 newkacvs table3showsthe7newkacvs kacv mand2kacv i thatwe reporttothekerneldevelopers.asaresult 2newkacvs kacv m and 1kacv i are confirmed by the kernel developers.
we are still waiting for the feedback for the rest of new kacvs.
in detail 4kacvs cap cap cap andcap are dueto missingor misusing cap checks in drivers or the net subsystem kacvs lsm 1andlsm are due to missing or misusing lsm checks in the signal mechanism or the semaphore mechanism kacv dac isduetomissingadaccheckinthefilesystem.
overall wecansay that achybis ableto detectnew kacvs.
discussion in this section we want to discuss the limitations of achyband our future work.
we recognized four limitations of achyb.
first achybcannotdetect non function permissionchecks.second achyb cannot detect privileged functions which are never protected by any identified permission checks.
however this is a rare case as itis quite unlikely that kernel developers failed to add any permission checks to protect a privileged function especially in recent kernel versions.
third achybmay get false positives in terms of privileged function detection as there may exist non privileged functionswhicharealsoprotectedbypermissionchecks.fourth achybcannotguaranteethatallpotentiallyvulnerablepathscan becoveredinagiventimebudget whichmaycausefalsenegatives.
nevertheless thecoveragecanbeimprovedbyaddingmorediverse seed programs.
in future work we will try to enhance achybto overcome the above limitations.
we also plan to upgrade achyb to support more access control modules in the linux kernel.
in addition weplantoproposeeffectiveapproachestodetect kacv s. onepossibledirectionwouldbetospecifythecorrectnessofthe internal access control states and validate these states using the specifications dynamically.
related work missingcheckdetection.
detectingmissingchecksispioneered by engler s work which attempts to automatically extract the programmers beliefs from the source code to detect missing checks.followingthisdirection severalstaticanalysistoolshave beenproposedtodetectmissingchecks.
autoises automaticallyinfersthesecurityspecificationgivenasetofuser provided security checks and detects the security violations in the linux kernel.rolecast leveragesthestandardsoftwareengineering patterns conventionstodetectthemissingsecuritychecksinthe webapplications.
crix proposesanovelpeerslicingapproach to detect missing checks for the critical variables in the linux kernel.lrsan proposes its specialized data flow and control flow analysistodetectmissingrechecksforcriticalvariables.
pex is the state of the art tool to detect themissing access control permission checks kacv m which is the most related work to achyb.
achybdiffers from pexin two main aspects.
first achybfocuses ondetectingbothkacv mandkacv i.second achybperformsa novel hybrid analysis to make the kacv detection both scalable andprecise while pexisapurelystaticanalysistoolsufferingfrom high false positive rates.
greybox fuzzing of os kernel.
greybox fuzzing achieves big success in revealing real world vulnerabilities in recent decades .
several greybox fuzzers for os kernel including syzkaller triforceafl and trinity have been released.
besides the tool developments researchers make great effort in enhancingboththeeffectivenessandtheefficiencyofthekernelfuzzing.
breakthroughs have been made in the complex path condition solving seedgeneration seeddistillation file systemtesting driver firmware testing 325achyb a hybrid analysis approachto detectkernelaccess control vulnerabilities esec fse august athens greece errorhandlingtesting etc.differentfromtheexistinggreybox fuzzers achybproposesanovelclustering basedseeddistillation approach to facilitate the greybox fuzzinginkacv detection.
kernel verification and validation.
several approaches have been proposed to verify or validate the correctness of the kernel source code.
for example serval is aframeworkforverifyingsystemsoftware.givenaninterpreter providedbyusers itperformssymbolicexecutiononthesystem code to do the verification.
besides tesla provides users a language to specify the dynamic safety properties of the linux kernel.thespecifiedpropertiesarethenconvertedintorun time checks to validate the kernel.
different from the above approaches which require the users to provide the specification of the linux kernel achybis able to detect kacvs based on the invariants of the access control.
conclusion in this paper we first conduct an empirical study on kacvs using national vulnerability database.
motivated by our study we focus on detecting two kinds of kacvs kacv mandkacv i. we present a precise and scalable hybrid analysis approach called achybto detect both kacv mandkacv i.achybfirst performs a more precise andmoresound staticanalysisto identifythe potentiallyvulnerable paths and then applies an efficient dynamic analysis to reduce the false positives of these paths.
our experimental results show thatachyboutperforms pex thestate of the artkacvdetector in terms of both the detection precision and the efficiency.
furthermore achybdetects7newkacvs 2ofwhichhavebeenconfirmed bythe kernel developers.