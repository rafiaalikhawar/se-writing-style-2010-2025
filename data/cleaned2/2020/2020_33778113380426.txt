watchman monitoring dependency conflicts for python library ecosystem yingwang wangying swc .neu.edu.cn software college northeastern university chinamingwen mwenaa hust .edu.cn school of cyber science and engineering hust chinayepang liu liuyp1 sustech .edu.cn department of computer science and engineering sustech china yibo wang zhenming li chaowang wybneu lzmneu wangcneu .com software college northeastern university chinahai yu yuhai mail .neu.edu.cn software college northeastern university chinashing chi cheung scc cse .ust.hk department of computer science and engineering hkust china changxu changxu nju .edu.cn statekey lab for novel software technology and department of computerscienceand technology nanjinguniversity chinazhiliang zhu zzl mail .neu.edu.cn software college northeastern university china abstract the pypiecosystem has indexed millions of python libraries to allowdeveloperstoautomaticallydownloadandinstalldependencies of their projects based on the specified version constraints.
despite the convenience brought by automation version constraints in python projects can easily conflict resulting in build failures.
we refer to such conflicts as dependency conflict dc issues.
although dc issues are common in python projects developers lack toolsupporttogainacomprehensiveknowledgefordiagnosingthe rootcausesoftheseissues.inthispaper weconductedanempirical studyon235real worlddcissues.westudiedthemanifestation patterns and fixing strategies of these issues and found several key factorsthatcanleadtodcissuesandtheirregressions.basedon our findings we designed and implemented watchman a techniquetocontinuouslymonitordependencyconflictsforthe pypi ecosystem.inourevaluation watchmananalyzed pypisnapshots between jul and aug and found potential dc issues.wereportedtheseissuestothedevelopersofthecorresponding projects.
so far issues have been confirmed of which have been quickly fixed by applying our suggested patches.
mingwenandyepangliuarethecorrespondingauthorsofthispaper.hust sustech and hkust are short for huazhong university of science and technology southern university of science and technology and the hong kong university of science and technology respectively.
permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed forprofitorcommercialadvantageandthatcopiesbearthisnoticeandthefullcitation on the first page.
copyrights for components of this work owned by others than acm mustbehonored.abstractingwithcreditispermitted.tocopyotherwise orrepublish topostonserversortoredistributetolists requirespriorspecificpermissionand ora fee.
request permissions from permissions acm.org.
icse may23 seoul republic of korea 2020association for computing machinery.
acm isbn ... .
.org .
.3380426ccs concepts software and its engineering softwarelibrariesandrepositories keywords python dependencyconflicts software ecosystem acm reference format ying wang ming wen yepang liu yibo wang zhenming li chao wang hai yu shing chi cheung chang xu and zhiliang zhu.
.
watchman monitoring dependency conflicts for python library ecosystem.
in proceedings of 42nd international conference on software engineering seoul republic of korea may icse pages.
.org .
.
introduction python projects are commonly shared as third party libraries in a server side central repository pypi and reused by other projectswithaclient sidelibraryinstaller pip .byjune the pypiecosystem pypifor short has indexed over .
million python libraries together with their metadata e.g.
version information dependencieson other libraries etc.
.
to use a library on pypi developers need to specify the desired version constraint in a configuration script such as setup.py and requirements.txt .whenalibraryisreusedbyanother project this library and other libraries on which it depends will be automatically installed at the project s build time.
the automation smartly combines a server side central repository and a client side library installer to manage library dependencies.
it considerably simplifiesthebuildprocessofpythonprojects.besides theversion constraintmechanismforarequiredlibraryallowsdevelopersto restrictthedependenciestoasetofcompatibleversionsandenables automaticlibrary evolution .
however such automation comes with the risk of potential dependency conflict dc issues which .
oe oufsobujpobm pogfsfodf po 4pguxbsf ohjoffsjoh !
!
figure illustrative examples of dependency conflict issues can cause build failures when the installed version of a library violatescertainversion constraints on the library.
figure1givesarealexample issue in channels .a s shownin channels .
.
sconfigurationscript itdirectlyrequires libraries asgiref versionconstraint angbracketleft .
.
angbracketright and daphne version constraint angbracketleft .
.
angbracketright .
note that when downloading a library the pipinstaller always chooses the latest version on pypithat satisfies the library s version constraint .
no dc issues occurredwhen channels .
.
wasbuiltbefore 9apr .
both asgiref .
.
and daphne2.
.
selected for the build satisfy the concerned constraints.
however issue arose after apr when channels .
.
was built via selecting the newly releasedlibrary daphne2.
.
whichadditionallyrequireslibrary asgiref version constraint angbracketleft .
.
angbracketright .
the dc issue the red curve a. happened because pipselected asgiref .
.
to satisfy the direct dependency constraint angbracketleft .
.
angbracketright but this version violated the constraint angbracketleft .
.
angbracketrightspecified in daphne .
.
.thisissuecaused a build error as shown in figure b .
tofixtheissue channels sdevelopersreleasedversion2.
.0on 14apr2019 whichupdatedtherequirementon asgrief sversion to angbracketleft .
.
angbracketright.this update ledtotheinstallation of asgrief .
.
thelatestversionunder4.
whenbuilding channels .
.
thusresolvingthefailure thegreencurvea.
.however thisfixinducedanotherdcissuein channels redis issue asfigure1 c shows.aftertheupgradeof channels tobuild channels redis2.
.
pipstill selected asgiref .
.
to satisfy the direct dependency constraint angbracketleft .
.
angbracketright.
unfortunately this version violatestheconstraint angbracketleft .
.
angbracketrightthatistransitivelyintroduced bychannel .
.
causinga build failure red curve c. .
to understand the scale of dc issues in python projects and theircharacteristics weempiricallystudied235dcissuesin124 popular python projects which were reported on githubin the lastfive years.
we explored the following two research questions rq1 manifestationpatterns howdodcissuesmanifestthemselvesinpythonprojects?aretherecommonpatternsthatcanbe leveraged for automated diagnosis of these issues?
rq2 fixing strategies how do developers fix dc issues in python projects?
are there common practices that can be leveraged forautomated repair of these issues?
throughinvestigatingtheresearchquestions weobservethat dcissuesmainlyarisefromconflictscausedbyremotedependency updates or local environments see section .
.
we also found common strategies for fixing dc issues and key factors that can leadto dc issues and their regressions see section .
.
asareal worldpythondevelopercommentedonthereportof pyenvissue thedependencyresolutioninthepython worldisfarfrombeingeasy.thedifficultiesaremainlyattributedtothecomplexdependenciesacrossprojects.developersoftenspecify version constraints on the dependent libraries of their projects without considering the constraints specified in other projects.
to be specific we summarize three major challenges as follows.
first theversionofalibraryinstalledforapythonprojectcan vary over time.
recall that for each required library of a project pipwillinstallitslatestversionsatisfyingtheconcernedconstraint.
therefore any update of libraries on pypican affect the version of thelibrariesinstalledforthedownstreamprojects i.e.
theprojects thatdependon these libraries causing potential build failures.
second when a library updates its version constraints on other libraries its downstream projects might be affected.
the impact canbe further propagated to a wide range of projects.
third itisdifficultforpythondeveloperstoobtainafullpicture oftheirprojects dependencieswithversionconstraintinformation.
state of the art tools like pipenvand poetryonly show which librarieshave been installed rather than their dependencies.
toaddressthechallengesandhelppythondeveloperscombat dcissues wedesignedatechnique watchman whichperforms aholisticanalysisfromtheperspectiveoftheentire pypiecosystem to continuously monitor dependency conflicts caused by library updates.
for each library on pypi watchmanbuilds a full dependency graph fdg aformal modelthat simulatesthe process of installing dependencies for python projects.
the fdgs can be incrementally updated as the libraries evolve on pypi.
watchman then analyzes them to detect and proactively prevent dc issues.
since fdgs record full dependencies of python projects with version constraints they can also provide useful diagnostic informationtohelpdevelopersunderstandtherootcausesofthe detected dc issues thus facilitating issue fixing.
toevaluatewatchman weplayedbacktheevolutionhistoryof alllibrarieson pypi from1jan2017to30jun2019anddeployed watchman to detect dc issues.
after analyzing pypisnapshots during this time period watchman detected dc issues and .
of them were indeed fixed by developers during the evolutionofthelibraries.toevaluatetheusefulnessof watchman we ranit to monitordependency conflicts forthe pypiecosystem between jul and aug .
during the time period it detected and reported previously unknown dc issues of which .
have been confirmed by developers.
further .
confirmedissueshavebeenfixedbyapplyingoursuggested patches.developersalsoexpressedgreatinterestsinwatchman.
in summary our work makes three major contributions originality to the best of our knowledge we conducted the firstempiricalstudyofdcissuesinopen sourcepythonprojects.
our findings help understand the characteristics of dc issues andprovide guidance to future studies related to this topic.
dataset we release the dataset for empirical study comprising dc issues collected from real world python projects to facilitatefuture research.
technique weproposedaformalmodeltosimulatethebuild process of python projects and developed a dc issue diagnostic technique watchman based on the model.
experimental results show that watchman can monitor the entire pypiecosystem and detect dc issues witha high precision.
!
figure dependencies of a python project preliminaries .
dependencies of python projects figure illustrates the concept of python project dependencies.
code reuse is pervasive in the python world where projects often reuseotherprojectsaslibraries.theconfigurationscriptofaproject pexplicitly constrains the versions of direct dependencies thatp mayuse.ifthesedirectdependenciesfurtherrelyonotherlibraries suchlibrariesarecalled transitivedependencies ofp.inthispaper all direct and transitive dependencies are collectively referred to as theupstreamprojects ofp.correspondingly wecall padownstream projectof its dependencies.
python projects are often developed in a self contained environment which can be created by tools such as virtualenv conda and pipenv .whenbuildingapython project the library installer pipdownloads most of the required libraries from pypi.
we refer to such libraries that need to be downloaded as remote dependencies.
for each required remote dependency pip downloadsitaccordingtoitsnameandversionconstraint.ifmulti ple releases of a library on pypisatisfy the version constraint pip downloads and installs the latest version of the library .
besides remote dependencies the development of a python project can be affected by its local environment including the local developmenttoolchains e.g.
thepythoninterpreterandgcc and local dependencies i.e.
libraries that are already installed .
local dependenciesexistwhenthedevelopmentenvironmentisnotclean e.g.
theprojectisnotdevelopedinanisolatedvirtualenvironment .
if any version of a required dependency has been installed locally pipwillnotdownload the dependency from pypi.
.
library version constraints tousealibrary apythonprojectneedstospecifyaconstraintonits desired library versions as shown in figure i.e.
the cannotated onsomeedges .tofacilitatesubsequentdiscussions weformally defineversionconstraint usingthegrammarbelow versionidrefers to a specific version of a library e.g.
.
.
c colonequal range extra version id range colonequalrange opversion id opversion id extra colonequal nequalversion id extra nequalversion id op colonequal a constraint ccould be empty in which case pipwill choose to download the latest version of the library from pypiif the libraryisnotinstalledinthelocalenvironment.developersmayalsospecify a specific version that is desired e.g.
.
.
or undesirednumber of projects in each categoryutilities administrationinstallation setuptestinglibrariesbuild tools development security engineering others stars forks issues revisionsdownstream projectscategory klockloc 0k 1k 1k 5k 5k 10k 10k 50k50k 100k100k 500k figure statistics of the projects used in our empirical study e.g.
nequal1.
.
.
in practice developers mostly specify a range of versionsinaconstraint e.g.
.
.
.
.
.tounderstand how frequent ranges are used in version constraints we investigated the top popular python projects on pypibased on the number of downstream projects.
we found that .
of these projects directdependenciesareconstrainedtoarangeofversions.
incomparison thisratioisonly0 .
forjavaprojectsmanagedby mavenfollowing the same investigation method.
such heavy uses of ranges in version constraints for dependencies make the diagnosisofdcissuesinthepythonworldcomplicatedandchallenging see section .
empirical study .
data collection followingthedatacollectionprocessofexistingstudies we prepared our dataset in two steps.
step selecting subjects.
to understand the manifestation patterns and fixing strategies of dc issues we need to study the issuereports withdiscussionsifany dependencyconfiguration scripts issue fixing patches and related code revisions.
for this purpose wesearched githubforpythonprojectsthatsatisfythree conditions popular havingmorethan50starsorforks being used as libraries containing more than three direct downstream projects and well maintained havingover500coderevisions orover50issuereports.withthisprocess weobtained1 596opensource python projects.
step2 identifyingdcissues.
tolocatedcissuesinthe1 projects wesearchedfortheissuereportsthatcontainkeywords dependency conflict or dependency hell case insensitive filed between jul and jul i.e.
in the past five years .
we obtained and issue reports by searching with the two keywords respectively.
next we removed duplicates and noises fromthesearchresultsandkeptonlythoseissuereportsthatsatisfythefollowingthreeconditions.first thereportisrelatedtovaliddc issues.second thereportcontainsdescriptionsofissuerootcauses.
third wecanfindcoderevisionsthatfixthereportedissue s inthe concernedproject scoderepositoryorthereisanexplicitconsensus on the fixing solutions among developers as documented in the issuereport.
eventually we obtained dc issues from projects and of the issues have been fixed.
figure shows the statistics ofthe124projects.aswecansee theyare largeinsize around kloc on average well maintained containing revisions and issues on average popular of them have over stars impactful of them have more than direct downstreamprojects and diverse coveringover10categories .
in the following we study the issues to answer rq1 .
.
rq1 manifestation patterns dc issuesin pythonprojects manifestthemselves dueto different causes.
our studied issues can be divided into two categories according to whether the issues are caused by remote dependencies or localenvironment.inthefollowing wediscussthemanifestation patternsof the issues in detail with illustrative examples.
finding 211outofthe235 .
dcissuesthatinvolvethe violation of library version constraints were introduced by the updates of remote dependencies on pypi.
.
.
pattern a conflicts caused by remote dependency updates.
the root cause of the issues is that the updates of some remote dependencychangetheversionoftheconcernedlibrarytobeinstalled by pip which is hardly perceptible to project developers.
suppose that a python project prequires a library with a constraintc.i fcdoes not specify an upper bound on s version e.g.
c angbracketleft .
angbracketright orthespecifiedupperboundisgreaterthanthelatest version of onpypi e.g.
c angbracketleft2.
.
angbracketright while the latest versionof is3.
thentheversionof usedtobuild pmaynot becontrollableindevelopers perspective meaningthat canbe upgradedwhentherearenewversionson pypi.suchupgrading caneasilyinducedcissues snewversionmaynotsatisfythe constraintsspecifiedby other dependencies of p the versionconstraints specified by for its own libraries may also change in new versions causing potential conflicts with the constraints for the samelibrariesintroduced by p s other dependencies.
the issues can be further categorized based on where the dependencyconflictscome from.
theoretically conflicts couldhappen in three different cases among direct dependencies between directdependencies andtransitive dependencies and amongtransitivedependencies.however developersusuallywill not introduce conflicts among direct dependencies by including two conflicting libraries in the configuration script such mistakes canbeeasilycaught .indeed wedidnotobserveanyconflictsof thefirstcase.
in the following we discuss the latter two cases.
a.conflictsbetweendirectandtransitivedependencies .
supposethatapythonproject pdirectlydependsontwolibraries and with the version constraints cp andcp respectively and furtherdependson withtheversionconstraint c .in other words is not only a direct dependency of p but also required by other direct dependencies of p i.e.
can also be seen as a transitive dependency of p .
when building p pipwill always installthelatestversion vofthelibrary thatsatisfies cp as isatthetoplevelof p sdependencytree .ifvfallsintothe version range s specified by c pwill be built successfully.
however once gets updated on pypi the update may cause pip to install another version v primeof .i fv primefalls out of the range s specified by c pwill not be built successfully.
for instance in issue the project gallery dl directly requires the libraries requests angbracketleft .
.
angbracketrightand urllib3 angbracketleft .
nequal1.
.
angbracketright.
pipinstalledtheversion2.
.0of requests whichalsodepends onurllib3 angbracketleft .
.
.
.
angbracketright.thingsworkedsmoothlywhen gallery dl was first released on pypi as the latest version ofurllib3 at that time was .
.
which satisfies the constraints angbracketleft .
nequal1.
.
angbracketrightand angbracketleft .
.
.
.
angbracketright.however whenthe project urllib3 wasupdatedto1.
.0on18apr2019 gallery dl began to suffer from build failures.
this is because when building gallery dl pipwill install the latest version i.e.
.
.
ofurllib3.
however the version .
.
violates the constraint angbracketleft .
.
.
.
angbracketrightspecified in requests.
b.conflictsbetweentransitivedependencies .
supposethat a python project pdirectly depends on two libraries and both of which depend on another library but withtwo different version constraints c andc respectively.
if the version v of downloaded by pipaccording to c suppose that it has a higher priority also satisfies c the project pcan be built successfully.however since and aretwoseparateprojects their dependency relationshipon may evolveover time.there canbe caseswheretheupdatesof or wouldresultinconflictingversion constraints of consequently causing dc issues when building p. we observed such issues in our study.
for example the issue report o f rasadocumented an incident that a project was forced to introduce multiple version constraints of the library requests by its direct dependencies rasaand sagemaker .
the reasonisthat rasareleasedanewversion1.
.4andaddedaconstraint angbracketleft .
.
angbracketrightonrequests .
however this constraint is in conflict with another constraint on requests angbracketleft .
.
.
.
angbracketright introduced by sagemaker.
finding2 24outofthe235 .
dcissuesaroseduetotheconflicts between remote dependencies and the tools libraries installed in the local environment.
.
.
pattern b conflicts affected by local environment.
such issuescanhappenwhentherequiredtoolofaremotedependencyis incompatiblewiththelocalinstalledone e.g.
requiringpython3.
.
but installed python .
.
.
they can also happen when the version ofadependency whichisalreadyinstalledinthelocalenvironment doesnotsatisfytheconstraintspecifiedbyaremotedependency.
take issue o f gradient as an example.
the project failed to be built because there was already one version .
.
ofthelibrary numpyinstalledinthelocalenvironmentbeforethe build and this version is in conflict with the constraint angbracketleft .
angbracketright specified by pandasv0.
.
a direct dependency of gradient.
.
.
dependency smells.
by further analyzing developers discussions in the issue reports and the dependency configuration scriptsoftheprojectversionsthatwerenotaffectedbythereported issues of pattern a 1we observed several types of dependency smells .
these smells are interesting as they do not immediately causedcissuesbutarelikelytoinduceissuesastheprojectsevolve.
finding restrictingdependenciestospecificversionsforcommonlibrariescouldeasilyinducedcissuestodownstreamprojects.
build failures can easily happen if library version constraints are too restrictive e.g.
only accepting specific versions especially for those common libraries.
of our studied issues belong to this case.
for instance the project molecule depends on 1we ignored pattern b issues as they are affected by developers local environments whichare often unknown to us.
aspecificversionof ansible lint i.e.
version3.
.
alibrary thatisusedbymanyotherprojects.thismakes molecule sdownstream projects that also depend on ansible lint particularly sensitive to the updates of ansible lint .
we observe that whenever there was a new version of ansible lint released on pypi molecule sdeveloperswouldreceiverequestsfromdownstream projectstoupgradeitsversionconstrainton ansible lint e.g.
.
as there were too many such requests molecule developers finally chose to update and loosen the version constraint on ansible lint toarange angbracketleft .
.
angbracketright thusallowingmore downstream projects to work well with it.
finding4 dc issues can easily occur when the installed version ofalibrarysatisfyingoneversionconstraintisclosetotheupper bound specified in another version constraint.
out of the issues belong to this case.
as a library version installed by pipin the concerned project is close to the upper boundthat anotherversion constraintimposedon thelibrary updates of the library will likely induce build failures.
for instance the projects that directly require both request and urllib3 have oftenencountereddc issues e.g.
.thereason isthat these projects always install the latest version of urllib3 since the direct dependency constraints on urllib3 do not set an upper bound.
besides request also depends on urllib3 with a version constraint angbracketleft .
.
.
angbracketright.theseprojectswerebuiltsuccessfully when urllib3 s latest version was .
.
which satisfies angbracketleft .
.
.
angbracketright.
however the installed latest version .
.
was close to the upper bound .
.
in such cases dc issues can easilyarisewhenthere comes a newer version of urllib3.
thesefindings are useful.
we will show that identifying the two types of smells can help perform predictive analysis to proactively prevent dc issues before they cause real build failures.
.
rq2 fixing strategies to answer rq2 we studied the patches of the fixed issues the planned fixing solutions of the remaining issues and the comments in the issue reports.
we observed seven fixing strategies whichaltogetherresolved93.
ofourcollectedissues.
strategy1 adjustingtheversionconstraints ofdirectdependencies .
the conflicts between direct and transitive dependencieswerecommonlyfixedbyadjustingtheversionconstraintsof directdependenciestobecompatiblewiththoseoftransitivedependencies.
for example in issue of project valinor there were two conflicting version constraints on the library pyyaml.
oneconstraint angbracketleft angbracketrightwasdirectlyspecifiedby valinor.the other constraint angbracketleft .
.
angbracketrightwas transitively introduced by pyocd a dependency of valinor.
in such a case any version of pyyamlinstalledby pip whichsatisfiestheformerconstraint will violatethelatterone.tofixtheproblem thedevelopersof valinor revised the version constraint of pyyamlto angbracketleft .
.
angbracketright.
strategy upgrading or downgrading the direct dependencies thatrequireconflictinglibraries .dependencyconflictsbetweentransitivedependenciescanbesolvedbyupgradingordowngradingthedirectdependenciesthatintroducethetransitivedependencies.takeissue ofzhmcclient asanexample.thetwo conflictingversion constraints angbracketleft .
.
angbracketrightand angbracketleft .
angbracketrightoncoveragewere transitively introduced by zhmcclient s direct dependencies python coveralls angbracketleft .
.
angbracketrightand pytest cov angbracketleft .
.
angbracketright r e spectively.
since the installed version pytest cov .
.
added coverage angbracketleft .
angbracketrightas its direct dependency which caused the conflict zhmcclient sdevelopersdowngraded pytest cov bychangingitsversionconstraintto angbracketleft .
.
.
.
angbracketright.afterrevisingthe constraint pytest cov .
.
whichrequires coverage angbracketleft .
angbracketright was installed.
this constraint angbracketleft .
angbracketrightis not in conflict with angbracketleft .
.
angbracketrightandthus thedc issue was resolved.
strategy coordinating with upstream projects to adjust conflicting version constraints .
dc issues can also be fixed via coordinating with upstream projects.
take issue o ft h e project yottaasanexample.althoughtheconflictcanberesolved by adjusting the direct dependency s version constraint i.e.
following strategy the developers chose to coordinate with the upstreamprojectstosolvetheproblem.thisavoidschangingthe version of the directly required library.
strategy4 removingconflictingdirectdependenciesandkeeping the transitive ones .
when it is difficult to make a project s directdependenciesinlinewithitstransitiveones developersmay choose to remove the conflicting direct dependencies.
for example as described in issue of the project wandb conflicts occurred when an upstream project updated its version constraint on adirectdependency pyyaml andthishappenedseveraltimes.as wandbdevelopershadnodirectcontrolontheupstreamprojects theyremovedthe conflictingdirectdependencyfromtheconfigurationscript andused the transitively introduced one instead.
strategy adding direct dependencies .
there are cases whentheversionconstraints c andc oftwoconflicting transitivedependenciesoverlap meaningthatonecanfindsome versions of the concerned library to satisfy both constraints.
the dcissueinsuchacasecanberesolvedbyadding asadirectdependencywithaconstraintthatentailsboth c andc .thiswill instruct piptoinstalltheversionspecifiedbythedirectdependency thatsatisfiesboththetransitivedependencies.forinstance inissue of crossbar thereexisttwoconflictingtransitivedependencies urllib3 angbracketleft .
.
.
angbracketrightand urllib3 angbracketleft .
.
angbracketright.t o resolve the conflict developers added urllib3 angbracketleft .
.
.
angbracketright as a direct dependency to avoid build failures.
strategy6 upgrading downgradingdevelopmenttools .
thedependencyconflictsbetweenthelocalenvironmentandthe remotedependenciesareoftensolvedbyupgradingordowngrading thedevelopment tools e.g.
issue of bandit .
strategy creating an isolated environment .
this is a viable solution for resolving the dependency conflicts between remote and locally installed dependencies.
as recommended by developersof spyder and pandas thereareseveraltools such as virtualenv conda and pipenv which can createvirtualenvironmentstoisolatetheimpactsoflocallyinstalled dependenciesto avoid such dc issues.
therearenineissuesthatwerefixedbyrestrictingtheconflicting librarytoaspecificversion.however thisisnotagoodpracticeand caninducenewissues e.g.
asdiscussedinfinding3.
theremaining six issues were fixed by specific workarounds.
table1summarizeshoweachpatternofissueswerefixed.from the statistics we can observe that there can be multiple ways to fix dcissuesofacertainpattern.inparticular issuesofpatterna.a table statistics of manifestation patterns and fixing strategies patternstrategy1234567 a.a a.b b can be fixed by adopting four different strategies among which strategy is the most wildly adopted one.
this is because python developers have full control of the version constraints of their projects direct dependencies.
if adopting strategy will cause side effects such as security loopholes developers may solve the conflicts by upgrading or downgrading the direct dependencies of theirprojects strategy2 orcoordinatingwithupstreamprojects to adjust conflicting version constraints strategy .
for pattern a.b developers often adopt strategies and to resolve the issues.
issues of pattern b are mainly resolved via dealing with the local environments.
due to the page limit we do not make further discussionsandwe summarize our observations in the following.
finding5 therecanbemultiplefixesforadcissue.thesolutions canbeaffectedbytheissue smanifestationpattern thetopologicalstructureoftheproject sdependencygraph pip sinstallationrules andtheinterferencebetweentheversionconstraintsofupstream projects and those of downstream projects.
dependency conflict diagnosis in view of many dc issues induced by complex dependenciesamong upstream and downstream projects on pypi we further propose a technique watchman to continuously monitor dependencyconflictsfrom the perspective of the entire ecosystem.
figure gives an overview of our technique.
a major challenge is to perform a holistic analysis of the huge number of projects on pypiand model their interdependent relationships which are subjecttochangeovertime.toaddressthechallenge watchmanfirst collectsthemetadataforeachlibraryversion includingitsdirect dependencies with version constraints and their declaration orders.second it consolidates the metadata of all libraries hosted on pypi intoasinglerepositorytoenabletheanalysisoftheinterference between the version constraints across upstream and downstream projects.
then by continuously monitoring library release information on pypi watchman synchronously updates the metadata repositorytopreciselymodelthedependencyrelationships.forthe capturedlibraryupdates watchmanusesadepth firstsearching strategytoidentifytheaffecteddownstreamprojects.italsoperformsabreadth firstsearchofthemetadatarepositorytoconstruct a full dependency graphfor each potentially affected downstream project according to the library installation mechanism of pip.
finally watchman performs the automatic dc issue diagnosis.
.
constructing metadata repository tomodelthedependencyrelationshipsamonglibraries watchman uses themetadata structure to capture the version constraints of the direct dependencies of each library version and the declaration orders of these direct dependencies.
for ease of understanding in the subsequent discussions we shall use lowercase greek letters to denotelibrariesandsuperscriptsto denote versions.algorithm1 identifyingaffected downstream projects input lupandg output laf 1laf 2foreach v lupdo 3identifyaffectedlibrary v laf g 4function identifyaffectedlibrary v laf g 5foreachg u d r p gdo 6if d vsatisfiesthe constraint c u then laf laf u identifyaffectedlibrary u laf g definition metadata structure for a library version v i.e.
the version vof library watchman captures a collectionof information g v d r p where d is a set of direct dependencies of v. r c v d wherec v denotes the version constrainton the dependency specified by v. pmapseachdependency dto its declaration order.
inourexperimentstodetectunknowndcissues watchman extracted versions of distinct libraries from a snapshot of pypion jun .
for each library version v l wherelrepresentsalllibraryversions itobtainedthestructured metadata g v via analyzing the dependency configuration script of v. such metadata of all extracted library versions formed an initialmetadatarepository g whichisdefinedas g v v l .
this repository enables the queries of dependency relationships amongall upstreamanddownstream projects on pypi.
.
analyzing the impacts of library updates the analysismainlyconsistsof two steps as explained below.
step1 monitoringlibraryupdates.
libraryupdateson pypi oftencausedcissues.therearetwotypesoflibraryupdateson pypi new versions of an existing library being released andnew librariesbeingreleased.watchmancomputes lupbymonitoring thetwotypesoflibraryupdatesonadailybasis.foreachlibrary version v lup watchman collects the metadata g v and addsittotherepository g.inthismanner themetadatarepository gcan be synchronized with the evolution of the libraries on pypi.
step identifying affected downstream projects.
watchman performs backward search for identifying the set of down stream projects affected by lup denoted laf following the processasdescribedinalgorithm1.thealgorithmworksasfollows.
first it initializes lafto an empty set line .
for each library v lup watchman analyzes which libraries in the ecosystem may be directly affected by the update via calling the function identifyaffectedlibrary lines2 whichtakes v laf andgas input and updates lafwhen needed.
for each piece of metadata g u d r p ing i f is directly referenced by u i.e.
d andtheversionnumber vsatisfiestheversionconstraint c u then uis possibly affected by vand thus added to laf.
then watchman performs a depth first search to recursively find more downstream projects affected by uandupdate lafaccordingly.
.
detecting dc issues as discussed earlier the topological structure of a python project s dependency tree determines the installed library versions.
in order figure the overall architecture of watchman todiagnosedcissuesforeachlibraryversion v laf w eneed to analyze the relationships among all library versions that would beinstalledby piptobuild v.tocapturesuchrelationships we propose a formal model fulldependency g raph fdg .
definition2 fulldependencygraph thefulldependency graph of a library version v denoted fdg v is a three tuple n e fr where n n prime v is the set of nodes in the graph and n primedenotes a set of library versions that pipinstalls for building v. the librarieshere include both direct and transitive dependencies.
e angbracketleft x y angbracketright x y n isasetofdirectededges wherethe edge from xto yrepresents that the version xof library directly depends on library .
frmapseachedges e angbracketleft x y angbracketright etotheversionconstraint thatthelibrary version xsetson the library i.e.
c x .
note that the fdg of a library version may change overtime whenthelibrary supstreamprojectsareupdatedon pypi.algorithm describes the process of constructing the fdg for a library version v. watchman constructs fdg v following pip s breadth first installation strategy pipfirst installs direct dependencies for a project and then installs dependencies at the next levelaccordingtotheproject sdependencytree andthisprocess continues until all dependencies are installed.
in the algorithm we use a queue named queueto record the order of traversing and installingdependencies and visinitiallyaddedtothequeue.when visitingeachdependency xinqueue watchmanfirstretrieves its metadata g x d r p .
it then tries to add each dependency indtothefdg.if hasnotyetbeenloaded orinstalled watchmandeterminestheversiontobeloadedbasedonconstraint c x recordedin r following pip sinstallationrules line8 .
nandqueuearethenupdatedaccordingly line9 .if hasalready beenaddedtothefdg watchmanwillretrievetheloadedversion line .
a new edge angbracketleft x y angbracketrightis then added to e line .
the algorithmusesanotherqueue visiteded es to record the orderin whichtheedgesaretraversed line13 .watchmanalsosetsthe version constraint of this edge line which can be retrieved fromr.aftertraversingalldependenciesin queue thefdgofa library is completely constructed.
dc issue detection.
watchmandetectsdc issuesby analyzing the fdg of eachproject v lafin the following steps.
first watchmantraverses fdg v andlocatesthosenodeswithmultipleincomingedges.anodehasmultipleincomingedgeswhen there aremultiple projectsthat directlydepend onthe libraryrepresented by the node.
next for each such node x watchman analyzesthesetofitsincomingedges denoted e .notethatthereis oneedgeeine thatistraversedfirstwhenconstructing fdg v .
suppose that xis the latest version number of the library that satisfies the constraint fr e .
to detect dc issues watchman checksxagainst the set of constraints associated with other edges ine i.e.
fr e prime e prime e e .ifxviolatesanysuchconstraints watchman willreport a dc issue to the project .algorithm2 constructingfdg viabreath first search input vandg output fdg lv n e fr 1n v e fr 2queue.add v loaded visiteded es 3while!queue.isempty do 4 x queue.pop loaded loaded 5g x d r p getmetadata x g 6foreach ddo if nelementloaded then y gettoloadversion c x n n y queue.add y else y getloadedversion n e e angbracketleft x y angbracketright visiteded es .add angbracketleft x y angbracketright fr angbracketleft x y angbracketright c x .
predictive analysis for dc issues the constructed fdgs by watchman can also enable us to performpredictiveanalysis for proactiveprevention of dc issuesvia detectingthe two types of smells discussed earlier findings .
type restricting a dependency to a specific version.
if a project restrictsadependencytoaspecificversion itsdownstreamprojects may suffer from dc issues.
specifically dc issues may arise if the following conditionshold there is a version vof project denoted v that restricts itsdirect dependency to a specific version x. there is a version yof a downstream project that depends onboth and and vand xaretheinstalledlibraryversions for yat the time of analysis.
letdpbe the set of downstream projects e.g.
thus found.
the larger dp is the more likely that dc issues can arise.
this isbecauseeachprojectin dpindependentlysetsitsownversion constraintson .if vonlyacceptstheversion xof thepossibility thattheconstraint angbracketleft x angbracketrightconflictswithotherconstraintson set bytheprojectsin dpishigh especiallywhen dpislarge.inour experiments wewillwarnthedevelopersoftheproject if dp is larger than a threshold value which is set empirically.
figure a gives an illustrative example.
in project c2.
the constraint for library ais restricted to angbracketleft .
angbracketright.
in addition c s downstream project b5.0depends on both c2.0and a2.
.
in such a case it is very likely that the restrictive constraint csets on a would cause conflicts for b e.g.
when agets updated on pypi .
the risk of conflicts gets higherif we find more such downstream projects.
watchman will find such cases and suggest project c s developerstorelaxitsconstrainton a toavoidpotentialdcissues.
type the installed version of a library is close to the upper bound specified in the version constraint.
if the installed version of a library satisfies the concerned version constraint but is close to the upperboundspecifiedintheconstraint buildfailuresmayoccur when the library evolves.
watchman deems that a project vhas a potential dc issue if the following conditions hold .
.
.
.
.
!
!
!
!
figure illustrative examples of potential dc issues infdg v n e fr thereexistsanode uwithmultiple incomingedges where isadependencyof vanduistheinstalled version of .
lete be the set of incoming edges to u. theversionconstraintofthefirsttraversededge eine does not specify an upper bound on e.g.
the constraint is of the form angbracketleft y angbracketright orthespecifiedupperboundisgreaterthan latestversion zonpypi.
in this case any updates of onpypiwill affect the version of to be installed.
there exists another edge e primeine e prime nequale of which the associatedconstraint fr e prime specifiesanupperboundontheversion of e.g.
the constraint is of the form angbracketleft x angbracketright and the upper bound is greater than or equal to the latest version of i.e.
z. figure5 b givesanillustrativeexample.inthefdgofproject q5.
therearetwoincomingedgestoproject t4.
onefromproject x2.0and the other from project p4.
.
suppose that the former edge is traversed before the latter.
since the constraint that x2.0sets on thasnoupperbound thelatestversion4.0of twillbeinstalled.
thereisnodependencyconflictat thetimeofanalysis.
however sincetheconstraintassociatedwithlatteredge i.e.
angbracketleft .
.
angbracketright restricts ttoaversionrange buildfailuresmayoccurifdevelopers release a newer version e.g.
.
of tonpypi.
evaluation to evaluate watchman we study two research questions rq3 effectiveness how effective is watchman in detecting real dc issues and predicting potential ones?
rq4 usefulness can watchman monitordc issues in pypi andprovide useful diagnostic information to developers?
toanswerrq3 wereplayedtheevolutionhistoryofalllibraries onpypifrom1jan2017to30jun2019.wefirstconstructedametadata repository for pypi s snapshot on jan and then conducted incremental analysis to extract daily updates of all libraries until30jun2019.foreachlibraryupdate weappliedwatchman todetectdcissuesandpredictpotentialonesviaidentifyingdependency smells.
since we have the whole evolution history we couldevaluatewatchman seffectivenessbycheckingwhetherthe detected dc issues have been resolved and whether the predicted oneshave indeed evolved into real issues subsequently.
to answer rq4 we deployed watchman to monitor pypisince jul and configured it to detect new dc issues of pattern a as well as potential ones that could be induced by the smells oftype1andtype2.notethatissuesofpatternbcanhardlybe detected since they are affected by developers local environments on which we have no knowledge.
we then consolidated the detected dc issues and submitted reportstotheconcernedprojects issuetrackingsystems if the detectedissueshavenotbeenreportedorfixedintheunreleasedtable basic information of experimental subjects period1 period2 period3 period4 period5 projects releases commits masterbranchesoftheprojectsand theconcernedprojectshavemaintenancerecordsinthelasttwoyears stillactive .ineachissue report we pointed out the detected conflicts and explained how they arose.
such diagnostic information can be easily provided by watchmansinceitsimulatesthebuildprocessofeachproject.the report also includes fixing suggestions generated by watchman based on our observed common fixing strategies.
.
rq3 effectiveness datacollection.
aproject sevolutionhistoryprovidesusefulinformation about how dc issues manifested themselves and gotfixed .
to ease experiments we divided the whole time period from jan to jun into the following five sub periods 1jan2017 30jun2017 period1 1jul2017 31dec2017 period2 jan jun period jul dec period and1jan2019 30jun2019 period5 .foreachsub period we collected open source python projects satisfying the following two criteria as our experimental subjects having more than five release versions during this sub period active and having more than commits during this sub period well maintained .
table2liststhebasicinformationofthesesubjects.onaverage there are16 421releasesof2 067projectsforeachsub period.wethen appliedwatchmantodetectdcissuesofpatternaandpredictpotentialonesthatmaybeinducedbysmellsoftype1 type1issues andtype type issues during each of the five sub periods on a daily basis.
evaluation metrics.
to evaluate watchman s effectiveness we define two metrics resolving ratio andlasting time for each detected issue of pattern a we checked whether it had been resolved in the latest version of the project released on pypi upto thedate20jul2019.the metric resolvingratio measurestheproportionofresolveddcissuesinthosedetectedby watchman.
higher resolving ratios indicate better effectiveness of watchman.themetric lastingtime measuresthegapbetween the detection time of a dc issue and the resolving time of this issue.
a longer lasting time indicates a wider impact caused by a dc issue on the concerned downstream projects.
for the predicted issues we checked whether they had turned intorealones.therearetwocases thepredictedissueindeed arose reported in history due to library updates and was fixed by developers in subsequent project releases the predicted issuewasnotreportedinhistorybutdevelopersstillfixeditto avoid certain undesirable consequences.
accordingly the metric resolvingratio measurestheproportionofthepredicteddcissues thatbelong to either case.
the metric lastingtime measures the gap between the time an issue was predicted and the time it wasreported for case and the gap between the time an issue was predicted and the time it was resolved by developers for case .
results.
table presents the experimental results.
for all the fivesub periods watchmandetectedatotalof369dcissuesofpattern a and all of them had been fixed by developers i.e.
resolving ratio .
this strongly suggests that watchman can precisely table results of dc issues reported by watchman from jan to jun period1period2period3period4period5summar y patterna fixed resolving ratio natural lastingtime days .
.
.
.
.
.
natural type type2 case case resolving ratio .
.
.
.
.
.
natural lastingtime days .
.
.
.
.
.
natural naturaldenotesthe average value while denotes the sum.
detectdcissues.watchmanalsopredictedatotalof156type1and type2issues 143ofwhichhadbeenresolvedbydevelopers resultinginanaverage resolvingratio of91.
.the resolvingratio ofthepredictedissuesfordifferentperiodsranges from87.
to93.
whicharegenerallysatisfactory.thissuggests that watchman is also effective in predicting potential dc issues.
besides we observed that all detected dc issues were resolved by developers within amonth on average days .
watchman mayhelpreduce thisdelaysinceitcan detectdcissuestimely it performsanalysison adailybasis and reportthemtodevelopers along with fixing suggestions.
if developers are able to fix watchman s detectedissues in duecourse the sideeffect of theseissues on downstream projects will be largely diminished.
as at jul .
of the dc issues predicted by watchman had not evolved into real ones.
by further analyzing the concerned projects we found that the dependenciesintroducing these issueswere no longer active.
for instance in the project finance dl watchman found multiple version constraints for library idna.
when building finance dl pipwould install version2.
of idna whichis equal tothe upperbound ofthe constraint angbracketleft .
.
angbracketrightintroduced by the latest version of the library selenium requests .
however this potential dc issue type2 didnotevolveintoarealone since selenium requests hadstopped its update on pypi at our study time .
.
rq4 usefulness watchmandetectedandpredictedatotalof189dcissuessince we started our online monitoring on jul .
we filtered out issues that had been reported in the corresponding projects issue tracking systems and issues whose associated projects had no maintenance record in the last two years.
after filtering we reported the remaining dc issues to developers.
as shown intable4 63issues .
wereconfirmedbydevelopersasreal dc issues within a few days.
out of the confirmed issues .
were quickly fixed and confirmed issues .
are under fixing.
the remaining issues are still pending mainly due to inactive maintenance of the associated projects.
we provide a detailed analysis in the following.
.
.
feedback on reported issues.
for detected issues of pattern a which were causedby libraryupdates watchmangot a higher confirmation rate .
which is within our expectation.forthese39confirmeddcissues developersagreed thatthedetectedconflictswouldcausebuildfailures andinvitedus to submit patches to help resolve them.
for instance in issue report of the project osmedeus the developer mentioned that they had indeed encountered our reported dc issue when deployingtheproject andleftacomment ialsogetthaterrorwhen installingtheprojectbutmyserverworksfine.justsubmitaprandi willreview the patch .
forthe21predicteddcissuesoftype1 11ofthemhavealready been spotted by developers and resolved in the master branches of thecorrespondingprojects butnotyetreleasedon pypi before we reported them.
for instance the project mycroftai adapt relaxed its version constraint on library sixfrom angbracketleft .
.
angbracketrightto angbracketleft .
.
angbracketrightincommit 7eeadeb withalog toavoidincompatibility with downstream projects adapt parser and jsonschema .
therefore wereportedonlytheremaining10issuesoftype1to thedevelopersofthecorrespondingprojects and4ofthemhave beenconfirmedbydevelopers.encouragingly intheissuereport oftheproject dynamic prefer ences wegotthefollowing comment from developers after they resolved our reported issue itisahazzletokeeptrackofallthefrozenversionsofsome dependencies especiallyforlargerprojects.ithinkitwouldbegoodto getan automaticnotificationas maintainersomehow if oneofyour dependencieshaslocked its own libraries on a specific version.
for the predicted type issues of them have been confirmed by developers although these issues may not cause build failuresimmediately.weobservedthatsomeof watchman swarnings quickly caught developers attention and they added labels bug and deploymentproblem toourissuereports e.g.
.
among the confirmed dc issues including both detected and predicted ones developers resolved .
of them followingoursuggestedsolutions.forexample wereportedanissueof patterna.atothedevelopersof webinfo alongwiththreefixing solutions issue .thedeveloperchosethe onewatchman generated based on strategy to resolve this conflict.
for the remainingnineconfirmed issues for which our fixing solutions have notbeenadoptedbydevelopers wefoundthattheseprojectscan besensitivetocertainlibraryupdatesandoursuggestedchanges might introduce other side effects such as vulnerability or compatibilityissues e.g.
issue in project kindred .
.
.
feedback on watchman.
besides confirming our reported dc issues some developers expressed interests in our tool watchman.forexample adeveloperleftthefollowingcommentinthe pullrequest of the project arxiv submission core abettermechanismofmaintainingthedependencyconstraints amongprojects on pypilikewhatyou did is much needed!
in issue report of the project pywb we found an encouraging comment from an experienced lead developer who is also thefounderof the webrecorder community are you an automation written by github community to help resolvedependencyconflictissuesforpythonprojects?ifso apieceof nice work!
i d say this is a good approach a nice friendly bot to informof potential dependency issues.
such feedback indicates that monitoring library updates and detecting predictingdependencyconflictsisindeedimportantto andwelcomedbyreal worldpythondevelopers.theinformation provided by watchman is also useful to help developers diagnose dc issues in practice.
table results of dc issues reported by watchman from jul to aug manifestation issuereports each item gives the issue report id and the project name patterna.aissue aucome issue crypto issue orcasong issue pypmml spark issue toolium issue gatewayframework issue airbnb data issue runcible issue identification issue identification issue tasking manager issue archery issue bocadillo issue crema issue what digit you write issue webinfo crawler issue zarp issue open helpdesk issue languagecrunch issue account cr eator issue jawfish issue openpose plus issue kindred issue generator gui issue tabular issue whats bot issue armory bot issue derrick issue historical prices issue dxr issue erpnext issue scrapy qtwebkit issue instapy issue api indotel issue cert issuer issue django issue pymacaron issue mgz db issue twitterbots issue gremlin issue awsbucketdump issue fabric cli issue blockcluster issue gateway issue beauty image issue indy node issue swapi issue explorer issue 34footmark issue driver acs issue driver napi issue simulator issue friends finder issue chatbot template issue djangopackages issue cadasta platform issue adminset issue wallpaper issue ltiauthenticator issue cryptography patterna.b issue bakerydemo issue pytools issue osmedeus issue aldryn search type 1issue dynamic preferences issue ldapdomaindump issue py cluster issue faker issue newspaper issue mixer issue client python issue pyinquirer issue compressor issue certstream type 2issue autocrawler issue bbscan issue pywb issue ct exposer issue eagleeye issue mythril issue frida util issue python urwid issue securitymanageframwork issue sherlock issue freqtrade issue trains issue glastopf issue machine learning with python issue kalliope issue bless issue arxiv submission core issue plaso issue oauth dropins issue ripping machine issue channelbreakoutbot issue tldextract issue messytables issue kuberdock platform issue python weixin issue nodb issue photon issue pyspider issue fan issue historical issue stephanie va issue subliminal issue wpseku issue zhihu crawler issue network topology issue marathon lb issue konan issue jbops issue hangoutsb ot issue gyoithon issue automation to ols issue start vm issue ahmia inde x status1 the issueshave already been fixed using our suggested solutions status2 the issues have already been fixed using other solutions status3 the issues have been confirmed and are under fixing usingour suggested solutions.
status4 the issues have been confirmed and are under fixing using other solutions.
status5 the issues are still pending.
we do not present the link of these issues due to page limit.
the detailed information of them can be found on our project website discussions threatstovalidity.
keywordsearchcanintroduceirrelevantissuesintoourdataset.suchnoisesposeathreattothevalidityofour studyresults.theerrorsinourmanualanalysisofthedcissues may also affect our study results.
to reduce these threats three co authors independently investigated our collected dc issues and cross validated their analysis results.
limitations.
our work has three limitations.
first we focus on the dc issues that cause build failures.
however in some cases dependencyconflictsmayleadtosemanticinconsistencies runtime errors or other consequences in python projects.
second the rules adopted in the predictive analysis can only help find a subset ofall possible dc issues that may be induced by the two types of dependency smells.
the rule set is designed based on our observed realcasesintheempiricalstudyandisnotmeanttobecomplete.
third watchman currently is not able to detect all patterns of dcissuesobservedinourempiricalstudy.wewilladdressthese limitationsin future work.
related work studies of dependency conflicts.
pradel et al.
studied the dependency conflicts among javascript libraries and proposed a detectionstrategy.suzakietal.
conductedanextensivecase study of conflict defects including conflicts on resource access conflictsonconfigurationdata andinteractionsbetweenuncommoncombinationsofpackages.soto valeroetal.
studiedthe problem of multiple versions of the same library co existing in maven central and presented empirical evidence about how the immutability of artifacts in maven central supports the emergence of natural software diversity.
wang et al.
conducted an empirical study to characterize dependency conflicts in java projects and developed riddle to generate tests to collect crashing stack traces to facilitate dc issue diagnosis .
to the best of our knowledge thereisnopreviousworkfocusingoncharacterizing anddetectingdc issues in the python world.
studiesofsoftwareecosystem.
serebrenik et al.
performed ameta analysisofthedifficulttasksinsoftwareecosystemresearchandidentifiedsixtypesofchallenges e.g.
howtoscaletheanalysis to a massive amount of data.
mens studied software ecosystem from the socio technical view on software maintenance and evolution.
zimmermann et al.
studied the security risks in the npmecosystem by analyzing data such as dependencies between packagesandpubliclyreportedsecurityissues.anotherstudyby lertwittayatraietal.
usednetworkanalysistechniquestostudy the topology of the javascript package ecosystem and extracted insights about dependencies and their relations.
our work studies softwareecosystemfromanovelperspectivebytakingintoaccount the interferencebetween the version constraints of upstream and downstream projects.
we also propose a technique to continuously monitordependencyconflictsforpythonprojects.
conclusion and future work in this work we first conducted an empirical study of real dependency conflict issues in python projects to understand the manifestation patterns and fixing strategies of dependency conflict issues.motivatedbyourempiricalfindings wethendesignedatechnique watchman tocontinuouslymonitordependencyconflicts forthe pypiecosystem.evaluationresultsshowthatwatchman can effectively detect dependency conflict issues with a high precision andprovide useful diagnostic informationto help developers fixtheissues.infuture weplantofurtherimprovethedetection capability of watchman and generalize our technique to other python library ecosystems such as anaconda to make it accessible to more developer communities.